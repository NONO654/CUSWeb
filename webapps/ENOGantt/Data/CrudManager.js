define("DS/ENOGantt/Data/CrudManager",["UWA/Class","DS/PlatformAPI/PlatformAPI","DS/Foundation2/FoundationV2Data","DS/ENOGantt/Ven/Bryntum","DS/ENOGantt/Data/TaskStore","DS/ENOGantt/Data/ResponseUtil"],function(b,a,e,d,c,f){return b.extend({init:function(){var j=this;var g=new c();g=g.getStore();Ext.define("DS.ENOGantt.Data.CrudManager",{extend:"Gnt.data.CrudManager",autoLoad:false,taskStore:g,prepareRemoved:function(q){var k=[],p;for(var o=0,n=q.length;o<n;o++){p={};p[q[o].idProperty]=q[o].getId();if("Gnt.model.Dependency"==q[o].$className){p.To=q[o].get("To");p.From=q[o].get("From")}if("Gnt.model.Assignment"==q[o].$className){p.TaskId=q[o].get("TaskId")}k.push(p)}return k},sendRequest:function(){var s=this;var w=App.Infra.isCustomizedEnvironment;var o="live";var p=s.transport.sync.params;if(p&&p.AddRemoveTask){o=""}var y=arguments[0].success;var r=JSON.parse(arguments[0].data);var t=r.type;var k="GET";var n=1;if(App.Infra.Load.Level!=undefined){n=App.Infra.Load.Level}else{App.Infra.Load.Level=n}var u=enoviaServer.physicalId;var q=App.Infra.Columns;if(enoviaServer.referenceId!=undefined&&enoviaServer.referenceId!="null"&&enoviaServer.referenceId!=""){u=u+","+enoviaServer.referenceId}var l="";if(App.Infra.ViewId==App.Infra.Views.VIEW_STATUS_REPORT){n=1}if(App.Infra.ViewId==App.Infra.Views.VIEW_STATUS_REPORT){var n=1;if(App.Infra.LoadStatusActualData){n=0}enoviaServer.projectId=enoviaServer.projectId?enoviaServer.projectId:enoviaServer.objectId;if(App.Infra.LoadStatusActualData||enoviaServer.initGantt){basePath="/resources/v1/modeler/projects/";include="none,tasks";if(enoviaServer.AddDeliverable=="true"){include=include+",deliverables"}l=basePath+enoviaServer.projectId+"?isDPMTask=true&$include="+include+"&isCustomizedEnvironment="+w+"&level="+n+"&$indexBasedImages=false&$fields=none,tasks.title,tasks.isSummaryTask,tasks.color,tasks.typeicon,tasks.modifyAccess,tasks.policy,tasks.actualStartDate,tasks.actualFinishDate,tasks.estimatedStartDate,tasks.estimatedDuration,tasks.percentComplete,tasks.dueDate,tasks.predictiveActualFinishDate,tasks.estimatedDurationInputValue,tasks.estimatedDurationInputUnit"}else{basePath="/resources/v1/modeler/tasks/";include="none";if(enoviaServer.AddDeliverable=="true"){include=include+",deliverables"}l=basePath+"?isDPMTask=true&$include="+include+"&isCustomizedEnvironment="+w+"$indexBasedImages=false&$fields=title,isSummaryTask,color,typeicon,modifyAccess,policy,actualStartDate,actualFinishDate,estimatedStartDate,dueDate,predictiveActualFinishDate,estimatedDurationInputValue,estimatedDurationInputUnit";for(i=0,m=q.length;i<m;i++){if(q[i].customColumn==true){l=l+","+q[i].name}}}}else{l="/resources/v1/modeler/projects/"+u+"?isDPMTask=true&$indexBasedImages=false&rollup="+o+"&isCustomizedEnvironment="+w+"&$include=none,tasks,predecessors,assignees&level="+n+"&$fields=none,";if(t=="sync"||App.Infra.loadProjectSelectable||n!=1){l=l+"title,PALId,sequenceOrder,state,policy,modifyAccess,estimatedStartDate,estimatedFinishDate,dueDate,actualStartDate,actualFinishDate,percentComplete,estimatedDurationInputValue,estimatedDurationInputUnit,actualDuration,constraintDate,defaulConstraintType,scheduleFrom,scheduleBasedOn,typeicon,"}l=l+"tasks.title,tasks.modifyAccess,tasks.deleteAccess,tasks.freeFloat,tasks.totalFloat,tasks.PALId.transient,tasks.state,tasks.notes,tasks.predictiveActualFinishDate,tasks.estimatedDuration,tasks.percentComplete,tasks.estimatedStartDate,tasks.dueDate,tasks.estimatedDurationInputValue,tasks.estimatedDurationInputUnit,tasks.actualStartDate,tasks.actualFinishDate,tasks.actualDuration,tasks.constraintType,tasks.Deviation,tasks.constraintDate,tasks.policy,tasks.isSummaryTask,tasks.color,tasks.sourceId,tasks.taskProjectId,tasks.criticalTask,tasks.status,tasks.typeicon,tasks.sequenceOrder,predecessors.title, predecessors.PALId,predecessors.lagTime,predecessors.dependencyType,predecessors.LagUnit,predecessors.From,predecessors.predTaskSeqNumber,predecessors.To,predecessors.predProjectName,predecessors.predProjectId,assignees.fullname,assignees.allocation";for(i=0,m=q.length;i<m;i++){if(q[i].customColumn==true){l=l+",tasks."+q[i].name}}}if(enoviaServer.securityContext&&enoviaServer.securityContext!="ctx::undefined"){l=l+"&SecurityContext="+enoviaServer.securityContext}this.transport.load.url=l;var v={};var r={};if(t=="sync"){k="PUT";v=this.getChangeSetPackage();r.data=f.format6WData(this,v);r.csrf={name:App.csrf.name,value:App.csrf.value,}}r=this.encode(r);var x="";if(App.Infra.ViewId==App.Infra.Views.VIEW_STATUS_REPORT&&!(App.Infra.LoadStatusActualData||enoviaServer.initGantt)){k="POST";r="$ids="+u;x="application/x-www-form-urlencoded"}e.ajaxRequest({data:r,url:l,type:k,dataType:"json",contentType:x,callback:function(C){var D=C.data;var z=C.csrf;if(z){App.csrf=z}if(this.type=="PUT"||this.method=="PUT"){var A=s.transport.sync.params;var I=f.syncFormat(D,false,A,s);s.transport.sync.params={};var G=s.encode(I);y.call(s,G);if(A&&A.AddRemoveTask||A&&A.AddRemoveDep){if(!App.Infra.loadProjectSelectable){App.Infra.loadProjectSelectable=true}if(App.Infra.Load.Level!=undefined&&App.Infra.Load.Level!=0){App.Infra.Load.Level=App.Infra.Load.Level+1}s.load()}}else{if(App.Infra.ViewId==App.Infra.Views.VIEW_STATUS_REPORT){if(!App.Infra.LoadStatusActualData&&!enoviaServer.initGantt){var H={};H.relateddata={};H.relateddata.tasks=D;D=[H]}}else{console.time("loadFormat");if(D.length>1){var J=D[1];f.getsourceIdData(J);D.splice(1,1)}}var F=f.loadFormat(D);if(App.Infra.LoadStatusActualData){var B=f.filterTaskForStatusReport(F,s);F.tasks.rows=B;delete App.Infra.LoadStatusActualData}console.timeEnd("loadFormat");var G=s.encode(I);console.time("call");y.call(s,F,G);s.taskStore.store.autoNormalizeNodes=true;if(s.transport.load.resolve){console.log("Reolve in CRUD");var E=s.transport.load.resolve;E();delete s.transport.load.resolve}console.timeEnd("call");if(App.Infra.loadProjectSelectable){App.Infra.loadProjectSelectable=false}}}})},transport:{load:{method:"GET",url:"/resources/v1/modeler/projects/"+enoviaServer.physicalId+"/dpmgantt",requestConfig:{timeout:60000}},sync:{url:"/resources/v1/modeler/projects/"+enoviaServer.physicalId+"/dpmgantt",requestConfig:{timeout:60000},params:{}}},});var h=Ext.create("DS.ENOGantt.Data.CrudManager");h.on("sync",function(q,l){if(l!=null&&l.error){alert(l.error);this.reject()}else{if(l.assignments.rows.length>0||l.assignments.removed.length>0||l.resources.rows.length>0||l.resources.removed.length>0){var o=Ext.ComponentQuery.query("#dpmresourceutilizationpanel")[0];var k=o.getStore();k.commitChanges();this.commit()}if(this.hasChanges()){console.log("============SYNC CALLED========");this.sync();this.commit()}else{this.commit()}var p=Ext.getCmp("tBarActionSaveAll");var n=Ext.getCmp("tBarActionResetAll");if(!p.isDisabled()||!n.isDisabled()){p.disable();n.disable()}}});h.on("haschanges",function(o,l){var n=Ext.getCmp("tBarActionSaveAll");var k=Ext.getCmp("tBarActionResetAll");if(n.isDisabled()||k.isDisabled()){n.enable();k.enable()}});h.on("nochanges",function(o,l){var n=Ext.getCmp("tBarActionSaveAll");var k=Ext.getCmp("tBarActionResetAll");if(n&&k){if(!(n.isDisabled())||!(k.isDisabled())){n.disable();k.disable()}}});h.on("beforeload",function(n,o,k){var l=Ext.ComponentQuery.query("#dpmprojectgantt")[0];if(l.rendered){l.setLoading({msg:App.Infra.LoadText||l.L("loadingText")})}});h.on("beforesync",function(n,l){var k=Ext.ComponentQuery.query("#dpmprojectgantt")[0];if(k.rendered){k.setLoading({msg:l.type==="load"?k.L("loadingText"):k.L("savingText")})}});this.crudManager=h}})});