define("DS/3DWorkbook/js/Wkb3DViewer",["UWA/Core","DS/3DWorkbook/js/WkbUtils","DS/UIKIT/Mask","WebappsUtils/WebappsUtils","DS/CoreEvents/ModelEvents","DS/DELMOMWKIExperience/js/WKI3DPlayer","DS/DELMOMWKIExperience/js/WkiStreamUtil","DS/3DWorkbook/js/WkbWidgetCom","i18n!DS/3DWorkbook/assets/nls/3DWorkbook"],function(e,t,s,S,x,i,J,E,W){var O,G=null,M=null,B,L,u,n=null,q=null,H=null,U=null,V=true,f=null,T="",I="",Y,X=false,K=false,p=false,a=false,ab="",aa="",b=null;var o=function(ad){Y=ad.modelEvtManager||new x();G=ad.ctx;O=ad.ematrixURL;H=ad.systemRefName;if(f===null){Y.subscribe({event:"wkbNav-SystemLoaded"},function(ae){Q(ae)});Y.subscribe({event:"wkbNav-SelectOper"},function(ae){z(ae)});Y.subscribe({event:"wkbHeader-SelectOper"},function(ae){z(ae)});Y.subscribe({event:"wkbHeader-SelectOrder"},function(ae){Q(ae)});Y.subscribe({event:"wkbMain-Remove3D"},ac);Y.subscribe({event:"wkbHeader-Select3D"},A);Y.subscribe({event:"wkbMain-GraphicsChanged"},function(ae){if(ae.object_type==="SYSTEM"){Q(ae)}else{z(ae)}});Y.subscribe({event:"wkbMain-NavSizeChanged"},r);Y.subscribe({event:"wkbMain-DetailSizeChanged"},r)}this.setContainer();X=true;return this};function ac(ad){if(f!==null){f.style.display="none"}X=false}function A(ad){if(f!==null){f.style.display=""}X=true}function R(ae){if(e.is(b)&&e.is(b.dispose)){b.dispose()}var ad={serverURL:O,securityContext:widget.getValue("collabSpace"),plmIdentifier:ae};b=new J(ad)}function Q(ad){var ad={object_type:"SYSTEM",object_data:ad.object_data};if(e.is(ad.object_data.systemPlmIdentifier)){R(ad.object_data.systemPlmIdentifier)}N(ad)}function z(ad){var ad={object_type:"OPERATION",object_data:ad.object_data};N(ad)}function N(ad){if(X){if(!ad.object_data.plmIdentifier){if((n)&&(ad.object_type==="SYSTEM")){ad.object_data.plmIdentifier=n;ad.object_data.parentPlmIdentifier=n;ad.object_data.systemPlmIdentifier=n;ad.object_data.publishedProductId=q;if(L){ad.object_data.xml3DFile=L}else{ad.object_data.xml3DFile=""}}else{return}}if(ad.object_type==="SYSTEM"){Z(ad.object_data.plmIdentifier,true,ad.object_data);n=ad.object_data.systemPlmIdentifier;L=ad.object_data.xml3DFile;q=ad.object_data.publishedProductId;U=ad.object_data.systemPhysicalId}else{Z(ad.object_data.plmIdentifier,false,ad.object_data)}}}function w(ad){console.log(ad)}function d(ae){if(u||!e.is(ae)){return}var af=new DOMParser();var ad=af.parseFromString(ae,"text/xml");Y.publish({event:"wkb3DViewer-MapFileLoaded",data:{mapData:ad,player:M}});E.publishMappingFileLoaded(ad)}function F(){s.unmask(f.parentElement);if(!u){k()}var ad;window.onresize=function(){window.clearTimeout(ad);ad=setTimeout(r,500)};G=M.player.getCtx();E.publishModelLoaded()}function k(){try{M.loadOperByRefName(T,I)}catch(ad){console.log(ad)}}function c(ad){if(a){ab=ad.title;a=false;if(!u){k()}}}function D(ad){a=true}function h(ae){var ad={action:ae.action.toUpperCase(),idPath:ae.instancePath};Y.publish({event:"wkb3DViewer-HighlightCallback",data:ad});E.publishPartSelected(ae)}function r(af){if(!e.is(f.parentElement)){return}var ad=f.parentElement.offsetWidth;var ae=f.parentElement.offsetHeight;f.setStyle("height",ae+"px");f.setStyle("width",ad+"px")}function j(){M.addEventListener("ScenarioChange",function ad(af){c(af.detail.scenario)});M.addEventListener("ScenarioStop",function ae(af){D(af.detail.scenario)});M.addEventListener("PartSelected",function(af){h(af)})}function P(){if(u){M.resetViewer()}else{k()}}function g(ae,ad,af){ae.innerHTML="";ae.style.display="";s.mask(f.parentElement);M=new i.WKI3DPlayer(ae,ad,af);j()}function l(ad,ae){if(!e.is(b)){R(ae)}b.getFile(ad,d)}function y(ag){var ad=f.parentElement.offsetWidth;var ai=f.parentElement.offsetHeight;f.setStyle("height",ai+"px");f.setStyle("width",ad+"px");var ae={height:ai+"px",callback:F,serverURL:O,requiredAuth:"passport",ctx:G};var ah=H+"_mapping.xml";ae.systemMapFile=ah;ae.systemRefName=H;ae.systemPLMID=ag.systemPlmIdentifier;ae.securityContext=widget.getValue("collabSpace");if((e.is(ae.systemPLMID)&&ae.systemPLMID.length>0)||(e.is(ag.publishedProductId)&&ag.publishedProductId.length>0)){K=(e.is(ag.publishedProductId)&&ag.publishedProductId.length>0);if(K){l(ah,ag.systemPlmIdentifier);if(e.is(M)){if(M.lastAsset===ag.publishedProductId){P()}else{M.loadProduct(ag.publishedProductId,ae)}}else{ae.productId=ag.publishedProductId;g(playerDiv,"",ae)}}else{l(ah,ag.systemPlmIdentifier);if(e.is(M)){if(M.lastAsset===ag.systemPlmIdentifier){P()}else{M.loadFileFromStream(ae.systemPLMID,ae.systemRefName)}}else{if(V){g(playerDiv,"",ae)}else{g(playerDiv,"",ae)}}}}else{if(M){M.ResetScenarios();M=null}f.textContent="";var af=t.createAndAppend(f,"div","msgDiv","msgDiv");af.textContent=W.No3DFoundMsg;Y.publish({event:"wkb3DViewer-No3D"})}}function Z(ad,af,ae){u=af;if(!af){T=ae.id;I=ad}if(V){y(ae)}else{y({xml3DFile:"V8_engine.3dxml",systemPlmIdentifier:"testPLMID"})}}function C(){if(e.is(M)){if(e.is(M.dispose)){M.dispose()}M=null}if(e.is(b)&&e.is(b.dispose)){b.dispose();b=null}}function m(){return G}function v(ag,af,ae,ad){V=false;switch(ag){case"processViewer":return y(af);case"hide3DViewer":return ac();case"renderGraphics":return N(af);case"onThreeDPartSelect":return h(af);case"xmlMapLoaded":return d(af);default:return null}}o.prototype={setContainer:function(){if(f===null){f=e.createElement("div",{id:"playerDiv","class":"playerDiv"});f.testFunction=v;f.dispose=C;f.getCtx=m}else{f.style.display=""}},getContainer:function(){return f},get3DPlayer:function(){return M},getCtx:m,dispose:C,testFunction:v};return o});