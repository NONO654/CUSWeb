define("DS/FolderEditorCustomization/Utils/FolderEditorCustomizationUtils",["UWA/Core"],function(b){var a={splitExtension:function(f){var d=f.split(".");var e="";if(d.length>1){e=d.pop()}var c={filename:d.join("."),extension:e};return c},editFileName:function(g,e){var c=g.split(".");var f="";if(c.length>1){f="."+c.pop()}var d;if(e<1000){d=("00"+e).slice(-3)}else{d=""+e}return c.join(".")+"_"+d+f},checkFolderEditorInvalidCharsWithSlash:function(d){var f=['"',"#","$","@","%","*",",","?","\\","<",">","[","]","|",":","/"];var c={hasInvalidChar:false,badChars:""};for(var e=0;e<f.length;e++){if(d.indexOf(f[e])>=0){c.hasInvalidChar=true;c.badChars=f.join("");break}}return c},isExistsInArray:function(d,e){for(var c=0;c<e.length;c++){if(e[c]===d){return true}}return false},isExistsInArrayUpperCase:function(d,e){for(var c=0;c<e.length;c++){if(e[c].toUpperCase()===d.toUpperCase()){return true}}return false},formatBytes:function(d,c){if(d===0){return"0 Byte"}var f=1000;var e=c+1||3;var h=["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"];var g=Math.floor(Math.log(d)/Math.log(f));return(d/Math.pow(f,g)).toPrecision(e)+" "+h[g]},getStringByte4UTF8:function(f){var e=[0,1,1,1,2,3,2,3,4,3];var c=0;for(var d=0;d<f.length;d++){c+=e[encodeURIComponent(f.charAt(d)).length]}return c},Sanitize:{encode:function(c){return c.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}},notAllowedChars:['"',"#","$","@","%","*",",","?","\\\\","<",">","\\[","\\]","|",":"],notAllowedCharsForOwner:['"',"#","$","%","*",",","?","\\\\","<",">","\\[","\\]","|",":"],removeControllCode:function(c){return c.replace(/[\t\r\n]/g,"")},escapeControllCode:function(c){return c.replace(/\t/g,"\\t").replace(/\r/g,"\\r").replace(/\n/g,"\\n")}};return a});define("DS/FolderEditorCustomization/ActiveFolder/ActionBar_ActiveFolderCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/FolderEditor/Folder_CSO","DS/FolderEditor/utils/FolderEditorcontrol","i18n!DS/FolderEditor/assets/nls/FolderEditor"],function(f,b,a,c,e){var d=b.extend({labelTopBar:e.Dialog_Title,isInsert:true,datas:{},init:function(g){this._parent(g,{mode:"exclusive",isAsynchronous:false})},beginExecute:function(){},execute:function(){require(["DS/FolderEditorCustomization/ActiveFolder/ActiveFolder"],function(h){if(h._isInitialized===false){h.activeFolder();return}var g=a.getCurrentFolder();h.activeFolderCommand(g)})},endExecute:function(){}});return d});define("DS/FolderEditorCustomization/BulkDownload/ActionBar_BulkDownloadCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/FolderEditor/Folder_CSO","DS/FolderEditor/utils/FolderEditorcontrol","i18n!DS/FolderEditor/assets/nls/FolderEditor"],function(f,b,a,d,e){var c=b.extend({labelTopBar:e.Dialog_Title,isInsert:true,datas:{},init:function(g){this._parent(g,{mode:"exclusive",isAsynchronous:false})},beginExecute:function(){},execute:function(){require(["DS/FolderEditorCustomization/BulkDownload/BulkDownload"],function(i){function k(r){var v=[];var p=[];for(var u=0;u<r.length;u++){p.push(r[u].getID())}function s(A,B){for(var z=0;z<B.length;z++){if(B[z]===A){return true}}return false}for(var u=0;u<r.length;u++){var y=r[u];var w=y.getParents();var q=false;for(var t=0;t<w.length;t++){var x=w[t];if(s(x.getID(),p)){q=true;break}}if(!q){v.push(y.getID())}}return v}function l(r,s,p){var t=[];for(var q=0;q<r.length-p;q++){if(r[q].type!=="FolderSection_AllFolders"){t.push(r[q].label)}}return t.join(s)}var h=a.getSelectedNodes();var g=k(h);var o;var j=a.getCurrentFolder();var m=a.getCurrentFolderPath();var n;if(h.length===1&&(h[0].plmType==="Folder"||h[0].plmType==="RootFolder")){if(h[0].getID()===j.getID()){n=e.name_Section_AllFolders+" > "+l(m," > ",0);o=l(m,"/",1)}else{n=e.name_Section_AllFolders+" > "+l(m," > ",0);if(n===e.name_Section_AllFolders+" > "){n+=h[0].getLabel()}else{n+=" > "+h[0].getLabel()}}}else{n=e.name_Section_AllFolders+" > "+l(m," > ",0)}if(o===undefined){o=l(m,"/",0)}new i({ui:true,renderTo:widget.body,destination:"",parent:n,folderpath:o}).review(g).then(function(p){})})},endExecute:function(){}});return c});define("DS/FolderEditorCustomization/Utils/FolderEditorCustomizationServices",["UWA/Core","DS/WAFData/WAFData","DS/PADUtils/PADUtilsServices","DS/DocumentManagement/DocumentManagement","DS/FolderEditor/service/FolderEditorWebService","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADWSAccess","DS/PlatformAPI/PlatformAPI"],function(c,f,d,g,a,e,i,h){var b={getDocument:function(j){g.getDocuments([j.id],j)},getFolder:function(l){if(!c.is(l,"object")){throw new Error("Invalid inputs for BulkDownload.getFolder")}var k=d.get3DSpaceUrl()+"/resources/v1/FolderManagement/Folder/"+l.id+"/content?Content=All&FilterChildren=Yes",j={method:"GET",headers:{Accept:"application/json",SecurityContext:widget.getPreference("pad_security_ctx").value},timeout:120000};j.onComplete=l.onComplete;j.onFailure=l.onFailure;f.authenticatedRequest(k,j)},getChildren:function(l){if(!c.is(l,"object")){throw new Error("Invalid inputs for BulkDownload.getChildren")}var k=d.get3DSpaceUrl()+"/resources/enopad/api/expand",j={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:widget.getPreference("pad_security_ctx").value},timeout:120000};j.onComplete=l.onComplete;j.onFailure=l.onFailure;j.data=JSON.stringify({rootids:l.id,level:-1,with_iterations:true});f.authenticatedRequest(k,j)},getFileStatus:function(l){if(!c.is(l,"object")){throw new Error("Invalid inputs for BulkDownload.getFileStatus")}var k=d.get3DSpaceUrl()+"/resources/enodec/api/getfilestatus",j={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:widget.getPreference("pad_security_ctx").value},timeout:120000};j.onComplete=l.onComplete;j.onFailure=l.onFailure;j.data="{inputids: [{id:"+l.id.join("},{id:")+"}]}";f.authenticatedRequest(k,j)},getURLs:function(k){var j={};j.onComplete=k.onComplete;j.onFailure=k.onFailure;g.downloadDocuments(k.id,j)},getUserPreferences:function(j){a.getUserPreferences(j)},setUserPreferences:function(j){a.setUserPreferences(j)},fetch:function(k){var j={intent:"explore_2D",debug:e.getSetting("enopad_webapis_debug")};i.fetch({enopad_webapis:e.getSetting("enopad_webapis"),data:j,pids:k.pids,onComplete:function(m){var l=c.is(m,"string")?JSON.parse(m):m;k.onComplete(l)},onFailure:function(l){k.onFailure(l)},timeout:120000})},listFolders:function(l){var k=d.get3DSpaceUrl()+"/resources/v1/FolderManagement/Folder/"+l.pfolderid+"/folders",j={method:"GET",type:"json",headers:{"Content-Type":"application/json",SecurityContext:widget.getPreference("pad_security_ctx").value},proxy:"passport",timeout:120000};j.onComplete=l.onComplete;j.onFailure=l.onFailure;f.authenticatedRequest(k,j)},roots:function(l){var k=d.get3DSpaceUrl()+"/resources/v1/FolderManagement/Folder/roots",j={method:"GET",type:"json",headers:{"Content-Type":"application/json",SecurityContext:widget.getPreference("pad_security_ctx").value},proxy:"passport",timeout:120000};j.onComplete=l.onComplete;j.onFailure=l.onFailure;f.authenticatedRequest(k,j)},getProperties:function(l){var k=d.get3DSpaceUrl()+"/resources/v1/FolderManagement/Folder/"+l.folderid+"/properties",j={method:"GET",type:"json",headers:{"Content-Type":"application/json",SecurityContext:widget.getPreference("pad_security_ctx").value},proxy:"passport",timeout:120000};j.onComplete=l.onComplete;j.onFailure=l.onFailure;f.authenticatedRequest(k,j)},newFolder:function(m,l){var n={SecurityContext:"ctx::"+m.securityContext,type:"folder"};var k=d.get3DSpaceUrl()+"/resources/v1/collabServices/authoring/op/createContent?select=type&select=physicalid&select=cestamp";if(m.folderid!==""){k+="&folderID="+m.folderid}var j={method:"POST",type:"json",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:"ctx::"+m.securityContext},data:JSON.stringify(n),timeout:120000};j.onComplete=l.onComplete;j.onFailure=l.onFailure;f.authenticatedRequest(k,j)},updateFolderAttrib:function(n,m){var j=[{op:"replace",path:"description",value:n.description.replace(/\n/g,"\\n")},{op:"replace",path:"name",value:n.name}];if(n.owner){if(h.getUser().login!==n.owner){j.push({op:"replace",path:"owner",value:n.owner});var p=n.securityContext.split(".");j.push({op:"replace",path:"organization",value:p[1]});j.push({op:"replace",path:"project",value:p[2]})}}var o={requests:[{queryParams:{select:["physicalid"]},body:j,path:"model/bus/"+m.folderid,method:"PATCH"}]};var l=d.get3DSpaceUrl()+"/resources/v1/collabServices/attributes/op/update";var k={method:"PUT",type:"json",proxy:"passport",headers:{"Content-Type":"application/json",SecurityContext:"ctx::"+n.securityContext},data:JSON.stringify(o),timeout:120000};k.onComplete=m.onComplete;k.onFailure=m.onFailure;f.authenticatedRequest(l,k)},personSearch:function(l){var k=d.get3DSpaceUrl()+"/resources/v2/e6w/service/PersonSearch?searchStr="+l.name;var j={method:"GET",type:"json",proxy:"passport",timeout:120000};j.onComplete=l.onComplete;j.onFailure=l.onFailure;f.authenticatedRequest(k,j)},deleteFolder:function(n,m){var l=d.get3DSpaceUrl()+"/resources/lifecycle/Delete/structure";var k={method:"POST",type:"json",proxy:"passport",headers:{"Content-Type":"application/json",SecurityContext:n.securityContext},timeout:120000};var j="?";j+="SecurityContext="+n.securityContext;var o={data:[{physicalid:n.folderid}]};k.data=JSON.stringify(o);var p=function(){};k.onComplete=m.onComplete||p;k.onFailure=m.onFailure||p;f.authenticatedRequest(l+j,k)}};return b});define("DS/FolderEditorCustomization/ImportCSV/ActionBar_ImportCSVCmd",["UWA/Core","DS/ApplicationFrame/Command"],function(c,a){var b=a.extend({labelTopBar:c.i18n("Import Folder Structure"),isInsert:true,datas:{},init:function(d){this._parent(d,{mode:"exclusive",isAsynchronous:false});require(["DS/FolderEditor/Folder_CSO","DS/FolderEditor/utils/FolderEditorcontrol"],function(f,e){})},beginExecute:function(){},execute:function(){var d=require("DS/FolderEditor/Folder_CSO");var e=require("DS/FolderEditor/utils/FolderEditorcontrol");require(["DS/FolderEditorCustomization/ImportCSV/ImportCSV"],function(g){var f=c.Element.getElement.call(widget.body,".drop-csv");if(!f){new g({parent:e._TreeCont._folders_TreeDocument.getSelectedNodes()[0],renderTo:widget.body,currentFolder:d.getCurrentFolder()})}})},endExecute:function(){},});return b});define("DS/FolderEditorCustomization/ActiveFolder/ActiveFolder",["UWA/Core","UWA/Class","UWA/Class/Options","DS/Logger/Logger","UWA/Class/Promise","DS/UIKIT/Mask","DS/FolderEditor/utils/FolderAlert","DS/FolderEditor/utils/FolderCommunication","DS/PADUtils/PADUtilsServices","DS/UIKIT/Tooltip","DS/WebappsUtils/WebappsUtils","DS/FolderEditor/utils/FolderEditorcontrol","DS/PADUtils/PADProbes","DS/PADUtils/PADContext","DS/PADUtils/PADSettingsMgt","DS/FolderEditorCustomization/Utils/FolderEditorCustomizationServices","DS/PlatformAPI/PlatformAPI","DS/FolderEditorOpenness/FolderEditorSecurityContextCustomization","DS/UIKIT/Alert","i18n!DS/FolderEditorCustomization/assets/nls/ActiveFolder","css!DS/FolderEditorCustomization/FolderEditorCustomization.css"],function(j,t,r,u,e,v,o,k,p,s,g,c,i,q,l,b,d,f,m,h,n){var a=t.singleton({name:"ActiveFolder",ACTIVE_FOLDER_PREFERENCE:"ActiveFolder_FolderID",DEFAULT_VALUE:"!",ICON_ACTIVE:g.getWebappsAssetUrl("FolderEditorCustomization","icons/folder_active.png"),ICON_ACTIVE_DISABLED:g.getWebappsAssetUrl("FolderEditorCustomization","icons/folder_active_disabled.png"),_logger:null,_isInitialized:false,defaultOptions:{},_activeFolder:{origin:widget.id,id:null,label:"",node:null,sc:""},_disabledActiveFolder:{origin:widget.id,id:null,label:"",node:null,sc:""},init:function(w){var x=this;x._logger=u.getLogger(a);x._logger.log("init");x._parent(w);x.activeFolderCallBack();return x},activeFolder:function(){var w=this;if(w._activeFolder.id===null){w.getActiveFolderFromPreference().then(function(x){w._displayActiveFolder()})}else{w._displayActiveFolder()}w._isInitialized=true},getActiveFolderFromPreference:function(){var w=this;return w._getUserPreference().then(function(x){if(x===w.DEFAULT_VALUE&&x.length===w.DEFAULT_VALUE.length){return e.reject()}else{if(x.indexOf(w.DEFAULT_VALUE)>=0){x=x.slice(1,x.length);w._disabledActiveFolder={origin:widget.id,id:x,label:"",node:null,sc:""}}}return w._checkFolderStatus(x)}).then(function(x){if(w._disabledActiveFolder.id!==null){w._disabledActiveFolder.label=x.label;c.setActiveFolder(w.DEFAULT_VALUE,w._disabledActiveFolder.label,"",w._disabledActiveFolder.id);w._updateUI(w._disabledActiveFolder.id,"");return e.resolve(x)}w._activeFolder=x;w._setCustomSecurityContext();c.setActiveFolder(w._activeFolder.id,w._activeFolder.label,w._activeFolder.sc,w._disabledActiveFolder.id);k.publish("FolderEditor.ActiveFolder",Object.assign({},x,{node:""}));return e.resolve(x)},function(x){w._unsetAfterError()})},activeFolderCommand:function(y){var x=this;var z=c.getContent().getContent();v.mask(z);var w=x._activeFolder.id;x.unsetActiveFolder(x._activeFolder).then(function(){var A={id:y.getID(),label:y.getLabel(),node:y};if(w===A.id){v.unmask(z);o.displayNotification({message:h.replace(h.InfoMsg_Inactive_Successfully,{folderLabel:A.label}),className:"success"});return false}x.setActiveFolder(A).then(function(B){v.unmask(z);o.displayNotification({message:h.replace(h.InfoMsg_Active_Successfully,{folderLabel:x._activeFolder.label}),className:"success"})})})},setActiveFolder:function(x){var w=this;return w.services.setUserPreferences(w.ACTIVE_FOLDER_PREFERENCE,x.id).then(function(z){w._activeFolder=x;c.setActiveFolder(w.DEFAULT_VALUE,"","","");var A=w._disabledActiveFolder.id;w._disabledActiveFolder={origin:widget.id,id:null,label:"",node:null,sc:""};w._updateUI(A,"");c.setActiveFolder(w._activeFolder.id,w._activeFolder.label,w._activeFolder.sc,w._disabledActiveFolder.id);var y=c.getTreeCont();w._updateUI(w._activeFolder.id,w.ICON_ACTIVE);w.enableCenterActiveFolder();w._setCustomSecurityContext();d.publish("FolderEditor.ActiveFolder",{origin:widget.id,id:w._activeFolder.id!==w.DEFAULT_VALUE?w._activeFolder.id:null,label:w._activeFolder.label,sc:w._activeFolder.sc});return z})},unsetActiveFolder:function(x){var w=this;return w.services.setUserPreferences(w.ACTIVE_FOLDER_PREFERENCE,w.DEFAULT_VALUE).then(function(z){c.setActiveFolder(w.DEFAULT_VALUE,"","",w._disabledActiveFolder.id);var y=c.getTreeCont();w._updateUI(w._activeFolder.id,"");w._activeFolder.id=w.DEFAULT_VALUE;w.disableCenterActiveFolder();d.publish("FolderEditor.ActiveFolder",{origin:widget.id,id:null,label:"",sc:""});return z})},_getUserPreference:function(){var w=this;return w.services.getUserPreferences(w.ACTIVE_FOLDER_PREFERENCE).then(function(x){if(x.value===w.DEFAULT_VALUE){return w.DEFAULT_VALUE}else{return x.value}})["catch"](function(x){o.displayNotification({message:h.ErrorMsg_Rest_Error,className:"error"});return w.DEFAULT_VALUE})},_checkFolderStatus:function(x){var w=this;return new e(function(z,y){if(x===null||x===""||x===w.DEFAULT_VALUE){y();return}b.getProperties({folderid:x,onComplete:function(A){if(A.id===undefined){o.displayNotification({message:h.ErrorMsg_Rest_GetActiveFolder,className:"warning"});y()}else{z({id:A.id,label:A.label})}},onFailure:function(A){o.displayNotification({message:h.ErrorMsg_Rest_GetActiveFolder,className:"warning"});y()}})})},_unsetAfterError:function(){var y=this;y._activeFolder={origin:widget.id,id:y.DEFAULT_VALUE,label:"",node:null,sc:""};y._disabledActiveFolder={origin:widget.id,id:null,label:"",node:null,sc:""};y.services.setUserPreferences(y.ACTIVE_FOLDER_PREFERENCE,y.DEFAULT_VALUE);d.publish("FolderEditor.ActiveFolder",{origin:widget.id,id:null,label:"",sc:""});c.setActiveFolder(y.DEFAULT_VALUE,"","","");y._displayActiveFolder();var x="#d1d4d4";var w=h.Label_NoDefaultLocation;y._centerActiveFolderButton.setStyle("color",x);y._centerActiveFolderTooltip.setBody(w);y._disableActiveFolderButton.setStyle("color",x);y._disableActiveFolderTooltip.setBody(w)},_displayActiveFolder:function(){var B=this;var A=c.getTreeCont()._folders_SortElmt;if(A._activeElmt!==undefined){return true}var z="",y="",w="",C="";if(B._activeFolder.id===B.DEFAULT_VALUE&&B._disabledActiveFolder.id===null){z=y="#d1d4d4";w=C=h.Label_NoDefaultLocation}else{if(B._activeFolder.id!==B.DEFAULT_VALUE&&B._disabledActiveFolder.id===null){z=y="#378ec3";w=h.replace(h.Label_DefaultLocation,{folderLabel:B._activeFolder.label});C=h.replace(h.Label_DisableDefaultLocation,{folderLabel:B._activeFolder.label});var x=c.getTreeCont();B._updateUI(B._activeFolder.id,B.ICON_ACTIVE)}else{if(B._activeFolder.id===null&&B._disabledActiveFolder.id!==null){z="#378ec3";y="#d1d4d4";w=h.replace(h.Label_DefaultLocation,{folderLabel:B._activeFolder.label===""?B._disabledActiveFolder.label:B._activeFolder.label});C=h.replace(h.Label_EnableLocation,{folderLabel:B._activeFolder.label===""?B._disabledActiveFolder.label:B._activeFolder.label});B._activeFolder.id=B.DEFAULT_VALUE}}}B._centerActiveFolderButton=A._activeElmt=j.createElement("span",{"class":"active-folder",styles:{color:z},events:{click:function(D){if(B._activeFolder.id===B.DEFAULT_VALUE&&B._disabledActiveFolder.id===null){return false}B.centerTreeToActiveFolder(B._activeFolder.id!==B.DEFAULT_VALUE?B._activeFolder.id:B._disabledActiveFolder.id)}}}).inject(A.elements.container,"top");j.createElement("span",{"class":"fonticon fonticon-target",styles:{"font-size":"1.4em","text-align":"left"}}).inject(A._activeElmt);B._centerActiveFolderTooltip=new s({position:"bottom",target:A._activeElmt,body:w});j.createElement("span",{"class":"active-folder-separator"}).inject(A.elements.container,"top");B._disableActiveFolderButton=A._activeElmtButton=j.createElement("span",{"class":"active-folder",styles:{color:y},events:{click:function(D){if(B._activeFolder.id===B.DEFAULT_VALUE&&B._disabledActiveFolder.id===null){return false}var E=c.getContent().getContent();v.mask(E);if(B._activeFolder.id===B.DEFAULT_VALUE&&B._disabledActiveFolder.id!==null){B._centerActiveFolderButton.setStyle("color","#378ec3");B._centerActiveFolderTooltip.setBody(h.replace(h.Label_DefaultLocation,{folderLabel:B._disabledActiveFolder.label}));B._checkFolderStatus(B._disabledActiveFolder.id).then(function(){return B.setActiveFolder(B._disabledActiveFolder)}).then(function(){v.unmask(E);B._disabledActiveFolder={origin:widget.id,id:null,label:"",node:null,sc:""};o.displayNotification({message:h.replace(h.InfoMsg_Disable_Successfully,{folderLabel:B._activeFolder.label}),className:"info"})},function(F){B._unsetAfterError();v.unmask(E)});return false}if(B._activeFolder.id!==B.DEFAULT_VALUE&&B._disabledActiveFolder.id===null){B._disabledActiveFolder={origin:widget.id,id:B._activeFolder.id,label:B._activeFolder.label,node:B._activeFolder.node,sc:B._activeFolder.sc};B._disableActiveFolderButton.setStyle("color","#d1d4d4");B._disableActiveFolderTooltip.setBody(h.replace(h.Label_EnableLocation,{folderLabel:B._activeFolder.label}));B._checkFolderStatus(B._activeFolder.id).then(function(){return B.unsetActiveFolder(B._activeFolder)}).then(function(){return B.services.setUserPreferences(B.ACTIVE_FOLDER_PREFERENCE,B.DEFAULT_VALUE+B._disabledActiveFolder.id)}).then(function(){v.unmask(E);o.displayNotification({message:h.replace(h.InfoMsg_Enable_Successfully,{folderLabel:B._activeFolder.label}),className:"info"})},function(F){B._unsetAfterError();v.unmask(E)});return false}v.unmask(E)}}}).inject(A.elements.container,"top");j.createElement("span",{"class":"fonticon fonticon-flash",styles:{"font-size":"1.4em"}}).inject(A._activeElmtButton);B._disableActiveFolderTooltip=new s({position:"bottom",target:A._activeElmtButton,body:C})},activeFolderCallBack:function(x){var w=this;d.subscribe("FolderEditor.ActiveFolderCallBack",function(y){if(y===null){d.publish("FolderEditor.ActiveFolder",{origin:widget.id,id:w._activeFolder.id!==w.DEFAULT_VALUE?w._activeFolder.id:null,label:w._activeFolder.label,sc:w._activeFolder.sc});return}o.displayNotification({message:h.replace(h.InfoMsg_DefaultLocation,{folderLabel:y.label}),className:"info"})});d.subscribe("FolderEditor.ActiveFolderCheck",function(y){w._checkFolderStatus(w._activeFolder.id).then(function(){},function(z){if(w._disabledActiveFolder.id!==null){w._checkFolderStatus(w._disabledActiveFolder.id).then(function(){},function(A){w._unsetAfterError()})}else{w._unsetAfterError()}})})},enableCenterActiveFolder:function(){var w=this;w._centerActiveFolderButton.setStyle("color","#378ec3");w._centerActiveFolderTooltip.setBody(h.replace(h.Label_DefaultLocation,{folderLabel:w._activeFolder.label}));w._disableActiveFolderButton.setStyle("color","#378ec3");w._disableActiveFolderTooltip.setBody(h.replace(h.Label_DisableDefaultLocation,{folderLabel:w._activeFolder.label}))},disableCenterActiveFolder:function(){var w=this;w._disableActiveFolderButton.setStyle("color","#d1d4d4");if(w._activeFolder.id===w.DEFAULT_VALUE&&w._disabledActiveFolder.id===null){w._disableActiveFolderTooltip.setBody(h.Label_NoDefaultLocation);w._centerActiveFolderButton.setStyle("color","#d1d4d4");w._centerActiveFolderTooltip.setBody(h.Label_NoDefaultLocation)}},centerTreeToActiveFolder:function(w){var x=this;if(!x._isExpanding){x._isExpanding=true;c.getTreeCont().expandTreeAndSelectFolder({folderToFindAndSelect:{id:w},onComplete:function(z){function y(){var A=c.getTreeCont()._getVisibleNodeById(w,null);if(A){c.getTreeCont().expandTreeAndSelectFolder({folderToFindAndSelect:{id:w}});x._isExpanding=false;return true}else{setTimeout(function(){y()},200);return false}}y()},onGiveUp:function(y){x._isExpanding=false;o.displayNotification({message:h.ErrorMsg_Rest_GetActiveFolder,className:"warning"});x._unsetAfterError()},onFailure:function(y){x._isExpanding=false;o.displayNotification({message:h.ErrorMsg_Rest_GetActiveFolder,className:"warning"});x._unsetAfterError()}})}},_updateUI:function(C,z){var B=this;var w=c.getTreeCont();if(B._disabledActiveFolder.id!==null){z=B.ICON_ACTIVE_DISABLED}var A=w._getVisibleNodeById(C,w._rootNodeFolders);if(A!==null){A.setBadges({bottomLeft:z})}var y=c.getContent().getPADTreeListView().getRoots();for(var x=0;x<y.length;x++){if(y[x].id===C){y[x].setBadges({bottomLeft:z})}}},_setCustomSecurityContext:function(){var z=this;if(f.useComputedSecurityContext()){var y=[];var x=widget.getPreference("pad_security_ctx");if(x){var B=x.options;if(Array.isArray(B)){B.forEach(function(C){if(C.value){y.push(C.value)}})}else{z._logger.warn("The widget has no options for pad_security_ctx preference")}}else{z._logger.warn("The widget has no pad_security_ctx preference")}var w="";if(y.length>0){try{w=f.computeSecurityContext(z._activeFolder.id,y)}catch(A){z._logger.warn("FolderEditorSecurityContextCustomization throws exception",A)}}z._activeFolder.sc=w}else{z._activeFolder.sc=""}},services:{getUserPreferences:function(w){return new e(function(y,x){b.getUserPreferences({name:w,onComplete:function(z){y({keyname:w,value:z,message:null})},onFailure:function(z){x({keyname:w,value:null,message:h.ErrorMsg_Rest_Error})}})})},setUserPreferences:function(w,x){return new e(function(z,y){b.setUserPreferences({name:w,value:x,onComplete:function(A){z({keyname:w,value:x,message:null})},onFailure:function(A){y({keyname:w,value:x,message:h.ErrorMsg_Rest_Error})}})})},}});return a});define("DS/FolderEditorCustomization/ImportCSV/ImportCSV",["UWA/Core","UWA/Controls/Abstract","UWA/Class/Events","UWA/Class/Options","DS/Logger/Logger","UWA/Class/Promise","DS/FolderEditor/utils/FolderAlert","DS/UIKIT/Modal","DS/UIKIT/SuperModal","DS/UIKIT/Scroller","DS/UIKIT/Mask","DS/UIKIT/Input/Button","DS/UIKIT/Tooltip","DS/UIKIT/Popover","DS/Tree/Tree","DS/Tree/TreeNodeModel","DS/WebappsUtils/WebappsUtils","DS/Foundation/CsvParser","i18n!DS/FolderEditorCustomization/assets/nls/ImportStructureCSV","DS/FolderEditor/utils/FolderEditorcontrol","DS/Controls/ProgressBar","DS/UIKIT/Input/Text","DS/ENOFloatingPanel/ENOFloatingPanel","DS/PADUtils/PADProbes","DS/PlatformAPI/PlatformAPI","DS/FolderEditorCustomization/Utils/FolderEditorCustomizationServices","DS/FolderEditorCustomization/Utils/FolderEditorCustomizationUtils","DS/Encoding/Encoding","css!DS/FolderEditorCustomization/FolderEditorCustomization.css"],function(n,A,v,B,H,h,p,b,z,F,I,r,D,E,q,t,j,x,m,e,l,d,s,k,f,c,g,i,o){var a=1000;var C="323px";var w="570px";var G="435px";var y=5;var u=A.extend(B,v,{name:"ImportCSV",_logger:null,defaultOptions:{parent:null,renderTo:null,data:{level:0,name:1,description:2,aclOwner:3,aclSecurityContext:4,toModel:function(J){return{level:J[0].trim(),label:J[1].trim(),description:J[2].trim(),acl:{owner:J[3].trim()===""?"@BLANK@":J[3].trim(),securityContext:J[4].trim()===""?"@BLANK@":J[4].trim()}}}}},_droppableType:{"application/vnd.ms-excel":"csv","text/csv":"csv"},_isClosing:true,_checkErrorRef:[],_currentFolderType:"",_currentFolder:null,_cancel:false,_lv1SecCtxEmpty:false,_browserLanguage:"",_mapSecurityContext:null,_errorTips:[],_errorReasons:null,init:function(J){var L=this;var K=n.merge(J||{},L.defaultOptions);L._browserLanguage=L.utils.getBrowserLanguage();L._mapSecurityContext=L.mapSecurityContext();return new h(function(N,M){L._logger=H.getLogger(u);L._logger.log("init");L._parent(J);L._currentFolder=J.currentFolder;L._currentFolderType=J.parent.getType();L.inject();N(L)})},closeDialog:function(){var J=this;if(J.dialog){J.dialog.destroy()}},clickCancelButton:function(){var J=this;if(J._isClosing){J._cancel=true;J._errorTips.forEach(function(K){K.destroy()});J.closeDialog()}},inject:function(){var O=this;O._logger.log("inject");var N=k.createProbe("ImportCSV_inject");var J=O.createDownloadLinkDynamic();var T=new D({position:"bottom",target:J,body:m.Help_Csv_File});var Q=new s({closable:true,resizable:true,autocenter:true,overlay:true,header:null,className:"importCSVDialog",limitParent:true,body:'<div class="drop-csv"><input class="drop-csv-input" type="file" /><span class="drop-csv-label"><span class="fonticon fonticon-publish fonticon fonticon-2x"></span><p class="drop-csv-label-p"><span class="icon-label">'+m.Drop_Csv_File+'</span></p></span></div><div class="preview-csv"><div class="prev-csv-read"></div><div class="preview-csv-tree"><div class="preview-csv-tree-msg"></div></div></div>',footer:'<div class="csvstatus"></div>',events:{onHide:function(){if(O._isClosing){P.destroy();T.destroy()}O.clickCancelButton.call(O)}}}).inject(O.options.renderTo);var L=n.Element.getElement.call(Q.getHeader(),".floatingPanel_title span");window.top.dbg=Q.getHeader();L.setHTML("<span class='csv-title'>"+m.Dialog_Title+O.options.parent.getLabel()+"</span><span class='csv-title-icon'></span>");var K=n.Element.getElements.call(L,"span")[0];var R=n.Element.getElements.call(L,"span")[1];J.inject(R);var P=new D({position:"bottom",target:K,body:(O.options.parent.getParents().map(function(U){return U.options.label}).reverse().join(" > "))+" > "+O.options.parent.getLabel()});Q.getContent().setStyle("min-width","450px");Q.getContent().setStyle("width","450px");Q.getContent().setStyle("min-height","215px");Q.getContent().setStyle("height","215px");O.csvStatusArea=n.Element.getElement.call(Q.getFooter(),".csvstatus");O.notifyArea=new d({className:"detailmsg",value:"",disabled:true}).inject(Q.getFooter());var M=new r({value:m.Label_Import,className:"primary",disabled:true}).inject(Q.getFooter());M.addEvent("onClick",function(){this.disable();O.execImportCSV()});var S=new r({value:m.Cancel,className:"default",title:m.Cancel_Tooltip}).inject(Q.getFooter());S.addEvent("onClick",function(){O.clickCancelButton.call(O)});Q.show();O.dialog=Q;O.importButton=M;O.cancelButton=S;O.dropZone=n.Element.getElement.call(O.dialog.getBody(),".drop-csv");O.dropInput=n.Element.getElement.call(O.dialog.getBody(),".drop-csv-input");O.dropLabel=n.Element.getElement.call(O.dialog.getBody(),".drop-csv-label");O.dropLabelPara=n.Element.getElement.call(O.dialog.getBody(),".drop-csv-label-p");O.dialog.getBody().addClassName("dialog-csv");O.dialog.getBody().setStyle("height","100px");O.droppable(O.dropZone);N.end();return O},reset:function(){var J=this;J._logger.log("reset");if(J.tree){J.tree.destroy()}if(J.filePreview){J.filePreview.destroy()}J.tree=undefined;J.filePreview=undefined},_initProgress:function(J){if(this.progress){this.progress.destroy()}this.csvStatusArea.empty();this.progress=new l({shape:"circular",statusFlag:false,emphasize:J,dislpayFlag:false,displayStyle:"lite"});this.progress.inject(this.csvStatusArea);this.progress.value=0},droppable:function(M){var L=this;var J=0;L.dropInput.addEventListener("click",function(O){this.value=null},false);L.dropInput.addEventListener("change",K,false);L.listeners={};L.listeners.clickable=function(O){this.setStyle("border","1px solid #368ec4");this.setStyle("background-color","#f9f9f9");L.dropInput.click()};M.addEventListener("click",L.listeners.clickable);L.listeners.dragenter=function(O){this.setStyle("border","1px solid #368ec4");this.setStyle("background-color","#f9f9f9");J++};M.addEventListener("dragenter",L.listeners.dragenter);L.listeners.dragleave=function(O){J--;if(J===0){this.setStyle("border","1px solid #f4f5f6");this.setStyle("background-color","initial")}};M.addEventListener("dragleave",L.listeners.dragleave);L.listeners.dragover=function(O){O.preventDefault()};document.addEventListener("dragover",L.listeners.dragover);L.listeners.drop=function(P){P.preventDefault();if(P.dataTransfer.types){var O=false;if(P.dataTransfer.types.indexOf){O=(P.dataTransfer.types.indexOf("Files")!=-1)}else{O=P.dataTransfer.types.contains("Files")}if(O){K(P)}}};M.addEventListener("drop",L.listeners.drop);function N(O){I.unmask(M);p.displayNotification({message:O,className:"error"});M.addClassName("error");setTimeout(function(){M.removeClassName("error")},a)}function K(R){var Q=R.dataTransfer?R.dataTransfer.files:R.target.files;if(Q.length===0){return true}if(Q.length>1){N(m.ErrorMsg_Drop_Multiple_File);return}var P=Q[0].name.split(".");if(P.length<=1||"csv"!==P[P.length-1].toLowerCase()){console.warn("drop file:"+P[P.length-1].toLowerCase());N(m.ErrorMsg_Drop_File_Not_CSV);return}else{if(Q[0].size===0){N(m.ErrorMsg_Drop_File_Empty);return true}else{if(Q[0].size>1024*25){var S=m.ConfirmMsg_Drop_File_Size_Large+" ("+g.formatBytes(Q[0].size,2)+")";var O=new z({renderTo:L.options.renderTo,events:{onShow:function(){L._isClosing=false;L.dialog.hide()},onHide:function(){L._isClosing=true;L.dialog.show()}}});O.confirm(S,m.Label_Confirm_Title,function(T){if(T){L._loadCsv(M,Q[0])}})}else{L._loadCsv(M,Q[0])}}}}},_loadCsv:function(M,K){var L=this;I.mask(M);var J=function(O){I.unmask(M);L.updateDroppedFile({name:K.name,size:K.size})};L._errorTips=[];L._errorReasons=[];L.importButton.setValue(m.Label_Import);L.importButton.disable();L.reset();M.setStyle("border","1px solid #f4f5f6").setStyle("background-color","initial");var N=n.Element.getElement.call(L.dialog.getBody(),".preview-csv-tree");N.setStyle("height","0px").setStyle("border","solid 0px");N.empty();n.createElement("div",{"class":"tree-content"}).inject(N);h.all([L._readFile(K)]).then(function(O){var R=[];try{L._initProgress("info");L.csvStatusArea.addClassName("active");var P=x.parse(O[0]+"\r\n");h.all([L.checkLines(P),L.checkRemoteStatus(P)]).then(function(S){var T=S[0].concat(S[1]).sort(function(V,U){if(Math.abs(V.linePos)!==Math.abs(U.linePos)){return(Math.abs(V.linePos)<Math.abs(U.linePos))?-1:1}else{return(Math.abs(V.pos)<Math.abs(U.pos))?-1:1}}).filter(function(U){return U.reason!==""});L._errorReasons=T;L._prepareImportData(P,T,J)})}catch(Q){handleError(Q.message)}})},_prepareImportData:function(L,M,Q){var R=this;var N;var S=M.length===0;if(!S){N=[]}else{N=L}var U=R._createTreeView();var K=R._createTreeModel(N);U.getDocument().addRoot(K);R.tree=U;R.root=K;h.all([R.resolveSecurityContextOfSelectedFolder(R.root),R._showPreview(U),R._getStructure(K.options.id,K.options.label,0,K),]).then(function(Z){var Y=Z[0],V=Z[1],X=Z[2];K.options.appData.acl.securityContext=Y;var W=R.root.getAllDescendants().filter(function(ab){return(ab.options.appData.hasId)});if(S){var aa=L.length-W.length;if(aa===0){R.notifyMessage("info",m.InfoMsg_Create_Target_Size_Zero);R.cancelButton.setValue(m.Close);R.importButton.setValue(m.Label_Import+"(0)");R.importButton.disable();return}else{if(Y===null&&R._lv1SecCtxEmpty){p.displayNotification({message:m.WarnMsg_SecurityContext_MissMatch,className:"warning"});R.cancelButton.setValue(m.Close);R.importButton.setValue(m.Label_Import+"(0)");R.importButton.disable();return}else{R.importButton.enable();R.importButton.setValue(m.Label_Import+"("+(aa)+")")}}}})["catch"](function(V){p.displayNotification({message:m.ErrorMsg_Rest_Error+" "+V.message,className:"error"})});Q(U);var J=M.map(function(V){return Math.abs(V.linePos)}).filter(function(X,V,W){return W.indexOf(X)===V}).length;var P=L.length-J;var T=n.Element.getElement.call(R.dialog.getBody(),".tree-content");if(S){R.notifyMessage("info","["+P+"/"+L.length+"] "+m.InfoMsg_Load_Csv_Success);R.csvStatusArea.removeClassName("active")}else{R.notifyMessage("error","["+P+"/"+L.length+"]"+m.InfoMsg_Load_Csv_Error);R.progress.emphasize="high-attention";T.addClassName("csverror");var O=[m.Label_Column_Level,m.Label_Column_Name,m.Label_Column_Description,m.Label_Column_Owner,m.Label_Column_SecurityContext];M.forEach(function(Y){var X=Math.abs(Y.linePos);var aa=R.options.data;var W=n.createElement("div",{text:" ("+m.Label_LineNumber+":"+(X+1)+") "+Y.reason,"class":"errorline icon"+Y.pos});T.appendChild(W);if(Y.pos){var Z="";Z=O[Y.pos]+" : "+L[X][Y.pos];var V=new D({position:"bottom",target:W,body:g.Sanitize.encode(Z)});R._errorTips.push(V)}})}new F({element:T});T.addClassName("csvshow")},undroppable:function(J){if(this.listeners){J.removeEventListener("click",this.listeners.clickable);J.removeEventListener("dragenter",this.listeners.dragenter);J.removeEventListener("dragleave",this.listeners.dragleave);J.removeEventListener("dragover",this.listeners.dragover);J.removeEventListener("drop",this.listeners.drop);this.listeners=null}J.setStyle("cursor","default");this.dropLabel.setStyle("cursor","default");J.addClassName("drop-disabled")},updateDroppedFile:function(K){var L=this;L.dialog.getContent().setStyle("min-width",w);L.dialog.getContent().setStyle("min-height",G);L.dialog.getContent().setStyle("width",w);L.dialog.getContent().setStyle("height",G);var J=n.createElement("span",{"class":"csv-file",html:'<span class="csv-file-image"></span><span class="csv-file-name">'+K.name+" ("+g.formatBytes(K.size,2)+")</span>"});L.filePreview=J;L.dropLabel.setStyle("font-size","10px").setStyle("top","-5px").setStyle("float","right").setStyle("text-align","center");L.dropZone.setStyle("height","40px").setStyle("border","initial").setStyle("cursor","pointer");var M=n.Element.getElement.call(L.dropLabelPara,".icon-label");M.textContent=m.Change_Csv_File;var O=n.Element.getElement.call(L.dialog.getBody(),".preview-csv-tree");O.setStyle("height","calc(100% - (56px + 66px + 66px) )");O.setStyle("border","1px solid #e2e4e3").setStyle("top","100px");var N=n.Element.getElement.call(L.dialog.getBody(),".tree-content");if(!N){n.createElement("div",{"class":"tree-content"}).inject(n.Element.getElement.call(L.dialog.getBody(),".preview-csv-tree-msg"))}setTimeout(function(){J.inject(L.dropLabel,"before");L.undroppable(L.dropZone);if(!L.iconZone){L.iconZone=n.Element.getElement.call(L.dropZone,".fonticon");L.iconZone.setStyle("cursor","pointer");var P=function(R){L.dropInput.click()};L.iconZone.addEventListener("click",P,false);var Q=M;Q.setStyle("cursor","pointer");Q.addEventListener("click",P,false)}},a/3)},_readFile:function(K){var L=this;var J=new FileReader();return new h(function(N,M){J.onload=(function(){return function(O){N(O.target.result)}})(K);if(L._browserLanguage==="ja"){J.readAsText(K,"Shift-JIS")}else{J.readAsText(K,"WINDOWS-1252")}})},checkLines:function(K){var N=this;for(var M=0;M<K.length;M++){var J=K[M];if(J.length>=2&&J.length<y){for(var L=J.length;L<y;L++){J.push("")}}}return new h(function(aa,R){var Y=k.createProbe("ImportCSV_checklines");var Q=N.options.data;var T=0;var P=0;var aj="";var ag=[{}];var X={};var ae={};var af=[];var S=new RegExp("^-*[0-9]+$");N._checkErrorRef=af;for(var ab=0;ab<K.length;ab++){var V={reason:"",data:[],linePos:-1,pos:-1};var W=K[ab];if(W.length<y){V.reason=m.ErrorMsg_Column_Count;V.linePos=ab;V.pos=null;af.push(V);continue}if(P>=0){V.pos=Q.level;var O=W[Q.level];if(S.test(O)){O=parseInt(O)}else{V.reason=m.ErrorMsg_Level_Is_Not_Number;V.linePos=ab*-1;af.push(V);P=V.linePos;continue}if(O<=0){V.reason=m.ErrorMsg_Level_Origin;V.linePos=ab*-1;af.push(V);P=V.linePos;continue}if(P>=O||P+1===O){if(P>=O){var ah=P-O;for(var Z=0;Z<ah;Z++){ag.pop()}}aj=W[Q.name];if(ag.length+1===O){ag.push({})}X=ag[O-1];if(X[aj]){V.pos=Q.name;V.reason=m.ErrorMsg_Name_Duplicate;V.linePos=ab;P=O;af.push(V);continue}X[aj]=true;P=O}else{V.pos=Q.level;V.reason=m.ErrorMsg_Level_Is_Not_Sequencial;V.linePos=ab*-1;af.push(V);P=V.linePos;continue}}V.pos=Q.name;aj=W[Q.name];if(aj.trim()===""){V.reason=m.ErrorMsg_Name_Required;V.linePos=ab;af.push(V);continue}if(g.getStringByte4UTF8(aj)>=127){V.reason=m.ErrorMsg_Name_Max_Over;V.linePos=ab;af.push(V);continue}var ad=g.notAllowedChars.join("");var ai=new RegExp("["+ad+"]");var U=ai.exec(aj);if(U){V.reason=m.ErrorMsg_Avoid_Char+"("+U.map(function(ak){return ak}).join("&nbsp;")+")";V.linePos=ab;af.push(V);continue}aj=g.removeControllCode(aj);W[Q.name]=aj;V.pos=Q.description;var ac=W[Q.description];if(ac.length>1024){V.reason=m.ErrorMsg_Desc_Max_Over;V.linePos=ab;af.push(V);continue}U=ai.exec(ac);if(U){V.reason=m.ErrorMsg_Avoid_Char+"("+U.map(function(ak){return ak}).join("&nbsp;")+")";V.linePos=ab;af.push(V);continue}ac=g.escapeControllCode(ac);W[Q.description]=ac}Y.end();aa(af)})},checkRemoteStatus:function(J){var K=this;return new h(function(Y,Z){var M=k.createProbe("ImportCSV_checkRemoteStatus");var L=K.options.data;var aa={listeners:{}};var S;var N=[];K.csvStatusArea.addClassName("active");K._lv1SecCtxEmpty=false;var T=g.notAllowedChars.join("");var U=g.notAllowedCharsForOwner.join("");var Q=new RegExp("["+T+"]");var P=new RegExp("["+U+"]");var X=0;var W=0;var V=K.listSecurityContext();var O=-1;function R(){return{reason:"",data:[],linePos:-1,pos:-1}}J.forEach(function(aj,ah){if(aj.length<y){for(var ad=aj.length;ad<y;ad++){aj.push("")}}var ak=R();W++;var ab=aj[L.aclOwner];ab=ab.trim();var ag=[];var ac=null;ac=h.resolve(true);if(ab.length!==0){var ae=P.exec(ab);switch(true){case g.getStringByte4UTF8(ab)!==ab.length:ak.pos=L.aclOwner;ak.reason=m.ErrorMsg_Owner_Is_Not_Ascii;ak.linePos=ah;N.push(ak);ac=h.resolve("NOCHECK");break;case ae!==null:ak.pos=L.aclOwner;ak.reason=m.ErrorMsg_Avoid_Char+"("+ae.map(function(al){return al}).join("&nbsp;")+")";ak.linePos=ah;N.push(ak);ac=h.resolve("NOCHECK");break;default:ak.pos=L.aclOwner;ac=K._checkOwner(ah,ab,aa);break}}ag.push(ac);ak=R();var af=aj[L.aclSecurityContext].trim();ac=h.resolve(true);if(af.length!==0){ae=Q.exec(af);switch(true){case af.split(".").length!==3:ak.pos=L.aclSecurityContext;ak.reason=m.ErrorMsg_SecCtx_Is_Invalid;ak.linePos=ah;N.push(ak);ac=h.resolve("NOCHECK");break;case ae!==null:ak.pos=L.aclSecurityContext;ak.reason=m.ErrorMsg_Avoid_Char+"("+ae.map(function(al){return al}).join("&nbsp;")+")";ak.linePos=ah;N.push(ak);ac=h.resolve("NOCHECK");break;default:ak.pos=L.aclSecurityContext;ac=K._checkSecurityContext(ah,af,V);break}}else{if(aj[L.level].trim()==="1"){K._lv1SecCtxEmpty=true}}ag.push(ac);var ai=ah+"";h.all(ag).then(function(al){if(al[0]===true&&al[1]===true){if(K._checkErrorRef.filter(function(an){return Math.abs(an.linePos)===parseInt(ai)}).length===0){X++;var am=(X/J.length)*100;if(O!==am){K.progress.value=am;O=am}}}return al}).then(function(al){var an=null;var am=null;if(al[0]===false){an=m.ErrorMsg_Owner_Does_Not_Exist}if(al[0]===null){an=m.ErrorMsg_Rest_Error}if(an){am={reason:an,data:aj,linePos:ah,pos:L.aclOwner};N.push(am)}an=null;if(al[1]===false){an=m.ErrorMsg_SecCtx_Does_Not_Exist}if(an){am={reason:an,data:aj,linePos:ah,pos:L.aclSecurityContext};N.push(am)}W--;if(W===0){M.end();Y(N)}})})})},_createTreeModel:function(N){var M=this,O=M.options.data;var L=[];var K=k.createProbe("ImportCSV_createTreeModel");var J=new t({id:M.options.parent.id,label:M.options.parent.getLabel(),level:0,appData:{acl:{}},icons:[j.getWebappsAssetUrl("FolderEditor","icons/foldersectionall.png")]});L.push(J);N.forEach(function(R){var P=O.toModel(R);P.hasId=false;var Q=new t({level:P.level,label:P.label,appData:P,icons:[j.getWebappsAssetUrl("FolderEditor","icons/folder.png")]});var S=P.level;if(L.length===S){L.push(Q)}else{L[S]=Q}L[S-1].addChild(Q)});K.end();return J},_createTreeView:function(){var L=this;var K={apiVersion:2,height:"auto",position:"relative",width:"auto",isEditable:false,isSortable:false};K.selection={toggle:false,canMultiSelect:false,unselectAllOnEmptyArea:false,nodes:false,rowHeaders:false};L.dialog.getBody().setStyle("height",C);var J=new q(K).inject(n.Element.getElement.call(L.dialog.getContent(),".preview-csv-tree"));return J},notifyMessage:function(J,K){this.notifyArea.setValue(K);this.notifyArea.setClassName("detailmsg show "+J)},_showPreview:function(J){var K=this;return new h(function(N,M){function L(){if(n.Element.getElement.call(K.dialog.getBody(),".wux-scroller")!==null){setTimeout(function(){J.getDocument().expandAll();I.unmask(n.Element.getElement.call(K.dialog.getContent(),".preview-csv-tree"))},a/10);N(J)}else{setTimeout(function(){L()},a/10)}}L()})},_getStructure:function(N,J,M,L){var K=this;return new h(function(S,R){var P=k.createProbe("ImportCSV_getStructure");var O=function(T){T.options.icons=[j.getWebappsAssetUrl("FolderEditorCustomization","icons/folder_ng.png")];T.updateOptions("icons")};var Q={onComplete:function(Y){var W={};var ac=[];var U=Y.folders;var ae=L.getChildren()||[];var V=ae.map(function(af){return af.getLabel()});for(var aa=0;aa<U.length;aa++){var T=U[aa],ab=M+1;var Z={id:T.id,label:T.name,level:M+1};W[T.name]=Z;var ad=V.indexOf(T.name);if(ad!=-1){var X=ae[ad];X.options.id=T.id;X.options.icons=[j.getWebappsAssetUrl("FolderEditor","icons/foldersectionall.png")];X.options.appData.hasId=true;X.options.appData.modified=new Date(Date.parse(T.modified));X.options.appData.acl.securityContext=K.resolveCurrentSecurityContextBy(T.organizationResponsible,T.project);X.updateOptions("icons");ac.push(K._getStructure(T.id,T.name,ab,X))}}h.all(ac).then(function(af){S(W);P.end()})},onFailure:function(T){O(L);R(L.options.label);P.end()}};if(M===0&&K._currentFolderType==="FolderSection_AllFolders"){c.roots(Q)}else{Q.pfolderid=N;c.listFolders(Q)}})},resolveSecurityContextOfSelectedFolder:function(J){var K=this;return new h(function(N,M){var L=k.createProbe("ImportCSV_resolveSecurityContextOfSelectedFolder");if(J.options.id!==""){c.getProperties({folderid:J.options.id,onComplete:function(O){J.options.appData.acl.securityContext=K.resolveCurrentSecurityContextBy(O.organizationResponsible,O.project);N(J.options.appData.acl.securityContext);L.end()},onFailure:function(O){J.options.icons=[j.getWebappsAssetUrl("FolderEditorCustomization","icons/folder_ng.png")];J.updateOptions("icons");M({type:"check",message:"("+J.options.label+")",raw:O});L.end()}})}else{J.options.appData.acl.securityContext=K.utils.getCurrentSecurityContext();N(J.options.appData.acl.securityContext);L.end()}})},resolveCurrentSecurityContextBy:function(P,K){var N=this;var M=N.utils.getCurrentSecurityContext();var J=M.split(".");var L=J[1];var O=J[2];if(L===P&&O===K){return M}else{N._logger.warn("can't resolve securityContext : "+P+"."+K);return null}},execImportCSV:function(){var O=this;var J=k.createProbe("ImportCSV_execImportCSV");O._cancel=false;O._initProgress("success");O.csvStatusArea.addClassName("active");var K=O.root.getAllDescendants();var R=[];var T=0;for(var M=0;M<K.length;M++){var P=K[M];var Q;if(P.options.appData.hasId){Q=O.getFolder(P);T++}else{Q=O.createFolder(P)}R.push(Q)}var S=0;var N=null;var L=R.length-T;R.reduce(function(U,V){return U.then(function(W){O.progress.value=(S/L)*100;O.notifyMessage("info","["+(S)+"/"+L+"] "+m.InfoMsg_Folder_Creating);if(W.type==="create"){S++}}).then(V)},h.resolve({type:"dummy"}))["catch"](function(U){N=U.message||U}).then(function(U){O.cancelButton.setValue(m.Close);e.getContent().loadContentAndSelect(O._currentFolder);e.getTreeCont().updateTreeWithNewFolder(O._currentFolder);if(N===null){O.progress.value=100;O.notifyMessage("info","["+L+"/"+L+"] "+m.InfoMsg_Folder_Create_Success);O.csvStatusArea.removeClassName("active");p.displayNotification({message:m.InfoMsg_Folder_Create_Success,className:"info"})}else{O.notifyMessage("error","["+S+"/"+L+"] "+m.ErrorMsg_Folder_Create_Stoped);O.progress.emphasize="high-attention";p.displayNotification({message:N,className:"error"})}J.end()})},createDownloadLinkDynamic:function(){var O=this;var Q=O.createDownloadCSV();if(O._browserLanguage==="ja"){function P(U){var R=[];for(var T=0;T<U.length;T++){var S=U.charCodeAt(T);if(S<128){R.push(S)}else{if(S<2048){R.push(192|(S>>6),128|(S&63))}else{if(S<55296||S>=57344){R.push(224|(S>>12),128|((S>>6)&63),128|(S&63))}else{T++;S=65536+(((S&1023)<<10)|(U.charCodeAt(T)&1023));R.push(240|(S>>18),128|((S>>12)&63),128|((S>>6)&63),128|(S&63))}}}}return R}var M=P(Q);var L=i.convert(M,{to:"SJIS",from:"UTF8"});Q=new Int8Array(L)}var J=new Blob([Q],{type:"octet/stream"});var N=window.URL.createObjectURL(J);var K=n.createElement("a",{"class":"fonticon fonticon-help-circled csv-file-help",download:"template.csv",href:N});K.addEventListener("click",function(R){R.stopPropagation();if(window.navigator.msSaveOrOpenBlob){window.navigator.msSaveOrOpenBlob(J,"template.csv")}});return K},createDownloadCSV:function(){var K=this;var J=[];Object.keys(K._mapSecurityContext).forEach(function(N,L){var M=[""+(L+1),"Folder"+(L+1),"comment",f.getUser().login,N];J.push(M.join(","))});return J.join("\r\n")},createFolder:function(K){var J=this;return function(){var L=new h(function(O,N){if(J._cancel){J._logger.log("Import operation canceled");N({type:"create",message:m.ErrorMsg_Folder_Create_Stoped,raw:""});return}var M;if(K.options.appData.acl.securityContext!=="@BLANK@"){M=K.options.appData.acl.securityContext}else{M=K.getParent().options.appData.acl.securityContext}if(M!==null){if(J._mapSecurityContext[M]){M=J._mapSecurityContext[M]}K.options.appData.acl.securityContext=M}if(M===null){K.options.icons=[j.getWebappsAssetUrl("FolderEditorCustomization","icons/folder_ng.png")];K.updateOptions("icons");N({type:"create",message:m.WarnMsg_SecurityContext_MissMatch,raw:""});return}c.newFolder({folderid:K.getParent().options.id,securityContext:M},{onComplete:function(P){var T=[j.getWebappsAssetUrl("FolderEditorCustomization","icons/folder_ok.png")];if(P===null||P.result!=="SUCCESS"){K.options.icons=[j.getWebappsAssetUrl("FolderEditorCustomization","icons/folder_ng.png")];K.updateOptions("icons");var S;if(!P){S=m.ErrorMsg_Folder_Create_Stoped}else{S=P.message||m.ErrorMsg_Folder_Create_Stoped}N({type:"create",message:S,raw:P});return}var Q={name:K.options.appData.label,description:K.options.appData.description,securityContext:M};if(K.options.appData.acl.owner!=="@BLANK@"){Q.owner=K.options.appData.acl.owner}var R=P.id;c.updateFolderAttrib(Q,{folderid:R,onComplete:function(W){var U=W.results[0];if(U.status===200){K.options.id=R;K.options.icons=T;K.updateOptions("icons");O({type:"create",message:null,raw:W})}else{var V=function(){K.options.icons=[j.getWebappsAssetUrl("FolderEditorCustomization","icons/folder_ng.png")];K.updateOptions("icons");N({type:"create",message:J.utils.updateFolderAttribMessageResolver(W.results[0]),raw:W})};c.deleteFolder({securityContext:widget.getPreference("pad_security_ctx").value,folderid:R},{onComplete:V,onFailure:V})}},onFailure:function(U){J._logger.log("updateFolderAttrib failure");J._logger.log(U);K.options.icons=[j.getWebappsAssetUrl("FolderEditorCustomization","icons/folder_ng.png")];K.updateOptions("icons");N({type:"create",message:m.ErrorMsg_Folder_Create_Stoped,raw:U})}})},onFailure:function(P){K.options.icons=[j.getWebappsAssetUrl("FolderEditorCustomization","icons/folder_ng.png")];K.updateOptions("icons");N({type:"create",message:m.ErrorMsg_Rest_Error+"("+K.options.label+")",raw:P})}})});return L}},getFolder:function(K){var J=this;return function(){var L=new h(function(N,M){c.getProperties({folderid:K.options.id,onComplete:function(O){var P=new Date(Date.parse(O.modified));if(P.getTime()!==K.options.appData.modified.getTime()){K.options.icons=[j.getWebappsAssetUrl("FolderEditorCustomization","icons/folder_ng.png")];K.updateOptions("icons");M({type:"check",message:m.ErrorMsg_Exist_Folder_Modified+"("+K.options.label+")",raw:O})}else{N({type:"check",message:null,raw:O})}},onFailure:function(O){K.options.icons=[j.getWebappsAssetUrl("FolderEditorCustomization","icons/folder_ng.png")];K.updateOptions("icons");M({type:"check",message:m.ErrorMsg_Rest_Error+"("+K.options.label+")",raw:O})}})});return L}},_checkOwner:function(K,J,L){var M=this;var N=false;return new h(function(R,Q){if(J===""){R(true);return}if(L[J]){R(L[J]);return}var O=(L.listeners[J]!==undefined);var P=L.listeners[J]||[];P.push(R);L.listeners[J]=P;if(O){return}c.personSearch({name:J,onComplete:function(S){if(S.data.length===1){var T=S.data[0].dataelements.name;if(J===T){P.forEach(function(U){U(true)});L[J]=true}else{P.forEach(function(U){U(false)});L[J]=false}}else{P.forEach(function(U){U(false)});L[J]=false}},onFailure:function(S){N=true;M._logger.log("response error personSearch ");P.forEach(function(T){T(null)})}})})},listSecurityContext:function(){var K=[];var J=widget.getPreference("pad_security_ctx");if(J){var L=J.options;if(Array.isArray(L)){L.forEach(function(M){if(M.value){K.push(M.value.split("::")[1])}})}}return K},mapSecurityContext:function(){var L={};var J=widget.getPreference("pad_security_ctx");if(J){var K=J.options;if(Array.isArray(K)){K.forEach(function(M){if(M.value){L[M.label]=(M.value.split("::")[1])}})}}return L},_checkSecurityContext:function(J,M,K){var L=this;return new h(function(P,O){var N=null;if(M===""){P(true);return}if(L._mapSecurityContext[M]){P(true);return}else{if(K.indexOf(M)!==-1){N=true}else{N=false}P(N);return}})},utils:{getCurrentSecurityContext:function(){var J=widget.getPreference("pad_security_ctx").value;if(J.contains("ctx::")){return J.split("::")[1]}else{return J}},getBrowserLanguage:function(){try{return widget.lang}catch(J){return undefined}},updateFolderAttribMessageResolver:function(J){if(J.body&&J.body.errors&&J.body.errors.length!==0){return J.body.errors[J.body.errors.length-1].message}return m.ErrorMsg_Folder_Create_Stoped}}});return u});define("DS/FolderEditorCustomization/BulkDownload/BulkDownload",["UWA/Core","UWA/Controls/Abstract","UWA/Class/Events","UWA/Class/Options","DS/Logger/Logger","UWA/Class/Promise","DS/i3DXCompassServices/i3DXCompassPubSub","DS/FolderEditor/utils/FolderAlert","DS/ENOFloatingPanel/ENOFloatingPanel","DS/UIKIT/Scroller","DS/UIKIT/Mask","DS/UIKIT/Input/Button","DS/UIKIT/Tooltip","DS/UIKIT/Form","DS/Controls/LineEditor","DS/Controls/ProgressBar","DS/UIKIT/Spinner","i18n!DS/FolderEditorCustomization/assets/nls/BulkDownload.json","DS/PADUtils/PADProbes","DS/FolderEditorCustomization/Utils/FolderEditorCustomizationServices","DS/FolderEditorCustomization/Utils/FolderEditorCustomizationUtils","css!DS/FolderEditorCustomization/FolderEditorCustomization.css"],function(i,r,p,s,w,d,e,m,a,u,y,n,t,j,v,h,k,l,g,b,c){var o='<div class="review-files"></div>',q='<div class="form-settings"></div>';var x={dialogBody:'<div class="flip-container"><div class="flipper"><div class="front">'+o+'</div><div class="back">'+q+"</div></div></div>",};var f=r.extend(s,p,{name:"BulkDownload",_logger:null,defaultOptions:{ui:true,renderTo:null,id:[],destination:"",folder:"Workspace Vault",rootFolder:"Personal Workspace",document:"Document",product:"CATProduct",part:"CATPart",process:"CATProcess",analysis:"CATAnalysis",analysisResult:"CATAnalysisResults",drawing:"CATDrawing",design:"CATIA Design Table",cgr:"CATIA CGR",analysisComputations:"CATAnalysisComputations",shape:"CATShape"},URLATTR_NOURL:"NOURL",URLATTR_URL:"URL",FILENAMEATTR_EO:"EO-",_id:null,_settingChanged:false,_loadingReady:false,_getFileStatusAPIisReady:false,_warningDisplayisReady:false,_userCanceled:false,_downloadFailed:false,_downloadStarted:false,_cannotDownload:false,_folders:{},_foldersForDownload:null,_folderpathForFlatDownload:null,_folderRelation:{_map:{},pushFoldername:function(z,B){var A=this;if(A._map[z.toUpperCase()]===undefined){A._map[z.toUpperCase()]=[]}if(B!==null){A._map[z.toUpperCase()].push(B)}},hasParentFoldername:function(z){var B=this;var A=false;if(z.toUpperCase() in Object.keys(B._map)){A=true}return A},getFoldernames:function(z){var B=this;var A=B._map[z.toUpperCase()];if(A===undefined){A=[]}return A},clearMap:function(){var z=this;z._map={}}},_files:{},_syncFiles:{_syncFileList:[],_syncFileMap:{},addFile:function(B){var A=this;var z=false;if(A._syncFileMap[B]===undefined){A._syncFileMap[B]=1;A._syncFileList.push(B);z=true}return z},concatFiles:function(C){var B=this;for(var z=0;z<C.length;z++){var A=C[z];B.addFile(A)}},getList:function(){var z=this;return z._syncFileList},getLength:function(){var z=this;return z._syncFileList.length},getItem:function(z){var A=this;return A._syncFileList[z]},clearList:function(){var z=this;z._syncFileList=[];z._syncFileMap={}}},_issues:[],_errors:{ERRORID_NOTSYNC:"notUpToDate",ERRORID_INVALID:"IEF035520650",ERRORID_NOTEXIST:"IEF035520649",ERRORID_OTHER:"UNKNOWN",ERRORID_EMBEDED_COMPONENT:"#4000043",_syncErrorMap:{},_errorMap:{},_logger:null,pushError:function(E,C,B){var D=this;D._logger.log("Error happens. fileid=["+E+"], errorId=["+C+"], errorMessage=["+B+"]");var A=function(F){if(F===D.ERRORID_NOTSYNC){return l.displayMessage_notSync}else{if(F===D.ERRORID_INVALID){return l.displayMessage_invalid}else{if(F===D.ERRORID_NOTEXIST){return l.displayMessage_notExist}else{return l.displayMessage_unknown}}}};var z=D._errorMap[E];if(z===undefined){z={fileid:E,errorid:C,errorMessage:B,displayError:A(C)};D._errorMap[z.fileid]=z;if(C===D.ERRORID_NOTSYNC){D._syncErrorMap[z.fileid]=z}}else{if(z.errorid===D.ERRORID_OTHER){z.errorid=C;z.displayError=A(C)}}},getSyncErrorLength:function(){var z=this;return Object.keys(z._syncErrorMap).length},getFileIdList:function(){var z=this;return Object.keys(z._errorMap)},getError:function(A){var z=this;return z._errorMap[A]},init:function(z){var A=this;A._logger=z;A.clearList()},getErrorIdFromErrorMessage:function(A){var B=this;var z=B.ERRORID_OTHER;if(A.indexOf(B.ERRORID_EMBEDED_COMPONENT)>=0){z=B.ERRORID_EMBEDED_COMPONENT}return z},clearList:function(){var z=this;z._errorMap={};z._syncErrorMap={}}},_stats:{folders:0,files:0,size:0,error:0,warning:0,conflictCount:0},_settings:{DOWNLOAD_FLAT_PREFERENCE:{keyname:"BulkDownload_downloadFlat",defaultvalue:"false"},DOWNLOAD_WITH_CSV_PREFERENCE:{keyname:"BulkDownload_downloadWithCSV",defaultvalue:"false"},downloadFlat:false,downloadWithCSV:false},_tooltips:{_map:{},_sequence:0,pushTooltip:function(A){var z=this;z._sequence++;z._map[z._sequence]=A;return z._sequence},clearList:function(){var B=this;var A=Object.keys(B._map);for(var z=0;z<A.length;z++){B.deleteTooltip(A[z])}B._map={};B._sequence=0},deleteTooltip:function(B){var z=this;var A=z._map[B];A.destroy();delete z._map[B]}},_progress:{_progressbar:null,_injectTo:null,_maxValue:0,_currentValue:0,initProgress:function(A,z,C){var B=this;if(B._progressbar){B._progressbar.destroy()}B._progressbar=new h({shape:"circular",statusFlag:false,emphasize:A,dislpayFlag:false,displayStyle:"lite"});B._maxValue=null;B._progressbar.inject(z);B._progressbar.value=0;if(C!==undefined){B._maxValue=C}else{B._maxValue=4}B._currentValue=0;B._injectTo=z},addCurrentValue:function(){var z=this;z._currentValue++;var A=z._currentValue/z._maxValue*100;z._progressbar.value=A;if(z._maxValue===z._currentValue){z._injectTo.removeClassName("active")}},startProgress:function(){var z=this;z._injectTo.addClassName("active")},setErrorProgress:function(){var z=this;z._progressbar.emphasize="high-attention"}},init:function(z){var B=g.createProbe("BulkDownload_init");var A=this;A._logger=w.getLogger(f);A._logger.log("init");A._parent(z);A.options.container=A.options.folder+","+A.options.rootFolder;A.options.expandable=A.options.product+","+A.options.part+","+A.options.analysis+","+A.options.process+","+A.options.drawing+","+A.options.shape;A.options.leaf=A.options.document+","+A.options.analysisComputations+","+A.options.cgr+","+A.options.analysisResult+","+A.options.design;A._getFileStatusAPIisReady=false;A._warningDisplayisReady=false;A._userCanceled=false;A._downloadFailed=false;A._downloadStarted=false;A._cannotDownload=false;B.end();return A},closeDialog:function(){var z=this;z._tooltips.clearList();if(z.dialog){z.dialog.destroy()}},displayDialog:function(){var K=g.createProbe("BulkDownload_displayDialog");var D=this;D._logger.log(">>> start displayDialog");D._logger.log("injecting the modal dialog in widget body");var G=new a({closable:true,resizable:true,autocenter:true,overlay:true,header:null,className:"bulkDownloadDialog",title:l.dialogTitle,body:x.dialogBody,footer:"",visible:true,limitParent:true,events:{onHide:function(){},onClose:function(){D.clickCancelButton()}}}).inject(D.options.renderTo);var z=G.getHeader().getElementsByClassName("floatingPanel_title")[2];var L=z.getChildren()[0];if(D.options.parent!==undefined){var E=new t({position:"bottom",target:L,body:D.options.parent});D._tooltips.pushTooltip(E)}G.getContent().setStyle("min-width","650px");G.getContent().setStyle("min-height","300px");G.getContent().setStyle("height","350px");var I=i.createElement("div",{"class":"progressbar-area"}).inject(G.getFooter());D.progressbarArea=I;var J=i.createElement("span",{"class":"stats-area-displayCurrentProcess"}).inject(G.getFooter());D.statsArea=J;var H=new n({value:l.download,className:"primary"}).inject(G.getFooter());H.disable();H.addEvent("onClick",function(){D.clickDownloadButton.call(D)});var M=new n({value:l.cancel,className:"default"}).inject(G.getFooter());M.addEvent("onClick",function(){D.clickCancelButton.call(D)});G.show();var A=i.createElement("span",{"class":"bulk-settings fonticon fonticon-cog"}).inject(z);var C=new t({position:"bottom",target:A,body:l.bulkSettings});D._tooltips.pushTooltip(C);A.addEvent("click",function(O){var N=i.Element.getElement.call(G.getBody(),".flip-container");if(N.className.indexOf("flipped")>=0){i.Element.getElement.call(G.getBody(),".flip-container").removeClassName("flipped");if(D._settingChanged){D._settingChanged=false;if(D._loadingReady&&!D._downloadFailed){D.reloadDisplay()}}else{if(D._loadingReady&&!D._downloadStarted&&!D._cannotDownload&&!D._downloadFailed){D.downloadButton.enable()}}}else{i.Element.getElement.call(G.getBody(),".flip-container").addClassName("flipped");D.downloadButton.disable()}if(O.callback!==undefined){O.callback(D)}});var B=new u({element:i.Element.getElement.call(G.getContent(),".review-files")}).inject(i.Element.getElement.call(G.getBody(),".front"));var F=i.createElement("div",{"class":"errorfiles-review"}).inject(B.elements.content);D.dialog=G;D.scroller=B;D.downloadButton=H;D.errorFilesDiv=F;D.displayDialogSettings();y.mask(i.Element.getElement.call(G.getContent(),".review-files"));D._progress.initProgress("success",D.progressbarArea);D._logger.log("<<< end displayDialog");K.end();return D},clickDownloadButton:function(){var C=this;var A=Object.keys(C._files);function D(F){var E={};F.attributes.forEach(function(H){if(H.name==="type"){H.name="ds6w:type"}else{if(H.name==="owner"){H.name="ds6w:responsible"}else{var I=H.name.split("/");H.name=I[I.length-1]}}if(i.is(H.value)&&i.is(H.value.replace,"function")){H.value=H.value.replace(/\\n/g," ")}if(H.name==="ds6w:created"||H.name==="ds6w:modified"){var G=Date.parse(H.value);if(!isNaN(G)){H.value=new Date(G).toLocaleString()}}if(H.name==="ds6w:type"){E.type=H.value}if(H.name==="resourceid"||H.name==="physicalid"){E.resourceid=H.value}else{if(H.name==="did"){E.did=H.value}else{if(H.name==="type_icon_url"){if(!E.icons){E.icons=[]}E.icons.push(H.value)}else{if(H.name==="preview_url"||H.name==="thumbnail_2d"){E.thumbnail=H.value;if(!E.grid){E.grid={}}E.grid.thumbnail="url("+H.value+")"}else{if(H.name==="relcount"){E.relcount=parseInt(H.value)}else{if(H.name==="ds6w:label"){E.label=H.value}else{if(!E.grid){E.grid={}}E.grid[H.name]=H.value}}}}}}});return E}function z(F,E){F.attributes={};F.attributes.label=E.label;F.attributes.type=E.type;F.attributes.relcount=E.relcount;F.attributes.resourceid=E.resourceid;F.attributes.created=E.grid["ds6w:created"];F.attributes.modified=E.grid["ds6w:modified"];F.attributes.organizationResponsible=E.grid["ds6w:organizationResponsible"];F.attributes.policy=E.grid["ds6w:policy"];F.attributes.project=E.grid["ds6w:project"];F.attributes.reserved=E.grid["ds6w:reserved"];F.attributes.responsible=E.grid["ds6w:responsible"];F.attributes.revision=E.grid["ds6wg:revision"];F.attributes.description=E.grid["ds6w:description"];F.attributes.isDuplicated=E.grid.isDuplicated;F.attributes.isLastMinorRevision=E.grid.isLastMinorRevision;return F}if(C._settings.downloadWithCSV){y.mask(i.Element.getElement.call(C.dialog.getContent(),".review-files"));C.downloadButton.disable();var B=[];B.push(new d(function(F,E){C._logger.log("Fetch count = "+A.length);b.fetch({pids:A,onComplete:function(G){if(G.results===undefined||G.results.length!==A.length){E({response:G,errormessage:l.error_index});return}F({response:G})},onFailure:function(G,H){E({response:G,error:H})}})}));d.all(B).then(function(H){var E=H[0];C._logger.log("Fetch result count = "+E.response.results.length);if(C._userCanceled){return C}for(var G=0;G<E.response.results.length;G++){var I=D(E.response.results[G]);var F=C._files[I.resourceid];F=z(F,I)}C.startDownload();C.closeDialog()},function(F){var E=F[0];if(C._userCanceled){return C}if(F.response&&F.response.message&&F.response.message.indexOf("timedout")>-1){C.utils.errorHandling.call(C,"error",l.message_timeout_error)}else{C.utils.errorHandling.call(C,"error",F.errormessage)}})}else{C.startDownload();C.closeDialog()}},clickCancelButton:function(){var z=this;z._userCanceled=true;z.closeDialog()},removeReviews:function(G){var D=this;function C(J,I){for(var H=0;H<I.length;H++){J.removeChild(I[H])}}var z=D.scroller.elements.content;var B=z.getElementsByClassName("only-message-div");var E=z.getElementsByClassName("conflictfiles-review");if(E!==null){C(z,E)}if(B!==null){C(z,B)}D.statsArea.className="stats-area-displayCurrentProcess";C(D.statsArea,D.statsArea.getElementsByClassName("display-conflict-info"));C(D.statsArea,D.statsArea.getElementsByClassName("display-update"));if(G===true){var F=z.getElementsByClassName("errorfiles-review");if(F!==null){C(z,F)}var A=z.getElementsByClassName("errorfiles-review-warning");if(A!==null){C(z,A)}}},reloadDisplay:function(){var C=g.createProbe("BulkDownload_reloadDisplay");var B=this;B._logger.log(">>> start reloadDisplay");B.removeReviews();y.mask(i.Element.getElement.call(B.dialog.getContent(),".review-files"));var D=Object.keys(B._files);for(var A=0;A<D.length;A++){var z=B._files[D[A]];z.newFileName={}}B.checkAndDisplay();B._logger.log("<<< end reloadDisplay");C.end()},checkAndDisplay:function(){var H=g.createProbe("BulkDownload_checkAndDisplay");var F=this;F._logger.log(">>> start checkAndDisplay");var B=F._folders;var I=F._folderRelation;if(F._settings.downloadFlat){B={};B[""]=[];var A=[];I={_map:{"":[]},getFoldernames:function(J){return[]}};var z=Object.keys(F._folders);for(var D=0;D<z.length;D++){var G=F._folders[z[D]];for(var C=0;C<G.length;C++){B[""].push(G[C]);A.push(z[D])}}F._folderpathForFlatDownload=A}if(F._userCanceled){return F}F._foldersForDownload=B;var E=F._checkConflict(B,F._files,I);F._displayReview(B,F._files,E,F._errors,I);F._displayStats(B,F._files,E,F._errors,I);y.unmask(i.Element.getElement.call(F.dialog.getContent(),".review-files"));F._logger.log("<<< end checkAndDisplay");H.end()},displayDialogSettings:function(){var F=g.createProbe("BulkDownload_displayDialogSettings");var E=this;E._logger.log(">>> start displayDialogSettings");var D="";var G="";function A(I,H){new j({fields:[{type:"checkbox",value:l.settingFlat,className:"primary",label:l.settingFlat,checked:I==="true",events:{onChange:function(J){b.setUserPreferences({name:"BulkDownload_downloadFlat",value:this.isChecked().toString(),onComplete:function(K){},onFailure:function(K){}});E._settings.downloadFlat=this.isChecked();E._settingChanged=true}}},{type:"checkbox",value:l.settingWithCSV,className:"primary",label:l.settingWithCSV,checked:H==="true",events:{onChange:function(J){b.setUserPreferences({name:"BulkDownload_downloadWithCSV",value:this.isChecked().toString(),onComplete:function(K){},onFailure:function(K){}});E._settings.downloadWithCSV=this.isChecked()}}}]}).inject(i.Element.getElement.call(E.dialog.getBody(),".form-settings"));E._settings.downloadFlat=I==="true";E._settings.downloadWithCSV=H==="true"}var z=[];z.push(E._settings.DOWNLOAD_FLAT_PREFERENCE);z.push(E._settings.DOWNLOAD_WITH_CSV_PREFERENCE);var C=[];for(var B=0;B<z.length;B++){C.push(new d(function(J,I){var H=z[B];b.getUserPreferences({name:H.keyname,onComplete:function(K){var L=K;if(L===""){b.setUserPreferences({name:H.keyname,value:H.defaultvalue,onComplete:function(M){},onFailure:function(M){}});L=H.defaultvalue}J({keyname:H.keyname,value:L})},onFailure:function(K){J({keyname:H.keyname,value:H.defaultvalue})}})}))}d.all(C).then(function(I){for(var H=0;H<I.length;H++){var J=I[H];if(J.keyname===E._settings.DOWNLOAD_FLAT_PREFERENCE.keyname){D=J.value}else{if(J.keyname===E._settings.DOWNLOAD_WITH_CSV_PREFERENCE.keyname){G=J.value}}}A(D,G);E._logger.log("<<< end displayDialogSettings")});F.end()},review:function(C){var A=g.createProbe("BulkDownload_review");var z=this;z._logger.log(">>> start review");z._id=C;z.utils.reset.call(z);z._logger.log("starts the download review");if(Object.prototype.toString.call(C)!=="[object Array]"){z.utils.displayNotification(l.noId,"info");return d.resolve(null)}z._logger.log(C.length+" objects selected to be downloaded");z.displayDialog();z._progress.startProgress();var B=new d(function(E,D){z.getInfo(C).then(function(F){z._progress.addCurrentValue();if(z._userCanceled){return}return z._getData(F,true)}).then(function(J){z._logger.log(">>> start collect folders and files ");z._progress.addCurrentValue();if(z._userCanceled){return}z._displayUpdate("");var H={},I=z._files;H[""]=[];var F=function(P){var O="";var L="";var K="";for(var N=0;N<P.length;N++){if(Array.isArray(P[N])){F(P[N])}else{if(P[N].resolved===true){L=P[N].path+P[N].name;K=P[N].originalpath+P[N].originalname;var Q=Object.keys(H);O=L;for(var M=0;M<Q.length;M++){if(L.toUpperCase()===Q[M].toUpperCase()){O=Q[M]}}if(H[O]===undefined){H[O]=[]}}else{if(I[P[N]]===undefined){I[P[N]]={}}H[O].push({fileid:P[N],folderpath:L,originalFolderpath:K})}}}};F(J);z._folders=H;z._files=I;z._stats.folders=Object.keys(H).length-1;z._stats.files=Object.keys(I).length;z._logger.log("<<< end collect folders and files ");var G=false;z._logger.log(">>> start getURLs API ");return new d(function(P,O){var M=g.createProbe("BulkDownload_ForGetURLs");if(z._stats.files>0){var K=[];var Q=Object.keys(z._folders);for(var N=0;N<Q.length;N++){for(var L=0;L<z._folders[Q[N]].length;L++){K.push(z._folders[Q[N]][L].fileid)}}b.getURLs({id:K,onFailure:function(S,R){M.end();if(G){z._logger.log("<<< end getURLs API / got urls but got error")}else{if(R&&R.error.indexOf("timeout error")>-1){z.utils.errorHandling.call(z,S,l.message_timeout_error)}else{z.utils.errorHandling.call(z,S)}z._logger.log("<<< end getURLs API / got error");O(S)}},onComplete:function(R){G=true;z._logger.log("<<< end getURLs API / got urls ");P(R)}})}else{z._logger.log("<<< end getURLs API / no file case ");M.end();P([])}})}).then(function(H){var J=g.createProbe("BulkDownload_ForDisplayReview");z._logger.log(">>> start  check download files");z._progress.addCurrentValue();if(z._userCanceled){return z}var I=H;z._displayUpdate();for(var G=0;G<I.length;G++){z._files[I[G].id].fileName=I[G].fileName;z._files[I[G].id].newFileName={};if(z._files[I[G].id].downloadUrl===undefined){z._files[I[G].id].downloadUrl=[]}z._files[I[G].id].downloadUrl.push(I[G].downloadUrl);z._files[I[G].id].isDownloadedCurrentStatus={};if(I[G].errorMessage!==undefined){z._files[I[G].id].isDownloaded=false;z._files[I[G].id].hasError=true;var F=z._errors.getErrorIdFromErrorMessage(I[G].errorMessage);if(F===z._errors.ERRORID_EMBEDED_COMPONENT){z._files[I[G].id].isEmbeddedComponent=true}z._errors.pushError(I[G].id,F,I[G].errorMessage)}else{z._files[I[G].id].isUptodate=true;z._files[I[G].id].isDownloaded=true;if(z._files[I[G].id].fileName===undefined){z._files[I[G].id].fileName="DocumentsZIPFile.ZIP"}}}z._logger.log("<<< end  check download files");z._loadingReady=true;z._getFileStatusAsAsyncronous();z.checkAndDisplay();J.end();E(z)})});B["catch"]=function(D){z.utils.errorHandling.call(z,D)};z._logger.log("<<< end review");A.end();return B},getInfo:function(D){var C=this;var B=g.createProbe("BulkDownload_getInfo");C._logger.log("Getting information about the "+D.length+" objects selected");var A=[];for(var z=0;z<D.length;z++){A.push(new d(function(F,E){b.getDocument({id:D[z],onComplete:function(G){B.end();F(G)},onFailure:function(G){B.end();C.utils.errorHandling.call(C,G);E(G)}})}));A[z]["catch"]=function(E){C.utils.errorHandling.call(C,E)}}return d.all(A)},_getData:function(N,I){var H=this;var K=g.createProbe("BulkDownload__getData");H._logger.log(">>> start _getData");if(H._userCanceled){return}H._displayUpdate(N);var B=[],F=[],G=[],M=null;for(var E=0;E<N.length;E++){var D=N[E];var A=D.id=D.id||H.utils.getID(D);var J=D.type=D.type||H.utils.getType(D);var C=D.name||H.utils.getName(D);var z=D.name=C.replace("/","");D.originalname=C;switch(true){case H.options.container.indexOf(J)>=0&&D.resolved!==true:B.push(D);break;case H.options.expandable.indexOf(J)>=0:F.push(A);break;case H.options.leaf.indexOf(J)>=0:G.push(A);break;case H.options.container.indexOf(J)>=0&&D.resolved===true:M=D;break}}var L=[];for(var E=0;E<B.length;E++){L.push(new d(function(S,R){var P=B[E];var Q=g.createProbe("BulkDownload__ForGetFolder");H._logger.log(">>> start getFolder API");b.getFolder({id:P.id,onComplete:function(T){var V=JSON.parse(T).content;var U={id:P.id,type:P.type,name:P.name,path:M!==null?M.path+M.name+"/":"",originalname:P.originalname,originalpath:M!==null?M.originalpath+M.originalname+"/":"",resolved:true};V.unshift(U);H._folderRelation.pushFoldername(M!==null?M.path+M.name:"",P.name);H._logger.log("<<< end getFolder API / got children of oid=["+P.id+"]");Q.end();S(H._getData(V,true))},onFailure:function(T){H._logger.log("<<< end getFolder API / fails to get children of oid=["+P.id+"]");Q.end();H.utils.errorHandling.call(H,T);R(T)}})}));L[E]["catch"]=function(P){H.utils.errorHandling.call(H,P)}}if(I===true&&F.length>0){var O=new d(function(R,Q){H._logger.log(">>> start getChildren API");var P=g.createProbe("BulkDownload__ForGetChildren");b.getChildren({id:F,onComplete:function(W){var Z=JSON.parse(W),aa=[];var S=H._files;var ad=M!==null?M.path+M.name:"";var af={};for(var ab=0;ab<Z.paths.length;ab++){var U;var ac;for(var X=0;X<Z.paths[ab].length;X+=2){var T=S[Z.paths[ab][X]];if(T===undefined){T={}}if(X===0){U=Z.paths[ab][X];ac=Z.paths[ab][X];if(T.isTop===undefined){T.isTop={}}T.isTop[ad]=true}var V=false;if(X===0){if(af[X]===Z.paths[ab][X]){}else{af={};af[X]=Z.paths[ab][X];V=true}}else{if(X>0){if(af[X]===undefined||Z.paths[ab][X-1]!==af[X]){af[X]=Z.paths[ab][X-1];var ag=Object.keys(af);for(var Y=0;Y<ag.length;Y++){var ae=ag[Y];if(ae>X){af[ae]=undefined}}V=true}}}if(V){if(T.topFileid===undefined){T.topFileid={}}if(T.parentFileid===undefined){T.parentFileid={}}if(T.topFileid[ad]===undefined){T.topFileid[ad]=[]}if(T.parentFileid[ad]===undefined){T.parentFileid[ad]=[]}T.topFileid[ad].push(U);T.parentFileid[ad].push(ac);if(T.folderpaths===undefined){T.folderpaths=[]}if(!c.isExistsInArrayUpperCase(ad,T.folderpaths)){T.folderpaths.push(ad)}S[Z.paths[ab][X]]=T;aa.push(Z.paths[ab][X])}ac=Z.paths[ab][X]}}H._files=S;H._syncFiles.concatFiles(aa);M!==null?aa.unshift(M):false;H._logger.log("<<< end getChildren API / got children of top product oid=["+F.join(",")+"]");P.end();R(aa)},onFailure:function(S){H._logger.log("<<< end getChildren API / fails to get children of top product oid=["+F.join(",")+"]");P.end();H.utils.errorHandling.call(H,S);Q(S)}})});L.push(O);O["catch"]=function(P){H.utils.errorHandling.call(H,P)}}if(I!==true&&F.length>0){H._syncFiles.concatFiles(F);G=G.concat(F)}if(G.length>0){L.push(new d(function(Q,P){M!==null?G.unshift(M):false;Q(G)}))}H._logger.log("<<< end _getData");K.end();return d.all(L)},_getFileStatusAsAsyncronous:function(){var A=this;var z=g.createProbe("BulkDownload_ForGetFileStatus");A._logger.log(">>> start getFileStatus API");if(A._userCanceled){return}new d(function(C,B){if(A._syncFiles.getLength()>0){b.getFileStatus({id:A._syncFiles.getList(),onComplete:function(D){z.end();A._logger.log("<<< end getFileStatus API / got status");C({syncFiles:JSON.parse(D).results})},onFailure:function(D){z.end();A._logger.log("<<< end getFileStatus API / got error");if(D&&D.message.indexOf("timedout")>-1){A.utils.errorHandling.call(A,D,l.message_timeout_error)}else{A.utils.errorHandling.call(A,D)}B(D)}})}else{A._logger.log("<<< end getFileStatus API / no file to be checked");z.end();C({syncFiles:[]})}}).then(function(C){if(A._downloadStarted||A._userCanceled){return}var J=C.syncFiles;for(var D=0;D<J.length;D++){var B=A._files[J[D].id];if(B!==undefined&&J[D].isUptodate==="false"){A._errors.pushError(J[D].id,A._errors.ERRORID_NOTSYNC,J[D].message);if(!(B.isEmbeddedComponent!==undefined&&B.isEmbeddedComponent)){B.isUptodate=false;B.isDownloaded=true}}}A._getFileStatusAPIisReady=true;var G=i.Element.getElement.call(A.scroller.elements.content,".errorfiles-review");var F=A.scroller.elements.content.getElementsByClassName("now-loading-file-status-message");G.removeChild(F[0]);if(J.length===0){G.className="errorfiles-review-nothing"}else{if(A._errors.getSyncErrorLength()>0){A._displayErrorFilesInReview(A._errors,A._files);G.className="errorfiles-review-warning"}else{G.className="errorfiles-review-nothing"}}var E=i.Element.getElement.call(A.dialog.getFooter(),".display-conflict-info");var I=i.Element.getElement.call(E,".display-stats");var H=I.textContent.replace("...","");H+=A._stats.warning;I.textContent=H;I.title=H;A._progress.addCurrentValue()})},_displayReview:function(ap,U,J,Q,X){var ag=this;var N=g.createProbe("BulkDownload__displayReview");ag._logger.log(">>> start _displayReview");var af="only-message-div";ag._cannotDownload=false;var ad=i.Element.getElement.call(ag.dialog.getBody(),".flip-container");var V=Object.keys(J);V.sort();if(!ag._getFileStatusAPIisReady&&!ag._warningDisplayisReady){var P=i.createElement("div",{"class":"now-loading-file-status-message",html:'<span title="'+l.message_now_loading_file_status+'">'+l.message_now_loading_file_status+'</span><span class="now-loading-icon"></span><div title="'+l.message_now_loading_file_status_warning_message+'" style="margin-top:10px;">'+l.message_now_loading_file_status_warning_message+"</div>"}).inject(ag.errorFilesDiv);var F=i.Element.getElement.call(P,".now-loading-icon");y.mask(F,"");var ac=F.getElementsByClassName("spinner spinning")[0];ac.setStyle("width","50px");ag._warningDisplayisReady=true}var D=i.Element.getElement.call(ag.dialog.getBody(),".review-files");D.setStyle("height","100%");var A=i.Element.getElement.call(ag.dialog.getBody(),".flip-container");A.setStyle("height","100%");var ah=Object.keys(U);var z=true;for(var W=0;W<ah.length;W++){var ae=U[ah[W]];if(ae.isDownloaded){z=false;break}}if(z){ag._displayNothingToDownload(af);ag._cannotDownload=true;ag.downloadButton.disable();return ag}var H=ag._checkFilePathLength(ap,U);if(!H&&V.length===0){var M=i.createElement("p",{"class":af,html:"<span>"+l.message_okToDownload+"</span>"});M.inject(ag.scroller.elements.content);if(ad.className.indexOf("flipped")<0){ag.downloadButton.enable()}return ag}var L=0;if(V.length>0){var Y="conflict-filename-review";var aq=l.message_conflict_files_are;var P=i.createElement("div",{"class":"conflictfiles-review",html:'<div title="'+aq+'">'+aq+"</div>"}).inject(ag.scroller.elements.content);for(var ao=0;ao<V.length;ao++){if(ag._userCanceled){return ag}var ai=l.currentFolder;var O='<span class="fonticon fonticon-folder"></span>';if(ag._settings.downloadFlat){ai=l.conflictmessage_flatdownload;var aj=l.noFolderStructure;O+='<div class="conflict-filename-folder" title="'+ai+aj+'">'+ai+'<span class="conflict-filename-folder-comment">'+aj+"</span></div>"}else{var Z=V[ao]===""?ai:V[ao];O+='<div class="conflict-filename-folder" title="'+Z+'">'+Z+"</div>"}var M=i.createElement("span",{"class":"folder-review",html:O});M.inject(P);var R=J[V[ao]],G=Object.keys(R);for(var al=0;al<G.length;al++){var ab=G[al]+" ("+R[G[al]].length+" files)";var M=i.createElement("div",{"class":"file-review",html:'<span class="fonticon fonticon-cancel file-review-fonticon-cancel"></span><div class="'+Y+'" title="'+ab+'">'+ab+'</div><div class="file-review-editor"></div>'});M.inject(P);L++;var C=ag._isConflictBetweenFolderAndFile(G[al],V[ao],X);for(var aa=1;aa-C<R[G[al]].length;aa++){var K=R[G[al]][aa-C];var I=V[ao];var T=U[K].fileName;var ar=ag._renameFileWithCheckConflict(I,T,aa,K,ap,X,U);var B=c.splitExtension(ar);var S=new v({value:B.filename,sizeInCharNumber:20});S.inject(i.Element.getElement.call(M,".file-review-editor"));S.elements.container.className+=" file-review-editor-lineeditor";S._myInput.setStyle("width","calc(100% - 25px)");if(aa===1){var ak="fonticon fonticon-down-open expander-arrow",E="fonticon fonticon-up-open expander-arrow",an=ak;if(R[G[al]].length<=2-C){an=ak+" disabled"}var am=i.createElement("span",{"class":an});am.inject(S.getContent());if(R[G[al]].length>2-C){am.addEventListener("click",function(){var at=this.parentElement.parentElement.parentElement;if(at.className.indexOf("expanded")>=0){this.className=ak;at.removeClassName("expanded")}else{this.className=E;at.addClassName("expanded")}})}}S.options.targetFileid=K;S.options.callListenerFunction=true;S.options.parentFolder=I;S.options.extension=B.extension;ag._addEventListenerToLineEditor(S,ap,X,U)}}}}ag._stats.conflictCount=L;if(ad.className.indexOf("flipped")<0){ag.downloadButton.enable()}ag._logger.log("<<< end _displayReview");N.end()},_displayNothingToDownload:function(B){var z=this;var A=i.createElement("p",{"class":B,html:"<span>"+l.message_nothingToDownload+"</span>"});A.inject(z.scroller.elements.content)},_displayErrorFilesInReview:function(J,A){var G=this;G._logger.log(">>> start _displayErrorFilesInReview");var H=i.Element.getElement.call(G.scroller.elements.content,".errorfiles-review");i.createElement("span",{html:'<span title="'+l.message_files_are_warning_objects+'">'+l.message_files_are_warning_objects+"</span>"}).inject(H);var M=J.getFileIdList();var D=0;for(var B=0;B<M.length;B++){var F=J.getError(M[B]);if(F.errorid===G._errors.ERRORID_NOTSYNC){var z=A[F.fileid].fileName+" ( "+F.displayError+" )";var C=l.folderpaths;if(A[F.fileid].folderpaths!==undefined){var I=A[F.fileid].folderpaths.concat();I.sort();for(var E=0;E<I.length;E++){var K=I[E];if(K===""){K=l.currentFolder}C+="\n - "+K}}else{C+="\n - "+l.currentFolder}var L=i.createElement("div",{"class":"file-review",html:'<div title="'+C+'" class="attention-icon fonticon fonticon-attention"></div><span class="error-filename-review" title="'+z+'">'+z+'</span><div class="file-review-editor"></div>'});L.inject(H);D++}}G._stats.warning=D;G._logger.log("<<< end _displayErrorFilesInReview")},_isConflictBetweenFolderAndFile:function(A,z,D){var E=this;var C=D.getFoldernames(z);for(var B=0;B<C.length;B++){if(C[B].toUpperCase()===A.toUpperCase()){return 1}}return 0},_checkConflictInThesameFolder:function(A,D,F,K,C){var I=this;var E=F[A];var J=K.getFoldernames(A);for(var H=0;H<E.length;H++){var B=E[H];var G=C[B.fileid];if(G.isDownloaded){var z=G.fileName;if(G.newFileName[A]!==undefined){z=G.newFileName[A]}if(z.toUpperCase()===D.toUpperCase()){return true}}}for(var H=0;H<J.length;H++){if(J[H].toUpperCase()===D.toUpperCase()){return true}}return false},_renameFileWithCheckConflict:function(z,G,H,F,B,I,A){var D=this;var E=c.editFileName(G,H);if(D._checkConflictInThesameFolder(z,E,B,I,A)){E=D._renameFileWithCheckConflict(z,G,H+1,F,B,I,A)}else{var C=A[F];C.newFileName[z]=E}return E},_addEventListenerToLineEditor:function(D,A,z,C){var B=this;D.addEventListener("change",function(G){var O=g.createProbe("BulkDownload_lineEditorChange");var F=G.dsModel;if(!F.options.callListenerFunction){F.options.callListenerFunction=true;return}var P=F.value;var K=F.options.targetFileid;var J=C[K];var Q=F.options.extension;var E=F.options.parentFolder;var T=P;if(Q!==""){T+="."+Q}var I=c.checkFolderEditorInvalidCharsWithSlash.call(B,P);var N=I.hasInvalidChar;var M="";if(N){M=l.replace(l.message_error_name_badchars,{name:P,badChars:I.badChars})}if(!N){var R;if(E===""){R=P}else{R=E+"/"+P}N=R.length>256;M=l.replace(l.message_toolong_in_manual_rename,{name:P,chars:256})}if(!N){N=P.trim()==="";M=l.message_onlySpaceCharacter_in_manual_rename}if(!N){N=B._checkConflictInThesameFolder(E,T,A,z,C);M=l.replace(l.message_conflict_in_manual_rename,{name:P})}if(N){F.options.callListenerFunction=false;var H=J.fileName;if(J.newFileName[E]!==undefined){H=J.newFileName[E]}F.value=c.splitExtension(H).filename;if(F.options.tooltip){F.options.tooltip.elements.body.textContent=M}else{var S=new t({target:F.getContent(),body:M,position:"right",events:{onPreInject:function(V){var U=this.options.target.getBoundingClientRect().right;var W=parseInt(widget.body.getStyle("width").replace("px",""));if(U>W-200){this.options.position="bottom";this.getContent().className="tooltip tooltip-root bottom fade"}else{this.options.position="right";this.getContent().className="tooltip tooltip-root right fade"}}}});F.options.tooltip=S;var L=B._tooltips.pushTooltip(S);F.options.tooltipid=L}F.options.tooltip.show()}else{J.newFileName[E]=T;if(F.options.tooltip){F.options.tooltip.elements.body.remove();B._tooltips.deleteTooltip(F.options.tooltipid);F.options.tooltip=undefined;F.options.tooltipid=undefined}}if(F.options.callback!==undefined){F.options.callback(F)}O.end()})},_displayStats:function(U,B,J,D){var C=this;var X=g.createProbe("BulkDownload__displayStats");C._logger.log(">>> start _displayStats");var M=0;var E=Object.keys(U);var H={};for(var S=0;S<E.length;S++){var K=U[E[S]];var Y={};for(var Q=0;Q<K.length;Q++){var V=B[K[Q].fileid];var O;var G=E[S];if(C._settings.downloadFlat){G=C._folderpathForFlatDownload[Q]}if(V.topFileid!==undefined){var F=V.topFileid[G];if(F!==undefined&&F.length!==0){if(H[K[Q].fileid]===undefined){H[K[Q].fileid]={}}if(H[K[Q].fileid][G]===undefined){H[K[Q].fileid][G]=F.concat()}if(H[K[Q].fileid][G].length>0){var L=H[K[Q].fileid][G].shift();var I=C._files[L];var N=I.fileName;if(I.newFileName[E[S]]!==undefined){N=I.newFileName[E[S]]}O=N}else{O=""}}else{O=""}}else{O=""}var R=V.isDownloadedCurrentStatus;if(V.isDownloaded===true&&R!==undefined&&R[E[S]]!==false&&Y[O+"_"+K[Q].fileid]===undefined){M++;Y[O+"_"+K[Q].fileid]=1}}}C._stats.files=M;var z='<span class="display-issues" style="color:#57B847; float: left;">'+l.noConflict+"</span>";if(C._cannotDownload){z='<span class="display-issues"></span>'}else{if(C._stats.conflictCount>0){z='<span class="display-issues" style="color:#ff0000; float: left; text-decoration: underline;">'+C._stats.conflictCount+" "+l.conflict+"</span>"}}var T=l.files+" "+C._stats.files+", "+l.folders+" "+C._stats.folders+", "+l.warningfiles;if(C._getFileStatusAPIisReady){T+=" "+C._stats.warning}else{T+=" ..."}var P=z+"<br>",W='<span class="display-stats" style="float: left; text-align: left; white-space: nowrap; text-overflow: ellipsis; overflow: hidden;" title="'+T+'">'+T+"</span>";var A=i.createElement("div",{styles:{"float":"left",height:""},html:P+W,"class":"display-conflict-info"}).inject(C.statsArea);C._logger.log("<<< end _displayStats");X.end()},_displayUpdate:function(C){var B=this;try{i.Element.getElement.call(B.dialog.getFooter(),".display-update").remove()}catch(D){}if(C===undefined){return B}else{if(typeof C==="string"){i.createElement("div",{styles:{"float":"left",height:""},html:l.displayFooterMessage_retrievingFileInfo,"class":"display-update"}).inject(B.statsArea);return B}}var A=l.currentFolder;var z=C[0].resolved===true?C[0].name:A;i.createElement("div",{html:l.displayFooterMessage_browsingFolder+z,"class":"display-update"}).inject(B.statsArea)},_checkConflict:function(A,z,O){var J=this,H={};var M=g.createProbe("BulkDownload__checkConflict");J._logger.log(">>> start _checkConflict");function B(X,R,T,S,aa){var Q=Object.create(null),Y={};for(var V=0;V<T.length;++V){var W=Object.keys(Q);for(var U=0;U<W.length;U++){if(T[V].toUpperCase()!==Q[W[U]].toUpperCase()){Q[T[V]]=null}}}for(var V=0;V<X.length;++V){var P=X[V];var ab=Object.keys(Q);var Z=P;for(var U=0;U<ab.length;U++){if(ab[U].toUpperCase()===P.toUpperCase()){Z=ab[U];if(Y[Z]===undefined){Y[Z]=[];if(Q[Z]!==null){Y[Z].push(Q[Z])}}Y[Z].push(R[V]);break}}Q[Z]=R[V]}return Y}var N=Object.keys(A);for(var F=0;F<N.length;F++){var L=A[N[F]].concat(),K=[],I=[];for(var C=0;C<L.length;C++){var G=z[L[C].fileid];if(G.isDownloaded&&!c.isExistsInArray(L[C].fileid,I)){G.isDownloadedCurrentStatus={};var E=z[L[C].fileid].fileName;if(z[L[C].fileid].newFileName[N[F]]!==undefined){E=z[L[C].fileid].newFileName[N[F]]}K.push(E);I.push(L[C].fileid)}else{L.splice(C,1);C--}}var D=B(K,I,O.getFoldernames(N[F]),z,N[F]);if(Object.keys(D).length>0){H[N[F]]=D}}J._logger.log("<<< end _checkConflict");M.end();return H},_checkFilePathLength:function(N,A){var D=this;var O=[];var S=g.createProbe("BulkDownload__checkFilePathLength");D._logger.log(">>> start _checkFilePathLength");var E=Object.keys(N);for(var L=0;L<E.length;L++){var I=N[E[L]];var Q=[];for(var K=0;K<I.length;K++){var M=A[I[K].fileid];if(M.isDownloaded&&M.isDownloadedCurrentStatus!==undefined&&M.isDownloadedCurrentStatus[E[L]]!==false){var G=M.fileName;if(M.newFileName[E[L]]!==undefined){G=M.newFileName[E[L]]}var C=E[L]+"/"+G;if(C.length>256){Q.push(G)}}}if(Q.length>0){O.push({folderpath:E[L],filenames:Q})}}var R=O.length>0;if(R){var P=l.replace(l.message_there_is_toolong_filepath,{chars:256});var H=i.createElement("div",{"class":"only-message-div",html:'<div class="toolong-filepath-willnotbeDownloaded" title="'+l.message_there_is_toolong_filepath_willnot_be_downloaded+'">'+l.message_there_is_toolong_filepath_willnot_be_downloaded+'</div></div><div class="toolong-filepath-mainmessage" title="'+P+'">'+P+"</div>"});H.inject(D.scroller.elements.content,"top");for(var F=0;F<O.length;F++){var z=i.createElement("div",{"class":"toolong-filepaths",html:'<span class="fonticon fonticon-folder"></span><div class="toolong-filepath-path" title="'+O[F].folderpath+'">'+O[F].folderpath+"</div>"});z.inject(H);for(var J=0;J<O[F].filenames.length;J++){var B=i.createElement("div",{"class":"toolong-filepath-filename",title:O[F].filenames[J],html:O[F].filenames[J]});B.inject(H)}}}D._logger.log("<<< end _checkFilePathLength");S.end();return R},startDownload:function(){var E=this;var H=0;var A=0;var B=0;var M=0;var z=E._getFileStatusAPIisReady;E._downloadStarted=true;var X=g.createProbe("BulkDownload_startDownload");E._logger.log(">>> start startDownload");var U=E._foldersForDownload;var J=Object.keys(U),W=[];for(var T=0;T<J.length;T++){var O=U[J[T]];var Q={};for(var S=0;S<O.length;S++){var V=E._files[O[S].fileid];var L=J[T];if(E._settings.downloadFlat){L=E._folderpathForFlatDownload[S]}var P=E._getTopFilename(O[S].fileid,L,J[T]);var K=E._getParentFilename(O[S].fileid,L,J[T]);var G="";if(E._settings.downloadWithCSV){var C="";if(z===false){C=l.do_not_get_filestatus}else{if(V.isUptodate===false){C=l.displayMessage_notSync}}var R="";if(V.attributes.description!==undefined){R=V.attributes.description}G+=' "'+V.attributes.label+'" "'+V.attributes.type+'" "'+V.attributes.revision+'" "'+V.attributes.responsible+'" "'+V.attributes.created+'" "'+V.attributes.modified+'" "'+C+'" "'+encodeURI(R)+'"'}var I="";var N="";var D=E.URLATTR_NOURL;if(V.isDownloaded===true){I=V.fileName;N=V.fileName;if(V.newFileName[J[T]]!==undefined){N=V.newFileName[J[T]]}if(V.isDownloadedCurrentStatus!==undefined&&V.isDownloadedCurrentStatus[J[T]]!==false){if(!(V.downloadUrl===undefined||V.downloadUrl.length===0)&&Q[P+"_"+O[S].fileid]!==1){D=V.downloadUrl.shift();Q[P+"_"+O[S].fileid]=1}}}else{if(V.isEmbeddedComponent){I=E.FILENAMEATTR_EO+O[S].fileid;N=E.FILENAMEATTR_EO+O[S].fileid}}var F=O[S].originalFolderpath;if(F===""||F===undefined){F=""}else{if(E.options.folderpath!==""&&E.options.folderpath!==undefined){F="/"+F}}if(D!==E.URLATTR_NOURL){D=E.URLATTR_URL}W.push({downloadUrl:D,path:J[T],fullpath:E.options.folderpath+F,fileName:N,orgFileName:I,topFilename:P,parentFilename:K,fileid:O[S].fileid,attributes:G});if(D!==E.URLATTR_NOURL){if(P===""&&K===""){H++;if(I!==N){A++}}else{B++;if(I!==N){M++}}}}}E._logger.log("<<< end startDownload");E._sendDownloadRequest(W,{documentFileCount:H,documentRenamedFileCount:A,catiaFileCount:B,catiaRenamedFileCount:M});X.end()},_getTopFilename:function(z,I,G){var E=this;var F;var A=E._files[z];if(A.topFileid!==undefined){var H=A.topFileid[I];if(H!==undefined&&H.length!==0){var C=H.shift();var D=E._files[C];var B=D.fileName;if(D.newFileName[G]!==undefined){B=D.newFileName[G]}F=B}else{F=""}}else{F=""}return F},_getParentFilename:function(z,I,G){var E=this;var F;var A=E._files[z];if(A.parentFileid!==undefined){var H=A.parentFileid[I];if(H!==undefined&&H.length!==0){var C=H.shift();var D=E._files[C];if(D.isEmbeddedComponent===true){B=E.FILENAMEATTR_EO+C}else{var B=D.fileName;if(D.newFileName[G]!==undefined){B=D.newFileName[G]}}F=B}else{F=""}if(F===undefined){F=""}}else{F=""}return F},_sendDownloadRequest:function(J,F){var G=this,A;var B=F.documentFileCount;var z=F.documentRenamedFileCount;var H=F.catiaFileCount;var E=F.catiaRenamedFileCount;A='{"lang":"'+widget.lang+'", "objects":"'+G._stats.files+'", "documentFileCount":"'+B+'", "documentRenamedFileCount":"'+z+'", "catiaFileCount":"'+H+'", "catiaRenamedFileCount":"'+E+'"}\n';var I=g.createProbe("BulkDownload__sendDownloadRequest");G._logger.log(">>> start _sendDownloadRequest");for(var D=0;D<J.length;D++){var K=J[D].path;if(K!==""){K=K+"/"}A+=J[D].downloadUrl+' "'+J[D].fileid+'" "'+K+'" "'+J[D].orgFileName+'" "'+J[D].fileName+'" "'+J[D].topFilename+'" "'+J[D].parentFilename+'" "'+J[D].fullpath+'"'+J[D].attributes+"\n"}var C={widgetId:widget.id,appId:"ENOFOLB_AP",fileName:"-d",fileContent:A};if(G._userCanceled){return G}e.subscribe("launchAppCallback",function(L){if(L&&L.widgetId===widget.id){if(L.response==="COMPLETE"){G.utils.displayNotification(l.launched,"success")}else{G.utils.displayNotification(l.failed,"error")}e.unsubscribe("launchAppCallback");G._logger.log("<<< end _sendDownloadRequest")}else{}});e.publish("launchApp",C);G.utils.displayNotification(l.starting,"info");I.end()},utils:{getID:function(z){return z.data[0].id},getType:function(z){return z.data[0].type},getName:function(z){var B="";try{B=z.data[0].dataelements.title;B=B===""?z.data[0].dataelements.name:B}catch(A){}return B},displayNotification:function(A,z){m.displayNotification({message:A,className:z})},reset:function(){var z=this;z._folders={};z._folderRelation.clearMap();z._files={};z._issues=[];z._errors.init(z._logger);z._syncFiles.clearList();z._stats={folders:0,files:0,error:0,size:0,warning:0,conflictCount:0};z._tooltips.clearList();z._foldersForDownload=null;z._folderpathForFlatDownload=null},errorHandling:function(z,B){var C=this;C._logger.log(z);if(!C._downloadFailed){C.removeReviews(true);var A=l.failed;if(B!==undefined){A=B}y.unmask(i.Element.getElement.call(C.dialog.getContent(),".review-files"));C.downloadButton.disable();var D=i.createElement("p",{"class":"download_failed_message",html:"<span>"+A+"</span>"});D.inject(C.scroller.elements.content);C._progress.setErrorProgress();C._downloadFailed=true}}}});return f});