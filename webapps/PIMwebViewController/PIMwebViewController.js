/*!  Copyright 2018 Dassault Systemes. All rights reserved. */
define("DS/PIMwebViewController/PIMwebItfCtrl",["UWA/Class","UWA/Core","UWA/Utils","DS/Visualization/ThreeJS_DS","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/CATWebUXSlideShow/CATWebUXSlideShowController","DS/PIMwebUX/PIMwebItfListUI","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/PADUtils/PADSettingsMgt","DS/PIMwebViewModel/PIMwebIsrMgr","DS/PIMwebUX/PIMwebOpacitySlider","DS/PADUtils/PADUtilsServices","DS/PIMwebViewModel/PIMwebUnits","DS/Windows/Panel","DS/Windows/Dialog","DS/Controls/Button","DS/WebappsUtils/WebappsUtils","DS/CoreEvents/ModelEvents","i18n!DS/PIMwebViewController/assets/nls/PIMwebItfCtrl","i18n!DS/PIMwebUX/assets/nls/PIMwebItfListUI"],function(C,x,g,D,u,m,E,p,h,o,w,n,j,y,f,q,d,s,k,c){function v(H){var G;for(var F=H.externalPath.length-1;F>=0&&!G;--F){if(p.isPLMNode(H.externalPath[F])){G=H.externalPath[F]}}return G?p.getNodeID(G):null}function l(J,G){var K,F,M,I,H,L=G.getController();if(J.length){M=L.getRootBagPath();for(K=0,F=J.length-1;K<=F;++K){I=L.getNode({id:J[K]});if(I){if(K===F){M.addElement(I)}else{H=I.getParents();if(H.length!==1){window.console.log("Instance with more than one parent!!");M=null;break}M.addElement(H[0]);M.addElement(I)}}else{M=null;break}}}return M&&M.checkExternalPath()?M:null}function b(G,K,O){var Q,L,N,J,I,P=[],M;if(!K||K.length===0||!G){return P}M=o.getIsr(K[0].itfModelId).getIsrContextIDs();if(M.length===0){return P}var H=M.filter(function(R){return O.indexOf(R)===-1});if(H.length){return P}for(Q=0,N=K.length;Q<N;++Q){var F=K[Q];if(!F||!F.itfSca2occ){continue}if(F.itfInstance1&&F.itfInstance2){continue}J=[];I=[];if(F.itfR2Sca){for(L=0;L<F.itfR2Sca.length;++L){J.push(F.itfR2Sca[L].physicalid);I.push(F.itfR2Sca[L].physicalid)}}if(F.itfSca2occ.length>0&&F.itfSca2occ[0]&&F.itfSca2occ[0].length){for(L=0;L<F.itfSca2occ[0].length;++L){J.push(F.itfSca2occ[0][L].physicalid)}}else{J.length=0}if(F.itfSca2occ.length>1&&F.itfSca2occ[1]&&F.itfSca2occ[1].length){for(L=0;L<F.itfSca2occ[1].length;++L){I.push(F.itfSca2occ[1][L].physicalid)}}else{I.length=0}F.itfInstance1=l(J,G);F.itfInstance2=l(I,G);F.itfInstance1Label=F.itfInstance1?F.itfSca2occ[0][F.itfSca2occ[0].length-1].label:"";F.itfInstance2Label=F.itfInstance2?F.itfSca2occ[1][F.itfSca2occ[1].length-1].label:"";if(F.itfInstance1||F.itfInstance2){P.push(F)}}return P}function B(G){var F="0-"+String(G.userValue)+"-"+String(G.checkedButton);localStorage.setItem("PIMwebOpacityPref",F)}function e(){var J={userValue:10,checkedButton:0},H=localStorage.getItem("PIMwebOpacityPref");if(typeof H==="string"){var G=H.split("-"),I=Number(G[1]),F=Number(G[2]);if(typeof I==="number"){J.userValue=0<=I&&I<=100?I:J.userValue}if(typeof F==="number"){J.checkedButton=0<=F&&F<=2?F:J.checkedButton}}return J}function a(H,G,J){var I=[];if(H){var F=H.getKey();if(J.indexOf(F)===-1){if(G.some(function(K){return H.isAParentOf(K)})){H.getChildrenPathes().forEach(function(K){Array.prototype.push.apply(I,a(K,G,J))})}else{I.push(H)}}}return I}var i=(function(){var H,F;function G(K){var I,L,J={};for(I in K){if(K.hasOwnProperty(I)){switch(I){case"itfQuantifier":case"itfTolerance":L=K[I];if(typeof L==="number"){L=(L*F).toFixed(3)+H}else{L=""}J[I]=L;break;case"itfPrevAnalysis":J[I]=(K[I]==="OK"||K[I]==="KO")?K[I]:"";break;default:J[I]=K[I]}}}return J}return function(I){H=window.widget?window.widget.getValue(j.Types.Length.name):"mm";F=j.Length[H]?j.Length[H].ratio:1;H=j.Length[H]?j.Length[H].nls:"mm";return I.map(G)}})();var r=C.extend({init:function(N){var H=this,G,F=null,M=N.readOnly,I=N.cbDnD;var L=N.frameWindow.getImmersiveFrame();function J(O){require(["DS/Windows/Dialog","DS/Controls/ButtonGroup","DS/Controls/Toggle"],function(U,V,R){var S=new U();var T=new x.Element("div",{"class":"wux-control-inline-container",style:{"vertical-align":"top"}});S.content=T;var Q=new V();Q.inject(T);O.forEach(function(W){Q.addChild(new R({type:"radio",label:W.label,value:W.value}))});Q.addEventListener("change",function P(W){F.onShowColumnComplete(W.dsModel.value.toString());L.removeWindow(S);S.destroy()});L.addWindow(S)})}function K(){var O=d.getWebappsAssetUrl("PIMwebUX","icons/22/");G=new y({title:c.noItf,identifier:"PIMwebItfListPanel",icon:O+"I_ExamineInterference.png",immersiveFrame:L,resizableFlag:true,height:200,width:500,collapsibleFlag:true,floatableFlag:true,maximizeButtonFlag:true,horizontallyStretchableFlag:true,verticallyStretchableFlag:true,currentDockArea:WUXDockAreaEnum.BottomDockArea});G.elements.container.addClassName(G.identifier);var P={parent:G,readOnly:M,cbDnD:I};F=new E(P);I=null;F.onShowColumn=J;G.hide();G.close=function(){if(!H.onClose){window.console.log("onClose function must be provided");return}H.onClose()}}this.getTreeListViewer=function(){return F};this.show=function(){if(!G){return}G.show(true);if(G.getDockedFlag()){var P=L.getDockingElement(G.currentDockArea).getContainedWindows();if(P.length===1&&P[0].isAWindowGroup()){P[0].currentWindows=[G]}var O=L.getDockingElement(G.currentDockArea);if(O.collapseDockingZoneFlag){O.collapseDockingZoneFlag=false}}};this.hide=function(){if(G){G.hide(false)}};this.updatePanelTitle=function(O){if(!G){return}G.title=O};this.onClose=null;this.toggleReadOnly=function(){if(F){F.toggleReadOnly()}};K()}});var z=C.extend({init:function(aa){var I=this,ae,Q,M={},aj=[],U=false,ax,ad,S=new s(),ar,R,H={},V,af,ah={},F,P={},ac=[],L=aa.pad3DViewer,Y,ab=true,az=false,av,K=[],G=true;function T(aA){if(P[aA]){F.remove(P[aA]);delete P[aA]}}var W=(function(){var aB,aC,aI,aS,aK,aN,aG,aQ,aT=3,aF=1,aA=new D.Color(16711680),aH=new D.Color(65280),aM=new D.LineBasicMaterial({color:aA,side:D.DoubleSide,transparent:true,opacity:1,force:true,lineWidth:aT}),aE=new D.LineBasicMaterial({color:16737792,side:D.DoubleSide,transparent:true,opacity:1,force:true,lineWidth:aF}),aO="PIMwebItfGeom",aD="PIMwebItfQuantifier",aR="Clash",aL="Clearance";function aJ(aW){var aV=M[aW],aU=P[aW];if(!aV||!aV.itfInstance1||!aV.itfInstance1.checkExternalPath()||!aV.itfInstance2||!aV.itfInstance2.checkExternalPath()||!aU||!aU.children||aU.children.length!==2){return}var aX=aI.computeCurves([aV.itfInstance1],[aV.itfInstance2],aV.itfSystemType);aU=aU.children[0];if(aX&&aX.clash&&aX.clash.length){aX.clash.Segment.forEach(function(a0){var aY=a0.map(function(a1){return new D.Vector3(a1[0],a1[1],a1[2])});var aZ=aB.createLineNode({points:aY,material:aM});aZ.setNoZ(true);aU.add(aZ)})}else{if(aX&&aX.contact&&aX.contact.Surface){aX.contact.Surface.forEach(function(a0){var aY=a0.map(function(a1){return new D.Vector3(a1[0],a1[1],a1[2])});aY.push(aY[0]);var aZ=aB.createLineNode({points:aY,material:aE});aU.add(aZ)})}}}var aP=(function(){function aV(a1,aZ,aW){var aY=new D.Vector3(a1[0],a1[1],a1[2]),aX=new D.Vector3(aZ[0],aZ[1],aZ[2]);var a0={arrowWidth:2,headLength:10,initialPoint:aY,finalPoint:aX,color:aW,head:1};return new aS(a0)}function aU(a1,a0,aX){var aZ=new aG({position:new D.Vector3(a0[0],a0[1],a0[2]),type:"Spherical"});aZ.setMatrix(new D.Matrix4().setPosition(new D.Vector3(a0[0],a0[1],a0[2])));aZ.setPickable(0);aZ.setNoZ(true);var aW=new aN({ratio:1});aZ.addChild(aW);var aY=aB.createTextNode({text:a1,font:aQ,fontSize:22,color:aX});aW.addChild(aY);return aZ}return function(a2){var a1=i([M[a2]])[0],a0=P[a2],aZ=new D.Matrix4(),aY,a3;if(!a1||!a1.itfInstance1||!a1.itfInstance1.checkExternalPath()||!a1.itfInstance2||!a1.itfInstance2.checkExternalPath()||!a0||!a0.children||a0.children.length!==2){return}if(!a1.itfQuantifier||!a1.itfQtfPt1||a1.itfQtfPt1.length!==3||!a1.itfQtfPt2||a1.itfQtfPt2.length!==3){return}a3=Math.min(a1.itfInstance1.externalPath.length,a1.itfInstance2.externalPath.length);for(aY=0;aY<a3;++aY){if(a1.itfInstance1.externalPath[aY]===a1.itfInstance2.externalPath[aY]){aZ.multiply(a1.itfInstance1.externalPath[aY].getMatrix())}else{break}}a0=a0.children[1];a0.setMatrix(aZ);var aX=[(a1.itfQtfPt2[0]+a1.itfQtfPt1[0])*0.5,(a1.itfQtfPt2[1]+a1.itfQtfPt1[1])*0.5,(a1.itfQtfPt2[2]+a1.itfQtfPt1[2])*0.5],aW=aH;if(a1.itfSystemType===aR){a0.addChild(aV(a1.itfQtfPt2,a1.itfQtfPt1,aA,aT));aW=aA}else{if(a1.itfSystemType===aL){a0.addChild(aV(aX,a1.itfQtfPt1,aH,aF));a0.addChild(aV(aX,a1.itfQtfPt2,aH,aF))}}a0.addChild(aU(a1.itfQuantifier,aX,aW))}})();return function(aU){if(!Array.isArray(aU)){return}if(!aB){require(["DS/Visualization/SceneGraphFactory","DS/Mesh/Mesh","DS/PIMwebViewController/PIMWebViewTools","DS/SceneGraphNodes/ArrowNode","DS/Visualization/Node3D","DS/SceneGraphNodes/FixedSizeNode3D","DS/SceneGraphNodes/BillBoardNode3D"],function(aV,a2,aY,aZ,a1,aX,aW){aB=aV;aC=a2;aS=aZ;aK=a1;aN=aX;aG=aW;aI=aY;var a0=document.createElement("span");a0.setAttribute("style","display: none");L.getViewer().canvas.appendChild(a0);aQ=window.getComputedStyle(a0,null).getPropertyValue("font-family");L.getViewer().canvas.removeChild(a0);W(aU)});return}Object.keys(P).forEach(function(aV){if(aU.indexOf(aV)===-1){T(aV)}});if(Object.keys(P).length===0){L.getViewer().removeNode(F);F=null}if(!F){F=new aK("PIMwebDecoration");F.setPickable(aC.NODRAWHL);L.getViewer().addNode(F)}aU.forEach(function(aW){if(!P[aW]){var aV;aV=P[aW]=new aK(aW);F.add(aV);aV.add(new aK(aO));aV.add(new aK(aD));setTimeout(function(){aJ(aW);aP(aW);L.getViewer().render()},0)}})}})();function ap(aB,aA){return S.publish({event:aB,data:aA})}function aw(){if(!V){return}if(ax===0){V.setVisibility(false);V.setVisibilityFree(true);V.setOpacity(null,false);V.setPickability(null)}else{if(ax===100){V.setVisibility(null);V.setVisibilityFree(null);V.setOpacity(null,false);V.setPickability(null)}else{V.setVisibility(null);V.setVisibilityFree(null);V.setOpacity(ax/100,true);V.setPickability("IGNORED")}}}function ay(){if(V&&ar){ar.deleteOverride(V);V=null}if(!ae||ae.getSelectedInterferences().length===0){return}var aB=[],aA=[];Object.keys(H).forEach(function(aD){var aE=M[aD];if(!aE){return}[aE.itfInstance1,aE.itfInstance2].forEach(function(aG){if(aG){var aF=aG.getKey();if(aA.indexOf(aF)===-1){aA.push(aF);aB.push(aG)}}})});var aC=a(L.getRootBagPath(),aB,aA);V=ar.createOverride({pathes:aC});aw()}function at(){var aA,aC=L.getViewer(),aB=aC.getVisibleSpace()===1?"visibleSpace":"invisibleSpace";Object.keys(H).forEach(function(aD){var aE=M[aD];if(!aE){return}[aE.itfInstance1,aE.itfInstance2].forEach(function(aG){if(aG&&aG.checkExternalPath()){var aF=aG.getBoundingSphere(aC,aB);if(aA){aA.mergeWithSphere(aF,aA)}else{aA=aF}}})});if(aA&&!aA.isNaN()){aA.radius=aA.radius/1.1*1.05;L.getFrameWindow().getViewpoint().reframe(undefined,undefined,aA)}}function an(aB){if(M.hasOwnProperty(aB)&&!H.hasOwnProperty(aB)){var aA,aD=M[aB],aC=[];if(!aD){return}if(aD.itfInstance1&&aD.itfInstance1.checkExternalPath()){aA=ar.createOverride({pathes:aD.itfInstance1});if(G){aA.setColor("blue",true)}aC.push(aA)}if(aD.itfInstance2&&aD.itfInstance2.checkExternalPath()){aA=ar.createOverride({pathes:aD.itfInstance2});if(G){aA.setColor("yellow",true)}aC.push(aA)}if(aC.length){H[aB]=aC}ay();L.getViewer().render();at();W(ae.getSelectedInterferences())}}function N(aA){if(aA&&H.hasOwnProperty(aA)){H[aA].forEach(ar.deleteOverride,ar);delete H[aA]}ay();L.getViewer().render();at();W(ae.getSelectedInterferences())}function X(){if(!Q){return}var aF=0,aE=0,aD=0,aG;Object.keys(M).forEach(function(aK){var aI=M[aK],aJ=aI.itfUserType,aH=aI.itfSystemType;if(aJ==="Clash"){aF++}else{if(aJ==="Contact"){aE++}else{if(aJ==="Clearance"){aD++}else{if(aJ==="Undefined"){if(aH==="Clash"){aF++}else{if(aH==="Contact"){aE++}else{if(aH==="Clearance"){aD++}}}}}}}});if(aF||aE||aD){aG=aF?(aF+" "+c[aF===1?"itfClash":"itfClashes"]):"";aG+=aG&&aE?" ":"";aG+=aE?(aE+" "+c[aE===1?"itfContact":"itfContacts"]):"";aG+=aG&&aD?" ":"";aG+=aD?(aD+" "+c[aD===1?"itfClearance":"itfClearances"]):""}aG=!aG?c.noItf:aG;var aC=Object.keys(ah);if(aC.length){if(aC.length>1){window.console.error("More than one simulation in session???")}var aA=o.getIsr(aC[0]),aB=aA?aA.getAlias():undefined;aG+=aB?(" - "+aB):""}Q.updatePanelTitle(aG)}function Z(aC){if(ab){return}var aB=M[aC.id].itfModelId,aA=o.getIsr(aB),aD=[],aE=function(aG){if(aG.some(function(aH){return aH.id===aC.id})){aD.forEach(function(aH){aA.unsubscribe(aH)});aD.length=0;var aF=aG.map(function(aJ){var aH=aA.getInterferences(aJ.id)[0],aI=M[aJ.id];x.extend(aI,aH,false);return aI});if(ae){ae.updateInterferences(i(aF),{onAttributeChange:Z});X()}}};aD.push(aA.subscribe("itfUpdateSuccess",aE));aD.push(aA.subscribe("itfUpdateFailed",aE));aA.updateInterference({id:aC.id,param:aC.param,newValue:aC.newValue});if(aC.param==="itfUserType"){M[aC.id].itfUserType=aC.newValue;X()}}function aq(){if(!ad){return}var aA=[WUXDockAreaEnum.TopDockArea,WUXDockAreaEnum.LeftDockArea,WUXDockAreaEnum.RightDockArea].map(function(aB){var aF="0px",aH=L.getFrameWindow().getImmersiveFrame().getDockingElement(aB),aE=aH.getContainedWindows(),aG=false;if(aE&&aE.length&&((aE[0].isAWindowGroup()&&aE[0].getEmbeddedWindows().length)||(!aE[0].isAWindowGroup()))){var aD=aE[0].getEmbeddedWindows?aE[0].getEmbeddedWindows():aE;for(var aC=0;aC<aD.length;aC++){if(aD[aC].visibleFlag){aG=true;break}}if(aG){aF=String((aH.collapseDockingZoneFlag?0:aH.dockingZoneSize)+aH._collapserSize)+"px"}}if(!aG&&aH.interactiveDockAreaVisibleFlag){aF=String(aH.dockingZoneSize+aH._collapserSize)+"px"}return aF});ad.setPosition({top:aA[0],left:aA[1],right:aA[2]})}function au(aA){if(R&&ar&&R.getSceneGraphOverrideSetIndex(ar)===-1){R.pushSceneGraphOverrideSet(ar)}aA.forEach(function(aB){if(aB&&!M[aB.itfuid]){M[aB.itfuid]=aB}});if(ae){b(L,aA,Y);ae.addInterferences(i(aA),{onAttributeChange:Z});X()}}function ai(){Object.keys(H).forEach(function(aA){H[aA].forEach(function(aB){ar.deleteOverride(aB)});delete H[aA]});ay()}function J(){if(ae){var aA=Object.keys(M).map(function(aB){return M[aB].itfuid});ae.removeInterferences(aA)}M={};X();ai();W([]);if(av){av.setActiveState(false)}L.getViewer().render()}function al(){var aB=[],aA=o.getLoadedIsr();Object.keys(ah).forEach(function(aC){aB=aB.concat(aA[aC].getIsrContextIDs());o.unlockIsr(aC);delete ah[aC];ap("onIsrRemoved",{isrLog:x.clone(ah,true),removedIsr:aC})});J();if(aB.length){L.removeRoots({pids:aB})}}R=L.getViewer().getSceneGraphOverrideSetManager();ar=new u(L.getRootBagPath().getLastElement(true));function ao(aA){if(!af){af={isrID:[],metricID:[]};if(av){av.setActiveState(false)}setTimeout(function(){var aR=false,aL=Object.keys(ah),aD,aJ,aI,aH=0,aN=true,aE=false,aQ,aO;if(aL.length>1){window.console.log("More than 1 interference simulation loaded. This must not be possible!!")}if(af.isrID.length>0){if(af.isrID.length>1){L.displayNotification({msg:k.pimSingleIsr,eventID:"info"})}aQ=af.isrID[0];var aF=af.metricID.length;if(!ah[aQ]){aR=true;al();ah={};ah[aQ]=[]}else{if(ah[aQ].length===0){aN=false}}if(aN){aD=function(aS){if(aS){aE=true;if(aR){o.lockIsr(aS.isrID)}X()}if(aH===0&&aE){L.unsubscribe(aJ);L.unsubscribe(aI);L.displayNotification({msg:k.itfCtrlMsgSuccess,eventID:"success"});if(aF){L.displayNotification({msg:k[aF>1?"pimMetricsIgnored":"pimMetricIgnored"],eventID:"info"})}ap("onIsrAdded",{isrLog:x.clone(ah,true),loadedIsr:aQ})}};var aG=localStorage.getItem("PIMwebContextLoadMode")==="1"?"InterferingPartsOnly":"AllParts";o.loadIsr({isrID:aQ,contextLoadMode:aG,onProgress:function(aW){if(aW.context){if(aW.context.length){var aT=aW.context;if(ah[aQ]&&ah[aQ].length){ah[aQ].length=0}else{aT=aW.context.filter(function(aX){return Y.indexOf(aX)===-1})}if(aT.length>0){aH+=aT.length;if(!aJ&&!aI){aJ=L.subscribe({event:"onRootAdded"},function(){aH=0;aD()});aI=L.subscribe({event:"onRootAlreadyExisting"},function(){aH=0;aD()})}L.addRoots({objects:aT.map(function(aX){return{path:[aX]}})},true,false)}else{L.displayNotification({msg:k.itfCtrlMsgCtxAlreadyLoaded,eventID:"info"})}}else{L.displayNotification({msg:k.itfCtrlMsgNoContext,eventID:"info"})}}if(aW.interferingParts&&aW.interferingParts.length){var aS=L.getController();for(aO=aW.interferingParts.length-1;aO>=0;--aO){if(aW.interferingParts[aO].every(function(aX){return aS.getNode({id:aX})})){aW.interferingParts.splice(aO,1)}}aH+=aW.interferingParts.length;if(aH&&!aJ&&!aI){aJ=L.subscribe({event:"onRootAdded"},function(){aH--;if(aH===0){aD()}});aI=L.subscribe({event:"onRootAlreadyExisting"},function(){aH--;if(aH===0){aD()}})}if(aH){L.addRoots({objects:aW.interferingParts.map(function(aX){return{path:aX}})},true,false)}}if(aW.itfIDs&&aW.isrID){var aV=o.getIsr(aW.isrID),aU=aV?aV.getInterferences(aU):null;if(aU){au(aU)}}},onComplete:aD,onFailure:function(aS){L.unsubscribe(aJ);L.unsubscribe(aI);ah={};if(aS.step==="Simulation"){L.displayNotification({msg:k.itfCtrlMsgNotFound,eventID:"warning"})}else{L.displayNotification({msg:k.itfCtrlMsgError,eventID:"warning"})}X();var aT={};aT[aQ]=[];ap("onIsrAddFailed",aT)}})}else{L.displayNotification({msg:k.itfCtrlMsgSimuAlreadyLoaded,eventID:"info"});var aC={};aC[aQ]=[];ap("onIsrAlreadyLoaded",aC)}}else{if(af.metricID.length>0){var aM=0,aK=[],aP=0,aB=af.metricID.length;if(aL.length){aN=!af.metricID.every(function(aS){return aL.some(function(aT){return ah[aT].indexOf(aS)>-1})})}if(aN){aD=function(aS){if(aS){if(aR){o.lockIsr(aS.isrID)}X()}else{if(aH!==0){return}L.unsubscribe(aJ);L.unsubscribe(aI);if(aK.length){L.displayNotification({msg:k[aK.length>1?"pimMetricsLoadOK":"pimMetricLoadOK"],eventID:"success"});ap("onItfAdded",{isrLog:x.clone(ah,true),loadedIsr:Object.keys(ah)[0],loadedMetrics:aK})}else{if(aB){L.displayNotification({msg:k[aB>1?"pimMetricsAlreadyLoaded":"pimMetricAlreadyLoaded"],eventID:"info"});ap("onItfAlreadyLoaded")}else{ap("onIsrItfNothingAdded")}}if(aP){L.displayNotification({msg:k[aP>1?"pimIgnoredMetrics":"pimIgnoredMetric"],eventID:"info"})}if(aM){L.displayNotification({msg:k[aM>1?"pimMetricsNoIsr":"pimMetricNoIsr"],eventID:"info"})}}};o.loadIsrFromMetrics({metrics:af.metricID,onFilterIsr:function(aX){function aU(aY){aX.onComplete(aY)}var aV=Object.keys(aX.isrIDs);if(aV.length===0){aM=aX.metricsWithoutIsr.length;aB=0;aU([]);return}if(aL.length&&aV.indexOf(aL[0])>-1){aQ=aL[0];aB=aX.isrIDs[aQ].itfM.length;for(aO=1;aO<aV.length;++aO){if(aV[aO]!==aQ){aP+=aX.isrIDs[aV[aO]].itfM.length}}if(ah[aQ].length===0){aU([]);return}else{if(aX.isrIDs[aQ].itfM.every(function(aY){return ah[aQ].indexOf(aY)>-1})){aU([]);return}}}else{aQ=aV[0];aB=aX.isrIDs[aQ].itfM.length;for(aO=1;aO<aV.length;++aO){if(aB<aX.isrIDs[aV[aO]].itfM.length){aQ=aV[aO];aP+=aB;aB=aX.isrIDs[aV[aO]].itfM.length}else{aP+=aX.isrIDs[aV[aO]].itfM.length}}if(aL.length){var aT,aS=new q({onClick:function(){aT.destroy();al();aU([aQ]);aR=true;ah[aQ]=[]}}),aW=new q({onClick:function(){aT.close()}});aT=new f({identifier:"PIMwebIsrRemovePanel",modalFlag:true,title:k.pimIsrRemoveTitle,content:new x.Element("div",{html:"<p>"+(aP?k.pimIsrRemoveMsg2:k.pimIsrRemoveMsg1)+"</p><p><b>"+aX.isrIDs[aQ].label+"</b></p>"}),width:350,immersiveFrame:L.getFrameWindow().getImmersiveFrame(),buttons:{Ok:aS,Cancel:aW}});aT.addEventListener("close",function(){aP=aB=0;aU([])});return}aR=true;ah[aQ]=[]}aU([aQ])},onProgress:function(aV){if(aV.interferingParts&&aV.interferingParts.length){var aS=L.getController();for(aO=aV.interferingParts.length-1;aO>=0;--aO){if(aV.interferingParts[aO].every(function(aW){return aS.getNode({id:aW})})){aV.interferingParts.splice(aO,1)}}aH+=aV.interferingParts.length;if(aH&&!aJ&&!aI){aJ=L.subscribe({event:"onRootAdded"},function(){aH--;if(aH===0){aD()}});aI=L.subscribe({event:"onRootAlreadyExisting"},function(){aH--;if(aH===0){aD()}})}if(aH){L.addRoots({objects:aV.interferingParts.map(function(aW){return{path:aW}})},true,false)}}if(aV.itfIDs){var aU=o.getIsr(aV.isrID),aT=aU.getInterferences(aV.itfIDs);au(aT)}if(aV.metrics){aV.metrics.forEach(function(aW){if(ah[aV.isrID].indexOf(aW)===-1){ah[aV.isrID].push(aW)}aK.push(aW)})}},onComplete:aD,onFailure:function(aS){L.unsubscribe(aJ);L.unsubscribe(aI);if(aS&&aS.isrID&&ah[aS.isrID]&&ah[aS.isrID].length===0){ah={}}X();L.displayNotification({msg:k[aB>1?"pimMetricsLoadKO":"pimMetricLoadKO"],eventID:"warning"});ap("onItfAddFailed")}})}else{L.displayNotification({msg:k[af.metricID.length>1?"pimMetricsAlreadyLoaded":"pimMetricAlreadyLoaded"],eventID:"info"});ap("onItfAlreadyLoaded")}}}af=null},0)}if(aA.isrID){af.isrID=af.isrID.concat(aA.isrID)}if(aA.metricID){af.metricID=af.metricID.concat(aA.metricID)}}aj.push(L.subscribe({event:"onRefreshBegin"},function(){ac=x.clone(ah,true)}));aj.push(L.subscribe({event:"onRefreshCompleted"},function(){var aC=Object.keys(ac);if(aC.length===1){var aB={},aA=aC[0];if(Array.isArray(ac[aA])&&ac[aA].length){aB.metricID=ac[aA]}else{aB.isrID=aA}ao(aB)}}));Y=L.getRoots().map(function(aA){return p.getNodeID(aA)});Array.prototype.push.apply(Y,L.getController().getHiddenRootIds());aj.push(L.subscribe({event:"onRootAdded"},function(aB){if(Y.indexOf(aB.id)===-1){Y.push(aB.id)}var aA=Object.keys(M).map(function(aC){return M[aC]});aA=b(L,aA,Y);if(ae){ae.updateInterferences(i(aA),{onAttributeChange:Z});X()}}));aj.push(L.subscribe({event:"onRootRemoved"},function(aB){var aA=Y.indexOf(aB.id);if(aA!==-1){Y.splice(aA,1)}var aC=o.getLoadedIsr();Object.keys(aC).forEach(function(aD){var aE=aC[aD].getIsrContextIDs();if(aE.indexOf(aB.id)>-1){o.unlockIsr(aD);delete ah[aD];J();ap("onIsrRemoved",{isrLog:x.clone(ah,true),removedIsr:aD})}})}));aj.push(L.subscribe({event:"onRootAttached"},function(aC){if(!ae){return}var aD=o.getLoadedIsr();if(aC.id&&Object.keys(aD).some(function(aF){var aE=aD[aF].getIsrContextIDs();return aE.indexOf(aC.id)!==-1})){var aB=[],aA;Object.keys(M).forEach(function(aE){aB.push(M[aE])});aA=b(L,aB,Y);if(ae&&aA){ae.updateInterferences(i(aA),{onAttributeChange:Z});X()}ae.getSelectedInterferences().forEach(function(aE){an(aE)})}}));aj.push(L.subscribe({event:"onRootDetached"},function(aA){var aB=o.getLoadedIsr();if(aA.id&&Object.keys(aB).some(function(aD){var aC=aB[aD].getIsrContextIDs();return aC.indexOf(aA.id)!==-1})){ai();W(ae.getSelectedInterferences());L.getViewer().render()}}));aj.push(L.subscribe({event:"onEndDelete"},(function(){function aA(aC,aD){if(!aC||!aD){return false}for(var aB=2;aB<aD.externalPath.length;aB+=2){if(aC===aD.externalPath[aB]){return true}}return false}return function(aC){var aB=[],aD=aC.pathToReparent;Object.keys(M).forEach(function(aF){var aG=M[aF],aE=false;if(aG.itfInstance1&&aA(aD,aG.itfInstance1)){aG.itfInstance1=undefined;aG.itfInstance1Label=undefined;aE=true}if(aG.itfInstance2&&aA(aD,aG.itfInstance2)){aG.itfInstance2=undefined;aG.itfInstance2Label=undefined;aE=true}if(aE){T(aF);aB.push(aG)}});aB.forEach(function(aE){M[aE.itfuid]=aE});if(ae){ae.updateInterferences(i(aB),{onAttributeChange:Z});X()}}})()));window.top.addEventListener("storage",function(aC){if(aC.key!=="PIMwebContextLoadMode"||aC.newValue===aC.oldValue||(aC.newValue==="0"&&aC.oldValue===null)||(aC.newValue===null&&aC.oldValue==="0")){return}var aB=x.clone(ah),aA=Object.keys(aB);if(aA.length===0){return}if(aA.length>1){window.console.log("More than one interference simulation in the viewer???");return}if(!Array.isArray(aB[aA[0]])||aB[aA[0]].length){return}al();ao({isrID:aA[0]})});function ag(){if(ad){return}var aA=e();aA.parent=L.getFrameWindow().getUIFrame();ax=aA.checkedButton===2?100:aA.checkedButton===1?0:aA.userValue;ad=new w(aA);ad.onOpacityChange=function(aB){B(aB);ax=aB.newValue;aw();L.getViewer().render()};L.getFrameWindow().getImmersiveFrame().addEventListener("freeZoneResize",aq)}function O(){if(ae){return}function aB(aH){aH.stopPropagation()}var aF=["dragenter","dragover","drop"];function aA(){var aH=L.getViewer().canvas,aI=L.getFrameWindow().getImmersiveFrame();aF.forEach(function(aJ){aH.addEventListener(aJ,aB);aI.addEventListener(aJ,aB)});return true}function aC(){var aH=L.getViewer().canvas,aI=L.getFrameWindow().getImmersiveFrame();aF.forEach(function(aJ){aH.removeEventListener(aJ,aB);aI.addEventListener(aJ,aB)});return true}function aE(aI,aK){if(!ae||!aK){return false}var aJ={protocol:"3DXContent",version:"1.1",data:{items:[]},source:window.widget&&window.widget.getValue("x3dAppId")?window.widget.getValue("x3dAppId"):"ENOI3D_AP",widgetId:window.widget?window.widget.id:undefined},aH=[];ae.getSelectedInterferences().forEach(function(aM){var aL=M[aM];if(aH.indexOf(aL.mID)===-1){aH.push(aL.mID);aJ.data.items.push({envId:n.getPlatformId(),serviceId:"3DSpace",contextId:h.getSetting("pad_security_ctx")?h.getSetting("pad_security_ctx"):undefined,objectId:aL.mID,objectType:aL.mType,displayName:aL.itfMetricName})}});aI.dataTransfer.setData("Text",JSON.stringify(aJ));aA();return true}Q=new r({frameWindow:L.getFrameWindow(),readOnly:ab,cbDnD:{onDragStartCell:aE,onDragOverCell:aB,onDragEndCell:aC,onDragEnterBlank:aB,onDragLeaveBlank:aB,onDragOverBlank:aB,onDragStartColumnHeader:aA,onDragEndColumnHeader:aC}});Q.onClose=function(){I.hideGUX();ap("onItfListClosed")};ae=Q.getTreeListViewer();ae.onSelect=an;ae.onUnselect=N;var aG=Object.keys(M);if(aG.length>0){var aD=[];aG.forEach(function(aH){aD.push(M[aH])});au(aD)}}function ak(){if(av){return}function aA(aE){if(typeof aE!=="number"){return false}var aC=ae.getNumberOfRows(),aB=aE<0?aC-1:aE>=aC?0:aE;if(aB<0||aB>=aC){window.console.log("No interference in list for slide show");return false}ae.selectRows([aB]);var aD=ae.getSelectedInterferences();if(aD.length===1){av.displaySlideInformation({message:M[aD[0]].itfCtxName+" ("+(aB+1)+" / "+aC+") "})}return true}av=m.getSlideShowController({context:L.getFrameWindow(),id:"PIMwebSlideShow",params:{activateRotation:true}});K.push(av.subscribe("onPreviousSlideCB",function(){var aC=ae.getSelectedRows(),aB=aC&&aC.length?aC.length>1?aC[0]:aC[0]-1:0;aA(aB)}));K.push(av.subscribe("onNextSlideCB",function(){var aC=ae.getSelectedRows(),aB=aC&&aC.length?aC.length>1?aC[0]:aC[0]+1:0;aA(aB)}));K.push(av.subscribe("onFirstSlideCB",function(){aA(0)}));K.push(av.subscribe("onLastSlideCB",function(){aA(ae.getNumberOfRows()-1)}));K.push(av.subscribe("onActiveStateModified",function(aB){if(aB.state&&Object.keys(ah).length===0){aB.onBeginSlideShow(false);return}if(aB.state){aB.onBeginSlideShow(true)}var aD=L.getViewer();L.setDefaultContextualBarVisibility(!aB.state);L.setDefaultContextualMenuVisibility(!aB.state);if(aB.state){if(az){Q.hide()}else{O();ag();ad.show();if(F){F.setVisibility(true);F.setVisibilityFree(false)}R.pushSceneGraphOverrideSet(ar);aD.render()}aD.setPicking({activated:false,trapSelection:false});require("DS/ApplicationFrame/CommandsManager").getCommandCheckHeader("PIMInteferenceListHdr",L.getCommandContext()).disable();var aC=ae.getSelectedRows();aA(!aC||!aC.length?0:null)}else{if(az){Q.show()}else{ad.hide();if(F){F.setVisibility(false);F.setVisibilityFree(true)}R.removeSceneGraphOverrideSet(ar);aD.render()}aD.setPicking({activated:true,trapSelection:true});require("DS/ApplicationFrame/CommandsManager").getCommandCheckHeader("PIMInteferenceListHdr",L.getCommandContext()).enable()}}))}this.load=function(aA){if(!U){return}ao(aA)};this.clearIsr=al;this.showGUX=function(){az=true;if(!U){return}ag();ad.show();O();Q.show();if(F){F.setVisibility(true);F.setVisibilityFree(false)}if(R&&ar&&R.getSceneGraphOverrideSetIndex(ar)===-1){R.pushSceneGraphOverrideSet(ar);L.getViewer().render()}aq()};function am(){if(Q){Q.hide()}if(ad){ad.hide()}if(F){F.setVisibility(false);F.setVisibilityFree(true)}R.removeSceneGraphOverrideSet(ar);L.getViewer().render()}this.hideGUX=function(){if(!az){return}az=false;am()};this.activate=function(aA){if(U){return}U=true;if(ab!==Boolean(aA.readOnly)){ab=Boolean(aA.readOnly);if(Q){Q.toggleReadOnly()}}L.setLoadingDelegations({_SIMItfSimulation:function(aB){n.multiTenantMgt([aB],p.getRoots(L),function(aC){if(!aC.isMultiTenant&&U){ao({isrID:[aB.objectId]})}})},_PLMPIMMetricReference:function(aB){n.multiTenantMgt([aB],p.getRoots(L),function(aC){if(!aC.isMultiTenant&&U){ao({metricID:[aB.objectId]})}})}});if(az){I.showGUX()}ak()};this.deactivate=function(){if(!U){return}U=false;L.setLoadingDelegations({_SIMItfSimulation:undefined,_PLMPIMMetricReference:undefined});am();K.forEach(function(aA){av.unsubscribe(aA)});K=[];m.unreferenceSlideShowController({context:L.getFrameWindow(),id:"PIMwebSlideShow"});av=null};this.subscribe=function(aB,aA){if(!aB||!aA){return null}return S.subscribe({event:aB},aA)};this.unsubscribe=function(aA){if(aA===null||aA===undefined){return undefined}return S.unsubscribe(aA)};this.destroy=function(){if(ad){ad.destroy()}ad=null;aj.forEach(function(aA){L.unsubscribe(aA)});L=ah=null}}});var t=[],A=function(F){if(!F||!F.pad3DViewer){return null}var G;t.some(function(H){return(H.pad3DViewer===F.pad3DViewer)?(G=H.enveloppe):false});return G};return C.singleton({init:function(){},giveItfCtrl:function(F){return A(F)},getItfCtrl:function(H){if(!H||!H.pad3DViewer){return null}var I=A(H);if(!I){var G=new z({pad3DViewer:H.pad3DViewer}),F={load:function(){return G?G.load.apply(null,arguments):undefined},activate:function(){return G?G.activate.apply(null,arguments):undefined},deactivate:function(){return G?G.deactivate.apply(null,arguments):undefined},showGUX:function(){return G?G.showGUX.apply(null,arguments):undefined},hideGUX:function(){return G?G.hideGUX.apply(null,arguments):undefined},clearIsr:function(){return G?G.clearIsr.apply(null,arguments):undefined},subscribe:function(){return G?G.subscribe.apply(null,arguments):undefined},unsubscribe:function(){return G?G.unsubscribe.apply(null,arguments):undefined},dereference:function(){if(!G){return}G.deactivate();G.destroy.apply(null,arguments);G=null;t.some(function(K,J){if(K.enveloppe===F){t.splice(J,1);F=null;return true}})}};Object.freeze(F);t.push({pad3DViewer:H.pad3DViewer,enveloppe:F});I=F}return I}})});define("DS/PIMwebViewController/PIMWebViewTools",["DS/WebPolyMaths/WebMeshIntersection","DS/WebPolyMaths/WebMathsBoundingGeometry","DS/WebPolyMaths/WebGeometryEnums","DS/WebPolyMaths/WebToolsMeasure","DS/WebPolyMaths/WebMeshRecognition","DS/WebPolyMaths/WebMathsVector3D","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(n,x,w,l,i,r,k){var m=0.001,u=m*m,f=function(){this.clash=[];this.contact=[];this.isClash=false};f.prototype={constructor:f,concat:function(z){if(this.clash.length===0){this.clash=z.clash}else{if(z.clash.length>0){Array.prototype.push.apply(this.clash,z.clash)}}if(this.contact.length===0){this.contact=z.contact}else{if(z.contact.length>0){Array.prototype.push.apply(this.contact,z.contact)}}}};function t(D,C){var B=D[0]-C[0],A=D[1]-C[1],z=D[2]-C[2];return Math.sqrt(B*B+A*A+z*z)}function j(C,A){var B=0,z=A.length,D;for(;B<z;++B){D=A[B];if(r.areEqual(C,D.item||D)){return true}}return false}function a(D,C){var B=0,z=C.length,A;for(;B<z;++B){A=C[B];if(A.type===w.GeometryType.LINE&&j(A.item[0],D.item)&&j(A.item[1],D.item)){return true}}return false}function v(z,B){var G=r.sub(B[2],B[0]);var E=r.sub(B[1],B[0]);var D=r.sub(z,B[0]);var C=[r.dot(G,G),r.dot(G,E),r.dot(G,D),r.dot(E,E),r.dot(E,D)];var A=1/(C[0]*C[3]-C[1]*C[1]);var H=(C[3]*C[2]-C[1]*C[4])*A;var F=(C[0]*C[4]-C[1]*C[2])*A;return(H>=0)&&(F>=0)&&(H+F<=1+u)}function p(C,B){var E=[],A=0,z=C.length,D;for(;A<z;++A){D=C[A];if(v(D,B)){E.push({type:w.GeometryType.POINT,item:D})}}return E}function c(D,C){var B=t(D,C[0]);var A=t(D,C[1]);var z=t(C[0],C[1]);return(Math.abs(z-(B+A))<=m)}function q(B){var C=0,D,A,z;for(;C<B.length;++C){A=B[C];for(D=C+1;D<B.length;++D){z=B[D];if(j(z[0],A)&&j(z[1],A)&&j(z[2],A)){B.splice(D,1);--D}}}}function b(C,A,B){var G={};var E=r.sub(C[1],C[0]);var z,F,D=r.dot(B,E);if(D!==0){F=r.dot(B,A)-r.dot(B,C[0]);z=F/D;if(Math.abs(z)>=0&&Math.abs(z)<=1){G={type:w.GeometryType.POINT,item:r.multiplyAndAdd(E,z,C[0])}}}else{G={type:w.GeometryType.LINE,item:C}}return G}function y(D,B,A){var H=[],C=[];if(c(D[0],B)&&c(D[1],B)){H.push({type:w.GeometryType.LINE,item:D})}else{if(c(B[0],D)&&c(B[1],D)){H.push({type:w.GeometryType.LINE,item:B})}else{if(c(D[0],B)){C.push(D[0])}else{if(c(D[1],B)){C.push(D[1])}}if(c(B[0],D)){C.push(B[0])}else{if(c(B[1],D)){C.push(B[1])}}if(C.length===2){if(r.areEqual(C[0],C[1])){H.push({type:w.GeometryType.POINT,item:C[0]})}else{H.push({type:w.GeometryType.LINE,item:C})}}else{if(C.length===1){if(A){H.push({type:w.GeometryType.POINT,item:C[0]})}}else{var J=r.sub(D[1],D[0]);var I=r.sub(B[1],B[0]);var K=r.sub(B[0],D[0]);var Q=r.dot(J,J);var P=r.dot(J,I);var O=r.dot(I,I);var N=r.dot(J,K);var M=r.dot(I,K);var L=(Q*O)-(P*P);if(L===0){}else{var z=(P*M-O*N)/L;var G=(Q*M-P*N)/L;if((Math.abs(z)>=0&&Math.abs(z)<=1)&&(Math.abs(G)>=0&&Math.abs(G)<=1)){var F=r.multiplyAndAdd(J,z,D[0]);var E=r.multiplyAndAdd(I,G,B[0]);if(r.areEqual(F,E)){if(c(F,D)&&c(F,B)){H.push({type:w.GeometryType.POINT,item:F})}}}}}}}}return H}function s(A,z){var B=[];Array.prototype.push.apply(B,y([A[0],A[1]],z));Array.prototype.push.apply(B,y([A[0],A[2]],z));Array.prototype.push.apply(B,y([A[1],A[2]],z));return B}function d(L,I){var z=[],F;var J=p(L,I);if(J.length===3){return[{type:w.GeometryType.SURFACE,item:L}]}var E=p(I,L);if(E.length===3){return[{type:w.GeometryType.SURFACE,item:I}]}E.forEach(function(Q){if(!j(Q.item,J)){J.push(Q)}});var O=[];var A=[];var M=[[L[0],L[1]],[L[1],L[2]],[L[2],L[0]]];var K=[[I[0],I[1]],[I[1],I[2]],[I[2],I[0]]];var H=function(Q){if(r.areEqual(Q,E.item)){return}if(j(Q,J)){var R={type:w.GeometryType.LINE,item:[Q,E.item]};if(!a(R,z)){z.push(R)}}};var D=0;for(;D<M.length;D++){A=[];var C=0;for(;C<K.length;C++){E=y(M[D],K[C],true);if(E.length!==0){E=E[0];if(E.type===w.GeometryType.LINE){A=[E];O.push({type:w.GeometryType.POINT,item:E.item[0]});O.push({type:w.GeometryType.POINT,item:E.item[1]});if(!a(A[0],z)){z.push(A[0])}C=K.length}else{if(!j(E.item,O)){O.push(E);A.push(E);if(J.length!==0){[M[D][0],K[C][0]].forEach(H);[M[D][1],K[C][1]].forEach(H)}}}if(A.length===2){F=[A[0].item,A[1].item];if(r.subAndSquaredLength(M[D][0],A[1].item)<r.subAndSquaredLength(M[D][0],A[0].item)){F=[A[1].item,A[0].item]}A=[{type:w.GeometryType.LINE,item:F}];if(!a(A[0],z)){z.push(A[0])}C=K.length}}}}if(J.length===2){F={type:w.GeometryType.LINE,item:[J[0].item,J[1].item]};if(!a(F,z)){z.push(F)}}else{if(J.length===1&&z.length===0){z=[{type:w.GeometryType.POINT,item:J[0]}]}}var G=[];O=[];var N;if(z.length>1){var B=z.splice(0,1)[0];O.push(B.item[0],B.item[1]);N=B.item[1];var P;while(!r.areEqual(O[0],N)){P=null;for(D=0;(D<z.length)&&!P;D++){if(r.areEqual(z[D].item[0],N)){P=z.splice(D,1)[0].item[1]}else{if(r.areEqual(z[D].item[1],N)){P=z.splice(D,1)[0].item[0]}}}if(!P){P=(z.length!==0)?z[0].item[0]:O[0]}N=P;O.push(N)}if(O.length>=3){G=[{type:w.GeometryType.SURFACE,item:O}]}}else{G=z}return G}function e(A,z){var B=new f;if(A.type===w.GeometryType.LINE&&A.type===z.type){B.clash=y(A.item,z.item)}else{if(A.type===w.GeometryType.LINE&&z.type===w.GeometryType.SURFACE){B.clash=s(z.item,A.item)}else{if(A.type===w.GeometryType.SURFACE&&z.type===w.GeometryType.LINE){B.clash=s(A.item,z.item)}else{if(A.type===w.GeometryType.SURFACE&&z.type===w.GeometryType.SURFACE){B.clash=d(A.item,z.item)}else{if(A.type===w.GeometryType.LINE&&z.type===w.GeometryType.POINT){if(c(z.item[0],A.item)){B.clash=[z]}}else{if(A.type===w.GeometryType.POINT&&z.type===w.GeometryType.LINE){if(c(A.item[0],z.item)){B.clash=[A]}}}}}}}return B}function h(D,C,B,K,H){var z;var F=[];var A=[];var J=[];var E=[D,C,B];var I,G;G=r.dot(H,K);E.forEach(function(L){I=(r.dot(H,L)-G);if(I>m){F.push(L)}else{if(I<-m){A.push(L)}else{J.push(L)}}});if(J.length===3){z={type:w.GeometryType.SURFACE,item:[D,C,B],overThePlane:3}}else{if(J.length===2){z={type:w.GeometryType.LINE,item:J,overThePlane:2}}else{if(J.length===1&&F.length===1&&A.length===1){z={type:w.GeometryType.LINE,item:[J[0],b([F[0],A[0]],K,H).item],overThePlane:1}}else{if(J.length===1&&(F.length===2||A.length===2)){z={type:w.GeometryType.POINT,item:[J[0]],overThePlane:1}}else{if(F.length===1&&A.length===2){z={type:w.GeometryType.LINE,item:[b([F[0],A[0]],K,H).item,b([F[0],A[1]],K,H).item]}}else{if(F.length===2&&A.length===1){z={type:w.GeometryType.LINE,item:[b([A[0],F[0]],K,H).item,b([A[0],F[1]],K,H).item]}}}}}}}return z}function g(S,M,R,J){if(!S||!S.group||!S.group.geometry||S.start===undefined||S.count===undefined||S.count<=0){return[]}if(!R||!R.group||!R.group.geometry||R.start===undefined||R.count===undefined||R.count<=0){return[]}if(S.group.glType!==4||R.group.glType!==4){return[]}var F=new f;var L=S.count;var z=i.extractMeshVertices(S,M.elements);var K=R.count;var W=i.extractMeshVertices(R,J.elements);var I,P,O,N,H,D,B,A,E,C,V,T,G,Q,U;for(G=0;G<L;){P=z[G++];O=z[G++];N=z[G++];I=[P,O,N];V=r.cross(r.sub(O,P),r.sub(N,P));for(Q=0;Q<K;){D=W[Q++];B=W[Q++];A=W[Q++];H=[D,B,A];T=r.cross(r.sub(B,D),r.sub(A,D));E=h(P,O,N,D,T);C=h(D,B,A,P,V);if(E&&C){U=e(E,C);if(U&&U.clash.length){if(E.overThePlane>1||C.overThePlane>1){U.contact=[{type:w.GeometryType.SURFACE,item:I},{type:w.GeometryType.SURFACE,item:H}]}else{if(U.clash.length===1&&U.clash[0].type===w.GeometryType.POINT){U.contact=[{type:w.GeometryType.SURFACE,item:I},{type:w.GeometryType.SURFACE,item:H}]}}if(!F.isClash&&U.clash.length&&U.contact.length===0){F.isClash=true}F.concat(U)}}}}return F}function o(I,G,F){var L=new f,Z=2*u,K=I,J=G,X=[],W=[],S,Q,B,A,P,N,D,M,V,z,U=K.length;if(F!=="Clash"&&F!=="Contact"){return}for(M=0;M<U;M++){P=K[M].getLastElement(true);N=J[M].getLastElement(true);S=l.retrieveProductAABB(P,K[M].getWorldMatrix());Q=l.retrieveProductAABB(N,J[M].getWorldMatrix());D=x.computeAABBSquaredDistance(S,Q);if(D<Z){B=k.is3DLeaf(P);A=k.is3DLeaf(N);if(B&&A){X.push({part:P,pathElement:K[M],AABB:S});W.push({part:N,pathElement:J[M],AABB:Q})}}}var C=X.length,R,O,T,Y,E,H;for(M=0;M<C;M++){O=l.retrievePartPrimitivesAndAABB(X[M].pathElement);Y=X[M].pathElement.getWorldMatrix();T=l.retrievePartPrimitivesAndAABB(W[M].pathElement);E=W[M].pathElement.getWorldMatrix();H=new f;for(V=0;V<O.primitives.length;V++){D=x.computeAABBSquaredDistance(O.AABB[V],W[M].AABB);if(D<u){for(z=0;z<T.primitives.length;z++){D=x.computeAABBSquaredDistance(O.AABB[V],T.AABB[z]);if(D<u){R=g(O.primitives[V],Y,T.primitives[z],E);H.concat(R)}}}}L.concat(H)}if(F==="Clash"){L.contact.length=0}else{if(F==="Contact"){L.clash.length=0}}L.clash.Segment=[];L.contact.Segment=[];L.clash.Surface=[];L.contact.Surface=[];L.clash.forEach(function(aa){if(aa.type===w.GeometryType.LINE){L.clash.Segment.push(aa.item)}else{if(aa.type===w.GeometryType.SURFACE){L.clash.Surface.push(aa.item)}}});L.contact.forEach(function(aa){if(aa.type===w.GeometryType.LINE){L.contact.Segment.push(aa.item)}else{if(aa.type===w.GeometryType.SURFACE){L.contact.Surface.push(aa.item)}}});n._mergePolylines(L.clash.Segment);q(L.contact.Surface);return L}return Object.freeze({computeCurves:o})});define("DS/PIMwebViewController/PIMwebPreferencesCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/Windows/Dialog","DS/Controls/Toggle","DS/Controls/Button","DS/PADUtils/PADContext"],function(l,a,i,k,c,f){var b="",e="All parts",h="Only interfering parts",n="Save",d="Reset",m="Cancel",j="Preferences";require(["i18n!DS/PIMwebViewController/assets/nls/PIMwebPreferencesCmd"],function(o){b=o.lblCtxtLoad;e=o.allParts;h=o.onlyItfParts;n=o.save;d=o.reset;m=o.cancel;j=o.title});function g(){var p=localStorage.getItem("PIMwebContextLoadMode"),r=l.createElement("div"),o,q;l.createElement("label",{text:b,styles:{"margin-bottom":"0px",padding:"10px 0px"}}).inject(r);o=new k({type:"radio",label:e,value:"pimAllParts",checkFlag:p!=="1"}).inject(r);o.getContent().setStyle("margin-left","20px");q=new k({type:"radio",label:h,value:"pimItfParts",checkFlag:p==="1"}).inject(r);q.getContent().setStyle("margin-left","20px");return{content:r,tglAllParts:o,tglItfParts:q}}return a.extend({init:function(o){this._parent(o,{mode:"shared",isAsynchronous:true});this.setRepeatMode(false)},beginExecute:function(){var q,p=g(),t=this,o=new c({label:n,emphasize:"primary",onClick:function(){localStorage.setItem("PIMwebContextLoadMode",p.tglAllParts.checkFlag?"0":"1");if(q.close){q.close()}else{q.destroy()}}}),s=new c({label:d,onClick:function(){p.tglAllParts.checkFlag=true;p.tglItfParts.checkFlag=false}}),r=new c({label:m,onClick:function(){if(q.close){q.close()}else{q.destroy()}}});q=new i({modalFlag:true,ensureHeightDefinitionOnHierarchy:true,title:j,content:p.content,immersiveFrame:f.get().getFrameWindow().getImmersiveFrame(),buttons:{Ok:o,Apply:s,Cancel:r}});q.addEventListener("close",function(){t.end()})},endExecute:function(){}})});define("DS/PIMwebViewController/PIMwebInteferenceListCmd",["DS/ApplicationFrame/CommandCheckHeader","DS/PADUtils/PADContext"],function(c,b){var a=c.extend({init:function(d){this._parent(d);var g=this,e,f;require(["DS/PIMwebViewController/PIMwebItfCtrl"],function(h){e=h.getItfCtrl({pad3DViewer:b.get()});f=e.subscribe("onItfListClosed",function(){if(g){g.setState(false)}});g.setState(localStorage.getItem("PIMwebItfListVisPref")==="1")});this.onStateChange(function(){if(!e||!g){return}var h=g.getState();if(h){e.showGUX()}else{e.hideGUX()}localStorage.setItem("PIMwebItfListVisPref",h?"1":"0")});this._destroy=function(){if(e){e.subscribe(f)}e=g=f=null;var h=Object.getPrototypeOf(this);if(h._destroy){h._destroy.apply(this,arguments)}}}});return a});