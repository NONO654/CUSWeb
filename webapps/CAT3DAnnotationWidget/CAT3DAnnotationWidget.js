/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils",["DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/WebappsUtils/WebappsUtils"],function(c,d){var e;var a=d.getWebappsAssetUrl("CAT3DAnnotationUtils","icons/22/");var b={setLoadedAssetType:function(f){e=f},getLoadedAssetType:function(){return e},getNodeInfos:function(f){var g={};if(!f){return null}if(e==="3DXML"){g.name=f.name;if(b.isReference(f)){g.icon=a+"I_Reference.png"}if(b.isRepReference(f)){g.icon=a+"I_Part.png"}}return g},getNodeType:function(g){var f=c.getNodeType(g);if(f){return f}f=g.getType?g.getType():null;if(f){return f}f=g.productType;return f},getNodeID:function(g){if(e==="3DXML"){return g.persistentId}var f=c.getNodeID(g);if(undefined===f&&g.getID){f=g.getID()}return f},getRoots:function(i){if(e!=="3DXML"){return c.getRoots(i)}else{var h=i.getRootBagPath().getChildrenPathes();var f=[];for(var g=0;g<h.length;g++){f.push(h[g].getLastElement(true))}return f}},is3DLeaf:function(f){if(e!=="3DXML"){return c.is3DLeaf(f)}else{return b.isRepReference(f)}},isPLMNode:function(g){if(e!=="3DXML"){return c.isPLMNode(g)}else{var f=b.getNodeType(g);return f!==undefined&&f!==null&&f!==""}},isReference:function(g){if(!g){return undefined}if(e!=="3DXML"){var f=c.isReference(g);if(f){return f}f=g.isPLMReference&&typeof g.isPLMReference==="function"?g.isPLMReference():false;return f}else{return g.productType?(g.productType==="Reference3D"):false}},isRepReference:function(g){if(!g){return undefined}if(e!=="3DXML"){var f=c.isRepReference(g);if(f){return f}f=g.isPLMReference&&typeof g.isPLMRepReference==="function"?g.isPLMRepReference():false;return f}else{return g.productType?(g.productType==="ReferenceRep"):false}},isRepInstance:function(g){if(!g){return undefined}if(e!=="3DXML"){var f=c.isRepInstance(g);if(f){return f}f=g.isPLMReference&&typeof g.isPLMRepInstance==="function"?g.isPLMRepInstance():false;return f}else{return g.productType?(g.productType==="InstanceRep"):false}},isInstance:function(g){if(!g){return undefined}if(e!=="3DXML"){var f=c.isInstance(g);if(f){return f}f=g.isPLMReference&&typeof g.isPLMInstance==="function"?g.isPLMInstance():false;return f}else{return g.productType?(g.productType==="Instance3D"):false}}};return b});define("DS/CAT3DAnnotationUI/CAT3DAnnotationFilterListItem",["UWA/Core","UWA/Class","DS/CAT3DAnnotationBaseUI/CAT3DAnnotationExpander","DS/Controls/Toggle","DS/VisuEvents/EventsManager","css!DS/CAT3DAnnotationUI/CAT3DAnnotationUI.css"],function(d,b,g,h,c){var i={};var f="";require(["i18n!DS/CAT3DAnnotationUI/assets/nls/CAT3DAnnotationUI"],function(j){f=j.SelectAllLbl});var a=g.extend({publishedProperties:{noSelectAll:{defaultValue:false,type:Boolean},name:{defaultValue:"",type:String},children:{defaultValue:null,type:Array},callback:{defaultValue:null,type:Object},checkFlag:{defaultValue:false,type:Boolean},type:{defaultValue:"checkbox",type:String},displayTitle:{defaultValue:true,type:Boolean},expandingPreference:{defaultValue:false,type:Boolean}},init:function(l){var v=l||{};this._endOffset=55;this._parent(v);this.callback=v.callback;this._checkFlag=v.checkFlag;this.name=v.name;this._type=v.type;this._expandFlag=false;this._expandingPref=v.expandingPreference;var m=v.children;var w;var n;var s;var q;var r;var u=function(p,z){if(z){var x=[];for(var y=0;y<m.length;y++){if(m[y].isDisplayed()){x.push(m[y])}}for(var y=0;y<x.length;y++){x[y].setCheckFlag(p,false,true)}}w.checkFlag=p;if(w.checkFlag&&!n.hasClassName("AnnotFilterSectionActive")){n.addClassName("AnnotFilterSectionActive")}else{if(!w.checkFlag&&n.hasClassName("AnnotFilterSectionActive")){n.removeClassName("AnnotFilterSectionActive")}}};this.body=d.createElement("div",{"class":"AnnotFilterListItemGroup"});if(m.length>1&&!v.noSelectAll){n=d.createElement("div",{id:this.name+"_SelectAll_div","class":"AnnotFilterListItem AnnotFilterListItemOdd"});var j=true;for(var t=0;t<m.length;t++){if(!m[t].getCheckFlag()){j=false}}w=new h({type:"checkbox",checkFlag:j,touchMode:false}).inject(n);w.elements.container.setStyles({display:"inline-block",position:"relative","min-height":"0px",bottom:"5px","margin-left":"4px"});s=function(){u(!w.checkFlag,true)};var o=d.createElement("div",{"class":"AnnotFilterSectionBody"});var k=d.createElement("p",{"class":"AnnotFilterListItemText"}).inject(o);k.setStyle("margin-left","5px");k.innerHTML=f;n.appendChild(o);this.body.appendChild(n);u(w.checkFlag,false)}for(var t=0;t<m.length;t++){this.body.appendChild(m[t].getContent())}if(s){w.addEventListener("buttonclick",s);c.addEvent(n,"onPrimaryPointerClick",s)}if(n&&q&&r){n.addEventListener("mouseenter",q);n.addEventListener("mouseleave",r)}this.setCheckFlag=function(p,x){this._checkFlag=p;if(!this._checkFlag&&this.expandedFlag&&!x){this.setExpandedFlag(!this.expandedFlag)}};this.getExpandedFlag=function(){return this.expandedFlag};this.setExpandedFlag=function(p){this.expandedFlag=p;if(this.expandedFlag){this.expand()}else{this.close()}i[this._expandingPref]=this.expandedFlag};this.update=function(){var x=true;for(var p=0;p<m.length;p++){if(!m[p].getCheckFlag()){x=false}}if(this._type==="checkbox"){this._checkFlag=x}if(w){u(x)}};this.clear=function(){if(n&&s){c.removeEvent(n,"onPrimaryPointerClick",s)}if(n&&q&&r){n.removeEventListener("mouseenter",q);n.removeEventListener("mouseleave",r)}c.removeEvent(this.elements.header,"onPrimaryPointerClick",this.headerCB)}},buildView:function(){this._parent();var j=this;setTimeout(function(){if(i[j._expandingPref]===true){if((j._type==="radio"&&j._checkFlag)||j._type!=="radio"){j.expand()}}else{i[j._expandingPref]=false;j.close()}},0);if(!this.headerCB){var j=this;this.headerCB=function(){if(j.callback&&!j._checkFlag){j.setCheckFlag(!j._checkFlag);j.callback({name:j.name,checkFlag:j._checkFlag})}if(j._expandingPref){i[j._expandingPref]=!j.expandedFlag}};c.addEvent(this.elements.header,"onPrimaryPointerClick",this.headerCB)}}});var e=b.extend({init:function(j){this._parent(j);var j=j||{};var y=this;this.name=j.name;var n=j.children;var t=j.checkFlag;var w;var C;var k;var z;var o;var A;var m;var l;var r=true;this.setCheckFlag=function(p,E,D){t=p;if(w){w.setCheckFlag(p,E)}o.checkFlag=t;if(t&&!C.hasClassName("AnnotFilterSectionActive")){C.addClassName("AnnotFilterSectionActive")}else{if(!t&&C.hasClassName("AnnotFilterSectionActive")){C.removeClassName("AnnotFilterSectionActive")}}if(D){j.callback({name:j.name,json:j.json,idPath:j.idPath,checkFlag:t})}};this.getCheckFlag=function(){return t};this.setDisplayFlag=function(p){if(z&&r){r=false;if(C.hasClassName("AnnotFilterListItemOdd")){C.removeClassName("AnnotFilterListItemOdd")}C.removeChild(k);C.appendChild(z)}if(C){C.hidden=!p}};this.setNbElems=function(p){if(l){l.innerHTML=p.toString()}};this.setExpandedFlag=function(p){if(w){return w.setExpandedFlag(p)}};this.getExpandedFlag=function(){if(w){return w.getExpandedFlag()}};this.update=function(D){if(w){w.update()}if(n&&n.length){var p=0;var H=0;for(var E=0;E<n.length;E++){if(n[E].isDisplayed()){n[E].setIsOdd(H%2===1);H++}n[E].update();p+=n[E].getDisplayedElements()}if(l){var G=0;for(var E=0;E<n.length;E++){G+=n[E].getCheckedElements()}l.innerHTML=G.toString()}if(j.type==="checkbox"){var F=true;for(var E=0;E<n.length;E++){if(n[E].getCheckFlag()===false&&n[E].isDisplayed()){F=false;break}}this.setCheckFlag(F,true)}if(p!==0){y.setDisplayFlag(true)}else{if(!D){y.setDisplayFlag(false)}else{if(z&&!r){r=true;C.addClassName("AnnotFilterListItemOdd");C.removeChild(z);C.appendChild(k)}}}}};this.getDisplayedElements=function(){var p=0;if(n){for(var D=0;D<n.length;D++){p+=n[D].getDisplayedElements()}}else{if(j.type==="checkbox"&&this.isDisplayed()){p++}}return p};this.getCheckedElements=function(){var p=0;if(n){for(var D=0;D<n.length;D++){p+=n[D].getCheckedElements()}}else{if(j.type==="checkbox"&&t&&this.isDisplayed()){p++}}return p};this.getChildrenItems=function(){if(n&&n.length){return n}return[]};this.getContent=function(){return C};this.isDisplayed=function(){if(C){return !C.hidden}};this.setIsOdd=function(p){if(w){return}if(p&&C.hasClassName("AnnotFilterListItemEven")){C.removeClassName("AnnotFilterListItemEven")}if(!p&&C.hasClassName("AnnotFilterListItemOdd")){C.removeClassName("AnnotFilterListItemOdd")}C.addClassName(p?"AnnotFilterListItemOdd":"AnnotFilterListItemEven")};this.addBottomSeparator=function(){var p=d.createElement("div",{"class":"AnnotFilterListItemSeparator"});C.appendChild(p)};this.clear=function(){if(n){for(var p=0;p<n.length;p++){n[p].clear()}}if(w){w.clear()}if(C&&m){c.removeEvent(C,"onPrimaryPointerClick",m)}};C=d.createElement("div",{id:j.id+"_div","class":"AnnotFilterListItem"});if(j.displayTitle===true||j.displayTitle===undefined){C.setAttribute("title",j.header)}if(j.className){C.addClassName(j.className)}if(j.isOdd){C.addClassName("AnnotFilterListItemOdd")}m=function(){if(r){y.setCheckFlag(!t);j.callback({name:j.name,idPath:j.idPath,checkFlag:t})}};k=d.createElement("div",{"class":"AnnotFilterSectionBody"});if(j.icon){var u=d.createElement("div",{"class":"AnnotFilterListItemIcon"}).inject(k);u.setStyle("background-image",'url("'+j.icon+'")')}if(j.header){var v=d.createElement("p",{"class":"AnnotFilterListItemText"}).inject(k);v.innerHTML=j.header;var x=(j.icon&&j.displayNbElems)?"calc(80% - 50px)":(j.icon?"calc(100% - 50px)":(j.displayNbElems?"calc(80% - 10px)":"calc(100% - 10px)"));v.setStyles({width:x})}if(n&&n.length){r=false;var q=0;for(var s=0;s<n.length;s++){if(n[s].isDisplayed()){n[s].setIsOdd(q%2===1);q++}}if(j.type==="radio"){o=new h({type:j.type,checkFlag:false,touchMode:false}).inject(C);A=function(){if(!t){y.setCheckFlag(true);j.callback({name:j.name,checkFlag:true})}};w=new a({name:this.name,touchMode:false,header:j.header,children:n,checkFlag:t,callback:j.callback,noSelectAll:j.noSelectAll,displayTitle:false,type:j.type,expandingPreference:j.expandingPreference});z=d.createElement("div",{"class":"AnnotFilterDivExpander"});z.appendChild(w.elements.container);C.appendChild(z)}else{o=new h({type:j.type,checkFlag:false,touchMode:false}).inject(C);A=function(){var D=o.checkFlag;for(var E=0;E<n.length;E++){if(n[E].isDisplayed()){n[E].setCheckFlag(D,false,true)}}if(D&&l){var p=0;for(var E=0;E<n.length;E++){if(n[E].isDisplayed()){p++}}l.innerHTML=p.toString()}else{if(l){l.innerHTML="0"}}};w=new a({name:this.name,touchMode:false,header:j.header,children:n,noSelectAll:j.noSelectAll,displayTitle:false,expandingPreference:j.expandingPreference});z=d.createElement("div",{"class":"AnnotFilterDivExpander"});z.appendChild(w.elements.container);C.appendChild(z)}}else{o=new h({type:j.type,checkFlag:false,touchMode:false}).inject(C);A=function(){setTimeout(function(){o.checkFlag=t;if((t&&j.type==="radio")||(j.type==="checkbox")){j.callback({name:j.name,idPath:j.idPath,checkFlag:t})}},0)};C.appendChild(k)}o.elements.container.setStyles({"vertical-align":"top",display:"inline-block","margin-left":"4px","margin-top":"5px"});if(j.displayNbElems){l=d.createElement("p");var B=0;if(w){l.addClassName("AnnotFilterExpanderNbElems");w.elements.header.appendChild(l);for(var s=0;s<n.length;s++){B+=n[s].getCheckedElements()}}else{l.addClassName("AnnotFilterNbElems");if(j.nbElems){B=j.nbElems}k.appendChild(l)}l.innerHTML=B.toString()}if(r){y.setIsOdd(true)}if(C&&m){c.addEvent(C,"onPrimaryPointerClick",m)}if(o&&A){o.addEventListener("buttonclick",A)}if(t!==undefined&&t!==null){this.setCheckFlag(t)}if(j.isDisplayed!==undefined){this.setDisplayFlag(j.isDisplayed)}}});return e});define("DS/CAT3DAnnotationWidget/CATA3EAppInit",["DS/WAfrContainer/App"],function(c){var b;var a={annotLoaderLib:"DS/CAT3DAnnotationModel/CAT3DAnnotationLoader",wkbFile:"CAT3DAnnotationWidgetWkb.xml",wkbModule:"CAT3DAnnotationWidget",defaultCmdHdr:"CAT3DAnnotationWidgetDefaultHdr",defaultCmdJSModule:"DS/CAT3DAnnotationCommands/CAT3DAnnotationWidgetDefaultCmd"};return c.extend({setUp:function(d){if(!d.sourceApp){var f=this;require(["DS/CAT3DAnnotationWidget/CAT3DAnnotationWidget"],function(g){b=new g({widget:window.widget,viewerAttachment:function(h){f.pad3DViewer=h.pad3DViewer;d.done(h.pad3DViewer.render())},modelerType:"VPM",data:a})});return}if(!d.sourceApp.pad3DViewer){d.done();return}this.pad3DViewer=d.sourceApp.pad3DViewer;var e=function(h){if(h.sourceApp&&!h.sourceApp.isDisposeCalled()){h.sourceApp.dispose()}var g=h;g.widgetData=a;b.setUp(g)};if(!b){require(["DS/CAT3DAnnotationWidget/CAT3DAnnotationWidget"],function(g){b=new g({widget:window.widget,data:a,pad3DViewer:d.sourceApp.pad3DViewer});e(d)})}else{e(d)}},dispose:function(d){b.dispose(d);this._parent(d)}})});define("DS/CAT3DAnnotationUtils/CAT3DAnnotationUnits",["i18n!DS/CAT3DAnnotationUtils/assets/nls/CAT3DAnnotationUtils"],function(b){var a={convert:function(f,e,c){var h=e;switch(h.toLowerCase()){case"length":h="Length";break;case"area":h="Area";break;case"angle":h="Angle";break;case"volume":h="Volume";break}var d=window&&window.widget?window.widget.getValue(h):null;if(!d){d=a.Types[h].defaultValue}if(a[h]&&a[h][d]){var g=parseFloat((parseFloat(f)*a[h][d].ratio).toFixed(3));if(c){return g.toString()+" "+a[h][d].nls}return g}if(c){return parseFloat(f).toString()+" "+a[h][d].nls}return parseFloat(f)},getCurrentUnitNls:function(d){var e=d,f=false;switch(e.toLowerCase()){case"length":e="Length";f=true;break;case"area":e="Area";f=true;break;case"angle":e="Angle";f=true;break;case"volume":e="Volume";f=true;break}if(!f){return""}var c=window&&window.widget?window.widget.getValue(e):null;if(!c){c=a.Types[e].defaultValue}return a[e][c].nls},Types:{Length:{name:"Length",defaultValue:"mm"},Angle:{name:"Angle",defaultValue:"deg"},Volume:{name:"Volume",defaultValue:"mm3"},Area:{name:"Area",defaultValue:"mm2"}},Length:{mm:{name:"mm",nls:b.units.mm,ratio:Math.pow(10,3)},cm:{name:"cm",nls:b.units.cm,ratio:Math.pow(10,2)},m:{name:"m",nls:b.units.m,ratio:1},km:{name:"km",nls:b.units.km,ratio:Math.pow(10,-3)},inch:{name:"inch",nls:b.units.inch,ratio:Math.pow(10,3)/25.4},foot:{name:"foot",nls:b.units.foot,ratio:Math.pow(10,3)/304.8}},Angle:{deg:{name:"deg",nls:b.units.deg,ratio:180/Math.PI},rad:{name:"rad",nls:b.units.rad,ratio:1}},Volume:{mm3:{name:"mm3",nls:b.units.mm3,ratio:Math.pow(10,9)},cm3:{name:"cm3",nls:b.units.cm3,ratio:Math.pow(10,6)},m3:{name:"m3",nls:b.units.m3,ratio:1},km3:{name:"km3",nls:b.units.km3,ratio:Math.pow(10,-9)},inch3:{name:"inch3",nls:b.units.inch3,ratio:Math.pow(10,9)/16387.064},foot3:{name:"foot3",nls:b.units.foot3,ratio:Math.pow(10,9)/28316846.6}},Area:{mm2:{name:"mm2",nls:b.units.mm2,ratio:Math.pow(10,6)},cm2:{name:"cm2",nls:b.units.cm2,ratio:Math.pow(10,4)},m2:{name:"m2",nls:b.units.m2,ratio:1},km2:{name:"km2",nls:b.units.km2,ratio:Math.pow(10,-6)},inch2:{name:"inch2",nls:b.units.inch2,ratio:Math.pow(10,6)/645.16},foot2:{name:"foot2",nls:b.units.foot2,ratio:Math.pow(10,6)/92903.04}}};return Object.freeze(a)});define("DS/CAT3DAnnotationExpController/CAT3DAnnotationExpController",[],function(){});define("DS/CAT3DAnnotationUI/CAT3DAnnotationUI",[],function(){});define("DS/CAT3DAnnotationUtils/CAT3DAnnotationUtilsOptions",["UWA/Core","UWA/Class","UWA/Class/Options","UWA/Utils"],function(b,e,c,a){var d=e.singleton(c,{init:function(){var f={};if(window.annotUrlComplementForODT){f=a.parseQuery(window.annotUrlComplementForODT)}if(window.location.search!==""){b.extend(f,a.parseQuery(window.location.search));if(f.widgetDomain){b.extend(f,a.parseQuery(f.widgetDomain))}}var i={};var h=Object.keys(f);for(var g=0;g<h.length;g++){i[h[g]]=true}if("debug_me" in f){i.debug=true}if(window.debug===true){i.debug=true}if(window.CAT3DANN_FILTER_PANEL_VER1===true){i.CAT3DANN_FILTER_PANEL_VER1=true}if(window.CAT3DANN_ASSY_FILTERING===true){i.CAT3DANN_ASSY_FILTERING=true}if(window.testWkb===true){i.testWkb=true}if(parseFloat(window.CAT3DGRID_MAXLABEL)){i.CAT3DGRID_MAXLABEL=parseFloat(window.CAT3DGRID_MAXLABEL)}this.setOptions(i)}});return d});define("DS/CAT3DAnnotationCommands/CAT3DAnnotationCommands",[],function(){});define("DS/CAT3DAnnotationUI/CAT3DAnnotationFilterTolFilterItem",["UWA/Core","UWA/Class","DS/Controls/Toggle","DS/Controls/Button","DS/Controls/LineEditor","DS/Controls/ComboBox","DS/VisuEvents/EventsManager","css!DS/CAT3DAnnotationUI/CAT3DAnnotationUI.css"],function(f,a,j,g,e,i,c){var k="";var l="";var d="";var h="";require(["i18n!DS/CAT3DAnnotationUI/assets/nls/CAT3DAnnotationUI"],function(m){k=m.ValueLbl;l=m.ApplyLbl;d=m.MinLbl;h=m.MaxLbl});var b=a.extend({init:function(q){var B=0;var s="infEqual";var F=0;var y="infEqual";this.setCheckFlag=function(I){w=I;v.checkFlag=w;m.disabled=!w;n.disabled=!w;C.disabled=!w;p.disabled=!w;u.disabled=!w;if(w&&n.currentValue==="equal"){C.disabled=true;p.disabled=true}if(w&&!H.hasClassName("AnnotFilterSectionActive")){H.addClassName("AnnotFilterSectionActive");if(!o()){m.value=0;n.currentValue="infEqual";C.value=0;p.currentValue="infEqual"}}else{if(!w&&H.hasClassName("AnnotFilterSectionActive")){H.removeClassName("AnnotFilterSectionActive")}}};this.update=function(){};this.getContent=function(){return H};this.getFormulaComponents=function(){return{leftValue:B,leftOperand:s,rightValue:F,rightOperand:y}};this.clear=function(){c.removeEvent(H,"onPrimaryPointerClick",E)};var o=function(){var I=true;if(B===undefined||B===null||s===undefined||s===null){I=false}if(F===undefined||F===null||y===undefined||y===null){I=false}if(s==="equal"){I=true}else{if(s==="infEqual"&&y==="infEqual"){I=B<=F}else{I=B<F}}return I};var z=this;this.name=q.name;var w=q.checkFlag;var H=f.createElement("div",{id:this.name+"_div","class":"AnnotFilterListItem AnnotFilterTolListItem"});H.ondragstart=function(){return false};var x=f.createElement("div",{"class":"AnnotFilterTolLineDiv"}).inject(H);x.setStyles({"margin-top":"2px"});var v=new j({type:"checkbox",checkFlag:false,touchMode:false}).inject(x);v.addEventListener("buttonclick",function(){v.checkFlag=w});var r=f.createElement("p",{id:this.name+"_sectionPar","class":"AnnotFilterListItemText"}).inject(x);r.innerHTML=k;var u=new g({label:l,touchMode:false,emphasize:"primary",onClick:function(I){I.stopPropagation();if(o()){q.callback({checkFlag:w,formulaComponents:z.getFormulaComponents()})}}});u.inject(x);x=f.createElement("div",{"class":"AnnotFilterTolLineDiv"}).inject(H);var A=f.createElement("p",{id:this.name+"_sectionPar","class":"AnnotFilterListItemText"}).inject(x);A.innerHTML=d;var D=[{labelItem:">=",valueItem:"infEqual"},{labelItem:">",valueItem:"inf"},{labelItem:"=",valueItem:"equal"}];var n=new i({elementsList:D,selectedIndex:0,touchMode:false,enableSearchFlag:false,actionOnClickFlag:false}).inject(x);n.addEventListener("change",function(){s=n.currentValue;if(s==="equal"){p.disabled=true;C.disabled=true}else{p.disabled=false;C.disabled=false}u.disabled=!o()});var m=new e({placeholder:"0",disabled:false,selectAllOnFocus:true,touchMode:false,autoCommitFlag:true,pattern:"^[0-9]*.?[0-9]*$"}).inject(x);m.addEventListener("change",function(){B=parseFloat(m.value)||0;u.disabled=!o()});x=f.createElement("div",{"class":"AnnotFilterTolLineDiv"}).inject(H);var t=f.createElement("p",{id:this.name+"_sectionPar","class":"AnnotFilterListItemText"}).inject(x);t.innerHTML=h;var G=[{labelItem:"<=",valueItem:"infEqual"},{labelItem:"<",valueItem:"inf"}];var p=new i({elementsList:G,selectedIndex:0,touchMode:false,enableSearchFlag:false,actionOnClickFlag:false}).inject(x);p.addEventListener("change",function(){y=p.currentValue;u.disabled=!o()});var C=new e({placeholder:"0",disabled:false,touchMode:false,selectAllOnFocus:true,autoCommitFlag:true,pattern:"^[0-9]*.?[0-9]*$"}).inject(x);C.addEventListener("change",function(){F=parseFloat(C.value)||0;u.disabled=!o()});if(q.formulaComponents){m.value=q.formulaComponents.leftValue;n.currentValue=q.formulaComponents.leftOperand;C.value=q.formulaComponents.rightValue;p.currentValue=q.formulaComponents.rightOperand;if(n.currentValue==="equal"){setTimeout(function(){C.disabled=true;p.disabled=true},0)}}if(q.className){H.addClassName(q.className)}v.elements.container.setStyles({display:"inline-block","min-height":"0px",position:"relative",bottom:"4px",left:"3px"});r.setStyles({width:"calc(100% - 100px)"});u.elements.container.setStyles({"float":"right","margin-right":"5px","margin-top":"2px",height:"100%"});m.elements.container.setStyles({display:"inline"});m.elements.container.childNodes[0].setStyles({width:"calc(100% - 120px)","margin-left":"3px",height:"22px"});C.elements.container.setStyles({display:"inline"});C.elements.container.childNodes[0].setStyles({width:"calc(100% - 120px)","margin-left":"3px",height:"22px"});A.setStyles({"vertical-align":"middle",width:"30px"});t.setStyles({"vertical-align":"middle",width:"30px"});this.setCheckFlag(q.checkFlag);var E=function(J){if(w&&(J.from[0].view===r)){z.setCheckFlag(!w);q.callback({checkFlag:w,formulaComponents:z.getFormulaComponents()})}else{var I=J.from[0].view;setTimeout(function(){if(I!==v.elements.checkSign&&I!==r){return}z.setCheckFlag(!w);q.callback({checkFlag:w,formulaComponents:z.getFormulaComponents()})},0)}};c.addEvent(H,"onPrimaryPointerClick",E)}});return b});define("DS/CAT3DAnnotationModel/CAT3DAnnotationModel",[],function(){});define("DS/CAT3DAnnotationModelLoader/CAT3DAnnotationVisuLoader",["UWA/Class","DS/Visualization/Node3D","DS/Visualization/LoaderUtils"],function(b,d,c){var a=b.extend({init:function(f){var e=f||{};this._parent(e);this.getType=function(){return"visu"};this.createAnnotationSet=function(i){var j=new d();if(i!==undefined&&i!==null){j.setVisibility(i)}j.getAnnotationClassType=function(){return"tpsAnnotationSet"};return j};this.postProcessViewsAndCaptures=function(){};var h=function(k){if(k.getNodeType&&k.getNodeType()==="Mesh3D"){return k}var i=k.children;for(var j=0;j<i.length;j++){var l=h(i[j]);if(l){return l}}};var g=function(k){if(k.setPickParent){k.setPickParent(true)}var i=k.children;for(var j=0;j<i.length;j++){g(i[j])}};this.createReps=function(m,o,p,n){var q,l,k;var i={textureInBlack:localStorage.getItem("3DAnnotWhiteVectorAsBlack")!=="false",edgeTransparency:p!==1&&p!==2&&p!==3,processText:c.isProcessDataAsynchronous&&o};var j=function(w){if(i.textureInBlack&&w.whiteVectorInBlack){w.whiteVectorInBlack()}var v=h(w);v.setShadow(false,false);v.setSSAO(false);v.setVisibilityInTree(false);if(m.nodeXMLtype!=="TPSCG"){v.setNoZ(true)}else{var u=true;var x=v.getPrimitives();for(q=0;q<x.length;q++){var s=x[q].getDimension();if(s==="surface"||s==="volume"){u=false}}v.setNoZ(u)}g(w);var r=w.children[0].isVisible();w.children[0].setVisibility(true);var t=w.getBoundingSphere();if(t.radius>0||t.pixelRadius>0){n.addChild(w);n.setVisibility(r)}};if(m.reps[0]&&m.reps[0].reps){l=new d();c.processData([l],m.reps[0],undefined,true,i,c.isProcessDataAsynchronous?function(){j(l)}:undefined);if(!c.isProcessDataAsynchronous){j(l)}}if(m.reps[1]&&m.reps[1].reps){k=new d();c.processData([k],m.reps[1],undefined,true,i,c.isProcessDataAsynchronous?function(){j(k)}:undefined);if(!c.isProcessDataAsynchronous){j(k)}}};this.createCappingRep=function(i){if(i.cappingRep.reps){var k=new d();c.processData([k],i.cappingRep,undefined,true);var j=h(k);j.setVisibilityInTree(false);j.setShadow(false,false);j.excludeFromHighlight(true,true);j.setNoZ(false);k.name=i.name+"_cappingRep";return k}}},loadAnnotation:function(i){if(i.nodeInfo.type===6){return}else{if(i.nodeInfo.nodeXMLtype==="AnnotationSet"){i.annotationSetNode.getContextType=function(){return(i.nodeInfo.contextType!==undefined?i.nodeInfo.contextType:0)}}else{var g=Object.keys(i.nodeInfo);if(g.length){var h=new d();i.annotationSetNode.addChild(h);for(var f=0;f<g.length;f++){if(g[f]==="reps"){this.createReps(i.nodeInfo,i.processText,i.annotationSetNode.getContextType(),h)}else{if(g[f]==="cappingRep"){var e=this.createCappingRep(i.nodeInfo);if(e){h.cappingRep=e}}}}}}}}});return a});define("DS/CAT3DAnnotationWidget/CAT3DAnnotationExperienceApp",["DS/WAfrContainer/App"],function(c){var b;var a={wkbFile:"CAT3DAnnotationWidgetWkb.xml",wkbModule:"CAT3DAnnotationWidget",defaultCmdHdr:"CAT3DAnnotationWidgetDefaultHdr",defaultCmdJSModule:"DS/CAT3DAnnotationCommands/CAT3DAnnotationWidgetDefaultCmd"};return c.extend({setUp:function(d){if(!d.sourceApp){var f=this;require(["DS/CAT3DAnnotationWidget/CAT3DAnnotationWidget"],function(g){b=new g({widget:window.widget,viewerAttachment:function(h){f.pad3DViewer=h.pad3DViewer;d.done(h.pad3DViewer.render())},modelerType:"DEC",data:a})});return}if(!d.sourceApp.pad3DViewer){d.done();return}this.pad3DViewer=d.sourceApp.pad3DViewer;var e=function(h){if(h.sourceApp&&!h.sourceApp.isDisposeCalled()){h.sourceApp.dispose()}var g=h;g.widgetData=a;b.setUp(h)};if(!b){require(["DS/CAT3DAnnotationWidget/CAT3DAnnotationWidget"],function(g){b=new g({widget:window.widget,data:a,pad3DViewer:d.sourceApp.pad3DViewer});e(d)})}else{e(d)}},dispose:function(d){b.dispose(d);this._parent(d)}})});define("DS/CAT3DAnnotationModel/CAT3DAnnotationNode",["DS/Visualization/Node3D","DS/WebappsUtils/WebappsUtils"],function(c,b){var d;var a=c.extend({init:function(j){var f=j||{};this._parent();var h;var e;var i=false;var k;this.getAnnotationClassType=function(){return"tps"};this.getAnnotationType=function(){return f.type};this.getAnnotationSupertype=function(){if(e){return e}var l={1:1,2:1,3:1,4:1,5:2,6:2,7:3,8:3,9:3,10:3,11:3,12:4,13:4,14:4,15:4,16:4,17:5,18:5,19:6,20:6,21:6,22:7,23:7,24:7,25:7,26:7,27:7,28:7,29:1,30:1,31:1,32:2,33:2,34:1,35:1,36:1,37:4,38:4,40:8,41:8,42:8,43:8,44:8,45:8,46:8,47:9,51:10,54:8};e=l[f.type];return e};this.getAnnotationName=function(){return f.name};this.getAnnotationUuid=function(){return f.uuid};this.getAnnotationIcon=function(){if(h){return h}var m={1:"I_W3DAnnot_Text",2:"I_W3DAnnot_FlagNote",3:"I_W3DAnnot_Datum",4:"I_W3DAnnot_NonSemanticGDT",5:"I_W3DAnnot_Datum",6:"I_W3DAnnot_DatumTarget",7:"I_W3DAnnot_Position",8:"I_W3DAnnot_Concentricity",9:"I_W3DAnnot_Symmetry",10:"I_W3DAnnot_Profline",11:"I_W3DAnnot_Profsurf",12:"I_W3DAnnot_Linear",13:"I_W3DAnnot_Angular",14:"I_W3DAnnot_Linear",15:"I_W3DAnnot_Linear",16:"I_W3DAnnot_BasicDim",17:"I_W3DAnnot_TotalRO",18:"I_W3DAnnot_CircularRO",19:"I_W3DAnnot_Parallelism",20:"I_W3DAnnot_Perpendicularity",21:"I_W3DAnnot_Angularity",22:"I_W3DAnnot_Straightness",23:"I_W3DAnnot_Flatness",24:"I_W3DAnnot_Circularity",25:"I_W3DAnnot_Cylindricity",26:"I_W3DAnnot_Profline",27:"I_W3DAnnot_Profsurf",28:"I_W3DAnnot_Position",29:"I_W3DAnnot_Roughness",30:"I_W3DAnnot_NOA",31:"I_W3DAnnot_Weld",32:"I_W3DAnnot_ReferenceFrame",33:"I_W3DAnnot_Datum",34:"I_W3DAnnot_Dimension",35:"I_W3DAnnot_DatumTarget",36:"I_W3DAnnot_CoordDim",37:"I_W3DAnnot_OrientedAngular",38:"I_W3DAnnot_OrientedLinear",40:"I_W3DAnnot_CGPoint",41:"I_W3DAnnot_CGLine",42:"I_W3DAnnot_CGPlane",43:"I_W3DAnnot_CGCircle",44:"I_W3DAnnot_CGCylinder",45:"I_W3DAnnot_CGCurve",46:"I_W3DAnnot_CGThread",47:"I_W3DAnnot_KnowledgeAttribute",51:"I_W3DAnnot_RestrictedArea",54:"I_W3DAnnot_CGCylinder"};var l=m[f.type];if(l){h=b.getWebappsAssetUrl("CAT3DAnnotationRsc","icons/22/")+l+".png"}return h};this.addLinkedData=function(l){if(!l){return}if(!k){k={}}if(l.type===-1){if(!k.hyperlinksAndComments){k.hyperlinksAndComments={}}k.hyperlinksAndComments.hiddenText=l.text}else{if(l.type===0){if(!k.hyperlinksAndComments){k.hyperlinksAndComments={}}if(!k.hyperlinksAndComments.urls){k.hyperlinksAndComments.urls=[]}k.hyperlinksAndComments.urls.push({title:l.anchorText,url:l.address})}else{if(l.type&(1<<8)){if(!k.relatedDocs){k.relatedDocs=[]}k.relatedDocs.push(l)}else{if(l.type&(1<<9)){if(!k.requirements){k.requirements=[]}k.requirements.push(l)}else{if(l.type==="failureModes"){k.failureModes=l.data}}}}}};this.getAnnotationHyperlinkData=function(){return k};this.getAnnotationID=function(){return f.tpsID};this.getAnnotationTTRS=function(){return f.ttrs};this.setDisplayFlag=function(l){if(l===i){return}i=l};this.getDisplayFlag=function(){return i};d=f.onAnnotationAttrModifiedCB;var g;if(f.hyperlinksData&&f.hyperlinksData.length){for(g=0;g<f.hyperlinksData.length;g++){if(f.hyperlinksData[g].type===0||f.hyperlinksData[g].type===-1){this.addLinkedData(f.hyperlinksData[g])}}}if(f.failureModes&&f.failureModes.length){this.addLinkedData({type:"failureModes",data:f.failureModes})}if(f.Text){this.getText=function(){return f.Text}}if(f.NOAText){this.getNOAText=function(){return f.NOAText}}if(f.NOAType){this.getNOAType=function(){return f.NOAType}}this.visible=true;this.setVisibilityFree(false)},setVisibility:function(e){if(e===this.visible){return}this._parent(e);this.setVisibilityFree(e===false);d(this,"visibility")},toJSON:function(){if(!this.jsonObject){var j=this.isDefaultAnnotation?this.isDefaultAnnotation():undefined;var f=this.getAnnotationToleranceValue?this.getAnnotationToleranceValue():undefined;var e=this.getAnnotationToleranceZoneValue?this.getAnnotationToleranceZoneValue():undefined;var k=this.getAnnotationDimensionLimits?this.getAnnotationDimensionLimits():undefined;var h=this.getGeneralTolerance?this.getGeneralTolerance():undefined;var i=this.getTabulatedLimit?this.getTabulatedLimit():undefined;this.jsonObject={};if(this.getAnnotationID()!==undefined){this.jsonObject.id=this.getAnnotationID()}if(this.getAnnotationName()!==undefined){this.jsonObject.name=this.getAnnotationName()}if(this.getAnnotationIcon()!==undefined){this.jsonObject.icon=this.getAnnotationIcon()}if(this.getAnnotationType()!==undefined){this.jsonObject.type=this.getAnnotationType()}if(this.getAnnotationSupertype()!==undefined){this.jsonObject.superType=this.getAnnotationSupertype()}if(this.getAnnotationTTRS()!==undefined){this.jsonObject.ttrs=this.getAnnotationTTRS()}if(this.getText){this.jsonObject.text=this.getText()}if(this.getNOAText){this.jsonObject.noaText=this.getNOAText()}if(this.getNOAType){this.jsonObject.noaType=this.getNOAType()}if(j!==undefined){this.jsonObject.isDefaultAnnot=j}if(f!==undefined){this.jsonObject.toleranceValue=f}if(e!==undefined){this.jsonObject.toleranceZoneValue=e}if(k!==undefined){this.jsonObject.toleranceLimits=k}if(h!==undefined){this.jsonObject.generalTolerance=h}if(i!==undefined){this.jsonObject.tabulatedLimit=i}}if(this.children&&this.children.length&&this.children[0].getAnnotationClassType){if(!this.jsonObject.children){this.jsonObject.children=[]}this.jsonObject.children.splice(0,this.jsonObject.children.length);for(var g=0;g<this.children.length;g++){this.jsonObject.children.push(this.children[g].toJSON())}}if(this.getDisplayFlag()!==undefined){this.jsonObject.displayFlag=this.getDisplayFlag()}if(this.getAnnotationHyperlinkData()!==undefined){this.jsonObject.hyperlink=this.getAnnotationHyperlinkData()}this.jsonObject.isVisible=this.isVisible();return this.jsonObject}});return a});window.top.performance.mark("A3E_jsAppLoad");window.performance.mark("A3E_jsAppLoad");define("DS/CAT3DAnnotationWidget/CAT3DAnnotationWidget",["UWA/Core","UWA/Utils","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtilsOptions","css!DS/UIKIT/UIKIT.css"],function(r,e,i,k){var f={};var v;var u,l,g=false;var d=null;var o=function(x,y,w){window.top.performance.measure(window.widget.id+"_"+x,w?y:window.widget.id+"_"+y);window.performance.measure(x,y)};var a=function(w){window.top.performance.mark(window.widget.id+"_"+w);window.performance.mark(w)};var p=function(){f.viewer.getContentName({callbacks:{onComplete:function(w){f.widget.setTitle(w.contentName)},onFailure:function(){}}})};var b=function(){if(f.annotControllerReady&&f.defaultCmdReady){o("A3E_Global widget creation time","A3E_jsAppLoad",true);f.widget.dispatchEvent("onWidgetAndAppReady",f.widget.getValue("widgetForODTReplay")==="1"?[{pad3DViewer:f.viewer}]:undefined)}};function q(A,z,x){var y=function(){var B={merge:true,file:z.wkbFile,module:z.wkbModule};if(k.getOption("testWkb")&&B.file==="CAT3DAnnotSemanticWidgetWkb.xml"){B={merge:true,file:"CAT3DAnnotSemanticWidgetWkb_TST.xml",module:"CAT3DAnnotSemanticTestWidget"}}else{if(k.getOption("testWkb")&&B.file==="CAT3DAnnotationWidgetWkb.xml"){B={merge:true,file:"CAT3DAnnotationWidgetWkb_TST.xml",module:"CAT3DAnnotationTestWidget"}}}A.loadActionBar(B)};if(x){A.loadActionBar({merge:false,file:"ENOPAD3DViewer.xml",module:"ENOPAD3DViewer"});var w=A.subscribe({event:"onActionBarReady"},function(){A.unsubscribe(w);w=null;y()})}else{y()}}var c=function(x){if(f.viewer){window.log("Must not be called in this method");return}x.unsubscribe(v);v=null;x.getController()._model._modelLoader.setCGRWithSG(true);o("A3E_PAD3DViewer creation","A3E_PAD3DViewerReady");a("A3E_ownCommands");require(["DS/CAT3DAnnotationFavoriteCtx/CAT3DAnnotationFavoriteCtxManager","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader"],function(B,z){o("A3E_Annot controller JS Load","A3E_ownCommands");a("A3E_annotController");l=B;u=z;var A=l.getFavoriteContextManager({context:x});A.activateDrop();var y=u.getAnnotationModelLoader({context:x,favoriteCtxManager:A});if(f.widgetData.annotLoaderLib&&y.getLoaderType()!=="WithSemantic"&&y.getLoaderType()!==f.widgetData.annotLoaderLib){y.setLoaderType(f.widgetData.annotLoaderLib)}y.setActiveState(1);f.viewerAttachment({pad3DViewer:x});x.getFrameWindow().getContextualUIManager().activateContextualBarOnLeftClicAfterCSOChange();o("A3E_Annot controller Init","A3E_annotController");f.annotControllerReady=true;b()});var w=x.subscribe({event:"onActionBarReady"},function(){o("A3E_Action Bar merge app commands","A3E_ownCommands");f.viewer=x;f.viewer.unsubscribe(w);w=null;require(["DS/ENOPAD3DViewer/utils/PAD3DViewerRestoreSession"],function(y){y.restoreSession()});f.viewer.subscribe({event:"onRootAdded"},p);f.viewer.subscribe({event:"onRootRemoved"},p);f.viewer.subscribe({event:"onRootAttached"},p);f.viewer.subscribe({event:"onRootDetached"},p);f.viewer.subscribe({event:"onContentNameModified"},p);a("A3E_beforeDefaultCmdLoad");require(["DS/ApplicationFrame/CommandsManager"],function(z){var y=f.viewer.getCommandContext?f.viewer.getCommandContext():null;z.setDefaultCommand({ID:f.widgetData.defaultCmdHdr,className:f.widgetData.defaultCmdJSModule,context:y});o("A3E_Default Cmd Init","A3E_beforeDefaultCmdLoad");f.defaultCmdReady=true;b()})});q(x,f.widgetData)};var h=function(x){if(g){return}g=true;var A,y,B=[],D=[],z=require("DS/PADUtils/PADSettingsMgt"),C=require("DS/PADUtils/PADCommandProxy"),w=["DS/CAT3DAnnotationUtils/CAT3DAnnotationUnits","i18n!DS/CAT3DAnnotationWidget/assets/nls/CAT3DAnnotationWidget","DS/PADUtils/PADSharedSettings","i18n!DS/PADUtils/assets/nls/PADUtils"];if(f.modelerType!=="DEC"){w.push("DS/CfgAuthoringContextUX/scripts/CfgAuthoringContext")}require(w,function(I,F,E,H,J){y=J;function G(){var N=E.listAvailableSharedSettings(),M=E.usedSharedSettings,L=[],K;K=N.indexOf("useIndexAccleration");if(K!==-1){N.splice(K,1);if(M.indexOf("useIndexAccleration")===-1&&!d){L.push("useIndexAccleration")}}E.addSharedSettings(f.widget,L);if(d){D.push("useIndexAccleration")}if(k.getOption("debug")){if(!f.widget.hasPreference("populateTags")){B.push({preference:{name:"populateTags",type:"boolean",label:H.activateFilter_label,defaultValue:"false"},fct:function(P){var Q=x.getBIController();if(Q){Q.toggleBetweenStandaloneAndSlaveMode(P?"STANDALONE":"SLAVE")}}})}if(!f.widget.hasPreference("webapi_timeout")){B.push({preference:{name:"webapi_timeout",type:"text",label:"Query timeout",defaultValue:"60000"}})}}else{D.push("populateTags");D.push("webapi_timeout")}D.forEach(function(P){f.widget.deleteValue(P)});D.length=0;B.forEach(function(P){f.widget.mergePreferences([P.preference])});N.forEach(function(P){if(M.indexOf(P)===-1){L.push(P)}});E.addSharedSettings(f.widget,L);if(!f.widget.hasPreference(I.Types.Length.name)){f.widget.addPreference({name:I.Types.Length.name,type:"list",label:F.UnitsLengthText,defaultValue:I.Types.Length.defaultValue,options:[{label:F.Millimeter,value:I.Length.mm.name},{label:F.Centimeter,value:I.Length.cm.name},{label:F.Meter,value:I.Length.m.name},{label:F.Kilometer,value:I.Length.km.name},{label:F.Inch,value:I.Length.inch.name},{label:F.Foot,value:I.Length.foot.name}]});f.widget.addPreference({name:I.Types.Angle.name,type:"list",label:F.UnitsAngleText,defaultValue:I.Types.Angle.defaultValue,options:[{label:F.Degree,value:I.Angle.deg.name},{label:F.Radian,value:I.Angle.rad.name}]});f.widget.addPreference({name:I.Types.Area.name,type:"list",label:F.UnitsAreaText,defaultValue:I.Types.Area.defaultValue,options:[{label:F.SquareMillimeter,value:I.Area.mm2.name},{label:F.SquareCentimeter,value:I.Area.cm2.name},{label:F.SquareMeter,value:I.Area.m2.name},{label:F.SquareKilometer,value:I.Area.km2.name},{label:F.SquareInch,value:I.Area.inch2.name},{label:F.SquareFoot,value:I.Area.foot2.name}]});f.widget.addPreference({name:I.Types.Volume.name,type:"list",label:F.UnitsVolumeText,defaultValue:I.Types.Volume.defaultValue,options:[{label:F.CubicMillimeter,value:I.Volume.mm3.name},{label:F.CubicCentimeter,value:I.Volume.cm3.name},{label:F.CubicMeter,value:I.Volume.m3.name},{label:F.CubicKilometer,value:I.Volume.km3.name},{label:F.CubicInch,value:I.Volume.inch3.name},{label:F.CubicFoot,value:I.Volume.foot3.name}]})}if(B.length||L.length){var O=function(){B.forEach(function(P){var R=P.preference.name;var S=f.widget.getValue(R),Q=z.getSetting(R);S=P.preference.type==="boolean"&&(typeof S!=="boolean")?"true"===S:S;if(S!==Q){z.setSetting(R,S)}if(P.fct){P.fct(S)}});z.updateWidgetPreferences();if(!A&&B.length){A=C.create({events:{onPreferenceModification:function(P){B.some(function(Q){if(P.name===Q.preference.name){if(typeof P.value!=="boolean"&&typeof P.value!=="string"){throw new Error("Value must be a string or a boolean")}if(z.getSetting(P.name)!==P.value){if(Q.preference.type==="boolean"&&typeof P.value!=="boolean"){throw new Error("Preference is a boolean type so value must be a boolean")}Q.debounce=true;f.widget.setValue(P.name,Q.preference.type==="boolean"?(P.value?"true":"false"):P.value);z.setSetting(P.name,P.value)}if(Q.fct){Q.fct(P.value)}return true}return false})}}});B.forEach(function(P){if(P.cb){z.addEvent(P.cb,function(Q){if(!P.debounce){A.preferenceModification({name:P.preference.name,value:Q})}else{P.debounce=false}})}})}};O();f.widget.addEvent("endEdit",O)}}if(y&&!f.widget.hasPreference("changeControlActivation")){y.initialize2(x.getFrameWindow().getViewerFrame(),C.appId(),"hide","top-right",function(K){y=null;if(K&&K.isLicenseValid===true){y=J;B.push({preference:{name:"changeControlActivation",type:"boolean",label:H.changeControlActivation_label,defaultValue:"false"},fct:function(L){y[L?"show":"hide"]()},cb:"onChangeControlActivation",debounce:false});B.push({preference:{name:"changeControlPosition",type:"list",label:H.changeControlPosition_label,defaultValue:"top-right",options:[{label:H["top-right_label"],value:"top-right"},{label:H["top-left_label"],value:"top-left"},{label:H["bottom-left_label"],value:"bottom-left"},{label:H["bottom-right_label"],value:"bottom-right"}]},fct:function(L){y.setPosition(L)}});z.setSetting("authorizeChangeControl",true)}else{D.push("changeControlActivation");D.push("changeControlPosition")}G()})}else{G()}})};var j=function(){if(!f.viewer){if(d===null){o("A3E_UWA widget loading","A3E_widgetLoad");a("A3E_LoadJSPAD3DViewer");if(f.modelerType!=="DEC"){d=false;setTimeout(function(){j()},0)}else{i.getGrantedRoles(function(w){for(var x=0;x<w.length;x++){if(w[x].id==="EXL"){d=true}else{if(w[x].id==="PAR"){d=false;break}}}d=d!==null?d:false;j()})}return}require(["DS/ENOPAD3DViewer/PAD3DViewer","DS/ENOPAD3DViewer/utils/PAD3DViewerRestoreSession","text!DS/CAT3DAnnotationWidget/assets/json/CAT3DAnnotationWidget.json"],function(w,z,x){o("A3E_PAD3DViewer load JS","A3E_LoadJSPAD3DViewer");a("A3E_PAD3DViewerReady");var B=JSON.parse(x),A;B.context="Default";A=new w({widget:f.widget,windowOptions:B,actionbar_corrected:true,allowAuthoring:!d});var y=require("DS/PADUtils/PADSettingsMgt");y.setSetting("appModelerType",f.modelerType==="DEC"?"DEC":"VPM");if(f.modelerType!=="DEC"){y.setSetting("settypes",true)}if(d){y.setSetting("authorized_root_types",["MCAD Assembly","MCAD Component","CATDrawing","VPMReference","VPMRepReference"]);y.setSetting("dynamic_authorized_types",true)}else{A.setAuthorizedRootTypes(y.getSetting(f.modelerType==="DEC"?"dec_authorized_root_types":"ups_authorized_root_types"))}v=A.subscribe({event:"onReady"},c);z.init({widget:f.widget,pad3DViewer:A});h(A)})}};var t=function(){if(f.viewer){f.viewer.refresh()}};var n=function(){if(f.viewer){u.unreferenceAnnotationModelLoader({context:f.viewer});l.unreferenceFavoriteContextManager({context:f.viewer});f.viewer.destroy()}g=false;f={};u=l=d=null};function s(w){if(f.viewer){f.viewer.search({searchQuery:w})}}var m=function(w){if(w.pad3DViewer){f.modelerType=require("DS/PADUtils/PADSettingsMgt").getSetting("appModelerType")}if(f.modelerType!=="DEC"||f.modelerType!=="VPM"){f.modelerType=w.modelerType==="DEC"?"DEC":"VPM";if(w.pad3DViewer){require("DS/PADUtils/PADSettingsMgt").setSetting("appModelerType",f.modelerType)}}f.widget=w.widget;f.widgetData=w.data;if(!w.pad3DViewer){o("A3E_JS dependencies loading","A3E_jsAppLoad",true);a("A3E_widgetLoad");if(w.viewerAttachment){f.viewerAttachment=w.viewerAttachment;j()}else{f.viewerAttachment=function(x){f.widget.setBody(x.pad3DViewer.render())};f.widget.addEvent("onLoad",j)}f.widget.addEvent("onRefresh",t);f.widget.addEvent("onDestroy",n);f.widget.addEvent("onSearch",s);f.widget.setMetas({helpPath:(f.widgetData.defaultCmdHdr.search("Insight")>=0?"CAT3DAnnotSemanticWidget":"CAT3DAnnotationWidget")+"/assets/help"})}else{f.viewer=w.pad3DViewer;h(w.pad3DViewer)}};m.prototype.setUp=function(w){require(["DS/ApplicationFrame/CommandsManager"],function(y){f.widget.setMetas({helpPath:(f.widgetData.defaultCmdHdr.search("Insight")>=0?"CAT3DAnnotSemanticWidget":"CAT3DAnnotationWidget")+"/assets/help"});var B={lastCommand:[],currentCommand:null,defaultCommand:null},x=f.viewer.getCommandContext?f.viewer.getCommandContext():null;if(x){y._commandsState[x]=B}else{y._commandsState=B}y.resetDefaultCommand(x);y._isCommandEnding=false;y._ignoreCommandBeginWhileEndingCommand=false;["_commands","_cmdCheckHeader"].forEach(function(D){var C=x?y[D][x]:y[D];Object.keys(C).forEach(function(E){var F=C[E];if(F&&F._destroy){F._destroy()}delete C[E]})});if(w.sourceApp&&w.sourceApp.pad3DViewer!==f.viewer){f.viewer=w.sourceApp.pad3DViewer}var A=0;var z=f.viewer.subscribe({event:"onActionBarReady"},function(){A++;if(A===1){require(["DS/CAT3DAnnotationFavoriteCtx/CAT3DAnnotationFavoriteCtxManager","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader"],function(G,E){var H=f.viewer?f.viewer.getFrameWindow():null;if(H&&H.removeReviewModel){H.removeReviewModel("DMUSection")}l=G;u=E;var F=l.getFavoriteContextManager({context:f.viewer});F.activateDrop();var D=u.getAnnotationModelLoader({context:f.viewer,favoriteCtxManager:F});if(w.widgetData.annotLoaderLib&&D.getLoaderType()!=="WithSemantic"&&D.getLoaderType()!==w.widgetData.annotLoaderLib){D.setLoaderType(w.widgetData.annotLoaderLib)}D.setActiveState(1);q(f.viewer,w.widgetData);f.annotControllerReady=true;b()})}else{f.viewer.unsubscribe(z);var C=f.viewer.getCommandContext?f.viewer.getCommandContext():null;y.setDefaultCommand({ID:w.widgetData.defaultCmdHdr,className:w.widgetData.defaultCmdJSModule,context:C});f.defaultCmdReady=true;w.done();b()}});f.viewer.loadActionBar({merge:false,file:"ENOPAD3DViewer.xml",module:"ENOPAD3DViewer"})})};m.prototype.dispose=function(){if(f.viewer){if(u){u.unreferenceAnnotationModelLoader({context:f.viewer})}if(l){l.unreferenceFavoriteContextManager({context:f.viewer})}}f.defaultCmdReady=false;f.annotControllerReady=false};return m});define("DS/CAT3DAnnotationCommands/CAT3DAnnotationOpenFavoriteCtxCmd",["DS/StateCommandEngine/StateCommand","DS/Visualization/PathElement","DS/StateCommandEngine/PathElementAgent","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/PADUtils/PADContext","DS/CAT3DAnnotationFavoriteCtx/CAT3DAnnotationFavoriteCtxManager","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils"],function(b,f,h,a,e,g,d,c){return b.extend({init:function(l){this._parent(l,{mode:"exclusive",isAsynchronous:true});this.setRepeatMode(false);var m,n,j,k=function(q){if(!q||!q.externalPath||!q.externalPath.length||q.externalPath[0].name!=="RootBag"){return false}for(var o=q.externalPath.length-1;o>=0;--o){var p=q.externalPath[o];if(c.isPLMNode(p)){return c.is3DLeaf(p)?new f(q.externalPath.slice(0,o+1)):false}}},i=function(o){setTimeout(function(){if(m&&m.object3D&&m.object3D.length===1){e.empty();var p=d.giveFavoriteContextManager({context:g.get()});j=p.manageFavoriteContext({path:k(m.object3D[0].pathElement),onComplete:function(){j=null;o()}}).cancel}},0)};this.buildGraph=function(){var o=g.get();o.getViewer().setDefaultPicking(false);n=true;j=null;m=new h({agentId:"CATFavoriteContextSelAgt",frameWindow:o.getFrameWindow(),engWithPSOHSO:true,withPSO:true,withHSO:true,valuedFromCSO:true,saveToCSO:false,pickingMode:"rep",prePickingMode:"rep",pickingFilter:k,prePickingFilter:k});var p=this.createInitialState("InitState"),q=this.getFinalState();this.addTransition({iInitialState:p,iFinalState:q,iEvent:m,iAction:i});this.addTransition({iInitialState:p,iFinalState:q,iCondition:function(){var r=c.getRoots(o);if(r&&r.length===1){if(r[0]&&c.is3DLeaf(r[0])){var s=o.getRootBagPath();s.addElement(r[0]);m.object3D.push({pathElement:s});return true}}},iAction:i})};this.execute=function(){if(n){a.empty();e.empty()}};this.endExecute=function(){g.get().getViewer().setDefaultPicking(true);if(j){j()}}}})});define("DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController",["UWA/Core","UWA/Controls/Abstract","DS/CoreEvents/ModelEvents","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils"],function(e,d,c,b){var a=d.singleton({init:function(){var f=new c();this.subscribe=function(l,k){if(l&&k){return f.subscribe({event:l},k)}};this.unsubscribe=function(k){if(k){f.unsubscribe(k)}};this.saveA3EWidgetPref=function(o){if(!o||!o.pref||!(o.path||o.rootLog||o.id)){return}if(!window.widget){return}var k=window.widget.getValue(o.pref);k=k&&e.is(k,"string")?JSON.parse(k):undefined;if(!k){window.widget.addPreference({name:o.pref,type:"hidden"});k=[]}if(o.rootLog){window.widget.setValue(o.pref,JSON.stringify(o.rootLog));return}if(o.id){if(!k.some(function(q){return q===o.id})){k.push(o.id);window.widget.setValue(o.pref,JSON.stringify(k))}return}var p={idPath:g(o.path)};if(o.data){var n=Object.keys(o.data);for(var m=0;m<n.length;m++){p[n[m]]=o.data[n[m]]}}for(var l=k.length-1;l>=0;l--){if(j(k[l].idPath,p.idPath)){k.splice(l,1)}}k.push(p);window.widget.setValue(o.pref,JSON.stringify(k))};this.getA3EWidgetAnnotSetsLoadedPref=function(o){if(!o||!o.path){return}if(!window.widget){return}var k=window.widget.getValue("A3EAnnotSetsLoaded");k=k&&e.is(k,"string")?JSON.parse(k):undefined;if(!k){return}var l=[];var n=g(o.path);for(var m=0;m<k.length;m++){if(i(n,k[m].idPath)){var p=o.path.clone();h(p,k[m].idPath,n.length);l.push({path:p,visibility:k[m].visibility,ctxType:k[m].ctxType})}}return l};this.removeA3EWidgetPref=function(n){if(!n||!n.pref||!(n.path||n.id)){return}if(!window.widget){return}var k=window.widget.getValue(n.pref);k=k&&e.is(k,"string")?JSON.parse(k):undefined;if(!k){return}if(n.id){for(var l=k.length-1;l>=0;l--){if(k[l]===n.id){k.splice(l,1);window.widget.setValue(n.pref,JSON.stringify(k));if(k.length===0){window.widget.deleteValue(n.pref)}}}return}var m=g(n.path);for(var l=k.length-1;l>=0;l--){if(j(k[l].idPath,m)){k.splice(l,1);window.widget.setValue(n.pref,JSON.stringify(k));if(k.length===0){window.widget.deleteValue(n.pref)}}}};this.deleteA3EWidgetPref=function(k){if(!k||!k.pref){return}if(!window.widget){return}window.widget.deleteValue(k.pref)};var g=function(n){var k=[];var m=n.clone();while(m){var l=m.getLastElement(true);if(b.getNodeID(l)){k.unshift(b.getNodeID(l))}m=m.getParentPath()}return k};var i=function(m,k){if(m.length>k.length){return false}for(var l=0;l<m.length;l++){if(m[l]!==k[l]){return false}}return true};var h=function(l,k,n){if(k.length===n-1){return}var p=l.getChildrenPathes();for(var m=0;m<p.length;m++){var o=p[m].getLastElement(true);if(b.getNodeID(o)===k[n]){l.addElement(o);return h(l,k,n+1)}}};var j=function(m,k){if(!m||!k){return false}if(m.length!==k.length){return false}for(var l=0;l<m.length;l++){if(m[l]!==k[l]){return false}}return true};this.setPreference=function(n,m){if(!n){return}var k=localStorage.getItem(n),l=m;switch(n){case"3DAnnotSemStd":if(typeof l!=="string"){return}break;case"FavoriteContextLoadMode":if(l!=="0"&&l!=="1"&&l!=="2"){return}break;case"3DAnnotLoadARMPartsPref":if(typeof l!=="boolean"){return}break;case"3DAnnotDisplayCapturesPref":if(typeof l!=="boolean"){return}break;case"3DAnnotWhiteVectorAsBlack":if(typeof l!=="boolean"){return}break;case"3DAnnotUpdateThumbnailsPref":if(typeof l!=="boolean"){return}break;case"3DAnnotAttributesOrderedList":return;default:if(n.indexOf("3DAnnotSemAttr_")!==-1){if(typeof l!=="boolean"){return}}}if(k!==l){localStorage.setItem(n,l);f.publish({event:"onPreferenceModified",data:{preference:n,value:l},context:this})}};this.getPreference=function(m){if(!m){return}var l=localStorage.getItem(m);switch(m){case"3DAnnotSemStd":return l;case"FavoriteContextLoadMode":l=(l==="0"||l==="2")?l:"1";break;case"3DAnnotLoadARMPartsPref":l=l==="true";break;case"3DAnnotDisplayCapturesPref":l=l==="true";break;case"3DAnnotWhiteVectorAsBlack":l=l!=="false";break;case"3DAnnotUpdateThumbnailsPref":l=l!=="false";break;case"3DAnnotAttributesOrderedList":var k=l?JSON.parse(l):null;l=k&&e.is(k,"array")?k:["2","3DAnnotations","0","1","3","4","5"];break;default:if(m.indexOf("3DAnnotSemAttr_")!==-1){l=l!=="false"}}return l}}});a.init();return a});define("DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader",["UWA/Class","UWA/Utils","DS/Visualization/AnnotationServices","DS/WebappsUtils/WebappsUtils","DS/Visualization/Utils","DS/CoreEvents/ModelEvents","DS/PADUtils/views/PADAlert","DS/PADUtils/views/PADProgressBar","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils","i18n!DS/CAT3DAnnotationModelLoader/assets/nls/CAT3DAnnotationModelLoader"],function(a,j,k,f,c,e,b,i,d,l,h){var n=a.extend({init:function(S){this._parent(S);var at=0;var Q=S.ctxViewer;var z=S.favoriteCtxManager;var v=null;var A=new k();var aa=[];var Y=4;var s=this;var V=new e();var w;var ak=null;var T=0;var J=false;var K=[];var ar=[];var x=[];var av=[];var E=[];var D=[];var R=[];var y=[];var aj=[];var ah=true;var au=[];var ap=[];var ac={};var B=0;var F=0;var aq=false;var O=false;this.setActiveState=function(aA){if(aA===at||(at!==0&&at!==1&&at!==2)){return}at=aA;O=true;t();if(at===1||at===2){if(!v){s.setLoaderType()}an();if(!ac.onRemoveRoot){ac.onRemoveRoot=Q.subscribe({event:"onRootRemoved"},af);ac.on3DPlayAssetChanged=Q.subscribe({event:"on3DPlayAssetChanged"},function(){af({path:Q.getRootBagPath()})});ac.onRootAttached=Q.subscribe({event:"onRootAttached"},r);ac.onRootDetached=Q.subscribe({event:"onRootDetached"},G);ac.onHide=Q.subscribe({event:"onHide"},ad);ac.onShow=Q.subscribe({event:"onShow"},p);ac.onRefreshBegin=Q.subscribe({event:"onRefreshBegin"},u);ac.onRefreshCompleted=Q.subscribe({event:"onRefreshCompleted"},o)}if(at===1&&!ac.onAddRoot){if(z){F=z.subscribe({event:"onFavoriteContextLoading"},H)}ac.onAddRoot=Q.subscribe({event:"onRootAdded"},C);ac.onLoadingComplete=Q.subscribe({event:"onLoadingComplete"},ao);ac.onLoadingFailure=Q.subscribe({event:"onLoadingFailure"},ao);ac.onLoadingCanceled=Q.subscribe({event:"onLoadingCanceled"},ao);B=d.subscribe("onPreferenceModified",Z);L()}}else{if(T>0){T=1;ae()}var ay=Object.keys(ac);var ax;for(ax=0;ax<ay.length;ax++){Q.unsubscribe(ac[ay[ax]])}ac={};if(B){d.unsubscribe(B);B=0}if(F&&z){z.unsubscribe(F);F=0}var az=R.slice();for(ax=R.length-1;ax>=0;ax--){R[ax].getParentPath().getLastElement(true).removeChild(R[ax].getLastElement(true))}if(az.length){al("onAnnotationSetRemoved",{pathes:az});Q.getViewer().render()}D.splice(0,D.length);R.splice(0,R.length);y.splice(0,y.length);K.splice(0,K.length);ar.splice(0,ar.length);x.splice(0,x.length);av.splice(0,av.length);E.splice(0,E.length);aj.splice(0,aj.length)}al("onAnnotModelLoaderActiveStateChanged",{state:at});O=false};this.clear=function(){this.setActiveState(0);Q=v=A=s=V=w=ac=aj=null;aa=K=ar=x=av=E=D=R=y=au=null};this.getActiveState=function(){return at};var P=function(aC){var ay=aC.clone();var aB=ay.getLastElement(true);var ax;for(ax=0;ax<R.length;ax++){var aA=R[ax].getLastElement(true);if(aA===aB){d.removeA3EWidgetPref({path:R[ax],pref:"A3EAnnotSetsLoaded"});d.saveA3EWidgetPref({path:aC,pref:"A3EAnnotSetsLoaded",data:{visibility:aB.isVisible(),ctxType:aB.getContextType()}});for(var az=R.length-1;az>=0;az--){if(R[ax].isEqual(R[az])){R[az]=aC.clone()}}}}for(ax=0;ax<D.length;ax++){if(D[ax].path.getLastElement(true)===ay.getParentPath().getLastElement(true)){D[ax].path=ay.getParentPath().clone()}}K.splice(0,K.length)};this.getLoadedAnnotationSets=function(){var aQ=[],aO;if(!at){return aQ}var aN=Q.getRootBagPath();if(K.length===0){var aG=[];for(var aK=0;aK<R.length;aK++){var aL=true;for(aO=0;aO<y.length;aO++){if(y[aO].path.isAParentOf(R[aK])){aL=false;break}}if(aL){aG.push(R[aK])}}var az=function(aU){var aT=aU.getLastElement(true);if(aT.getTreeOrder&&aT.getTreeOrder()){return true}var aS=aU.getChildrenPathes();for(var aV=0;aV<aS.length;aV++){var aR=az(aS[aV]);if(aR===true){return true}}return undefined};var aI=function(aV){var aR=[];var aU=aV;while(!aU.isEqual(aN)){var aT=aU.getLastElement(true);var aS=0;if(aT.getTreeOrder&&aT.getTreeOrder()){aS=aT.getTreeOrder()}aR.splice(0,0,aS);aU=aU.getParentPath()}return aR};var ay=function(aU,aS){if(aU.length===0){return true}if(aS.length===0){return false}var aR=Math.max(aU.length,aS.length);for(var aT=0;aT<aR;aT++){if(aU[aT]===aS[aT]){continue}else{return aU[aT]>aS[aT]}}return false};var aE=[];var aM=function(aW){var aV=aW.getLastElement(true);var aU,aT;if(aV.getAnnotationClassType&&aV.getAnnotationClassType()==="tpsAnnotationSet"){var aS=true;for(aU=0;aU<aG.length;aU++){if(aW.isEqual(aG[aU])){for(aT=0;aT<aE.length;aT++){if(aE[aT].isEqual(aG[aU])){aS=false;break}}if(aG[aU]&&aS){aE.push(aG[aU].clone())}break}}}else{var aR=aW.getChildrenPathes();for(aU=0;aU<aR.length;aU++){aM(aR[aU])}}};var aB=aN.getChildrenPathes();for(var aD=0;aD<aB.length;aD++){aE=[];var aF;if(az(aB[aD])){var aC=[];for(aF=0;aF<aG.length;aF++){if(aB[aD].isAParentOf(aG[aF])){aC.push({index:aI(aG[aF].getParentPath().getParentPath()),path:aG[aF]})}}var aA=[];for(aF=0;aF<aC.length;aF++){var aJ=aC[aF].index;var aH=aC[aF].path.clone();if(aE.length===0){aE.push(aH);aA.push(aJ)}else{var aP=false;for(aO=0;aO<aA.length;aO++){if(ay(aJ,aA[aO])){if(aO===aA.length-1){aE.push(aH);aA.push(aJ);aP=true;break}else{if(ay(aA[aO+1],aJ)){aE.splice(aO+1,0,aH);aA.splice(aO+1,0,aJ);aP=true;break}}}else{break}}if(!aP){aE.splice(0,0,aH);aA.splice(0,0,aJ)}}}}else{aM(aB[aD])}K=K.concat(aE)}}if(K&&K.length){for(var ax=0;ax<K.length;ax++){aQ.push(K[ax].clone())}}return aQ};this.subscribe=function(ay,ax){if(ay&&ax){return V.subscribe({event:ay},ax)}return undefined};this.unsubscribe=function(ax){if(V&&ax){V.unsubscribe(ax)}};this.isRunning=function(){return(x&&x.length>0)||(E&&E.length>0)};this.setLoaderType=function(ay){var ax=ay||w||"DS/CAT3DAnnotationModel/CAT3DAnnotationLoader";if(ax!==w){w=ax;require([ax],function(aB){if(w===ax){v=new aB();if(R.length){var aA;for(var az=R.length-1;az>=0;az--){aA=R[az].getLastElement(true);R[az].getParentPath().getLastElement(true).removeChild(aA);aA.removeChildren();aA=null;R.splice(az,1)}R.splice(0,R.length);K.splice(0,K.length);D.splice(0,D.length);t();an();L()}}})}};this.getLoaderType=function(){return v?v.getType():"undefined"};this.hasAlreadyBeenLoaded=function(az,aB){var ax,ay;if(az){if(aB){for(ax=0;ax<au.length;ax++){if(au[ax].isEqual(az)){return 1}}}else{for(ax=0;ax<D.length;ax++){if(D[ax].recursive){if(D[ax].path.isAParentOf(az)){for(ay=0;ay<R.length;ay++){if(az.isAParentOf(R[ay])){return 1}else{if(az.getLastElement(true)===R[ay].getParentPath().getLastElement(true)){return 7}}}for(ay=0;ay<x.length;ay++){if(x[ay]&&(az.isAParentOf(x[ay])||az.isEqual(x[ay]))){return 3}}return 2}else{if(D[ax].path.getLastElement(true)===az.getLastElement(true)){return 7}}}else{if(az.isEqual(D[ax].path)){for(ay=0;ay<R.length;ay++){var aA=R[ay].getParentPath();if(az.isEqual(aA)){return 4}}for(ay=0;ay<x.length;ay++){if(x[ay]&&az.isEqual(x[ay])){return 6}}return 5}else{if(D[ax].path.getLastElement(true)===az.getLastElement(true)){return 8}}}}}}return 0};function U(aB,aA){if(l.getNodeID(aA.getLastElement(true))===aB){return aA}var ay=aA.getChildrenPathes();var az;for(var ax=0;ax<ay.length;ax++){az=U(aB,ay[ax]);if(az){return az}}return undefined}this.loadFTALightModel=function(aM,aU,aK,aY){var aJ,aH,aR;if(!aM||!A||!at){return}var aB=aY&&aY.length===1&&aY[0]===2;if(aB){if(s.hasAlreadyBeenLoaded(aM,true)===1){return}au.push(aM.clone())}else{var aA=s.hasAlreadyBeenLoaded(aM);if(aA===1||aA===2||aA===3){return}if(!aK&&(aA===4||aA===5||aA===6)){return}if(!aK&&(aA===7||aA===8)){for(aH=0;aH<R.length;aH++){if(R[aH].getParentPath().getLastElement(true)===aM.getLastElement(true)){var ay=aM.clone();ay.addElement(R[aH].getLastElement(true));P(ay)}}return}var az=[];if(aM.isEqual(Q.getRootBagPath())){az=Q.getRootBagPath().getChildrenPathes()}else{az.push(aM)}for(var aD=0;aD<az.length;aD++){aJ=az[aD];var aE=false;for(aH=0;aH<D.length;aH++){if(D[aH].path.isEqual(aJ)){if(!D[aH].recursive&&aK){D[aH].recursive=aK}aE=true}else{if(aK&&aJ.isAParentOf(D[aH].path)&&!D[aH].recursive){D[aH].recursive=true}}}if(!aE&&!aJ.isEqual(Q.getRootBagPath())){D.push({path:aJ.clone(),recursive:aK!==undefined?aK:false})}}}var aF=[];if(aK){q(aM,aF,aU)}else{if(aB){var aC=aM.getChildrenPathes();for(aR=0;aR<aC.length;aR++){var aX=aC[aR].getChildrenPathes();if(l.getNodeType(aM.getLastElement(true))==="CATProduct"&&aX.length===1&&l.is3DLeaf(aX[0].getLastElement(true))){aF.push(aX[0])}else{if(l.isReference(aM.getLastElement(true))&&aX.length===1&&l.isReference(aX[0].getLastElement(true))){var aL=aX[0].getChildrenPathes();if(aL.length===1&&l.isRepInstance(aL[0].getLastElement(true))){aF.push(aL[0].getChildrenPathes()[0])}}}}}else{aF.push(aM)}}var aO=[],aN=[],aG=[],ax=[],aW=[];var aT=false;for(aH=0;aH<aF.length;aH++){aJ=aF[aH];var aP=l.getNodeID(aJ.getLastElement(true));if(aP){for(aR=0;aR<R.length;aR++){if(aJ.getLastElement(true)===R[aR].getParentPath().getLastElement(true)){aP=false;break}}for(aR=0;aR<x.length;aR++){if(aJ.isEqual(x[aR])){aP=false;break}}for(aR=0;aR<aO.length;aR++){if(aJ.getLastElement(true)===aO[aR].getLastElement(true)){aP=false;break}}if(aP){var aI=l.getNodeID(aJ.getLastElement(true));if(aJ.getLastElement(true).xml){W(aJ,aJ.getLastElement(true).xml,aU,aY,true);aJ.getLastElement(true).xml=null;x.push(aJ);aT=true}else{if(!l.getLoadedAssetType()){if(aJ.getLastElement(true).getLoadedStream&&aJ.getLastElement(true).getLoadedStream()){if(E.indexOf(aI)===-1){av.push({path:aJ.clone(),id:aI});if(aJ.getLastElement(true).getLoadedStream()==="thumbnail"){aW.push(aI);ax.push({node:Q.getController().getNode({id:aI}),stream:"cgr"})}else{aG.push(aI)}}}else{aN.push(aI);aO.push(aJ)}}}}}}if(aN.length||aG.length||aW.length){J=x.length!==0;x=x.concat(aO);E=E.concat(aG);E=E.concat(aW);var aQ=function(a0){if(a0&&a0.node){var a2=l.getNodeID(a0.node);var a1;for(var aZ=0;aZ<av.length;aZ++){if(av[aZ].id===a2){if(!a0.xml){av.splice(aZ,1);return}av[aZ].xml=a0.xml;av[aZ].node=a0.node;a1=U(a2,av[aZ].path);if(a1){av.splice(aZ,1)}break}}if(!a1||!at){return}if(x.indexOf(a1)!==-1){return}x.push(a1);E.splice(E.indexOf(a2),1);if(a0.xml){Q.getController().lockNodes({ids:[a2]});W(a1,a0.xml,aU,aY);return}al("onNoAnnotationSetLoaded",{path:a1})}else{al("onNoAnnotationSetLoaded",{})}};var aS=function(){for(var aZ=0;aZ<av.length;aZ++){if(av[aZ].xml&&av[aZ].node){aQ(av[aZ])}}};var aV=function(){var aZ;for(aZ=0;aZ<aG.length;aZ++){E.splice(E.indexOf(aG[aZ]),1)}var a0=null;for(aZ=0;aZ<av.length;aZ++){a0=U(aI,av[aZ]);if(a0){av.splice(aZ,1);break}}if(E.length===0&&x.length===0){al("onNoAnnotationSetLoaded",{})}};if(aN.length){Q.getController().getAttributes({ids:aN,attributes:["cgr","ds6w:label"],callbacks:{onComplete:function(a1){for(var a0=0;a0<aN.length;a0++){var a2=a1[aN[a0]],aZ=a2?a2.cgr:null;if(aZ){ab(aO[a0],aZ,aU,aY)}else{al("onNoAnnotationSetLoaded",{path:aO[a0]})}}},onFailure:function(){for(aH=x.length-1;aH>=0;aH--){for(aR=0;aR<aO.length;aR++){if(aO[aR].isEqual(x[aH])){x.splice(aH,1);al("onNoAnnotationSetLoaded",{path:x[aH]});break}}}}}})}if(aG.length){Q.getController().refreshGeometry({ids:aG,applicativeContainers:{V4V5_FDT:{errorCallBack:aQ,doneCallback:aQ}},onComplete:aS,onFailure:aV,onTimeout:aV})}if(ax.length){Q.getController().switchNodeVisuStreamOnDemand({data:ax,applicativeContainers:{V4V5_FDT:{errorCallBack:aQ,doneCallback:aQ}},callbacks:{onURLLoad:function(){},onComplete:aS,onFailure:aV,onTimeout:aV}})}}else{if(!aT){al("onNoAnnotationSetLoaded",{})}}};this.getDirectChildrenAnnotSets=function(ax){return N(ax)};this.setGlobalFTAVisibilityFlag=function(ay){var ax;if(typeof ay==="boolean"&&at>0){ah=ay;if(!ah){for(ax=0;ax<R.length;ax++){if(R[ax].getLastElement(true).isVisible()){aj.push(R[ax].clone());R[ax].getLastElement(true).setVisibility(false)}}}else{for(ax=0;ax<aj.length;ax++){aj[ax].getLastElement(true).setVisibility(true)}aj.length=0}Q.getViewer().render()}};var L=function(){var aC=Q.getRootBagPath().getChildrenPathes();var aG=[];var aA=d.getPreference("3DAnnotLoadARMPartsPref");for(var aF=0;aF<aC.length;aF++){var ax=d.getA3EWidgetAnnotSetsLoadedPref({path:aC[aF]});if(ax&&ax.length){aG=aG.concat(ax)}else{var ay=aC[aF].getLastElement(true);if(l.is3DLeaf(ay)){aG.push({path:aC[aF],visibility:true})}else{s.loadFTALightModel(aC[aF],true,false);if(aA){s.loadFTALightModel(aC[aF],true,false,[2])}if(l.isReference(aC[aF].getLastElement(true))&&l.getNodeType(aC[aF].getLastElement(true))!=="CATProduct"){var az=aC[aF].getChildrenPathes();for(var aD=0;aD<az.length;aD++){var aE=az[aD].getChildrenPathes();if(aE.length===1&&l.is3DLeaf(aE[0].getLastElement(true))){s.loadFTALightModel(aE[0],true,false)}}}}}}d.deleteA3EWidgetPref({pref:"A3EAnnotSetsLoaded"});for(var aB=0;aB<aG.length;aB++){s.loadFTALightModel(aG[aB].path,aG[aB].visibility,l.is3DLeaf(aG[aB].path.getLastElement(true)))}};var aw=function(az,ax){if(!az||!az.getAnnotationClassType||!ax){return}var aA;for(var ay=0;ay<R.length;ay++){if(R[ay].getLastElement(true)===az){aA=R[ay];break}}if(ax==="visibility"){al("onAnnotationVisibilityModified",{annotNode:az,path:aA})}};var Z=function(aC){if(aC.preference==="3DAnnotLoadARMPartsPref"&&aC.value===true){var aE=Q.getRootBagPath().getChildrenPathes();for(var ay=0;ay<aE.length;ay++){var ax=aE[ay].getLastElement(true);s.loadFTALightModel(aE[ay],true,false,[2]);if(l.getNodeType(ax)==="CATDrawing"||l.getNodeType(ax)==="CATAnalysis"){var aB=aE[ay].getChildrenPathes();for(var aA=0;aA<aB.length;aA++){var aD=aB[aA];var az;while(aD){az=aD.getLastElement(true);if(l.isReference(az)||l.is3DLeaf(az)||aD.getChildrenPathes().length!==1){break}aD=aD.getChildrenPathes()[0]}if(aD&&l.isReference(aD.getLastElement(true))){s.loadFTALightModel(aD,true,false,[2])}}}}Q.getViewer().render()}};var H=function(ax){ap=ap.concat(ax)};var C=function(aB){if(!aq){var ax=true;for(var ay=0;ay<ap.length;ay++){if(ap[ay].root===l.getNodeID(aB.path.getLastElement(true))){var aC=aB.path.clone();var aA=ap[ay].instances&&ap[ay].instances.length?ap[ay].instances:[ap[ay].origin];for(var az=0;az<aA.length;az++){aC=ai(aC,aA[az])}if(aC&&!aC.isEqual(aB.path)){s.loadFTALightModel(aC,true,false);ax=false}ap.splice(ay,1);break}}if(ax){am(aB.path)}}};var af=function(ay){var az=[];var ax;for(ax=R.length-1;ax>=0;ax--){if(ay.path.isAParentOf(R[ax])){az.push(R[ax].clone());R.splice(ax,1)}}K.length=0;for(ax=D.length-1;ax>=0;ax--){if(ay.path.isAParentOf(D[ax].path)){D.splice(ax,1)}}for(ax=ar.length-1;ax>=0;ax--){if(ay.path.isAParentOf(ar[ax].path)){ar.splice(ax,1)}}for(ax=aa.length-1;ax>=0;ax--){if(aa[ax].loadedData&&(ay.path.isAParentOf(aa[ax].loadedData.path)||ay.path.isEqual(aa[ax].loadedData.path))){al("onNoAnnotationSetLoaded",{path:aa[ax].loadedData.path,loadingAlreadyStarted:true});aa[ax].terminate();an(ax);ae()}}if(az.length){al("onAnnotationSetRemoved",{pathes:az})}};var r=function(ay){for(var ax=0;ax<y.length;ax++){if(y[ax].detached&&ay.path.isEqual(y[ax].path)){if(y[ax].hidden){y[ax].detached=false}else{y.splice(ax,1)}break}}al("onAnnotationParentVisibilityModified")};var G=function(az){var ax=false;for(var ay=0;ay<y.length;ay++){if(az.path.isEqual(y[ay].path)){y[ay].detached=true;ax=true;break}}if(!ax){y.push({path:az.path.clone(),hidden:false,detached:true})}al("onAnnotationParentVisibilityModified")};var ao=function(){ap.length=0};var ad=function(aA){for(var ay=0;ay<aA.paths.length;ay++){var ax=false;for(var az=0;az<y.length;az++){if(aA.paths[ay].isEqual(y[az].path)){y[az].hidden=true;ax=true;break}}if(!ax){y.push({path:aA.paths[ay].clone(),hidden:true,detached:false})}}al("onAnnotationParentVisibilityModified")};var p=function(az){for(var ax=0;ax<az.paths.length;ax++){for(var ay=0;ay<y.length;ay++){if(y[ay].hidden&&az.paths[ax].isEqual(y[ay].path)){if(y[ay].detached){y[ay].hidden=false}else{y.splice(ay,1)}}}}al("onAnnotationParentVisibilityModified")};var u=function(){aq=true;K.splice(0,K.length)};var o=function(){aq=false;if(T>0){T=1;ae()}t();an();var ay=Q.getRootBagPath().getChildrenPathes();for(var ax=0;ax<ay.length;ax++){am(ay[ax])}};var ai=function(aB,aC){var ay=aB.getLastElement(true);if(l.getNodeID(ay)===aC){return aB}var aA=aB.getChildrenPathes();for(var ax=0;ax<aA.length;ax++){var az=ai(aA[ax],aC);if(az){return az}}return undefined};var N=function(aD){var ax=[];var az;var aB=aD.getLastElement(true);if(l.is3DLeaf(aB)){for(az=0;az<R.length;az++){if(aD.isAParentOf(R[az])){ax.push(R[az].clone())}}}else{if(l.isReference(aB)){for(az=0;az<R.length;az++){var aE=X(R[az]);if(aE&&aD.isEqual(aE)){ax.push(R[az].clone())}}}else{if(l.getNodeType(aB)==="CATDrawing"||l.getNodeType(aB)==="CATAnalysis"){var aA=aD.getChildrenPathes();for(az=0;az<aA.length;az++){var aC=aA[az];var ay;while(aC){ay=aC.getLastElement(true);if(l.isReference(ay)||l.is3DLeaf(ay)||aC.getChildrenPathes().length!==1){break}aC=aC.getChildrenPathes()[0]}if(aC){if(l.isReference(aC.getLastElement(true))||l.is3DLeaf(aC.getLastElement(true))){ax=ax.concat(N(aC))}}}}}}return ax};var X=function(aB){var aA=aB.clone();var ay=Q.getRootBagPath();var ax=false;while(aA&&!aA.isEqual(ay)){var az=aA.getLastElement(true);if(l.is3DLeaf(az)){if(l.getNodeType(az)==="3DShape"){if(aA.getParentPath().isEqual(ay)){return aA}}else{if(l.getNodeType(az)==="CATPart"){if(aB.getLastElement(true).getContextType()!==2){return aA}}}}else{if(l.isReference(az)){if(aB.getLastElement(true).getContextType()===2){if(l.getNodeType(aA.getLastElement(true))==="CATProduct"||ax){return aA}ax=true}else{return aA}}}aA=aA.getParentPath()}return undefined};var am=function(ax){var az=ax.getLastElement(true);var aH=d.getA3EWidgetAnnotSetsLoadedPref({path:ax});if(aH&&aH.length){for(var aC=0;aC<aH.length;aC++){s.loadFTALightModel(aH[aC].path,aH[aC].visibility,l.is3DLeaf(ax.getLastElement(true)))}}else{if(l.is3DLeaf(az)){s.loadFTALightModel(ax,true,true)}else{if(l.isReference(az)){s.loadFTALightModel(ax,true,false);if(d.getPreference("3DAnnotLoadARMPartsPref")){s.loadFTALightModel(ax,true,false,[2])}if(l.isReference(ax.getLastElement(true))&&l.getNodeType(ax.getLastElement(true))!=="CATProduct"){var aG=ax.getChildrenPathes();for(var aB=0;aB<aG.length;aB++){var aE=aG[aB].getChildrenPathes();if(aE.length===1&&l.is3DLeaf(aE[0].getLastElement(true))){s.loadFTALightModel(aE[0],true,false)}}}}else{if(l.getNodeType(az)==="CATDrawing"||l.getNodeType(az)==="CATAnalysis"){var aA=ax.getChildrenPathes();for(var aD=0;aD<aA.length;aD++){var aF=aA[aD];var ay;while(aF){ay=aF.getLastElement(true);if(l.isReference(ay)||l.is3DLeaf(ay)||aF.getChildrenPathes().length!==1){break}aF=aF.getChildrenPathes()[0]}if(aF){if(l.isReference(aF.getLastElement(true))||l.is3DLeaf(aF.getLastElement(true))){am(aF)}}}}}}}};var q=function(ay,aD,aB){var aE=false;var aF;var ax=ay.getChildrenPathes();for(aF=0;aF<ax.length;aF++){var az=ax[aF].getLastElement(true);if(az.getAnnotationClassType&&az.getAnnotationClassType()==="tpsAnnotationSet"&&az.getContextType){ax[aF].getLastElement(true).setVisibility(aB);aE=true}}if(!aE){var aA=ay.getLastElement(true);if(l.getNodeID(aA)){var aG=true;if(!l.getNodeType(aA)||l.getNodeType(aA)!=="CATProduct"&&!l.is3DLeaf(aA)){aG=false}if(aG){for(var aC=0;aC<aD.length;aC++){if(aD[aC].getLastElement(true)===aA){aG=false;break}}}if(aG){aD.push(ay.clone())}}}if(ax&&ax.length){for(aF=0;aF<ax.length;aF++){q(ax[aF],aD,aB)}}};var an=function(aB){var ax=f.getWebappsBaseUrl();var aD=!j.matchUrl(ax,window.location)?"Passport":null;var aC={provider:"FILE",filename:"CAT3DAnnotationLoadWorker.js",serverurl:ax+"CAT3DAnnotationWorkers/",requiredAuth:aD};var ay={provider:"FILE",filename:"AmdLoader.js",serverurl:ax+"AmdLoader/",requiredAuth:aD};var az={provider:"FILE",filename:"ThreeJS_Base.js",serverurl:ax+"Mesh/",requiredAuth:aD};var aF={provider:"FILE",filename:"Mesh.js",serverurl:ax+"Mesh/",requiredAuth:aD};var aA={provider:"FILE",filename:"CGRFile.js",serverurl:ax+"Formats/",requiredAuth:aD};var aE={provider:"FILE",filename:"EasySax.js",serverurl:ax+"EasySax/",requiredAuth:aD};if(aB===undefined){aa.splice(0,aa.length)}c.getWorkerBlobFromSpecs([ay,az,aF,aA,aE,aC],function(aG){if(!aa){return}if(aB===undefined){for(var aH=0;aH<Y;aH++){var aI=new Worker(aG);aI.onmessage=M;aa.push(aI)}}else{aa[aB]=new Worker(aG);aa[aB].onmessage=M}})};var t=function(){for(var ax=0;ax<aa.length;ax++){aa[ax].terminate()}aa.splice(0,aa.length);ar.splice(0,ar.length);x.splice(0,x.length)};var ab=function(aA,ay,az,ax){if(!aA||!ay||!A||!at){return}A.getFTAContainer(ay,"V4V5_FDT",function(aB){if(aA&&aB&&aB.xml){W(aA,aB.xml,az,ax);return}al("onNoAnnotationSetLoaded",{path:aA})})};var W=function(aC,az,aB,ay,aD){if(aa.length!==Y){var ax=setInterval(function(){if(aa.length===Y){clearInterval(ax);W(aC,az,aB,ay,aD)}},50);return}for(var aA=0;aA<aa.length;aA++){if(!aa[aA].loadedData){al("onAnnotationSetBeginLoad",{path:aC});aa[aA].loadedData={annotationSets:{},path:aC.clone(),visibility:aB,xml:az,ctxTypes:ay};aa[aA].postMessage({xmlData:az,loadingIndex:aA,ctxTypes:ay});return}}ar.push({annotationSets:{},path:aC.clone(),visibility:aB,xml:az,ctxTypes:ay})};var ag=function(ay){if(s.getLoaderType()!=="visu"){if(ay.children.length!==12){return false}for(var ax=0;ax<ay.children.length;ax++){if(ay.children[ax].children.length!==0){return true}}return false}return true};var M=function(aO){var aH=aO.data.loadingIndex;var aA,aM,aE;if(aH===undefined){return}var aG=aa[aH].loadedData?aa[aH].loadedData.path:null;if(!aG){aa[aH].terminate();an(aH);return}if(aO.data.done===true){var aC=Object.keys(aa[aH].loadedData.annotationSets);if(aO.data.loadingCancelled===true){for(aA=0;aA<D.length;aA++){if(D[aA].path.isEqual(aG)&&l.is3DLeaf(D[aA].path.getLastElement(true))){D.splice(aA,1)}else{if(D[aA].path.isAParentOf(aG)&&D[aA].recursive){D[aA].recursive=false}}}for(aA=0;aA<aC.length;aA++){aM=aa[aH].loadedData.annotationSets[aC[aA]];aG.getLastElement(true).removeChild(aM);for(var aI=0;aI<aj.length;aI++){if(aj[aI].getLastElement(true)===aM){aj.splice(aI,1)}}}if(aO.data.error===true){al("onAnnotationSetLoadingFailed",{path:aG})}else{al("onNoAnnotationSetLoaded",{path:aG,loadingAlreadyStarted:true})}}else{var aJ=function(aQ){var aP=h.TesselatedTextRepsMissing;if(aQ[aF]["ds6w:label"]){aP+=aQ[aF]["ds6w:label"]+" / "}aP+=aM.getAnnotationName();al("onAnnotationSetPartiallyLoaded",{path:aE,message:aP})};var aK=function(){al("onAnnotationSetPartiallyLoaded",{path:aE,message:h.TesselatedTextRepsMissing+aM.getAnnotationName()})};for(aA=0;aA<aC.length;aA++){aM=aa[aH].loadedData.annotationSets[aC[aA]];v.postProcessViewsAndCaptures(aa[aH].loadedData.annotationSets[aC[aA]]);if(aO.data.loadingPartiallyFailed){if(!aa[aH].loadedData.hasFailedOnce&&aa[aH].loadedData.xml){aG.getLastElement(true).removeChild(aM);var aB=aa[aH].loadedData;aB.hasFailedOnce=true;var ay=j.loadXml(aB.xml);aB.xml=j.xmlToString(ay);ar.push(aB);console.warn("Error while loading annotations of : "+l.getNodeID(aG.getLastElement(true))+". FTA light model is converted and reloaded.")}else{aE=aG.clone();aE.addElement(aM);al("onAnnotationSetPartiallyLoaded",{path:aE})}}else{if(ag(aM)){aE=aG.clone();aE.addElement(aM);if(!aO.data.hasTesseletedTextReps){if(!l.getLoadedAssetType()){var aF=l.getNodeID(aG.getLastElement(true));Q.getController().getAttributes({ids:[aF],attributes:["ds6w:label"],callbacks:{onComplete:aJ,onFailure:aK}})}else{al("onAnnotationSetPartiallyLoaded",{path:aE,message:h.TesselatedTextRepsMissing+aM.getAnnotationName()})}}else{al("onAnnotationSetLoaded",{path:aE})}}else{aG.getLastElement(true).removeChild(aM);al("onNoAnnotationSetLoaded",{path:aG,loadingAlreadyStarted:true})}}}}if(ar.length){var az;for(aA=ar.length-1;aA>=0;aA--){if(ar[aA]&&!ar[aA].path){ar.splice(aA,1)}else{if(ar[aA]&&ar[aA].path){az=aA}}}aa[aH].loadedData={visibility:ar[az].visibility,path:ar[az].path.clone(),annotationSets:{},hasFailedOnce:ar[az].hasFailedOnce,xml:ar[az].xml};aa[aH].postMessage({xmlData:ar[az].xml,loadingIndex:aH,ctxTypes:ar[az].ctxTypes});ar.splice(az,1)}else{aa[aH].loadedData=null}}else{var aL=aO.data.node;if(aa[aH].loadedData.annotationSets[aO.data.annotSetID]){aM=aa[aH].loadedData.annotationSets[aO.data.annotSetID]}else{var aN=aa[aH].loadedData.visibility;var ax=false;if(aN&&!ah){aN=false;ax=true}aM=v.createAnnotationSet(aN,aw,aL);aG.getLastElement(true).addChild(aM);if(ax){var aD=aG.clone();aD.addElement(aM);aj.push(aD)}aa[aH].loadedData.annotationSets[aO.data.annotSetID]=aM}if(aL){v.loadAnnotation({nodeInfo:aL,annotationSetNode:aM,processText:aO.data.processText,cb:aw})}}Q.getViewer().render()};var al=function(aE,aB){var aC=aB?(aB.path?aB.path.clone():null):null;var ax;var aA=!l.getLoadedAssetType();if(aE==="onAnnotationSetBeginLoad"){I()}else{if(aE==="onAnnotationSetLoaded"||aE==="onAnnotationSetPartiallyLoaded"){J=true;var ay=aC.getLastElement(true);if(aA){d.saveA3EWidgetPref({path:aC.getParentPath(),pref:"A3EAnnotSetsLoaded",data:{visibility:ay.isVisible(),ctxType:ay.getContextType()}})}K.splice(0,K.length);var aD=aC.getParentPath();for(ax=x.length-1;ax>=0;ax--){if(aD.isEqual(x[ax])){x.splice(ax,1)}}if(x.length===0&&J){if(aE==="onAnnotationSetPartiallyLoaded"){b.displayNotification({eventID:"warning",msg:aB.message?aB.message:h.AnnotationSetPartiallyLoadedLbl})}else{b.displayNotification({eventID:"success",msg:h.AnnotationSetLoadedSuccessfullyLbl})}}R.push(aC.clone());ae()}else{if(aE==="onAnnotationSetRemoved"){if(!aq&&!O&&aA){if(aB.pathes&&aB.pathes.length){for(ax=0;ax<aB.pathes.length;ax++){d.removeA3EWidgetPref({path:aB.pathes[ax],pref:"A3EAnnotSetsLoaded"})}}}K.splice(0,K.length)}else{if(aE==="onAnnotationSetLoadingFailed"){for(ax=x.length-1;ax>=0;ax--){if(aC.isEqual(x[ax])){x.splice(ax,1)}}b.displayNotification({eventID:"error",msg:h.AnnotationSetLoadedFailedLbl});ae()}else{if(aE==="onNoAnnotationSetLoaded"){if(aC){for(ax=x.length-1;ax>=0;ax--){if(aC.isEqual(x[ax])){x.splice(ax,1)}}}if(x.length===0&&!J&&E.length===0){b.displayNotification({eventID:"info",msg:h.NoAnnotationSetLoadedLbl})}else{if(x.length===0&&J&&E.length===0){b.displayNotification({eventID:"success",msg:h.AnnotationSetLoadedSuccessfullyLbl})}}if(aB&&aB.loadingAlreadyStarted){ae()}}else{if(aE==="onAnnotationSetLoadingCanceled"){x.splice(0,x.length);av.splice(0,av.length);E.splice(0,E.length);b.displayNotification({eventID:"info",msg:h.AnnotationSetLoadedCanceledLbl});ae()}else{if(aE==="onAnnotationVisibilityModified"){if(aC){var az=aC.getLastElement(true);if(aA){d.removeA3EWidgetPref({path:aC,pref:"A3EAnnotSetsLoaded"});d.saveA3EWidgetPref({path:aC,pref:"A3EAnnotSetsLoaded",data:{visibility:az.isVisible(),ctxType:az.getContextType()}})}}}else{if(aE==="onAnnotationParentVisibilityModified"){K.length=0}}}}}}}}if(D){V.publish({event:aE,data:aB,context:s})}};var I=function(){if(ak){clearTimeout(ak);ak=null}ak=setTimeout(function(){T=1;ae()},20000);T++;if(T===1){i.on(h.LoadingAnnotationsLbl,function(){for(var ax=aa.length-1;ax>=0;ax--){if(aa[ax].loadedData){var aA=aa[ax].loadedData.path.getLastElement(true);var az=Object.keys(aa[ax].loadedData.annotationSets);var ay;for(ay=0;ay<az.length;ay++){aA.removeChild(aa[ax].loadedData.annotationSets[az[ay]])}for(ay=D.length-1;ay>=0;ay--){if(D[ay].path.isAParentOf(aa[ax].loadedData.path)||D[ay].path.isEqual(aa[ax].loadedData.path)){D.splice(ay,1)}}}}t();an();al("onAnnotationSetLoadingCanceled");Q.getViewer().render()})}};var ae=function(){if(ak){clearTimeout(ak);ak=null}T--;if(T<0){T=0;return}if(T===0){i.off()}}}});var g=[];var m=a.singleton({init:function(){},getAnnotationModelLoader:function(q){if(q&&q.context){var o=false;for(var p=0;p<g.length;p++){if(g[p].context===q.context){g[p].counter++;o=true;break}}if(!o){g.push({counter:1,context:q.context,modelLoader:new n({ctxViewer:q.context,favoriteCtxManager:q.favoriteCtxManager})})}return this.giveAnnotationModelLoader(q)}return undefined},giveAnnotationModelLoader:function(r){if(r&&r.context){var o,q;for(var p=0;p<g.length;p++){if(g[p].context===r.context){q=g[p];o=q.modelLoader;break}}if(o){return Object.freeze({setActiveState:function(s){if(o){o.setActiveState(s)}},getActiveState:function(){if(o){return o.getActiveState()}return undefined},setGlobalFTAVisibilityFlag:function(s){if(o){o.setGlobalFTAVisibilityFlag(s)}},loadFTALightModel:function(u,t,v,s){if(o){o.loadFTALightModel(u,t,v,s)}},hasAlreadyBeenLoaded:function(s,t){if(o&&q.counter>0){return o.hasAlreadyBeenLoaded(s,t)}return undefined},getLoadedAnnotationSets:function(){if(o){return o.getLoadedAnnotationSets()}return undefined},getDirectChildrenAnnotSets:function(s){if(o){return o.getDirectChildrenAnnotSets(s)}return undefined},isRunning:function(){if(o){return o.isRunning()}return undefined},setLoaderType:function(s){if(o){o.setLoaderType(s)}},getLoaderType:function(){if(o){return o.getLoaderType()}return undefined},subscribe:function(t,s){if(o){return o.subscribe(t,s)}return undefined},unsubscribe:function(s){if(o){o.unsubscribe(s)}}})}}return undefined},unreferenceAnnotationModelLoader:function(p){if(p&&p.context){for(var o=0;o<g.length;o++){if(g[o].context===p.context){g[o].counter--;if(g[o].counter<=0){if(g[o].modelLoader){g[o].modelLoader.clear()}g.splice(o,1)}return}}}}});return m});define("DS/CAT3DAnnotationController/CAT3DAnnotBaseControllerInstance",["UWA/Core","UWA/Class","DS/Visualization/ThreeJS_DS","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Visualization/SceneGraphUtils","DS/CATWebUXComponents/CATWebUXInfoFlag","DS/SceneGraphNodes/PolyLineSectionUtils","DS/CoreEvents/ModelEvents","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/CATWebUXSlideShow/CATWebUXSlideShowController","DS/Visualization/Viewpoint","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADUtilsServices","DS/WAFData/WAFData","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/CoreEvents/Events","DS/ApplicationFrame/CommandsManager","DS/CATWebUXTooltipManager/CATWebUXTooltipManager","DS/CAT3DAnnotationBaseUI/CAT3DAnnotationAttrDiv","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils"],function(d,t,x,v,k,r,s,u,l,n,c,f,i,m,g,j,b,p,o,a,w,q,h){var e=t.extend({init:function(af){var Q=af||{};this._parent(Q);var N=Q.ctxViewer;var B=this;var ax=false;var U;var ac=new n();var E;var ar;var ay=[];var aa={};var at=null;var J;var F=new x.MeshPhongMaterial({color:"#436655"});var X;var A;var C=0;var am,S;var Y,az;var ad,Z;var aA;var W;function D(){if(!aA){aA=i.getSlideShowController({context:N.getFrameWindow(),id:"CAT3DAnnotationSlideShow"});var aH={},aC,aE=[],aG=[];var aD=function(aK,aJ){var aI=aG[aJ-1].label;B.displayViewOrCapture({path:aK,data:{label:aI,icon:aG[aJ-1].icon.replace("icons/22/","icons/32/")}});aA.displaySlideInformation({message:aI+(aJ!==undefined?(" ("+aJ+" / "+aE.length+") "):"")})};var aB=function(aI,aL){if(aL&&aL.length&&aL[aI[0]]){if(aL[aI[0]].children&&aL[aI[0]].children[aI[1]]){if(aL[aI[0]].children[aI[1]].path){var aJ=aL[aI[0]].children[aI[1]].path.getChildrenPathes();if(aJ&&aJ.length&&aJ[aI[2]]){var aK=aJ[aI[2]].getChildrenPathes();if(aK&&aK.length&&aK[aI[3]]){return aK[aI[3]]}}}}}return undefined};var aF=function(aK,aR){var aV=0;var aS=[];var aO,aW;for(aV=0;aV<aK.children.length;aV++){if(aK.children[aV].type==="RootViews"){aO=aV}else{if(aK.children[aV].type==="RootCaptures"){aW=aV}}}if(aC&&aK.children[aW].children.length){for(aV=0;aV<aK.children[aW].children.length;aV++){aS.push([aR[0],aR[1],aW,aV]);aG.push({label:aK.children[aW].children[aV].name,icon:aK.children[aW].children[aV].icon})}}else{if(!aC){for(aV=0;aV<aK.children[aO].children.length;aV++){var aP=aK.children[aO].children[aV];if(aP.isSubView){continue}var aT=[aR[0],aR[1],aO,aV];var aQ=aP.name,aN=aP.icon;var aI=aP.associatedCapture;if(aI&&aI.length){aT=[aR[0],aR[1],aW,aI[0]-1]}aS.push(aT);aG.push({label:aQ,icon:aN});var aM=0;if(aI.length>1){for(aM=1;aM<aI.length;aM++){aS.push([aR[0],aR[1],aW,aI[aM]-1]);aG.push({label:aK.children[aW].children[aI[aM]-1].name,icon:aK.children[aW].children[aI[aM]-1].icon})}}if(aP.isMultiSectionView){for(aM=0;aM<aP.multiSectionData.views.length;aM++){var aX=aK.children[aO].children[aP.multiSectionData.views[aM]-1];if(!aX.isSubView){continue}var aL=aX.associatedCapture;if(!aL||(aL&&!aL.length)){continue}for(var aJ=0;aJ<aL.length;aJ++){aS.push([aR[0],aR[1],aW,aL[aJ]-1]);aG.push({label:aK.children[aW].children[aL[aJ]-1].name,icon:aK.children[aW].children[aL[aJ]-1].icon})}}}}for(aV=0;aV<aK.children[aW].children.length;aV++){var aU=aK.children[aW].children[aV];if(!aU.pointedView){aS.push([aR[0],aR[1],aW,aV]);aG.push({label:aU.name,icon:aU.icon})}}}}return aS};aH.onPreviousSlideCB=aA.subscribe("onPreviousSlideCB",function(){for(var aI=0;aI<aE.length;aI++){if(aE[aI].isEqual(K())){if(aI>0){aD(aE[aI-1],aI)}else{aD(aE[aE.length-1],aE.length)}return}}aD(aE[aE.length-1],aE.length)});aH.onNextSlideCB=aA.subscribe("onNextSlideCB",function(){for(var aI=0;aI<aE.length;aI++){if(aE[aI].isEqual(K())){if(aI<aE.length-1){aD(aE[aI+1],aI+2)}else{aD(aE[0],1)}return}}aD(aE[0],1)});aH.onFirstSlideCB=aA.subscribe("onFirstSlideCB",function(){aD(aE[0],1)});aH.onLastSlideCB=aA.subscribe("onLastSlideCB",function(){aD(aE[aE.length-1],aE.length)});aH.onActiveStateModified=aA.subscribe("onActiveStateModified",function(aJ){var aI=0;if(aJ.state){B._getJSONModel(function(aQ){aE=[];for(aI=0;aI<aQ.length;aI++){if(aQ[aI].children){for(var aO=0;aO<aQ[aI].children.length;aO++){var aN=aQ[aI].children[aO];if(aN.isVisible){var aK=aF(aN,[aI,aO]);if(aK.length){for(var aP=0;aP<aK.length;aP++){aE.push(aB(aK[aP],aQ))}aL+=aK.length}}}}}aJ.onBeginSlideShow(aE.length>0);if(!aE.length){return}B._disableAnnotUI();aC=f.getPreference("3DAnnotDisplayCapturesPref");var aL=0;var aM=K();if(aM){for(aI=0;aI<aE.length;aI++){if(aM.isEqual(aE[aI])){aD(aM,aI+1)}}}else{aD(aE[0],1)}})}else{B._enableAnnotUI()}B._publish("onSlideShowActiveStateModified",{state:aJ.state})})}}this.setActiveState=function(aC){ax=aC;U=c.giveAnnotationModelLoader({context:N});if(aC&&!U){var aB=setInterval(function(){U=c.giveAnnotationModelLoader({context:N});if(U){clearInterval(aB);B.setActiveState(ax)}},10);return}D();if(ax&&!ar){ar={};ad={activated:N.getViewer().picking.activated,primitive:N.getViewer().picking.primitive,trapSelectionMesh:N.getViewer().picking.trapSelectionMesh,trapSelection:N.getViewer().picking.trapSelection};Z={activated:N.getViewer().pPicking.activated,primitive:N.getViewer().pPicking.primitive,trapSelectionMesh:N.getViewer().pPicking.trapSelectionMesh,trapSelection:N.getViewer().pPicking.trapSelection};N.getViewer().setPicking({activated:true,primitive:1,trapSelectionMesh:true,trapSelection:true});N.getViewer().setPrePicking({activated:true,primitive:1,trapSelectionMesh:true,trapSelection:true});az=w.getTooltipManager({context:N});Y=az.register({onTooltipReady:ah,filterPath:aj});ar.onAnnotationSetLoaded=U.subscribe("onAnnotationSetLoaded",function(aD){if(aA&&aA.getActiveState()){aA.setActiveState(false)}V(aD.path)});ar.onAnnotationSetPartiallyLoaded=U.subscribe("onAnnotationSetPartiallyLoaded",function(){if(aA&&aA.getActiveState()){aA.setActiveState(false)}});ar.onAnnotationSetRemoved=U.subscribe("onAnnotationSetRemoved",function(){if(aA&&aA.getActiveState()){aA.setActiveState(false)}ab()});ar.cmdsManager=a.onCommandStart(B._onCommandStartCB,N.getCommandContext&&N.getCommandContext()?N.getCommandContext():undefined)}else{if(!ax&&ar){if(N.getViewer()){N.getViewer().setPicking({primitive:ad.primitive,trapSelectionMesh:ad.trapSelectionMesh,trapSelection:ad.trapSelection,activated:ad.activated});N.getViewer().setPrePicking({primitive:Z.primitive,activated:Z.activated,trapSelectionMesh:Z.trapSelectionMesh,trapSelection:Z.trapSelection})}i.unreferenceSlideShowController({context:N.getFrameWindow(),id:"CAT3DAnnotationSlideShow"});aA=null;az.unregister(Y);w.unreferenceTooltipManager({context:N});ab();if(X){X.clean();X=null}if(U&&ar.onAnnotationSetLoaded){U.unsubscribe(ar.onAnnotationSetLoaded)}if(U&&ar.onAnnotationSetRemoved){U.unsubscribe(ar.onAnnotationSetRemoved)}if(U&&ar.onAnnotationVisibilityModified){U.unsubscribe(ar.onAnnotationVisibilityModified)}if(ar.cmdsManager){o.unsubscribe(ar.cmdsManager)}ar=null;ay.splice(0,ay.length)}}B._publish("onAnnotControllerActiveStateChanged",{state:ax})};this.clearController=function(){B.setActiveState(false);N=B=U=ac=E=F=X=A=null;ay=aa=null};this.onAdditionalInfosRequired=function(aB){if(aB.controller==="AnnotBrowser"){require(["DS/CAT3DAnnotationBaseCmds/controllers/CAT3DAnnotationBrowserController"],function(aD){var aC=aD.give3DAnnotBrowserController({context:N});if(aC&&aC.setDataModelMethods){aC.setDataModelMethods(B._getJSONModel,an,ag,O,au,G)}aB.cb()})}else{if(aB.controller==="AnnotScenario"){aB.cb({func:B._getSelectedAnnotationsVisibilityFlag})}else{if(aB&&aB.cb){B._getJSONModel(aB.cb)}}}};this.getAnnotControllerPrototype=function(){var aB={getAnnotationControllerType:function(){if(B){return B.getAnnotationControllerType()}return undefined},onAdditionalInfosRequired:function(aC){if(B){B.onAdditionalInfosRequired(aC)}},setActiveState:function(aC){if(B){B.setActiveState(aC)}},getActiveState:function(){if(B){return B.getActiveState()}return undefined},getFTAViewOrCaptureDisplayInfos:function(aC){if(B){return al(aC)}return undefined},displayFTAViewOrCapture:function(aC){if(B){B.displayViewOrCapture(aC)}},removeFilteringAndClipping:function(){ab()},subscribe:function(aC,aD){if(B){return B.subscribe(aC,aD)}return undefined},unsubscribe:function(aC){if(B){B.unsubscribe(aC)}}};return aB};this.getActiveState=function(){return ax};this.getAnnotationControllerType=function(){return"3DAnnotationBaseServices"};this.subscribe=function(aC,aB){return ac&&aC&&aB?ac.subscribe({event:aC},aB):undefined};this.unsubscribe=function(aB){if(ac&&aB){ac.unsubscribe(aB)}};var al=function(aJ){if(!aJ||(aJ&&!aJ.path&&!aJ.uuid)||!ax||(aJ&&!aJ.cb)){if(aJ.cb){aJ.cb()}return}var aO=aJ.path;if(!aO&&aJ.uuid){var aF=U.getLoadedAnnotationSets();for(var aM=0;aM<aF.length;aM++){var aN=aF[aM].getChildrenPathes();for(var aG=0;aG<aN.length;aG++){if(aN[aG].getLastElement(true).getAnnotationType()==="RootViews"||aN[aG].getLastElement(true).getAnnotationType()==="RootCaptures"){var aE=aN[aG].getChildrenPathes();for(var aB=0;aB<aE.length;aB++){if(aE[aB].getLastElement(true).getAnnotationUuid()===aJ.uuid){aO=aE[aB];break}}if(aO){break}}}if(aO){break}}}if(!aO){if(aJ.cb){aJ.cb()}return}var aH={path:aO};var aD=aO.getLastElement(true);if(!aD.getAnnotationClassType||(aD&&aD.getAnnotationClassType()!=="tpsView"&&aD.getAnnotationClassType()!=="tpsCapture")){if(aJ.cb){aJ.cb(aH)}return}var aL=aO.getParentPath().getParentPath();var aK=aq(aO);if(aK&&(aD.getAnnotationClassType()==="tpsView"||(aD.getAnnotationClassType()==="tpsCapture"&&aD.isSectionPlaneActivated()))){aH.clippingInfos=ap(aK)}aH.visibleAnnotations=[aO,aL];aH.visibleAnnotations=aH.visibleAnnotations.concat(aD.getVisibleAnnotations(aL,true));if(aD.getVisibleBodiesInst){var aI=M(aD.getVisibleBodiesInst(),aL.getParentPath());if(aI&&aI.length){aH.visibleBodies=aI}}if(aD.getHiddenBodiesInst){var aC=M(aD.getHiddenBodiesInst(),aL.getParentPath());if(aC&&aC.length){aH.hiddenBodies=aC}}aH.reframeInfos=z(aO);ao(aO,function(aP){if(aP&&aP.hiddenPaths&&aP.hiddenPaths.length){aH.hiddenAssyComponents=aP.hiddenPaths}if(aP&&aP.visiblePaths&&aP.visiblePaths.length){aH.visibleAssyComponents=aP.visiblePaths}aJ.cb(aH)})};this.getAssociatedInformations=function(aQ,aP){var aE=[];if(!aQ||!aQ.length||!B.getActiveState()){return aE}var aB=null;if(aP&&aP.getAttributeTypesFiltered){aB=aP.getAttributeTypesFiltered()}var aF=f.getPreference("3DAnnotAttributesOrderedList");var aN=function(aZ){var a0=false,a1={};if((aB&&aB.indexOf("3DAnnotations")===-1)||aB===null){var aY=aZ.getAnnotationHyperlinkData?aZ.getAnnotationHyperlinkData():null;if(aY){if(aY.hyperlinksAndComments){a1.hyperlinksAndComments=aY.hyperlinksAndComments;a0=true}if(aY.relatedDocs&&aY.relatedDocs.length){a1.relatedDocs=aY.relatedDocs;a0=true}if(aY.requirements&&aY.requirements.length){a1.requirements=aY.requirements;a0=true}if(aY.failureModes&&aY.failureModes.length){a1.failureModes=aY.failureModes;a0=true}}}return a0?a1:null};var aK,aS;for(aK=0;aK<aQ.length;aK++){var aT=aQ[aK].getLastElement(true);if(aT.getAnnotationClassType){var aO=aT.getAnnotationClassType()==="tpsAnnotationSet"?-1:aT.getAnnotationID();if(aO){var aV={id:aO,type:aT.getAnnotationType(),name:aT.getAnnotationName(),icon:aT.getAnnotationIcon(),infos:{}};for(aS=0;aS<aF.length;aS++){aV.infos[aF[aS]]=null}var aJ=false;if(aT.getAnnotationClassType()==="tpsAttribute"){if((aB&&aB.indexOf(aT.getAttributeCategory())===-1)||aB===null){var aH=aT.getAttributeParam();if(!aH){continue}aV.infos[aT.getAttributeCategory()]=aH;aJ=true}}else{if((aB&&aB.indexOf("3DAnnotations")===-1)||aB===null){var aR;var aC=aT.getTabulatedLimit?aT.getTabulatedLimit():null;var aD=aT.getAnnotationDimensionLimits?aT.getAnnotationDimensionLimits():null;if(aC&&aD){aR={tabulatedLimit:aC,toleranceLimits:aD}}var aX=aT.getGeneralTolerance?aT.getGeneralTolerance():null;if(aX){if(!aR){aR={}}aR.generalTol=aX}if(aR){aV.infos.tolerances=aR;aJ=true}}}var aW=aN(aT);if(aW){d.extend(aV.infos,aW);aJ=true}if(aJ){var aM=Object.keys(aV.infos);for(aS=aM.length-1;aS>=0;aS--){if(!aV.infos[aM[aS]]){delete aV.infos[aM[aS]]}}aE.push(aV)}}}else{if(typeof B.getPontingAnnotations==="function"){var aL=B.getPontingAnnotations(aQ[aK],true);if(aL&&aL.length){for(aS=0;aS<aL.length;aS++){var aG=aL[aS].getLastElement(true);if(aG.getAnnotationClassType()==="tpsAttribute"){if((aB&&aB.indexOf(aG.getAttributeCategory())===-1)||aB===null){var aI=aG.getAttributeParam();if(!aI){continue}var aU={};aU[aG.getAttributeCategory()]=aI;aE.push({name:aG.getAnnotationName(),icon:aG.getAnnotationIcon(),infos:aU})}}}}}}}return aE};var aj=function(aC){var aB=aC;while(aB.getLastElement(true).getPickParent()){aB=aB.getParentPath()}return aB};var ah=function(aD){if(!aD||!aD.completed){return}if(!aD.arrayPath||aD.arrayPath.length!==1||!aD.token){aD.completed();return}if(!E){E=new q();N.getFrameWindow().getUIFrame().appendChild(E.getContent())}var aC=B.getAssociatedInformations(aD.arrayPath);var aF;var aE=false;if(aC&&aC.length){E.setTouchDisplay(aD.fromTouchEvt);aF=E.build(aC,false,B.onAttributeClicked);for(var aI=0;aI<aC.length;aI++){var aG=aC[aI].infos;if(aG.hyperlinksAndComments&&aG.hyperlinksAndComments.urls&&aG.hyperlinksAndComments.urls.length||aG.relatedDocs&&aG.relatedDocs.length||aG.requirementsSpec&&aG.requirementsSpec.length||aG.requirements&&aG.requirements.length){aE=true;break}}if(aF){var aH=50;aF.setStyles({"max-width":"300px",width:""});var aJ=d.createElement("div");aJ.setStyles({opacity:"0",position:"absolute",left:"-400px"});N.getFrameWindow().getUIFrame().appendChild(aJ);aJ.appendChild(aF);var aB=setInterval(function(){if(E.getContainerHeight()){N.getFrameWindow().getUIFrame().removeChild(aJ);aJ=undefined;clearInterval(aB);var aK=aF;if(E.areAllInformationVisible({maxHeight:aH})){aE=true;aK=E.buildDivWithDots({maxHeight:aH,callback:function(){r.empty();var aM=a.getCommandCheckHeader("CAT3DAnnotSemanticAttrBrowserHdr",N.getCommandContext?N.getCommandContext():null);if(aM&&aM.getState()){w.getTooltipManager({context:N}).destroyTooltip()}else{E.expand()}var aN=[];for(var aL=0;aL<aD.arrayPath.length;aL++){aN.push({pathElement:aD.arrayPath[aL]})}v.empty();k.empty();v.add(aN);k.add(aN)}})}aD.completed({token:aD.token,div:aK,interactiveContent:aE})}},10);return}}aD.completed({token:aD.token,div:aF,interactiveContent:aE})};var G=function(){return aa};this.displayViewOrCapture=function(aC){if(!aC||!ax){return}C++;var aB=C;ab();al({path:aC.path,uuid:aC.uuid,cb:function(aI){if(!aI||(aI&&!aI.path)){return}A=aI.path.clone();var aG=aI.path.getLastElement(true),aD,aF;if(!aG||!aG.getAnnotationClassType||(aG&&aG.getAnnotationClassType()!=="tpsCapture"&&aG.getAnnotationClassType()!=="tpsView")){return}if(C===aB){var aE=aI.path.getParentPath().getParentPath().getChildrenPathes();for(aD=0;aD<aE.length;aD++){var aH=aE[aD].getChildrenPathes();for(aF=0;aF<aH.length;aF++){aH[aF].getLastElement(true).setVisibility(false)}}if(aI.visibleAnnotations){for(aD=0;aD<aI.visibleAnnotations.length;aD++){aI.visibleAnnotations[aD].getLastElement(true).setVisibility(true)}}if((aI.hiddenBodies&&aI.hiddenBodies.length)||(aI.visibleBodies&&aI.visibleBodies.length)){if(aI.visibleBodies&&aI.visibleBodies.length){aa.visibleBodies=[];for(aD=0;aD<aI.visibleBodies.length;aD++){if(s.getVisibilityFromPath&&!s.getVisibilityFromPath(aI.visibleBodies[aD])){aa.visibleBodies.push(aI.visibleBodies[aD]);s.applyVisibilityToPath(aI.visibleBodies[aD],1)}}}if(aI.hiddenBodies&&aI.hiddenBodies.length){aa.hiddenBodies=[];for(aD=0;aD<aI.hiddenBodies.length;aD++){if((s.getVisibilityFromPath&&s.getVisibilityFromPath(aI.hiddenBodies[aD]))||!s.getVisibilityFromPath){aa.hiddenBodies.push(aI.hiddenBodies[aD]);s.applyVisibilityToPath(aI.hiddenBodies[aD],0)}}}}if(aI.hiddenAssyComponents||aI.visibleAssyComponents){ai(aI.hiddenAssyComponents,aI.visibleAssyComponents)}if(aI.clippingInfos){J=aI.clippingInfos;an(J)}N.getViewer().render();au(N.getViewer().currentViewpoint,aI.reframeInfos);T(aC.data&&aC.data.label?aC.data.label:aG.getAnnotationName(),aC.data&&aC.data.icon?aC.data.icon:aG.getAnnotationIcon().replace("icons/22/","icons/32/"));aG.setDisplayFlag(true);if(aC.cb){aC.cb(aI)}B._publish("onViewOrCaptureDisplayed",aI)}}})};function K(){return A}var an=function(aF){if(aF&&aF.path){if(!aF.multiClipping){N.getViewer().addClippingPlane(aF.data,F)}y(aF.rootPath,aF,true);var aB=aF.path.getLastElement(true).getCappingRep?aF.path.getLastElement(true).getCappingRep():null;if(aB){var aD=aF.path.getParentPath().getParentPath().getParentPath();if(!aF.multiClipping){var aC=aF.data.normal.clone().normalize().negate().multiplyScalar(0.01);var aE=new x.Matrix4().makeTranslation(aC.x,aC.y,aC.z);aB.setMatrix(aE)}aD.getLastElement(true).addChild(aB)}N.getViewer().setSectionCapping(true)}};var O=function(){if(J&&J.path){return{multiClipping:J.multiClipping,rootPath:J.rootPath.clone(),path:J.path.clone(),data:J.data}}return undefined};var ag=function(aC){if(aC&&aC.path&&N.getViewer()){if(!aC.multiClipping){N.getViewer().removeClippingPlane(aC.data)}y(aC.rootPath,aC,false);var aB=aC.path.getLastElement(true).getCappingRep?aC.path.getLastElement(true).getCappingRep():null;if(aB){aC.path.getParentPath().getParentPath().getParentPath().getLastElement(true).removeChild(aB)}N.getViewer().setSectionCapping(false)}};var I=function(aC,aI){if(!(aC instanceof Array)||!aI||!ax){return}var aE=[],aD,aB=[];if(h.getLoadedAssetType()==="3DXML"){for(aD=0;aD<aC.length;aD++){var aG=h.getNodeInfos(aC[aD]);aB.push({id:h.getNodeID(aC[aD]),label:aG.name,icon:aG.icon})}aI(aB)}else{for(aD=0;aD<aC.length;aD++){if(h.getNodeID(aC[aD])){aE.push(h.getNodeID(aC[aD]))}}var aH=aE.slice(0);for(aD=aH.length-1;aD>=0;aD--){for(var aF=0;aF<ay.length;aF++){if(ay[aF].id===aH[aD]){aB.push({id:ay[aF].id,label:ay[aF].label,icon:ay[aF].icon});aH.splice(aD,1);break}}}if(aH.length){N.getController().getAttributes({ids:aE,attributes:["ds6w:label","type_icon_url"],callbacks:{onComplete:function(aM){if(!ax){return}var aN=function(aP){for(var aO=0;aO<ay.length;aO++){if(ay[aO].id===aP.id){return}}ay.push(aP)};var aJ=[];for(var aK=0;aK<aE.length;aK++){var aL={id:aE[aK],label:aM[aE[aK]]?aM[aE[aK]]["ds6w:label"]:"",icon:aM[aE[aK]]?aM[aE[aK]].type_icon_url:undefined};aJ.push(aL);aN(aL)}aI(aJ)},onFailure:function(){if(!ax){return}var aJ=[];for(var aK=0;aK<aE.length;aK++){aJ.push({id:aE[aK],label:"",icon:""})}aI(aJ)}}})}else{aI(aB)}}};this._disableAnnotUI=function(){S=true;W=N.isDefaultContextualMenuVisible();if(W){N.setDefaultContextualMenuVisibility(false)}if(X){X.setVisibleFlag(false)}am=null;require(["DS/CAT3DAnnotationBaseCmds/controllers/CAT3DAnnotationBrowserController"],function(aC){var aB=aC.give3DAnnotBrowserController({context:N});if(aB&&aB.getActiveState()){am=aB.getPanelVisibilityFlag();aB.setPanelVisibilityFlag(false)}})};this._enableAnnotUI=function(){S=false;if(W!==undefined){N.setDefaultContextualMenuVisibility(W)}W=undefined;if(X){X.setVisibleFlag(true)}if(am!==null){require(["DS/CAT3DAnnotationBaseCmds/controllers/CAT3DAnnotationBrowserController"],function(aC){var aB=aC.give3DAnnotBrowserController({context:N});if(aB){aB.setPanelVisibilityFlag(am)}})}};this._getJSONModel=function(aH){if(!U){return}var aC=U.getLoadedAnnotationSets();var aB=[],aK;for(aK=0;aK<aC.length;aK++){var aL=R(N.getRootBagPath(),aC[aK]);var aF=aC[aK].getParentPath().getLastElement(true);if(aB.indexOf(aF)===-1){aB.push(aF)}var aJ=aC[aK].getLastElement(true).getContextType();var aE;if(aJ!==1&&aJ!==3){aE=aJ===2?aC[aK].getParentPath().getParentPath():aC[aK].getParentPath();aF=aE.getLastElement(true);if(!aE.isEqual(aL)){while(aE){if(h.isReference(aE.getLastElement(true))){aF=aE.getLastElement(true);break}aE=aE.getParentPath()}}if(aB.indexOf(aF)===-1){aB.push(aF)}}aE=aC[aK].getParentPath();while(aE){if(h.isInstance(aE.getLastElement(true))||aE.isEqual(aL.getParentPath())){if(!aE.isEqual(aL.getParentPath())){if(aB.indexOf(aE.getLastElement(true))===-1){aB.push(aE.getLastElement(true))}}break}aE=aE.getParentPath()}}var aD=N.getRootBagPath().getChildrenPathes();var aI=N.getHideShowController();for(aK=0;aK<aD.length;aK++){if(aI.isVisible(aD[aK])){var aG=U.hasAlreadyBeenLoaded(aD[aK]);if(aG===0||aG===1||aG===3||aG===4||aG===5||aG===6){if(aB.indexOf(aD[aK].getLastElement(true))===-1){aB.push(aD[aK].getLastElement(true))}}}}I(aB,function(a5){if(!B.getActiveState()){aH();return}var aS=U.getLoadedAnnotationSets();var aO=N.getRootBagPath().getChildrenPathes();var a1=[];var aN=[];var aU,a0,aM;for(a0=0;a0<aO.length;a0++){var aW=aO[a0].getLastElement(true);for(aU=0;aU<a5.length;aU++){if(h.getNodeID(aW)===a5[aU].id&&aN.indexOf(aO[a0])===-1){a1.push({id:h.getNodeID(aW),path:aO[a0].clone(),name:a5[aU].label,icon:a5[aU].icon,type:h.getNodeType(aW),children:[]});aN.push(aO[a0]);break}}}for(a0=0;a0<aS.length;a0++){var aY=R(N.getRootBagPath(),aS[a0]);var aX=aS[a0].getParentPath().getLastElement(true);for(aU=0;aU<a5.length;aU++){if(h.getNodeID(aX)===a5[aU].id){var aV=a5[aU].label;var a3=aS[a0].getParentPath();while(a3){if(h.isInstance(a3.getLastElement(true))||a3.isEqual(aY.getParentPath())){if(!a3.isEqual(aY.getParentPath())){for(aM=0;aM<a5.length;aM++){if(a5[aM].id===h.getNodeID(a3.getLastElement(true))&&a5[aM].label){aV+=" ("+a5[aM].label+")"}}}break}a3=a3.getParentPath()}var a2=a5[aU].icon;var aZ=aS[a0].getLastElement(true).getContextType();if(aZ!==1&&aZ!==3){var aP=aZ===2?aS[a0].getParentPath().getParentPath():aS[a0].getParentPath();aF=aP.getLastElement(true);if(!aP.isEqual(aY)){while(aP){if(h.isReference(aP.getLastElement(true))){break}aP=aP.getParentPath()}}if(aP){for(aM=0;aM<a5.length;aM++){if(a5[aM].id===h.getNodeID(aP.getLastElement(true))&&a5[aM].icon){a2=a5[aM].icon}}}}for(aM=0;aM<a1.length;aM++){if(a1[aM].path.isAParentOf(aS[a0])){var a4=false;var aR=U.getDirectChildrenAnnotSets(a1[aM].path);for(var aT=0;aT<aR.length;aT++){if(aR[aT].isEqual(aS[a0])){a4=true}}var aQ=JSON.parse(JSON.stringify(aS[a0].getLastElement(true).toJSON()));aQ.id=aS[a0].getLastElement(true).id;aQ.path=aS[a0].clone();aQ.referenceLabel=aV;aQ.referenceIcon=a2;aQ.isDirectChild=a4;aQ.isLeafChild=h.is3DLeaf(aX);a1[aM].children.push(aQ);break}}break}}}aH(a1)})};this._getSelectedAnnotationsVisibilityFlag=function(){var aN="notAssigned";var aB=localStorage.getItem("3DAnnotLoadARMPartsPref")==="true";var aL=v.get(),aP,aF;for(aP=0;aP<aL.length;aP++){var aQ=aL[aP].pathElement;if(aQ.internalPath.length){while(aQ.internalPath.length){aQ=aQ.getParentPath()}while(!h.isPLMNode(aQ.getLastElement(true))&&!aQ.getLastElement(true).getAnnotationClassType){aQ=aQ.getParentPath()}}var aD=aQ.getLastElement(true);if(aD.getAnnotationClassType){if(aN==="notAssigned"||aN===null){aN=aD.isVisible()}else{if(aN!==aD.isVisible()){return undefined}}}else{if(h.is3DLeaf(aD)){var aE=false;var aM=H(aQ);if(aM){aE=true;aN=aM.getLastElement(true).isVisible()}if(!aE){if(!aQ){if(aN==="notAssigned"){aN=null}continue}var aK=U.hasAlreadyBeenLoaded(aQ);if(aK===1||aK===4){var aJ=U.getLoadedAnnotationSets(aQ);for(aF=0;aF<aJ.length;aF++){if(aN==="notAssigned"||aN===null){aN=aJ[aF].getLastElement().isVisible()}else{if(aN!==aJ[aF].getLastElement().isVisible()){return undefined}}}}else{if(aK===2||aK===5){if(aN==="notAssigned"){aN=null}}else{if(aK===0){if(aN==="notAssigned"||aN===null){aN=false}else{if(aN){return undefined}}}}}}}else{var aI=null;var aO=U.getDirectChildrenAnnotSets(aL[aP].pathElement);if(h.getNodeType(aD)==="CATProduct"){if(aB){aI=U.hasAlreadyBeenLoaded(aL[aP].pathElement,true)}for(aF=0;aF<aO.length;aF++){if(aO[aF].getLastElement(true).getContextType()===2||aO[aF].getParentPath().isEqual(aL[aP].pathElement)){var aH=aO[aF].getLastElement(true).isVisible();if(aI===null){aI=aH}else{if(aI!==aH){aI=undefined;break}}}}}else{for(aF=0;aF<aO.length;aF++){var aC=aO[aF].getLastElement(true).isVisible();if(aI===null){aI=aC}else{if(aI!==aC){aI=undefined;break}}}}if(aI===undefined||(aI!==null&&aN!=="notAssigned"&&aN!==aI)){return undefined}else{if(aI!==null&&aN==="notAssigned"){aN=aI}else{if(aI===null){var aG=U.hasAlreadyBeenLoaded(aL[aP].pathElement);if(aG===2||aG===5){aN=null}else{aN=false}}}}}}}return aN};this._onCommandStartCB=function(aB){if(aB._id==="SwitchVisuOnDemandHdr"){ab()}};var z=function(aD){var aP;var aG=N.getViewer().currentViewpoint.camera.fov;var aE=aD.getLastElement(true);var aF=P(aD);var aC=new x.Matrix4().extractRotation(aF);if(aE.getCaptureCamera&&aE.getCaptureCamera()){aP={};var aK=aE.getCaptureCamera();var aH=new x.Vector3().copy(aK.position);aH.applyMatrix4(aF);aP.target=new x.Vector3().copy(aK.target);aP.target.applyMatrix4(aF);aP.sight=new x.Vector3().copy(aK.direction).normalize();aP.sight.applyMatrix4(aC);aP.up=new x.Vector3().copy(aK.zenith).normalize();aP.up.applyMatrix4(aC).normalize();var aO=aK.zoom;if(aO===0||isNaN(aO)){aP.distanceToTarget=aP.target.distanceTo(aH);aO=1/(aP.distanceToTarget*Math.tan(Math.PI/180*13.5))}aP.distanceToTarget=1/(aO*Math.tan(0.5*aG*Math.PI/180));aP.projectionType=aK.type==="0"?m.PERSPECTIVE:m.ORTHOGRAPHIC;aP.origin=new x.Vector3().copy(aP.target);aP.origin.sub(new x.Vector3().copy(aP.sight).multiplyScalar(aP.distanceToTarget))}else{var aL=aq(aD);if(aL){aP={};aE=aL.getLastElement(true);var aB=aE.getReframeArea();var aI=aE.getViewPlaneInformations();if(aB){var aJ=Math.sqrt(aB.width*aB.width+aB.length*aB.length)/2;var aN=new x.Vector2(aB.cornerX+aB.width/2,aB.cornerY+aB.length/2);var aM=new x.Vector3().crossVectors(aI.direction,aI.normal).normalize();aP.origin=new x.Vector3().copy(aI.origin);aP.origin.add(new x.Vector3().copy(aM).multiplyScalar(aN.x));aP.origin.add(new x.Vector3().copy(aI.direction).multiplyScalar(aN.y));aP.origin.applyMatrix4(aF);aP.sight=new x.Vector3().copy(aI.normal).applyMatrix4(aC).normalize().negate();aP.distanceToTarget=aJ/Math.tan(aG*Math.PI/360);aP.origin.sub(new x.Vector3().copy(aP.sight).multiplyScalar(aP.distanceToTarget));aP.up=new x.Vector3().copy(aI.direction).applyMatrix4(aC).normalize()}else{aP.sight=new x.Vector3().copy(aI.normal).applyMatrix4(aC).normalize().negate();aP.up=new x.Vector3().copy(aI.direction).applyMatrix4(aC).normalize();aP.reframeView=aL.clone()}}}return aP};var au=function(aK,aH,aI){if(!aH||!aK){return}var aM=aH.origin,aP=aH.distanceToTarget;if(!aM&&!aP&&aH.reframeView){var aL;var aE=aH.reframeView.getLastElement(true);var aN=aH.reframeView.getParentPath().getParentPath();var aG=P(aH.reframeView);var aF=aE.getVisibleAnnotations(aN,true);var aR,aJ,aQ;if(aF.length){var aB;for(aR=0;aR<aF.length;aR++){if(aF[aR].getLastElement(true).getAnnotationClassType()!=="tps"){continue}aB=[];av(aF[aR].getLastElement(true),aB);if(aB.length){for(aJ=0;aJ<aB.length;aJ++){aQ=aB[aJ].getBoundingSphere("visibleSpace");if(aQ.radius){if(!aL){aL=new x.Sphere().copy(aQ)}else{aL.mergeWithSphere(aQ,aL)}}}}}if(!aL){aB=[];av(aH.reframeView.getLastElement(true),aB);if(aB.length){for(aJ=0;aJ<aB.length;aJ++){aQ=aB[aJ].getBoundingSphere("visibleSpace");if(aQ.radius){if(!aL){aL=new x.Sphere().copy(aQ)}else{aL.mergeWithSphere(aQ,aL)}}}}}if(aL){aL.center.applyMatrix4(aG)}}else{var aO=aN.getParentPath();var aC;if(aN.getLastElement(true).getContextType()===2){aO=aO.getParentPath();if(h.isInstance(aO.getLastElement(true))){aO=aO.getParentPath()}var aD=aO.getChildrenPathes();for(aR=0;aR<aD.length;aR++){aQ=aD[aR].getBoundingSphere(N.getViewer(),"visibleSpace");if(aQ.radius){if(!aL){aL=new x.Sphere().copy(aQ)}else{aL.mergeWithSphere(aQ,aL)}}}if(aL){aL.center.applyMatrix4(aG)}}else{for(aR=0;aR<aO.getChildrenPathes().length;aR++){if(!aO.getChildrenPathes()[aR].isEqual(aN)){aC=aO.getChildrenPathes()[aR];break}}aL=new x.Sphere().copy(aC.getBoundingSphere(N.getViewer(),"visibleSpace"))}}aM=new x.Vector3().copy(aL.center);if(!aL.radius){aM.copy(aE.getViewPlaneInformations().origin)}aP=aL.radius/Math.tan(aK.camera.fov*Math.PI/360);aM.sub(new x.Vector3().copy(aH.sight).multiplyScalar(aP))}if(aM&&aP&&aH.sight&&aH.up){if(aH.projectionType!==undefined){aK.setProjectionType(aH.projectionType)}if(aI!==0){aK.moveTo({eyePosition:aM,upDirection:aH.up,sightDirection:aH.sight,distanceToTarget:aP,duration:aI>0?aI:400})}else{aK.setEyePosition(aM);aK.setSightDirection(aH.sight);aK.setUpDirection(aH.up);aK.setTargetDistance(aP)}}};function aw(aF){var aJ=aF.getChildrenPathes();var aB={relIds:[],paths:[]};for(var aI=0;aI<aJ.length;aI++){var aG=aJ[aI].getChildrenPathes();for(var aH=0;aH<aG.length;aH++){var aE=aG[aH].getLastElement(true);var aC=aE.getLinkedDataRelatedInfos?aE.getLinkedDataRelatedInfos():null;if(aC&&aC.length){aB.paths.push(aG[aH].clone());for(var aD=0;aD<aC.length;aD++){if(aB.relIds.indexOf(aC[aD].addressRelId)===-1){aB.relIds.push(aC[aD].addressRelId)}}}}}return aB}function ae(aI,aC,aB){if(!aI||(aI&&!aI.length)||!aC||!aB||(aB&&!aB.length)){return}var aD,aF;for(aD=0;aD<aI.length;aD++){for(aF=0;aF<aB.length;aF++){var aE=aB[aF].getLastElement(true);if(aE.getLinkedDataRelatedInfos){var aH=aE.getLinkedDataRelatedInfos();for(var aG=0;aG<aH.length;aG++){if(aH[aG].addressRelId===aI[aD].matches[0].sr_id){aE.addLinkedData({displayLabel:aH[aG].anchorText,label:aI[aD].elements[0]["ds6w:label"],type:aH[aG].type,phyID:aI[aD].elements[0].physicalid,phyType:aI[aD].elements[0]["ds6w:type"]})}}}}}for(aF=0;aF<aB.length;aF++){delete aB[aF].getLastElement(true).getLinkedDataRelatedInfos}}var V=function(aD){if(h.getLoadedAssetType()==="3DXML"){return}var aC=aD?aD.getLastElement(true):null;if(!aD||(aD&&!aC.getAnnotationClassType)||(aD&&aC.getAnnotationClassType&&aC.getAnnotationClassType()!=="tpsAnnotationSet")){return}var aB=aw(aD);if(aB.relIds&&aB.relIds.length&&aB.paths&&aB.paths.length){B._getPointedRelations({physicalID:h.getNodeID(aD.getParentPath().getLastElement(true)),relIds:aB.relIds,semantics:["4"],role:["173"],onComplete:function(aF){if(!B){return}var aE=d.is(aF,"string")?JSON.parse(aF):aF;if(!d.is(aE.result,"array")||aE.result.length<1||!d.is(aE.result[0].outputs.RESULTS,"array")||aE.result[0].outputs.RESULTS.lenght<1){return}ae(aE.result[0].outputs.RESULTS,aD,aB.paths);B._publish("onAnnotationsLinkedDataSolved",{path:aD,succeeded:true})},onFailure:function(){if(!B){return}B._publish("onAnnotationsLinkedDataSolved",{path:aD,succeeded:false})},onTimeout:function(){if(!B){return}B._publish("onAnnotationsLinkedDataSolved",{path:aD,succeeded:false})}})}};var R=function(aC,aG){if(aC.isAParentOf(aG)){var aF=aC.getLastElement(true);if(h.is3DLeaf(aF)||h.isReference(aF)){return aC}else{var aD=aC.getChildrenPathes();for(var aE=0;aE<aD.length;aE++){var aB=R(aD[aE],aG);if(aB){return aB}}}}return undefined};var aq=function(aD){var aC=aD.getLastElement(true);if(!aC||!aC.getAnnotationClassType||aC.getAnnotationClassType()==="tpsView"){return aD}if(!aC||!aC.getAnnotationClassType||aC.getAnnotationClassType()!=="tpsCapture"){return undefined}var aB=aD.getParentPath().getParentPath();if(aC.getPointedView()){var aF=aB.getLastElement(true).getRootAnnotationNode("RootViews");if(aF){var aE=aB.clone();aE.addElement(aF);aE.addElement(aF.children[aC.getPointedView()-1]);return aE}}return undefined};var ap=function(aT){if(aT&&aT.getLastElement(true).getAnnotationClassType()==="tpsView"){var aV=aT.getLastElement(true),aG=aV.getViewType();var aE={};if(aG!=="SectionView"&&aG!=="SectionCutView"&&!aV.isMultiSectionView()){return aE}aE.path=aT.clone();aE.clipPlaneMaterial=F;var aB=N.getRootBagPath();var aU=P(aT);var aI=aB.getChildrenPathes();var aQ;for(aQ=0;aQ<aI.length;aQ++){if(aI[aQ].isAParentOf(aT)){aE.rootPath=aI[aQ].clone()}}var aS=aV.getViewPlaneInformations();var aF=new x.Plane().setFromNormalAndCoplanarPoint(aS.normal.clone().negate(),aS.origin.clone());if(aV.isMultiSectionView()){aE.multiClipping=true;var aY=aV.getMultiSectionData();var aZ=new x.Vector3().copy(aY.SketchNormal).normalize().negate();var aL=new x.Vector3().subVectors(aY.pointsDef[1],aY.pointsDef[0]);var aN=new x.Vector3().crossVectors(aZ,aL).normalize();var aP=aT.getParentPath().getLastElement(true);var aO=aP.children[aY.views[0]-1].getViewPlaneInformations().normal;if(aO.dot(aN)>0){aZ.negate()}var aX=new x.Vector3().copy(aY.SketchOrigin);var aJ=new x.Vector3(aZ.y,aZ.x,aZ.z).normalize();if(aJ.equals(aZ)){aJ=new x.Vector3(aZ.x,aZ.z,aZ.y).normalize()}var aH=new x.Vector3().crossVectors(aZ,aJ).normalize();aX.applyMatrix4(aU);var aW=new x.Matrix4().extractRotation(aU);aJ.applyMatrix4(aW);aH.applyMatrix4(aW);var aK=[];var aD;for(aQ=0;aQ<aY.pointsDef.length;aQ++){var aC=new x.Vector3().copy(aY.pointsDef[aQ]).applyMatrix4(aU);aD=new x.Vector3().subVectors(aC,aX);aK.push(new x.Vector2(aD.dot(aJ),aD.dot(aH)))}var aR={polyLinePoints:aK,planeOrigin:aX,planeU:aJ,planeV:aH};var aM=aB.getLastElement(true).getBoundingSphere("visibleSpace");aM.radius=aM.radius;aE.data=l.makeClosedPolyLine(aR,aM)}else{aE.multiClipping=false;aE.data=aF;aE.data.applyMatrix4(aU)}return aE}return undefined};this._publish=function(aC,aB){ac.publish({event:aC,data:aB,context:B})};var H=function(aD){var aB=aD.getChildrenPathes();for(var aC=0;aC<aB.length;aC++){if(aB[aC].getLastElement(true).getAnnotationClassType&&aB[aC].getLastElement(true).getAnnotationClassType()==="tpsAnnotationSet"){return aB[aC]}}return undefined};var P=function(aD){var aC=aD.clone();while(aC){if(h.isInstance(aC.getLastElement(true))){break}aC=aC.getParentPath()}var aB=new x.Matrix4();if(aC){aB.copy(aC.getWorldMatrix(N.getViewer()))}return aB};var y=function(aF,aG,aC){var aE=aF.getLastElement(true);var aD;if(h.is3DLeaf(aE)){for(aD=0;aD<aE.children.length;aD++){if(!aE.children[aD].getAnnotationClassType){if(!aG.multiClipping){aE.children[aD].enableClippingPlane(aG.data,aC)}else{aE.children[aD].setClippingProfile(aC?aG.data:null)}}}}else{if(aE.getAnnotationClassType){return}else{var aB=aF.getChildrenPathes();for(aD=0;aD<aB.length;aD++){y(aB[aD],aG,aC)}}}};var ab=function(){var aB;if((aa.hiddenBodies&&aa.hiddenBodies.length)||(aa.visibleBodies&&aa.visibleBodies.length)){if(aa.hiddenBodies&&aa.hiddenBodies.length){for(aB=0;aB<aa.hiddenBodies.length;aB++){s.applyVisibilityToPath(aa.hiddenBodies[aB],1)}}if(aa.visibleBodies&&aa.visibleBodies.length){for(aB=0;aB<aa.visibleBodies.length;aB++){s.applyVisibilityToPath(aa.visibleBodies[aB],0)}}}aa.hiddenBodies=null;aa.visibleBodies=null;ag(J);J=null;L();if(at){N.getViewer().getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(at);at=null}N.getViewer().render();B._publish("onFilteringAndClippingRemoved")};var T=function(aC,aB){if(!ax){return}L();if((J&&J.path)||(aa.hiddenBodies&&aa.hiddenBodies.length)||(aa.visibleBodies&&aa.visibleBodies.length)||at){if(!X){X=new u({frameWindow:N.getFrameWindow(),viewer:N.getViewer()})}X.display({label:aC,icon:aB,onClickCB:ab,widgetType:"Cancel"});if(S){X.setVisibleFlag(false)}}};var L=function(){if(X){X.hide()}};this.getCGRPath=function(aF){if(aF){var aE=aF.getChildrenPathes(),aB;for(var aC=0;aC<aE.length;aC++){var aD=aE[aC].getLastElement(true);if(aD.getPathElement&&aD.setInternalSceneGraph){return aE[aC]}}if(h.getLoadedAssetType()==="3DXML"){aE=aF.getChildrenPathes();for(aC=0;aC<aE.length;aC++){aB=B.getCGRPath(aE[aC]);if(aB){return aB}}}else{return B.getCGRPath(aF.getParentPath())}}return undefined};var M=function(aB,aC){if(!aB||(aB&&aB.length===0)||!aC){return undefined}var aD=B.getCGRPath(aC);if(aD){return aD.getLastElement(true).getPathElement(aB,aD)}return undefined};this._getPointedRelations=function(aD){if(!d.is(aD,"object")){return}if(!d.is(aD.onComplete,"function")){return}if(!d.is(aD.physicalID,"string")){aD.onComplete();return}if(!d.is(aD.onFailure,"function")){aD.onComplete();return}if(!d.is(aD.onTimeout,"function")){aD.onComplete();return}var aE={};if(aD.semantics){aE.semantics=aD.semantics}if(aD.role){aE.role=aD.role}if(aD.relIds&&aD.relIds.length){aE.sr_id=aD.relIds}var aC={input_physical_ids:[aD.physicalID],primitives:[{navigate_to_sr:{id:1,filter:aE,mode:"path"}}],patterns:{RESULTS:[{id:1,iter:1}]},flags:["returnMatches","noReturnThumbnails"],version:3,label:"CAT3DAnnotControllerNav"};var aB={data:JSON.stringify(aC),timeout:parseInt(g.getSetting("webapi_timeout"),10),method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},onComplete:aD.onComplete,onFailure:aD.onFailure,onTimeout:aD.onTimeout};j.getSecurityContext(function(aF){var aG=j.get3DSpaceUrl()+"/cvservlet/navigate?SecurityContext="+aF.securityContext;if(g.getSetting("cors_activated")===true){b.authenticatedRequest(aG,aB)}else{aB.proxy="passport";b.proxifiedRequest(aG,aB)}})};var ai=function(aD,aC){if(at){N.getViewer().getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(at)}if(!aD||!aC||(!aD.length&&!aC.length)){return}at=new p(N.getRootBagPath().getLastElement(true));N.getViewer().getSceneGraphOverrideSetManager().pushSceneGraphOverrideSet(at);if(aC&&aC.length){var aE=at.createOverride({pathes:aC});aE.setVisibility(true)}if(aD&&aD.length){var aB=at.createOverride({pathes:aD});aB.setVisibility(false)}};var ao=function(aF,aG){var aE=aF.getLastElement(true).getVisibleCompRelIds?aF.getLastElement(true).getVisibleCompRelIds():null;var aD=aF.getLastElement(true).getXMLVisibleCompRelIds?aF.getLastElement(true).getXMLVisibleCompRelIds():null;if(!aE&&!aD){aG()}var aC=function(aK,aQ){var aN=N.getRootBagPath().getChildrenPathes();var aO,aM,aL;for(aM=0;aM<aN.length;aM++){if(aN[aM].isAParentOf(aQ)){aO=aN[aM];break}}var aH=[];for(aM=0;aM<aK.length;aM++){var aP=aO.clone();for(aL=0;aL<aK[aM].length;aL++){aP=ak(aP,aK[aM][aL])}aH.push(aP)}var aJ=[];var aI=function(aW){var aS=aW.getLastElement(true);if(h.is3DLeaf(aS)||aW.isEqual(aQ)){return}if(!aW.isAParentOf(aQ)&&((aW.getParentPath().isEqual(aO)&&h.isRepInstance(aS))||(h.isInstance(aS)))){var aR=true;for(var aU=0;aU<aH.length;aU++){if(aH[aU].isEqual(aW)){aR=false;break}}if(aR){aJ.push(aW.clone())}if(aW.getParentPath().isEqual(aO)&&h.isRepInstance(aS)){return}}var aT=aW.getChildrenPathes();for(var aV=0;aV<aT.length;aV++){aI(aT[aV])}};aI(aO);aF.getLastElement(true).setListsOfAssyPathComponents(aH,aJ);aG({visiblePaths:aH,hiddenPaths:aJ})};if(aE&&aE.length){if(aF.getLastElement(true).getListsOfAssyPathComponents&&aF.getLastElement(true).getListsOfAssyPathComponents()!==undefined){aG(aF.getLastElement(true).getListsOfAssyPathComponents())}else{var aB=aF.getParentPath().getParentPath().getParentPath();B._getPointedRelations({physicalID:h.getNodeID(aB.getLastElement(true)),relIds:aE,semantics:["4"],role:["173"],onComplete:function(aM){var aJ,aK;var aI=d.is(aM,"string")?JSON.parse(aM):aM;if(!d.is(aI.result,"array")||aI.result.length<1||!d.is(aI.result[0].outputs.RESULTS,"array")||aI.result[0].outputs.RESULTS.lenght<1){return}var aN=aI.result[0].outputs.RESULTS,aH=[],aL;for(aJ=0;aJ<aN.length;aJ++){aL=aN[aJ].elements;aH.push([]);for(aK=0;aK<aL.length;aK++){aH[aH.length-1].push(aL[aK].physicalid)}}aC(aH,aB)},onFailure:aG,onTimeout:aG})}}else{if(aD&&aD.length){aC(aD,aF)}}};var ak=function(aF,aG){var aC=aF.getLastElement(true);if(h.getNodeID(aC)===aG){return aF}var aE=aF.getChildrenPathes();for(var aB=0;aB<aE.length;aB++){var aD=ak(aE[aB],aG);if(aD){return aD}}return undefined};var av=function(aD,aB){if(aD.getNodeType&&aD.getNodeType()==="Mesh3D"){aB.push(aD)}else{for(var aC=0;aC<aD.children.length;aC++){av(aD.children[aC],aB)}}}}});return e});define("DS/CAT3DAnnotationController/CAT3DAnnotationController",["UWA/Class","DS/CAT3DAnnotationController/CAT3DAnnotBaseControllerInstance"],function(c,d){var b=[];var a=c.singleton({registerAnnotationController:function(e){if(!e||!e.annotController||!e.context){return}this.unreferenceAnnotationController(e);b.push({context:e.context,annotController:e.annotController})},giveAnnotationController:function(f){if(f&&f.context){for(var e=0;e<b.length;e++){if(b[e].context===f.context){return Object.freeze(b[e].annotController.getAnnotControllerPrototype())}}}},getAnnotationController:function(f){var g=this.giveAnnotationController(f);if(!g&&f&&f.context){var e=new d({ctxViewer:f.context});b.push({context:f.context,annotController:e});g=Object.freeze(b[b.length-1].annotController.getAnnotControllerPrototype())}return g},unreferenceAnnotationController:function(f){if(f&&f.context){for(var e=b.length-1;e>=0;e--){if(b[e].context===f.context){if(b[e].annotController){b[e].annotController.clearController()}b.splice(e,1)}}}}});return a});define("DS/CAT3DAnnotationCommands/CAT3DAnnotationWidgetDefaultCmd",["DS/ApplicationFrame/Command","DS/CATRelatedDataLauncher/CATRelatedDataController","DS/CAT3DAnnotationController/CAT3DAnnotationController","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtilsOptions","DS/PADUtils/PADContext"],function(b,f,a,d,c){var e=b.extend({init:function(i){var i=i||{};this._parent(i,{mode:"exclusive",isAsynchronous:true});this.setRepeatMode(false);this.isAnnotDefaultCmd=true;var h=c.get();var k=this;var j=f.giveDataLauncherController({context:h});require([i.annotControllerLib||"DS/CAT3DAnnotationExpController/CAT3DAnnotExpControllerInstance"],function(m){var l=new m({ctxViewer:h});l.setActiveState(true);a.registerAnnotationController({annotController:l,context:h})});this.beginExecute=function(){if(j){j.setActiveState(true)}};this.endExecute=function(){if(j){j.setActiveState(false)}};this.pauseExecute=function(){if(j){j.setActiveState(false)}};this.resumeExecute=function(){if(j){j.setActiveState(true)}};var g=this._destroy;this._destroy=function(){g.call(k);a.unreferenceAnnotationController({context:h});k=h=j=null}}});return e});define("DS/CAT3DAnnotationModel/CAT3DAnnotationSetNode",["DS/CAT3DAnnotationModel/CAT3DAnnotationNode","DS/WebappsUtils/WebappsUtils"],function(b,c){var a=b.extend({init:function(h){var e=h||{};this._parent(e);var g;var d=[];var f;this.getAnnotationIcon=function(){if(g){return g}g=c.getWebappsAssetUrl("CAT3DAnnotationRsc","icons/22/");g+="I_W3DAnnot_NodeAnnotationSet.png";return g};this.getAnnotationClassType=function(){return"tpsAnnotationSet"};this.getAnnotationType=function(){return 0};this.getRootAnnotationNode=function(i){for(var j=0;j<this.children.length;j++){if(this.children[j].getAnnotationType()===i){return this.children[j]}}return undefined};this.getContextType=function(){return e.contextType};this.addTTRS=function(k){if(k&&k.GeoP&&k.tpsID){var i=[],n,j;for(var l=0;l<k.GeoP.length;l++){j=[];n=false;for(var m=0;m<k.GeoP[l].length;m++){if(k.GeoP[l][m]!==0||n){j.push(k.GeoP[l][m]);n=true}}if(j.length){i.push(j)}}if(i.length){d.push({geoP:i,tpsID:k.tpsID})}}};this.getTTRSs=function(){return d};this.addReferenceFrame=function(i){if(!f){f=[]}f.push({datums:i.datums,tpsID:i.tpsID,uuid:i.uuid})};this.getReferenceFrames=function(){return f}},toJSON:function(){this._parent();if(this.getSemanticStandards&&this.getSemanticStandards()!==undefined){this.jsonObject.semanticStandards=this.getSemanticStandards()}if(this.getAnnotationIcon()!==undefined){this.jsonObject.icon=this.getAnnotationIcon()}if(this.getContextType()!==undefined){this.jsonObject.contextType=this.getContextType()}if(this.getAnnotationType()!==undefined){this.jsonObject.type=this.getAnnotationType()}return this.jsonObject}});return a});define("DS/CAT3DAnnotationModel/CAT3DAnnotationRootNode",["DS/CAT3DAnnotationModel/CAT3DAnnotationNode"],function(a){var b=a.extend({init:function(d){var d=d||{};this._parent(d);var c;this.getAnnotationClassType=function(){return"tpsRoot"};this.getAnnotationType=function(){if(d.rootType===1){return"RootViews"}else{if(d.rootType===2){return"RootCaptures"}else{if(d.rootType===3){return"RootNonSemantic"}else{if(d.rootType===4){return"RootDatums"}else{if(d.rootType===5){return"RootPositions"}else{if(d.rootType===6){return"RootDimensions"}else{if(d.rootType===7){return"RootRunOuts"}else{if(d.rootType===8){return"RootOrientations"}else{if(d.rootType===9){return"RootForms"}else{if(d.rootType===10){return"RootGeometries"}else{if(d.rootType===11){return"RootAttributes"}else{if(d.rootType===12){return"RootRestrictedArea"}}}}}}}}}}}}};this.getAnnotationUuid=function(){return""+d.rootType};this.getAnnotationCategory=function(){return};this.toJSONObject=function(){if(!c){c={classType:this.getAnnotationClassType(),annotType:this.getAnnotationType(),isVisible:this.isVisible(),children:[]}}else{c.isVisible=this.isVisible();c.children.splice(0,c.children.length);for(var e=0;e<this.children.length;e++){c.children.push(this.children[e].toJSONObject())}}return c}},toJSON:function(){this._parent();if(this.getAnnotationType()!==undefined){this.jsonObject.type=this.getAnnotationType()}if(!this.jsonObject.children){this.jsonObject.children=[]}this.jsonObject.children.splice(0,this.jsonObject.children.length);for(var c=0;c<this.children.length;c++){this.jsonObject.children.push(this.children[c].toJSON())}return this.jsonObject}});return b});define("DS/CAT3DAnnotationModel/CAT3DAnnotationCaptureNode",["DS/CAT3DAnnotationModel/CAT3DAnnotationNode","DS/WebappsUtils/WebappsUtils"],function(a,c){var b=a.extend({init:function(g){var e=g||{};this._parent(e);var h=e.thumbnail?"data:image/png;base64,"+e.thumbnail:null;var f;var d;this.getAnnotationIcon=function(){if(f){return f}f=c.getWebappsAssetUrl("CAT3DAnnotationRsc","icons/22/");f+="I_W3DAnnot_CaptureAnnotations.png";return f};this.getPointedView=function(){return e.view};this.setPreview=function(i){h=i};this.getPreview=function(){return h};this.getAnnotationClassType=function(){return"tpsCapture"};this.getAnnotationType=function(){return 6};this.getCaptureCamera=function(){return e.camera};this.getVisibleAnnotations=function(r){var m=[];var u=r.getLastElement?r.getLastElement(true):r;var w,s,v,p;if(e.TPSs){for(var l=0;l<e.TPSs.length;l++){var n=false;var t=u.children;for(v=0;v<t.length;v++){s=t[v];if(s.getAnnotationType()!=="RootViews"&&s.getAnnotationType()!=="RootCaptures"){var j=s.children;for(p=0;p<j.length;p++){if(j[p].getAnnotationID()===e.TPSs[l]){if(r.getLastElement){w=r.clone();w.addElement(s);w.addElement(j[p]);m.push(w)}else{m.push(j[p])}n=true;break}}}if(n){break}}}}for(var q=0;q<3;q++){var k=null;var o=null;if(q===0){k=e.CGs;o="RootGeometries"}else{if(q===1){k=e.Views;o="RootViews"}else{if(q===1){k=e.Caps;o="RootCaptures"}}}if(k&&k.length){s=u.getRootAnnotationNode(o);if(s){for(v=0;v<k.length;v++){var i=s.children;for(p=0;p<i.length;p++){if(i[p].getAnnotationID()===k[v]){if(r.getLastElement){w=r.clone();w.addElement(s);w.addElement(i[p]);m.push(w)}else{m.push(i[p])}break}}}}}}return m};this.isSectionPlaneActivated=function(){return e.ClipPla===1};this.getHiddenBodiesInst=function(){return e.HiddenBodyInst};this.getVisibleBodiesInst=function(){return e.VisibleBodyInst};this.getVisibleCompRelIds=function(){return e.VisibleCompRelId};this.getXMLVisibleCompRelIds=function(){return e.VisibleCompXmlId};this.getAnnotationSupertype=function(){return 11};this.setListsOfAssyPathComponents=function(i,k){d={visiblePaths:[],hiddenPaths:[]};var j;for(j=0;j<i.length;j++){d.visiblePaths.push(i[j].clone())}for(j=0;j<k.length;j++){d.hiddenPaths.push(k[j].clone())}};this.getListsOfAssyPathComponents=function(){return d}},toJSON:function(){if(!this.jsonObject){this._parent();var f=[];var i=this.parents[0].parents[0];var h=this.getVisibleAnnotations(i);for(var e=0;e<h.length;e++){var d=h[e].parents[0];var j=null,k=null,g;for(g=0;g<i.children.length;g++){if(d.getAnnotationType()===i.children[g].getAnnotationType()){j=g;break}}for(g=0;g<i.children[j].children.length;g++){if(h[e].getAnnotationID()===i.children[j].children[g].getAnnotationID()){k=g;break}}if(j!==null&&k!==null){f.push([j,k])}}if(this.getAnnotationIcon()!==undefined){this.jsonObject.icon=this.getAnnotationIcon()}if(this.getAnnotationType()!==undefined){this.jsonObject.type=this.getAnnotationType()}if(this.getAnnotationSupertype()!==undefined){this.jsonObject.superType=this.getAnnotationSupertype()}if(this.getPointedView()!==undefined){this.jsonObject.pointedView=this.getPointedView()}if(this.getVisibleBodiesInst()!==undefined){this.jsonObject.visibleBodiesInst=this.getVisibleBodiesInst()}if(this.getHiddenBodiesInst()!==undefined){this.jsonObject.hiddenBodiesInst=this.getHiddenBodiesInst()}if(this.getCaptureCamera()!==undefined){this.jsonObject.camera=this.getCaptureCamera()}if(f!==undefined){this.jsonObject.tpsList=f}}else{this._parent()}if(this.getPreview()!==undefined){this.jsonObject.preview=this.getPreview()}return this.jsonObject}});return b});define("DS/CAT3DAnnotationCommands/panels/CAT3DAnnotationFilterPanel",["UWA/Core","UWA/Class","DS/CoreEvents/ModelEvents","DS/CAT3DAnnotationUI/CAT3DAnnotationFilterListItem","DS/CAT3DAnnotationUI/CAT3DAnnotationFilterTolFilterItem","UWA/Controls/ThemedScroller","DS/UIKIT/SuperModal","DS/WebappsUtils/WebappsUtils","DS/CATWebUXComponents/CATWebUXSectionHeader","i18n!DS/CAT3DAnnotationRsc/assets/nls/CAT3DAnnotationSubtypes","i18n!DS/CAT3DAnnotationRsc/assets/nls/CAT3DAnnotationSupertypes","i18n!DS/CAT3DAnnotationRsc/assets/nls/CAT3DAnnotationTypes","i18n!DS/CAT3DAnnotationRsc/assets/nls/CAT3DAnnotationAttributesCategories","i18n!DS/CAT3DAnnotationCommands/assets/nls/CAT3DAnnotationCommands","css!DS/CAT3DAnnotationCommands/CAT3DAnnotationCommands.css"],function(h,a,d,k,e,g,c,f,o,l,m,i,b,j){var n=a.extend({init:function(X){this._parent(X);var X=X||{};var O=X.style!==undefined?(X.style.version!==undefined?X.style.version:1):1;var Q=X.style!==undefined?(X.style.semanticUI!==undefined?X.style.semanticUI:false):false;var au;var aa,ah,Y;var V;var R;var aq;var am;var L;var E=[];var W=[];var z=[];var q=[];var y=[];var ax="AnnotSetAssemblyRoot";var at="AnnotViewsCustom";var aj="AnnotsCustom";var ay="AttributesAll";var aB=new d();var ae=[];var aw=[];var ar=[];var F=[];var K=[];var M=false;var I=false;var P;var C=new c({renderTo:document.body});this.buildPanel=function(aE){this.cleanPanel();if(aE.attrTypesFilteredByPref&&aE.attrTypesFilteredByPref.length){F=aE.attrTypesFilteredByPref.slice()}if(aE.attrTypesOrderedList&&aE.attrTypesOrderedList.length){K=aE.attrTypesOrderedList.slice()}u(aE.model);if(!au){au=h.createElement("div",{id:"CAT3DAnnotFilterMainDiv","class":"CAT3DAnnotFilterMainDiv"})}var aF=h.createElement("div",{id:"CAT3DAnnotFilterScrollerDiv"});var aC=new g().inject(au);aC.getInnerElement().setContent(aF);aC.getInnerElement().parentNode.setStyle("height","100%");var aD=h.createElement("div",{id:"CAT3DAnnotSetsSection","class":"CAT3DAnnotSectionMainDiv"}).inject(aF);E.push(new o({sectionLabel:j.AnnotSetsSectionLbl,fontIcon:"fonticon fonticon-annotationFilter",displayTooltip:false,doubleClickCB:U}));aD.appendChild(E[E.length-1].getContent());R=h.createElement("div",{"class":"CAT3DAnnotFilterSectionDiv"}).inject(aD);T(true,aD,R);Z();if(O===1){aa=h.createElement("div",{id:"CAT3DAnnotViewsSection","class":"CAT3DAnnotSectionMainDiv"}).inject(aF);E.push(new o({sectionLabel:j.AnnotViewsSectionLbl,displayTooltip:false,doubleClickCB:U}));aa.appendChild(E[E.length-1].getContent());aq=h.createElement("div",{"class":"CAT3DAnnotFilterSectionDiv"}).inject(aa);ao()}ah=h.createElement("div",{id:"CAT3DAnnotsSection","class":"CAT3DAnnotSectionMainDiv"}).inject(aF);E.push(new o({sectionLabel:j.AnnotsSectionLbl,displayTooltip:false,doubleClickCB:U}));ah.appendChild(E[E.length-1].getContent());V=h.createElement("div",{"class":"CAT3DAnnotFilterSectionDiv"}).inject(ah);ad();if(O!==1&&Q){Y=h.createElement("div",{id:"CAT3DAttributesSection","class":"CAT3DAnnotSectionMainDiv"}).inject(aF);E.push(new o({sectionLabel:j.AttributesSectionLbl,displayTooltip:false,doubleClickCB:U}));Y.appendChild(E[E.length-1].getContent());am=h.createElement("div",{"class":"CAT3DAnnotFilterSectionDiv"}).inject(Y);ac()}af();return au};this.cleanPanel=function(aC){var aD;for(aD=0;aD<W.length;aD++){W[aD].clear()}W.splice(0,W.length);for(aD=0;aD<z.length;aD++){z[aD].clear()}z.splice(0,z.length);for(aD=0;aD<q.length;aD++){q[aD].clear()}q.splice(0,q.length);for(aD=0;aD<y.length;aD++){y[aD].clear()}y.splice(0,y.length);for(aD=0;aD<E.length;aD++){E[aD].clear()}E.splice(0,E.length);if(au){while(au.firstChild){au.removeChild(au.firstChild)}}V=null;R=null;aq=null;am=null;L=null;if(aC){ax="AnnotSetAssemblyRoot";at="AnnotViewsCustom";aj="AnnotsCustom";ay="AttributesAll";ae.length=0;aw.length=0;ar.length=0;F.length=0;K.length=0;I=false;M=false;P=null}};var s=function(aE,aC){if(!aE||!aC||(aE&&aC&&aE.length!==aC.length)){return false}for(var aD=0;aD<aE.length;aD++){if(aE[aD]!==aC[aD]){return false}}return true};this.updatePanel=function(aC){if(!au||!R){return this.buildPanel(aC)}var aD=u(aC.model);if(aD.rebuildPanel){Z();ao();ad()}else{if(!s(aC.attrTypesFilteredByPref,F)||!s(aC.attrTypesOrderedList,K)){F=aC.attrTypesFilteredByPref.slice();K=aC.attrTypesOrderedList.slice()}}af();if(O!==1&&Q){ac()}if(aD.refreshViewsSection){r({name:at,forceRefresh:true})}if(aD.refreshAnnotsSection){D({name:aj,forceRefresh:true})}if(I||M){M=false;I=false;p();ak(true)}};var an=function(aE){var aC=aE.type;var aD="";if(aE.superType===11){if(aC===6){aD="Captures"}else{aD="Views"}}else{if(aC===40||aC===41||aC===42||aC===43||aC===44||aC===45||aC===46||aC===54){aD="Geometries"}else{if(aC===22||aC===23||aC===24||aC===25||aC===26||aC===27||aC===28){aD="GeomTolerances"}else{if(aC===12||aC===13||aC===14||aC===15||aC===16||aC===37||aC===38){aD="Dimensions"}else{if(aC===7||aC===8||aC===9||aC===10||aC===11){aD="GeomTolerances"}else{if(aC===19||aC===20||aC===21){aD="GeomTolerances"}else{if(aC===17||aC===18){aD="GeomTolerances"}else{if(aC===5){aD="Datums"}else{if(aC===35){aD="Datums"}else{if(aC===3){aD="Datums"}else{if(aC===4){aD="GeomTolerances"}else{if(aC===34){aD="Dimensions"}else{if(aC===36){aD="Dimensions"}else{if(aC===29){aD="Roughness"}else{if(aC===31){aD="Welds"}else{if(aC===1){aD="Notes"}else{if(aC===2){aD="Notes"}else{if(aC===30){aD="Notes"}else{if(aC===51){aD="RestrictedAreas"}}}}}}}}}}}}}}}}}}}return aD};var af=function(){if(ax!=="AnnotSetCustom"){var aC=false;for(var aF=0;aF<ae.length;aF++){var aD=ae[aF];var aE=aD.checkFlagInAllSection===undefined?aD.hasBeenEntirelyLoaded:aD.checkFlagInAllSection;if(ax==="AnnotSetAll"&&ae.length===1&&!aE){aC=true}else{if(aD.children.length){for(var aG=0;aG<aD.children.length;aG++){if(ax==="AnnotSetAll"){var aE=aD.checkFlagInAllSection===undefined?aD.hasBeenEntirelyLoaded:aD.checkFlagInAllSection;if(((ae.length===1||(ae.length>1&&aE))&&!aD.children[aG].isVisible)||(ae.length>1&&!aE&&aD.children[aG].isVisible)){aC=true;break}}else{if(ax==="AnnotSetAssemblyRoot"){if(ae.length===1){if((!aD.children[aG].isVisible&&aD.children[aG].isDirectChild)||aD.children[aG].isVisible&&!aD.children[aG].isDirectChild){aC=true;break}}else{if(ae.length>1){if((aD.checkFlagInAssySection&&aD.children[aG].isDirectChild&&!aD.children[aG].isVisible)||(aD.checkFlagInAssySection&&!aD.children[aG].isDirectChild&&aD.children[aG].isVisible)||(!aD.checkFlagInAssySection&&aD.children[aG].isVisible)){aC=true;break}}}}else{if(ax==="AnnotSetNone"){if(aD.children[aG].isVisible){aC=true;break}}}}}}}if(aC){break}}if(aC){for(var aF=0;aF<ae.length;aF++){for(var aG=0;aG<ae[aF].children.length;aG++){ae[aF].children[aG].checkFlagInCustomSection=ae[aF].children[aG].isVisible}}return G({name:"AnnotSetCustom"})}}ak(false)};var H=function(aC){if(aC.superType===11){return aC.type===6?"Capture":"View"}return aC.type};var ak=function(aK){if(aK){az()}var aL=0,aO=0;var aR=false,aG=false;for(var aQ=0;aQ<ae.length;aQ++){var aN=ae[aQ];var aI=aN.checkFlagInAllSection===undefined?aN.hasBeenEntirelyLoaded:aN.checkFlagInAllSection;if(aN.allView){aN.allView.setCheckFlag(aI)}if(aN.assyView){aN.assyView.setCheckFlag(aN.checkFlagInAssySection)}for(var aH=0;aH<aN.children.length;aH++){var aP=aN.children[aH];if(aP.view){aP.view.setCheckFlag(aP.checkFlagInCustomSection)}for(var aE=0;aE<aP.children.length;aE++){var aC=aP.children[aE];if(aC.type==="RootAttributes"){continue}for(var aM=0;aM<aC.children.length;aM++){var aD=aC.children[aM];if((aC.type==="RootViews"||aC.type==="RootCaptures")&&aP.isVisible){aL++;aR=true}else{if(aP.isVisible){aG=true}if(aD.isDisplayed&&aP.isVisible){aO++}}if(aD.view){aD.view.setCheckFlag(aD.checkFlagInCustomSection);aD.view.setDisplayFlag(aD.isDisplayed)}}}}}for(var aQ=0;aQ<aw.length;aQ++){aw[aQ].view.setDisplayFlag(aw[aQ].isDisplayed);for(var aH=0;aH<aw[aQ].types.length;aH++){aw[aQ].types[aH].view.setDisplayFlag(aw[aQ].types[aH].isDisplayed)}}for(var aQ=0;aQ<W.length;aQ++){W[aQ].update();W[aQ].setCheckFlag(W[aQ].name===ax)}for(var aQ=0;aQ<z.length;aQ++){if(z[aQ].name==="AnnotViewsAll"){z[aQ].setNbElems(aL)}z[aQ].update(z[aQ].name==="AnnotViewsCustom");z[aQ].setCheckFlag(z[aQ].name===at)}if(O===1){T(aR,aa,aq)}for(var aQ=0;aQ<q.length;aQ++){if(q[aQ].name==="AnnotsAll"){if(O===1){q[aQ].setNbElems(aO)}else{q[aQ].setNbElems(aO+aL)}}q[aQ].update(q[aQ].name==="AnnotsCustom"||q[aQ].name==="AnnotsType");if(q[aQ].name!=="AnnotsDisplayOnlyDefault"&&q[aQ].name!=="AnnotsFilterByTol"){q[aQ].setCheckFlag(q[aQ].name===aj)}else{if(q[aQ].name==="AnnotsDisplayOnlyDefault"){q[aQ].setCheckFlag(M)}else{if(q[aQ].name==="AnnotsFilterByTol"){q[aQ].setCheckFlag(I)}}}}if(O===1){T(aG,ah,V)}else{T(aG||aR,ah,V)}var aF=0,aJ=false;for(var aQ=0;aQ<ar.length;aQ++){if(ar[aQ].isDisplayed&&F.indexOf(ar[aQ].name)===-1){aF++}if((ar[aQ].view&&ar[aQ].view.isDisplayed()!==ar[aQ].isDisplayed)||(!ar[aQ].view&&ar[aQ].isDisplayed)){aJ=true}}if(aJ){ac()}for(var aQ=0;aQ<y.length;aQ++){if(y[aQ].name==="AttributesAll"){y[aQ].setNbElems(aF)}y[aQ].update(y[aQ].name==="AttributesType");y[aQ].setCheckFlag(y[aQ].name===ay)}if(O!==1&&Q){T(aF!==0,Y,am)}};var T=function(aC,aD,aE){var aF=aD.querySelector(".CATWebUXSectionHeader");aF.setStyles({color:aC?"":"rgb(190, 190, 190)"});aE.setStyles({height:aC?"auto":"",padding:aC?"5px":"0px 5px",overflow:aC?"auto":"",opacity:aC?"1":"0.5"})};this.subscribe=function(aD,aC){if(!aD||!aC){return}return aB.subscribe({event:aD},aC)};this.unsubscribe=function(aC){if(aC===null||aC===undefined){return}aB.unsubscribe(aC)};var w=function(aE,aD,aH,aI){var aJ=true;for(var aG=0;aG<aE.length;aG++){if(aE[aG].name===aD){if(aE[aG].isDisplayed===null||aE[aG].isDisplayed===false){aE[aG].isDisplayed=aI}aJ=false;break}}if(aJ){var aF=aH;if(!aF){aF=f.getWebappsAssetUrl("CAT3DAnnotationRsc","icons/22/");if(aD==="3DAnnotations"){aF+="I_W3DAnnot_NodeAnnotationSet.png"}else{aF=null}}var aC={name:aD,checkFlag:true,icon:aF,isDisplayed:aI};for(var aG=0;aG<ar.length;aG++){if(ar[aG].name===aD){aC.checkFlag=ar[aG].checkFlag;break}}aE.push(aC)}};var ap=function(aE,aD,aC){if(aE.hyperlink){if((aE.hyperlink.relatedDocs&&aE.hyperlink.relatedDocs.length)||aE.hyperlink.hyperlinksAndComments||(aE.hyperlink.failureModes&&aE.hyperlink.failureModes.length)||(aE.hyperlink.requirements&&aE.hyperlink.requirements.length)){w(aD,"3DAnnotations",null,aC)}}else{if(aE.generalTolerance||(aE.tabulatedLimit&&aE.toleranceLimits)){w(aD,"3DAnnotations",null,aC)}}};var u=function(a2){var aD=[];var aH=a2.length!==ae.length;var aJ=0;var aM=[];for(var aR=0;aR<ar.length;aR++){ar[aR].isDisplayed=null}for(var aR=0;aR<a2.length;aR++){var aE=a2[aR];var aV=null;for(var aW=0;aW<ae.length;aW++){if(ae[aW].id===aE.id){aV=ae[aW];break}}if(!aV){aH=true;var aZ=[];for(var aW=0;aW<aE.children.length;aW++){var aI={};Object.assign(aI,aE.children[aW]);aI.checkFlagInCustomSection=aE.children[aW].isVisible;aZ.push(aI)}var aN=aE.type==="3DShape"||aE.type==="CATPart"||aE.type==="3DPart";if(typeof aE.hasBeenEntirelyLoaded==="boolean"){aN=aE.hasBeenEntirelyLoaded}aV={id:aE.id,name:aE.name,icon:aE.icon,children:aZ,hasBeenEntirelyLoaded:aN,checkFlagInAssySection:true}}else{if(typeof aE.hasBeenEntirelyLoaded==="boolean"){aV.hasBeenEntirelyLoaded=aE.hasBeenEntirelyLoaded}for(var aW=aV.children.length-1;aW>=0;aW--){var aS=false;for(var aF=0;aF<aE.children.length;aF++){if(aE.children[aF].id===aV.children[aW].id){aS=true;break}}if(!aS){aH=true;aV.children.splice(aW,1)}}var aT=false;for(var aW=0;aW<aE.children.length;aW++){var aY=aE.children[aW];var a0=-1;for(var aF=0;aF<aV.children.length;aF++){if(aY.id===aV.children[aF].id){a0=aF;break}}if(a0===-1){aH=true;aT=true;var aI={};Object.assign(aI,aY);aI.checkFlagInCustomSection=aY.isVisible;aV.children.push(aI);for(var aF=0;aF<aI.children.length;aF++){var aQ=aI.children[aF];for(var aO=0;aO<aQ.children.length;aO++){aQ.children[aO].checkFlagInCustomSection=aQ.children[aO].isVisible}}if(aj!=="AnnotsCustom"){aj="AnnotsCustom";aJ=aJ===0?1:3}if(at!=="AnnotViewsCustom"){at="AnnotViewsCustom";aJ=aJ===0?2:3}}else{if(aV.children[a0].referenceLabel!==aY.referenceLabel){aH=true;aV.children[a0].referenceLabel=aY.referenceLabel}if(aV.children[a0].isVisible!==aY.isVisible){if(aj!=="AnnotsCustom"){aj="AnnotsCustom";aJ=aJ===0?1:3}if(at!=="AnnotViewsCustom"){at="AnnotViewsCustom";aJ=aJ===0?2:3}aV.children[a0].isVisible=aY.isVisible;aV.children[a0].checkFlagInCustomSection=aY.isVisible}var aC=0;for(var aF=0;aF<aV.children[a0].children.length;aF++){var aQ=aV.children[a0].children[aF];var aX=aY.children[aF];for(var aO=0;aO<aQ.children.length;aO++){var a1=aQ.children[aO];var aG=aX.children[aO];var aP=false;if(a1.id===aG.id){if(a1.name!==aG.name&&a1.view){a1.view.setLabel(a1.name)}if(a1.isVisible!==aG.isVisible){aP=true;a1.isVisible=aG.isVisible;a1.checkFlagInCustomSection=aG.isVisible}}else{aP=true;aQ.children.splice(aO,1,aG);aH=true}if(aP){if((aQ.type==="RootViews"||aQ.type==="RootCaptures")&&at!=="AnnotViewsCustom"){at="AnnotViewsCustom";aC=aC===0?1:3}else{if(aQ.type!=="RootViews"&&aQ.type!=="RootCaptures"&&aj!=="AnnotsCustom"){aj="AnnotsCustom";aC=aC===0?2:3}}}}}if(aC!==0){for(var aF=0;aF<aV.children[a0].children.length;aF++){var aQ=aV.children[a0].children[aF];for(var aO=0;aO<aQ.children.length;aO++){if((aQ.type==="RootViews"||aQ.type==="RootCaptures")&&(aC===1||aC===3)){aQ.children[aO].checkFlagInCustomSection=aQ.children[aO].isVisible}else{if(aQ.type!=="RootViews"&&aQ.type!=="RootCaptures"&&(aC===2||aC===3)){aQ.children[aO].checkFlagInCustomSection=aQ.children[aO].isVisible}}}}}}}if(aT){var aL=[];for(var aW=0;aW<aE.children.length;aW++){for(var aF=0;aF<aV.children.length;aF++){if(aE.children[aW].id===aV.children[aF].id){aL.push(aV.children[aF]);break}}}aV.children=aL}}aM.push(aV);for(var aW=0;aW<aE.children.length;aW++){var aY=aE.children[aW];aV.children[aW].hyperlink=aY.hyperlink;ap(aY,aD,aY.isVisible);for(var aF=0;aF<aY.children.length;aF++){var aQ=aY.children[aF];if(aQ.type==="RootAttributes"){for(var aO=0;aO<aQ.children.length;aO++){w(aD,aQ.children[aO].category,aQ.children[aO].icon,aY.isVisible)}}else{if(aQ.type!=="RootViews"&&aQ.type!=="RootCaptures"){for(var aO=0;aO<aQ.children.length;aO++){aV.children[aW].children[aF].children[aO].hyperlink=aQ.children[aO].hyperlink;ap(aQ.children[aO],aD,aY.isVisible)}}}}}}if(O!==1&&Q){var aU=[];for(var aR=0;aR<K.length;aR++){var aK=false;for(var aW=aD.length-1;aW>=0;aW--){if(K[aR]===aD[aW].name){aU.push(aD[aW]);aD.splice(aW,1);aK=true;break}}if(!aK){for(var aW=ar.length-1;aW>=0;aW--){if(K[aR]===ar[aW].name){aU.push(ar[aW]);aU[aU.length-1].isDisplayed=false;break}}}}ar=aU}aM=aM.slice(0,aM.length);ae=[];for(var aR=0;aR<a2.length;aR++){for(var aW=0;aW<aM.length;aW++){if(aM[aW].id===a2[aR].id){ae.push(aM[aW]);break}}}az();return{rebuildPanel:aH,refreshViewsSection:aJ===2||aJ===3,refreshAnnotsSection:aJ===1||aJ===3}};var az=function(){var aG=[];for(var aQ=0;aQ<ar.length;aQ++){ar[aQ].isDisplayed=null}if(Q){for(var aQ=0;aQ<aw.length;aQ++){aw[aQ].isDisplayed=false;for(var aJ=0;aJ<aw[aQ].types.length;aJ++){aw[aQ].types[aJ].isDisplayed=false}}}for(var aQ=0;aQ<ae.length;aQ++){var aO=ae[aQ];for(var aJ=0;aJ<aO.children.length;aJ++){var aP=aO.children[aJ];ap(aP,aG,aP.isVisible);for(var aF=0;aF<aP.children.length;aF++){var aD=aP.children[aF];for(var aN=0;aN<aD.children.length;aN++){if(aD.type==="RootAttributes"){w(aG,aD.children[aN].category,aD.children[aN].icon,aP.isVisible)}else{if(aD.type!=="RootViews"&&aD.type!=="RootCaptures"){ap(aD.children[aN],aG,aP.isVisible)}}var aE=aD.children[aN];var aM=true;if(ax==="AnnotSetAll"&&ae.length>1&&(aO.checkFlagInAllSection===false||aO.checkFlagInAllSection===undefined&&!aO.hasBeenEntirelyLoaded)){aM=false}if(aM&&ax==="AnnotSetAssemblyRoot"){if((ae.length===1&&!aP.isDirectChild)||(ae.length>1&&!aO.checkFlagInAssySection)||(ae.length>1&&aO.checkFlagInAssySection&&!aP.isDirectChild)){aM=false}}if(aM&&ax==="AnnotSetCustom"&&!aP.checkFlagInCustomSection){aM=false}if(aM&&ax==="AnnotSetNone"){aM=false}if(aM&&aD.type!=="RootViews"&&aD.type!=="RootCaptures"&&v(aE)){aE.isDisplayed=false}else{aE.isDisplayed=aM}if(Q&&((O===1&&aD.type!=="RootViews"&&aD.type!=="RootCaptures")||O!==1)){var aI="";switch(aE.superType){case 1:aI="NonSemantic";break;case 2:aI="Datum";break;case 3:aI="PosOrRun";break;case 4:aI="Size";break;case 5:aI="PosOrRun";break;case 6:aI="PosOrRun";break;case 7:aI="Form";break;case 8:aI="Geometry";break;case 10:aI="RestrictedAreas";break;case 11:aI="ViewsAndCaptures";break;default:aI="";break}if(aI){var aL=-1;var aK=-1;for(var aH=0;aH<aw.length;aH++){if(aw[aH].name===aI){aL=aH;break}}if(aL===-1){aw.push({name:aI,types:[]});aL=aw.length-1}var aC=i[H(aE)];for(var aH=0;aH<aw[aL].types.length;aH++){if(aw[aL].types[aH].name===aC){aK=aH;break}}if(aK===-1&&aC){aw[aL].types.push({name:aC,type:H(aE),checkFlag:false,isDisplayed:false})}}}}}}}for(var aQ=0;aQ<aG.length;aQ++){for(var aJ=0;aJ<ar.length;aJ++){if(ar[aJ].name===aG[aQ].name){ar[aJ].isDisplayed=aG[aQ].isDisplayed;break}}}if(Q){for(var aQ=0;aQ<ae.length;aQ++){var aO=ae[aQ];for(var aJ=0;aJ<aO.children.length;aJ++){var aP=aO.children[aJ];for(var aF=0;aF<aP.children.length;aF++){var aD=aP.children[aF];for(var aN=0;aN<aD.children.length;aN++){if(((O===1&&aD.type!=="RootViews"&&aD.type!=="RootCaptures")||O!==1)){var aE=aD.children[aN];for(var aH=0;aH<aw.length;aH++){for(var aR=0;aR<aw[aH].types.length;aR++){if(aw[aH].types[aR].name===i[H(aE)]&&aE.isDisplayed){aw[aH].types[aR].isDisplayed=true;break}}}}}}}}}};var Z=function(){for(var aK=0;aK<W.length;aK++){if(W[aK].getContent().parentNode===R){W[aK].clear();R.removeChild(W[aK].getContent())}}W.splice(0,W.length);var aH;var aF;if(ae&&ae.length>1){aH=[];aF=[];for(var aK=0;aK<ae.length;aK++){aH.push(new k({id:"AnnotSetAll_"+aK,idPath:[aK],name:ae[aK].name,icon:ae[aK].icon,header:ae[aK].name,type:"checkbox",className:"AnnotFilterLeaf",displayNbElems:false,displayTitle:false,callback:N,checkFlag:ae[aK].checkFlagInAllSection===undefined?ae[aK].hasBeenEntirelyLoaded:ae[aK].checkFlagInAllSection}));ae[aK].allView=aH[aH.length-1];aF.push(new k({id:"AnnotSetAssemblyRoot_"+aK,idPath:[aK],name:ae[aK].name,icon:ae[aK].icon,header:ae[aK].name,type:"checkbox",className:"AnnotFilterLeaf",displayNbElems:false,displayTitle:false,callback:x,checkFlag:ae[aK].checkFlagInAssySection}));ae[aK].assyView=aF[aF.length-1]}}W.push(new k({id:"AnnotSetAll",name:"AnnotSetAll",type:"radio",header:j.AllSectionLbl,checkFlag:ax==="AnnotSetAll",children:aH,displayNbElems:aH!==undefined,noSelectAll:true,className:"AnnotFilterMainSection",callback:G,expandingPreference:"AnnotationSets.All"}));W.push(new k({id:"AnnotSetAssemblyRoot",name:"AnnotSetAssemblyRoot",type:"radio",header:j.AssemblyRootSectionLbl,checkFlag:ax==="AnnotSetAssemblyRoot",children:aF,displayNbElems:aF!==undefined,noSelectAll:true,className:"AnnotFilterMainSection",callback:G,expandingPreference:"AnnotationSets.AssemblyRoots"}));var aD=ae.length>1;if(aD){var aG=0;for(var aK=0;aK<ae.length;aK++){if(ae[aK].children.length){aG++}}aD=aG>1}var aE=[];for(var aK=0;aK<ae.length;aK++){var aC=true;var aJ=[];for(var aI=0;aI<ae[aK].children.length;aI++){if(!ae[aK].children[aI].checkFlagInCustomSection){aC=false}aJ.push(new k({id:"AnnotSetCustom_"+aK+"_"+aI,idPath:[aK,aI],name:ae[aK].children[aI].referenceLabel+" / "+ae[aK].children[aI].name,icon:ae[aK].children[aI].referenceIcon,header:ae[aK].children[aI].referenceLabel+" / "+ae[aK].children[aI].name,type:"checkbox",className:"AnnotFilterLeaf",displayNbElems:false,displayTitle:true,callback:aA,checkFlag:ae[aK].children[aI].checkFlagInCustomSection}));ae[aK].children[aI].view=aJ[aJ.length-1]}if(aD){if(ae[aK].children.length){aE.push(new k({id:"AnnotSetCustom_"+aK,type:"checkbox",name:ae[aK].name||(j.DefaultRootLbl+"."+aK),header:ae[aK].name||(j.DefaultRootLbl+"."+aK),noSelectAll:true,displayNbElems:true,displayTitle:true,className:"annotFilterSubSection",checkFlag:aC,children:aJ}))}}else{if(aJ.length){aE=aE.concat(aJ)}}}W.push(new k({id:"AnnotSetCustom",name:"AnnotSetCustom",type:"radio",header:j.CustomSectionLbl,displayNbElems:aE.length>0,displayTitle:false,noSelectAll:ae.length!==1,expandingPreference:"AnnotationSets.Custom",className:"AnnotFilterMainSection",children:aE,checkFlag:ax==="AnnotSetCustom",callback:G}));W.push(new k({id:"AnnotSetNone",name:"AnnotSetNone",type:"radio",header:j.NoneSectionLbl,checkFlag:ax==="AnnotSetNone",displayNbElems:false,displayTitle:false,className:"AnnotFilterMainSection",callback:G}));for(var aK=0;aK<W.length;aK++){R.appendChild(W[aK].getContent())}};var ao=function(){if(O!==1){return}for(var aQ=0;aQ<z.length;aQ++){if(z[aQ].getContent().parentNode===aq){z[aQ].clear();aq.removeChild(z[aQ].getContent())}}z.splice(0,z.length);var aL=[];var aG=[];var aH=true;var aS=true;if(ae&&ae.length){var aE=0;var aM=0;for(var aQ=0;aQ<ae.length;aQ++){var aK=ae[aQ];for(var aF=0;aF<aK.children.length;aF++){var aP=aK.children[aF];for(var aC=0;aC<aP.children.length;aC++){var aO=aP.children[aC];if(aO.type==="RootViews"){for(var aJ=0;aJ<aO.children.length;aJ++){aE++;var aI=aO.children[aJ];aI.checkFlagInCustomSection=aI.checkFlagInCustomSection!==undefined?aI.checkFlagInCustomSection:aI.isVisible;aG.push(new k({id:"AnnotViewsCustomViews_"+aQ+"_"+aF+"_"+aC+"_"+aJ,idPath:[aQ,aF,aC,aJ],isDisplayed:aI.isDisplayed,name:aI.name+" / "+aP.referenceLabel+" / "+aP.name,header:aI.name+" / "+aP.referenceLabel+" / "+aP.name,icon:aI.icon,type:"checkbox",displayNbElems:false,displayTitle:true,className:"AnnotFilterLeaf",callback:J,checkFlag:aI.checkFlagInCustomSection}));aG[aG.length-1].setDisplayFlag(aI.isDisplayed);if(aI.isDisplayed&&!aI.isVisible){aH=false}aI.view=aG[aG.length-1]}}else{if(aO.type==="RootCaptures"){for(var aJ=0;aJ<aO.children.length;aJ++){aM++;var aN=aO.children[aJ];aN.checkFlagInCustomSection=aN.checkFlagInCustomSection!==undefined?aN.checkFlagInCustomSection:aN.isVisible;aL.push(new k({id:"AnnotViewsCustomCaps_"+aQ+"_"+aF+"_"+aC+"_"+aJ,idPath:[aQ,aF,aC,aJ],name:aN.name+" / "+aP.referenceLabel+" / "+aP.name,header:aN.name+" / "+aP.referenceLabel+" / "+aP.name,icon:aN.icon,type:"checkbox",displayNbElems:false,displayTitle:true,className:"AnnotFilterLeaf",isDisplayed:aN.isDisplayed,callback:J,checkFlag:aN.checkFlagInCustomSection}));aL[aL.length-1].setDisplayFlag(aN.isDisplayed);if(aN.isDisplayed&&!aN.isVisible){aS=false}aN.view=aL[aL.length-1]}}}}}}}var aR=[];if(aG.length){var aD=false;for(var aQ=0;aQ<aG.length;aQ++){if(aG[aQ].isDisplayed()){aD=true;break}}aR.push(new k({id:"AnnotationViews.Custom.Views",name:"Views",type:"checkbox",className:"annotFilterSubSection",isDisplayed:aD,header:l.Views,children:aG,checkFlag:aH,noSelectAll:true,displayNbElems:true,displayTitle:true,expandingPreference:"AnnotationViews.Custom.Views"}))}if(aL.length){var aD=false;for(var aQ=0;aQ<aL.length;aQ++){if(aL[aQ].isDisplayed()){aD=true;break}}aR.push(new k({id:"AnnotationViews.Custom.Captures",name:"Captures",type:"checkbox",isDisplayed:aD,className:"annotFilterSubSection",header:l.Captures,children:aL,checkFlag:aS,noSelectAll:true,displayNbElems:true,displayTitle:true,expandingPreference:"AnnotationViews.Custom.Captures"}))}z.push(new k({id:"AnnotViewsAll",name:"AnnotViewsAll",type:"radio",header:j.AllSectionLbl,className:"AnnotFilterMainSection",checkFlag:at==="AnnotViewsAll",displayNbElems:true,displayTitle:false,nbElems:aG.length+aL.length,callback:r}));z.push(new k({id:"AnnotViewsCustom",name:"AnnotViewsCustom",type:"radio",header:j.CustomSectionLbl,checkFlag:at==="AnnotViewsCustom",children:aR,expandingPreference:"AnnotationViews.Custom",noSelectAll:true,displayNbElems:true,displayTitle:false,className:"AnnotFilterMainSection",callback:r}));for(var aQ=0;aQ<z.length;aQ++){aq.appendChild(z[aQ].getContent())}T(aG.length+aL.length!==0,aa,aq)};var ad=function(){for(var aO=0;aO<q.length;aO++){if(q[aO].getContent().parentNode===V){q[aO].clear();V.removeChild(q[aO].getContent())}}if(L){V.removeChild(L);L=null}q.splice(0,q.length);var aI=[];var aS=0;if(ae&&ae.length){for(var aO=0;aO<ae.length;aO++){var aU=ae[aO];for(var aX=0;aX<aU.children.length;aX++){var aY=aU.children[aX];for(var aG=0;aG<aY.children.length;aG++){var aP=aY.children[aG];if((O===1&&aP.type!=="RootViews"&&aP.type!=="RootCaptures")||O!==1){var aC=aP.children;for(var aM=0;aM<aC.length;aM++){var aL=aC[aM];aL.checkFlagInCustomSection=aL.checkFlagInCustomSection!==undefined?aL.checkFlagInCustomSection:aL.isVisible;var aV=an(aL);if(aV!==""){if(!aI[aV]){aI[aV]=[]}var aH=aV==="Captures"||aV==="Views"?J:S;var aW=aV==="Captures"||aV==="Views"?aL.name+" / "+aY.referenceLabel+" / "+aY.name:aL.name;aI[aV].push(new k({id:"AnnotsCustom_"+aO+"_"+aX+"_"+aG+"_"+aM,idPath:[aO,aX,aG,aM],name:aW,icon:aL.icon,header:aW,isDisplayed:aL.isDisplayed,type:"checkbox",displayNbElems:false,displayTitle:true,className:"AnnotFilterLeaf",callback:aH,checkFlag:aL.checkFlagInCustomSection}));aS++;aL.view=aI[aV][aI[aV].length-1];aI[aV][aI[aV].length-1].setDisplayFlag(aL.isDisplayed)}}}}}}}q.push(new k({id:"AnnotsAll",name:"AnnotsAll",type:"radio",header:j.AllSectionLbl,checkFlag:aj==="AnnotsAll",callback:D,displayNbElems:true,displayTitle:false,nbElems:aS,className:"AnnotFilterMainSection"}));if(Q){var aD=[];for(var aO=0;aO<aw.length;aO++){var aJ=aw[aO];var aK=[];var aF=true;for(var aX=0;aX<aJ.types.length;aX++){var aN=aJ.types[aX];aK.push(new k({id:"AnnotsType_"+aO+"_"+aX,idPath:[aO,aX],name:aN.name.toString(),header:aN.name.toString(),type:"checkbox",displayNbElems:false,displayTitle:true,checkFlag:aN.checkFlag,className:"AnnotFilterLeaf",callback:t}));aN.view=aK[aK.length-1]}aD.push(new k({id:"AnnotsType_"+aO,idPath:[aO],name:aJ.name.toString(),header:m[aJ.name.toString()],type:"checkbox",className:"annotFilterSubSection",expandingPreference:"Annotations.Type."+aJ.name.toString(),children:aK,checkFlag:aF,noSelectAll:true,displayTitle:true}));aJ.view=aD[aD.length-1]}q.push(new k({id:"AnnotsType",name:"AnnotsType",header:j.TypeSectionLbl,type:"radio",checkFlag:aj==="AnnotsType",noSelectAll:true,displayTitle:false,className:"AnnotFilterMainSection",children:aD,callback:D,expandingPreference:"Annotations.Type"}))}var aT=["Views","Captures","Datums","GeomTolerances","Dimensions","Roughness","Welds","Notes","RestrictedAreas","Geometries"];var aR=[];for(var aO=0;aO<aT.length;aO++){var aQ=Object.keys(aI);for(var aX=0;aX<aQ.length;aX++){if(aQ[aX]===aT[aO]){aR[aQ[aX]]=aI[aQ[aX]];break}}}var aE=[];var aQ=Object.keys(aR);for(var aO=0;aO<aQ.length;aO++){var aF=true;var aZ=false;for(var aX=0;aX<aR[aQ[aO]].length;aX++){if(!aR[aQ[aO]][aX].getCheckFlag()){aF=false}if(aR[aQ[aO]][aX].isDisplayed()){aZ=true}}aE.push(new k({id:"AnnotsCustom"+aQ[aO].toString(),name:aQ[aO].toString(),type:"checkbox",header:l[aQ[aO].toString()],className:"annotFilterSubSection",isDisplayed:aZ,checkFlag:aF,noSelectAll:true,displayNbElems:true,displayTitle:true,children:aR[aQ[aO]],expandingPreference:"Annotations.Custom."+aQ[aO].toString()}));if(aQ[aO]==="Captures"){aE[aE.length-1].addBottomSeparator()}}q.push(new k({id:"AnnotsCustom",name:"AnnotsCustom",type:"radio",header:j.CustomSectionLbl,checkFlag:aj==="AnnotsCustom",children:aE,callback:D,displayNbElems:true,noSelectAll:true,displayTitle:false,expandingPreference:"Annotations.Custom",className:"AnnotFilterMainSection"}));if(O!==1){q.push(new k({id:"AnnotsNone",name:"AnnotsNone",type:"radio",header:j.NoneSectionLbl,checkFlag:aj==="AnnotsNone",callback:D,displayNbElems:false,noSelectAll:true,displayTitle:false,className:"AnnotFilterMainSection"}))}if(Q){q.push(new e({name:"AnnotsFilterByTol",checkFlag:I,callback:ai,formulaComponents:P,className:"AnnotFilterTolItem"}));q.push(new k({id:"AnnotsDisplayOnlyDefault",name:"AnnotsDisplayOnlyDefault",header:j.DefaultAnnotationsLbl,type:"checkbox",callback:A,displayNbElems:false,displayTitle:false,checkFlag:M,className:"AnnotFilterDefaultItem"}))}for(var aO=0;aO<q.length;aO++){if(q[aO].name==="AnnotsFilterByTol"){L=h.createElement("div",{"class":"AnnotFilterSeparator"});V.appendChild(L)}V.appendChild(q[aO].getContent())}T(aS!==0,ah,V)};var ac=function(){if(O===1){return}for(var aG=0;aG<y.length;aG++){if(y[aG].getContent().parentNode===am){y[aG].clear();am.removeChild(y[aG].getContent())}}y.splice(0,y.length);var aI=[];var aF=[];var aC;for(var aG=0;aG<ar.length;aG++){ar[aG].view=null;if(F&&F.indexOf(ar[aG].name)===-1&&ar[aG].isDisplayed){var aD=b[ar[aG].name]||(b.unknownAttribute+"("+ar[aG].name+")");ar[aG].view=new k({id:"AttributesType_"+aG,idPath:[aG],name:ar[aG].name,icon:ar[aG].icon,header:aD,type:"checkbox",displayNbElems:false,displayTitle:true,checkFlag:ar[aG].checkFlag,className:"AnnotFilterLeaf",callback:B});if(!isNaN(parseFloat(ar[aG].name))){if(ar[aG].name==="2"){aC=ar[aG].view}else{aF.push(ar[aG].view)}}else{aI.push(ar[aG].view)}}}var aE=(aC?1:0)+aI.length+aF.length;y.push(new k({id:"AttributesAll",name:"AttributesAll",type:"radio",header:j.AllSectionLbl,checkFlag:ay==="AttributesAll",callback:av,displayNbElems:true,displayTitle:false,nbElems:aE,className:"AnnotFilterMainSection"}));var aH=[];if(aC){aH.push(aC)}aH=aH.concat(aI);aH=aH.concat(aF);y.push(new k({id:"AttributesType",name:"AttributesType",type:"radio",header:j.TypeSectionLbl,checkFlag:ay==="AttributesType",callback:av,children:aH,displayNbElems:false,displayTitle:false,noSelectAll:aH.length<=1,expandingPreference:"Attributes.Type",className:"AnnotFilterMainSection"}));y.push(new k({id:"AttributesNone",name:"AttributesNone",type:"radio",header:j.NoneSectionLbl,checkFlag:aj==="AttributesNone",callback:av,displayNbElems:false,noSelectAll:true,displayTitle:false,className:"AnnotFilterMainSection"}));for(var aG=0;aG<y.length;aG++){am.appendChild(y[aG].getContent())}T(aE!==0,Y,am)};var U=function(){al("onFilterPanelResized")};var v=function(aC){return(aC.hiddenByDefaultFilter||aC.hiddenByTolFilter)};var ab=function(aE){if(aE.superType===1||aE.superType===2||aE.superType===8||aE.superType===9){return false}var aC;if(aE.toleranceLimits){var aD=aE.toleranceLimits;aC=aD.max-aD.min}else{aC=aE.toleranceValue}if(aC===undefined){return false}if(P.leftOperand==="equal"){return aC===P.leftValue}else{if(P.leftOperand==="infEqual"){if(P.rightOperand==="infEqual"){return(aC>=P.leftValue)&&(aC<=P.rightValue)}else{return(aC>=P.leftValue&&aC<P.rightValue)}}else{if(P.rightOperand==="infEqual"){return(aC>P.leftValue&&aC<=P.rightValue)}else{return(aC>P.leftValue&&aC<P.rightValue)}}}};var ag=function(aC){C.confirm(j.TooManyAnnotSetsLbl,j.WarningSectionLbl,function(aD){if(aD){if(aC.onAcceptCB){aC.onAcceptCB()}}else{if(aC.onCancelCB){aC.onCancelCB()}}})};var G=function(aH){if(ax!==aH.name){var aD=ax;ax=aH.name;var aG=[];if(ax==="AnnotSetAll"){for(var aC=0;aC<W.length;aC++){W[aC].setCheckFlag(W[aC].name===ax)}if(ae.length===1&&!ae[0].hasBeenEntirelyLoaded){return ag({idPath:[0],onAcceptCB:function(){ae[0].hasBeenEntirelyLoaded=true;ae[0].checkFlagInAllSection=true;for(var aI=0;aI<W.length;aI++){W[aI].setCheckFlag(W[aI].name===ax)}var aK=[];for(var aJ=0;aJ<ae[0].children.length;aJ++){if(!ae[0].children[aJ].isVisible){ae[0].children[aJ].isVisible=true;aK.push({idPath:[0,aJ],visuFlag:true})}}ak(true);al("onAnnotationSetsLoadingRequired",[{idPath:[0]}]);if(aK.length){al("onAnnotationsVisibilityModified",aK)}},onCancelCB:function(){G({name:aD});for(var aI=0;aI<W.length;aI++){W[aI].setCheckFlag(W[aI].name===ax)}ak(true)}})}else{for(var aC=0;aC<ae.length;aC++){for(var aE=0;aE<ae[aC].children.length;aE++){ae[aC].children[aE].isVisible=ae[aC].checkFlagInAllSection===undefined?ae[aC].hasBeenEntirelyLoaded:ae[aC].checkFlagInAllSection;aG.push({idPath:[aC,aE],visuFlag:ae[aC].children[aE].isVisible})}}}}else{if(ax==="AnnotSetAssemblyRoot"){for(var aC=0;aC<ae.length;aC++){if(ae.length===1||(ae.length>1&&ae[aC].checkFlagInAssySection)){for(var aE=0;aE<ae[aC].children.length;aE++){var aF=ae[aC].children[aE].isDirectChild;if(ae[aC].children[aE].isVisible!==aF){ae[aC].children[aE].isVisible=aF;aG.push({idPath:[aC,aE],visuFlag:aF})}}}}}else{if(ax==="AnnotSetCustom"){for(var aC=0;aC<ae.length;aC++){for(var aE=0;aE<ae[aC].children.length;aE++){if(ae[aC].children[aE].isVisible!==ae[aC].children[aE].checkFlagInCustomSection){ae[aC].children[aE].isVisible=ae[aC].children[aE].checkFlagInCustomSection;aG.push({idPath:[aC,aE],visuFlag:ae[aC].children[aE].checkFlagInCustomSection})}}}}else{if(ax==="AnnotSetNone"){for(var aC=0;aC<ae.length;aC++){for(var aE=0;aE<ae[aC].children.length;aE++){if(ae[aC].children[aE].isVisible){ae[aC].children[aE].isVisible=false;aG.push({idPath:[aC,aE],visuFlag:false})}}}}}}}ak(true);al("onAnnotationsVisibilityModified",aG)}for(var aC=0;aC<W.length;aC++){W[aC].setCheckFlag(W[aC].name===ax)}};var r=function(aL){if(O!==1){return}if(at!==aL.name||aL.forceRefresh){at=aL.name;var aI=[];var aF=[];var aQ=[];for(var aS=0;aS<ae.length;aS++){var aP=ae[aS];for(var aJ=0;aJ<aP.children.length;aJ++){var aR=aP.children[aJ];for(var aE=0;aE<aR.children.length;aE++){var aC=aR.children[aE];if(aC.type==="RootViews"||aC.type==="RootCaptures"){for(var aO=0;aO<aC.children.length;aO++){var aN=aC.children[aO];if(at==="AnnotViewsAll"){aN.isVisible=true;aI.push({idPath:[aS,aJ,aE,aO],visuFlag:true});var aG=aN.tpsList;for(var aH=0;aH<aG.length;aH++){var aD=aR.children[aG[aH][0]].children[aG[aH][1]];if(v(aD)){if(!aD.isVisible){continue}aD.isVisible=false;aI.push({idPath:[aS,aJ,aE,aO],visuFlag:false})}else{if(!aD.isVisible){aD.isVisible=true;if(aj!=="AnnotsCustom"){aj="AnnotsCustom"}aI.push({idPath:[aS,aJ,aG[aH][0],aG[aH][1]],visuFlag:true});aD.checkFlagInCustomSection=true}}}}else{if(at==="AnnotViewsCustom"){aN.isVisible=aN.checkFlagInCustomSection;aI.push({idPath:[aS,aJ,aE,aO],visuFlag:aN.checkFlagInCustomSection});var aG=aN.tpsList;for(var aH=0;aH<aG.length;aH++){var aD=aR.children[aG[aH][0]].children[aG[aH][1]];if(v(aD)){if(!aD.isVisible){continue}aD.isVisible=false;aI.push({idPath:[aS,aJ,aE,aO],visuFlag:false})}else{var aM=JSON.stringify([aS,aJ,aG[aH][0],aG[aH][1]]);if(aN.checkFlagInCustomSection&&aF.indexOf(aM)===-1){var aK=aQ.indexOf(aM);if(aK!==-1){aQ.splice(aK,1)}aF.push(aM);aD.isVisible=true;aD.checkFlagInCustomSection=true}else{if(!aN.checkFlagInCustomSection&&aQ.indexOf(aM)===-1&&aF.indexOf(aM)===-1){aQ.push(aM);aD.isVisible=false;aD.checkFlagInCustomSection=false}}}}}}}}}}}if(aF.length||aQ.length){if(aj!=="AnnotsCustom"){aj="AnnotsCustom"}for(var aS=0;aS<aF.length;aS++){aI.push({idPath:JSON.parse(aF[aS]),visuFlag:true})}for(var aS=0;aS<aQ.length;aS++){aI.push({idPath:JSON.parse(aQ[aS]),visuFlag:false})}}ak(false);al("onAnnotationsVisibilityModified",aI)}for(var aS=0;aS<z.length;aS++){z[aS].setCheckFlag(z[aS].name===at)}};var D=function(aI){if(aj!==aI.name||aI.forceRefresh){aj=aI.name;var aG=[];for(var aN=0;aN<ae.length;aN++){var aK=ae[aN];for(var aH=0;aH<aK.children.length;aH++){var aM=aK.children[aH];for(var aE=0;aE<aM.children.length;aE++){var aC=aM.children[aE];if((O===1&&aC.type!=="RootViews"&&aC.type!=="RootCaptures")||O!==1){for(var aJ=0;aJ<aC.children.length;aJ++){var aD=aC.children[aJ];if(aj==="AnnotsAll"){if(v(aD)){if(!aD.isVisible){continue}aD.isVisible=false;aG.push({idPath:[aN,aH,aE,aJ],visuFlag:false})}else{if(!aD.isVisible){aD.isVisible=true;aG.push({idPath:[aN,aH,aE,aJ],visuFlag:true})}}}else{if(aj==="AnnotsType"){var aL=null;for(var aF=0;aF<aw.length;aF++){for(var aO=0;aO<aw[aF].types.length;aO++){if(H(aD)===aw[aF].types[aO].type){aL=aw[aF].types[aO].checkFlag;break}}if(aL!==null){break}}if(v(aD)){if(!aD.isVisible){continue}aD.isVisible=false;aG.push({idPath:[aN,aH,aE,aJ],visuFlag:false})}else{if(aL!==aD.isVisible){aC.children[aJ].isVisible=aL;aG.push({idPath:[aN,aH,aE,aJ],visuFlag:aL})}}}else{if(aj==="AnnotsCustom"){if(v(aD)){if(!aD.isVisible){continue}aD.isVisible=false;aG.push({idPath:[aN,aH,aE,aJ],visuFlag:false})}else{if(aD.isVisible!==aD.checkFlagInCustomSection){aD.isVisible=aD.checkFlagInCustomSection;aG.push({idPath:[aN,aH,aE,aJ],visuFlag:aD.checkFlagInCustomSection})}}}else{if(aj==="AnnotsNone"){if(aD.isVisible){aD.isVisible=false;aG.push({idPath:[aN,aH,aE,aJ],visuFlag:false})}}}}}}}}}}al("onAnnotationsVisibilityModified",aG)}for(var aN=0;aN<q.length;aN++){if(q[aN].name!=="AnnotsDisplayOnlyDefault"&&q[aN].name!=="AnnotsFilterByTol"){q[aN].setCheckFlag(q[aN].name===aj)}else{if(q[aN].name==="AnnotsDisplayOnlyDefault"){q[aN].setCheckFlag(M)}else{if(q[aN].name==="AnnotsFilterByTol"){q[aN].setCheckFlag(I)}}}}};var av=function(aE){if(ay!==aE.name){ay=aE.name;var aD=[];for(var aC=0;aC<ar.length;aC++){if(ay==="AttributesAll"){aD.push({name:ar[aC].name,visuFlag:true})}else{if(ay==="AttributesType"){aD.push({name:ar[aC].name,visuFlag:ar[aC].checkFlag})}else{aD.push({name:ar[aC].name,visuFlag:false})}}}al("onAttributesVisibilityModified",aD)}for(var aC=0;aC<y.length;aC++){y[aC].setCheckFlag(y[aC].name===ay)}};var N=function(aE){if(!ae[aE.idPath[0]].hasBeenEntirelyLoaded){ag({idPath:aE.idPath,onAcceptCB:function(){ae[aE.idPath[0]].hasBeenEntirelyLoaded=true;ae[aE.idPath[0]].checkFlagInAllSection=true;ak(true);var aG=[];for(var aF=0;aF<ae[aE.idPath[0]].children.length;aF++){if(!ae[aE.idPath[0]].children[aF].isVisible){ae[aE.idPath[0]].children[aF].isVisible=true;aG.push({idPath:[aE.idPath[0],aF],visuFlag:true})}}al("onAnnotationSetsLoadingRequired",[{idPath:aE.idPath}]);if(aG.length){al("onAnnotationsVisibilityModified",aG)}},onCancelCB:function(){ak(true)}})}else{ae[aE.idPath[0]].checkFlagInAllSection=aE.checkFlag;var aD=[];for(var aC=0;aC<ae[aE.idPath[0]].children.length;aC++){aD.push({idPath:[aE.idPath[0],aC],visuFlag:aE.checkFlag});ae[aE.idPath[0]].children[aC].isVisible=aE.checkFlag}ak(true);al("onAnnotationsVisibilityModified",aD)}};var x=function(aE){ae[aE.idPath[0]].checkFlagInAssySection=aE.checkFlag;var aD=[];for(var aC=0;aC<ae[aE.idPath[0]].children.length;aC++){if(ae[aE.idPath[0]].children[aC].isDirectChild){aD.push({idPath:[aE.idPath[0],aC],visuFlag:aE.checkFlag});ae[aE.idPath[0]].children[aC].isVisible=aE.checkFlag}}ak(true);al("onAnnotationsVisibilityModified",aD)};var aA=function(aC){ae[aC.idPath[0]].children[aC.idPath[1]].checkFlagInCustomSection=aC.checkFlag;ae[aC.idPath[0]].children[aC.idPath[1]].isVisible=aC.checkFlag;ak(true);al("onAnnotationsVisibilityModified",[{idPath:aC.idPath,visuFlag:aC.checkFlag}])};var J=function(aG){ae[aG.idPath[0]].children[aG.idPath[1]].children[aG.idPath[2]].children[aG.idPath[3]].checkFlagInCustomSection=aG.checkFlag;ae[aG.idPath[0]].children[aG.idPath[1]].children[aG.idPath[2]].children[aG.idPath[3]].isVisible=aG.checkFlag;var aF=[{idPath:aG.idPath,visuFlag:aG.checkFlag}];var aE=ae[aG.idPath[0]].children[aG.idPath[1]].children[aG.idPath[2]].children[aG.idPath[3]].tpsList;var aH=ae[aG.idPath[0]].children[aG.idPath[1]];for(var aD=0;aD<aE.length;aD++){var aC=aH.children[aE[aD][0]].children[aE[aD][1]];if(v(aC)){if(!aC.isVisible){continue}aC.isVisible=false;aF.push({idPath:[aG.idPath[0],aG.idPath[1],aE[aD][0],aE[aD][1]],visuFlag:false})}else{if(aC.isVisible!==aG.checkFlag){aF.push({idPath:[aG.idPath[0],aG.idPath[1],aE[aD][0],aE[aD][1]],visuFlag:aG.checkFlag});aC.isVisible=aG.checkFlag;aC.checkFlagInCustomSection=aG.checkFlag}}}if(aj!=="AnnotsCustom"){aj="AnnotsCustom"}ak(false);al("onAnnotationsVisibilityModified",aF)};var S=function(aC){ae[aC.idPath[0]].children[aC.idPath[1]].children[aC.idPath[2]].children[aC.idPath[3]].checkFlagInCustomSection=aC.checkFlag;ae[aC.idPath[0]].children[aC.idPath[1]].children[aC.idPath[2]].children[aC.idPath[3]].isVisible=aC.checkFlag;ak(false);al("onAnnotationsVisibilityModified",[{idPath:aC.idPath,visuFlag:aC.checkFlag}])};var t=function(aH){aw[aH.idPath[0]].types[aH.idPath[1]].checkFlag=aH.checkFlag;var aF=[];var aI=aw[aH.idPath[0]].types[aH.idPath[1]].type;for(var aM=0;aM<ae.length;aM++){var aK=ae[aM];for(var aG=0;aG<aK.children.length;aG++){var aL=aK.children[aG];for(var aE=0;aE<aL.children.length;aE++){var aC=aL.children[aE];for(var aJ=0;aJ<aC.children.length;aJ++){var aD=aC.children[aJ];if(H(aD)===aI){if(v(aD)){if(!aD.isVisible){continue}aD.isVisible=false;aF.push({idPath:[aM,aG,aE,aJ],visuFlag:false})}else{if(aD.isVisible!==aH.checkFlag){aD.isVisible=aH.checkFlag;aF.push({idPath:[aM,aG,aE,aJ],visuFlag:aH.checkFlag})}}}}}}}ak(false);al("onAnnotationsVisibilityModified",aF)};var p=function(){for(var aF=0;aF<ae.length;aF++){var aC=ae[aF];for(var aH=0;aH<aC.children.length;aH++){var aG=aC.children[aH];for(var aI=0;aI<aG.children.length;aI++){var aD=aG.children[aI];if(aD.type!=="RootViews"&&aD.type!=="RootCaptures"){for(var aJ=0;aJ<aD.children.length;aJ++){var aE=aD.children[aJ];if(M&&!aE.isDefaultAnnot){aE.hiddenByDefaultFilter=true}else{aE.hiddenByDefaultFilter=false}if(I&&ab(aE)===false){aE.hiddenByTolFilter=true}else{aE.hiddenByTolFilter=false}}}}}}};var ai=function(aC){I=aC.checkFlag;P=aC.formulaComponents;p();ak(true);D({name:aj,forceRefresh:true})};var A=function(aC){M=aC.checkFlag;p();ak(true);D({name:aj,forceRefresh:true})};var B=function(aC){ar[aC.idPath[0]].visuFlag=aC.checkFlag;ar[aC.idPath[0]].checkFlag=aC.checkFlag;ak(false);al("onAttributesVisibilityModified",[ar[aC.idPath[0]]])};var al=function(aD,aC){return aB.publish({event:aD,data:aC,context:this})}}});return n});define("DS/CAT3DAnnotationCommands/controllers/CAT3DAnnotationFilterController",["UWA/Class","DS/CoreEvents/ModelEvents","DS/CAT3DAnnotationCommands/panels/CAT3DAnnotationFilterPanel","DS/CATWebUXComponents/CATWebUXPanel","DS/CAT3DAnnotationController/CAT3DAnnotationController","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtilsOptions","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/WebappsUtils/WebappsUtils","i18n!DS/CAT3DAnnotationCommands/assets/nls/CAT3DAnnotationCommands"],function(a,c,l,m,h,i,j,d,e,g){var b=a.extend({init:function(S){var G=S||{};this._parent(G);var v=i.getOption("CAT3DANN_FILTER_PANEL_VER1")?1:2;var ad=false;var R;var y;var D=G.ctxViewer;var Y;var M;var ac=200;var F=ac;var A=false;var n=[];var ab=[];var Q={};var P={};var w={};var J={};var O;var T=d.subscribe("onPreferenceModified",function(am){if(am.preference.indexOf("3DAnnotSemAttr_")!==-1){var al=am.preference.substring(am.preference.indexOf("_")+1,am.preference.length);var ai=r.getAttributeTypesFiltered();var ah;for(O=0;O<ab.length;O++){if(ab[O].name===al){ab[O].filteredByPref=!am.value;ah=true;break}}if(!ah){ab.push({name:al,filteredByPref:!am.value,filtered:false})}var ak=r.getAttributeTypesFiltered();ag();var aj=ak.length!==ai.length;if(!aj){for(O=0;O<ak.length;O++){if(ai.indexOf(ak[O])===-1){aj=true;break}}}if(aj){Z("onAttributesVisibilityModified",{attributesFiltered:ak})}}});var V=0;var r=this;var af=new c();var K=true;var W=false;var H=0;var p=0;var U=150;var E=0;var ae=true;var q=false;var x=false;var C=false;this.setActiveState=function(ah){ad=ah;if(!R||!y){var ai=setInterval(function(){y=j.giveAnnotationModelLoader({context:D});R=h.giveAnnotationController({context:D});if(R&&y&&y.getLoaderType()!=="undefined"){clearInterval(ai);r.setActiveState(ad);return}},10);return}if(!r.getDataModel){R.onAdditionalInfosRequired({controller:"AnnotFilter",cb:function(){r.setActiveState(ad)}});return}p=0;var ap;if(ad){if(!A){var al=function(){ae=true;ag(true)};x=!(R.getActiveState()&&y.getActiveState());var an=function(){if(R.getActiveState()&&y.getActiveState()){x=false;ag(true)}else{N();x=true}};Q.onLoadingComplete=D.subscribe({event:"onLoadingComplete"},al);Q.onLoadingFailure=D.subscribe({event:"onLoadingFailure"},al);Q.onLoadingCanceled=D.subscribe({event:"onLoadingCanceled"},al);Q.onRootRemovedToken=D.subscribe({event:"onRootRemoved"},function(){ae=true;U=0;ag(true)});P.onAnnotControllerActiveStateChanged=R.subscribe("onAnnotControllerActiveStateChanged",an);P.onAnnotationsLinkedDataSolved=R.subscribe("onAnnotationsLinkedDataSolved",function(ar){if(ar.succeeded===true){ag()}});w.onAnnotModelLoaderActiveStateChanged=y.subscribe("onAnnotModelLoaderActiveStateChanged",an);w.onAnnotationVisibilityModifiedToken=y.subscribe("onAnnotationVisibilityModified",function(ar){ag(ar.annotNode.getAnnotationClassType()==="tpsAnnotationSet")});w.onAnnotationSetLoadingFailedToken=y.subscribe("onAnnotationSetLoadingFailed",function(){ae=true;I(true);ag(true)});w.onAnnotationSetLoadedToken=y.subscribe("onAnnotationSetLoaded",function(){ae=true;I(true);ag(true)});w.onAnnotationSetPartiallyLoaded=y.subscribe("onAnnotationSetPartiallyLoaded",function(){ae=true;I(true);ag(true)});w.onAnnotationSetRemovedToken=y.subscribe("onAnnotationSetRemoved",function(){ae=true;ag(true)});w.onAnnotationSetBeginLoadToken=y.subscribe("onAnnotationSetBeginLoad",function(){ae=false;I(false)});w.onAnnotationSetLoadingCanceledToken=y.subscribe("onAnnotationSetLoadingCanceled",function(){ae=true;I(true);ag(true)});w.onNoAnnotationSetLoadedToken=y.subscribe("onNoAnnotationSetLoaded",function(ar){if(ar&&ar.loadingAlreadyStarted){ae=true;I(true)}ag(true)});P.onViewOrCaptureDisplayedToken=R.subscribe("onViewOrCaptureDisplayed",function(){ae=true;ag()});w.onVisuModificationToken=y.subscribe("onAnnotationParentVisibilityModified",function(){ag(true)});V=D.getViewer().onSwapVisibleSpace?D.getViewer().onSwapVisibleSpace(function(){C=D.getViewer().getVisibleSpace()===0;if(D.getViewer().getVisibleSpace()===1){ag(true)}else{N()}}):null;C=D.getViewer().getVisibleSpace()===0;var ao=o();for(ap=0;ap<ao.length;ap++){var ak=false;for(var aj=0;aj<ab.length;aj++){if(ab[aj].name===ao[ap]){ak=true;ab[aj].filteredByPref=true;break}}if(!ak){ab.push({name:ao[ap],filteredByPref:true,filtered:false})}}A=true}var am=ae;ae=true;ag(true);ae=am}else{if(A){var aq=Object.keys(Q);for(ap=0;ap<aq.length;ap++){D.unsubscribe(Q[aq[ap]])}aq=Object.keys(P);for(ap=0;ap<aq.length;ap++){R.unsubscribe(P[aq[ap]])}aq=Object.keys(w);for(ap=0;ap<aq.length;ap++){y.unsubscribe(w[aq[ap]])}if(V&&D.getViewer()){D.getViewer().unsubscribe(V)}V=0;Q={};P={};w={};N(true);A=false}if(H){clearTimeout(H);H=0}if(E){clearTimeout(E);E=0}n.splice(0,n.length);for(ap=ab.length-1;ap>=0;ap--){if(ab[ap].filtered){if(!ab[ap].filteredByPref){ab.splice(ap,1)}else{ab[ap].filtered=false}}}ae=true}Z("onAnnotationFilterActiveStateModified",{state:ad})};this.getActiveState=function(){return ad};this.setPanelVisibilityFlag=function(ah){K=ah;if(M&&n){M.setPanelVisibilityFlag(K&&n.length!==0)}};this.getPanelVisibilityFlag=function(){return K};this.clearController=function(){this.setActiveState(false);if(T){d.unsubscribe(T)}T=0;if(Y){var ai=Object.keys(J);for(var ah=0;ah<ai.length;ah++){Y.unsubscribe(J[ai[ah]])}}J={};if(M){M.clean()}R=y=D=Y=M=n=ab=af=r=null};this.getAttributeTypesFiltered=function(){var ai=[];for(var ah=0;ah<ab.length;ah++){if(ab[ah].filteredByPref||ab[ah].filtered){ai.push(ab[ah].name)}}return ai};var o=function(){var ai=d.getPreference("3DAnnotAttributesOrderedList");for(var ah=ai.length-1;ah>=0;ah--){if(d.getPreference("3DAnnotSemAttr_"+ai[ah])){ai.splice(ah,1)}}return ai};this.subscribe=function(ai,ah){if(!ai||!ah){return undefined}return af.subscribe({event:ai},ah)};this.unsubscribe=function(ah){if(!af||!ah){return}af.unsubscribe(ah)};var aa=function(ah){if(n&&n.length&&n[ah[0]]){var ai=n[ah[0]];if(ah.length===1){return ai.path}if(ai.children&&ai.children[ah[1]]){var aj=ai.children[ah[1]];if(ah.length===2){return aj.path}if(aj.path){var ak=aj.path.getChildrenPathes();if(ak&&ak.length&&ak[ah[2]]){var am=ak[ah[2]];if(ah.length===3){return am}var al=ak[ah[2]].getChildrenPathes();if(al&&al.length&&al[ah[3]]){return al[ah[3]]}}}}}return undefined};var I=function(ah){if(ad){p+=ah===true?1:-1;if(E){clearTimeout(E);E=0}if(M){M.setEnableFlag(p>=0);if(p<0){E=setTimeout(function(){if(ad&&M){M.setEnableFlag(true)}p=0},20000)}}}};var ag=function(ah){if(q||!ae||!ad||x||C||!R.getActiveState()){return}if(ah){W=ah}if(H){clearTimeout(H);H=0}H=setTimeout(function(){r._internalRefresh();U=150;H=0},U)};var N=function(ah){if(H){clearTimeout(H);H=0}if(M){F=M.getWidth();M.clean();M=null}if(Y){Y.cleanPanel(ah)}};this._internalRefresh=function(){if(!ad||!r||typeof r.getDataModel!=="function"){return}if(W){n.splice(0,n.length);if(!M){s()}r.getDataModel(function(aj){if(!ad){return}n=aj;for(var ai=n.length-1;ai>=0;ai--){var ah=y.hasAlreadyBeenLoaded(n[ai].path);n[ai].hasBeenEntirelyLoaded=ah===1||ah===2||ah===3;if(n[ai].hasBeenEntirelyLoaded&&n[ai].children.length===0){n.splice(ai,1)}}X(false);M.setPanelVisibilityFlag(K&&n.length!==0);if(n.length){M.setEnableFlag(p>=0)}})}else{X(true);if(M&&n){M.setPanelVisibilityFlag(K&&n.length!==0)}}};var s=function(){N();if(!Y){Y=new l({style:{version:v,semanticUI:R.getAnnotationControllerType()==="3DAnnotationInsight"}});J={};J.onFilterPanelResized=Y.subscribe("onFilterPanelResized",u);J.onAnnotationSetsLoadingRequired=Y.subscribe("onAnnotationSetsLoadingRequired",z);J.onAnnotationsVisibilityModified=Y.subscribe("onAnnotationsVisibilityModified",L);J.onAttributesVisibilityModified=Y.subscribe("onAttributesVisibilityModified",t)}if(!M){var ah;if(sessionStorage.getItem("CAT3DAnnotFilterExpFlag_"+widget.id)==="true"){ah=parseFloat(sessionStorage.getItem("CAT3DAnnotFilterWidth_"+widget.id))}if(!ah){ah=F!==undefined?F:ac}F=ah;var ai={id:"CAT3DAnnotFilterPanel",className:"CAT3DAnnotFilterSidePanel",title:g.FilterPanelTitle,showTitleFlag:false,icon:e.getWebappsAssetUrl("CAT3DAnnotationCommands","icons/32/")+"I_CAT3DAnnotFilter.png",frameWindow:D.getFrameWindow(),immersiveFrame:D.getFrameWindow().getImmersiveFrame(),content:Y.buildPanel({model:n,attrTypesFilteredByPref:o(),attrTypesOrderedList:d.getPreference("3DAnnotAttributesOrderedList")}),minHeight:330,minWidth:ac,width:ah,allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea,currentDockArea:WUXDockAreaEnum.RightDockArea,onPanelResizedCB:function(aj){if(aj.currentDockArea===WUXDockAreaEnum.RightDockArea||aj.currentDockArea===WUXDockAreaEnum.LeftDockArea){F=aj.width;if(aj.widthModifiedInteractively){sessionStorage.setItem("CAT3DAnnotFilterExpFlag_"+widget.id,"true");sessionStorage.setItem("CAT3DAnnotFilterWidth_"+widget.id,aj.width)}}}};M=new m(ai)}else{Y.buildPanel(n)}if(M&&n){M.setPanelVisibilityFlag(K&&n.length!==0)}M.setEnableFlag(p>=0)};var X=function(ak){if(!Y){return}if(ak){for(var ai=0;ai<n.length;ai++){for(var aj=0;aj<n[ai].children.length;aj++){var ah=n[ai].children[aj].path.getLastElement(true).toJSON();Object.assign(n[ai].children[aj],ah)}}}Y.updatePanel({model:n,attrTypesFilteredByPref:o(),attrTypesOrderedList:d.getPreference("3DAnnotAttributesOrderedList")})};var B=o();for(var O=0;O<B.length;O++){ab.push({name:B[O],filteredByPref:true,filtered:false})}var u=function(){if(sessionStorage){var ah=sessionStorage.getItem("CAT3DAnnotFilterExpFlag_"+widget.id);if(ah==="true"){sessionStorage.setItem("CAT3DAnnotFilterExpFlag_"+widget.id,"false");M.setWidth(ac)}else{var ai=parseFloat(sessionStorage.getItem("CAT3DAnnotFilterWidth_"+widget.id));if(ai&&ai!==ac){sessionStorage.setItem("CAT3DAnnotFilterExpFlag_"+widget.id,"true");M.setWidth(ai)}}}};var z=function(ai){var ah=aa(ai[0].idPath);y.loadFTALightModel(ah,true,true)};var L=function(ai){q=true;for(var ah=0;ah<ai.length;ah++){var aj=aa(ai[ah].idPath);if(aj){aj.getLastElement(true).setVisibility(ai[ah].visuFlag)}}D.getViewer().render();q=false};var t=function(am){var al=false;var an=r.getAttributeTypesFiltered(),aj;for(aj=0;aj<am.length;aj++){var ah=null;for(var ak=0;ak<ab.length;ak++){if(ab[ak].name===am[aj].name){ah=ak;break}}if(ah!==null){ab[ah].filtered=!am[aj].visuFlag}else{ab.push({name:am[aj].name,filtered:!am[aj].visuFlag,filteredByPref:false})}}var ai=r.getAttributeTypesFiltered();al=ai.length!==an.length;if(!al){for(aj=0;aj<ai.length;aj++){if(an.indexOf(ai[aj])===-1){al=true;break}}}if(al){Z("onAttributesVisibilityModified",{attributesFiltered:ai})}};var Z=function(ai,ah){return af.publish({event:ai,data:ah,context:this})}}});var f=[];var k=a.singleton({init:function(){},give3DAnnotFilterController:function(o){if(o&&o.context){for(var n=0;n<f.length;n++){if(f[n].context===o.context){return f[n].filterController}}}return undefined},get3DAnnotFilterController:function(o){var p;if(o&&o.context){p=this.give3DAnnotFilterController(o);if(!p){var n=new b({ctxViewer:o.context});p=Object.freeze({setActiveState:function(q){if(n){n.setActiveState(q)}},getActiveState:function(){if(n){return n.getActiveState()}return null},clearController:function(){if(n){n.clearController();n=null}},getAttributeTypesFiltered:function(){if(n){return n.getAttributeTypesFiltered()}return null},setPanelVisibilityFlag:function(q){if(n){n.setPanelVisibilityFlag(q)}},getPanelVisibilityFlag:function(){if(n){return n.getPanelVisibilityFlag()}return null},subscribe:function(r,q){if(n){return n.subscribe(r,q)}return null},unsubscribe:function(q){if(n){n.unsubscribe(q)}},setDataModelMethod:function(q){if(n&&!n.dataModelInitialized){n.getDataModel=q;n.dataModelInitialized=true;if(n.getActiveState()){n._internalRefresh()}}}});f.push({context:o.context,filterController:p})}}return p},unreference3DAnnotFilterController:function(o){if(o&&o.context){for(var n=0;n<f.length;n++){if(f[n].context===o.context){f[n].filterController.clearController();f.splice(n,1);break}}}}});return k});define("DS/CAT3DAnnotationCommands/CAT3DAnnotationFilterCmd",["DS/ApplicationFrame/CommandCheckHeader","DS/PADUtils/PADContext","DS/CAT3DAnnotationCommands/controllers/CAT3DAnnotationFilterController"],function(d,c,b){var a=d.extend({init:function(h){this._parent(h,{});var k=this;var i=c.get();var g=b.get3DAnnotFilterController({context:i});var j=this.onStateChange(function(){g.setActiveState(k.getState());localStorage.setItem("CAT3DAnnotationFilterCmd",k.getState()?"true":"false")});var f=this._destroy;this._destroy=function(){if(i){b.unreference3DAnnotFilterController({context:i})}k._modelEvents.unsubscribe(j);f.call(k)};var e=localStorage.getItem("CAT3DAnnotationFilterCmd");e=e==="true"?true:(e==="false"?false:undefined);this.setState(e===false?false:true,true)},_destroy:function(){this._parent()}});return a});define("DS/CAT3DAnnotationExpController/CAT3DAnnotExpControllerInstance",["DS/CAT3DAnnotationController/CAT3DAnnotBaseControllerInstance","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/CAT3DAnnotationCommands/controllers/CAT3DAnnotationFilterController","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader","DS/CATWebUXSlideShow/CATWebUXSlideShowController"],function(g,c,e,d,b,a){var f=g.extend({init:function(o){var j=o||{};this._parent(j);var l=j.workbenchName||"CAT3DAnnotationWidgetWkb";var z=j.moduleName||"CAT3DAnnotationWidget";var t=j.ctxViewer;var s=this;var i;var y;var w,k;var v=this.setActiveState;this.setActiveState=function(B){v(B);if(B&&!i){var A=setInterval(function(){i=b.giveAnnotationModelLoader({context:t});if(i){clearInterval(A);s.setActiveState(B);return}},10);return}if(B&&!y){y={};w=t.isDefaultContextualBarVisible();if(w){t.setDefaultContextualBarVisibility(false)}k=t.isRobotVisible();if(k){t.setRobotVisibility(false)}y.onAddHSO=e.onAdd(s.onAddHSOCB);y.onRemoveHSO=e.onRemove(s.onRemoveHSOCB);t.getFrameWindow().getContextualUIManager().register({onContextualBarReady:function(){var D=s.getContextualCommandList();return D.length?{cmdList:D}:undefined},context:t.getCommandContext?t.getCommandContext():null,workbenchName:l,module:z,cmdPrefix:"",subscriberId:z,merge:true});var C=a.giveSlideShowController({context:t.getFrameWindow(),id:"CAT3DAnnotationSlideShow"});if(C){C.setListOfCommandsAllowed(["CAT3DAnnotationWidgetDefaultHdr"])}}else{if(!B&&y){if(w!==undefined){t.setDefaultContextualBarVisibility(w)}w=undefined;if(k!==undefined){t.setRobotVisibility(k)}k=undefined;if(y.onAddHSO){e.unsubscribe(y.onAddHSO)}if(y.onRemoveHSO){e.unsubscribe(y.onRemoveHSO)}if(t.getFrameWindow()){t.getFrameWindow().getContextualUIManager().unregister(z)}y=null}}};var u=this.clearController;this.clearController=function(){u();t=s=i=null};var n=this.onAdditionalInfosRequired;this.onAdditionalInfosRequired=function(A){if(A.controller==="AnnotFilter"){require(["DS/CAT3DAnnotationCommands/controllers/CAT3DAnnotationFilterController"],function(C){var B=C.give3DAnnotFilterController({context:t});if(B&&B.setDataModelMethod){B.setDataModelMethod(s._getJSONModel)}A.cb()})}else{n(A)}};var p=this.getAnnotControllerPrototype;this.getAnnotControllerPrototype=function(){var A=p();A.getAssociatedInformations=function(B){if(s){return s.getAssociatedInformations(B)}return undefined};return A};this.getAnnotationControllerType=function(){return"3DAnnotationExperience"};var m=this._disableAnnotUI,q=false;this._disableAnnotUI=function(){m();require(["DS/CAT3DAnnotationCommands/controllers/CAT3DAnnotationFilterController"],function(B){var A=B.give3DAnnotFilterController({context:t});if(A&&A.getActiveState()){q=A.getPanelVisibilityFlag();A.setPanelVisibilityFlag(false)}})};var h=this._enableAnnotUI;this._enableAnnotUI=function(){h();require(["DS/CAT3DAnnotationCommands/controllers/CAT3DAnnotationFilterController"],function(B){var A=B.give3DAnnotFilterController({context:t});if(A){A.setPanelVisibilityFlag(q)}})};var r=this._onCommandStartCB;this._onCommandStartCB=function(A){r(A)};var x=this.getAssociatedInformations;this.getAssociatedInformations=function(A,C){var B=C;if(!B){B=d.give3DAnnotFilterController({context:t})}return x(A,B)};this.getContextualCommandList=function(){var C=[],J;if(!t){return C}var K=[];var E=c.get();var G=t.getRootBagPath();for(J=0;J<E.length;J++){if(E[J].pathElement&&G.isAParentOf(E[J].pathElement)){K.push(E[J].pathElement)}}if(K.length===0){return C}var A=false,F=false;for(J=0;J<K.length;J++){if(!A){var H=s._getSelectedAnnotationsVisibilityFlag();if(H===true||H===false||H===undefined){var D;if(E.length===1&&((E[0].pathElement.getLastElement(true).getAnnotationClassType&&E[0].pathElement.getLastElement(true).getAnnotationClassType()==="tpsAnnotationSet")||!E[0].pathElement.getLastElement(true).getAnnotationClassType)){D=H?"CAT3DAnnotationSetHideHdr":"CAT3DAnnotationSetShowHdr"}else{D=H?"CAT3DAnnotationHideHdr":"CAT3DAnnotationShowHdr"}C.push({line:1,name:H?"CAT3DAnnotationHideStr":"CAT3DAnnotationShowStr",hdr_list:[D]});A=true}}var I=K[J].getParentPath();var B=K[J].getLastElement(true);if(((B.getAnnotationClassType&&B.getAnnotationClassType()!=="tpsAnnotationSet")||!B.getAnnotationClassType)&&K.length===1){if(!F){if(I&&I.getLastElement(true).name!=="RootBag"){C.push({line:1,name:"CAT3DAnnotationLevelSelectorStr",hdr_list:["CAT3DAnnotationLevelSelectorHdr"]});F=true}}}if(K.length===1&&I.getLastElement(true).name==="RootBag"){C.push({name:"CAT3DAnnotationRemoveRootStr",line:1,hdr_list:["RemoveRootHdr"]})}}return C};this.onAddHSOCB=function(){};this.onRemoveHSOCB=function(){}}});return f});define("DS/CAT3DAnnotationModel/CAT3DAnnotationViewNode",["DS/CAT3DAnnotationModel/CAT3DAnnotationNode","DS/WebappsUtils/WebappsUtils"],function(b,c){var a=b.extend({init:function(d){var d=d||{};this._parent(d);var i=d.thumbnail?"data:image/png;base64,"+d.thumbnail:null;var h=false;var g=[];var f;var e;this.getAnnotationIcon=function(){if(f){return f}var j=this.getAnnotationType();var k=this.isMultiSectionView();f=c.getWebappsAssetUrl("CAT3DAnnotationRsc","icons/22/");if(j===1&&!k){f+="I_W3DAnnot_ProjectionView"}else{if(j===2||k){f+="I_W3DAnnot_SectionView"}else{if(j===3){f+="I_W3DAnnot_SectionCutView"}else{f+="I_W3DAnnot_AxoView"}}}f+=".png";return f};this.isSubView=function(){return h};this.setIsSubView=function(j){h=j};this.setPreview=function(j){i=j};this.getPreview=function(){return i};this.getAnnotationClassType=function(){return"tpsView"};this.getViewType=function(){if(e){return e}var k=this.isMultiSectionView();var j=this.getAnnotationType();if(j===1&&!k){e="ProjectionView"}else{if(j===2||k){e="SectionView"}else{if(j===3){e="SectionCutView"}else{e="AxonometricView"}}}return e};this.getViewPlane=function(){return d.viewPlane};this.getViewPlaneInformations=function(){return{direction:d.viewDirection,origin:d.viewOrigin,normal:d.viewNormal}};this.getCappingRep=function(){return d.cappingRep};this.getReframeArea=function(){return d.reframeArea};this.getVisibleAnnotations=function(r,z){var w=r.getLastElement?r.getLastElement(true):r;var o=[];var y;if(d.TPSs){for(var l=0;l<d.TPSs.length;l++){var p=false;var x=w.children;for(var v=0;v<x.length;v++){var t=x[v];if(t.getAnnotationType()!=="RootViews"&&t.getAnnotationType()!=="RootCaptures"){var j=t.children;for(var q=0;q<j.length;q++){if(j[q].getAnnotationID()===d.TPSs[l]){if(r.getLastElement){y=r.clone();y.addElement(t);y.addElement(j[q]);o.push(y)}else{o.push(j[q])}p=true;break}}}if(p){break}}}}var n=[];if(o&&o.length&&z){var u=w.getRootAnnotationNode("RootGeometries");if(u){for(var v=0;v<o.length;v++){var k=o[v].getLastElement?o[v].getLastElement(true):o[v];if(k.getAnnotationTTRS){var m=k.getAnnotationTTRS();if(m){var s=u.children;for(var q=0;q<s.length;q++){if(s[q].getAnnotationTTRS()&&s[q].getAnnotationTTRS().equals(m)){if(r.getLastElement){y=r.clone();y.addElement(u);y.addElement(s[q]);n.push(y)}else{n.push(s[q])}}}}}}}}return o.concat(n)};this.isMultiSectionView=function(){if(d.multiClipping){if(d.multiClipping.SketchNormal&&d.multiClipping.SketchOrigin){if(d.multiClipping.views&&d.multiClipping.views.length&&d.multiClipping.views.length>1){if(d.multiClipping.pointsDef&&d.multiClipping.pointsDef.length){return true}}}}return false};this.getMultiSectionData=function(){return d.multiClipping};this.setAssociatedCapture=function(j){g.push(j)};this.getAssociatedCapture=function(){return g};this.getTPSList=function(){return d.TPSs};this.getAnnotationSupertype=function(){return 11}},toJSON:function(){if(!this.jsonObject){this._parent();var i=this.parents[0].parents[0];var h=this.getVisibleAnnotations(i,true);var f=[];for(var e=0;e<h.length;e++){var d=h[e].parents[0];var j=null;var k=null;for(var g=0;g<i.children.length;g++){if(d.getAnnotationType()===i.children[g].getAnnotationType()){j=g;break}}for(var g=0;g<i.children[j].children.length;g++){if(h[e].getAnnotationID()===i.children[j].children[g].getAnnotationID()){k=g;break}}if(j!==null&&k!==null){f.push([j,k])}}if(this.getAnnotationIcon()!==undefined){this.jsonObject.icon=this.getAnnotationIcon()}if(this.getAnnotationType()!==undefined){this.jsonObject.type=this.getAnnotationType()}if(this.getAnnotationSupertype()!==undefined){this.jsonObject.superType=this.getAnnotationSupertype()}if(this.isSubView()!==undefined){this.jsonObject.isSubView=this.isSubView()}if(this.getAssociatedCapture()!==undefined){this.jsonObject.associatedCapture=this.getAssociatedCapture()}if(this.isMultiSectionView()!==undefined){this.jsonObject.isMultiSectionView=this.isMultiSectionView()}if(this.getViewPlaneInformations()!==undefined){this.jsonObject.viewPlaneInformations=this.getViewPlaneInformations()}if(this.getMultiSectionData()!==undefined){this.jsonObject.multiSectionData=this.getMultiSectionData()}if(this.getReframeArea()!==undefined){this.jsonObject.reframeArea=this.getReframeArea()}if(f!==undefined){this.jsonObject.tpsList=f}}else{this._parent()}if(this.getPreview()!==undefined){this.jsonObject.preview=this.getPreview()}return this.jsonObject}});return a});define("DS/CAT3DAnnotationModel/CAT3DAnnotationLoader",["UWA/Core","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationVisuLoader","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Visualization/LoaderUtils","DS/CAT3DAnnotationModel/CAT3DAnnotationNode","DS/CAT3DAnnotationModel/CAT3DAnnotationViewNode","DS/CAT3DAnnotationModel/CAT3DAnnotationSetNode","DS/CAT3DAnnotationModel/CAT3DAnnotationRootNode","DS/CAT3DAnnotationModel/CAT3DAnnotationCaptureNode"],function(d,h,i,f,c,e,g,b,k,j){var a=h.extend({init:function(m){var l=m||{};this._parent(l);var n=this;this.getType=function(){return"NoSemantic"};this.createAnnotationSet=function(s,q,o){var t=new b(d.extend(o,{onAnnotationAttrModifiedCB:q},true));if(s!==undefined&&s!==null){t.setVisibility(s)}for(var r=0;r<12;r++){var p=new k({annotController:n,rootType:r+1});t.addChild(p)}return t};this.postProcessViewsAndCaptures=function(o){var p=o.getRootAnnotationNode("RootCaptures");var u=o.getRootAnnotationNode("RootViews");var v,s,t;if(u&&u.children.length){for(v=0;v<u.children.length;v++){t=u.children[v];var r=t.getMultiSectionData?t.getMultiSectionData():null;if(r&&r.views){for(s=0;s<r.views.length;s++){u.children[r.views[s]-1].setIsSubView(true)}}}}if(p&&p.children.length&&u&&u.children.length){for(v=0;v<p.children.length;v++){var w=p.children[v];var q=w.getPointedView();if(q){for(s=0;s<u.children.length;s++){t=u.children[s];if(t.getAnnotationID()===q){t.setAssociatedCapture(w.getAnnotationID())}}}}}};this.isAnnotationCorrect=function(o){if(!o){return false}if(o.getAnnotationType()===null||o.getAnnotationType()===undefined||isNaN(o.getAnnotationType())){return false}if(o.getAnnotationClassType()==="tps"&&(o.getAnnotationType()>54||o.getAnnotationType()<=0)){return false}return true}},loadAnnotation:function(s){var v;if(s.nodeInfo.type===6){return}else{if(s.nodeInfo.nodeXMLtype==="AnnotationSet"){if(s.nodeInfo.standards||s.nodeInfo.standardNorms){s.annotationSetNode.getSemanticStandards=function(){return{standards:s.nodeInfo.standards,defaultSpecs:s.nodeInfo.standardNorms,stdName:s.nodeInfo.standard}}}if(s.nodeInfo.hyperlinksData&&s.nodeInfo.hyperlinksData.length){var n=[];for(v=0;v<s.nodeInfo.hyperlinksData.length;v++){if(s.nodeInfo.hyperlinksData[v].type&2){n.push(s.nodeInfo.hyperlinksData[v])}}if(n.length){s.annotationSetNode.getLinkedDataRelatedInfos=function(){return n}}}}else{var w=Object.keys(s.nodeInfo);if(w.length){var o={onAnnotationAttrModifiedCB:s.cb,reps:[]};for(var p=0;p<w.length;p++){if(w[p]==="cappingRep"){o.cappingRep=this.createCappingRep(s.nodeInfo)}else{if(w[p]==="planeInfos"){var t=s.nodeInfo.planeInfos.direction;o.viewDirection=new i.Vector3(t.x,t.y,t.z);var r=s.nodeInfo.planeInfos.normal;o.viewNormal=new i.Vector3(r.x,r.y,r.z);var u=s.nodeInfo.planeInfos.origin;o.viewOrigin=new i.Vector3(u.x,u.y,u.z)}else{o[w[p]]=s.nodeInfo[w[p]]}}}var m;var q=-1;if(s.nodeInfo.nodeXMLtype==="TPS"||s.nodeInfo.nodeXMLtype==="TPSCG"){m=new e(o);q=m.getAnnotationSupertype()+1}else{if(s.nodeInfo.nodeXMLtype==="TPSView"){q=0;m=new g(o)}else{if(s.nodeInfo.nodeXMLtype==="TPSCap"){q=1;m=new j(o)}}}if(q!==-1&&s.annotationSetNode&&s.annotationSetNode.children[q]&&this.isAnnotationCorrect(m)){s.annotationSetNode.children[q].addChild(m);s.nodeInfo.rootIndex=q}if(s.nodeInfo.nodeXMLtype.indexOf("TPSAttribute")===-1){if(s.nodeInfo.toleranceZoneValue!==undefined){m.getAnnotationToleranceZoneValue=function(){return s.nodeInfo.toleranceZoneValue}}if(s.nodeInfo.dimensionLimits!==undefined){m.getAnnotationDimensionLimits=function(){return s.nodeInfo.dimensionLimits}}if(s.nodeInfo.genTol!==undefined){m.getGeneralTolerance=function(){return s.nodeInfo.genTol}}if(s.nodeInfo.tabLimit!==undefined){m.getTabulatedLimit=function(){return s.nodeInfo.tabLimit}}if(s.nodeInfo.hyperlinksData&&s.nodeInfo.hyperlinksData.length){var l=[];for(v=0;v<s.nodeInfo.hyperlinksData.length;v++){if(s.nodeInfo.hyperlinksData[v].type&2){l.push(s.nodeInfo.hyperlinksData[v])}}if(l.length){m.getLinkedDataRelatedInfos=function(){return l}}}}if(s.nodeInfo.reps){this.createReps(s.nodeInfo,s.processText,s.annotationSetNode.getContextType(),m)}}}}}});return a});