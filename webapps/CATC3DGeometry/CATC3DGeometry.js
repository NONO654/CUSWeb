/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CATC3DGeometry/CATC3DGeometryEnums",[],function(){var a={};a.GeometryType={POINT:0,CURVE:2,LINE:3,CIRCLE:4,SURFACE:5,PLANE:6,CYLINDER:7,CONE:8,SPHERE:9,AXISSYSTEM:11,AXISSYSTEMAXIS:12,AXISSYSTEMORIGIN:13,AXIS:14,AXISX:15,AXISY:16,AXISZ:17,REFPLANE:18};a.GeometryMode={REAL:0,TRANSIENT:1};Object.freeze(a);return a});define("DS/CATC3DGeometry/CATC3DEquivalentGeometry",["UWA/Class","DS/CATC3DGeometry/CATC3DGeometryEnums","DS/DMUMeasurable/DMUGeometryEnums","DS/DMUMeasurable/DMUMeshRecognition","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement","DS/CAT3DComposeWidget/CAT3DComposeWidgetOptions","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(o,g,m,p,n,f,i,d){var e=i.getOption("authoring3d"),l=new n.Matrix4(),k={},j="AxisSystems",a="RefPlanes",c=g.GeometryType,b=o.extend({init:function(w){var u=w.pathElement,s=w.type,v=w.mode,x=w.direction,t=w.origin,r=w.geom;var q=(function(){var y;return function(z){if(!z&&y===undefined){y=new n.Matrix4()}return u.getWorldMatrix(null,z||y)}}());this.getPathElement=function(){return u.clone()};this.getType=function(){return s};this.getMode=function(){return v};if(s===g.GeometryType.AXISSYSTEM||s===g.GeometryType.AXISSYSTEMAXIS||s===g.GeometryType.AXISSYSTEMORIGIN){if(s===g.GeometryType.AXISSYSTEMAXIS){(function(B){var z=u.getParentPath(),y=new n.Matrix4(),A=new n.Matrix4();B.getOrigin=function(C){z.getWorldMatrix(null,y);return(C||new n.Vector3()).getPositionFromMatrix(y)};B.getDirection=function(C){A.extractRotation(q());return(C||new n.Vector3()).set(0,0,1).applyMatrix4(A).normalize()}})(this)}else{if(s===g.GeometryType.AXISSYSTEMORIGIN){this.getOrigin=function(y){return(y||new n.Vector3()).getPositionFromMatrix(q())}}else{this.getMatrix=function(y){return q(y)}}}return}if(s===g.GeometryType.REFPLANE){v=g.GeometryMode.REAL;this.getPlane=function(){var y=q();return{origin:new n.Vector3().getPositionFromMatrix(q()),normal:new n.Vector3().getColumnFromMatrix(2,y)}};this.getNormal=function(z){var y=q();return(z||new n.Vector3()).getColumnFromMatrix(2,y)};return}if(s===g.GeometryType.AXIS||s===g.GeometryType.AXISX||s===g.GeometryType.AXISY||s===g.GeometryType.AXISZ){this.getDirection=(function(){var y=new n.Matrix4();return function(z){y.extractRotation(q());return(z||new n.Vector3()).copy(x).applyMatrix4(y).normalize()}}());this.getOrigin=function(y){return(y||new n.Vector3()).copy(t).applyMatrix4(q())};this.getAxis=function(){var y=q();return{origin:t.clone().applyMatrix4(y),direction:x.clone().transformDirection(y)}};return}v=g.GeometryMode.REAL;switch(r.type){case m.GeometryType.POINT:s=g.GeometryType.POINT;break;case m.GeometryType.CURVE:s=g.GeometryType.CURVE;break;case m.GeometryType.LINE:s=g.GeometryType.LINE;break;case m.GeometryType.CIRCLE:s=g.GeometryType.CIRCLE;break;case m.GeometryType.SURFACE:s=g.GeometryType.SURFACE;break;case m.GeometryType.PLANE:s=g.GeometryType.PLANE;break;case m.GeometryType.CYLINDER:s=g.GeometryType.CYLINDER;break;case m.GeometryType.CONE:s=g.GeometryType.CONE;break;case m.GeometryType.SPHERE:s=g.GeometryType.SPHERE;break;default:window.console.log("Unknown DMU geometry type!!!")}if(s===g.GeometryType.POINT){this.getPoint=function(y){return(y||new n.Vector3()).copy(r.position).applyMatrix4(q())}}if(s===g.GeometryType.LINE||s===g.GeometryType.CURVE||s===g.GeometryType.CYLINDER||s===g.GeometryType.CONE){this.getEndPoints=function(){var y=q();return{startPoint:r.point1.clone().applyMatrix4(y),endPoint:r.point2.clone().applyMatrix4(y)}}}if(s===g.GeometryType.PLANE){this.getPlane=function(){var y=q();return{origin:r.origin.clone().applyMatrix4(y),normal:r.normal.clone().transformDirection(y)}};this.getNormal=function(z){var y=q();return(z||new n.Vector3()).copy(r.normal).transformDirection(y)}}if(s===g.GeometryType.CIRCLE||s===g.GeometryType.CYLINDER||s===m.GeometryType.SPHERE){this.getRadius=function(){return r.radius}}if(s===g.GeometryType.CIRCLE||s===g.GeometryType.SPHERE){this.getCenter=function(y){return(y||new n.Vector3()).copy(r.center).applyMatrix4(q())}}if(s===g.GeometryType.CIRCLE){this.getNormal=function(y){return(y||new n.Vector3()).copy(r.normal).transformDirection(q())}}}});function h(s){var q=new f(s.externalPath),r=q.getLastElement(true);if(r&&(d.isInstance(r)||d.isRepInstance(r))&&r.children.length===1){q.addElement(r.children[0])}else{while(q&&(r=q.getLastElement(true))&&(!d.isPLMNode(r)||(!d.is3DLeaf(r)&&!d.isReferencenode(r)))){q=q.getParentPath()}}return q}k.getEquivalentGeometry=function(u){if(!u||!u.pathElement||!u.pathElement.externalPath||u.pathElement.externalPath.length<2||u.pathElement.externalPath[0].name!=="RootBag"){return undefined}var A=u.pathElement,z,v,r=-1,s=-1,t,B,x;for(var y=A.externalPath.length-1;y>=0;--y){var q=A.externalPath[y];if(!q){continue}if(q.name===j){r=y;break}if(q.name===a){s=y;break}if(d.isPLMNode(q)){break}}if(r===-1&&s===-1&&A.internalPath.length){var w=A.getLastElement().sgNode;if(w){B=p.recognizeCanonicGeometry(w,l,true);x=B.type;if(B.returnCode===0&&(x===m.GeometryType.POINT||x===m.GeometryType.CURVE||x===m.GeometryType.LINE||x===m.GeometryType.CIRCLE||x===m.GeometryType.SURFACE||x===m.GeometryType.PLANE||x===m.GeometryType.CYLINDER||x===m.GeometryType.CONE||x===m.GeometryType.SPHERE)){v={pathElement:u.pathElement.clone(),geom:B};z=new b(v)}else{if(B.returnCode!==0&&u.nonCanonicGeometry===true){B=p.recognizeNonCanonicGeometry(w,l,true);x=B.type;if(B.returnCode===0&&(x===m.GeometryType.POINT||x===m.GeometryType.CURVE||x===m.GeometryType.LINE||x===m.GeometryType.CIRCLE||x===m.GeometryType.SURFACE||x===m.GeometryType.PLANE||x===m.GeometryType.CYLINDER||x===m.GeometryType.CONE||x===m.GeometryType.SPHERE)){v={pathElement:u.pathElement.clone(),geom:B};z=new b(v)}}}}}else{if(r>=0&&(r+1)<A.externalPath.length){v={pathElement:new f(A.externalPath.slice(0,r+2))};if(u.axisSystemOrigin===true){v.type=g.GeometryType.AXISSYSTEMORIGIN;v.mode=g.GeometryMode.TRANSIENT}else{v.mode=g.GeometryMode.REAL;if((r+2)<A.externalPath.length&&u.axisSystemSub===true){v.type=g.GeometryType.AXISSYSTEMAXIS;v.pathElement.addElement(A.externalPath[r+2])}else{v.type=g.GeometryType.AXISSYSTEM}}z=new b(v)}else{if(s>=0){v={pathElement:u.pathElement.clone(),type:g.GeometryType.REFPLANE};z=new b(v)}else{if(e){if(u.direction&&u.direction instanceof n.Vector3&&u.origin&&u.origin instanceof n.Vector3){t=h(A);if(t){v={pathElement:t};v.type=g.GeometryType.AXIS;v.mode=g.GeometryMode.TRANSIENT;v.origin=u.origin.clone();v.direction=u.direction.clone().normalize();z=new b(v)}}else{if(u.axis===c.AXISX||u.axis===c.AXISY||u.axis===c.AXISZ){t=h(A);if(t){v={pathElement:t,origin:new n.Vector3(),type:u.axis};v.mode=g.GeometryMode.TRANSIENT;v.direction=u.axis===c.AXISX?new n.Vector3(1,0,0):u.axis===c.AXISY?new n.Vector3(0,1,0):new n.Vector3(0,0,1);z=new b(v)}}}}}}}return z};Object.freeze(k);return k});