/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CAT3DAnnotSemanticCmds/CAT3DAnnotSemanticSolveAttrLinkCmd",["UWA/Class","DS/ENOCollabSharingCmds/commands/EditPropCmd/EditPropCmdBase"],function(c,b){var a=c.extend(b,{init:function(d){this._parent(d,{mode:"shared",isAsynchronous:true});this.setRepeatMode(false)}});return a});define("DS/CAT3DAnnotSemanticCmds/CAT3DAnnotSemanticCmds",[],function(){});define("DS/CAT3DAnnotSemanticCmds/CAT3DAnnotSemanticPreferencesCmd",["UWA/Core","DS/Controls/Toggle","DS/Controls/Expander","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/CAT3DAnnotationBaseCmds/CAT3DAnnotationPreferencesCmd","i18n!DS/CAT3DAnnotSemanticCmds/assets/nls/CAT3DAnnotSemanticCmds","i18n!DS/CAT3DAnnotationRsc/assets/nls/CAT3DAnnotationAttributesCategories","css!DS/CAT3DAnnotSemanticCmds/CAT3DAnnotSemanticCmds.css"],function(h,g,b,a,e,d,c){var f=e.extend({getPreferencePanel:function(){var p=this._parent();var m=a.getPreference("3DAnnotAttributesOrderedList");var n=[],j,i,q;var l=h.createElement("div",{"class":"CAT3DAnnotAttrPrefAttrSection"});new b({header:d.PrefAttributesTitle,body:l}).inject(p.body);for(q=0;q<m.length;q++){j="3DAnnotSemAttr_"+m[q];i=a.getPreference(j);var r=new g({label:c[m[q]],value:j,type:"checkbox",checkFlag:i}).inject(l);n.push({toggle:r,initValue:i,name:j})}var k=p.saveCB;p.saveCB=function(){k();for(q=0;q<n.length;q++){if(n[q].toggle.checkFlag!==n[q].initValue){a.setPreference(n[q].name,n[q].toggle.checkFlag)}}};var o=p.resetCB;p.resetCB=function(){o();for(q=0;q<n.length;q++){n[q].toggle.checkFlag=true}};return p}});return f});define("DS/CAT3DAnnotSemanticCmds/CAT3DAnnotSemanticShowRelatedAnnotCmd",["DS/ApplicationFrame/Command","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/PADUtils/PADContext","DS/CAT3DAnnotationController/CAT3DAnnotationController"],function(d,b,c,e,a){return d.extend({init:function(f){this._parent(f,{mode:"shared",isAsynchronous:true});this.setRepeatMode(false)},beginExecute:function(){var i=function(t){if(!t){return null}var w=t.getLastElement(true).getAnnotationID!==undefined?t.getLastElement(true).getAnnotationID():null;var A=t.getParentPath().getParentPath();if(!A.getLastElement(true).getAnnotationClassType||A.getLastElement(true).getAnnotationClassType()!=="tpsAnnotationSet"){return null}var u=null;var y=A.getChildrenPathes();for(var B=0;B<y.length;B++){if(y[B].getLastElement(true).getAnnotationType()==="RootViews"){u=y[B];break}}if(u){var z=u.getChildrenPathes();for(var B=0;B<z.length;B++){var v=z[B].getLastElement(true).getTPSList();if(v&&v.length){for(var x=0;x<v.length;x++){if(v[x]===w){return z[B]}}}}}};var l=b.get();if(!l.length){this.end()}this.ctxBarPosition=this.getFrameWindow().getContextualUIManager().getContextualBar().getPosition();this.ctxBarPosition=this.ctxBarPosition?{x:this.ctxBarPosition.x,y:this.ctxBarPosition.y}:{x:0,y:0};var p=e.get();var s=a.giveAnnotationController({context:p});var g=[];var k=[];for(var r=0;r<l.length;r++){var m=s.getPontingAnnotations(l[r].pathElement);if(m&&m.length){for(var j=0;j<m.length;j++){g.push(m[j]);var o=i(m[j]);if(o&&o.getLastElement(true).isVisible()&&g.indexOf(o)===-1){g.push(o)}var q=m[j].getParentPath().getParentPath();if(k.indexOf(q)===-1){k.push(q)}}}}if(k&&k.length){for(var r=0;r<k.length;r++){var h=k[r].getChildrenPathes();for(var j=0;j<h.length;j++){var n=h[j].getChildrenPathes();for(var f=0;f<n.length;f++){n[f].getLastElement(true).setVisibility(false)}}}}if(g&&g.length){for(var r=0;r<g.length;r++){g[r].getLastElement(true).setVisibility(true)}}this.end()},endExecute:function(){var f=b.get();var h=[];for(var g=0;g<f.length;g++){h.push({pathElement:f[g].pathElement.clone()})}b.empty();c.empty();b.add(h);c.add(h);this.getFrameWindow().getContextualUIManager().showContextualBar({hideWithDistance:true,x:this.ctxBarPosition.x,y:this.ctxBarPosition.y});this.getFrameWindow().getViewer().render();this.ctxBarPosition=null}})});define("DS/CAT3DAnnotSemanticCmds/CAT3DAnnotSemanticShowGeomAttachCmd",["DS/ApplicationFrame/Command","DS/Selection/CSOManager","DS/Selection/HSOManager"],function(c,a,b){return c.extend({init:function(d){this._parent(d,{mode:"shared",isAsynchronous:true});this.setRepeatMode(false)},beginExecute:function(){var i=a.get();if(!i.length){this.end()}this.ctxBarPosition=this.getFrameWindow().getContextualUIManager().getContextualBar().getPosition();this.ctxBarPosition=this.ctxBarPosition?{x:this.ctxBarPosition.x,y:this.ctxBarPosition.y}:{x:0,y:0};for(var l=0;l<i.length;l++){if(!i[l].pathElement.getLastElement(true).isVisible()){continue}var e=i[l].pathElement.getLastElement(true);var j=e.getGeometricalAttachmentList();if(j&&j.length){var k=i[l].pathElement.getParentPath().getParentPath();var m=k.getLastElement(true).children;for(var g=0;g<m.length;g++){if(m[g].getAnnotationType()!=="RootViews"&&m[g].getAnnotationType()!=="RootCaptures"&&m[g].getAnnotationType()!=="RootGeometries"){var f=m[g].children;for(var d=0;d<f.length;d++){var h=j.indexOf(f[d].getAnnotationID());if(h!==-1&&!f[d].isVisible()){f[d].setVisibility(true)}}}}}}this.end()},endExecute:function(){var d=a.get();var f=[];for(var e=0;e<d.length;e++){f.push({pathElement:d[e].pathElement.clone()})}a.empty();b.empty();a.add(f);b.add(f);this.getFrameWindow().getContextualUIManager().showContextualBar({hideWithDistance:true,x:this.ctxBarPosition.x,y:this.ctxBarPosition.y});this.getFrameWindow().getViewer().render();this.ctxBarPosition=null}})});define("DS/CAT3DAnnotSemanticCmds/CAT3DAnnotSemanticWidgetDefaultCmd",["DS/CAT3DAnnotationCommands/CAT3DAnnotationWidgetDefaultCmd"],function(a){var a=a.extend({init:function(b){var b=b||{};b.annotControllerLib="DS/CAT3DAnnotSemanticController/CAT3DAnnotSemanticContInstance";this._parent(b)}});return a});define("DS/CAT3DAnnotSemanticCmds/panels/CAT3DAnnotSemanticAttrBrowserPanel",["UWA/Core","DS/CAT3DAnnotationBaseUI/CAT3DAnnotationAttrListTable","DS/WebappsUtils/WebappsUtils","DS/CAT3DAnnotSemanticUI/CAT3DAnnotSemBrowserListItem","DS/Tree/TreeDocument","i18n!DS/CAT3DAnnotSemanticCmds/assets/nls/CAT3DAnnotSemanticCmds"],function(g,e,f,a,b,d){var c=e.extend({init:function(u){this._parent(u);var l;var i=[],p;var m=false;var k=this;function h(v,w){var y;if(w.getIDPath()&&w.getIDPath().equals(v)){y=w}else{if(w.getChildren()&&w.getChildren().length){for(var x=0;x<w.getChildren().length;x++){y=h(v,w.getChildren()[x]);if(y){break}}}}return y}function s(v){if(!v||(v&&!v.length)){return undefined}var y;for(var w=0;w<i.length;w++){if(i[w].section.getIDPath()[0]===v[0]&&i[w].section.getIDPath()[1]===v[1]){for(var x=0;x<i[w].elements.length;x++){y=h(v,i[w].elements[x]);if(y){return{section:i[w].section,item:y}}}}}return y}function n(v){for(var w=0;w<v.length;w++){q(v[w]);if(v[w].getRootParentNode()&&v[w].getRootParentNode().getDisplayFlag()){q(v[w].getRootParentNode())}}}function q(y){var v;if(y.isAStructuralItem()){if(y.getDisplayFlag(true)){v=y.getRootParentNode()&&y.getRootParentNode().getDisplayFlag(true)?"rgb(87, 184, 71)":"rgb(54, 142, 196)"}}else{if(y.isRootNode()){v=y.getDisplayFlag(true)?"rgb(87, 184, 71)":""}else{if(y.getDisplayFlag()){v=y.getRootParentNode()&&y.getRootParentNode().getDisplayFlag(true)?"rgb(87, 184, 71)":"rgb(54, 142, 196)"}}}if(y.getContent()){y.getContent().updateOptions({color:v})}var w=y.getChildren();if(w){for(var x=0;x<w.length;x++){q(w[x])}}}function j(v){k.publish("onAttrDisplayFlagModified",{idPath:v.getIDPath(),flag:v.getDisplayFlag(),discipline:k.getDiscipline()})}function o(x){var z=[];var y=function(B){if(!B.isAStructuralItem()&&B.getActiveState()){z.push({idPath:B.getIDPath(),activeState:B.getActiveState()})}if(B.getChildren()&&B.getChildren().length){for(var A=0;A<B.getChildren().length;A++){y(B.getChildren()[A])}}};var v,w;for(v=0;v<i.length;v++){for(w=0;w<i[v].elements.length;w++){y(i[v].elements[w])}}if(z!==p){p=z;z.discipline=k.getDiscipline();k.publish("onAttrActiveStateModified",z)}n([x])}var t=this.buildAttributeTable;this.buildAttributeTable=function(P){var F,N;var H;if(P.model&&P.model.length&&P.discipline){k.setDiscipline(P.discipline);l=new b({useAsyncPreExpand:false,shouldAcceptDrag:function(){return true},shouldAcceptDrop:function(){return false}});var G=[],L=[];var w=[{text:d.titleCol,dataIndex:"tree",isEditable:false}];var z=function(T){var R,S;if(T.children&&T.children.length){R=[];for(S=0;S<T.children.length;S++){R.push(z(T.children[S]))}}if(T.type){m=true}if(T.attributes&&T.attributes.length){var Q=T.attributes;for(S=0;S<Q.length;S++){if(L.indexOf(Q[S].colID)===-1){G.push(Q[S].title);L.push(Q[S].colID)}}}if(m&&!O){w.push({text:d.typeCol,dataIndex:"type",isEditable:false});O=true}return new a({idPath:T.idPath,isAStructuralItem:T.isAStructuralItem,name:T.name,displayFlag:T.displayFlag,activeState:T.activeState,icon:T.icon,attributes:T.attributes,type:T.type,createTreeModelNode:true,children:R,callback:!T.isAStructuralItem?o:function(){},onDisplayHistoryFlagChangeCB:!T.isAStructuralItem?j:function(){}})};var O=false;for(F=0;F<P.model.length;F++){var M=[];for(N=0;N<P.model[F].elements.length;N++){M.push(z(P.model[F].elements[N]))}var v=new a({idPath:P.model[F].section.idPath,name:P.model[F].section.name,icon:P.model[F].section.icon,children:M,createTreeModelNode:P.model.length>1,isRootNode:true});i.push({section:v,elements:M});if(P.model.length>1){for(N=0;N<M.length;N++){M[N].setRootParentNode(v)}l.addRoot(v.getContent())}else{for(N=0;N<M.length;N++){M[N].setRootParentNode(v);l.addRoot(M[N].getContent())}}}var x=function(U){if(!H){return}var R=H.reuseCellContent("CAT3DAnnotationAttributesLinks");while(R.firstChild){R.removeChild(R.firstChild)}var S=H.columns[U.columnID].dataIndex;var T=U.nodeModel.options.grid[S];var Q=k.buildLinks(T,S);if(Q){Q.inject(R)}U.cellView._setReusableContent(R)};var C=function(T){if(!H){return}var Q=H.reuseCellContent("CAT3DAnnotationAttributesFailureModes");while(Q.firstChild){Q.removeChild(Q.firstChild)}var R=H.columns[T.columnID].dataIndex;var S=T.nodeModel.options.grid[R];var U=k.buildFailureMode(S);if(U){U.inject(Q)}T.cellView._setReusableContent(Q)};if(P.discipline==="3DAnnotations"){var y=[],I=[],B;var D=["hiddenText","failureModes","navReq","relatedDocs","urls"];for(F=0;F<D.length;F++){B=L.indexOf(D[F]);if(B!==-1){y.push(L[B]);I.push(G[B]);L.splice(B,1);G.splice(B,1)}}L=L.concat(y);G=G.concat(I)}var A,J=false,K=false;for(F=0;F<G.length;F++){A={text:G[F],dataIndex:L[F],isEditable:false};if(L[F]==="urls"||L[F]==="relatedDocs"||L[F]==="navReq"||L[F]==="hiddenText"){J=true;A.onCellRequest=x;A.autoRowHeightFlag=true}else{if(L[F]==="failureModes"){K=true;A.onCellRequest=C;A.autoRowHeightFlag=true}}w.push(A)}var E={identifier:"CAT3DAnnotationAttributesList",treeDocument:l,defaultColumnDef:{width:"auto"},columns:w,rowSelection:"multiple",cellSelection:{defaultValue:"none"},sortModel:[{dataIndex:"tree",sort:"asc"}],rowDragEnabledFlag:false,allowUnsafeHTMLContent:false,cellDragEnabledFlag:false,showNodeKPIColorFlag:true,activateAllCellsRenderedEventFlag:true,showRowBorderFlag:true,placeholder:"",recId:"A3IAttrList",onContextualEvent:function(S){if(!H){return}var V=[],U=S.cellInfos;if(S&&S.collectionView&&U){if(U.columnID===-1){return V}if(U.rowID===-1){V=S.collectionView.buildDefaultContextualMenu(S,{pin:true,firstColumnsVisibility:false,columnsManagement:true,sizeColumnToFit:true});var T=V.splice(V.length-1,1)[0];V.push({type:"PushItem",title:d.hideColumnLabel,action:{callback:function(){if(!H){return}var W=H.layout.getDataIndexFromColumnIndex(U.columnID);H.layout.setColumnVisibleFlag(W,false,{isUserInteraction:true})}}});var Q=l.getFilterManager().filterModel;var R=H.layout.getDataIndexFromColumnIndex(U.columnID);if(R==="tree"){R="label"}if(Q[R]){V.push({type:"PushItem",title:d.removeFilterLabel,action:{callback:function(){delete Q[R];l.setFilterModel({});l.setFilterModel(Q)}}})}else{V.push({type:"PushItem",title:d.addFilterLabel,action:{callback:function(){l.getFilterManager().setPropertyFilterModel(R,{filterId:"stringRegexp"})}}})}V.push({type:"SeparatorItem",title:""});V.push(T);V.push({type:"SeparatorItem",title:""});V.push({type:"PushItem",title:d.AttrResetDisplayHistoryLbl,icon:f.getWebappsAssetUrl("CAT3DAnnotationBaseCmds","icons/22/")+"I_CAT3DAnnotResetDisplayHistory.png",action:{callback:function(){k.publish("onDeleteDisplayHistory",{discipline:k.getDiscipline()})}}})}else{V.push({type:"PushItem",title:d.ReframeOnLabel,icon:f.getWebappsAssetUrl("CAT3DAnnotSemanticCmds","icons/32/")+"I_CAT3DAnnotReframeOn.png",action:{callback:function(){k.publish("onReframeOn",{discipline:k.getDiscipline()})}}})}}return V}};H=t({gridOptions:E});if(K||J){if(J){H.registerReusableCellContent({id:"CAT3DAnnotationAttributesLinks",buildContent:function(){return new g.Element("div")}})}if(K){H.registerReusableCellContent({id:"CAT3DAnnotationAttributesFailureModes",buildContent:function(){return new g.Element("div")}})}H.layout.getRowHeightFunction=function(S){var R=H.layout.cellHeight;var T=H.model[S];if(!T){return R}if(T.customRowHeight){R=T.customRowHeight}else{var Q=function(W,V,U){R=Math.max(k.getRowHeight(V(W,U)),R)};if(T.options.grid.hiddenText&&T.options.grid.hiddenText.length){Q(T.options.grid.hiddenText,k.buildLinks,"hiddenText")}if(T.options.grid.urls&&T.options.grid.urls.length){Q(T.options.grid.urls.lgth,k.buildLinks,"urls")}if(T.options.grid.relatedDocs&&T.options.grid.relatedDocs.length){Q(T.options.grid.relatedDocs,k.buildLinks,"relatedDocs")}if(T.options.grid.navReq&&T.options.grid.navReq.length){Q(T.options.grid.navReq,k.buildLinks,"navReq")}if(T.options.grid.failureModes&&T.options.grid.failureModes.length){Q(T.options.grid.failureModes,k.buildFailureMode)}T.customRowHeight=R}return R}}}return H};this.updateGridDisplay=function(){var w=[];for(var v=0;v<i.length;v++){w=w.concat(i[v].elements)}n(w)};var r=this.cleanPanel;this.cleanPanel=function(){for(var v=0;v<i.length;v++){if(i[v].section){i[v].section.clear()}for(var w=0;w<i[v].elements.length;w++){i[v].elements[w].clear()}}i.splice(0,i.length);l=null;r()};this.getDisplayedIDPaths=function(y){var v=[];var z=function(B){if(!B.isAStructuralItem()&&(!y||y&&B.getActiveState())){v.push(B.getIDPath())}if(B.getChildren()&&B.getChildren().length){for(var A=0;A<B.getChildren().length;A++){z(B.getChildren()[A])}}};for(var w=0;w<i.length;w++){for(var x=0;x<i[w].elements.length;x++){z(i[w].elements[x])}}return v};this.setAdditionalInformations=function(C){var B=function(I,J){if(I.isAStructuralItem()){J.push(I)}if(I.getChildren()&&I.getChildren().length){for(var H=0;H<I.getChildren().length;H++){B(I.getChildren()[H],J)}}};var F,y,x=[];for(F=0;F<C.length;F++){var D=s(C[F].idPath);if(D){var G=Object.keys(C[F].infos);var w=false;for(y=0;y<G.length;y++){if(G[y]==="activeState"&&C[F].infos[G[y]]!==D.item.getActiveState()){var v=D.item.getDisplayFlag();D.item.setActiveState(C[F].infos[G[y]]);if(v!==D.item.getDisplayFlag()){w=true}}else{if(G[y]==="displayFlag"&&C[F].infos[G[y]]!==D.item.getDisplayFlag()){D.item.setDisplayFlag(C[F].infos[G[y]]);x.push(D.item);w=true}}}var E=[];if(w&&D.section){if(D.section.getContent()){x.push(D.section);B(D.section,E);for(var A=0;A<E.length;A++){x.push(E[A])}}else{if(D.section.getChildren()&&D.section.getChildren().length){E=D.section.getChildren();for(var z=0;z<E.length;z++){x.push(E[z])}}}}}}n(x)}}});return c});
/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CAT3DAnnotSemanticCmds/controllers/CAT3DAnnotSemanticAttrBrowserCtr",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/CAT3DAnnotSemanticCmds/panels/CAT3DAnnotSemanticAttrBrowserPanel","DS/CATWebUXComponents/CATWebUXPanel","DS/CAT3DAnnotationController/CAT3DAnnotationController","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader","DS/CAT3DAnnotationCommands/controllers/CAT3DAnnotationFilterController","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/WebappsUtils/WebappsUtils","DS/CAT3DAnnotationUtils/CAT3DAnnotationUnits","DS/ApplicationFrame/CommandsManager","DS/PADUtils/views/PADAlert","i18n!DS/CAT3DAnnotSemanticCmds/assets/nls/CAT3DAnnotSemanticCmds","i18n!DS/CAT3DAnnotationRsc/assets/nls/CAT3DAnnotationAttributesCategories","i18n!DS/CAT3DAnnotationRsc/assets/nls/CAT3DAnnotationAttributesSubTypes","i18n!DS/CAT3DAnnotationRsc/assets/nls/CAT3DAnnotationTypes"],function(n,s,k,r,c,l,i,e,m,h,g,f,b,p,j,q,o,u){var d=n.extend({init:function(ac){this._parent(ac);var S=ac||{};var A=this;var F=[],K={};var y=[];var am=false;var W=true;var ap=[];var Q=[];var ah=[];var N=S.ctxViewer;var H=false;var X={};var Z={};var C={};var ae=0;var D={};var al;var aa;var G;var ak=false;var ad=150;var w=0;var O=0;var v=0;var M=false;var B=[];var z=h.getPreference("3DAnnotAttributesOrderedList");function T(){var ar;var av=Object.keys(K);for(ar=0;ar<av.length;ar++){K[av[ar]].splice(0,K[av[ar]].length)}K={};if(F&&F.length){for(ar=0;ar<F.length;ar++){for(var au=0;au<F[ar].children.length;au++){var at=F[ar].children[au];if(at.isVisible){for(var aw=0;aw<z.length;aw++){if(B===null||(B&&B.indexOf(z[aw])===-1)){var aq={elements:ab(at,[ar,au],z[aw]),section:{idPath:[ar,au],name:at.referenceLabel+" / "+at.name,icon:at.referenceIcon}};if(aq.elements.length){if(!K[z[aw]]){K[z[aw]]=[]}K[z[aw]].push(aq)}}}}}}}}this._internalRefresh=function(){if(!am||M||!aa.getActiveState()||!A.getDataModel){Y()}else{F.splice(0,F.length);A.getDataModel(function(aw){F=aw;B=al.getAttributeTypesFiltered();T();var au=Object.keys(K),ar;for(ar=y.length-1;ar>=0;ar--){if(au.indexOf(y[ar].discipline)===-1){y[ar].panel.clean();var av=Object.keys(y[ar].tokensBrowserPanel);for(var at=0;at<av.length;at++){y[ar].attrUI.unsubscribe(y[ar].tokensBrowserPanel[av[at]])}y[ar].attrUI.cleanPanel();y.splice(ar,1)}}for(ar=au.length-1;ar>=0;ar--){x(au[ar],K[au[ar]])}if(y.length){y.forEach(function(ax){ax.panel.setPanelVisibilityFlag(W);ax.panel.setEnableFlag(w>=0)});if(W){var aq=r.get();for(ar=0;ar<aq.length;ar++){ao(aq[ar].pathElement,{activeState:true},true)}}}})}};var ai=function(){if(!am||M){Y()}else{if(v){clearTimeout(v);v=0}v=setTimeout(function(){A._internalRefresh();ad=150;v=0},ad)}};var V=function(aq){if(am){w+=aq===true?1:-1;if(O){clearTimeout(O);O=0}if(y.length){y.forEach(function(ar){ar.panel.setEnableFlag(w>=0)});if(w<0){O=setTimeout(function(){if(am&&y){y.forEach(function(ar){ar.panel.setEnableFlag(true)})}w=0},20000)}}}};var ao=function(ar,ax,av){var ay={path:ar.clone(),attributes:[]};var aw=[];var aq=false;var at=ar.getLastElement(true);if(at&&at.getAnnotationClassType){var az=P(ar);if(az){aw.push({idPath:az,infos:ax})}}else{var au=aa.getPontingAnnotations(ar,true);if(au&&au.length){for(var aA=0;aA<au.length;aA++){if(au[aA].getLastElement(true).getAnnotationClassType()==="tpsAttribute"){aw.push({idPath:P(au[aA]),infos:ax});ay.attributes.push(au[aA].clone());aq=true}}}}if(aw.length){y.forEach(function(aB){aB.attrUI.setAdditionalInformations(aw)})}if(aq&&av){ap.push(ay)}};var J=function(aq){if(ak||M){return}if(aq.event){ah.length=0;Q.push(aq)}ao(aq.pathElement,{activeState:true,displayFlag:true},true)};var af=function(ar){if(ak||M){return}var aq;if(ar.event){ah.length=0;for(aq=0;aq<Q.length;aq++){if(Q[aq].pathElement.isEqual(ar.pathElement)){Q.splice(aq,1)}}}ao(ar.pathElement,{activeState:false},false);for(aq=0;aq<ap.length;aq++){if(ap[aq].path.isEqual(ar.pathElement)){ap.splice(aq,1)}}};var ag=function(){if(ak||M){return}Q.splice(0,Q.length-1);ah.length=0;ap.splice(0,ap.length);y.forEach(function(aq){var ar=aq.attrUI.getDisplayedIDPaths();var au=[];for(var at=0;at<ar.length;at++){au.push({idPath:ar[at],infos:{activeState:false}})}if(au.length){aq.attrUI.setAdditionalInformations(au)}})};var Y=function(){if(v){clearTimeout(v);v=0}if(y.length){y.forEach(function(aq){aq.panel.clean();var at=Object.keys(aq.tokensBrowserPanel);for(var ar=0;ar<at.length;ar++){aq.attrUI.unsubscribe(aq.tokensBrowserPanel[at[ar]])}aq.attrUI.destroy();aq.attrUI=null});y.length=0}};function I(aq){var ay=[],aw;if(Array.isArray(aq)){var av,au;for(aw=0;aw<aq.length;aw++){au=aq[aw].Magnitude;av=aq[aw].Value;if(au&&au.toLowerCase){au=au.toLowerCase()}var at=false;if(au==="length"||au==="area"||au==="volume"||au==="angle"){av=f.convert(aq[aw].Value,au);at=true}else{if(au==="boolean"){av=(av==="1").toString()}}ay.push({colID:aq[aw].Name,title:aq[aw].Name+(at?("("+f.getCurrentUnitNls(au)+")"):""),value:av})}}else{if(aq){var ax=aq.split(/(\r\n|\n|\r)/gm);for(aw=0;aw<ax.length;aw++){if(ax[aw].charCodeAt(0)===10){continue}var ar=ax[aw].indexOf("=");if(ar===-1){ar=ax[aw].indexOf(":")}if(ar!==-1){ay.push({colID:ax[aw].substring(0,ar),title:ax[aw].substring(0,ar),value:ax[aw].substring(ar+1,ax[aw].length)})}else{ay.push({colID:"otherParams",title:j.otherParams,value:ax[aw]})}}}}return ay}function L(ar,aB,aw){var aF,aA=[],ay=false,az=u[ar.type];if(ar.type===47&&ar.category===aw){ay=true;az=ar.attrType?o[ar.attrType]:undefined;var av=I(ar.param);if(av&&av.length){aA=aA.concat(av)}}else{if(aw==="3DAnnotations"&&ar.type!==47){ay=true;if(ar.noaText){aA.push({colID:"noaText",title:j.noaText,value:ar.noaText})}if(ar.noaType){aA.push({colID:"noaType",title:j.noaType,value:ar.noaType})}if(ar.text){aA.push({colID:"text",title:j.text,value:ar.text})}if(ar.generalTolerance||(ar.tabulatedLimit&&ar.toleranceLimits)){var aq=ar.type===37?"angle":"length",ax=" ("+f.getCurrentUnitNls(aq)+")";if(ar.generalTolerance){aA.push({colID:"generalToleranceName",title:j.generalToleranceName,value:ar.generalTolerance.name});aA.push({colID:"generalToleranceVariation",title:j.generalToleranceVariation+ax,value:f.convert(ar.generalTolerance.variation,aq)})}else{aA.push({colID:"tabulatedLimit",title:j.tabulatedLimit,value:ar.tabulatedLimit});aA.push({colID:"toleranceLimitMin",title:j.toleranceLimitMin+ax,value:f.convert(ar.toleranceLimits.min,aq)});aA.push({colID:"toleranceLimitMax",title:j.toleranceLimitMax+ax,value:f.convert(ar.toleranceLimits.max,aq)})}}if(ar.hyperlink&&ar.hyperlink.hyperlinksAndComments&&ar.hyperlink.hyperlinksAndComments.hiddenText){var aE=ar.hyperlink.hyperlinksAndComments.hiddenText.split("&#xA;");var aD=[];aE.forEach(function(aG){aD=aD.concat(aG.split(/(\r\n|\n|\r)/gm))});aA.push({colID:"hiddenText",title:j.hiddenText,value:aE})}if(ar.hyperlink&&ar.hyperlink.failureModes&&ar.hyperlink.failureModes.length){aA.push({colID:"failureModes",title:j.failureModes,value:ar.hyperlink.failureModes})}if(ar.hyperlink&&ar.hyperlink.requirements){aA.push({colID:"navReq",title:j.navReq,value:ar.hyperlink.requirements})}if(ar.hyperlink&&ar.hyperlink.relatedDocs){aA.push({colID:"relatedDocs",title:j.relatedDocs,value:ar.hyperlink.relatedDocs})}if(ar.hyperlink&&ar.hyperlink.hyperlinksAndComments&&ar.hyperlink.hyperlinksAndComments.urls&&ar.hyperlink.hyperlinksAndComments.urls.length){aA.push({colID:"urls",title:j.urls,value:ar.hyperlink.hyperlinksAndComments.urls})}}}var au;if(ar.children&&ar.children.length){au=[];var at;for(var aC=0;aC<ar.children.length;aC++){at=L(ar.children[aC],aB.concat([aC]),aw);if(at){au.push(at)}}}if(ay){aF={idPath:aB,isAStructuralItem:ar.isRootAttr,name:ar.name,type:az,displayFlag:ar.displayFlag,activeState:ar.activeState,icon:ar.icon,attributes:aA,children:au}}return aF}function ab(ar,ay,au){var at=[];var az,av,ax,aw;if(au==="3DAnnotations"&&ar.hyperlink){ax={};aw=false;if(ar.hyperlink.hyperlinksAndComments){ax.hyperlinksAndComments=ar.hyperlink.hyperlinksAndComments}else{if(ar.hyperlink&&ar.hyperlink.requirements){ax.navReq=ar.hyperlink.requirements}}if(aw){at.push({idPath:ay.slice(),isAStructuralItem:ar.isRootAttr,name:ar.name,type:ar.type,displayFlag:ar.displayFlag,activeState:ar.activeState,icon:ar.icon,attributes:ax})}}for(az=0;az<ar.children.length;az++){var aq=ar.children[az];if(aq.type!=="RootViews"&&aq.type!=="RootCaptures"){for(av=0;av<aq.children.length;av++){var aA=L(aq.children[av],[ay[0],ay[1],az,av],au);if(aA){at.push(aA)}}}}return at}var x=function(au,av){var ar;for(var ay=0;ay<y.length;ay++){if(y[ay].discipline===au){ar=y[ay];break}}var at;if(ar&&ar.attrUI&&ar.panel){ar.attrUI.buildAttributeTable({model:av,discipline:au,disciplineNls:q[au]})}else{ar={discipline:au};var aq=180,az=150;ar.attrUI=new c();ar.tokensBrowserPanel={};ar.tokensBrowserPanel.onAttrActiveStateModified=ar.attrUI.subscribe("onAttrActiveStateModified",R);ar.tokensBrowserPanel.onAttrDisplayFlagModified=ar.attrUI.subscribe("onAttrDisplayFlagModified",E);ar.tokensBrowserPanel.onDeleteDisplayHistory=ar.attrUI.subscribe("onDeleteDisplayHistory",an);ar.tokensBrowserPanel.onReframeOn=ar.attrUI.subscribe("onReframeOn",U);ar.tokensBrowserPanel.onAttributeClicked=ar.attrUI.subscribe("onAttributeClicked",A.solveAttributeLink);at=ar.attrUI.buildPanel({model:av,discipline:au,disciplineNls:q[au]});if(at){var aw=g.getWebappsAssetUrl("CAT3DAnnotationRsc","icons/22/");if(au==="3DAnnotations"){aw+="I_W3DAnnot_NodeAnnotationSet.png"}else{if(au==="0"){aw+="I_W3DAnnot_MechanicalAttribute.png"}else{if(au==="1"){aw+="I_W3DAnnot_ElectricalAttribute.png"}else{if(au==="2"){aw+="I_W3DAnnot_KnowledgeAttribute.png"}else{if(au==="3"){aw+="I_W3DAnnot_StructureAttribute.png"}else{if(au==="4"){aw+="I_W3DAnnot_CompositeAttribute.png"}else{if(au==="5"){aw+="I_W3DAnnot_GeometricalAttribute.png"}}}}}}}var ax={id:"CAT3DAnnotAttrBrowserPanel"+au,className:"CAT3DAnnotAttrBrowserPanel",title:q[au],icon:aw,immersiveFrame:N.getFrameWindow().getImmersiveFrame(),content:at,minHeight:az,minWidth:aq,snappableFlag:true,allowMaximizeFlag:true,maximizeButtonFlag:true,allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea|WUXDockAreaEnum.TopDockArea|WUXDockAreaEnum.BottomDockArea,currentDockArea:WUXDockAreaEnum.BottomDockArea};ar.panel=new l(ax);y.push(ar)}}if(ar){ar.panel.setPanelVisibilityFlag(W&&ar.attrUI.getDisplayedIDPaths().length!==0)}};var aj=function(aq){if(F&&F.length&&F[aq[0]]){if(F[aq[0]].children&&F[aq[0]].children[aq[1]]){if(aq.length===2){return F[aq[0]].children[aq[1]].path}else{if(F[aq[0]].children[aq[1]].path){var at=F[aq[0]].children[aq[1]].path.getChildrenPathes();var au;for(var ar=2;ar<aq.length;ar++){if(at&&at[aq[ar]]){au=at[aq[ar]];at=au.getChildrenPathes()}}return au}}}}return undefined};var P=function(ar){var av;if(F&&F.length){var aw,au,az;av=[];for(var ax=0;ax<F.length;ax++){var ay=F[ax].path;if(ay.isAParentOf(ar)){av.push(ax);for(var at=0;at<F[ax].children.length;at++){az=F[ax].children[at].path;if(az.isAParentOf(ar)){av.push(at);while(!az.isEqual(ar)){au=false;aw=az.getChildrenPathes();for(var aq=0;aq<aw.length;aq++){if(aw[aq].isAParentOf(ar)||aw[aq].isEqual(ar)){av.push(aq);az=aw[aq];au=true;break}}if(!au){return undefined}}}}}}}return av};var R=function(au){ak=true;var ax=function(aC,ay){var aB,aD;var az=aC.getLastElement(true);if(az.getAnnotationClassType&&az.getAnnotationClassType()==="tpsAttribute"){if(!ay){var aF=false;for(aB=0;aB<ap.length;aB++){for(aD=0;aD<ap[aB].attributes.length;aD++){if(aC.isEqual(ap[aB].attributes[aD])){aF=ap[aB].path.clone();break}}if(aF){ap.splice(aB,1);break}}if(aF){r.remove({pathElement:aF})}}var aA=aa.getRelatedGeometryPaths(aC);if(aA.length){var aE=[];for(aB=0;aB<aA.length;aB++){aE.push({pathElement:aA[aB]})}if(az.getAttributeCategory&&az.getAttributeCategory()==="5"){if(ay){r.add(aE)}else{r.remove(aE)}}if(ay){k.add(aE)}else{k.remove(aE)}}}else{if(ay){k.add({pathElement:aC})}else{k.remove({pathElement:aC})}}if(ay){r.add({pathElement:aC})}else{r.remove({pathElement:aC})}az.setDisplayFlag(ay?true:az.getDisplayFlag())};var aq,ar;if(Q&&Q.length){for(aq=0;aq<Q.length;aq++){r.remove(Q[aq]);k.remove(Q[aq])}Q.splice(0,Q.length-1)}var at=[];for(aq=0;aq<au.length;aq++){var av=aj(au[aq].idPath);if(av){at.push({path:av,activeState:au[aq].activeState})}}var aw;for(aq=0;aq<ah.length;aq++){aw=false;for(ar=0;ar<at.length;ar++){if(at[ar].path.isEqual(ah[aq].path)){aw=true}}if(!aw){at.push({path:ah[aq].path,activeState:false})}}ah.length=0;for(aq=0;aq<at.length;aq++){ax(at[aq].path,at[aq].activeState);if(at[aq].activeState){ah.push(at[aq])}}ak=false};var E=function(aq){var ar=aj(aq.idPath);if(ar&&ar.getLastElement(true).getDisplayFlag&&ar.getLastElement(true).getDisplayFlag()!==aq.flag){ar.getLastElement(true).setDisplayFlag(aq.flag)}};function an(az){var au,aC;for(aC=0;aC<y.length;aC++){if(y[aC].discipline===az.discipline){au=y[aC];break}}if(au){var aD=function(aE){aE.setDisplayFlag(false);if(aE.children&&aE.children.length&&aE.children[0].setDisplayFlag){for(var aF=0;aF<aE.children.length;aF++){aD(aE.children[aF])}}};var aB=G.getLoadedAnnotationSets(N.getRootBagPath());for(aC=0;aC<aB.length;aC++){var av=aB[aC].getChildrenPathes();for(var ay=0;ay<av.length;ay++){var aq=av[ay].getLastElement(true);if(aq.getAnnotationType()!=="RootCaptures"&&aq.getAnnotationType()!=="RootViews"){var ax=av[ay].getChildrenPathes(),at;for(var ar=0;ar<ax.length;ar++){at=ax[ar].getLastElement(true);if((az.discipline==="3DAnnotations"&&at.getAnnotationType()!==47)||(at.getAttributeCategory&&az.discipline===at.getAttributeCategory())){aD(at)}}}}}p.displayNotification({eventID:"info",msg:j.DisplayHistorySuccessfulLbl});var aw=au.attrUI.getDisplayedIDPaths();var aA=[];for(aC=0;aC<aw.length;aC++){aA.push({idPath:aw[aC],infos:{displayFlag:false}})}if(aA.length){au.attrUI.setAdditionalInformations(aA)}}}function U(au){var aq,ax;for(ax=0;ax<y.length;ax++){if(y[ax].discipline===au.discipline){aq=y[ax];break}}if(aq){var at=aq.attrUI.getDisplayedIDPaths(true);var ar;if(at.length){var ay=[],az;for(ax=0;ax<at.length;ax++){az=aj(at[ax]);if(az){ay.push(az);ar=aa.getRelatedGeometryPaths([az]);if(ar&&ar.length){ay=ay.concat(ar)}}}var av,aw;if(ay.length){for(ax=0;ax<ay.length;ax++){aw=ay[ax].getBoundingSphere(N.getViewer(),"visibleSpace",true);if(aw.radius){if(!av){av=new s.Sphere().copy(aw)}else{av.mergeWithSphere(aw,av)}}}}if(av&&av.radius){N.getViewer().currentViewpoint.reframe(null,400,av,"visibleSpace")}}}}this.setActiveState=function(au){am=au;if(!al||!aa||!G){var aq=setInterval(function(){G=e.giveAnnotationModelLoader({context:N});al=m.give3DAnnotFilterController({context:N});aa=i.giveAnnotationController({context:N});if(al&&aa&&G){clearInterval(aq);A.setActiveState(am)}},10);return}if(!A.getDataModel){aa.onAdditionalInfosRequired({controller:"AnnotAttrBrowser",cb:function(){A.setActiveState(am)}});return}var ar;if(am){if(!H){D.onAdd=r.onAdd(J);D.onRemove=r.onRemove(af);D.onEmpty=r.onEmpty(ag);X.onAnnotationFilterActiveStateModified=al.subscribe("onAnnotationFilterActiveStateModified",function(){var aw=al.getAttributeTypesFiltered();var av=false;if(aw.length!==B.length){av=true}if(!av){for(ar=0;ar<aw.length;ar++){if(aw[ar]!==B[ar]){av=true;break}}}if(av){ai()}});X.onAttributesVisibilityModified=al.subscribe("onAttributesVisibilityModified",ai);Z.onAnnotControllerActiveStateChanged=aa.subscribe("onAnnotControllerActiveStateChanged",function(av){if(av.state){ai()}else{Y()}});Z.onAnnotationsLinkedDataSolved=aa.subscribe("onAnnotationsLinkedDataSolved",function(av){if(av.succeeded===true){ai()}});C.onAnnotModelLoaderActiveStateChanged=G.subscribe("onAnnotModelLoaderActiveStateChanged",function(av){if(av.state){ai()}else{Y()}});C.onAnnotationVisibilityModifiedToken=G.subscribe("onAnnotationVisibilityModified",function(av){if(av.annotNode.getAnnotationClassType()==="tpsAnnotationSet"){ai()}});C.onAnnotationSetLoadedToken=G.subscribe("onAnnotationSetLoaded",function(){V(true);ai()});C.onAnnotationSetPartiallyLoaded=G.subscribe("onAnnotationSetPartiallyLoaded",function(){V(true);ai()});C.onAnnotationSetRemovedToken=G.subscribe("onAnnotationSetRemoved",function(){ad=0;ai()});C.onAnnotationSetBeginLoadToken=G.subscribe("onAnnotationSetBeginLoad",function(){V(false)});C.onAnnotationSetLoadingFailedToken=G.subscribe("onAnnotationSetLoadingFailed",function(){V(true)});C.onNoAnnotationSetLoadedToken=G.subscribe("onNoAnnotationSetLoaded",function(av){if(av&&av.loadingAlreadyStarted){V(true)}});C.onAnnotationSetLoadingCanceledToken=G.subscribe("onAnnotationSetLoadingCanceled",function(){V(true)});C.onVisuModificationToken=G.subscribe("onAnnotationParentVisibilityModified",function(){ai()});ae=N.getViewer().onSwapVisibleSpace?N.getViewer().onSwapVisibleSpace(function(){M=N.getViewer().getVisibleSpace()===0;if(N.getViewer().getVisibleSpace()===1){ai()}else{Y()}}):null;M=N.getViewer().getVisibleSpace()===0;H=true}ai()}else{if(H){r.unsubscribe(D.onAdd);r.unsubscribe(D.onRemove);r.unsubscribe(D.onEmpty);var at=Object.keys(X);for(ar=0;ar<at.length;ar++){al.unsubscribe(X[at[ar]])}at=Object.keys(Z);for(ar=0;ar<at.length;ar++){aa.unsubscribe(Z[at[ar]])}at=Object.keys(C);for(ar=0;ar<at.length;ar++){G.unsubscribe(C[at[ar]])}if(ae&&N.getViewer()){N.getViewer().unsubscribe(ae)}ae=0;X={};C={};Z={};D={};Y();H=false}}};this.getActiveState=function(){return am};this.setPanelVisibilityFlag=function(aq){W=aq;if(y.length){y.forEach(function(ar){ar.panel.setPanelVisibilityFlag(W&&ar.attrUI.getDisplayedIDPaths().length!==0)})}};this.getPanelVisibilityFlag=function(){return W};this.clearController=function(){this.setActiveState(false);y=F=ap=Q=N=null;al=aa=G=A=B=null};this.solveAttributeLink=function(aq){if(aq&&aq.phyID){require(["DS/PADUtils/PADUtilsServices","DS/CATRelatedDataUtils/CATRelatedDataTransientWidget"],function(ar,at){ar.getSecurityContext(function(au){var av=function(ay){var az={protocol:"3DXContent",version:"0.1",source:"X3DCSMA_AP",data:{items:[{envId:ar.getPlatformId(),serviceId:"3DSpace",objectId:ay.physicalid,objectType:ay.type,contextId:au.securityContext}]}};var ax=new at();ax.showWidget({id:ay.appID,title:ay.title,data:{x3dSharedId:widget.getValue("x3dSharedId"),x3dPlatformId:widget.getValue("x3dPlatformId"),X3DContentId:JSON.stringify(az)}})};if(aq){if(aq.type&(1<<9)||aq.type&(1<<10)){var aw=b.getCommand("CAT3DAnnotSemanticSolveAttrLinkHdr",N.getCommandContext?N.getCommandContext():null);aw.launchProperties({getSecurityContext:function(){return au.securityContext},getSelectedNodes:function(){return[{attrLinkID:aq.phyID,getID:function(){return this.attrLinkID}}]}})}else{av({appID:"X3DPLAW_AP",title:aq.title?aq.title:aq.url,physicalid:aq.phyID,type:aq.phyType})}}})})}}}});var a=[];var t=n.singleton({init:function(){},give3DAnnotAttrBrowserController:function(w){if(w&&w.context){for(var v=0;v<a.length;v++){if(a[v].context===w.context){return a[v].attrBrowserController}}}return undefined},get3DAnnotAttrBrowserController:function(v){var x=this.give3DAnnotAttrBrowserController(v);if(v&&v.context&&!x){var w=new d({ctxViewer:v.context});x=Object.freeze({setActiveState:function(y){if(w){w.setActiveState(y)}},getActiveState:function(){if(w){return w.getActiveState()}return undefined},clearController:function(){if(w){w.clearController();w=null}},setPanelVisibilityFlag:function(y){if(w){w.setPanelVisibilityFlag(y)}},getPanelVisibilityFlag:function(){if(w){return w.getPanelVisibilityFlag()}return null},solveAttributeLink:function(y){if(w){w.solveAttributeLink(y)}},setDataModelMethod:function(y){if(w&&!w.dataModelInitialized){w.getDataModel=y;w.dataModelInitialized=true;if(w.getActiveState()){w._internalRefresh()}}}});a.push({context:v.context,attrBrowserController:x})}return x},unreference3DAnnotAttrBrowserController:function(w){if(w&&w.context){for(var v=0;v<a.length;v++){if(a[v].context===w.context){a[v].attrBrowserController.clearController();a.splice(v,1);break}}}}});return t});define("DS/CAT3DAnnotSemanticCmds/CAT3DAnnotSemanticAttrBrowserCmd",["DS/ApplicationFrame/CommandCheckHeader","DS/PADUtils/PADContext","DS/CAT3DAnnotSemanticCmds/controllers/CAT3DAnnotSemanticAttrBrowserCtr"],function(d,c,b){var a=d.extend({init:function(g){this._parent(g,{});var j=this;var h;var i=this.onStateChange(function(){if(!h){h=c.get()}b.get3DAnnotAttrBrowserController({context:h}).setActiveState(j.getState());localStorage.setItem("CAT3DAnnotSemanticAttrBrowserCmd",j.getState()?"true":"false")});var f=this._destroy;this._destroy=function(){if(h){b.unreference3DAnnotAttrBrowserController({context:h})}j._modelEvents.unsubscribe(i);f.call(j)};var e=localStorage.getItem("CAT3DAnnotSemanticAttrBrowserCmd");e=e==="true"?true:(e==="false"?false:undefined);this.setState(e===false?false:true,true)},_destroy:function(){this._parent()}});return a});