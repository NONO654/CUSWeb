/*!  COPYRIGHT DASSAULT SYSTEMES 2015   */
define("DS/ENOPAD3DViewer/mixins/PAD3DViewerDebugTileNodeModel",["UWA/Core","UWA/Class"],function(c,a){var b=a.extend({name:"PAD3DViewerDebugTileNodeModel",dump_representations_loaded_inViewpoint:function(){var f=this._OOCManager._getDebugJSON().references;var d=Object.keys(f);var g=[];for(var e=0;e<d.length;e++){if(f[d[e]].handlerType===0&&f[d[e]].status==="complete"&&f[d[e]].screenRadius>=0){g.push(d[e])}}console.group("Status about reps loaded in current viewpoint:");console.group("Number of reps:");console.log(g.length);console.groupEnd();console.group("List of rep ids:");console.log(JSON.stringify(g));if(typeof copy!="undefined"){copy(JSON.stringify(g));console.log("Content is copied in clipboard")}console.groupEnd();console.groupEnd()},dump_references_nbChildren:function(){var f=this._OOCManager._getDebugJSON().references;var d=Object.keys(f);var g=[];for(var e=0;e<d.length;e++){if(f[d[e]].expectedNbChildren){g.push(f[d[e]].expectedNbChildren)}}g.sort(function(i,h){if(i<h){return -1}if(i>h){return 1}return 0}).reverse();console.group("All nbChildren");console.log(JSON.stringify(g));if(typeof copy!="undefined"){copy(JSON.stringify(g));console.log("Content is copied in clipboard")}console.groupEnd()},dump_representations_loaded_outsideViewpoint:function(){var f=this._OOCManager._getDebugJSON().references;var d=Object.keys(f);var g=[];for(var e=0;e<d.length;e++){if(f[d[e]].handlerType===0&&f[d[e]].status==="complete"&&f[d[e]].screenRadius<0){g.push(d[e])}}console.group("Status about reps loaded outside current viewpoint:");console.group("Number of reps:");console.log(g.length);console.groupEnd();console.group("List of rep ids:");console.log(JSON.stringify(g));if(typeof copy!="undefined"){copy(JSON.stringify(g));console.log("Content is copied in clipboard")}console.groupEnd();console.groupEnd()},dump_representations_notLoaded_inViewpoint:function(){var f=this._OOCManager._getDebugJSON().references;var d=Object.keys(f);var g=[];for(var e=0;e<d.length;e++){if(f[d[e]].handlerType===0&&f[d[e]].status!=="complete"&&f[d[e]].screenRadius>=0){g.push(d[e])}}console.group("Status about reps not loaded in current viewpoint:");console.group("Number of reps:");console.log(g.length);console.groupEnd();console.group("List of rep ids:");console.log(JSON.stringify(g));if(typeof copy!="undefined"){copy(JSON.stringify(g));console.log("Content is copied in clipboard")}console.groupEnd();console.groupEnd()},dump_representations_notLoaded_outsideViewpoint:function(){var f=this._OOCManager._getDebugJSON().references;var d=Object.keys(f);var g=[];for(var e=0;e<d.length;e++){if(f[d[e]].handlerType===0&&f[d[e]].status!=="complete"&&f[d[e]].screenRadius<0){g.push(d[e])}}console.group("Status about reps not loaded outside current viewpoint:");console.group("Number of reps:");console.log(g.length);console.groupEnd();console.group("List of rep ids:");console.log(JSON.stringify(g));if(typeof copy!="undefined"){copy(JSON.stringify(g));console.log("Content is copied in clipboard")}console.groupEnd();console.groupEnd()},dump_references_locked:function(){var g=this._OOCManager._getDebugJSON().references;var d=Object.keys(g);var e=[];for(var f=0;f<d.length;f++){if(this.isNodeLocked(d[f])){e.push(d[f])}}console.group("Status about references locked:");console.group("Number of references:");console.log(e.length);console.groupEnd();console.group("List of reference ids:");console.log(JSON.stringify(e));if(typeof copy!="undefined"){copy(JSON.stringify(e));console.log("Content is copied in clipboard")}console.groupEnd();console.groupEnd()},dump_representations_withoutStream:function(){var f=this._OOCManager._getDebugJSON().references;var d=Object.keys(f);var g=[];for(var e=0;e<d.length;e++){if(f[d[e]].handlerType===0){if(!this._OOCManager._getLDHReference(d[e]).url){g.push(d[e])}}}console.group("Status about reps without stream:");console.group("Number of reps:");console.log(g.length);console.groupEnd();console.group("List of rep ids:");console.log(JSON.stringify(g));if(typeof copy!="undefined"){copy(JSON.stringify(g));console.log("Content is copied in clipboard")}console.groupEnd();console.groupEnd()},dump_debugJSON:function(){var d=this._OOCManager._getDebugJSON();console.group("Status OOC model:");console.log(JSON.stringify(d));if(typeof copy!="undefined"){copy(JSON.stringify(d));console.log("Content is copied in clipboard")}console.groupEnd()},dump_OOCModelStats:function(){var l=this._OOCManager._getDebugJSON().references,e=this._OOCManager._getAllInstancesDebugJSON(),d=[],o=[],n=[],h=0,g=0;var m=Object.keys(l);var k=Object.keys(e);for(h=0;h<m.length;h++){var f=l[m[h]];if(f.handlerType===1){n.push(m[h])}else{o.push(m[h])}}for(h=0;h<k.length;h++){d.push(k[h])}console.group("Stats about OOC model:");console.group("References");console.group("Number of references:");console.log(n.length);console.groupEnd();console.group("List of reference ids:");console.log(JSON.stringify(n));console.groupEnd();console.groupEnd();console.group("Instances");console.group("Number of instances:");console.log(d.length);console.groupEnd();console.group("List of instance ids:");console.log(JSON.stringify(d));console.groupEnd();console.groupEnd();console.group("Representations");console.group("Number of representations:");console.log(o.length);console.groupEnd();console.group("List of representation ids:");console.log(JSON.stringify(o));console.groupEnd();console.groupEnd();console.groupEnd()},dump_representations_projected_bbox:function(){var o=this._OOCManager._getDebugJSON().references;var j=[];var n=[];var d=[];var k=0;for(k=this._repList.length-1;k>=0;k--){var e=this._OOCManager._getLDHReference(this._repList[k].id,true);if(!e){this._repList.splice(k,1)}}if(this._repList.length){var h=this._repList[0].stamp;n.push("00:00:00.000");d.push(this._repList[0].parsingID);j.push(Math.min(this._OOCManager._getLDHReference(this._repList[0].id,true)._screenRadius,2000));for(k=1;k<this._repList.length;k++){j.push(Math.min(this._OOCManager._getLDHReference(this._repList[k].id,true)._screenRadius,2000));var l=this._repList[k].stamp.getTime()-h.getTime();var g=Math.floor(l/60000);var m=((l%60000)/1000).toFixed(0);var f=((((l%60000)/1000)-Math.floor(((l%60000)/1000)))*1000).toFixed(0);n.push("00:"+g+":"+m+"."+f);d.push(this._repList[k].parsingID)}}console.group("Projected BBox ordered as received:");console.group("Number of reps:");console.log(j.length);console.groupEnd();console.group("List of size:");console.log(JSON.stringify(j));console.groupEnd();console.group("List of dates:");console.log(JSON.stringify(n));console.groupEnd();console.group("List of query id:");console.log(JSON.stringify(d));console.groupEnd();console.groupEnd()}});return b});define("DS/ENOPAD3DViewer/commands/PAD3DViewerHideShowCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/PADUtils/PADContext"],function(d,a,c){var b=a.extend({name:"PAD3DViewerHideShowCmd",init:function(e){this._parent(e,{mode:"shared",isAsynchronous:true});this._context=c.get(this.options.context)},execute:function(){var e=this;require(["DS/Selection/CSOManager"],function(f){var h=f.get();var g=[];h.forEach(function(i){g.push(i.pathElement.clone())});e._context.getHideShowController().toggleHideShow({paths:g,dispatch:true});e.end()})},});return d.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerHideShowCmd",b)});define("DS/ENOPAD3DViewer/utils/PAD3DViewerChangeAction",["UWA/Class","DS/PADUtils/PADChangeActionHandler","DS/PADUtils/PADWSProxy","DS/PADUtils/views/PADAlert","DS/PADUtils/views/PADProgressBar","i18n!DS/PADUtils/assets/nls/PADUtils.json"],function(a,j,k,b,g,d){function i(o,m){var n=o.indexOf(m);if(n!==-1){o.splice(n,1)}}function f(q,n){var p=[];for(var m=0;m<n.length;m++){var o=q._controller.getNode({id:n[m]});if(o){p.push(o.path)}}return p}function l(n){var u=[],p,o,r={},m=[];for(p=0;p<n.results.length;p++){var v=n.results[p];if(v.attributes){var q="",t="";for(o=0;o<v.attributes.length;o++){if(v.attributes[o].name==="did"){q=v.attributes[o].value}else{if(v.attributes[o].name==="physicalid"){t=v.attributes[o].value}}if(q!==""&&t!==""){r[q]=t}}}else{if(v.path){m.push(v.path)}}}for(p=0;p<m.length;p++){var s=[];for(o=0;o<m[p].length;o++){s.push(r[m[p][o]])}u.push(s)}return u}function e(n){var v=[],p,o,r={},m=[],u=[];for(p=0;p<n.results.length;p++){var w=n.results[p];if(w.attributes){var q="",t="";for(o=0;o<w.attributes.length;o++){if(w.attributes[o].name==="did"){q=w.attributes[o].value}else{if(w.attributes[o].name==="physicalid"){t=w.attributes[o].value}}if(q!==""&&t!==""){r[q]=t}}}else{if(w.path){m.push(w.path)}}}for(p=0;p<m.length;p++){var s=[];for(o=0;o<m[p].length;o++){s.push(r[m[p][o]])}u.push({path:s,hidden:false})}return u}function c(n){var o=[];for(var m=0;m<n.length;m++){o.push({id:n[m],hidden:false})}return o}var h=a.extend({init:function(m){this._parent(m)},loadChange:function(o){var s=o.app;var r=this;var m=s._controller.getRoots();var p=s._controller.getHiddenRootIds();s._controller._startAsync();g.setText(d.retrieveChangeAction);var q=o.changes.map(function(t){return t.objectId});j.getInfos(q,function(u){s._controller._stopAsync();var t=-1;var v=function(){t++;if(t<u.length){var w=u[t];r._processCA(w,s,v)}else{s._controller.checkIfEmpty()}};v()},function n(t){s._controller.checkIfEmpty()})},_processCA:function(n,o,m){j.determineExecution(n,{addAndFind:function(z){var p=j.extractIds(z.changeaction.context);var y=j.extractRealizedAndProposed(z);var r=o._controller.getRoots().map(function(A){return A.getID()});r=r.concat(o._controller.getHiddenRootIds());var t=p.filter(function(A){return r.indexOf(A)===-1});if(t.length!==p.length){b.displayNotification({msg:d.root_already_loaded});if(t.length===0&&m){m()}}if(t.length){var x=t.length;var w;var u;var q=function(A){x--;if(x===0){o._controller.unsubscribe(w);o._controller.unsubscribe(u);if(m){m()}}};w=o._controller.subscribe({event:"onLoadingFailure"},q);u=o._controller.subscribe({event:"onRootAdded"},q);for(var s=0;s<t.length;s++){var v=k.find_in_ctx({rootId:t[s],findids:y});v.then(function(B){var A=e(B.results);if(A.length){o.addRoots({objects:A,dispatch:false})}else{b.displayNotification({msg:d.find_in_context_no_result,eventID:"info"});o.addRoots({objects:[{path:[B.params.rootId]}],dispatch:false})}})["catch"](function(A){console.error(A)})}}},add:function(r){var w=o._controller.getRoots().map(function(x){return x.getID()});w=w.concat(o._controller.getHiddenRootIds());var v=r.filter(function(x){return w.indexOf(x)===-1});if(v.length===0){b.displayNotification({msg:d.root_already_loaded});if(m){m()}}else{var q=v.length;var p;var u;var t=function(x){q--;if(q===0){o._controller.unsubscribe(p);o._controller.unsubscribe(u);if(m){m()}}};p=o._controller.subscribe({event:"onLoadingFailure"},t);u=o._controller.subscribe({event:"onRootAdded"},t);var s=c(v);o.addRoots({objects:s})}},wasEmpty:function(){o._dropZoneContainer.show("drop");if(m){m()}}})}});return h});define("DS/ENOPAD3DViewer/utils/PAD3DViewerTypesDictionary",["UWA/Class","UWA/Class/Options","text!DS/ENOPAD3DViewer/assets/typesDictionary.json"],function(c,b,a){var d=c.singleton(b,{name:"PAD3DViewerTypesDictionary",_dictionary:null,init:function(){this._dictionary=JSON.parse(a)},get:function(){return this._dictionary},});return d});define("DS/ENOPAD3DViewer/commands/PAD3DViewerFocusOnCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/PADUtils/PADContext"],function(d,b,c){var a=b.extend({name:"PAD3DViewerFocusOnCmd",init:function(e){this._parent(e,{mode:"shared",isAsynchronous:true});this._context=c.get(this.options.context)},execute:function(){var e=this;require(["DS/Selection/CSOManager","DS/PADUtils/PADCommandProxy"],function(f,g){var j=g.create();if(j){var k=f.get();var i=[];if(k.length){k.forEach(function(m){var n=m.pathElement;var l=e._context.streamPath(n);i.push(l)});var h=require("DS/PADUtils/PADUtilsServices");j.focus({intent:"focus",paths:i,widget:"3D",sharedID:h.getSharedId(),appID:h.getAppId()})}}e.end()})}});return d.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerFocusOnCmd",a)});define("DS/ENOPAD3DViewer/commands/PAD3DViewerEditPropertiesCmd",["UWA/Class","DS/ApplicationFrame/Command","DS/Selection/CSOManager","DS/PADUtils/PADContext"],function(c,b,d,e){var a=b.extend({name:"PAD3DViewerEditPropertiesCmd",_propertiesCommandPath:"DS/ENOCollabSharingCmds/commands/EditPropCmd/EditPropCmdBase",init:function(f){var g=this;this._parent(f,{mode:"shared",isAsynchronous:false});require([this._propertiesCommandPath],function(h){d.onPostAdd(function(){if(d.get().length>0){g.enable()}else{g.disable()}});d.onEmpty(function(){g.disable()});d.onRemove(function(){if(d.get().length>0){g.enable()}else{g.disable()}});if(d.get().length>0){g.enable()}else{g.disable()}},function(){g.disable()})},execute:function(){require(["DS/PADUtils/PADSettingsMgt","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices",this._propertiesCommandPath],function(m,g,j){var k=new j();var o=d.get();var n=[],h=[];for(var l=0;l<o.length;l++){n.push(o[l].pathElement)}n.forEach(function(r){while(r&&!g.isPLMNode(r.getLastElement(true))){r=r.getParentPath()}if(!r&&e.get().isSelectiveLoadingActivated()){var q=e.get().getController().getOOCSelectedReferenceID();if(q){h.push({refID:q,instID:null})}}else{var p=r.getLastElement(true);var i=r.getParentPath().getLastElement(true);h.push({refID:g.getNodeID(p),instID:g.getNodeID(i)})}});var f={getSelectedNodes:function(){var i=[];h.forEach(function(p){var q={id:p.refID,tenant:m.getSetting("x3dPlatformId"),source:"3DSpace",getID:function(){return p.refID},getRelationID:function(){return p.instID}};i.push(q)});return i},getSecurityContext:function(){return{SecurityContext:m.getSetting("pad_security_ctx"),tenant:m.getSetting("x3dPlatformId")}}};k.launchProperties(f)})}});return a});define("DS/ENOPAD3DViewer/views/PAD3DRemoveFilterPanel",["i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json","DS/PADUtils/PADSettingsMgt","UWA/Controls/Abstract","DS/PADUtils/PADContext","DS/Controls/Button","DS/Controls/Toggle"],function(a,d,b,e,g,h){var i="DS/ENOFloatingPanel/ENOFloatingPanel";var c=function(k){var j=false;if(UWA.is(k,"boolean")){j=k}else{if(UWA.is(k,"string")){j=k.toLowerCase()==="true"}}return j};"use strict";var f=b.extend({name:"padRemoveFilterPanel",widget:null,init:function(j){this._parent(j);this.container=this.options.container;this.widget=e.get().getWidget();this.options={displayRemoveFilterOpts:false,validateCB:j.events.onValidate};this.elements.container=UWA.createElement("div",{"class":this.getClassNames("-removeFilter")});if(c(this.widget.getValue("displayRemoveFilterOpt"))===true){require([i],function(k){this.elements.floatingpanel=new k({className:this.name,body:this._buildContainer(),footer:this._buildFooter(),title:a.removeFilterPanelTitle,overlay:true,closable:true,animate:true,resizable:false,visible:true,events:{onClose:function(){this.options.validateCB(c(this.widget.getValue("removeFilterFullReload")));this.elements.floatingpanel.destroy()}.bind(this)}});this.elements.floatingpanel.inject(this.container)}.bind(this),function(k){console.error("AMD loading failed : failed to load the module ENOFloatingPanel, "+k)})}else{e.get().displayNotification({eventID:"info",msg:c(this.widget.getValue("removeFilterFullReload"))===true?a.removeFilterAutoReload:a.removeFilterAutoIgnore});this.options.validateCB(c(this.widget.getValue("removeFilterFullReload")))}},_buildContainer:function(){var j=UWA.createElement("div",{"class":this.getClassNames("-bodyView")}).inject(this.elements.container);var l=UWA.createElement("p",{"class":this.getClassNames("-description")}).inject(j);l.innerText=a.removeFilterPanelDescription;var k=UWA.createElement("div",{"class":this.getClassNames("-footerView")}).inject(j);applyToggle=new h({label:a.removeFilterPanelAutoApply,checkFlag:!c(this.widget.getValue("displayRemoveFilterOpt"))});var m=UWA.createElement("div",{"class":this.getClassNames("-instruction applyToggle"),content:applyToggle});applyToggle.inject(m);m.inject(k);applyToggle.addEventListener("change",function(o){var n=o.dsModel;this.options.displayRemoveFilterOpts=!n.checkFlag;if(c(this.widget.getValue("displayRemoveFilterOpt"))!==this.options.displayRemoveFilterOpts){this.widget.setValue("displayRemoveFilterOpt",this.options.displayRemoveFilterOpts)}}.bind(this));return j},_buildFooter:function(){var l=UWA.createElement("div",{"class":this.getClassNames("-footerModal")});var k=new g({label:a.reload,emphasize:"primary",touchMode:true});var j=new g({label:a.ignore,touchMode:true});k.addEventListener("click",function(){if(c(this.widget.getValue("displayRemoveFilterOpt"))===false){this.widget.setValue("removeFilterFullReload",true)}this.options.validateCB(true);this.elements.floatingpanel.destroy()}.bind(this));j.addEventListener("click",function(){if(c(this.widget.getValue("displayRemoveFilterOpt"))===false){this.widget.setValue("removeFilterFullReload",false)}this.options.validateCB(false);this.elements.floatingpanel.destroy()}.bind(this));k.inject(l);j.inject(l);return l}});return f});define("DS/ENOPAD3DViewer/commands/PAD3DViewerRootInfoPanelCmd",["UWA/Core","DS/ApplicationFrame/CommandCheckHeader","DS/PADUtils/PADContext","DS/Core/ModelEvents"],function(e,d,c,b){var a=d.extend({_context:null,_callbackAdd:false,init:function(g){this._parent(g,{});this._context=c.get();var h=this;var f=false;if(h._context.elements.triptych&&h._context.elements.triptych._modelEvents){h._context.elements.triptych._modelEvents.subscribe({event:"triptych-hide-panel"},function(i){if(i==="left"){f=true;h.setState(false,false)}});h._callbackAdd=true}h=this;this.onStateChange(function(){if(f){f=false}else{h._context.elements.triptych.togglePanel("left")}})},addCallback:function(){if(that._callbackAdd===false){this._context.elements.triptych._modelEvents.subscribe({event:"triptych-hide-panel"},function(f){if(f==="left"){change_state_from_close=true;that.setState(false,false)}});that._callbackAdd=true}}});return a});define("DS/ENOPAD3DViewer/commands/PAD3DViewerRemoveAllCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/PADUtils/PADContext"],function(d,b,c){var a=b.extend({name:"PAD3DViewerRemoveAllCmd",init:function(e){var f=this;this._CBTokens=[];this._parent(e,{isAsynchronous:true});this._context=c.get(e.context);this._CBTokens.push(this._context.subscribe({event:"onRootAdded"},function(){f.enable()}));this._CBTokens.push(this._context.subscribe({event:"onRootRemoved"},function(){if(f._context.getRoots().length===0&&(!f._context._controller.getHiddenRootIds().length)){f.disable()}}));if(this._context.getRoots().length===0&&(!f._context._controller.getHiddenRootIds().length)){this.disable()}else{this.enable()}},destroy:function(){if(this._context){for(var e=0;e<this._CBTokens.length;e++){this._context.unsubscribe(this._CBTokens[e])}}this._CBTokens=null;this._context=null},execute:function(){var e=this;require(["DS/Selection/CSOManager","DS/Selection/HSOManager"],function(f,g){if(e._context&&e._context.name==="ENOPAD3DViewer"){e._context.getViewer().getSceneGraphOverrideSetManager().clear();e._context.empty()}f.empty();g.empty();e.end()})},});return d.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerRemoveAllCmd",a)});define("DS/ENOPAD3DViewer/commands/PAD3DViewerPrintCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/PADUtils/PADContext","DS/PADUtils/PADUtilsServices"],function(e,a,d,c){var b=a.extend({name:"PAD3DViewerPrintCmd",init:function(f){this._parent(f,{isAsynchronous:true,mode:"shared"});this._context=d.get(f.context);if(c.isMobileDevice()){this.disable()}},execute:function(){var r=1920;var k=this._context.getViewer();var A=k.SCREEN_WIDTH;var J=k.SCREEN_HEIGHT;var g=A/J;var f=g>1?r:Math.floor(r*g);var s=g>1?Math.floor(r/g):r;var o=document.createElement("canvas");o.width=f;o.height=s;var D={data:null,width:f,height:s,bufferWidth:0,bufferHeight:0,x:0,y:0};this._context.getViewer().renderToTarget(D,this._context.getViewpoint());var C=o.getContext("2d");var B=C.getImageData(0,0,o.width,o.height);if(B.width!=o.width){console.error("error");return undefined}if(B.height!=o.height){console.error("error");return undefined}var n=(D.width-1)/(B.width-1);var x=(D.height-1)/(B.height-1);var u=D.data;var L=B.data;var F,E,q,z;if(n==1&&x==1){var G=B.height;var v=B.width;var t=4*v;for(E=0;E<G;E++){q=4*(E*v);z=4*((G-E)*v);for(F=t;F--;){L[q+F]=u[z+F]}}}else{var K=function(O,N,M,P,Q){if(Q){N=P-N}return M*N+O};var y=B.height;var p=B.width;var m=D.height;var I=D.width;for(E=0;E<y;E++){var H=Math.floor(x*E);for(F=0;F<p;F++){q=4*K(F,E,p,y);z=4*K(Math.floor(n*F),H,I,m,true);L[q]=u[z];L[q+1]=u[z+1];L[q+2]=u[z+2];L[q+3]=u[z+3]}}}C.putImageData(B,0,0,0,0,o.width,o.height);var l=function(j){var i='style="max-width: 100%"';if(g<1){i='style="max-height: 95%; margin: 0px"'}var N=j.contentName;var w=o.toDataURL("image/png");var h="<!DOCTYPE html>";h+='<html style="height: 100vh; width: 100vw; margin: 0px">';h+="<head><title>"+N+"</title></head>";h+='<body style="height: 100vh; width: 100vw; margin: 0px">';h+='<img src="'+w+'" '+i+">";h+="</body>";h+="</html>";var M=window.open("","","width=800,height=600");M.document.open();M.document.addEventListener("load",function(){M.focus();M.print();M.document.close();M.close();this.end()}.bind(this),true);M.document.write(h)};this._context.getContentName({callbacks:{onComplete:l.bind(this),onFailure:l.bind(this)}})},});return e.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerPrintCmd",b)});define("DS/ENOPAD3DViewer/commands/PAD3DLineLayoutCmd",["UWA/Core","DS/ApplicationFrame/CommandCheckHeader","DS/PADUtils/PADContext"],function(d,c,b){var a=c.extend({init:function(e){this._parent(e,{});var f=this;this._layout=null;this._context=b.get(f.options.context);this._layout=this._context.getCurrentLayout();if(this._layout){this.setState(true)}this.onStateChange(function(){f.disable();if(!f._layout){require(["DS/ENOPAD3DViewer/views/PAD3DLineLayout"],function(g){f._layout=new g({context:f._context});f._context.setCurrentLayout(f._layout);f._layout.activate()})}else{if(!f.getState()){f._context.setCurrentLayout(null);f._layout.deactivate()}else{f._context.setCurrentLayout(f._layout);f._layout.activate()}}setTimeout(function(){f.enable()},1000)})},destroy:function(){this._layout.destroy()}});return d.namespace("DS/ENOPAD3DViewer/commands/PAD3DLineLayoutCmd",a)});define("DS/ENOPAD3DViewer/commands/PAD3DViewerReframeOnCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/PADUtils/PADContext"],function(d,a,c){var b=a.extend({name:"PAD3DViewerReframeOnCmd",init:function(e){this._parent(e,{isAsynchronous:true,mode:"shared"});this._context=c.get(e.context)},execute:function(){var e=this;require(["DS/Selection/CSOManager","DS/ENOPAD3DViewer/utils/PAD3DViewerVisuServices"],function(f,g){var i=f.get();var h=[];i.forEach(function(j){h.push(j.pathElement)});g.reframeOn({paths:h,viewpoint:e._context.getViewpoint()});e.end()})},});return d.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerReframeOnCmd",b)});define("DS/ENOPAD3DViewer/commands/PAD3DViewerCenterTreeCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/PADUtils/PADContext"],function(d,b,c){var a=b.extend({name:"PAD3DViewerCenterTreeCmd",init:function(e){this._parent(e,{mode:"shared",isAsynchronous:true});this._context=c.get(this.options.context)},execute:function(){var e=this;require(["DS/Selection/CSOManager"],function(f){var h=e._context.getCommandProxy();if(h){var i=f.get();var g=[];if(i.length){i.forEach(function(k){var l=k.pathElement;var j=e._context.streamPath(l);g.push(j)});h.focus({paths:g,intent:"centerTree"})}}e.end()})}});return d.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerCenterTreeCmd",a)});define("DS/ENOPAD3DViewer/mixins/PAD3DViewerDECSpecificController",["UWA/Core","UWA/Class","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADWSAccess","DS/PADUtils/PADSession","DS/PADUtils/views/PADProgressBar","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json"],function(h,b,d,g,a,f,e){var c=b.extend({name:"PAD3DViewerDECSpecificController",getAssociatedDrawingSVGs:function(k){if(!h.is(k,"object")){throw new Error("No parameter defined")}if(!h.is(k.ids,"array")){throw new Error("No input ids defined")}if(!h.is(k.callbacks,"object")){throw new Error("No callbacks function defined")}if(!h.is(k.callbacks.onComplete,"function")){throw new Error("No onComplete callback function defined")}if(!h.is(k.callbacks.onFailure,"function")){throw new Error("No onFailure callback function defined")}var j=this;function l(q){var r={};var w;try{w=h.is(q,"string")?JSON.parse(q):q}catch(m){k.callbacks.onFailure(m);return}var p={};var t={};for(var s=0;s<w.results.length;s++){var n=w.results[s];if(n.hasOwnProperty("nav_pattern")){if(!p[n.nav_pattern.physicalid]){p[n.nav_pattern.physicalid]=[]}for(var o=0;o<n.nav_pattern.linked_id.length;o++){var u=n.nav_pattern.linked_id[o];p[n.nav_pattern.physicalid].push(u);t[u]=""}}}var v=Object.getOwnPropertyNames(t);if(v.length>0){j.getAttributes({authored:true,ids:v,attributes:["ds6w:label","ds6w:modified","ds6w:created","svg"],callbacks:{onComplete:function(x){Object.getOwnPropertyNames(p).forEach(function(y){r[y]=[];p[y].forEach(function(z){r[y].push(x[z])})});k.callbacks.onComplete(r)},onFailure:function(x){k.callbacks.onFailure(x)}}})}else{k.callbacks.onComplete(p)}}var i={intent:"explore_3D",nav_pattern:[{name:"associated_drawing",direction:"to",physicalid:k.ids}],authored:true};g.navigateOnLinks({data:i,onComplete:l,onFailure:k.callbacks.onFailure})},storePositions:function(p){if(!h.is(p,"object")){throw new Error("No parameter defined")}if(!h.is(p.data,"array")){throw new Error("No input data defined")}if(!h.is(p.callbacks,"object")){throw new Error("No callbacks function defined")}if(!h.is(p.callbacks.onComplete,"function")){throw new Error("No onComplete callback function defined")}if(!h.is(p.callbacks.onFailure,"function")){throw new Error("No onFailure callback function defined")}var j=[];var k=p.userFeedback===undefined?false:true;for(var l=0;l<p.data.length;l++){var o=this.getNode({id:p.data[l].id});if(o!==undefined){p.data[l].attributes=[];var m="";m+=p.data[l].matrix.elements[0].toString()+",";m+=p.data[l].matrix.elements[1].toString()+",";m+=p.data[l].matrix.elements[2].toString()+",";m+=p.data[l].matrix.elements[4].toString()+",";m+=p.data[l].matrix.elements[5].toString()+",";m+=p.data[l].matrix.elements[6].toString()+",";m+=p.data[l].matrix.elements[8].toString()+",";m+=p.data[l].matrix.elements[9].toString()+",";m+=p.data[l].matrix.elements[10].toString()+",";m+=p.data[l].matrix.elements[12].toString()+",";m+=p.data[l].matrix.elements[13].toString()+",";m+=p.data[l].matrix.elements[14].toString();var q={name:"matrixtxt",value:m};p.data[l].attributes.push(q);delete p.data[l].matrix;j.push(o)}}var n=this;if(k){n._startAsync();f.setText(e.storePositions)}g.modify({enopad_webapis:d.getSetting("enopad_webapis"),data:p.data,onComplete:function(r){var i=h.is(r,"string")?JSON.parse(r):r;if(k){n._stopAsync()}if(i.status==="failure"){p.callbacks.onFailure(i)}else{a.setAuthoringState(true,"PADSession_enabling_authored_mode",true);n.publish({event:"onMove",data:{nodes:j}});p.callbacks.onComplete()}},onFailure:function(i){if(k){n._stopAsync()}p.callbacks.onFailure(i)}})},getEditability:function(k){if(!h.is(k,"object")){throw new Error("No parameter defined")}if(!h.is(k.data,"array")||!k.data.length){throw new Error("No input data defined")}if(!h.is(k.intent,"string")||k.intent!=="MOVE"){throw new Error("No input intent defined")}if(!h.is(k.callbacks,"object")){throw new Error("No callbacks function defined")}if(!h.is(k.callbacks.onComplete,"function")){throw new Error("No onComplete callback function defined")}if(!h.is(k.callbacks.onFailure,"function")){throw new Error("No onFailure callback function defined")}function i(p){var n={};var m;try{m=h.is(p,"string")?JSON.parse(p):p}catch(o){k.callbacks.onFailure(o);return}for(var l=0;l<m.results.length;l++){n[m.results[l].rel_physicalid]=m.results[l].value==="true"}k.callbacks.onComplete(n)}var j={ids:k.data,intent:"explore_3D",name:[k.intent.toLowerCase()],authored:true,lang:k.lang?k.lang:"en"};g.getEditability({data:j,onComplete:i,onFailure:k.callbacks.onFailure})},});return c});define("DS/ENOPAD3DViewer/utils/PAD3DViewerVisuServices",["UWA/Core","DS/Controls/Loader","DS/Visualization/Viewpoint","DS/Visualization/ThreeJS_DS"],function(g,b,c,d){function f(h){return{x:h.x,y:h.y,z:h.z}}function e(h){var k=h.camera;var j=k.getLookAt();var i={projection:h.getProjectionType()===c.PERSPECTIVE?"CONIC":"CYLINDRIC",focus:h.getTargetDistance(),near:k.near,far:k.far,up:[f(k.up)],eye:[f(k.position)],sight:[f(j)],fov:h.getAngle()};return i}var a={reframeOn:function(r){if(!UWA.is(r,"object")){throw new Error("No parameter defined")}if(!r.path&&!r.paths&&!r.BS){throw new Error("No paths or bounding sphere defined")}if(!r.viewpoint){throw new Error("No viewpoint defined")}if(r.BS){r.viewpoint.reframe(null,undefined,r.BS)}else{var s=[];if(r.path){s.push(r.path)}else{s=r.paths}var l=new d.Vector3(0,0,0),p=new d.Vector3(0,0,0),h=new d.Vector3(0,0,0);var m=0,n=0;s.forEach(function(w){var v=w.getLastElement(true).getBoundingBox().clone();var t=w.getWorldMatrix();v.applyMatrix4(t);var u=v.min,i=v.max;if(m===0){l.x=Math.min(u.x,i.x);l.y=Math.min(u.y,i.y);l.z=Math.min(u.z,i.z);p.x=Math.max(u.x,i.x);p.y=Math.max(u.y,i.y);p.z=Math.max(u.z,i.z)}else{l.x=Math.min(Math.min(u.x,i.x),l.x);l.y=Math.min(Math.min(u.y,i.y),l.y);l.z=Math.min(Math.min(u.z,i.z),l.z);p.x=Math.max(Math.max(u.x,i.x),p.x);p.y=Math.max(Math.max(u.y,i.y),p.y);p.z=Math.max(Math.max(u.z,i.z),p.z)}m++});n=Math.sqrt(Math.pow(p.x-l.x,2)+Math.pow(p.y-l.y,2)+Math.pow(p.z-l.z,2))/2;h.add(l).add(p);h.divideScalar(2);var k=r.viewpoint;var q=1.1*n/Math.tan(22.5*Math.PI/180);var o=h.clone();var j=k.control.orientation.clone();k.control.moveTo({target:o,orientation:j,distanceToTarget:q,duration:400})}},buildViewPoint:function(h){return e(h)},convertExponentialToDecimal:function(m){var q=m.toString();if(q.indexOf("e")!==-1){if(/\d+\.?\d*e[\+\-]*\d+/i.test(m)){var p="0",n=String(m).toLowerCase().split("e"),o=n.pop(),k=Math.abs(o),h=o/k,i=n[0].split(".");if(h===-1){i[0]=Math.abs(i[0]);m="-"+p+"."+new Array(k).join(p)+i.join("")}else{var j=i[1];if(j){k=k-j.length}m=i.join("")+new Array(k+1).join(p)}}return m}else{return q}}};return a});define("DS/ENOPAD3DViewer/views/PAD3DLayerView",["DS/Core/ModelEvents","DS/PADUtils/PADSettingsMgt"],function(c,b){function a(d){this._container=null;this._hideShowBtnDiv=null;this._labelDiv=null;this._deleteBtnDiv=null;this._controller=null;this._modelEvents=new c();this._buildSkeleton(d);this._bindEvents()}a.prototype.hide=function(){this._hideShowBtnDiv.classList.remove("fonticon-eye");this._hideShowBtnDiv.classList.add("fonticon-eye-off");this.publish({event:"hide"})};a.prototype.show=function(){this._hideShowBtnDiv.classList.remove("fonticon-eye-off");this._hideShowBtnDiv.classList.add("fonticon-eye");this.publish({event:"show"})};a.prototype.render=function(){return this._container};a.prototype.destroy=function(){delete this._container;delete this._hideShowBtnDiv;delete this._labelDiv;delete this._deleteBtnDiv;delete this._controller;delete this._modelEvents};a.prototype.getModelEvents=function(d){return this._modelEvents};a.prototype.publish=function(d){this.getModelEvents().publish(d)};a.prototype.subscribe=function(d,e){return this.getModelEvents().subscribe(d,e)};a.prototype.unsubscribe=function(d){this.getModelEvents().unsubscribe(d)};a.prototype._buildSkeleton=function(d){this._container=document.createElement("div");this._container.classList.add("PAD3DLayer-container");this._hideShowBtnDiv=document.createElement("div");this._hideShowBtnDiv.classList.add("PAD3DLayer-button");this._hideShowBtnDiv.classList.add("fonticon");this._hideShowBtnDiv.classList.add("fonticon-eye");this._labelDiv=document.createElement("div");this._labelDiv.classList.add("PAD3DLayer-label");this._labelDiv.innerHTML=d.label;this._deleteBtnDiv=document.createElement("div");this._deleteBtnDiv.classList.add("PAD3DLayer-button");this._deleteBtnDiv.classList.add("fonticon");this._deleteBtnDiv.classList.add("fonticon-wrong");if(this._hideShowBtnDiv!==null){this._container.appendChild(this._hideShowBtnDiv)}this._container.appendChild(this._labelDiv);this._container.appendChild(this._deleteBtnDiv)};a.prototype._bindEvents=function(){if(this._hideShowBtnDiv!==null){this._hideShowBtnDiv.onclick=function(){if(this._hideShowBtnDiv.classList.contains("fonticon-eye")){this.hide()}else{this.show()}}.bind(this)}this._deleteBtnDiv.onclick=function(){this.publish({event:"delete"})}.bind(this)};return a});define("DS/ENOPAD3DViewer/views/PAD3DLineLayout",["UWA/Core","UWA/Controls/Abstract","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement","DS/Animation/PropertyAnimation","DS/Logger/Logger","DS/Core/ModelEvents","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/SceneGraphUtils"],function(f,h,j,e,g,c,b,i,a){var d=h.extend({name:"PAD3DLineLayout",_logger:null,_context:null,_roots:null,_isActive:false,_modelToken:[],_overloadedPaths:[],_modelEvents:null,init:function(k){this._parent(k);this._logger=c.getLogger(d);this._context=k.context;var l=this;this._modelEvents=new b()},isActive:function(){return this._isActive},activate:function(){var k=this;this._roots=this._context.getRoots().slice(0);this._sceneGraphOverrideSet=new i(this._context.getController().getRootBagPath().externalPath[0]);function l(){if(k.isActive()){k.compute()}}if(this._context){this._modelToken.push(this._context.subscribe({event:"onRootDetached"},l));this._modelToken.push(this._context.subscribe({event:"onRootAttached"},l));this._modelToken.push(this._context.subscribe({event:"onRootRemoved"},l));this._modelToken.push(this._context.subscribe({event:"onLoadingComplete"},l));this._modelToken.push(this._context.subscribe({event:"onModelUpdated"},l))}this._isActive=true;this.compute()},deactivate:function(l){var k=this;this._modelToken.forEach(function(m){k._context.unsubscribe(m)});this._modelToken=[];if(this._isActive){this.resetPositions(l);this._isActive=false}},compute:function(){var p=this;this._logger.log("compute");this.publish({event:"onLayoutComputationBegin"});var r=this._context.getViewer().getSceneGraphOverrideSetManager();if(r){r.pushSceneGraphOverrideSet(this._sceneGraphOverrideSet)}var k=this._context.getRoots().slice(0);if(undefined!==k){var q=[];var n=0;var l=0;for(l=k.length-1;l>=0;l--){var m=k[l].getBoundingBox();var o=Math.abs(m.max.x-m.min.x);if(o===Infinity){k.splice(l,1)}}k.forEach(function(s){var t=s.getBoundingBox();var u=Math.abs(t.max.x-t.min.x);if(u!==Infinity){q.push({xSize:t.max.x-t.min.x,zMin:t.min.z,center:(t.min.clone().add(t.max)).divideScalar(2)});if(n<u){n=u}}});l=0;k.forEach(function(s){if(Math.round(s.getMatrix().elements[12])!=Math.round(-(q[l].center.x+n*l*1.2))||Math.round(s.getMatrix().elements[13])!=Math.round(-q[l].center.y)||Math.round(s.getMatrix().elements[14])!=Math.round(-q[l].zMin)){var v=new e();v.addElement(p._context.getController()._model.getRootBag());v.addElement(s);p._overloadedPaths.push(v);var t=r.computeAppliedPosition(v);if(t===null){t=v.getLastElement(true).getMatrix()}var w={_duration:1000,_startX:t.elements[12],_startY:t.elements[13],_startZ:t.elements[14],_endX:-(q[l].center.x+n*l*1.2),_endY:-q[l].center.y,_endZ:-q[l].zMin,_path:v,duration:function(){return this._duration},valueAt:function(C){var B=this._startX+(this._endX-this._startX)*(C/this._duration),A=this._startY+(this._endY-this._startY)*(C/this._duration),z=this._startZ+(this._endZ-this._startZ)*(C/this._duration);var x=new j.Matrix4().makeTranslation(B,A,z);var y=p._sceneGraphOverrideSet.getUniqueOverrideFromPathElement(this._path);if(!y){y=p._sceneGraphOverrideSet.createOverride(this._path)}y.setPosition(x);p._context._viewer.render({updateInfinitePlane:true})}};var u=new g(s,"setMatrix",w);u.start()}l++});setTimeout(function(){p._context._viewer.render({updateInfinitePlane:true});p._context.reframe();p.publish({event:"onLayoutComputationEnd"})},1100)}},destroy:function(){this._logger.log("destroy");this.deactivate(false)},resetPositions:function(l){l=l===undefined?true:l;var k=this;var n=this._context.getViewer().getSceneGraphOverrideSetManager();if(n){n.pushSceneGraphOverrideSet(this._sceneGraphOverrideSet)}if(this._overloadedPaths&&this._overloadedPaths.length>0){this.publish({event:"onLayoutComputationBegin"});var m=1000;if(!l){m=1}this._overloadedPaths.forEach(function(r){var o=n.computeAppliedPosition(r);n.removeSceneGraphOverrideSet(k._sceneGraphOverrideSet);var q=n.computeAppliedPosition(r);if(q===null){q=r.getLastElement(true).getMatrix()}n.pushSceneGraphOverrideSet(k._sceneGraphOverrideSet);if(o&&q){var s={_duration:m,_startX:o.elements[12],_endX:q.elements[12],_startY:o.elements[13],_endY:q.elements[13],_startZ:o.elements[14],_endZ:q.elements[14],_path:r,duration:function(){return this._duration},valueAt:function(y){var x=this._startX+(this._endX-this._startX)*(y/this._duration),w=this._startY+(this._endY-this._startY)*(y/this._duration),v=this._startZ+(this._endZ-this._startZ)*(y/this._duration);var t=new j.Matrix4().makeTranslation(x,w,v);if(y===this._duration){if(n){n.removeSceneGraphOverrideSet(k._sceneGraphOverrideSet);delete k._sceneGraphOverrideSet}}else{var u=k._sceneGraphOverrideSet.getUniqueOverrideFromPathElement(this._path);if(!u){u=k._sceneGraphOverrideSet.createOverride(this._path)}else{u.setPosition(t)}}k._context._viewer.render({updateInfinitePlane:true})}};var p=new g(r.getLastElement(true),"setMatrix",s);p.start()}});setTimeout(function(){k._context._viewer.render({updateInfinitePlane:true});k._context.reframe();k.publish({event:"onLayoutComputationEnd"})},m+100)}},publish:function(k){this.getModelEvents().publish(k)},subscribe:function(k,l){return this.getModelEvents().subscribe(k,l)},unsubscribe:function(k){this.getModelEvents().unsubscribe(k)},getModelEvents:function(){return this._modelEvents}});return f.namespace("DS/ENOPAD3DViewer/views/PAD3DLineLayout",d)});define("DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices",["UWA/Core","DS/PADUtils/PADSettingsMgt","DS/Visualization/Node3D"],function(d,b,c){var a={toUnique:function(f,e,g){e=f.length;if(e>1){while(g=--e){while(g--){if(f[e]===f[g]){f.splice(g,1)}}}}return f},equals:function(f,e){var g=false;if(this.isPLMNode(f)&&this.isPLMNode(e)){g=this.getNodeID(f)===this.getNodeID(e)}return g},isAModelPath:function(g){var f=false;if(g){for(var e=0;e<g.externalPath.length;e++){if(g.externalPath[e].name==="RootBag"){f=true;break}}}return f},isAPOIPath:function(g){var f=false;if(g){for(var e=0;e<g.externalPath.length;e++){if(g.externalPath[e].className==="PAD3DPOINode"){f=true;break}}}return f},getNodeID:function(e){var f=null;if(this.isPLMNode(e)){if(b.getSetting("enopad3dviewer_lightNodeModel")){f=e.getModelIdentification()}else{f=e.getID()}}return f},getNodeType:function(f){var e=null;if(this.isPLMNode(f)){if(b.getSetting("enopad3dviewer_lightNodeModel")){e=f.getUserData&&f.getUserData()?f.getUserData().type:null}else{e=f.getType()}}return e},getLoadedStream:function(e){var f=null;if(this.isPLMNode(e)){if(b.getSetting("enopad3dviewer_lightNodeModel")){if(this.isRepReference(e)){f=e.getUserData&&e.getUserData()?e.getUserData().loadedStream:null}}else{f=e.getLoadedStream()}}return f},isReference:function(f){var e=false;if(this.isPLMNode(f)){if(b.getSetting("enopad3dviewer_lightNodeModel")){e=f.isOOCReference()}else{e=f.isPLMReference()}}return e},isInstance:function(e){var f=false;if(this.isPLMNode(e)){if(b.getSetting("enopad3dviewer_lightNodeModel")){f=e.isOOCInstance()}else{f=e.isPLMInstance()}}return f},isRepReference:function(e){var f=false;if(this.isPLMNode(e)){if(b.getSetting("enopad3dviewer_lightNodeModel")){f=e.isOOCRepReference()}else{f=e.isPLMRepReference()}}return f},isRepInstance:function(e){var f=false;if(this.isPLMNode(e)){if(b.getSetting("enopad3dviewer_lightNodeModel")){f=e.isOOCRepInstance()}else{f=e.isPLMRepInstance()}}return f},is3DLeaf:function(f){var e=false;if(this.isPLMNode(f)){if(b.getSetting("enopad3dviewer_lightNodeModel")){e=f.isOOCRepReference()}else{e=f.is3DLeaf()}}return e},isPLMNode:function(e){var f=false;if(b.getSetting("enopad3dviewer_lightNodeModel")){f=e&&e.modelIdentification!==null&&e.modelIdentification!==undefined?true:false}else{f=e&&e.className==="PAD3DViewerNode"?true:false}return f},isFiltered:function(f,e){return e.getController().isFiltered(this.getNodeID(f)).hasFilter},getBIColor:function(f){var e=null;if(this.isPLMNode(f)){if(b.getSetting("enopad3dviewer_lightNodeModel")){e=f.getUserData&&f.getUserData()?f.getUserData().BIColor:null}else{e=f.getBIColor()}}return e},getRoots:function(f){var e=null;if(b.getSetting("enopad3dviewer_lightNodeModel")){e=f.getController().getRootBag().children}else{e=f.getController().getRoots()}return e},getSiblings:function(g){var h=[],e=g;var f=this;g.parents.forEach(function(i){i.children.forEach(function(j){if(!f.equals(j,e)){h.push(j)}})});return this.toUnique(h)},getReferences:function(f){var e=[];if(this.isRepInstance(f)){e=f.parents}else{if(this.isReference(f)){e.push(f)}else{if(this.isRepReference(f)){f.parents.forEach(function(g){e=e.concat(g.parents)})}else{if(this.isInstance(f)){e=f.children}}}}return this.toUnique(e)},isLeaf:function(f){var g=true;var e=this;f.children.forEach(function(h){if(!e.isRepInstance(h)){g=false}});return this.isReference(f)&&g},getRootReferences:function(g,e){if(!e){e=[]}var f=this;if(g.parents.length===1&&g.parents[0].name==="RootBag"){e.push(g);return f.toUnique(e)}else{g.parents.forEach(function(h){f.getRootReferences(h,e)});return f.toUnique(e)}}};return a});define("DS/ENOPAD3DViewer/mixins/PAD3DViewerQueryParser",["DS/PADUtils/PADProbes","DS/Visualization/ThreeJS_DS"],function(b,c){var a={name:"PAD3DViewerQueryParser",_buildFromJSONOcc:function(M){var E=this;var k=M.hidden!==undefined?M.hidden:false;var T=window.localStorage.getItem("TileModelDebug")==="ON";E.nbCgrLoaded=0;E.nbThbLoaded=0;var D=[];var w=[];var P=0;var d=[];var G=[];var A={};var f=null;var m=function(){var i=D.slice(0);var j=w.slice(0);M.callbacks.onComplete({id:M.rootIds[0],ids:M.rootIds,createdPaths:i,selectedPaths:j,BS:f});D=null;w=null;M=null;E=null};var g=function(){if(--P===0){m()}};this._parsingRunning=true;this.parsingProbe=b.createProbe("Parsing "+M.json.results.length+" results and building structure");var O=window.performance.now();var h=null;var B=new Map();var C=new Map();var x={};var u=0;var v=0;var R=0;var e=0;var K=M.json.results.length;var n=M.json.results;var N=0;this._OOCManager.startInstRefGraphTransaction();for(N=0;N<K;N++){if(this._OOCManager.isCPUMemoryFull()){break}var H=n[N];var z=null;var J=null;if(H.attributes!==undefined){u++;var F={};this._parseAttributes(H.attributes,F,M.extraAttribute);if(F.globalType!=="ds6w:Instance"&&F.type!=="VPMRepInstance"){if(F.thbUrl||F.cgrUrl){R++}if(!this._OOCManager.isRegistered(F.pid)){G.push(F.pid);if(H.boundingbox){var t=this._parseBoundingElements(H.boundingbox);J=t.boundingBox;z=t.boundingSphere}if((F.thbUrl||F.cgrUrl)){e++}var y=null;var S=null;if(F.globalType==="ds6w:Document"){if(M.streamToLoad==="thumbnail"&&F.thbUrl){y=F.thbUrl;S="thumbnail";E.nbThbLoaded++}else{y=F.cgrUrl;S="cgr";E.nbCgrLoaded++}if(!y){z.radius=0}if(T){this._repList.push({id:F.pid,stamp:new Date(Date.now()),parsingID:O})}}this._OOCManager.registerReference(F.pid,{handler:F.globalType==="ds6w:Document"?this._model3DHandler:this._refHandler,boundingBox:z&&z.radius>0?J:undefined,boundingSphere:z,url:y,loadModelOptions:F.globalType==="ds6w:Document"?{noMeshInRAM:true}:null});if(H.nbchildren!==undefined){if(M.partialOpen&&M.partialOpenPath.indexOf(F.pid)!=-1&&M.partialOpenPath.indexOf(F.pid)!=(M.partialOpenPath.length-1)){this._OOCManager.lockChildren(F.pid)}if(M.blockNbChildren){this._OOCManager.setExpectedNbChildren(F.pid,0)}else{this._OOCManager.setExpectedNbChildren(F.pid,parseInt(H.nbchildren))}}this._OOCManager.setUserData(F.pid,{type:F.type,loadedStream:S})}if(F.globalType==="ds6w:Document"){d.push(F.pid)}if(M.intent==="addRoot"){if(M.rootIds.indexOf(F.pid)!==-1){if(M.reframe===true){M.callbacks.onReframe({BS:z,rootBS:true})}if(!this.getRoot({id:F.pid})){var Q=this._OOCManager.addRoot(F.pid,{handler:F.thbUrl?this._model3DHandler:F.cgrUrl?this._model3DHandler:this._refHandler,boundingBox:z&&z.radius>0?J:undefined,boundingSphere:z});this._OOCManager.addSceneGraphLock(F.pid);this._rootIndex[F.pid]={occId:Q,setSequenceFilter:function(i){this._sequenceFilter=i},setConfigFilter:function(i){this._configFilter=i},setCVFilterQuery:function(i){this._CVFilterQuery=i},getSequenceFilter:function(){return this._sequenceFilter},getConfigFilter:function(){return this._configFilter},getCVFilterQuery:function(W,V,i){var j=i==="V1"?{V1:{}}:{V2:{}};var U=null;if(V&&V.GetFilterSpec){U=V.GetFilterSpec(W,j).CVQuery3D}return U}.bind(this,F.pid)}}f=z}}if(M.extraAttribute){if(!A[F.pid]){A[F.pid]={};if(F[M.extraAttribute]){A[F.pid][M.extraAttribute]=F[M.extraAttribute]}}}C.set(F.did,F.pid)}else{B.set(F.did,F);C.set(F.did,F.pid)}}else{if(H.path!==undefined){v++;var o=""+H.path[0];var s=C.get(o);var I=[s];for(var L=1;L<H.path.length;L++){I.push(C.get(""+H.path[L]));if(L%2===1){var q=""+H.path[L];var r=C.get(q);var l=""+H.path[L+1];var p=C.get(l);if(!this._OOCManager.isRegistered(r)){this._OOCManager.addChild(s,p,{matrix:B.get(q).matrix,instanceId:r});this._OOCManager.setUserData(r,{type:B.get(q).type});B["delete"](q)}o=l;s=p}}if(M.forceLoad){this.lockNodes({ids:[I[I.length-1]]})}w.push(I)}}}E.publish({event:"onUrlLoaded",data:{nbCgrLoaded:E.nbCgrLoaded,nbThbLoaded:E.nbThbLoaded}});this._OOCManager.endInstRefGraphTransaction();E.parsingProbe.end();delete E.parsingProbe;this.statProb=b.createProbe("nbRef: "+u+" / nbUrl : "+R+" / nbNewUrl : "+e+" / nbPath : "+v);E.statProb.end();delete E.statProb;M.json=null;delete M.json;E._parsingRunning=false;if(d.length&&M.extraAttribute){E.publish({event:"colorOverridePostProcess",data:{leavesToColorize:d,hashMap:A}})}if(G.length){E.publish({event:"newNodes",data:{newNodes:G}})}if(P===0){m()}},_buildFromJSONInstRef:function(k){var l=this;var C=k.hidden!==undefined?k.hidden:false;var p=window.localStorage.getItem("TileModelDebug")==="ON";l.nbCgrLoaded=0;l.nbThbLoaded=0;var E=[];var r=[];var d=0;var y=[];var q=[];var F={};var D=null;var o=function(){var i=E.slice(0);var I=r.slice(0);k.callbacks.onComplete({id:k.rootIds[0],ids:k.rootIds,createdPaths:i,selectedPaths:I,BS:D});E=null;r=null;k=null;l=null};var v=function(){if(--d===0){o()}};this._parsingRunning=true;this.parsingProbe=b.createProbe("Parsing "+k.json.results.length+" results and building structure");var f=window.performance.now();var g=null;var H={nbRef:0,nbNewRef:0,nbRep:0,nbNewRep:0,nbInst:0,nbNewInst:0,nbUrl:0,nbNewUrl:0,nbObj:0,timing:0};var s=k.json.results.length;var x=k.json.results;var u=new Date();var B=0;this._OOCManager.startInstRefGraphTransaction();for(B=0;B<s;B++){if(this._OOCManager.isCPUMemoryFull()){break}H.nbObj++;var G=x[B];var n=null;var m=null;var e=null;var j=null;if(G["ds6w:globaltype"]==="ds6w:Document"){G.nbchildren="0";y.push(G.resourceid);if(!this._OOCManager.isRegistered(G.resourceid)){q.push(G.resourceid);if(G.boundingbox){var w=this._parseBoundingElements(G.boundingbox);m=w.boundingBox;n=w.boundingSphere}if(k.streamToLoad==="thumbnail"&&G.thumbnail_3d){e=G.thumbnail_3d;j="thumbnail";this.nbThbLoaded++}else{e=G.cgr;j="cgr";this.nbCgrLoaded++}if(!e&&n){n.radius=0;m=undefined}this._OOCManager.registerReference(G.resourceid,{handler:this._model3DHandler,boundingBox:m,boundingSphere:n,url:e,loadModelOptions:{noMeshInRAM:true}});if(G.nbchildren!==undefined){if(k.partialOpen&&k.partialOpenPath.indexOf(G.resourceid)!=-1&&k.partialOpenPath.indexOf(G.resourceid)!=(k.partialOpenPath.length-1)){this._OOCManager.lockChildren(G.resourceid)}if(k.blockNbChildren){this._OOCManager.setExpectedNbChildren(G.resourceid,0)}else{this._OOCManager.setExpectedNbChildren(G.resourceid,parseInt(G.nbchildren))}}this._OOCManager.setUserData(G.resourceid,{type:G["ds6w:type"],loadedStream:j});if(p){this._repList.push({id:G.resourceid,stamp:new Date(Date.now()),parsingID:f})}if(G.thumbnail_3d||G.cgr){H.nbNewUrl++}H.nbNewRep++}if(k.forceLoad){this.lockNodes({ids:[G.resourceid]})}if(G.thumbnail_3d||G.cgr){H.nbUrl++}H.nbRep++}else{if(G["ds6w:globaltype"]==="ds6w:Part"){if(!this._OOCManager.isRegistered(G.resourceid)){if(G.boundingbox){var w=this._parseBoundingElements(G.boundingbox);m=w.boundingBox;n=w.boundingSphere}this._OOCManager.registerReference(G.resourceid,{handler:this._refHandler,boundingBox:m,boundingSphere:n,url:null,loadModelOptions:null});if(G.nbchildren!==undefined){if(k.partialOpen&&k.partialOpenPath.indexOf(G.resourceid)!=-1&&k.partialOpenPath.indexOf(G.resourceid)!=(k.partialOpenPath.length-1)){this._OOCManager.lockChildren(G.resourceid)}if(k.blockNbChildren){this._OOCManager.setExpectedNbChildren(G.resourceid,0)}else{this._OOCManager.setExpectedNbChildren(G.resourceid,parseInt(G.nbchildren))}}this._OOCManager.setUserData(G.resourceid,{type:G["ds6w:type"],loadedStream:null});H.nbNewRef++}H.nbRef++}else{if(!this._OOCManager.isRegistered(G.resourceid)&&G.from!==undefined&&G.to!==undefined){var A=this._parseMatrix(G.matrixtxt);this._OOCManager.addChild(G.from,G.to,{matrix:A,instanceId:G.resourceid});this._OOCManager.setUserData(G.resourceid,{type:G["ds6w:type"]});H.nbNewInst++}H.nbInst++}}if(k.intent==="addRoot"){if(k.rootIds.indexOf(G.resourceid)!==-1){delete k.intent;if(k.reframe===true){k.callbacks.onReframe({BS:n,rootBS:true})}if(!this.getRoot({id:G.resourceid})){var z=this._OOCManager.addRoot(G.resourceid,{handler:G["ds6w:globaltype"]==="ds6w:Document"?this._model3DHandler:this._refHandler,boundingBox:m,boundingSphere:n});this._OOCManager.addSceneGraphLock(G.resourceid);this._rootIndex[G.resourceid]={occId:z,setSequenceFilter:function(i){this._sequenceFilter=i},setConfigFilter:function(i){this._configFilter=i},setCVFilterQuery:function(i){this._CVFilterQuery=i},getSequenceFilter:function(){return this._sequenceFilter},getConfigFilter:function(){return this._configFilter},getCVFilterQuery:function(L,K,i){var I=i==="V1"?{V1:{}}:{V2:{}};var J=null;if(K&&K.GetFilterSpec){J=K.GetFilterSpec(L,I).CVQuery3D}return J}.bind(this,G.resourceid)}}}}if(k.extraAttribute){if(!F[G.resourceid]){F[G.resourceid]={};if(G[k.extraAttribute]){F[G.resourceid][k.extraAttribute]=G[k.extraAttribute]}}}}this._OOCManager.endInstRefGraphTransaction();this.parsingProbe.end();delete this.parsingProbe;var h=new Date();var t=h-u;t/=1000;H.timing=t+"s";this.statProb=b.createProbe(JSON.stringify(H));this.statProb.end();delete this.statProb;k.json=null;delete k.json;this._parsingRunning=false;if(y.length&&k.extraAttribute){this.publish({event:"colorOverridePostProcess",data:{leavesToColorize:y,hashMap:F}})}this.publish({event:"onUrlLoaded",data:{nbCgrLoaded:this.nbCgrLoaded,nbThbLoaded:this.nbThbLoaded}});if(q.length){l.publish({event:"newNodes",data:{newNodes:q}})}if(d===0){o()}},_parseBoundingElements:function(f){var d=new c.Box3(new c.Vector3(parseFloat(f.min[0]),parseFloat(f.min[1]),parseFloat(f.min[2])),new c.Vector3(parseFloat(f.max[0]),parseFloat(f.max[1]),parseFloat(f.max[2])));var e=d?d.getBoundingSphere():null;if(d.max.x<d.min.x){e.radius=0;d=undefined}return{boundingBox:d,boundingSphere:e}},_parseMatrix:function(d){var e=null;if(d!==undefined&&d!=="1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0"&&d!=="1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0"&&d!=="1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0"){e=new c.Matrix4();var f=d.split(/[,]/);e.elements[0]=parseFloat(f[0]);e.elements[1]=parseFloat(f[1]);e.elements[2]=parseFloat(f[2]);e.elements[4]=parseFloat(f[3]);e.elements[5]=parseFloat(f[4]);e.elements[6]=parseFloat(f[5]);e.elements[8]=parseFloat(f[6]);e.elements[9]=parseFloat(f[7]);e.elements[10]=parseFloat(f[8]);e.elements[12]=parseFloat(f[9]);e.elements[13]=parseFloat(f[10]);e.elements[14]=parseFloat(f[11])}return e},};return a});define("DS/ENOPAD3DViewer/utils/PAD3DViewerRestoreSession",[],function(){var d=false,e=false,h=false,g,a;function f(j){var k=a.getValue("PAD3DViewerRootsDetached");k=k?JSON.parse(k):undefined;if(!k){a.addPreference({name:"PAD3DViewerRootsDetached",type:"hidden"});k=[]}var i=k.filter(function(l){return j.id!==l});if(i.length!==k.length){a.setValue("PAD3DViewerRootsDetached",JSON.stringify(i))}}function c(i){var j=a.getValue("PAD3DViewerRootsDetached");j=j?JSON.parse(j):undefined;if(!j){a.addPreference({name:"PAD3DViewerRootsDetached",type:"hidden"});j=[]}if(!j.some(function(k){return k===i.id})){j.push(i.id);a.setValue("PAD3DViewerRootsDetached",JSON.stringify(j))}}function b(j){var i=a.getValue("PAD3DViewerPathsInSession");i=i?JSON.parse(i):undefined;if(!i){a.addPreference({name:"PAD3DViewerPathsInSession",type:"hidden"})}a.setValue("PAD3DViewerPathsInSession",JSON.stringify(j.rootLog));if(j.hidden===true){c(j)}}return{init:function(j){if(d){return}if(typeof j!=="object"){throw new Error("No parameter defined")}if(!j.pad3DViewer){throw new Error("No pad3DViewer defined")}if(!j.widget){throw new Error("No widget defined")}d=true;g=j.pad3DViewer;a=j.widget;a.addEventOnce("onDestroy",function(){d=e=h=false;g=a=undefined});var i=g.subscribe({event:"onReady"},function(){h=true;g.unsubscribe(i);i=null});g.subscribe({event:"onRootAdded"},b);g.subscribe({event:"onRootRemoved"},function(k){b(k);f(k)});g.subscribe({event:"onRootAttached"},f);g.subscribe({event:"onRootDetached"},c)},restoreSession:function(){var k={objectsLoading:false};if(!d||!g||!a||!h){throw new Error("init method must be called first")}if(e){return k}e=true;var i=a.getValue("PAD3DViewerPathsInSession");i=i?JSON.parse(i):undefined;var l=a.getValue("X3DContentId");a.deleteValue("X3DContentId");if(i&&i.length>0){var m=a.getValue("PAD3DViewerRootsDetached");m=m?JSON.parse(m):[];var j=[];i.forEach(function(o){if(!o||!o.length){return}var n=o[0];j.push({path:o,hidden:m.some(function(p){return n===p})})});g.addRoots({objects:j},false);k.objectsLoading=true}else{if(l){g.addRootNodesFromContent({json3DXContent:JSON.parse(l),dispatch:false});k.objectsLoading=true}}return k}}});define("DS/ENOPAD3DViewer/views/PAD3DLayerWindow",["DS/Windows/Panel"],function(a){function b(c){this._list=null;this._panel=null;this._parentContainer=c.renderTo;this._buildSkeleton()}b.prototype._buildSkeleton=function(){this._list=document.createElement("div");this._list.classList.add("PAD3DLayerWindow-container");this._panel=new a({title:"Layers",immersiveFrame:this._parentContainer,content:this._list,resizableFlag:false,width:200,height:"auto",currentDockArea:8,allowedDockAreas:12,collapsibleFlag:false,verticallyStretchableFlag:navigator.userAgent.match(/Android|iPhone|iPod|BlackBerry|Opera Mini|IEMobile/i)?false:true,closeButtonFlag:false})};b.prototype.hide=function(){this._panel.hide()};b.prototype.show=function(){this._panel.show()};b.prototype.appendChild=function(c){this._list.appendChild(c)};b.prototype.removeChild=function(c){this._list.removeChild(c)};return b});define("DS/ENOPAD3DViewer/views/PAD3DPushpinCanvasNode",["DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","DS/SceneGraphNodes/CanvasNodeTexture"],function(c,d,b){function a(e){this._fillColor=e.fillColor?e.fillColor:null;this._borderColor=e.borderColor?e.borderColor:"#000000";this._width=20;this._height=32;this._pois=e.pois?e.pois:[];this._colors=e.colors?e.colors:[];this._matrices=e.matrices?e.matrices:[];this._highlight=e.highlight?e.highlight:null}a.prototype.render=function(){var e=new b({width:this._width,height:this._height,drawCB:this._draw.bind(this)});var f=c.createCanvas2DInstancingNode({canvasNodeTexture:e,hotspot:new d.Vector2(this._width/2,this._height/2),nbInstances:this._pois.length,matrices:this._matrices,colors:this._colors});return f};a.prototype._draw=function(f,e){e.fillStyle="#ffffff";e.save();e.translate(this._width/2,this._height);e.beginPath();e.moveTo(0,0);e.bezierCurveTo(2,-10,-20,-25,0,-30);e.bezierCurveTo(20,-25,-2,-10,0,0);e.fill();e.lineWidth=1.5;e.fillStyle="#000000";e.stroke();e.beginPath();e.arc(0,-21,3,0,Math.PI*2);e.closePath();e.fill()};return a});define("DS/ENOPAD3DViewer/commands/PAD3DViewerRemoveRootCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/PADUtils/PADContext"],function(e,b,c,d){var a=b.extend({name:"PAD3DViewerRemoveRootCmd",init:function(f){this._parent(f,{isAsynchronous:true});this._context=d.get(f.context)},execute:function(){var f=this;require(["DS/Selection/CSOManager","DS/Selection/HSOManager"],function(g,h){var j=g.get();var i=[];j.forEach(function(l){var k=l.pathElement.getLastElement(true);if(c.isPLMNode(k)){i.push(c.getNodeID(k))}});g.empty();h.empty();if(i.length){f._context.removeRoots({pids:i},true);f._context.getViewer().render({updateInfinitePlane:true});f._context.reframe()}f.end()})},});return e.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerRemoveRootCmd",a)});define("DS/ENOPAD3DViewer/commands/PAD3DViewerRightSidePanel",["DS/PADUtils/commands/RightSidePanel","DS/Selection/CSOManager","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADContext","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(f,a,b,e,c){var d=f.extend({getXSO:function(){return a},getID:function(i){var h;var j=i.pathElement;while(j&&!c.isPLMNode(j.getLastElement(true))){j=j.getParentPath()}if(!j&&e.get().isSelectiveLoadingActivated()){h=e.get().getController().getOOCSelectedReferenceID()}else{var g=j.getLastElement(true);h=c.getNodeID(g)}return h},getTriptych:function(){return e.get().elements.triptych},onTriptychReady:function(h){var g=e.get().subscribe({event:"on3DTriptychReady"},function(j){h.call(e.get().elements.triptych);var i=require("DS/PADServices/utils/GlobalModelEvents");i.unsubscribe(g)})}});return d});define("DS/ENOPAD3DViewer/commands/PAD3DViewerDefineFilterCmd",["DS/ENONextGenFilterCmd/commands/ENONextGenFilterCmd","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADContext","DS/PADUtils/PADSession","DS/Selection/CSOManager"],function(h,e,g,d,f,a,b){var c=h.extend({_hasCSV:false,_openFilterPanelNow:false,init:function(i){this._parent(i);f.get().getController().getModelEvents().subscribe({event:"onRootRemoved"},function(j){this.setAvailabilityFromRolesAndRoots()}.bind(this));f.get().getModelEvents().subscribe({event:"grantedRoleRetrieved"},function(j){this.checkRoles(j);this.setAvailabilityFromRolesAndRoots()}.bind(this));f.get().getController().getModelEvents().subscribe({event:"onRootAdded"},function(j){this.setAvailabilityFromRolesAndRoots()}.bind(this));a.subscribe({event:"authoringStateModified"},function(k){var j=this.getAvailability();if(j&&!k.authored){this.setAvailabilityFromRolesAndRoots()}else{this.disable()}}.bind(this));this.checkRoles(d.getSetting("enopad3dviewer_roles"));this.setAvailabilityFromRolesAndRoots()},setAppParams:function(i){this._widgetId=i.widgetId;this._appId=i.appId},setOpenFilterNow:function(i){this._openFilterPanelNow=true;this._SelectedID=i},getAppParams:function(){return{widgetId:g.getWidgetId(),appId:g.getSharedId()}},getRoots:function(){if(this._openFilterPanelNow!==false){this._openFilterPanelNow=false;var k=[];var m=f.get().getController().getRoot({id:this._SelectedID});k.push({id:this._SelectedID,filtered:e.isFiltered(m,f.get())});return k}else{var k=[];var j=f.get().getController().getRoots();for(var l=0;l<j.length;++l){k.push({id:e.getNodeID(j[l]),filtered:e.isFiltered(j[l],f.get())})}return k}},getSelection:function(){var k=b.get();var l=[];if(k.length>0){for(var j=0;j<k.length;++j){if(k[j].pathElement!==null){l.push(f.get().streamPath(k[j].pathElement))}}}return{path:l}},getSelectorManager:function(){return b||null},checkRoles:function(k){for(var j=0;j<k.length;++j){if(k[j].id==="CSV"||k[j].id==="InternalDS"){this._hasCSV=true;return}}this._hasCSV=false},setAvailabilityFromRolesAndRoots:function(){if(!this.isEnabled()&&this._hasCSV===true&&f.get().getController().getRoots().length>0){this.enable()}else{if(f.get().getController().getRoots().length===0){this.disable()}}}});return c});define("DS/ENOPAD3DViewer/commands/PAD3DViewerRelationalNavigatorCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/Selection/CSOManager","DS/PADUtils/PADContext","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(f,a,b,d,c){var e=a.extend({name:"PAD3DViewerRelationalNavigatorCmd",init:function(g){this._parent(g,{mode:"shared",isAsynchronous:true});var h=this;this._context=d.get(g.context);function j(k){var l=false;for(var m=0;m<k.length;m++){if(c.isAModelPath(k[m].pathElement)){l=true;break}}return l}function i(){if(j(b.get())){h.enable()}else{h.disable()}}this._CBTokens=[];this._CBTokens.push(b.onAdd(function(){i()}));this._CBTokens.push(b.onEmpty(function(){h.disable()}));this._CBTokens.push(b.onRemove(function(){i()}));i()},destroy:function(){for(var g=0;g<this._CBTokens.length;g++){b.unsubscribe(this._CBTokens[g])}this._CBTokens=null;this._context=null},execute:function(){var g=this;require(["DS/PADUtils/PADUtilsServices"],function(j){var i=b.get();var h=[];i.forEach(function(l){var m=l.pathElement;var k=m.getLastElement(true);while(!c.isPLMNode(k)){k=k.parents[0]}var o=g._context.streamPath(m);var n={options:{type:c.getNodeType(k),grid:{"ds6w:type":""}},getID:function(){return c.getNodeID(k)},getLabel:function(){return undefined},getOccurencePathWithType:function(){return o}};h.push(n)});j.setObject_on_compass({nodes_2_open:h});j.open_app({appId:"ENORIPE_AP"},function(){});g.end()})}});return f.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerRelationalNavigatorCmd",e)});define("DS/ENOPAD3DViewer/commands/PAD3DViewerFilterDropObjectsCmd",["i18n!DS/PADUtils/assets/nls/PADUtils.json","DS/ApplicationFrame/Command","DS/PADUtils/PADSession","DS/PADUtils/PADContext","DS/PADUtils/views/PADAlert","DS/PADUtils/PADUtilsServices","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(e,c,a,h,b,g,d){var f=c.extend({name:"PAD3DViewerFilterDropObjectsCmd",context:h.get(),init:function(i){this._parent(i,{mode:"shared",isAsynchronous:false})},execute:function(i,j,k){if(!a.isAuthoring()){require(["DS/PADUtils/PADTypesMgt"],function(m){var l=this;m.retrieveAuthorizedObjects({notifPerObjects:true,displayNotif:true,unserializedData:i,callback:function(n){l._handler(n,j,k)},version:"2.0"})}.bind(this))}},_handler:function(p,n,o){var k=typeof n==="undefined"?typeof o==="undefined"?true:!o:!n;var j=p.authorizedWithKind.Product?p.authorizedWithKind.Product.length:0;j+=p.authorizedWithKind.Filter?p.authorizedWithKind.Filter.length:0;if(p.authorized_objects&&p.authorized_objects.length===0||j===0){if(this.context.getRoots().length===0&&!this.context._checkHiddenRoots()){require(["DS/PADServices/utils/GlobalModelEvents"],function(i){var q=i.getModelEvents();q.publish({event:"ENXViews/WelcomePanel/activate"})})}}else{var m=this.context.subscribe({event:"onRootAdded"},function(i){this.context.unsubscribe(m);if(p.authorized_objects.length===1&&i.id&&n!==true){this._callDefineFilter(i.id)}}.bind(this));if(p.authorized_objects&&p.authorizedWithKind.Product&&p.authorizedWithKind.Product.length){for(var l=0;l<p.authorizedWithKind.Product.length;++l){this.context.addRoots({objects:[{path:[p.authorizedWithKind.Product[l].objectId]}],loadWithFilter:p.authorized_objects.length===1?true:false,tenant:g.getPlatformId()},k)}}if(p.authorizedWithKind.Filter&&p.authorizedWithKind.Filter.length){this.context.getController()._BIProxy.retrieveFilters({filterObjects:p.authorizedWithKind.Filter,fromDropOnFilter:true,callback:function(s){var v=function(z,i){if(z){this.context.addRoots({objects:[{path:[z],filterId:i}],loadWithFilter:true,tenant:g.getPlatformId()},k)}else{if(p.authorized_objects.length===1&&n!==true){this._callDefineFilter(p.authorized_objects[0].objectId)}}}.bind(this);var x=this.context.getController().getRoots();for(var t=0;t<s.success.length;++t){if(x.length===0){v(s.success[t].rootId,s.success[t].filterId)}else{for(var r=0;r<x.length;++r){if(s.success[t].rootId!==d.getNodeID(x[r])){v(s.success[t].rootId,s.success[t].filterId)}}}}if(s.failure.length){for(var w=0;w<s.failure.length;w++){var q={msg:s.failure[w].msg,eventID:s.failure[w].eventID};b.displayNotification(q)}if(this.context.getRoots().length===0&&!this.context._checkHiddenRoots()){var y=require("DS/PADServices/utils/GlobalModelEvents");var u=y.getModelEvents();u.publish({event:"ENXViews/WelcomePanel/activate"})}}}.bind(this)})}}},_callDefineFilter:function(i){require(["DS/ApplicationFrame/CommandsManager"],function(j){var k=j.getCommand("DefineFilterHdr",this.context.getCommandContext());if(k){k.setAppParams({widgetId:g.getWidgetId(),appId:g.getSharedId()});k.setOpenFilterNow(i);k.begin()}}.bind(this))}});return f});define("DS/ENOPAD3DViewer/commands/PAD3DViewerLevelSelectorCmd",["UWA/Core","DS/Core/Events","DS/ApplicationFrame/Command","DS/Logger/Logger","DS/LevelSelector/LevelSelector","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/PADUtils/PADContext","DS/PADUtils/PADSettingsMgt","DS/Visualization/ThreeJS_DS","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(h,f,c,e,j,g,d,m,l,k,n,i,b){var a=c.extend({name:"PAD3DViewerLevelSelectorCmd",init:function(o){this._logger=e.getLogger(a);this._parent(o,{isAsynchronous:true,isEnabled:true});this._labelsVisibility=false;this._context=l.get(o.context)},execute:function(){this.emptyCSOToken=g.onEmpty(function(){this.end()}.bind(this));var t=g.get();if(t.length===1){var s=t[0].pathElement;var q=t[0].event;this._levelSelectorContext=t[0].pathElement.clone();var p=this._context.getFrameWindow().getContextualUIManager().getContextualBar();p.hide();var r=[];var o={positionX:q?q.currentPosition.x+75:this._context.elements.view_container.offsetWidth/2,positionY:q?q.currentPosition.y-75:this._context.elements.view_container.offsetHeight/2,uiFrame:this._context.elements.view_container,getLevels:function(z){var y=[];var x=s;while(x){if(b.isPLMNode(x.externalPath[x.externalPath.length-1])&&(b.isReference(x.externalPath[x.externalPath.length-1])||b.is3DLeaf(x.externalPath[x.externalPath.length-1]))){var u=x.getLastElement(true);var w=b.getBIColor(u);if(w!==null){r.push({pathElement:x,canvasColor:w,event:q})}else{r.push({pathElement:x,event:q})}y.push(b.getNodeID(x.getLastElement(true)))}x=x.getParentPath()}if(this._labelsVisibility){var v=["ds6w:label","type_icon_url"];if(this._context.getController().isColorizeActivated()&&this._context.getController().isStandalone()){v.push(this._context.getController().getBIColorMap().predicate)}this._context.getController().getAttributes({ids:y,attributes:v,callbacks:{onComplete:function(A){r.forEach(function(E){var D=b.getNodeID(E.pathElement.getLastElement(true));if(A[D]){E.name=A[D]["ds6w:label"];E.icon=A[D].type_icon_url;if(this._context.getController().isColorizeActivated()&&this._context.getController().isStandalone()){var B=this._context.getController().getBIColorMap().predicate;var C=this._context.getController().getBIColorMap().map;E.canvasColor=C[A[D][B]]}}}.bind(this));z(r)}.bind(this),onFailure:function(A){console.error("Levele selector command: The getAttributes call failed.",A);z(r)}}})}return r}.bind(this),onHover:function(u){d.empty();m.empty();u.event=q;d.add(u)}.bind(this),onLeave:function(u){d.empty();m.empty();d.add({pathElement:this._levelSelectorContext,event:q})}.bind(this),onSelect:function(u){d.empty();g.empty();u.event=q;d.add(u);g.add(u);this.end()}.bind(this)};j.createView(o)}},endExecute:function(){g.unsubscribe(this.emptyCSOToken);j.destroyView()},displayLabels:function(o){this._labelsVisibility=o}});return h.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerLevelSelectorCmd",a)});define("DS/ENOPAD3DViewer/commands/PAD3DViewerSwitchVisuOnDemandCmd",["UWA/Core","DS/ApplicationFrame/Command","DS/PADUtils/PADContext","DS/Selection/CSOManager","DS/PADUtils/PADSession","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json"],function(h,b,g,c,a,d,f){var e=b.extend({name:"PAD3DViewerSwitchVisuOnDemandCmd",_currentMode:"thumbnail",init:function(i){var k=this;this._parent(i,{});this._context=g.get(i.context);this._CBTokens=[];this._currentMode=this._context.getController().getDefaultStreamToLoad();this._CBTokens.push(this._context.subscribe({event:"onUrlLoaded"},function(l){if(l.nbCgrLoaded){k._context.changeVisuModeCmdAvailability(true)}}));this._CBTokens.push(this._context.subscribe({event:"onStreamSwitched"},function(){k.checkStream()}));this._CBTokens.push(this._context.subscribe({event:"onRootAdded"},function(){k.checkStream()}));this._CBTokens.push(this._context.subscribe({event:"onRootRemoved"},function(){k.checkStream()}));var j=false;if(typeof widget!=="undefined"){if(widget.getValue("x3dPlatformId")!=="OnPremise"){j=true}}if(j){console.warn("Switch HD command is disabled on cloud environment: no thumbnail available");k.disable()}if(this._currentMode==="cgr"){this._context.changeVisuModeCmdAvailability(true)}else{this._context.changeVisuModeCmdAvailability(false)}},destroy:function(){if(this._context){for(var j=0;j<this._CBTokens.length;j++){this._context.unsubscribe(this._CBTokens[j])}}this._CBTokens=null;this._context=null},checkStream:function(p){var l=this;var o=false;var n=[];if(p){l._context.changeVisuModeCmdAvailability(true);return}var m=function(i){i.forEach(function(q){if(d.is3DLeaf(q)){n.push(q)}else{m(q.children)}})};var j=d.getRoots(l._context);m(j);if(n.length){for(var k=0;k<n.length;k++){if(d.getLoadedStream(n[k])==="cgr"){o=true;break}}l._context.changeVisuModeCmdAvailability(o)}},execute:function(){var o=this;var m=null;var n=[];var l=c.get();var i=[],j=[];var r=function(s){s.forEach(function(t){if(d.is3DLeaf(t)){i.push(d.getNodeID(t))}else{r(t.children)}})};var k=function(s){return o._context.getController().getNode({id:s})};l.forEach(function(t){var s=o._context.streamPath(t.pathElement);j.push(k(s[s.length-1]))});r(j);if(i.length===1){if(d.is3DLeaf(k(i[0]))){m=d.getLoadedStream(k(i[0]))==="thumbnail"?"cgr":"thumbnail";if(a.isAuthoring()&&m==="thumbnail"){o._context.displayNotification({eventID:"info",msg:f.switchVisuNodeNoThumbnailOnAuthoring});return}n.push({node:k(i[0]),stream:m})}}if(i.length>1){var q=0,p=0;i.forEach(function(s){if(d.is3DLeaf(k(s))){if(d.getLoadedStream(k(s))==="thumbnail"){q++}else{if(d.getLoadedStream(k(s))==="cgr"){p++}}}});if(q>=p){m="cgr"}else{m="thumbnail";if(a.isAuthoring()&&m==="thumbnail"){o._context.displayNotification({eventID:"info",msg:f.switchVisuNodeNoThumbnailOnAuthoring});return}}i.forEach(function(s){n.push({node:k(s),stream:m})})}if(n.length){o._context.getController().switchNodeVisuStreamOnDemand({data:n,callbacks:{onComplete:function(s){if(s.nbUrlLoaded!==0){if(n[0].stream==="cgr"){var t=s.nbUrlLoaded;if(s.nbUrlLoaded>1){t+=f.switchVisuNodeToCGRsSuccess}else{t+=f.switchVisuNodeToCGRSuccess}o._context.displayNotification({eventID:"success",msg:t})}else{var t=s.nbUrlLoaded;if(s.nbUrlLoaded>1){t+=f.switchVisuNodeToThumbnailsSuccess}else{t+=f.switchVisuNodeToThumbnailSuccess}o._context.displayNotification({eventID:"success",msg:t})}}else{if(s.nbUrlLoaded===0&&n[0].stream==="thumbnail"){o._context.displayNotification({eventID:"info",msg:f.switchVisuNodeUrlnotFound})}}},onFailure:function(){o._context.displayNotification({eventID:"error",msg:f.switchVisuNodeFailure})}}})}},});return h.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerSwitchVisuOnDemandCmd",e)});define("DS/ENOPAD3DViewer/controller/PAD3DViewerHideShowController",["UWA/Core","UWA/Controls/Abstract","DS/Core/ModelEvents","DS/PADUtils/PADContext","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/SceneGraphUtils","DS/PADUtils/PADSettingsMgt"],function(d,f,c,i,b,g,a,h){var e=f.extend({name:"PAD3DViewerHideShowController",init:function(j){this._parent(j);this._commandProxy=null;this._overloadedPaths=[];this._sceneGraphOverrideSet=null;this._context=j.context;this._viewer=j.viewer;this.createOverrideSet();this._modelEvents=new c();this._initInterwidgetCom()},destroy:function(){delete this._context;if(this._viewer){delete this._viewer}delete this._modelEvents;if(this._commandProxy){this._commandProxy.destroy();delete this._commandProxy}},publish:function(j){this.getModelEvents().publish(j)},subscribe:function(j,k){return this.getModelEvents().subscribe(j,k)},unsubscribe:function(j){this.getModelEvents().unsubscribe(j)},getModelEvents:function(){return this._modelEvents},_initInterwidgetCom:function(){var j=this;if(this._context.isInterwidgetComAvailable()){require(["DS/PADUtils/PADCommandProxy"],function(k){j._commandProxy=k.create({events:{onShow:function(l){l.action="Show";j._onHideShow(l)},onHide:function(l){l.action="Hide";j._onHideShow(l)}}})})}},hide:function(k){if(!d.is(k,"object")){console.error("Incorrect parameters type in hide()");return}var l=0;k.withLock=k.withLock!==undefined?k.withLock:true;if(k.paths&&this._sceneGraphOverrideSet){k.paths.forEach(function(p){var o=p.clone();if(b.isAModelPath(o)){while(o&&!b.isPLMNode(o.getLastElement(true))){o=o.getParentPath()}if(o){var n=this._sceneGraphOverrideSet.getUniqueOverrideFromPathElement(o);if(!n||n===null){n=this._sceneGraphOverrideSet.createOverride(o)}n.setVisibility(false);if(h.getSetting("enopad3dviewer_lightNodeModel")===true&&k.withLock){this._context.getController().lockNodes({ids:[b.getNodeID(o.getLastElement(true))]})}}l++}}.bind(this));var m=this._viewer.getSceneGraphOverrideSetManager();if(m){m.pushSceneGraphOverrideSet(this._sceneGraphOverrideSet)}}if(l){setTimeout(function(){this._viewer.render({updateInfinitePlane:true})}.bind(this))}if(k.dispatch){var j=[];k.paths.forEach(function(o){if(b.isAModelPath(o)){var n=this._context.streamPath(o);j.push(n)}}.bind(this));if(this._commandProxy){this._commandProxy.hide({paths:j})}}this.publish({event:"onHide",data:k})},show:function(m){if(!d.is(m,"object")){console.error("Incorrect parameters type in show()");return}var n=0;m.withLock=m.withLock!==undefined?m.withLock:true;var j=function(r){if(!d.is(r,"object")){console.error("Incorrect path type in show().override()");return}var q=r.clone();if(b.isAModelPath(q)){while(q&&!b.isPLMNode(q.getLastElement(true))){q=q.getParentPath()}if(q){var p=this._sceneGraphOverrideSet.getUniqueOverrideFromPathElement(q);if(p&&p.getVisibility()===false){this._sceneGraphOverrideSet.deleteOverride(p);if(h.getSetting("enopad3dviewer_lightNodeModel")===true&&m.withLock){this._context.getController().unlockNodes({ids:[b.getNodeID(q.getLastElement(true))]})}}n++}}}.bind(this);if(m.paths&&this._sceneGraphOverrideSet){for(var l=0;l<m.paths.length;++l){j(m.paths[l])}var o=this._viewer.getSceneGraphOverrideSetManager();if(o){o.pushSceneGraphOverrideSet(this._sceneGraphOverrideSet)}}if(n){setTimeout(function(){this._viewer.render({updateInfinitePlane:true})}.bind(this))}if(m.dispatch){var k=[];m.paths.forEach(function(p){if(b.isAModelPath(p)){k.push(this._context.streamPath(p))}}.bind(this));if(this._commandProxy){this._commandProxy.show({paths:k})}}this.publish({event:"onShow",data:m})},createOverrideSet:function(){this._sceneGraphOverrideSet=new g(this._context.getController().getRootBagPath().externalPath[0])},resetState:function(){var j=this;if(this._viewer&&this._sceneGraphOverrideSet){var k=this._viewer.getSceneGraphOverrideSetManager();if(k){k.removeSceneGraphOverrideSet(this._sceneGraphOverrideSet);delete this._sceneGraphOverrideSet;this.createOverrideSet()}setTimeout(function(){j._viewer.render({updateInfinitePlane:true})})}},exclusiveShow:function(m){if(!d.is(m,"object")){throw new Error("No parameter defined")}if(!d.is(m.paths,"array")){throw new Error("No paths to be shown defined")}var l=this;l.resetState();var j=l._context.getController()._model._nodeIndex;var n=Object.getOwnPropertyNames(j);var k=l._context.getController()._model.getRootBag();n.forEach(function(q){if(j[q].is3DLeaf&&j[q].is3DLeaf()){var p=a.buildPathesLeadingToNode(j[q],k);p.forEach(function(s){var r=l._sceneGraphOverrideSet.createOverride(s);r.setVisibility(false)})}});m.paths.forEach(function(r){if(b.isAModelPath(r)){var p=r.getLastElement(true);if(p.is3DLeaf&&p.is3DLeaf()){var q=l._sceneGraphOverrideSet.createOverride(r);q.setVisibility(true)}else{var t=[];var s={};p.traverse(function(v){if(v.is3DLeaf&&v.is3DLeaf()&&!s[v.getID()]){s[v.getID()]=true;var u=a.buildPathesLeadingToNode(v,k);u.forEach(function(w){if(r.isAParentOf(w)){t.push(w)}})}});t.forEach(function(v){var u=l._sceneGraphOverrideSet.createOverride(v);u.setVisibility(true)})}}});var o=l._viewer.getSceneGraphOverrideSetManager();if(o){o.pushSceneGraphOverrideSet(l._sceneGraphOverrideSet)}setTimeout(function(){l._viewer.render({updateInfinitePlane:true})});this.publish({event:"onExclusiveShow",data:m})},toggleHideShow:function(l){var k=this;if(l.paths){var m=[],j=[];l.paths.forEach(function(o){if(b.isAModelPath(o)){while(o&&!b.isPLMNode(o.getLastElement(true))){o=o.getParentPath()}var n=k._viewer.getSceneGraphOverrideSetManager().getCurrentVisibility(o);if(n===null||n){j.push(o)}else{m.push(o)}}});if(m.length){this.show({paths:m,dispatch:l.dispatch,withLock:true})}if(j.length){this.hide({paths:j,dispatch:l.dispatch,withLock:true})}}},_onHideShow:function(l){if(!d.is(l,"object")&&!d.is(l.paths,"array")){console.error("No path to hide/show defined");return}var n=[];var m=[];var k=function(p,o){p.forEach(function(r){if(r.length){var q=this._context.unstreamPath(r);if(q){m.push(q)}}}.bind(this));if(l.action==="Hide"){this.hide({paths:m,dispatch:false,withLock:o})}else{if(l.action==="Show"){this.show({paths:m,dispatch:false,withLock:o})}}}.bind(this);for(var j=0;j<l.paths.length;++j){if(this._context.unstreamPath(l.paths[j])===null){n.push(l.paths[j])}}if(n.length===0){k(l.paths,true)}else{this._context.getController().expand({paths:n,progressiveExpand:false,expand_iter:"0",forceLoad:true,singleAdd:false,onComplete:function(o){if(!d.is(o,"object")){console.error("Incorrect data type in expand onComplete()");return}if(!d.is(o.selectedPaths,"array")){console.error("Incorrect data.selectedPaths type in expand onComplete()");return}k(l.paths,false)}.bind(this),onFailure:function(){console.warn("Something went wrong when trying to expand those paths.");return},},false,false)}},isVisible:function(k){var j=false;if(k&&this._viewer){j=this._viewer.getSceneGraphOverrideSetManager().getCurrentVisibility(k)===null?true:this._viewer.getSceneGraphOverrideSetManager().getCurrentVisibility(k)}return j},applyPGPHideShow:function(o){var p=this;var D=p._context.getController().getRootBag();if(o.references&&o.references.length>0){var u=[],r=[];for(var B=0;B<o.references.length;B++){var C=a.buildPathesLeadingToNode(p._context.getController().getNode({id:o.references[B].id}),D);if(o.references[B].value===false){u=u.concat(C)}if(o.references[B].value===true){r=r.concat(C)}}if(u.length){p.hide({paths:u,dispatch:false})}if(r.length){p.show({paths:r,dispatch:false})}}if(o.instances&&o.instances.length>0){var E=[],A=[];for(var z=0;z<o.instances.length;z++){var l=a.buildPathesLeadingToNode(p._context.getController().getNode({id:o.instances[z].id}),D);for(var y=0;y<l.length;y++){l[y].addElement(b.getReferences(l[y].getLastElement(true))[0])}if(o.instances[z].value===false){E=E.concat(l)}if(o.instances[z].value===true){A=A.concat(l)}}if(E.length){p.hide({paths:E,dispatch:false})}if(A.length){p.show({paths:A,dispatch:false})}}if(o.occurrences&&o.occurrences.length>0){for(var x=0;x<o.occurrences.length;x++){var s=[],F=[],v,t,q;t=p._context.unstreamPath(o.occurrences[x].path);t.substractPath(p._context.unstreamPath([o.occurrences[x].path[0],o.occurrences[x].path[1]]),t);q=a.buildPathesLeadingToNode(p._context.getController().getNode({id:o.occurrences[x].path[0]}),D);for(var w=0;w<q.length;w++){q[w].concatenatePathes(q[w],t);v=q[w];if(o.occurrences[x].value===false){s.push(v)}if(o.occurrences[x].value===true){F.push(v)}}if(s.length){p.hide({paths:s,dispatch:false})}if(F.length){p.show({paths:F,dispatch:false})}}}}});return d.namespace("DS/ENOPAD3DViewer/controller/PAD3DViewerHideShowController",e)});define("DS/ENOPAD3DViewer/commands/PAD3DViewerNavigateOnSelectionCmd",["UWA/Core","UWA/Promise","DS/ApplicationFrame/Command","DS/Selection/CSOManager","DS/PADUtils/PADUtilsServices","DS/Selection/HSOManager","DS/PADUtils/PADCommandProxy","DS/PADUtils/PADContext","DS/PADUtils/PADSettingsMgt","DS/PADUtils/views/PADPager","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/ENOPAD3DViewer/utils/PAD3DViewerVisuServices","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json"],function(g,m,d,f,h,e,b,k,j,l,c,i,n){var a=d.extend({name:"PAD3DViewerNavigateOnSelectionCmd",init:function(o){var p=this;this._parent(o,{mode:"shared",isAsynchronous:true});this._CBTokens=[];this._view=null;this._selection=[];this._selectedIdx=null;this._previousCB=null;this._nextCB=null;this._closeCB=null;this._csoChangeCB=null;this._escapeCB=null;this._lockedNodes=[];this.useModelBoundingSphere=false;this._context=k.get(this.options.context);this._commandProxy=b.create();this._CBTokens.push(this._context.subscribe({event:"onClosePager"},function(){if(p._view!==null){p._view.hide()}}));this._CBTokens.push(this._context.subscribe({event:"onFocusChange"},function(q){p.focusChange(q)}));this._CBTokens.push(this._context.subscribe({event:"onUpdatePager"},function(q){p.updatePager(q)}));this._escapeCB=function(q){if(q.keyCode===27){this.end();this.restoreSelection();this._context.reframe();this._context.reframeSelection()}}.bind(this)},updatePager:function(q){var p=this;var o=[];q.forEach(function(s){var r=p._context.unstreamPath(s);o.push({pathElement:r})});p._selection=o;p._selectedIdx=0;p.reframeOn(p.useModelBoundingSphere)},focusChange:function(p){var o=this;if(o._selection){if(p.event=="previous"){o._selectedIdx--;o.reframeOn(o.useModelBoundingSphere)}if(p.event=="next"){o._selectedIdx++;o.reframeOn(o.useModelBoundingSphere)}}},execute:function(o){return new m(function(q,p){this.prepareCSOData(o).then(function(t){document.addEventListener("keyup",this._escapeCB);this.useModelBoundingSphere=t;this._selectedIdx=0;var s=[];s=f.get().slice();this._internalCSOChange=false;var u=this;if(s.length>1){for(var r=0;r<s.length;r++){if(s[r].pathElement!==null){this._selection.push(s[r])}}if(null===this._view){this._view=new l({renderTo:this._context.elements.view_container});this._previousCB=this._view.subscribe({event:"previous"},function(){u.focusChange({event:"previous"});u._commandProxy.focusChange3D({sharedID:h.getSharedId(),event:"previous"})});this._nextCB=this._view.subscribe({event:"next"},function(){u.focusChange({event:"next"});u._commandProxy.focusChange3D({sharedID:h.getSharedId(),event:"next"})});this._closeCB=this._view.subscribe({event:"close"},function(){u.end();u.restoreSelection();u._context.reframe();u._context.reframeSelection()})}this.reframeOn(t);this._view.show();this._csoChangeCB=f.onRemove(function(){if(!u._internalCSOChange){u.end()}})}else{if(s.length===1){if(s[0].pathElement!==null){this._selection=s;this.reframeOn(t);this._csoChangeCB=f.onRemove(function(){if(!u._internalCSOChange){u.end()}})}}else{console.log("CSO selection is empty");u.end()}}q()}.bind(this))}.bind(this))},restoreSelection:function(){var o=this;o._context.lockSelectionBroadcast(false);if(o.originalSelection.length){o.originalSelection.forEach(function(q){var p=o._context.unstreamPath(q);if(p!==null){f.add({pathElement:p});e.add({pathElement:p})}})}},end:function(){this._context.getController().unlockNodes({ids:this._lockedNodes});this._context._reframeFocus=false;this._selection=[];this._selectedIdx=null;this._previousCB=null;this._nextCB=null;this._closeCB=null;this._lockedNodes=[];f.empty();e.empty();if(this._escapeCB){document.removeEventListener("keyup",this._escapeCB)}if(this._csoChangeCB){f.unsubscribe(this._csoChangeCB)}if(this._view){this._view.hide()}},prepareCSOData:function(o){return new m(function(r){var s=function(t){this._context.lockSelectionBroadcast(true);this.originalSelection=t;f.empty();e.empty();var u=this._context._controller.getHiddenRootIds();t.forEach(function(w){if(u.indexOf(w[0])===-1){var v=this._context.unstreamPath(w);f.add({pathElement:v});e.add({pathElement:v})}}.bind(this))}.bind(this);var q=[];if(j.getSetting("enopad3dviewer_lightNodeModel")===true){for(var p=0;p<o.length;++p){if(this._context.unstreamPath(o[p])===null){q.push(o[p])}}}if(q.length===0){s(o);if(j.getSetting("enopad3dviewer_lightNodeModel")===true){r(true)}else{r(false)}}else{this._context.getController().expand({paths:q,progressiveExpand:false,expand_iter:"0",singleAdd:false,onComplete:function(u){if(!g.is(u,"object")){console.error("Incorrect data type in expand onComplete()");return}for(var t=0;t<o.length;++t){this._lockedNodes.push(o[t][o[t].length-1])}this._context.getController().lockNodes({ids:this._lockedNodes});s(o);r(true)}.bind(this)})}}.bind(this))},reframeOn:function(r){if(this._selectedIdx===-1){this._selectedIdx=this._selection.length-1}var o=this._selectedIdx%this._selection.length;if(this._view){var q=(o+1)+"/"+this._selection.length;this._view.setLabel(q)}this._internalCSOChange=true;this._context._reframeFocus=true;this._context.lockSelectionBroadcast(true);f.empty();e.empty();f.add(this._selection[o]);e.add(this._selection[o]);this._internalCSOChange=false;this._context.lockSelectionBroadcast(false);if((this._context.getHideShowController()&&!this._context.getHideShowController().isVisible(this._selection[o].pathElement)&&this._context._viewer.getVisibleSpace()===1)||(this._context.getHideShowController()&&this._context.getHideShowController().isVisible(this._selection[o].pathElement)&&this._context._viewer.getVisibleSpace()===0)){this._context.displayNotification({eventID:"info",msg:n.swapToSeeSelection})}var s=this._context.getController().getReferenceBoundingSphere(c.getNodeID(this._selection[o].pathElement.externalPath[this._selection[o].pathElement.externalPath.length-1]));if(s&&r===true){var p=this._selection[o].pathElement.getWorldMatrix();p.multiplyVector3(s.center);i.reframeOn({BS:s,viewpoint:this._context.getViewpoint()})}else{i.reframeOn({paths:[this._selection[o].pathElement],viewpoint:this._context.getViewpoint()})}}});return g.namespace("DS/ENOPAD3DViewer/commands/PAD3DViewerNavigateOnSelectionCmd",a)});define("DS/ENOPAD3DViewer/models/PAD3DViewerTileNodeModel",["UWA/Class","UWA/Promise","DS/ENOPAD3DViewer/mixins/PAD3DViewerDebugTileNodeModel","DS/ENOPAD3DViewer/mixins/PAD3DViewerQueryParser","DS/3DXMTiles/OOCManager","DS/3DXMTiles/OOCModel3DHandler","DS/3DXMTiles/OOCHandler","DS/3DXMTiles/LDHReference","DS/3DXMTiles/Debug3DXMTiles","DS/Visualization/Node3D","DS/Visualization/PathElement","DS/Visualization/ModelLoader","DS/Core/ModelEvents","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/PADUtils/PADProbes","DS/PADUtils/PADSettingsMgt","DS/VisuTools/FPSCounter"],function(o,b,h,a,p,d,g,i,m,k,n,r,l,q,f,c,e,j){var s=o.extend(h,a,{className:"PAD3DViewerTileNodeModel",init:function(u){var w=this;this._parent(u);this._modelEvents=new l();this._nodeIndex={};this._rootIndex={};this._hiddenRootIds=[];this._repList=[];this._rootLog=[];this._OOCManager=null;this._parsingRunning=false;this._getFcsUrlsCB=u.getFcsUrlsCB;this._nodeIndex[this.getRootBagId()]=new k("RootBag");u.viewer.addNode(this._nodeIndex[this.getRootBagId()]);this._decorationBag=new k("DecorationBag");u.viewer.addNode(this._decorationBag);this._loadingBoxesBag=new k("LoadingBoxesBag");u.viewer.addNode(this._loadingBoxesBag);var v=new n();v.addElement(this._nodeIndex[this.getRootBagId()]);this._nodeIndex[this.getRootBagId()].path=v;var t="full";if(navigator.userAgent.match(/iPad/i)){u.viewer.setSmallRenderTargetPicking(true);t="medium"}else{if(navigator.userAgent.match(/Android|iPhone|iPod|BlackBerry|Opera Mini|IEMobile/i)){u.viewer.setSmallRenderTargetPicking(true);t="restricted"}}window.OOCNewPriorityPrototype=true;this._OOCManager=new p(u.viewer,{config:t,forceSceneMin:true,enableOcclusionTest:e.getSetting("enopad3dviewer_occlusionTest")});this._OOCManager.setTargetNode(this.getRootBag());this._OOCManager.setOnStartLoadingCB(u.startLoadingCB);this._OOCManager.setOnEndLoadingCB(u.endLoadingCB);this._OOCManager.setTargetNode(this.getRootBag());this._OOCManager.setPerformancesOptions({pauseLoadingDuringViewpointMove:true});if(this._OOCManager.setMaxNbExpectedChildrenPerRequest){this._OOCManager.setMaxNbExpectedChildrenPerRequest(30000)}u.viewer.budgetedRenderManager.setBudget(0.1);window._modelDebugger=this;this._initOOCHandlers(u);if(window.localStorage.getItem("TileModelPerf")==="ON"){j.setAutoRefresh(false);u.viewer.showPerfo(true,false)}},getRootBagId:function(){return"rootBag"},getRootLog:function(){return this._rootLog.slice(0)},addToRootLog:function(t){this._rootLog.push(t)},getHiddenRootIds:function(t){if(t!==undefined){return this._hiddenRootIds[t]}else{return this._hiddenRootIds}},getOOCManager:function(){if(this._OOCManager!==undefined){return this._OOCManager}},destroy:function(){delete this._modelLoader;delete this._nodeIndex;delete this._hiddenRootIds;delete this._viewer;delete this._rootLog;if(this._modelEvents){delete this._modelEvents}this._parent()},_initOOCHandlers:function(t){this._model3DHandler=new d();this._model3DHandler.setLoadModelOptions({proxyurl:"none"});this._model3DHandler.setFileType(!e.getSetting("enopad3dviewer_streamFileType")?"cgr":e.getSetting("enopad3dviewer_streamFileType"));if(this._model3DHandler.setRedirectUrlCB){this._model3DHandler.setRedirectUrlCB(function(w,x){this._getFcsUrlsCB({urls:w,callbacks:{onComplete:function(y){if(y.results){x(y.results)}},onFailure:function(A){var z=[];for(var y=0;y<w.length;y++){z.push(null)}x(z)}}})}.bind(this))}var u=this;var v=function(w){g.call(this,g.InstRefHander);this._processing=false;this._expandCB=w.expandCB;this.manager=u._OOCManager};v.prototype=Object.create(g.prototype);v.prototype.isReady=function(){return this._processing===false};v.prototype.getBatchSize=function(){return e.getSetting("enopad3dviewer_LDHBatchSize")?e.getSetting("enopad3dviewer_LDHBatchSize"):100};v.prototype.getData=function(D,w){this._processing=true;var A={};var z=0;var y=0;for(z=0;z<D.length;z++){var E=D[z];var C=E.ids[0];if(A[C]===undefined){A[C]={idPaths:[],treatedRef:[]}}A[C].idPaths.push(E.ids);A[C].treatedRef.push(E.getLastId())}var x=Object.keys(A);var B=[];for(z=0;z<x.length;z++){if(A[x[z]].idPaths.length){B.push(new b(function(G,F){this._expandCB({paths:A[x[z]].idPaths,pixelCulling:(w.screenRadius*0.3).toFixed(),onComplete:function(H,J,I){this.done(J,[],w);G()}.bind(this,A[x[z]].idPaths,A[x[z]].treatedRef),onFailure:function(H,I){this.done([],I,w);G()}.bind(this,A[x[z]].idPaths,A[x[z]].treatedRef),singleAdd:false,progressiveExpand:true},false,false)}.bind(this)))}}b.all(B).then(function(){this._processing=false}.bind(this))};v.prototype.done=function(w,y,x){x.doneCB(w,y)};v.prototype.handlePathes=function(x,w){this.getData(x,w)};this._refHandler=new v(t)},_parseAttributes:function(u,t,z){var x=null;var w=u.length;var v=0;t.did=null;t.globalType=null;t.type=null;t.pid=null;t.thbUrl=null;t.cgrUrl=null;t.matrix=null;for(v=0;v<w;v++){x=u[v];if(x.name==="did"){t.did=x.value}else{if(x.name.toLowerCase()==="ds6w:globaltype"){t.globalType=x.value}else{if(x.name==="type"){t.type=x.value}else{if(x.name==="ds6w:type"){t.type=x.value}else{if(x.name==="physicalid"){t.pid=x.value}else{if(x.name==="thumbnail_3d"){t.thbUrl=x.value}else{if(x.name==="cgr"){t.cgrUrl=x.value}else{if(x.name==="matrixtxt"&&x.value!==""){if(x.value!=="1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0"&&x.value!=="1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0"&&x.value!=="1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0"){t.matrix=new q.Matrix4();var y=x.value.split(/[,]/);t.matrix.elements[0]=parseFloat(y[0]);t.matrix.elements[1]=parseFloat(y[1]);t.matrix.elements[2]=parseFloat(y[2]);t.matrix.elements[4]=parseFloat(y[3]);t.matrix.elements[5]=parseFloat(y[4]);t.matrix.elements[6]=parseFloat(y[5]);t.matrix.elements[8]=parseFloat(y[6]);t.matrix.elements[9]=parseFloat(y[7]);t.matrix.elements[10]=parseFloat(y[8]);t.matrix.elements[12]=parseFloat(y[9]);t.matrix.elements[13]=parseFloat(y[10]);t.matrix.elements[14]=parseFloat(y[11])}}}}}}}}}if(z&&z===x.name){t[x.name]=x.value}}},buildFromJSON:function(t){if(t.json&&t.json.infos&&t.json.infos.kind&&t.json.infos.kind==="InstRef"){this._buildFromJSONInstRef(t)}else{this._buildFromJSONOcc(t)}},unlockChildren:function(t){this._OOCManager.unlockChildren(t.id)},reparentNode:function(t){},insertExistingNode:function(t){},createNode:function(t){},removeNode:function(t){if(!UWA.is(t,"object")){throw new Error("No parameter defined")}if(t.id===undefined){console.error("No id defined");return}},removeRoot:function(u){if(!UWA.is(u,"object")){throw new Error("No parameter defined")}if(u.id===undefined){console.error("No id defined");return}for(var t=this._rootLog.length-1;t>=0;t--){if(UWA.is(this._rootLog[t],"array")){if(this._rootLog[t][0]===u.id){this._rootLog.splice(t,1)}}}if(this._rootIndex[u.id]&&this._rootIndex[u.id].occId){this._OOCManager.removeRoot(this._rootIndex[u.id].occId);delete this._rootIndex[u.id]}},detachNode:function(v){if(!UWA.is(v,"object")){throw new Error("No parameter defined")}if(v.id===undefined){console.error("No id defined");return}if(v.parentId===undefined){console.error("No parentId defined");return}var u=this.getNode({id:v.id});var t=this.getNode({id:v.parentId});if(u&&t){t.remove(u)}},attachNode:function(v){if(!UWA.is(v,"object")){throw new Error("No parameter defined")}if(v.id===undefined){console.error("No id defined");return}if(v.parentId===undefined){console.error("No parentId defined");return}var u=this.getNode({id:v.id});var t=this.getNode({id:v.parentId});if(u&&t){t.add(u);u.path=t.path.clone();u.path.addElement(u)}},switchNodeVisuStreamOnDemand:function(v){if(!UWA.is(v,"object")){throw new Error("No parameter defined")}if(!UWA.is(v.data,"array")){throw new Error("No input data defined")}if(!UWA.is(v.callbacks.onURLLoad,"function")){throw new Error("No onURLLoad callback function defined")}if(!UWA.is(v.callbacks.onComplete,"function")){throw new Error("No onComplete callback function defined")}var u=this;u.nbCgrLoaded=0;u.nbThbLoaded=0;var t=function(){u._nbURLToLoad--;u._nbURLLoaded++;if(u._nbURLToLoad===0){v.callbacks.onComplete({nbUrlLoaded:u._nbURLLoaded})}};u._nbURLToLoad=v.data.length;u._nbURLLoaded=0;v.data.forEach(function(x){var y=x.url;if(y&&x.stream!==x.node.getUserData().loadedStream){u._OOCManager.setReferenceLoadModelOptions(x.node.getModelIdentification(),{applicativeContainers:undefined===v.applicativeContainers?undefined:v.applicativeContainers,noMeshInRAM:undefined===v.noMeshInRAM?true:v.noMeshInRAM});var w=x.node.getUserData();w.loadedStream=x.stream;x.node.setUserData(w);if(x.stream==="cgr"){u.nbCgrLoaded++}else{u.nbThbLoaded++}if(x.stream!==(e.getSetting("enopad3dviewer_CGRorTHB")?"cgr":"thumbnail")){u.lockNodes({ids:[x.node.getModelIdentification()]})}else{u.unlockNodes({ids:[x.node.getModelIdentification()]})}u._OOCManager.switchLOD(x.node.getModelIdentification(),y,t)}else{u._nbURLToLoad--}});u.publish({event:"onUrlLoaded",data:{nbCgrLoaded:u.nbCgrLoaded,nbThbLoaded:u.nbThbLoaded}});if(!u._nbURLToLoad){v.callbacks.onComplete({nbUrlLoaded:u._nbURLLoaded})}},refreshStream:function(v){if(!UWA.is(v,"object")){throw new Error("No parameter defined")}if(!UWA.is(v.data,"array")){throw new Error("No input data defined")}if(!UWA.is(v.callbacks.onURLLoad,"function")){throw new Error("No onURLLoad callback function defined")}if(!UWA.is(v.callbacks.onComplete,"function")){throw new Error("No onComplete callback function defined")}var u=this;var t=null;u._nbURLToLoad=v.data.length;u._nbURLLoaded=0;u.nbCgrLoaded=0;u.nbThbLoaded=0;t=function(){u._nbURLToLoad--;if(u._nbURLToLoad===0){v.callbacks.onComplete()}};v.data.forEach(function(w){var x=w.url;if(w.stream==="cgr"){u.nbCgrLoaded++}else{u.nbThbLoaded++}u._OOCManager.setReferenceLoadModelOptions(w.node.getModelIdentification(),{applicativeContainers:v.applicativeContainers,noMeshInRAM:undefined===v.noMeshInRAM?true:v.noMeshInRAM});u._OOCManager.switchLOD(w.node.getModelIdentification(),x,t)});u.publish({event:"onUrlLoaded",data:{nbCgrLoaded:u.nbCgrLoaded,nbThbLoaded:u.nbThbLoaded}});if(!u._nbURLToLoad){v.callbacks.onComplete()}},isNodeLocked:function(t){return(this._OOCManager.getSceneGraphLockCounter(t)>0)?true:false},lockNodes:function(t){if(!UWA.is(t,"object")){console.error("Incorrect options type in addSceneGraphLock()");return}for(var u=0;u<t.ids.length;++u){this._OOCManager.addSceneGraphLock(t.ids[u])}},unlockNodes:function(t){if(!UWA.is(t,"object")){console.error("Incorrect options type in removeSceneGraphLock()");return}for(var u=0;u<t.ids.length;++u){this._OOCManager.removeSceneGraphLock(t.ids[u])}},getRootBag:function(){return this._nodeIndex.rootBag},getNode:function(t){if(!UWA.is(t,"object")){throw new Error("No parameter defined")}if(!UWA.is(t.id,"string")){console.error("No id defined");return}if(t.id==="rootBag"){return this.getRootBag()}else{return this._OOCManager.getSceneGraphNode(t.id)}},getRoot:function(t){if(!UWA.is(t,"object")){throw new Error("No parameter defined")}if(!UWA.is(t.id,"string")){console.error("No id defined");return}return this._rootIndex[t.id]},abort:function(t){while(this._parsingRunning){}if(this._rootIndex[t]&&this._rootIndex[t].occId){this._OOCManager.removeRoot(this._rootIndex[t].occId)}},pause:function(){if(this._OOCManager){this._OOCManager.setPauseLoading(true)}},resume:function(){if(this._OOCManager){this._OOCManager.setPauseLoading(false)}},getDecorationBag:function(){return this._decorationBag},getLoadingBoxesBag:function(){return this._loadingBoxesBag},publish:function(t){this.getModelEvents().publish(t)},subscribe:function(t,u){return this.getModelEvents().subscribe(t,u)},unsubscribe:function(t){this.getModelEvents().unsubscribe(t)},getModelEvents:function(){return this._modelEvents},getReferenceBoundingSphere:function(t){return this._OOCManager.getReferenceBoundingSphere(t).clone()},enableProgressiveBI:function(t){this._OOCManager.addUserQueue(t)},disableProgressiveBI:function(t){this._OOCManager.removeUserQueue(t)},displayCandidateQueue:function(u,t){if(u){this._OOCManager.setCandidateQueueRendererParams(true,{displayIntermediateReferences:true,repRefAttributes:{color:new q.Color(t.repColor),opacity:0.3,dimension:2,},refAttributes:{color:new q.Color(t.assemblyColor),opacity:1,dimension:1},rootNode:this.getLoadingBoxesBag()})}else{this._OOCManager.setCandidateQueueRendererParams(false)}},registerOverrideSet:function(t){this._OOCManager.registerOverrideSet(t)},setOverrideCB:function(u,v,t){this._OOCManager.setOverrideCB(u,v,t)},hasOverrideCB:function(u,t){var v=false;if(this._OOCManager.hasOverrideCB){v=this._OOCManager.hasOverrideCB(u,t)}return v},removeOverrideSet:function(t){this._OOCManager.removeOverrideSet(t)},createReferenceIterator:function(t){return this._OOCManager.createReferenceIterator(t)},setLoadingBoxesPickable:function(t){if(this._OOCManager.setLoadingBoxesPickable){if(t){this._OOCManager.setLoadingBoxesPickable(f.PICKABLE)}else{this._OOCManager.setLoadingBoxesPickable(f.NODRAWHL)}}},getOOCSelectedReferenceID:function(){var t=null;if(this._OOCManager){t=this._OOCManager.getSelectedReference()}return t},getOOCReference:function(u){var t=null;if(this._OOCManager){t=this._OOCManager._getLDHReference(u)}return t},getWorldMatrix:function(u){var t=null;if(this._OOCManager){t=this._OOCManager.getWorldMatrix(this._rootIndex[u[0]].occId,u)}return t}});return s});define("DS/ENOPAD3DViewer/mixins/_PAD3DViewerFilterController",["UWA/Class","DS/PADUtils/PADUtilsServices","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADPromise","DS/ENOPAD3DViewer/views/PAD3DRemoveFilterPanel","DS/Visualization/SceneGraphUtils","DS/Visualization/PathElement"],function(a,f,c,h,g,i,b,e){var d=a.extend({initFilterController:function(){return new Promise(function(j){var k=function(l){if(this.isStandaloneFilterAvailable()===true){this.applyFilter(l,false)}}.bind(this);require(["DS/PADUtils/PADUtilsServices","DS/ENOFilterBIUX/FilterBIComponentProxy"],function(q,m){var n=(this._context.getWidget()&&this._context.getWidget().id)?this._context.getWidget().id:"fakeWidgetIDFallback";var o=(this._context.getWidget())?q.getSharedId():null;var l=h.getSetting("activateVolumeFilter")?h.getSetting("activateVolumeFilter"):0;this._BIProxy=new m({tenant:q.getPlatformId(),processingMode:"appProcessing",ExpandSynthesisON:this.isStandaloneFilterAvailable()?true:false,colorize:true,widgetId:n,volumeFilterAvailable:l,appId:o,synthesis_priority:2});this._BIProxy.addEvent("ApplyNGFilter",k,this);this._BIProxy.addEvent("NGFilter_Volume",this._onNGFilterVolume,this);this._BIProxy.addEvent("FilterBIFilteringEvent",this._onFilterBIRefineEvent,this);this._BIProxy.addEvent("NGFilter_Close",function(r){this.publish({event:"onEnableUX"});if(this._wait4Filter===true){if(this.isStandaloneFilterAvailable()===true){if(h.getSetting("enopad3dviewer_lightNodeModel")===true){this.resumeProgressiveLoading()}else{this.expand({paths:[[this._rootIds[this._rootIds.length-1]]]},false,true,true)}}else{this.expand({paths:[[this._rootIds[this._rootIds.length-1]]]},false,true,true)}delete this._wait4Filter}if(this._useWrapToRemoveWhenFilter===true){this._useWrap=false}},this);if(UWA.is(this._BIProxy.setNGFilterOptions,"function")){var p={expandServices:"expand3d",appID:o};this._BIProxy.setNGFilterOptions(p)}j()}.bind(this))}.bind(this))},retrieveFilters:function(j){if(this.isStandaloneFilterAvailable()===true){this._BIProxy.retrieveFilters({filterObjects:j.authorizedWithKind.Filter,callback:function(l){if(l.success.length){for(var m=0;m<l.success.length;++m){var k=this.getRoot({id:l.success[m].rootId});if(!k){this.applyFilter(l.success[m].filter,false,l.success[m])}else{this.publish({event:"onRootAlreadyExisting"})}}}if(l.failure.length){this.publish({event:"onRetrieveFilterFailure",data:l})}}.bind(this)})}},removeFilterFullReload:function(j){return new Promise(function(n,m){if(this.isStandaloneFilterAvailable()===true){this._clearRootEvents();this.removeRoots({pids:j},false,false);var l=[];for(var k=0;k<j.length;k++){l.push({path:[j[k]]})}this.addRoots({objects:l},false,true,false,function(){this._restoreRootEvents();n()}.bind(this))}else{n()}}.bind(this))},applyFilter:function(m,k,j){var l=this;g.createPromise(function(y,z){var s=[];if(l.getRoots().length&&!l._context._physicalId.length){l._context._physicalId.push(c.getNodeID(l.getRoots()[0]))}l.publish({event:"onEnableUX"});if(l._context._volumePanel!==0){l._context.publish({event:"onVolumeOpen",data:{closePanel:true}})}var w=false;if(l._wait4Filter===true){if(h.getSetting("enopad3dviewer_lightNodeModel")===true){l.resumeProgressiveLoading()}w=true;delete l._wait4Filter}if(l._useWrapToRemoveWhenFilter===true){l._useWrap=false}if(m){if(!m.CVQuery3D&&!m.empty){if(m.sequence_filter||m.config_filter){var o=m.root_physicalid;var t=m.sequence_filter;var u=m.config_filter;s=[];var A=true;if(!w){if(o&&l.getNode({id:o})){A=false}}s.push({path:[o],sequence_filter:t,configBin:u});l._clearRootEvents();l.removeRoots({pids:[o]},false,false);l.addRoots({objects:s},false,false,A,function(B){this._restoreRootEvents();this.publish({event:"onFilterApplied",data:{filter:{objects:B}}})}.bind(l,s));if(k){l._commandProxy.applyFilter(m)}}else{if(m.root_physicalid){var p=l.getNode({id:m.root_physicalid});p.setSequenceFilter(undefined);p.setConfigFilter(undefined)}else{var x=l.getRoots();for(var v=0;v<x.length;v++){x[v].setSequenceFilter(undefined);x[v].setConfigFilter(undefined)}}}y()}else{if(!m.empty&&m.CVQuery3D){var n=m.filterRootIds;s=[];l._clearRootEvents();var A=true;for(var r=0;r<n.length;r++){if(!w){if(n[r]&&l.getNode({id:n[r]})){A=false}}l.removeRoots({pids:[n[r]]},false,false);var q=typeof j!=="undefined"?j.filterId:typeof m.filterId!=="undefined"?m.filterId:undefined;s.push({path:[n[r]],CVQuery3D:m.CVQuery3D,filterId:q})}l.addRoots({objects:s},false,false,A,function(B){this._restoreRootEvents();this.publish({event:"onFilterApplied",data:{filter:{objects:B}}})}.bind(l,s));if(k){l._commandProxy.applyFilter(m)}}else{if(m.empty===true){if(m.filterRootIds){for(var r=0;r<m.filterRootIds.length;r++){l.removeFilterFromRoot(m.filterRootIds[r])}}}else{var x=l.getRoots();for(var v=0;v<x.length;v++){x[v].setCVFilterQuery(undefined)}}}y()}}else{console.error("No parameter pass")}})},_onNGFilterVolume:function(k){var j=this;require(["DS/ApplicationFrame/CommandsManager","DS/PADUtils/PADPromise","DS/Selection/CSOManager"],function(n,l,m){if(k.action){var o=true;var p=l.getPromises().slice();l.createPromise(function(r,q){Promise.all(p).then(function(t){p=null;var s=[],x=null,z=[];var v=j._context._context;var y=n.getCommand("VolumeQueryHdr",v);j._context.publish({event:"onVolumeOpen",data:{changeType:k.volume}});var u=m.get();if(j._context._volumePanel==0){if(j._context.getRoots().length){if(k.volume){if(UWA.is(k.volume.root_path_physicalid[0],"array")){if(k.volume.type=="proximity"){x=j._context.unstreamPath(k.volume.root_path_physicalid[0]);if(x==null){o=false;j._context.publish({event:"onVolumeOpen",data:{error:true}})}else{s.push({pathElement:x});m.add(s)}}else{if(u.length==0){z.push(k.volume.root_path_physicalid[0][0]);x=j._context.unstreamPath(z);s.push({pathElement:x});m.add(s)}}}}else{if(u.length==0){z.push(c.getNodeID(j._context.getRoots()[0]));x=j._context.unstreamPath(z);s.push({pathElement:x});m.add(s)}}}if(o){y.begin()}}if(j._context.getRoots().length===0||j._context._controller._wait4Filter==true){j._context._filterDrop=true;j._context._controller.publish({event:"onEnableUX"});j._context._controller.publish({event:"onDisableActionBar"})}var w=l.getPromises().slice();l.createPromise(function(B,A){Promise.all(w).then(function(C){w=null;if(o){j._context.publish({event:"onVolumeOpen",data:{biData:k}})}B()})},"volumeFilterUpdate");r()})},"volumeFilter")}else{if(j._context._volumePanel!==0){j._context.publish({event:"onVolumeOpen",data:{closePanel:true}})}}})},_onFilterBIRefineEvent:function(l){var j=this;var k=g.getPromises().slice();g.createPromise(function(n,m){Promise.all(k).then(function(o){k=null;if(j._viewer){var p=j._context.getController()._model._nodeIndex;var s=Object.getOwnPropertyNames(p);var r=j._context.getController()._model.getRootBag();j._resetFiltering();if(j.isStandalone()){var q=Object.getOwnPropertyNames(l.allfilters);var t=[],v=0;if(q.length>0&&l.filteredSubjectList.length){s.forEach(function(x){if(p[x].is3DLeaf&&p[x].is3DLeaf()){var w=b.buildPathesLeadingToNode(p[x],r);w.forEach(function(z){var y=j._refineOverrideSet.createOverride(z);y.setVisibility(false);y.setVisibilityFree(true)})}});l.filteredSubjectList.forEach(function(y){var x=j._context.getController().getNode({id:l.nodes[y]});if(x&&x.is3DLeaf&&x.is3DLeaf()){var w=new e();w.addElement(x);var z=b.buildPathesLeadingToNode(x,r);z.forEach(function(B){var A=j._refineOverrideSet.getUniqueOverrideFromPathElement(B);if(A){j._refineOverrideSet.deleteOverride(A)}})}t.push([v++])});j._BIProxy.setPathTags({nodes:l.filteredPathIDList,paths:t})}else{j._onFilterBIUnFilter();l.filteredPathIDList.forEach(function(w){t.push([v++])});j._BIProxy.setPathTags({nodes:l.filteredPathIDList,paths:t})}}else{s.forEach(function(x){if(p[x].is3DLeaf&&p[x].is3DLeaf()){var w=b.buildPathesLeadingToNode(p[x],r);w.forEach(function(z){var y=j._refineOverrideSet.createOverride(z);y.setVisibility(false);y.setVisibilityFree(true)})}});if(l.nodes&&l.path){l.path.forEach(function(A){var y=[];A.forEach(function(D){y.push(l.nodes[D].pid)});var z=j._context.unstreamPath(y);var w=z.getLastElement(true);if(z){if(w.is3DLeaf&&w.is3DLeaf()){var x=j._refineOverrideSet.getUniqueOverrideFromPathElement(z);if(x){j._refineOverrideSet.deleteOverride(x)}}else{var C=[];var B={};w.traverse(function(E){if(E.is3DLeaf&&E.is3DLeaf()&&!B[c.getNodeID(E)]){B[c.getNodeID(E)]=true;var D=b.buildPathesLeadingToNode(E,r);D.forEach(function(F){if(z.isAParentOf(F)){C.push(F)}})}});C.forEach(function(E){var D=j._refineOverrideSet.getUniqueOverrideFromPathElement(E);if(D){j._refineOverrideSet.deleteOverride(D)}})}}})}}var u=j._viewer.getSceneGraphOverrideSetManager();if(u){u.insertSceneGraphOverrideSetAt(j._refineOverrideSet,0)}j._viewer.render({updateInfinitePlane:true});j.publish({event:"onBIFiltering",})}n()})},"filterBIFilter")},_onFilterClose:function(o){var n=this;if(o.tag==="dataFilterPanel"){var k=n._context.getController();var m=o?o:{};if(m.rootIds===undefined){m.rootIds=[];var l=k.getRoots();for(var j=0;j<l.length;j++){m.rootIds.push(l[j].getID())}}k._disableFilterWaiting(m)}},_clearRootEvents:function(){this._cbCounter--;this.unsubscribe(this._biRootAddedEvents);this.unsubscribe(this._biRootRemovedEvents);this._biRootAddedEvents=-1;this._biRootRemovedEvents=-1;this.publish({event:"onApplyFilterBegin"})},_restoreRootEvents:function(){this._cbCounter++;if(this._cbCounter===0){this._biRootAddedEvents=this.subscribe({event:"onRootAdded"},this.onSetTagsWithExpandSynthesis.bind(this));this._biRootRemovedEvents=this.subscribe({event:"onEndRootRemoved"},this._rootRemovedProxyEvent.bind(this));this.publish({event:"onApplyFilterEnd"})}},isStandaloneFilterAvailable:function(){var l=h.getSetting("enopad3dviewer_roles");var j=false;if(l){for(var k=0;k<l.length;k++){if(l[k].id==="CSV"||l[k].id==="InternalDS"){j=true;break}}}return(h.getSetting("enopad3dviewer_FilterAvailable")&&j)},isSlaveFilterAvailable:function(){var l=h.getSetting("enopad3dviewer_roles");var j=false;if(l){for(var k=0;k<l.length;k++){if(l[k].id==="CSV"||l[k].id==="InternalDS"){j=true;break}}}return(this._biMode==="SLAVE"&&j)},removeFilterFromRoot:function(l,k){var j=this.getRoot({id:l});if(h.getSetting("enopad3dviewer_lightNodeModel")){this.removeFilterFullReload([l]).then(function(){this.publish({event:"onFilterRemoved",data:{id:l}})}.bind(this))}else{if(j&&(j.getCVFilterQuery()!==null&&j.getCVFilterQuery()!==undefined)){if(j.setCVFilterQuery){j.setCVFilterQuery(undefined)}this.publish({event:"onFilterRemoved",data:{id:l}})}}},getPrdIdFromFilterId:function(j){return this._BIProxy.RetrievePrdFromFilterId(j)},refreshAppliedFilters:function(){var j=this.getRoots();for(var k=0;k<j.length;++k){this.removeFilterFromRoot(c.getNodeID(j[k]),true)}},isFiltered:function(j){var k=false;if(j){k=this._BIProxy.HasFilter(j)}return k}});return d});define("DS/ENOPAD3DViewer/mixins/PAD3DViewerLoadingBoxesEngine",["UWA/Core","UWA/Class","DS/CoreEvents/Events","DS/PADUtils/PADSettingsMgt","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(h,a,e,c,d){var b={GREY:"rgb(119,121,124)",ORANGE:"rgb(232,123,0)",BLUE:"rgb(5,155,255)",GREEN:"rgb(50,221,28)",YELLOW:"rgb(232,212,24)"};var g={"5SEC":5000,"10SEC":10000,"15SEC":15000};var f=a.extend({name:"PAD3DViewerLoadingBoxesEngine",_boxesDisplayToken:null,_visuEventToken:null,_realMove:false,_memoryLimitToken:null,_boxesRemovalToken:null,_expandToken:null,_enforceLoadingBoxesDisplay:false,_colors:{repColor:b.GREY,assemblyColor:b.GREY},setupLoadingBoxesEngine:function(){if(this.isSelectiveLoadingActivated()){if(c.getSetting("enopad3dviewer_displayCandidateQueue")!=="OFF"){this.setLoadingBoxesColor(c.getSetting("enopad3dviewer_displayCandidateQueue_color"));this._clearVisuEventCallback();if(c.getSetting("enopad3dviewer_displayCandidateQueue")==="ALWAYS"){this.toggleLoadingBoxesDisplay(true)}else{this._visuEventToken=e.subscribe({event:"/VISU/"},function(i){switch(i.eventType){case"@onViewpointChange":this._realMove=true;break;case"@onViewpointBeginMove":case"@onViewpointBeginMove_bis":this._clearBoxesDisplayTimeout();this._clearBoxesRemovalTimeout();break;case"@onViewpointEndMove":case"@onViewpointEndMove_bis":if(this._realMove){this._realMove=false;this._clearBoxesDisplayTimeout();this._clearBoxesRemovalTimeout();if(!this._enforceLoadingBoxesDisplay){this._boxesRemovalToken=setTimeout(function(){this._boxesRemovalToken=null;this.toggleLoadingBoxesDisplay(false)}.bind(this),1000)}this._boxesDisplayToken=setTimeout(function(){this._boxesDisplayToken=null;this.toggleLoadingBoxesDisplay(true)}.bind(this),g[c.getSetting("enopad3dviewer_displayCandidateQueue")])}break}}.bind(this));this._memoryLimitToken=this.subscribe({event:"onEndProgressiveLoad"},function(i){this.toggleLoadingBoxesDisplay(true);this.getController()._model.setLoadingBoxesPickable(true)}.bind(this));this._memoryLimitToken=this.subscribe({event:"onStartProgressiveLoad"},function(i){this.getController()._model.setLoadingBoxesPickable(false)}.bind(this))}}else{this.toggleLoadingBoxesDisplay(false);this.disposeLoadingBoxesEngine()}}},toggleLoadingBoxesDisplay:function(i){if(this.isSelectiveLoadingActivated()&&this.getController()&&this.getController()._model&&i!==undefined){if(i&&c.getSetting("enopad3dviewer_displayCandidateQueue")!=="OFF"){this.getController()._model.displayCandidateQueue(true,this._colors)}else{if(!i){this.getController()._model.displayCandidateQueue(false,this._colors)}}}},_clearBoxesDisplayTimeout:function(){if(this._boxesDisplayToken){clearTimeout(this._boxesDisplayToken);this._boxesDisplayToken=null}},_clearBoxesRemovalTimeout:function(){if(this._boxesRemovalToken){clearTimeout(this._boxesRemovalToken);this._boxesRemovalToken=null}},_clearVisuEventCallback:function(){if(this._visuEventToken){e.unsubscribe(this._visuEventToken);this._visuEventToken=null}},_clearMemoryLimitCallback:function(){if(this._memoryLimitToken){this.unsubscribe(this._memoryLimitToken);this._memoryLimitToken=null}},disposeLoadingBoxesEngine:function(){if(this.isSelectiveLoadingActivated()){this._clearVisuEventCallback();this._clearMemoryLimitCallback();this._clearBoxesDisplayTimeout()}},setLoadingBoxesColor:function(i){this._colors.repColor=b[i];this._colors.assemblyColor=b[i]}});return f});define("DS/ENOPAD3DViewer/views/PAD3DRootListMgt",["UWA/Class","UWA/Promise","DS/PADUtils/views/PADResponsiveRootList","i18n!DS/PADUtils/assets/nls/PADUtils.json","DS/PADUtils/PADWSAccess","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/Core/ModelEvents","DS/PADUtils/PADSettingsMgt"],function(s,c,u,f,o,t,h,i,m,d){var k=[];var q=s.extend({createRootListSlidder:function(w){var v=this;v.elements.padrootlist_div=UWA.createElement("div",{"class":"pad3drootlist",styles:{height:"calc(100% - 38px)",background:"white",top:"38px",position:"absolute",width:"100%"}});v.elements.pad3drootlist=new u({events:{onTileAdd:n.bind(v),onTileDelete:a.bind(v),onTileSelect:e.bind(v),onAttach:r.bind(v),onDetach:p.bind(v),},callback:function(){t.onPostAdd(function(){var y=l().slice();var x=t.get();b(function(A,z){c.all(y).then(function(B){if(x.length>0){x.forEach(function(D){if(D.pathElement!==null){var E=D.pathElement;var C=E.getLastElement(true);v._controller.getRoots().forEach(function(F){if(i.getNodeID(F)===i.getNodeID(C)){var G=function(){return i.getNodeID(C)};v.elements.pad3drootlist.selectTile({data:{nodeModel:{getID:G}}})}})}})}A()})},"SelectTile");return false});t.onPostRemove(function(A){for(var y=0;y<A.length;y++){if(A[y].pathElement!==null){var z=A[y].pathElement;var x=z.getLastElement(true);v._controller.getRoots().forEach(function(B){if(i.getNodeID(B)===i.getNodeID(x)){var C=function(){return i.getNodeID(x)};v.elements.pad3drootlist.unselectTile({data:{nodeModel:{getID:C}}})}})}}})},disableDetach:d.getSetting("disableDetach")}).inject(v.elements.padrootlist_div);v.subscribe({event:"onRootAdded"},function(x){var y=l().slice();b(function(A,z){c.all(y).then(function(B){o.fetch({enopad_webapis:d.getSetting("enopad_webapis"),data:{authored:false,intent:"fetch_3D",select_predicate:["ds6w:label","ds6w:responsible","ds6w:identifier"],select_file:["icon","thumbnail_2d"]},pids:[x.id],onComplete:function(D){var H=UWA.is(D,"string")?JSON.parse(D):D;var J={};J.grid={};for(var G=0;G<H.results.length;G++){var F=H.results[G];if(F.hasOwnProperty("attributes")){for(var E=0;E<F.attributes.length;E++){var I=F.attributes[E];if(I.name==="resourceid"){J.resourceid=I.value}if(I.name==="ds6w:label"){J.label=I.value}if(I.name==="type_icon_url"){J.icon=[I.value]}if(I.name==="preview_url"){J.thumbnail=I.value}if(I.name==="ds6w:responsible"){J.grid["ds6w:responsible"]=I.value}}}}var C=null;if(i.isFiltered){C=i.isFiltered(v.getController().getNode({id:x.id}),v)}if(C){J.isFiltered=true}else{J.isFiltered=false}if(x.hidden){J.isRootAttached=false}if(d.getSetting("disableDetach")){J.disableDetach=true}if(J){J.nSelect=true;J.resolve=A;v.elements.pad3drootlist.addRootTile(J)}},onFailure:function(){z()}})})},"AddRootTile")});v.subscribe({event:"onRootRemoved"},function(x){if(v.elements.pad3drootlist){v.elements.pad3drootlist.removeTile({tile_id:x.id,noDispatch:true})}return false});v.subscribe({event:"onFilterRemoved"},function(y){if(v.elements.pad3drootlist){var x=v.elements.pad3drootlist._search(y.id);if(x.length){x[0].setBadges({bottomRight:""})}}return false});if(!d.getSetting("disableDetach")){v.subscribe({event:"onRootDetached"},function(y){var x=0;if(v.elements.pad3drootlist._roots2add.length>0){x=250}setTimeout((function(){var A=y.id,z=v.elements.pad3drootlist._search(A);if(z.length===1){z[0].options.isRootAttached=false;z[0].options.statusbarIcons[1]="eye-off";z[0].options.statusbarIconsTooltips[1]=f.attachRoot;v.elements.pad3drootlist.options.grid.layout.invalidate();z[0].unselect()}}).bind(v.elements.pad3drootlist),x)});v.subscribe({event:"onRootAttached"},function(B){var x=B.id,z=v.elements.pad3drootlist._search(x);if(z.length===1){var A=v.elements.pad3drootlist.options.model.getRoots();var y=A.indexOf(z[0]);z[0].options.isRootAttached=true;z[0].options.statusbarIcons[1]="eye";z[0].options.statusbarIconsTooltips[1]=f.detachRoot;v.elements.pad3drootlist.options.grid.layout.invalidate();z[0].select()}})}if(w&&w.leftContainer){v.elements.padrootlist_div.inject(w.leftContainer)}return v.elements.padrootlist_div},});function n(w){var v=this,x={};if(w.json_content.authorized_objects&&w.json_content.authorized_objects.length>0){x={pids:[]};x.callback=w.callback;w.json_content.authorized_objects.forEach(function(y){x.pids.push(y.objectId)});v.addRoots(x)}else{console.warn("You have accessed an invalid branch in the _onTileAdd() event handler.")}return false}function e(x){if(!UWA.is(x.tile_ids,"array")){throw new Error("Invalid input param, no params.tile_ids defined")}var w=this;var v=[];t.empty();h.empty();x.tile_ids.forEach(function(y){var A=w._controller.getNode({id:y});if(A){var z=w._controller.buildPathFromArray([y]);v.push({pathElement:z});t.add(v);t.get().forEach(function(B){h.add(B)})}else{console.log("Cannot find ["+y+"] in the TreeDocument")}})}function a(w){if(!UWA.is(w.tile_id)){throw new Error("Invalid input parameter")}var v=this.getController().getNode({id:w.tile_id});if(UWA.is(v)){this.getController().removeRoots({pids:[w.tile_id]})}return false}function r(y){var w=this.getController().getNode({id:y.tile_id});if(UWA.is(w)){var v=[];var x=this._controller.buildPathFromArray([y.tile_id]);v.push({pathElement:x});t.add(v);t.get().forEach(function(z){h.add(z)});this.getController().attachRoots({pids:[y.tile_id]},true)}this.dispatchEvent("onRootsVisibility");return false}function p(x){var w=this,v=w.getController().getNode({id:x.tile_id});if(UWA.is(v)){w.getController().detachRoots({pids:[x.tile_id]},true)}w.dispatchEvent("onRootsVisibility");return false}function l(){var w=[];for(var v=0;v<k.length;v++){if(!k[v].isFulfilled||!k[v].isFulfilled()){w.push(k[v])}}k=w;return k}function b(x,w){var y=new c(x);var v=j(y,w);l().push(v);return v}function g(){k=[]}function j(A,y){if(A.isResolved){return A}var w=true;var z=false;var x=false;var v=A.then(function(B){x=true;w=false;return B},function(B){z=true;w=false;throw B});v.isFulfilled=function(){return x};v.isPending=function(){return w};v.isRejected=function(){return z};v.name=y;return v}return q});define("DS/ENOPAD3DViewer/models/PAD3DViewerNode",["DS/Visualization/Node3D","DS/ENOPAD3DViewer/utils/PAD3DViewerTypesDictionary"],function(c,b){function a(f,e,g){e=f.length;if(e>1){while(g=--e){while(g--){if(f[e]===f[g]){f.splice(g,1)}}}}return f}var d=c.extend({className:"PAD3DViewerNode",_id:null,_type:null,_treeOrder:null,_loadedStream:null,_BIColor:null,_sequence_filter:null,_config_filter:null,_CVFilterQuery:null,_globalType:null,init:function(e){this._parent();if(e.id){this._id=e.id}if(e.type){this._type=e.type}if(e.BIColor){this._BIColor=e.BIColor}if(e.treeOrder){this._treeOrder=e.treeOrder}if(e.globalType){this._globalType=e.globalType}if(e.sequence_filter){this._sequence_filter=e.sequence_filter}if(e.config_filter){this._config_filter=e.config_filter}if(e.CVFilterQuery){this._CVFilterQuery=e.CVFilterQuery}},getID:function(){return this._id},_setID:function(e){this._id=e},getDid:function(){console.warn("Deprecated: did is not stored on the node anymore, please request it using getAttributes API on PAD3DViewerController");return null},getCgrUrl:function(){console.warn("Deprecated: cgr url is not stored on the node anymore, please request it using getAttributes API on PAD3DViewerController");return null},getThbUrl:function(){console.warn("Deprecated: thb url is not stored on the node anymore, please request it using getAttributes API on PAD3DViewerController");return null},getLoadedStream:function(){return this._loadedStream},setLoadedStream:function(e){this._loadedStream=e},getType:function(){return this._type},getGlobalType:function(){return this._globalType},getBIColor:function(){return this._BIColor},setBIColor:function(e){this._BIColor=e},getTreeOrder:function(){return this._treeOrder},getSequenceFilter:function(){return UWA.clone(this._sequence_filter,true)},setSequenceFilter:function(e){this._sequence_filter=e},getConfigFilter:function(){return UWA.clone(this._config_filter,true)},setConfigFilter:function(e){this._config_filter=e},getCVFilterQuery:function(){return UWA.clone(this._CVFilterQuery,true)},setCVFilterQuery:function(e){this._CVFilterQuery=e},isPLMInstance:function(){return b.get().instances.indexOf(this.getType())!==-1||this.getGlobalType()==="ds6w:Instance"},isPLMRepInstance:function(){return b.get().repInstances.indexOf(this.getType())!==-1||this.getGlobalType()==="ds6w:RepInstance"},isPLMRepReference:function(){return b.get().repReferences.indexOf(this.getType())!==-1||this.getGlobalType()==="ds6w:Document"},isPLMReference:function(){return b.get().references.indexOf(this.getType())!==-1||this.getGlobalType()==="ds6w:Part"},is3DLeaf:function(){return(b.get().representations.indexOf(this.getType())!==-1||this.getGlobalType()==="ds6w:Document")},equals:function(f){var e=false;if(f.getID){e=this.getID()===f.getID()}return e},getSiblings:function(){var f=[],e=this;this.parents.forEach(function(g){g.children.forEach(function(h){if(!h.equals(e)){f.push(h)}})});return a(f)},getReferences:function(){var e=[];if(this.isPLMInstance()){e=this.children}else{if(this.isPLMReference()){e.push(this)}else{if(this.isPLMRepReference()){this.parents.forEach(function(f){e=e.concat(f.parents)})}else{if(this.isPLMRepInstance()){e=this.parents}}}}return a(e)},isLeaf:function(){var e=true;this.children.forEach(function(f){if(f.isPLMRepInstance&&!f.isPLMRepInstance()){e=false}});return this.isPLMReference()&&e},getRootReferences:function(e){if(!e){e=[]}if(this.parents.length===1&&this.parents[0].name==="RootBag"){e.push(this);return a(e)}else{this.parents.forEach(function(f){if(f.getRootReferences){f.getRootReferences(e)}});return a(e)}}});return d});define("DS/ENOPAD3DViewer/models/PAD3DViewerNodeModel",["UWA/Class","DS/ENOPAD3DViewer/models/PAD3DViewerNode","DS/Visualization/Node3D","DS/Visualization/PathElement","DS/Visualization/ModelLoader","DS/Visualization/ThreeJS_DS","DS/Mesh/MeshUtils","DS/PADUtils/PADProbes","DS/PADUtils/PADSettingsMgt","DS/Core/ModelEvents","DS/3DXMTiles/OOCManager","DS/3DXMTiles/OOCModel3DHandler","DS/VisuTools/FPSCounter"],function(c,n,k,g,b,m,e,l,j,d,i,h,a){var f=c.extend({className:"PAD3DViewerNodeModel",init:function(p){var r=this;this._parent(p);this._modelEvents=new d();this._nodeIndex={};this._rootLog=[];this._hiddenRootIds=[];this._modelLoader=null;this._parsingRunning=false;this._withRepLoading=true;if(window.localStorage.getItem("ENOPADNoGeometry")){this._withRepLoading=false}this._selectiveLoadingActivated=j.getSetting("enopad3dviewer_dynamicRepLoading");this._supportPgpBasedOnDescription=j.getSetting("supportPgpBasedOnDescription");this._getFcsUrlsCB=p.getFcsUrlsCB;this._nodeIndex[this.getRootBagId()]=new k("RootBag");p.viewer.addNode(this._nodeIndex[this.getRootBagId()]);this._decorationBag=new k("DecorationBag");p.viewer.addNode(this._decorationBag);this._loadingBoxesBag=new k("LoadingBoxesBag");p.viewer.addNode(this._loadingBoxesBag);var q=new g();q.addElement(this._nodeIndex[this.getRootBagId()]);this._nodeIndex[this.getRootBagId()].path=q;this._modelLoader=new b(p.viewer.getWebGLContext(),false);this._modelLoader.setFileType("cgr");this._modelLoader.setRenderCallback(p.viewer.render,1000);this._modelLoader.setCGRNewInfra(true);this._modelLoader.setSceneGraph(this._nodeIndex[this.getRootBagId()]);if(this._selectiveLoadingActivated){this._modelLoader.setKeepLoaderMode(true);p.viewer.budgetedRenderManager.setBudget(0.1);var o="full";if(navigator.userAgent.match(/iPad/i)){p.viewer.setSmallRenderTargetPicking(true);o="medium"}else{if(navigator.userAgent.match(/Android|iPhone|iPod|BlackBerry|Opera Mini|IEMobile/i)){p.viewer.setSmallRenderTargetPicking(true);o="restricted"}}window.OOCNewPriorityPrototype=true;this._OOCManager=new i(p.viewer,{config:o,enableOcclusionTest:j.getSetting("enopad3dviewer_occlusionTest")});this._OOCManager.setTargetNode(this.getRootBag());this._OOCManager.setOnStartLoadingCB(p.startLoadingCB);this._OOCManager.setOnEndLoadingCB(p.endLoadingCB);this._OOCManager.setUnloadLeafReferenceCB(function(t){var u=r.getNode({id:t});if(u){for(var s=u.children.length-1;s>=0;s--){if(u.children[s].className==="PAD3DViewerCGRNode"){u.remove(u.children[s])}}this.publish({event:"onLeafReferenceUnloaded",data:{id:t}})}}.bind(this));this._OOCManager.setOnLeafReferenceLoadedCB(function(s,t){if(t&&t.nodes){t.nodes.forEach(function(u){u.className="PAD3DViewerCGRNode"})}this.publish({event:"onLeafReferenceLoaded",data:{id:s}})}.bind(this));this._OOCManager.setTargetNode(this.getRootBag());this._OOCManager.setPerformancesOptions({pauseLoadingDuringViewpointMove:true});window._OOCManager=this._OOCManager;this._model3DHandler=new h();this._model3DHandler.setFileType(!j.getSetting("enopad3dviewer_streamFileType")?"cgr":j.getSetting("enopad3dviewer_streamFileType"));this._model3DHandler.setLoadModelOptions({proxyurl:"none"});if(j.getSetting("enopad3dviewer_useStaticURL")&&this._model3DHandler.setRedirectUrlCB){this._model3DHandler.setRedirectUrlCB(function(s,t){this._getFcsUrlsCB({urls:s,callbacks:{onComplete:function(u){if(u.results){t(u.results)}},onFailure:function(w){var v=[];for(var u=0;u<s.length;u++){v.push(null)}t(v)}}})}.bind(this))}if(window.localStorage.getItem("TileModelPerf")==="ON"){a.setAutoRefresh(false);p.viewer.showPerfo(true,false)}}},getRootBagId:function(){return"rootBag"},getRootLog:function(){return this._rootLog.slice(0)},addToRootLog:function(o){this._rootLog.push(o)},getHiddenRootIds:function(o){if(o!==undefined){return this._hiddenRootIds[o]}else{return this._hiddenRootIds}},destroy:function(){delete this._modelLoader;delete this._nodeIndex;delete this._hiddenRootIds;delete this._rootLog;if(this._modelEvents){delete this._modelEvents}this._parent()},_parseAttributes:function(p,o){var s=null;var r=p.length;var q=0;o.did=null;o.type=null;o.globalType=null;o.pid=null;o.thbUrl=null;o.cgrUrl=null;o.matrix=null;o.treeOrder=null;o.hide=null;o.pgpOptions=null;for(q=0;q<r;q++){s=p[q];if(s.name==="did"){o.did=s.value}else{if(s.name==="type"){o.type=s.value}else{if(s.name==="ds6w:type"){o.type=s.value}else{if(s.name==="ds6w:globalType"){o.globalType=s.value}else{if(s.name==="physicalid"){o.pid=s.value}else{if(s.name==="resourceid"){o.pid=s.value}else{if(s.name==="thumbnail_3d"){o.thbUrl=s.value}else{if(s.name==="cgr"){o.cgrUrl=s.value}else{if(s.name==="stepcgr"){o.stepcgrUrl=s.value}else{if(s.name==="TreeOrder"){o.treeOrder=parseFloat(s.value)}else{if(s.name==="ro.plminstance.V_description"&&this._supportPgpBasedOnDescription){if(s.value==="tmpHide"){o.hide=true}}else{if(s.name==="matrixtxt"&&s.value!==""){o.matrix=null;if(s.value!=="1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0"&&s.value!=="1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0"&&s.value!=="1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0"){o.matrix=new m.Matrix4();var t=s.value.split(/[,]/);o.matrix.elements[0]=parseFloat(t[0]);o.matrix.elements[1]=parseFloat(t[1]);o.matrix.elements[2]=parseFloat(t[2]);o.matrix.elements[4]=parseFloat(t[3]);o.matrix.elements[5]=parseFloat(t[4]);o.matrix.elements[6]=parseFloat(t[5]);o.matrix.elements[8]=parseFloat(t[6]);o.matrix.elements[9]=parseFloat(t[7]);o.matrix.elements[10]=parseFloat(t[8]);o.matrix.elements[12]=parseFloat(t[9]);o.matrix.elements[13]=parseFloat(t[10]);o.matrix.elements[14]=parseFloat(t[11])}}else{if(s.name.toLowerCase()==="ro.pgpshowextension.v_pgp_show"||s.name.toLowerCase()==="bo.pgpshowextension.v_pgp_show"){o.pgpOptions=s.value.toLowerCase()==="true"?true:false}else{if(s.name.toLowerCase()==="bo.pgpcolorrgbextension.v_pgp_colorrgb"||s.name.toLowerCase()==="ro.pgpcolorrgbextension.v_pgp_colorrgb"){o.pgpOptions=s.value}}}}}}}}}}}}}}}if(o.stepcgrUrl){o.cgrUrl=o.stepcgrUrl;delete o.stepcgrUrl}if(!o.globalType&&o.type==="VPMRepInstance"){o.globalType="ds6w:RepInstance"}},_parseBoundingBox:function(o){return new m.Box3(new m.Vector3(parseFloat(o.min[0]),parseFloat(o.min[1]),parseFloat(o.min[2])),new m.Vector3(parseFloat(o.max[0]),parseFloat(o.max[1]),parseFloat(o.max[2])))},buildFromJSON:function(ab){var M=this;var y=ab.hidden!==undefined?ab.hidden:false;M._rootId=null;M._nbCGRToLoad=0;M._nbCGRLoaded=0;M.nbCgrLoaded=0;M.nbThbLoaded=0;var O=true;var K=[];var G=[];var J=new Map();var Q=[];var z={references:[],instances:[],occurrences:[],hiddenPaths:[]};var ad={};var L=null;var A=function(){if(M._nbCGRToLoad>0){M.load3DProbe.end();delete M.load3DProbe}var af=K.slice(0);var ag=G.slice(0);var ae=M._rootId;ab.callbacks.onComplete({id:ae,createdPaths:af,selectedPaths:ag,pgpOptions:z,BS:L});M._nbCGRToLoad=null;M._nbCGRLoaded=null;M._rootId=null;K=null;G=null;ab=null;z=null;M=null};if(!M._selectiveLoadingActivated){var v=function(ae){if(ae&&ae.nodes){ae.nodes.forEach(function(af){af.className="PAD3DViewerCGRNode"})}M._nbCGRLoaded++;ab.callbacks.onCGRLoad({nbCGRLoaded:M._nbCGRLoaded,nbCGRToLoad:M._nbCGRToLoad})};var Z=function(ae){M._nbCGRLoaded++;ab.callbacks.onCGRLoad({nbCGRLoaded:M._nbCGRLoaded,nbCGRToLoad:M._nbCGRToLoad})};this._modelLoader.setOnLoadedCallback(A);this._modelLoader.setOnLoadedProductStructureCallback(v);this._modelLoader.onErrorCB=Z}this._parsingRunning=true;this.parsingProbe=l.createProbe("queryResultParsing");var t=false;var W=ab.json.results.length;var ac=0;for(ac=0;ac<W;ac++){var R=ab.json.results[ac];if(R.attributes!==undefined){var P={},H;M._parseAttributes(R.attributes,P);J.set(P.did,P.pid);var F=M.getNode({id:P.pid});if(!F){Q.push(P.pid);if(P.hide===true){ad[P.pid]=true}F=M.createNode({id:P.pid,type:P.type,globalType:P.globalType,matrix:P.matrix,treeOrder:P.treeOrder});var I=null,s=null;if(M._selectiveLoadingActivated){if(R.boundingbox){s=this._parseBoundingBox(R.boundingbox);I=s?s.getBoundingSphere():null;if(s.max.x<s.min.x){if(!P.thbUrl&&!P.cgrUrl){I.radius=0}else{I=null}}if((I!==null&&L!==null&&I.radius>L.radius)||(L===null&&I!==null)){L=I}}if(ab.rootIds.indexOf(P.pid)!==-1&&I&&I.radius>0){L=I;t=true}}if(F.is3DLeaf()&&(P.thbUrl||P.cgrUrl)){if(ab.streamToLoad==="thumbnail"&&P.thbUrl){H=P.thbUrl;F.setLoadedStream("thumbnail");M.nbThbLoaded++}else{H=P.cgrUrl;F.setLoadedStream("cgr");M.nbCgrLoaded++}if(M._nbCGRToLoad===0){M.load3DProbe=l.createProbe("3DLoading")}if(M._selectiveLoadingActivated){if(H&&M._withRepLoading){M._OOCManager.registerLeafReference(P.pid,{handler:M._model3DHandler,url:H,boundingBox:I&&I.radius>0?s:undefined,boundingSphere:I,node:F});if(O){O=false;M._OOCManager.forceReferenceLoad(P.pid,null)}}}else{if(H&&M._withRepLoading){M._nbCGRToLoad++;M._modelLoader.loadModel({filename:H,format:"cgr",requestsOptions:{proxymode:"passport"}},F)}}}}if(P.pgpOptions!==undefined&&P.pgpOptions!==null){var C={id:P.pid,value:P.pgpOptions,type:typeof(P.pgpOptions)==="boolean"?"hideshow":"color"};if(P.globalType==="ds6w:Part"||P.globalType==="ds6w:Document"){z.references.push(C)}else{z.instances.push(C)}}}else{if(R.path!==undefined){var p=J.get(""+R.path[0]);var S=[p];if(M._rootId===null||M._rootId!==p){M._rootId=p;var u=false;if(ab.parent){var B=ab.parent.children;for(var aa=0;aa<B.length;aa++){if(B[aa].getID&&B[aa].getID()===M._rootId){u=true;break}}var w=M.getNode({id:M._rootId});if(!u&&!y){ab.parent.add(w);w.path=ab.parent.path.clone();w.path.addElement(w)}else{if(y){w.path=ab.parent.path.clone();w.path.addElement(w)}}}}var o=M._rootId;if(null!==o){var N=false;var x=true;var r=M.getNode({id:o});for(var aa=1;aa<R.path.length;aa++){var Y=J.get(""+R.path[aa]);if(undefined===Y){Y=String(R.path[aa])}var T=true;S.push(Y);if(ad[Y]){var E=UWA.clone(S);E.push(J.get(""+R.path[aa+1]));z.hiddenPaths.push(E)}if(!M.isNodeAlreadyAttached(Y,o)){M.attachNode({id:Y,parentId:o});N=true}o=Y}if(N){K.push(S)}G.push(S)}}else{if(R.pgp_overload!==undefined){var D=Object.keys(R.pgp_overload);var q=Object.values(R.pgp_overload);for(var X=0;X<q.length;X++){if(q[X]["PGPShowExtension.V_PGP_Show"]!==undefined){D[X]=D[X].split(",");for(var V=0;V<D[X].length;V++){D[X][V]=J.get(""+D[X][V])}z.occurrences.push({path:D[X],value:q[X]["PGPShowExtension.V_PGP_Show"].toLowerCase()==="true"?true:false,type:"hideshow"})}if(q[X]["PGPColorRGBExtension.V_PGP_ColorRGB"]!==undefined){D[X]=D[X].split(",");for(var U=0;U<D[X].length;U++){D[X][U]=J.get(""+D[X][U])}z.occurrences.push({path:D[X],value:q[X]["PGPColorRGBExtension.V_PGP_ColorRGB"],type:"color"})}}}}}}M.parsingProbe.end();delete M.parsingProbe;ab.json=null;delete ab.json;M._parsingRunning=false;if(M._selectiveLoadingActivated&&ab.intent==="addRoot"&&ab.reframe===true){ab.callbacks.onReframe({BS:L,rootBS:t})}if(z.hiddenPaths.length||z.references.length||z.instances.length||z.occurrences.length){M.publish({event:"PGPPostProcess",data:z})}M.publish({event:"onUrlLoaded",data:{nbCgrLoaded:M.nbCgrLoaded,nbThbLoaded:M.nbThbLoaded}});if(Q.length){M.publish({event:"newNodes",data:{newNodes:Q}})}if(M._nbCGRToLoad===0||M._selectiveLoadingActivated){A()}},reparentNode:function(u){var s;var t=this;for(var r=0;r<u.json.results.length;r++){var p=u.json.results[r];if(p.attributes!==undefined){var o={};t._parseAttributes(p.attributes,o);if(o.pid===u.createdInstID){s=t.getNode({id:o.pid});if(!s){s=t.createNode({id:o.pid,type:o.type,globalType:o.globalType,matrix:o.matrix,treeOrder:o.treeOrder});break}}}}u.json=null;delete u.json;if(u.newParent.getID){t.attachNode({id:u.createdInstID,parentId:u.newParent.getID()})}var q=u.oldInstance.children;q.forEach(function(v){if(v.getID&&u.oldInstance.getID){t.detachNode({id:v.getID(),parentId:u.oldInstance.getID()});t.attachNode({id:v.getID(),parentId:u.createdInstID})}});t.removeNode({id:u.oldInstance.getID()});return s},insertExistingNode:function(t){var r;var s=this;for(var q=0;q<t.json.results.length;q++){var p=t.json.results[q];if(p.attributes!==undefined){var o={};s._parseAttributes(p.attributes,o);if(o.pid===t.createdInstID){r=s.getNode({id:o.pid});if(!r){r=s.createNode({id:o.pid,type:o.type,globalType:o.globalType,matrix:o.matrix,treeOrder:o.treeOrder});break}}}}t.json=null;delete t.json;if(t.parent.getID&&t.toInsert.getID){s.attachNode({id:t.createdInstID,parentId:t.parent.getID()});s.attachNode({id:t.toInsert.getID(),parentId:t.createdInstID})}return r},isNodeAlreadyAttached:function(r,s){var o=false;var p=this.getNode({id:r}).parents;for(var q=0;q<p.length;q++){if(p[q]&&p[q].getID&&p[q].getID()===s){o=true;break}}return o},createNode:function(p){if(!UWA.is(p,"object")){throw new Error("No parameter defined")}if(!UWA.is(p.id,"string")){throw new Error("No id defined")}if(!UWA.is(p.type,"string")){throw new Error("No type defined")}var o=new n({id:p.id,type:p.type,globalType:p.globalType,treeOrder:p.treeOrder});if(p.matrix){o.setMatrix(p.matrix)}this._nodeIndex[String(p.id)]=o;return o},removeNode:function(q){if(!UWA.is(q,"object")){throw new Error("No parameter defined")}if(q.id===undefined){console.error("No id defined");return}for(var o=this._rootLog.length-1;o>=0;o--){if(UWA.is(this._rootLog[o],"array")){if(this._rootLog[o][0]===q.id){this._rootLog.splice(o,1)}}}var p=this.getNode({id:q.id});if(p){if(p.parents.length<=1){if(q.removeDetached===true&&p.isDetached){p.isDetached=false}if(p.isDetached!==true){this._removeChildren(p);p.parents.forEach(function(r){r.remove(p)});delete this._nodeIndex[q.id];if(p.is3DLeaf()&&this._selectiveLoadingActivated&&this._OOCManager&&this._OOCManager.isRegistered(p.getID())){this._OOCManager.unregisterLeafReference(p.getID())}}}else{this.detachNode({id:q.id,parentId:this.getRootBagId()})}}},removeRoot:function(o){this.removeNode(o)},_removeChildren:function(p){if(p){var q=this;var o=p.children;if(o){o.forEach(function(r){if(r.parents.length===1){if(r.getID){if(q.getHiddenRootIds().indexOf(r.getID())===-1){if(r.is3DLeaf()&&q._selectiveLoadingActivated&&q._OOCManager&&q._OOCManager.isRegistered(r.getID())){q._OOCManager.unregisterLeafReference(r.getID())}delete q._nodeIndex[r.getID()];q._removeChildren(r)}}else{q._removeChildren(r)}}});o.forEach(function(r){p.remove(r)})}}},detachNode:function(q){if(!UWA.is(q,"object")){throw new Error("No parameter defined")}if(q.id===undefined){console.error("No id defined");return}if(q.parentId===undefined){console.error("No parentId defined");return}var p=this.getNode({id:q.id});p.isDetached=true;var o=this.getNode({id:q.parentId});if(p&&o){o.remove(p)}},attachNode:function(q){if(!UWA.is(q,"object")){throw new Error("No parameter defined")}if(q.id===undefined){console.error("No id defined");return}if(q.parentId===undefined){console.error("No parentId defined");return}var p=this.getNode({id:q.id});p.isDetached=false;var o=this.getNode({id:q.parentId});if(p&&o){o.add(p);p.path=o.path.clone();p.path.addElement(p)}},updateNode:function(q,o){var p=null;if(!UWA.is(q,"object")){console.error("updateNode: There is no parameter defined.");return p}if(!UWA.is(q.id,"string")){console.error("updateNode: There is no id defined.");return p}if(!UWA.is(o,"object")){console.error("updateNode: There is no new parameter defined.");return p}if(!UWA.is(o.id,"string")){console.error("updateNode: There is no new id defined.");return p}p=this.getNode({id:q.id});if(p){if(o.matrix){p.setMatrix(o.matrix)}else{p._setID(o.id);this._nodeIndex[o.id]=p;delete this._nodeIndex[q.id]}}else{throw new Error("updateNode: Node not found.")}return p},switchNodeVisuStreamOnDemand:function(r){if(!UWA.is(r,"object")){throw new Error("No parameter defined")}if(!UWA.is(r.data,"array")){throw new Error("No input data defined")}if(!UWA.is(r.callbacks.onURLLoad,"function")){throw new Error("No onURLLoad callback function defined")}if(!UWA.is(r.callbacks.onComplete,"function")){throw new Error("No onComplete callback function defined")}var q=this;q._nbURLToLoad=r.data.length;q._nbURLLoaded=0;q.nbCgrLoaded=0;q.nbThbLoaded=0;var p=null;if(!q._selectiveLoadingActivated){var s=function(t){if(t&&t.nodes){t.nodes.forEach(function(u){u.className="PAD3DViewerCGRNode"})}q._nbURLLoaded++;r.callbacks.onURLLoad({nbURLLoaded:q._nbURLLoaded,nbURLToLoad:q._nbURLToLoad})};var o=function(){r.callbacks.onComplete({nbUrlLoaded:q._nbURLLoaded})};q._modelLoader.setOnLoadedCallback(o);q._modelLoader.setOnLoadedProductStructureCallback(s);q._modelLoader.onErrorCB=s}else{p=function(){q._nbURLToLoad--;q._nbURLLoaded++;if(q._nbURLToLoad===0){r.callbacks.onComplete({nbUrlLoaded:q._nbURLLoaded})}}}r.data.forEach(function(t){var v=t.url;if(v&&t.stream!==t.node.getLoadedStream()){for(var u=t.node.children.length-1;u>=0;u--){if(t.node.children[u].className==="PAD3DViewerCGRNode"){t.node.remove(t.node.children[u])}}t.node.setLoadedStream(t.stream);if(t.stream==="cgr"){q.nbCgrLoaded++}else{q.nbThbLoaded++}if(q._selectiveLoadingActivated){q._OOCManager.setReferenceLoadModelOptions(t.node.getID(),{applicativeContainers:r.applicativeContainers?r.applicativeContainers:undefined});q._OOCManager.switchLOD(t.node.getID(),v,p)}else{q._modelLoader.loadModel({filename:v,format:"cgr",requestsOptions:{proxymode:"passport"}},t.node,false,{applicativeContainers:r.applicativeContainers?r.applicativeContainers:undefined})}}else{q._nbURLToLoad--}});q.publish({event:"onUrlLoaded",data:{nbCgrLoaded:q.nbCgrLoaded,nbThbLoaded:q.nbThbLoaded}});if(!q._nbURLToLoad){r.callbacks.onComplete({nbUrlLoaded:q._nbURLLoaded})}},refreshStream:function(s){if(!UWA.is(s,"object")){throw new Error("No parameter defined")}if(!UWA.is(s.data,"array")){throw new Error("No input data defined")}if(!UWA.is(s.callbacks.onURLLoad,"function")){throw new Error("No onURLLoad callback function defined")}if(!UWA.is(s.callbacks.onComplete,"function")){throw new Error("No onComplete callback function defined")}var r=this;r._nbURLToLoad=s.data.length;r._nbURLLoaded=0;r.nbCgrLoaded=0;r.nbThbLoaded=0;var q=null;if(!r._selectiveLoadingActivated){var p=function(t){if(t&&t.nodes){t.nodes.forEach(function(u){u.className="PAD3DViewerCGRNode"})}r._nbURLLoaded++;s.callbacks.onURLLoad({nbURLLoaded:r._nbURLLoaded,nbURLToLoad:r._nbURLToLoad})};var o=function(){s.callbacks.onComplete()};r._modelLoader.setOnLoadedCallback(o);r._modelLoader.setOnLoadedProductStructureCallback(p);r._modelLoader.onErrorCB=p}else{q=function(){r._nbURLToLoad--;if(r._nbURLToLoad===0){s.callbacks.onComplete()}}}s.data.forEach(function(u){var v=u.url;if(v){for(var t=u.node.children.length-1;t>=0;t--){if(u.node.children[t].className==="PAD3DViewerCGRNode"){u.node.remove(u.node.children[t])}}u.node.setLoadedStream(u.stream);if(r._selectiveLoadingActivated){r._OOCManager.setReferenceLoadModelOptions(u.node.getID(),{applicativeContainers:s.applicativeContainers});r._OOCManager.switchLOD(u.node.getID(),v,q)}else{r._modelLoader.loadModel({filename:v,format:"cgr",requestsOptions:{proxymode:"passport"},},u.node,false,{applicativeContainers:s.applicativeContainers})}}else{r._nbURLToLoad--}});r.publish({event:"onUrlLoaded",data:{nbCgrLoaded:r.nbCgrLoaded,nbThbLoaded:r.nbThbLoaded}});if(!r._nbURLToLoad){s.callbacks.onComplete()}},getRootBag:function(){return this._nodeIndex.rootBag},getNode:function(o){if(!UWA.is(o,"object")){throw new Error("No parameter defined")}if(!UWA.is(o.id,"string")){console.error("No id defined");return}return this._nodeIndex[o.id]},getRoot:function(o){return this.getNode(o)},abort:function(){while(this._parsingRunning){}this._modelLoader.abort()},getDecorationBag:function(){return this._decorationBag},getLoadingBoxesBag:function(){return this._loadingBoxesBag},publish:function(o){this.getModelEvents().publish(o)},subscribe:function(o,p){return this.getModelEvents().subscribe(o,p)},unsubscribe:function(o){this.getModelEvents().unsubscribe(o)},getModelEvents:function(){return this._modelEvents},isNodeLocked:function(o){if(this._OOCManager){return(this._OOCManager.getSceneGraphLockCounter(o)>0)?true:false}return null},lockNodes:function(o){if(!UWA.is(o,"object")){console.error("Incorrect options type in lockNodes()");return}if(this._OOCManager){for(var p=0;p<o.ids.length;++p){this._OOCManager.addSceneGraphLock(o.ids[p])}}},unlockNodes:function(o){if(!UWA.is(o,"object")){console.error("Incorrect options type in unlockNodes()");return}if(this._OOCManager){for(var p=0;p<o.ids.length;++p){this._OOCManager.removeSceneGraphLock(o.ids[p])}}},getReferenceBoundingSphere:function(o){return null},pause:function(){if(this._OOCManager){this._OOCManager.setPauseLoading(true)}},resume:function(){if(this._OOCManager){this._OOCManager.setPauseLoading(false)}},enableProgressiveBI:function(){},disableProgressiveBI:function(){},displayCandidateQueue:function(p,o){if(p){this._OOCManager.setCandidateQueueRendererParams(true,{displayIntermediateReferences:true,repRefAttributes:{color:new m.Color(o.repColor),opacity:0.3,dimension:2},refAttributes:{color:new m.Color(o.assemblyColor),opacity:1,dimension:1},rootNode:this.getLoadingBoxesBag()})}else{this._OOCManager.setCandidateQueueRendererParams(false)}},setLoadingBoxesPickable:function(o){if(this._OOCManager&&this._OOCManager.setLoadingBoxesPickable){if(o){this._OOCManager.setLoadingBoxesPickable(e.PICKABLE)}else{this._OOCManager.setLoadingBoxesPickable(e.NODRAWHL)}}},getOOCSelectedReferenceID:function(){var o=null;if(this._OOCManager){o=this._OOCManager.getSelectedReference()}return o}});return f});define("DS/ENOPAD3DViewer/mixins/_PAD3DViewerBIController",["UWA/Core","UWA/Controls/Abstract","DS/PADUtils/PADPromise","DS/Visualization/PathElement","DS/Visualization/ThreeJS_DS","DS/Selection/CSOManager","DS/PADUtils/PADSettingsMgt","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/Visualization/SceneGraphUtils","DS/PADUtils/PADUtilsServices","DS/Utilities/Utils"],function(f,h,g,d,l,c,j,i,b,a,e,k){var m=h.extend({name:"PAD3DViewerBIController",_userQueueCallbacks:{},_overloadedNodes:[],_modelControllerTokens:[],_mode:null,_isColorizeActive:false,_refineOverrideSet:null,_biOverrideSet:null,_biCommandProxy:null,_overrideSetId:"biColorOverride",_biRootAddedEvents:-1,_biRootRemovedEvents:-1,_cbCounter:0,initBIController:function(){this._viewer=this._context.getViewer();this._refineOverrideSet=new i(this.getRootBagPath().externalPath[0]);this._biOverrideSet=new i(this.getRootBagPath().externalPath[0])},destroyBIController:function(){if(this._viewer){delete this._viewer}if(this._biCommandProxy){this._biCommandProxy.destroy();delete this._biCommandProxy}delete this._refineOverrideSet;delete this._biOverrideSet;this._parent()},onSetTagsWithExpandSynthesis:function(){if(this.isStandaloneFilterAvailable()===true){if(this._BIProxy){var o=[];this.getRoots().forEach(function(p){var q=b.getNodeID(p);if(q){o.push(q)}});if(this._BIProxy.setTagsWithExpandSynthesis){var n={no_type_filter_bo:["PLMPort","PLMConnection"],synthesis_mode:"flat",max_count_path:"1"};if(o.length){this._BIProxy.setTagsWithExpandSynthesis(o,n)}}else{console.warn("onSetTagsWithExpandSynthesis: The BIProxy doesn't implement the setTagsWithExpandSynthesis() method.")}}else{console.warn("onSetTagsWithExpandSynthesis: The PAD3DViewerController doesn't contains a BIProxy object.")}}},toggleBetweenStandaloneAndSlaveMode:function(n){if(n===this._biMode){return}if(n==="STANDALONE"){this._activateStandaloneMode()}else{if(n==="SLAVE"){this._activateSlaveMode()}}},_activateStandaloneMode:function(){this._biMode="STANDALONE";this._resetShading();this._resetFiltering();this._BIProxy.addEvent("FilterBIColorize",this._onFilterBIColorize,this);this._BIProxy.addEvent("FilterBIUnColorize",this._onFilterBIUnColorize,this);this._biRootAddedEvents=this.subscribe({event:"onRootAdded"},this.onSetTagsWithExpandSynthesis.bind(this));this._biRootRemovedEvents=this.subscribe({event:"onEndRootRemoved"},this._rootRemovedProxyEvent.bind(this));this.registerOverrideSet(this._overrideSetId)},_activateSlaveMode:function(){this._biMode="SLAVE";this._resetShading();this._resetFiltering();this._modelControllerTokens.forEach(function(n){this._context.unsubscribe(n)}.bind(this));this._modelControllerTokens=[];if(this._biRootAddedEvents!==-1){this._clearRootEvents()}if(this._context.isInterwidgetComAvailable()&&!this._biCommandProxy){require(["DS/PADUtils/PADCommandProxy"],function(o){var n=this;this._biCommandProxy=o.create({events:{onPadFilterBI:function(p){if(!n.isStandalone()){if(p.filterBIColorize){n._onFilterBIColorize(p.filterBIColorize)}else{if(p.filterBIUnColorize){n._onFilterBIUnColorize(p.filterBIUnColorize)}else{if(p.filterBIFilteringEvent){n._onFilterBIRefineEvent(p.filterBIFilteringEvent)}else{if(p.filterBIUnFilterEvent){n._onFilterBIUnFilter()}}}}}},onApplyFilter:function(p){n.applyFilter(p,false)},onPadDestroy:function(){if(!n.isStandalone()){n._resetShading();n._resetFiltering()}}}})}.bind(this))}},_rootRemovedProxyEvent:function(o){if(this.isStandaloneFilterAvailable()===true){if(o.ids){this._BIProxy.resetNGFilterUI({widgetId:e.getWidgetId(),appId:e.getSharedId(),rootIds:o.ids});for(var n=0;n<o.ids.length;n++){this._BIProxy.removeRoot(o.ids[n])}}}},_onFilterBIColorize:function(p){if(this.isColorizeAvailable()===true){var n=this;var o=g.getPromises().slice();g.createPromise(function(r,q){Promise.all(o).then(function(D){n._isColorizeActive=true;o=null;n._resetShading();function B(G,F){if(f.is(G.coloredSubjects,"array")){G.coloredSubjects.forEach(function(I){var H=I.color;var J=I.path.map(function(K){return G.nodes[K]});F(H,J)})}}function v(){var F=n._viewer.getSceneGraphOverrideSetManager();if(F){F.pushSceneGraphOverrideSet(n._biOverrideSet)}n._viewer.render();n.publish({event:"onBIColorize",});r()}function u(F,G){if(F.length===0){return}n.getAttributes({ids:F,attributes:[n._colorMap.predicate],callbacks:{onComplete:function(L){var K=Object.keys(L);if(j.getSetting("enopad3dviewer_lightNodeModel")===true){for(var H=0;H<K.length;++H){if(!n.hasOverrideCB(K[H],n._overrideSetId)&&L[K[H]]){n.setOverrideCB(K[H],function(P,O){var Q=true;var N=n._colorMap.map[L[P][n._colorMap.predicate]];if(!N){Q=false;N=!N?"#FFFFFF":N}O.setColor(N,Q)},n._overrideSetId)}}}else{for(var H=0;H<K.length;++H){var J=n._model._nodeIndex[K[H]];var I=new l.MeshPhongMaterial({color:y.map[L[K[H]][y.predicate]],side:l.DoubleSide});var M=a.buildPathesLeadingToNode(J,n.getRootBag());M.forEach(function(O){var N=n._biOverrideSet.createOverride(O);N.setMaterial(I,true)});J.setBIColor(y.map[L[K[H]][y.predicate]]);n._overloadedNodes.push(J)}v()}n._viewer.render({updateInfinitePlane:true});if(G){G()}r()},onFailure:function(H){console.log(H)}}})}if(n._viewer){var t=n._model.getRootBag();if(n.isStandalone()){if(f.is(p.tagColors,"array")){var y={map:{},predicate:undefined};p.tagColors.forEach(function(F){if(y.predicate===undefined){var H=F.predicate.split("/");var G=H[H.length-1];y.predicate=G.toLowerCase()}y.map[F.object]=F.color});n._colorMap=y;if(j.getSetting("enopad3dviewer_lightNodeModel")===false){var E=Object.keys(n._model._nodeIndex);var s=[];for(var A=0;A<E.length;++A){var x=n._model._nodeIndex[E[A]];if(b.is3DLeaf(x)){var C=b.getReferences(x);for(var z=0;z<C.length;++z){s.push(b.getNodeID(C[z]))}if(s.length===1000){u(s);s=[]}}}u(s)}else{var w=false;n._userQueueCallbacks={handleReferences:function(N,G){w=true;var P=[];var F=[];for(var K=0;K<N.length;++K){var L=n.createReferenceIterator(N[K]);var M=L.getParents();for(var J=0;J<M.length;++J){var H=M[J].getReferenceId();if(H&&P.indexOf(H)===-1){P.push(H)}}F.push(L.getReferenceId())}var O=this;var I=function(){O.done(F,[],G)};u(P,I)},getBatchSize:function(){return 1000},isReady:function(){return w===false},done:function(F,H,G){w=false;G.doneCB(F,H)},onFailure:function(F){console.log(F)}};n._model.enableProgressiveBI(n._userQueueCallbacks)}}}else{if(p.nodes){p.nodes.forEach(function(F){var H=n._context.getController().getNode({id:F.pid});if(H&&F.color){H.setBIColor(F.color);n._overloadedNodes.push(H);var I=a.buildPathesLeadingToNode(H,t);var G=new l.MeshPhongMaterial({color:F.color,side:l.DoubleSide});I.forEach(function(K){var J=n._biOverrideSet.createOverride(K);J.setMaterial(G,false)})}});p.path.forEach(function(K){var H=[];K.forEach(function(L){H.push(p.nodes[L].pid)});var J=n._context.unstreamPath(H,true);if(J){var F=J.getLastElement(true).getBIColor();if(F!==null){var I=new l.MeshPhongMaterial({color:J.getLastElement(true).getBIColor(),side:l.DoubleSide});var G=n._biOverrideSet.createOverride(J);G.setMaterial(I,true)}}})}v()}}})},"filterBIColorize",false)}},_onFilterBIUnColorize:function(){if(this.isColorizeAvailable()===true){var n=this;var o=g.getPromises().slice();g.createPromise(function(q,p){Promise.all(o).then(function(r){n._model.disableProgressiveBI(n._userQueueCallbacks);o=null;n._resetShading();n._isColorizeActive=false;n._context.getLevelSelectorCommand(function(s){s.endExecute()});n.publish({event:"onBIUnColorize",});q()})},"filterBIUnColorize")}},colorizeNewNodes:function(r){if(this.isColorizeAvailable()===true){if(j.getSetting("enopad3dviewer_lightNodeModel")===true){for(var q=0;q<r.leavesToColorize.length;q++){var n=this.createReferenceIterator(r.leavesToColorize[q]);var p=n.getParents();for(var o=0;o<p.length;++o){var s=p[o].getReferenceId();if(!this.hasOverrideCB(s,this._overrideSetId)&&r.hashMap[s]){this.setOverrideCB(s,function(v,u){var w=true;var t=this._colorMap.map[r.hashMap[v][this._colorMap.predicate]];if(!t){w=false;t=!t?"#FFFFFF":t}u.setColor(t,w)}.bind(this),this._overrideSetId)}}}this._viewer.render()}else{console.warn("colorizeNewNodes: This method must be called in light node model only.")}}},_onFilterBIUnFilter:function(){if(this.isColorizeAvailable()===true){var n=this;var o=g.getPromises().slice();g.createPromise(function(q,p){Promise.all(o).then(function(r){n._resetFiltering();n.publish({event:"onBIUnFiltering",});q()})},"filterBIUnFilter")}},_resetShading:function(){if(this.isColorizeAvailable()===true){var n=this;if(this._viewer){if(j.getSetting("enopad3dviewer_lightNodeModel")===true){n.removeOverrideSet(n._overrideSetId);n.registerOverrideSet(n._overrideSetId)}else{if(n._overloadedNodes&&n._overloadedNodes.length){n._overloadedNodes.forEach(function(p){if(typeof p!=="string"){p.setBIColor(null)}});var o=this._viewer.getSceneGraphOverrideSetManager();if(o&&this._biOverrideSet){o.removeSceneGraphOverrideSet(this._biOverrideSet);delete this._biOverrideSet;this._biOverrideSet=new i(this._context.getController().getRootBagPath().externalPath[0])}}n._overloadedNodes=[]}n._viewer.render({updateInfinitePlane:true})}}},_resetFiltering:function(){if(this.isColorizeAvailable()===true){var n=this;if(n._viewer&&this._refineOverrideSet){var o=this._viewer.getSceneGraphOverrideSetManager();if(o){o.removeSceneGraphOverrideSet(this._refineOverrideSet);delete this._refineOverrideSet;this._refineOverrideSet=new i(this._context.getController().getRootBagPath().externalPath[0])}n._viewer.render({updateInfinitePlane:true})}}},getBIProxy:function(){return this._BIProxy},isColorizeActivated:function(){return this._isColorizeActive},isStandalone:function(){return(this._biMode==="STANDALONE")},getBIColorMap:function(){return f.clone(this._colorMap,true)},isColorizeAvailable:function(){var p=j.getSetting("enopad3dviewer_roles");var n=false;if(p){for(var o=0;o<p.length;o++){if(p[o].id==="CSV"||p[o].id==="InternalDS"){n=true;break}}}return(n&&this._BIMode!=="OFF")},applyPGPColor:function(B){var y=this;var o=y._context.getController().getRootBag();if(B.references&&B.references.length>0){var r=[];for(var x=0;x<B.references.length;x++){var A=a.buildPathesLeadingToNode(y._context.getController().getNode({id:B.references[x].id}),o);if(B.references[x].type==="color"){r=refShowPaths.concat(A)}}if(r.length){}}if(B.instances&&B.instances.length>0){var C=[];for(var w=0;w<B.instances.length;w++){var u=a.buildPathesLeadingToNode(y._context.getController().getNode({id:B.instances[w].id}),o);for(var v=0;v<u.length;v++){u[v].addElement(b.getReferences(u[v].getLastElement(true))[0])}if(B.instances[w].type==="color"){C=C.concat(u)}}if(C.length){}}if(B.occurrences&&B.occurrences.length>0){for(var q=0;q<B.occurrences.length;q++){var D=[],t,s,z;s=y._context.unstreamPath(B.occurrences[q].path);s.substractPath(y._context.unstreamPath([B.occurrences[q].path[0],B.occurrences[q].path[1]]),s);z=a.buildPathesLeadingToNode(y._context.getController().getNode({id:B.occurrences[q].path[0]}),o);for(var p=0;p<z.length;p++){z[p].concatenatePathes(z[p],s);t=z[p];if(B.occurrences[q].type==="color"){}}if(D.length){}}}}});return m});define("DS/ENOPAD3DViewer/mixins/_PAD3DViewerExternalKPIController",["UWA/Core","UWA/Controls/Abstract","DS/PADUtils/PADPromise","DS/Visualization/PathElement","DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphUtils","DS/Visualization/Node3D","DS/Selection/CSOManager","DS/PADUtils/PADSettingsMgt","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/ENOPAD3DViewer/views/PAD3DPushpinCanvasNode","DS/PADUtils/PADUtilsServices","DS/Utilities/Utils"],function(g,i,h,e,n,a,l,c,k,b,j,f,m){var d=i.extend({name:"PAD3DViewerExternalKPIController",_externalKPICommandProxy:null,_viewer:null,_decorationBag:null,_activeKPI:false,_colorDescriptionMap:null,_layers:null,_colorKPIUserQueueCallbacks:{},_POIsDescriptionMap:null,_POIsIdInstancingIndexMap:null,_pushPinNodeColorMap:null,_selectedPushpinCanvasNodeColorMap:null,_highlightedPushPinNode:null,_POIsKPIUserQueueCallbacks:{},_pois:[],initExternalKPIController:function(){return new Promise(function(o){if(this._context.isInterwidgetComAvailable()&&!this._externalKPICommandProxy){this._viewer=this._context.getViewer();this._decorationBag=this.getDecorationBag();this._layers=new Map();this._colorDescriptionMap=new Map();this._POIsDescriptionMap={};this._POIsIdInstancingIndexMap=new Map();this._pushPinNodeColorMap=new Map();this._selectedPushpinCanvasNodeColorMap=new Map();this.poiToLoad=[];this.max_path=5000;this._matrices=[];this._colors=[];require(["DS/PADUtils/PADCommandProxy"],function(q){var p=this;this._externalKPICommandProxy=q.create({events:{onEnrichWithKPI:function(r){this.enrichWithKPI(r)}.bind(this)}});c.onPostAdd(this._drawHighlight.bind(this));c.onEmpty(this._drawHighlight.bind(this));c.onPostRemove(this._drawHighlight.bind(this));this.subscribe({event:"onEndRootRemoved"},function(){this.resetPOIs();this.resetGraphicProperties();this._shareSessionContent()}.bind(this));this.subscribe({event:"onComplete"},function(r){if(r.intend==="addRoot"){this.resetPOIs();this.resetGraphicProperties();this._shareSessionContent()}}.bind(this));o()}.bind(this))}else{o()}}.bind(this))},destroyExternalKPIController:function(){if(this._viewer){delete this._viewer}if(this._externalKPICommandProxy){this._externalKPICommandProxy.destroy();delete this._externalKPICommandProxy}this._layers.clear();delete this._layers;this._layerController.destroy();delete this._layerController;if(this._colorKPIUserQueueCallbacks&&this._model){this._model.disableProgressiveBI(this._colorKPIUserQueueCallbacks);delete this._colorKPIUserQueueCallbacks}this._parent()},enrichWithKPI:function(o){this.resetGraphicProperties();this.resetPOIs();if(o.graphicProperties){this.applyGraphicProperties(o.graphicProperties)}if(o.pointOfInterest){this.drawPOIs(o.pointOfInterest)}},isKPIActivated:function(){return this._activeKPI},_shareSessionContent:function(){var o=this.getRoots();var q=[];var p=0;for(p=0;p<o.length;p++){q.push(b.getNodeID(o[p]))}var r={widgetId:f.getWidgetId(),rootIds:q};this._externalKPICommandProxy.sessionContent(r)},applyGraphicProperties:function(s){if(s.colorMap.length){var o=this._layerController.createLayer({label:s.label!==undefined?s.label:"KPI colors"});this._layers.set("KPIs",o);this._activeKPI=true;this._convertColorMap(s.colorMap);if(k.getSetting("enopad3dviewer_lightNodeModel")===true){var r=false;var q=this;this._colorKPIUserQueueCallbacks={handleReferences:function(v,u){r=true;var t=0;for(t=0;t<v.length;t++){var x=v[t];var w=q._colorDescriptionMap.get(x);if(w){o.getOverrideSet().setOverrideCB(x,q._applyOverride.bind(q))}}this.done(v,[],u)},getBatchSize:function(){return 1000},isReady:function(){return r===false},getParams:function(){return{addLeaves:true,addIntermediateNodes:true}},done:function(t,v,u){r=false;u.doneCB(t,v)},onFailure:function(t){console.log(t)}};this._model.enableProgressiveBI(this._colorKPIUserQueueCallbacks)}else{var p=this.getRootBag();this._colorDescriptionMap.forEach(function(A,z){var w=this.getNode({id:z});if(w){var y=a.buildPathesLeadingToNode(w,p);var t=A.color;var u=A.opacity;var x=A.forceInherit;var v=o.getOverrideSet().createOverride(y);v.setOpacity(u,x);v.setColor(t,x)}}.bind(this));o.show()}this._viewer.render()}},resetGraphicProperties:function(){if(k.getSetting("enopad3dviewer_lightNodeModel")){this._model.disableProgressiveBI(this._colorKPIUserQueueCallbacks)}var o=this._layers.get("KPIs");if(o){this._layerController.deleteLayer(o);this._layers["delete"]("KPIs")}this._viewer.setOIT(false);this._activeKPI=false;this._colorDescriptionMap.clear();this._viewer.render()},streamPOI:function(o,p){var q=o.instanceId;if(q===undefined){var r=this._POIsIdInstancingIndexMap.get(q);p.push(r)}},unstreamPOI:function(r){var o=[],q=this;var p=this.getPOINodeInstanceId(r);if(this._layers.get("POIs").getNode3DBag().children[0]){p.forEach(function(t){var s=new e();s.setFromArray([q._decorationBag,q._layers.get("POIs").getNode3DBag().children[0]]);s.instanceId=t;o.push(s)})}return o},getPOINodeInstanceId:function(p){var o=[];if(p){this._POIsIdInstancingIndexMap.forEach(function(r,q){if(r===p){o.push(q)}})}return o},drawPOIs:function(s){if(s.pointMap.length){this._activeKPI=true;this._convertPointMap(s.pointMap);this._pushPinNodeColorMap=new Map();var q=this._layerController.createLayer({label:s.label!==undefined?s.label:"POIs"});this._layers.set("POIs",q);if(k.getSetting("enopad3dviewer_lightNodeModel")===true){var o=this._POIsDescriptionMap.referencePOIs;o.forEach(function(v,u){this._drawPOIWithDynamicLoading(v)}.bind(this));var r=this._POIsDescriptionMap.pathPOIs;r.forEach(function(v,u){this._drawPOIWithDynamicLoading(v)}.bind(this));if(this.poiToLoad.length>0){while(this.poiToLoad.length>this.max_path){this._loadPOI(this.poiToLoad.slice(0,this.max_path));this.poiToLoad=this.poiToLoad.slice(this.max_path)}this._loadPOI(this.poiToLoad)}}else{var o=this._POIsDescriptionMap.referencePOIs;o.forEach(function(v,u){this._drawPOI(v)}.bind(this));var r=this._POIsDescriptionMap.pathPOIs;r.forEach(function(v,u){this._drawPOI(v)}.bind(this))}var p=0;var t=this._POIsDescriptionMap.positionPOIs;for(p=0;p<t.length;p++){this._drawPOI(t[p])}this._drawPOINodes(this._pois);q.show()}},resetPOIs:function(){var o=this._layers.get("POIs");if(o){this._layerController.deleteLayer(o);this._layers["delete"]("POIs")}this._POIsIdInstancingIndexMap.clear();this._model.disableProgressiveBI(this._POIsKPIUserQueueCallbacks);this._POIsDescriptionMap={};this._pois=[];this._pushPinNodeColorMap.clear();this._activeKPI=false;this._viewer.render()},_convertColorMap:function(o){this._colorDescriptionMap=new Map();var p=0;for(p=0;p<o.length;p++){this._colorDescriptionMap.set(o[p].resourceid,{color:o[p].color!==undefined?o[p].color:"#FFFFFF",opacity:o[p].opacity!==undefined?o[p].opacity:1,forceInherit:o[p].forceInherit!==undefined?o[p].forceInherit:true})}},_applyOverride:function(r,q){var t=this._colorDescriptionMap.get(r);if(t){var o=t.color;var p=t.opacity;var s=t.forceInherit;q.setOpacity(p,s);q.setColor(o,s)}},_applyKPIsOnNewNodes:function(v){if(this.isKPIActivated()){var w=0;var p=this.getRootBag();var x=this._layers.get("KPIs");for(w=0;w<v.newNodes.length;w++){var r=v.newNodes[w];var t=this._colorDescriptionMap.get(r);if(t){if(k.getSetting("enopad3dviewer_lightNodeModel")){x.getOverrideSet().setOverrideCB(r,that._applyOverride.bind(that))}else{var s=this.getNode({id:r});if(s){var z=a.buildPathesLeadingToNode(s,p);var u=t.color;var y=t.opacity;var o=t.forceInherit;var q=x.getOverrideSet().createOverride(z);q.setOpacity(y,o);q.setColor(u,o)}}}}if(!k.getSetting("enopad3dviewer_lightNodeModel")){x.show()}}},_convertPointMap:function(p){this._POIsDescriptionMap={positionPOIs:[],referencePOIs:new Map(),pathPOIs:new Map(),};var q=0;for(q=0;q<p.length;q++){var o=p[q];if(o.resourceid&&this.getNode({id:o.resourceid})){this._POIsDescriptionMap.referencePOIs.set(o.resourceid,{id:o.id,resourceid:o.resourceid,color:o.color!==undefined?o.color:"#EA4F37"})}else{if(o.path&&this.getNode({id:o.path[o.path.length-1]})){this._POIsDescriptionMap.pathPOIs.set(o.path[o.path.length-1],{id:o.id,path:o.path,color:o.color!==undefined?o.color:"#EA4F37"})}else{if(o.position){this._POIsDescriptionMap.positionPOIs.push({id:o.id,position:o.position,color:o.color!==undefined?o.color:"#EA4F37"})}}}}},_drawPOINodes:function(s){var q=this;this._pois.forEach(function(t){q._colors.push(new n.Color(t.color));q._matrices.push(new n.Matrix4().setPosition(new n.Vector3(t.position.x,t.position.y,t.position.z)))});var p=new j({pois:s,colors:q._colors,matrices:q._matrices}).render();var r=new l();r.className="PAD3DPOINode";r.addChild(p);this._layers.get("POIs").getNode3DBag().addChild(r);for(var o=0;o<s.length;o++){this._POIsIdInstancingIndexMap.set((o+1)*5,s[o].id)}},_drawPOI:function(v){if(v.resourceid){var t=this.getNode({id:v.resourceid});if(t){var u=a.buildPathesLeadingToNode(t,this.getRootBag());for(var r=0;r<u.length;r++){var s=u[r];var q=s.getWorldMatrix();var o=s.getLastElement(true).getBoundingSphere().center;o.applyProjection(q);if(o){var p={id:v.id,resourceid:v.resourceid,color:v.color,position:o,};this._pois.push(p)}}}}else{if(v.path){var s=this.buildPathFromArray(v.path);if(s){var q=s.getWorldMatrix();var o=s.getLastElement(true).getBoundingSphere().center;o.applyProjection(q);if(o){v.position=o;this._pois.push(v)}}}else{if(v.position){this._pois.push(v)}}}},_drawPOIWithDynamicLoading:function(o){if(o!==undefined&&o.resourceid){if(this._model.getOOCManager().isRegistered(o.resourceid)){var q=this._model.getOOCReference(o.resourceid);if(q){var s=q.getBoundingBox();var r=new n.Vector3((s.min.x+s.max.x)/2,(s.min.y+s.max.y)/2,(s.min.z+s.max.z)/2);var p=q.getOccurrences();for(var t=0;t<p.length;t++){var w=p[t];var v=this._model.getWorldMatrix(w.getIdPath());var u=r.clone();u.applyProjection(v);if(u){var x={id:o.id,resourceid:o.resourceid,color:o.color,position:u,};this._pois.push(x)}}}}else{this.poiToLoad.push(o.resourceid)}}else{if(o!==undefined&&o.path){if(this._model.getOOCManager().isRegistered(o.path[o.path.length-1])){var q=this._model.getOOCReference(o.path[o.path.length-1]);if(q){var s=q.getBoundingBox();var v=this._model.getWorldMatrix(o.path);var u=new n.Vector3((s.min.x+s.max.x)/2,(s.min.y+s.max.y)/2,(s.min.z+s.max.z)/2);u.applyProjection(v);if(u){o.position=u;this._pois.push(o)}}}else{this.poiToLoad.push(o.path[o.path.length-1])}}else{if(o!==undefined&&o.position){this._pois.push(o)}}}},_drawHighlight:function(){if(this._POIsIdInstancingIndexMap&&this._POIsIdInstancingIndexMap.size){this._selectedPushpinCanvasNodeColorMap.forEach(function(w,v){this._colors[v/5-1]=w}.bind(this));if(this._selectedPushpinCanvasNodeColorMap.size>0){this._layers.get("POIs").getNode3DBag().children[0].children[0].setInstancingParams({nbInstances:this._pois.length,matrices:this._matrices,colors:this._colors})}this._selectedPushpinCanvasNodeColorMap.clear();var o=c.get();var t=[],s=this;for(var q=0;q<o.length;q++){var u=o[q].pathElement.externalPath;for(var p=0;p<u.length;p++){if(u[p].className==="PAD3DPOINode"){var r=o[q].pathElement.instanceId;if(r){if(o[q].event===undefined){t=this.getPOINodeInstanceId(this._POIsIdInstancingIndexMap.get(r))}else{t.push(r)}t.forEach(function(v){s._selectedPushpinCanvasNodeColorMap.set(v,s._colors[v/5-1]);s._colors[v/5-1]=new n.Color("#368EC4")})}}}}if(this._selectedPushpinCanvasNodeColorMap.size>0){this._layers.get("POIs").getNode3DBag().children[0].children[0].setInstancingParams({nbInstances:this._pois.length,matrices:this._matrices,colors:this._colors})}this._viewer.render()}},_loadPOI:function(u){if(u.length>0){var p=this.getRoots();var s=this;var t=h.getPromises().slice();var q=[];var o=u;if(p.length>0){for(var r=0;r<p.length;r++){h.createPromise(function(x,w){var v={cancelable:false,forceIndex:true,find_in_context_physicalid:o,path:[b.getNodeID(p[r])],parent:s._model.getRootBag(),sequence_filter:s._model.getRoot({id:b.getNodeID(p[r])}).getSequenceFilter(),configBin:s._model.getRoot({id:b.getNodeID(p[r])}).getConfigFilter(),CVQuery3D:s._model.getRoot({id:b.getNodeID(p[r])}).getCVFilterQuery(),resolve:x,intent:"searchInDsBoard",progressiveExpand:false,expand_iter:"-1",forceLoad:false,max_count_path:(s.max_path*10).toString(),onComplete:function(z){for(var y=0;y<z.selectedPaths.length;y++){if(s._POIsDescriptionMap.referencePOIs.get(z.selectedPaths[y][z.selectedPaths[y].length-1])!==undefined){s._drawPOIWithDynamicLoading(s._POIsDescriptionMap.referencePOIs.get(z.selectedPaths[y][z.selectedPaths[y].length-1]))}if(s._POIsDescriptionMap.pathPOIs.get(z.selectedPaths[y][z.selectedPaths[y].length-1])!==undefined){s._drawPOIWithDynamicLoading(s._POIsDescriptionMap.pathPOIs.get(z.selectedPaths[y][z.selectedPaths[y].length-1]))}}if(x){x()}if(s._loadingQueue.length){s._processLoadingQueue()}else{s.publish({event:"onComplete",data:{reframe:false}})}},onFailure:function(y){s.publish({event:"onLoadPOIFailure",data:y});if(x){x()}if(s._loadingQueue.length){s._processLoadingQueue()}else{s.publish({event:"onComplete",data:{reframe:false}})}},onTimeout:function(y){s.publish({event:"onLoadPOIFailure",data:y});if(x){x()}if(s._loadingQueue.length){s._processLoadingQueue()}else{s.publish({event:"onComplete",data:{reframe:false}})}},};q.push(v)},"loadPOI")}}Promise.all(t).then(function(v){t=null;for(var w=0;w<q.length;w++){var x=q[w];s._loadingQueue.push(x)}s._processLoadingQueue()})}}});return d});define("DS/ENOPAD3DViewer/models/PAD3DLayer",["DS/ENOPAD3DViewer/views/PAD3DLayerView","DS/PADUtils/PADSettingsMgt","DS/Core/ModelEvents","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/3DXMTiles/OOCQuickOverrideSet","DS/Visualization/Node3D"],function(b,c,g,a,e,f){function d(h){this._view=null;this._node3DBag=null;this._overrideSet=null;this._uuid=h.UUID;this._overrideSetId=h.UUID;this._label=h.label;this._viewer=h.viewer;this._controller=h.controller;this._decorationBag=h.decorationBag;this._overrideSetManager=h.viewer.getSceneGraphOverrideSetManager();this._buildView(h);this._buildOverrideSet(h);this._buildNode(h);this._bindEvents()}d.prototype.getID=function(){return this._uuid};d.prototype.getOverrideSet=function(){return this._overrideSet};d.prototype.getOverrideSetID=function(){return this._overrideSetId};d.prototype.getNode3DBag=function(){return this._node3DBag};d.prototype.show=function(){this._addNodeBagToSG();this._pushOverrideSet()};d.prototype.hide=function(){this._removeNodeBagFromSG();this._removeOverrideSet()};d.prototype.render=function(){return this._view.render()};d.prototype.destroy=function(){this._removeOverrideSet();this._removeNodeBagFromSG();this._view.destroy();delete this._view;delete this._node3DBag;delete this._uuid;delete this._modelEvents;delete this._overrideSet;delete this._overrideSetManager;delete this._overrideSetId;delete this._controller;delete this._viewer};d.prototype.getModelEvents=function(h){return this._modelEvents};d.prototype.publish=function(h){this.getModelEvents().publish(h)};d.prototype.subscribe=function(h,i){return this.getModelEvents().subscribe(h,i)};d.prototype.unsubscribe=function(h){this.getModelEvents().unsubscribe(h)};d.prototype._buildView=function(){this._view=new b({label:this._label})};d.prototype._buildOverrideSet=function(h){if(c.getSetting("enopad3dviewer_lightNodeModel")){this._overrideSet=new e(h.controller._model.getOOCManager())}else{this._overrideSet=new a(h.rootBag)}this._pushOverrideSet()};d.prototype._buildNode=function(h){this._node3DBag=new f(h.root);this._addNodeBagToSG()};d.prototype._pushOverrideSet=function(){if(c.getSetting("enopad3dviewer_lightNodeModel")){this._overrideSet.setActive(true)}else{if(this._overrideSetManager&&this._overrideSet&&this._overrideSet.getOverrides().length){this._overrideSetManager.pushSceneGraphOverrideSet(this._overrideSet)}}this._viewer.render()};d.prototype._removeOverrideSet=function(){if(c.getSetting("enopad3dviewer_lightNodeModel")){this._overrideSet.setActive(false)}else{if(this._overrideSetManager&&this._overrideSet){this._overrideSetManager.removeSceneGraphOverrideSet(this._overrideSet)}}this._viewer.render()};d.prototype._addNodeBagToSG=function(){this._decorationBag.add(this._node3DBag)};d.prototype._removeNodeBagFromSG=function(){this._decorationBag.remove(this._node3DBag)};d.prototype._bindEvents=function(){this._modelEvents=new g();this._view.subscribe({event:"show"},function(){this.show();this.publish({event:"show",data:{id:this.getID(),layer:this}})}.bind(this));this._view.subscribe({event:"hide"},function(){this.hide();this.publish({event:"hide",data:{id:this.getID(),layer:this}})}.bind(this));this._view.subscribe({event:"delete"},function(){this.publish({event:"delete",data:{id:this.getID(),layer:this}})}.bind(this))};return d});define("DS/ENOPAD3DViewer/views/PAD3DFindInContextColorized",["DS/Core/ModelEvents","UWA/Class","DS/PADUtils/PADSettingsMgt","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(f,a,b,e,d){var c=a.extend({applyGraphicPropertiesForFindInCtx:function(k,l){var j=this;var h=this.getController()._layerController.createLayer({label:e.searchResults_FindInContext+'"'+l+'"'});if(b.getSetting("enopad3dviewer_lightNodeModel")===true){for(var g=0;g<k.length;g++){h.getOverrideSet().setOverrideCB(k[g][k[g].length-1],function(o,n){var i="#008000";var m=1;if(n){var p=true;n.setOpacity(m,p);n.setColor(i,p)}})}this.getRoots().forEach(function(i){h.getOverrideSet().setOverrideCB(d.getNodeID(i),function(o,n){var m=0.3;var p=false;if(n){n.setOpacity(m,p)}})})}else{k.forEach(function(q){var o=j.unstreamPath(q);var i="#008000";var m=1;var p=true;var n=h.getOverrideSet().createOverride(o);if(n){n.setOpacity(m,p);n.setColor(i,p)}});this.getRoots().forEach(function(i){var o=j.unstreamPath([d.getNodeID(i)]);var m=0.3;var p=false;var n=h.getOverrideSet().createOverride(o);if(n){n.setOpacity(m,p)}});h.show()}if(navigator.userAgent.match(/Android|iPhone|iPod|BlackBerry|Opera Mini|IEMobile/i)){if(this.getController().get3DLayerController().getLayerListView()._parentContainer.dockingElements&&this.getController().get3DLayerController().getLayerListView()._parentContainer.dockingElements[1]){this.getController().get3DLayerController().getLayerListView()._parentContainer.dockingElements[1].collapseDockingZoneFlag=true}}this.getViewer().render()},initFindInContextColorizedSubscription:function(){this.subscribe({event:"onEndRootRemoved"},function(){this.getController()._layerController.deleteLayers()}.bind(this));this.subscribe({event:"onComplete"},function(g){if(g.intend==="addRoot"){this.getController()._layerController.deleteLayers()}}.bind(this));this.subscribe({event:"onEndReparent"},function(){this.getController()._layerController.deleteLayers()}.bind(this));this.subscribe({event:"onEndReplaceInstance"},function(){this.getController()._layerController.deleteLayers()}.bind(this));this.subscribe({event:"onEndDelete"},function(){this.getController()._layerController.deleteLayers()}.bind(this));this.subscribe({event:"onInsertExisting"},function(){this.getController()._layerController.deleteLayers()}.bind(this))}});return c});define("DS/ENOPAD3DViewer/controller/PAD3DLayerController",["DS/ENOPAD3DViewer/views/PAD3DLayerWindow","DS/ENOPAD3DViewer/models/PAD3DLayer","DS/Utilities/UUID"],function(b,a,d){function c(e){this._layers=new Map();this._layerListView=null;this._rootBag=e.rootBag;this._decorationBag=e.decorationBag;this._viewer=e.viewer;this._parentContainer=e.renderTo;this._controller=e.controller;this._layerListView=new b({renderTo:this._parentContainer});this._layerListView.hide()}c.prototype.getLayer=function(e){return this._layers.get(e)};c.prototype.getLayers=function(){return this._layers};c.prototype.getLayerListView=function(){return this._layerListView};c.prototype.createLayer=function(e){var g=d.v4();var f=new a({UUID:g,label:e.label,rootBag:this._rootBag,decorationBag:this._decorationBag,viewer:this._viewer,controller:this._controller});this._bindEvents(f);this._layers.set(g,f);this._layerListView.appendChild(f.render());this._layerListView.show();return f};c.prototype.deleteLayer=function(g){var f=g.getID();var e=this._layers.get(f);if(e){this._layerListView.removeChild(e.render());this._layers["delete"](f);e.destroy()}if(this._layers.size===0){this._layerListView.hide()}};c.prototype.deleteLayers=function(){this._layers.forEach(function(e,f){this.deleteLayer(e)}.bind(this))};c.prototype.destroy=function(){this.deleteLayers();this._layers.clear();delete this._layers;this._layerListView.destroy();delete this._layerListView;delete this._rootBag;delete this._decorationBag;delete this._viewer;delete this._parentContainer;delete this._controller};c.prototype._bindEvents=function(e){e.subscribe({event:"delete"},function(f){this.deleteLayer(f.layer)}.bind(this));e.subscribe({event:"hide"},function(f){}.bind(this));e.subscribe({event:"show"},function(f){}.bind(this))};return c});define("DS/ENOPAD3DViewer/commands/PAD3DViewerDebugVisuCmd",["i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json","UWA/Core","UWA/Class","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADContext","DS/Controls/Button","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(d,e,a,f,g,h,b){var i="DS/ENOFloatingPanel/ENOFloatingPanel";var c=a.extend({init:function(j){this.context={};this.floatingpanel={};this.closeButton={}},execute:function(){this.context=g.get();var j=e.createElement("div",{});var k=e.createElement("div",{});this._build(j,k);require([i],function(l){this.floatingpanel=new l({body:j,footer:k,title:d.debugVisuTitle,overlay:true,closable:true,animate:true,resizable:true,visible:true,events:{onClose:function(){this.close()}.bind(this)}});this.floatingpanel.inject(document.body)}.bind(this))},_build:function(x,D){x.id="DebugVisuCmdPanel";x.style.width="100%";x.style.height="100%";x.style.display="flex";x.style.justifyContent="center";x.style.alignItems="center";x.style.flexDirection="column";var A={styles:{marginBottom:0}};var t=e.createElement("p",A).inject(x);var B=e.createElement("p",A).inject(x);var r=e.createElement("p",A).inject(x);var m=e.createElement("p",A).inject(x);var w=e.createElement("p",A).inject(x);var C=e.createElement("p",A).inject(x);var o=e.createElement("p",A).inject(x);var F=e.createElement("p",A).inject(x);var k=e.createElement("p",A).inject(x);var H=e.createElement("p",A).inject(x);var u=e.createElement("p",A).inject(x);var p=e.createElement("p",A).inject(x);var N=e.createElement("p",A).inject(x);var y=e.createElement("p",A).inject(x);var O=e.createElement("p",A).inject(x);var z=e.createElement("p",A).inject(x);this.closeButton=new h({label:d.close,emphasize:"primary",touchMode:true,}).inject(D);this.closeButton.elements.button.id="DebugVisuCmdCloseButton";this.close=this.close.bind(this);this.closeButton.addEventListener("click",this.close);var G=0;var J=0;var j=0;var v=0;if(f.getSetting("enopad3dviewer_lightNodeModel")===true){var q={};var n=function(S){for(var R=0;R<S.children.length;++R){if(S.children[R].children.length>0&&!q[S.children[R].modelIdentification]){if(b.isReference(S.children[R])){++v}else{if(b.isRepInstance(S.children[R])){++G}else{if(b.isInstance(S.children[R])){++J}else{if(b.isRepReference(S.children[R])){++j}}}}q[S.children[R].modelIdentification]=1;n(S.children[R])}else{return}}}.bind(this);var L=this.context.getController()._model._nodeIndex.rootBag;n(L)}else{var Q=function(T){var S=Object.getOwnPropertyNames(T);for(var R=0;R<S.length;R++){if(b.isReference(T[S[R]])){v++}else{if(b.isInstance(T[S[R]])){J++}else{if(b.isRepReference(T[S[R]])){j++}else{if(b.isRepInstance(T[S[R]])){G++}}}}}};var I=this.context.getController()._model._nodeIndex;Q(I)}var K=this.context.getViewer().getInfos();var P=K.memory,E=K.render;t.innerHTML=d.debugVisuRefAmount+"<b>"+v+"</b>";B.innerHTML=d.debugVisuInstAmount+"<b>"+J+"</b>";r.innerHTML=d.debugVisuRepRefAmount+"<b>"+j+"</b>";m.innerHTML=d.debugVisuRepInstAmount+"<b>"+G+"</b>";w.innerHTML=d.debugVisuTotalGeometryAmount+"<b>"+P.geometries+"</b>";C.innerHTML=d.debugVisunbSharedBufferAmount+"<b>"+P.sharedbuffers+"</b>";o.innerHTML=d.debugVisunbTexturesAmount+"<b>"+P.textures+"</b>";F.innerHTML=d.debugVisunbProgramsAmount+"<b>"+P.programs+"</b>";k.innerHTML=d.debugVisunbCallsAmount+"<b>"+E.calls+"</b>";H.innerHTML=d.debugVisunbFacesAmount+"<b>"+E.faces+"</b>";u.innerHTML=d.debugVisunbLinesAmount+"<b>"+E.lines+"</b>";p.innerHTML=d.debugVisunbMeshesAmount+"<b>"+E.meshes+"</b>";N.innerHTML=d.debugVisunbCulledMeshesAmount+"<b>"+E.culledMeshes+"</b>";y.innerHTML=d.debugVisunbCulledGeometriesAmount+"<b>"+E.culledGeometries+"</b>";O.innerHTML=d.debugVisunbCulledTrianglesAmount+"<b>"+E.culledDGTriangles+"</b>";z.innerHTML=d.debugVisunbCulledLinesAmount+"<b>"+E.culledDGLines+"</b>";var s={refCount:v,instCount:J,repRefCount:j,repInstCount:G,geometries:P.geometries,sharedBuffer:P.sharedbuffers,textures:P.textures,programs:P.programs,calls:E.calls,faces:E.faces,lines:E.lines,meshes:E.meshes,culledMeshes:E.culledMeshes,culledGeometries:E.culledGeometries,culledDGTriangles:E.culledDGTriangles,culledDGLines:E.culledDGLines};var M=(function(){var R=document.createElement("a");document.body.appendChild(R);if(/Edge/.test(navigator.userAgent)){R.style.display="none;"}else{if(/Firefox/.test(navigator.userAgent)||/Google Inc/.test(navigator.vendor)){R.style="display: none"}else{R.setAttribute("display","none")}}return function(S,U){if(!!document.documentMode){navigator.msSaveBlob(S,U)}else{var T=window.URL.createObjectURL(S);R.href=T;R.download=U;R.click();window.URL.revokeObjectURL(T)}}}());var l=new Blob([JSON.stringify(s,null,2)],{type:"application/json"});M(l,Date.now()+"-VisuDebugValues.json");M=null;l=null},close:function(){this.closeButton.removeEventListener("click",this.close);this.floatingpanel.destroy();this.destroy()},destroy:function(){delete this.context;delete this.floatingpanel;delete this.closeButton}});return c});define("DS/ENOPAD3DViewer/controller/PAD3DViewerController",["UWA/Core","UWA/Controls/Abstract","UWA/Promise","DS/Core/ModelEvents","DS/PADUtils/PADSettingsMgt","DS/PADUtils/PADWSAccess","DS/PADUtils/PADSession","DS/PADUtils/PADPromise","DS/PADUtils/views/PADAlert","DS/ENOPAD3DViewer/mixins/PAD3DViewerDECSpecificController","DS/ENOPAD3DViewer/mixins/_PAD3DViewerFilterController","DS/ENOPAD3DViewer/mixins/_PAD3DViewerBIController","DS/ENOPAD3DViewer/mixins/_PAD3DViewerExternalKPIController","DS/ENOPAD3DViewer/controller/PAD3DLayerController","DS/PADUtils/views/PADProgressBar","DS/Visualization/PathElement","DS/PADUtils/PADProbes","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json","i18n!DS/PADUtils/assets/nls/PADUtils.json","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/ENOPAD3DViewer/utils/PAD3DViewerVisuServices"],function(j,u,d,p,k,s,o,b,w,c,g,e,q,r,l,v,i,m,a,n,h){var f=1500;var t=u.extend(c,g,e,q,{name:"PAD3DViewerController",init:function(y){this._parent(y);this._model=null;this._modelEvents=null;this._commandProxy=null;this._rootIds=[];this._loadingQueue=[];this._operationInProgress=false;this._BIProxy=null;this._defaultStreamToLoad=null;this._stepcgrAvailableForRole=false;this._promises=[];this._runningQuery=null;this._useWrap=false;this._sessionCBTokens=[];this._configFilter=null;this._modelEvents=new p();this._querySuccess=true;this._engineState=1;this._initModel(y);this._setDefaultStreamToLoad(k.getSetting("enopad3dviewer_CGRorTHB"));var B=k.getWebAPI_Options("navigate3D");if(k.getSetting("supportPgpBasedOnDescription")){B.select_rel.push("ro.plminstance.V_description");k.setWebAPI_Options("navigate3D",B);k.setWebAPI_Options("volumeQuery",B)}var A=require("DS/PADUtils/PADUtilsServices");var z=this;A.getGrantedRoles(function(D){z._stepcgrAvailableForRole=false;for(var C=0;C<D.length;C++){if(D[C].id==="SXX"){z._stepcgrAvailableForRole=true;break}}if(z._stepcgrAvailableForRole){B.computeCGRsNThumbnails=["thumbnail_3d","stepcgr","cgr"];k.setWebAPI_Options("navigate3D",B);k.setWebAPI_Options("volumeQuery",B)}});this._context=y.context;this._BIProxy=y.BIProxy;this._initInterwidgetCom();this.setWrapUsage(k.getSetting("enopad3dviewer_navigate_with_wrap"));var x=k.getSetting("enopad_webapis");o.softInit(!x,!x);this._sessionCBTokens.push(o.subscribe({event:"authoringStateModified"},function(C){z.publish({event:"onAuthoringSwitch",data:{state:C.authored}})}));this._sessionCBTokens.push(o.subscribe({event:"useIndexPreferenceModified"},function(C){z.publish({event:"onIndexAvalabilityChange",data:{availability:C.useIndexPreference}})}));k.addEvent("onEnopad3dviewer_CGRorTHB",function(C){if(z){if(C===true){z._defaultStreamToLoad="cgr"}else{z._defaultStreamToLoad="thumbnail"}}})},destroy:function(){if(this._model){this._model.destroy();delete this._model}if(this._commandProxy){this._commandProxy.destroy();delete this._commandProxy}if(this._modelEvents){delete this._modelEvents}if(this._sessionCBTokens.length){for(var x=0;x<this._sessionCBTokens.length;x++){o.unsubscribe(this._sessionCBTokens[x])}this._sessionCBs=null}this.destroyBIController();this._rootIds=null;this._promises=null;this._BIProxy=null;this._parent()},_initInterwidgetCom:function(){var x=this;if(this._context.isInterwidgetComAvailable()){require(["DS/PADUtils/PADCommandProxy","DS/PADUtils/PADUtilsServices"],function(y,z){x._commandProxy=y.create({events:{onDrop:function(C){var D=require("DS/PADUtils/PADUtilsServices");D.updatePlatformId(C.tenant);if(C.pids||C.paths){x.addRoots(C,false)}else{if(C.rootsWithFilters){for(var B=0;B<C.rootsWithFilters.length;++B){var A=x.getRoot({id:C.rootsWithFilters[B].rootId});if(!A){x.applyFilter(C.rootsWithFilters[B].filter,false)}else{x.publish({event:"onRootAlreadyExisting"})}}}}},onRemove:function(A){x.removeRoots(A,false)},onDetach:function(A){x.detachRoots(A,false)},onAttach:function(A){x.attachRoots(A,false)},onCleanAll:function(){x.flushModel(false)},onPadRefresh:function(A){if(A.TitleInfo){x.publish({event:"onContentNameModified",data:{TitleInfo:A.TitleInfo}})}else{o.setAuthoringState(true,"PADSession_enabling_authored_mode",false);x._parseAuthoringTransaction(A)}},onReceiveFilterInfo:function(A){if(x._filterCalback){x._filterCalback(A);x._filterCalback=null;if(this._filterTimer){clearTimeout(this._filterTimer);this._filterTimer=null}}},onRefreshModel:function(){x.refresh(false)},onPadExpand:function(A){if(A===false){w.displayNotification({msg:a.find_in_context_no_result,eventID:"info"})}else{if(k.getSetting("enopad3dviewer_lightNodeModel")===true){x.unlockChildrenFromProgressiveExpand(A)}else{x.expand(A)}if(A.updatePager===true){x._context.updatePager=true;x._context.pagerData=A.paths}}},onUpdatePosMatrix:function(C){var B=[];if(C.instances){b.createPromise(function(E,D){C.instances.forEach(function(K){var F={elements:[]};var J=K.hasPositioningMatrix;F.elements[0]=parseFloat(J[0]);F.elements[1]=parseFloat(J[1]);F.elements[2]=parseFloat(J[2]);F.elements[3]=parseFloat(0);F.elements[4]=parseFloat(J[3]);F.elements[5]=parseFloat(J[4]);F.elements[6]=parseFloat(J[5]);F.elements[7]=parseFloat(0);F.elements[8]=parseFloat(J[6]);F.elements[9]=parseFloat(J[7]);F.elements[10]=parseFloat(J[8]);F.elements[11]=parseFloat(0);F.elements[12]=parseFloat(J[9]);F.elements[13]=parseFloat(J[10]);F.elements[14]=parseFloat(J[11]);F.elements[15]=parseFloat(1);var I={id:String(K.instance)},L={id:String(K.instance),matrix:F};var G=x._model.updateNode(I,L);if(G){var H=x.buildPathFromArray(K.nodePath);if(H){B.push(H)}}});E()},"posMatrixUpdate");var A=b.getPromises().slice();d.all(A).then(function(D){A=null;x.publish({event:"onEndMatriceUpdate",data:C})})}},onDisableFilterWaiting:x._disableFilterWaiting.bind(x),onSearchInApp:function(A){if(x.search){x.search({searchQuery:A.query})}}}})})}},onMove3D:function(x){this._commandProxy.update2DPosMatrix(x)},isFilterOpen:function(y){var x=this;this._filterCalback=y;this._commandProxy.sendFilterInfo();this._filterTimer=setTimeout(function(){if(x._filterCalback){var z={filterAvailable:false};x._filterCalback(z);x._filterCalback=null}},f)},_isAuthored:function(){return o.determineAuthoredFlag()},_initModel:function(y){var x=this;var z=function(){x.initFilterController().then(function(){x.initBIController();x.initExternalKPIController().then(function(){x._layerController=new r({renderTo:x._context.getFrameWindow().getImmersiveFrame(),rootBag:x.getRootBag(),decorationBag:x.getDecorationBag(),viewer:x._context.getViewer(),controller:x,});if(y.readyCB){y.readyCB()}})})};y.tileModel=y.tileModel===undefined?false:y.tileModel;if(k.getSetting("enopad3dviewer_lightNodeModel")===true){require(["DS/ENOPAD3DViewer/models/PAD3DViewerTileNodeModel"],function(A){x._model=new A({viewer:y.viewer,startLoadingCB:x._startProgressiveLoad.bind(x),endLoadingCB:x._endProgressiveLoad.bind(x),expandCB:function(D,C,B){x.expand(D,C,B)},getFcsUrlsCB:function(B){x.getFcsUrls(B)}});z();x._model.subscribe({event:"colorOverridePostProcess"},function(B){if(x.isColorizeActivated()){x.colorizeNewNodes(B)}});x._model.subscribe({event:"newNodes"},function(B){if(x.isKPIActivated()){x._applyKPIsOnNewNodes(B)}});x._model.subscribe({event:"onUrlLoaded"},function(B){x.publish({event:"onUrlLoaded",data:B})})})}else{require(["DS/ENOPAD3DViewer/models/PAD3DViewerNodeModel"],function(A){x._model=new A({viewer:y.viewer,startLoadingCB:x._startProgressiveLoad.bind(x),endLoadingCB:x._endProgressiveLoad.bind(x),getFcsUrlsCB:function(B){x.getFcsUrls(B)}});z();x._model.subscribe({event:"PGPPostProcess"},function(B){x.publish({event:"PGPPostProcess",data:B})});x._model.subscribe({event:"newNodes"},function(B){if(x.isKPIActivated()){x._applyKPIsOnNewNodes(B)}});x._model.subscribe({event:"onUrlLoaded"},function(B){x.publish({event:"onUrlLoaded",data:B})});x._model.subscribe({event:"onLeafReferenceLoaded"},function(B){x.publish({event:"onLeafReferenceLoaded",data:B})});x._model.subscribe({event:"onLeafReferenceUnloaded"},function(B){x.publish({event:"onLeafReferenceUnloaded",data:B})})})}},getHiddenRootIds:function(x){if(x!==undefined){return this._model.getHiddenRootIds(x)}else{return this._model.getHiddenRootIds()}},checkIfEmpty:function(){if(!this.getNbRoots()&&(!this.getHiddenRootIds().length)){this.publish({event:"onEmptyView"})}},_startAsync:function(x){this._operationInProgress=true;x=undefined===x?{}:x;this.publish({event:"startAsync",data:x})},_startProgressiveLoad:function(){this.publish({event:"onStartProgressiveLoad"})},_stopAsync:function(x){this._operationInProgress=false;this._runningQuery=null;this.publish({event:"stopAsync",data:x})},_endProgressiveLoad:function(x){this.publish({event:"onEndProgressiveLoad",data:x})},switchAuthoringMode:function(y,x,z){o.setAuthoringState(y,z,x)},_parseAuthoringTransaction:function(B){var A=this;var x=B.transactions;if(x){A.publish({event:"onAuthoringTransactionBegin"});for(var z=0;z<x.length;z++){var D=x[z];if(D.reParent){A.reparent(D.reParent)}else{if(D.insertExisting){if(D.insertExisting.inserted&&D.insertExisting.inserted.length>1){for(var y=0;y<D.insertExisting.inserted.length;y++){var E={created:[D.insertExisting.created[y]],inserted:[D.insertExisting.inserted[y]],modified:[D.insertExisting.modified[y]]};A.insertExisting(E)}}else{A.insertExisting(D.insertExisting)}}}}var C=b.getPromises().slice();d.all(C).then(function(){C=null;A.publish({event:"onAuthoringTransactionEnd"})})}else{if(B.detach){A.unparent(B.detach)}}},_processLoadingQueue:function(){if(!this.isRunning()){var x=this._loadingQueue.splice(0,1);if(x.length){this._load(x[0])}}},_load:function(Q){var W=this;Q.userFeedback=Q.userFeedback!==undefined?Q.userFeedback:true;var N=Q.reframe;var S=Q.path;var R=Q.paths;var O=Q.structure;var I=Q.configBin;var E=Q.sequence_filter;var U=Q.CVQuery3D;var x=Q.id;var H=Q.parent;var K=Q.hidden!==undefined?Q.hidden:false;var D=Q.forceIndex?Q.forceIndex:false;var ab=W._useWrap?(W._wait4Filter?"expand3D":"wrap"):"expand3D";var Z=parseInt(k.getSetting("webapi_timeout"));var X=Q.expand_iter!==undefined?Q.expand_iter:"-1";var ac=k.getSetting("enopad3dviewer_navigate_wrap_density")?k.getSetting("enopad3dviewer_navigate_wrap_density"):4;var P=j.clone(k.getWebAPI_Options("navigate3D"),true);var G={expand_iter:X,select_bo:P.select_bo,select_rel:P.select_rel,compute_select_bo:this.getDefaultStreamToLoad()==="thumbnail"?P.computeCGRsNThumbnails:P.computeCGRs,intent:"explore_3D",authored:W._isAuthored(),debug:k.getSetting("enopad_webapis_debug"),boundingbox:W._withBoundingBoxes(),fcs_url_mode:k.getSetting("enopad3dviewer_useStaticURL")?"REDIRECT":undefined,find_in_context:Q.findInCtx?[{"q.query":Q.findInCtx}]:undefined,find_in_context_physicalid:Q.find_in_context_physicalid?Q.find_in_context_physicalid:undefined,option:W._useWrap>0&&!Q.findInCtx?{density:!j.is(ac,"string")?ac.toString():ac}:undefined,config_filter:I!==undefined?I:undefined,sequence_filter:E!==undefined?E:undefined,max_count_path:Q.max_count_path?Q.max_count_path:undefined};if(k.getSetting("enopad3dviewer_lightNodeModel")===true){if(W.isColorizeActivated()&&W._colorMap){G.select_bo.push(W._colorMap.predicate);G.select_rel.push(W._colorMap.predicate)}G.nbchildren=true}var M=Q.progressiveExpand!==undefined?Q.progressiveExpand:k.getSetting("enopad3dviewer_lightNodeModel")===true&&!W._useWrap;if(M){ab="progressiveExpand";var J=this._context.getViewpointParameters();G.zoom="0.0";if(!k.getSetting("enopad3dviewer_useNewProgressiveExpandAPI")){var T=J.near.toFixed(0);var L=J.far.toFixed(0);var z=L.length-T.length;for(var ae=0;ae<z;ae++){T="0"+T}G.pass="0";G.zoom=L+"."+T}var af=h.convertExponentialToDecimal;G.screen_width_px=this._context.getViewer().SCREEN_WIDTH.toFixed(1);G.screen_height_px=this._context.getViewer().SCREEN_HEIGHT.toFixed(1);G.eye_position=[af(J.eye[0].x),af(J.eye[0].y),af(J.eye[0].z)];G.sight=[af(J.sight[0].x),af(J.sight[0].y),af(J.sight[0].z)];G.up=[af(J.up[0].x),af(J.up[0].y),JSON.stringify(J.up[0].z)];G.angle=J.fov.toFixed(1);G.near_plane=J.near.toFixed(1);G.far_plane=J.far.toFixed(1);G.pixel_culling=Q.pixelCulling!==undefined?""+Math.max(Q.pixelCulling,parseInt(k.getSetting("enopad3dviewer_pixelCulling_progressiveExpand"))):k.getSetting("enopad3dviewer_pixelCulling_progressiveExpand")}var ag="";var V=false;var ad=false;if(S){if(S.length>1){V=true}else{x=S[0]}}if(R){ad=true}if(V){G.root_path_physicalid=[S];G.rootPhID=S[0];ag=S[0]}else{if(ad){G.root_path_physicalid=R;G.rootPhID=R[0][0];ag=R[0][0]}else{G.root_physicalid=x;G.rootPhID=x;ag=x}}function y(){H=null;S=null;K=null;I=null;x=null;G=null;Q=null;W=null}if(U&&!W._isAuthored()){D=true;var aa=U;if(G.find_in_context){aa=W._context.getBIController()._BIProxy.completeCVQueryWithAppSpecs(U,{find_in_context:G.find_in_context},true)}var B=j.clone(aa,true);if(ab==="wrap"){if(B.union){B.union.wrap=B.union.expand3d;delete B.union.expand3d;B.union.wrap.forEach(function(ah){ah.option=G.option})}else{if(B.intersect){B.intersect.wrap=B.intersect.expand3d;delete B.intersect.expand3d;B.intersect.wrap.forEach(function(ah){ah.option=G.option})}else{if(B.minus){B.minus.wrap=B.minus.expand3d;delete B.minus.expand3d;B.minus.wrap.forEach(function(ah){ah.option=G.option})}}}}delete G.root_physicalid;delete G.root_path_physicalid;delete G.find_in_context;delete G.expand_iter;delete G.option;G=j.extend(G,B,true)}if(ad){this.navQueryProbe=i.createProbe("Expand"+X+" - "+R.length+" paths")}else{this.navQueryProbe=i.createProbe("navigateQuery")}var F=W;W._abortLoading=function(){F._interruptLoading(ag);F._stopAsync({userFeedback:Q.userFeedback});if(Q.onCancel){Q.onCancel()}y()};W._pauseLoading=function(){if(F._runningQuery){F._pauseQuery();F._stopAsync({userFeedback:Q.userFeedback});if(Q.onCancel){Q.onCancel()}y()}};W._startAsync(Q.cancelable===false?{userFeedback:Q.userFeedback}:{onCancel:W.abortLoading.bind(W),userFeedback:Q.userFeedback});W.publish({event:"onBeginRootLoading"});l.setText(m.queryRunning);function A(ai){W.navQueryProbe.end();delete W.navQueryProbe;var aq;try{aq=j.is(ai,"string")?JSON.parse(ai):ai}catch(ah){W._stopAsync({userFeedback:Q.userFeedback});if(Q.onFailure){Q.onFailure()}y();return}var am=aq.error?aq.error.errorCode:false;if(am==="CLOUDVIEW_ERROR__SUMMARY"){W._stopAsync({userFeedback:Q.userFeedback});var ap=false;var ak=false;if(!W._isAuthored()&&k.getSetting("enopad_webapis")){for(var aj=0;aj<aq.error.errors.length;aj++){if(aq.error.errors[aj].errorCode==="CLOUDVIEW_ERROR__INVALID_PATH_QUERY"||aq.error.errors[aj].errorCode==="CLOUDVIEW_ERROR__INVALID_ROOTS"){ap=true}else{if(aq.error.errors[aj].errorCode==="VOLUME_QUERIES_DISABLED"){ak=true}}}}if(ap){o.setAuthoringState(true,a.PADSession_disabling_index_object_not_found,true);W._load(Q)}else{if(ak){if(Q.CVQuery3D){W._operationInProgress=false;delete Q.CVQuery3D;Q.expand_iter="0";Q.progressiveExpand=false;Q.blockNbChildren=true;W._load(Q);W.publish({event:"onVQDisabled"})}}else{if(Q.onFailure){var al={filterMessage:a.cannot_insert_branch};Q.onFailure(al,null,null)}}}y();return}if(aq.authoringMode&&aq.authoringMode===true){o.setAuthoringState(true,"PADSession_disabling_index_from_server",true)}l.setText(m.parsingResponse);if(!aq.results||aq.results.length===0||!W.isRunning()||(aq.results.length===1&&typeof aq.results[0].status!=="undefined")){if(Q.findInCtx){W._stopAsync({userFeedback:Q.userFeedback});if(Q.onComplete){var an=aq.results&&aq.results.length===1&&typeof aq.results[0].status!=="undefined"?aq.results[0].status:undefined;Q.onComplete({tooManyPath:an});y()}}else{if(Q.sequence_filter||Q.CVQuery3D){W._stopAsync({userFeedback:Q.userFeedback});var ao={filterMessage:a.sequence_filter_error,display:true,eventID:"info"};if(Q.CVQuery3D){Q.CVQuery3DToStoreOnObject=Q.CVQuery3D;delete Q.CVQuery3D;Q.expand_iter="0";Q.progressiveExpand=false;Q.blockNbChildren=true;W._loadingQueue.push(Q);W._operationInProgress=false}if(Q.onFailure){Q.onFailure(ao);y()}}else{if(M){W._stopAsync({userFeedback:Q.userFeedback});if(Q.onFailure){Q.onFailure();y()}}else{W._stopAsync({userFeedback:Q.userFeedback});if(!W._isAuthored()&&k.getSetting("enopad_webapis")){o.setAuthoringState(true,a.PADSession_disabling_index_object_not_found,true);W._load(Q)}else{if(Q.onFailure){Q.onFailure(ai);y()}}}}}}else{W._model.buildFromJSON({rootIds:[ag],json:aq,reframe:N,parent:H,hidden:K,forceLoad:Q.forceLoad,partialOpen:S!==undefined&&S.length>1?true:false,partialOpenPath:S!==undefined&&S.length>1?S:null,progressiveExpand:M,expand3DType:ab,streamToLoad:W.getDefaultStreamToLoad(),nbRoot:W.getNbRoots(),intent:Q.intent,blockNbChildren:Q.blockNbChildren,extraAttribute:W._colorMap?W._colorMap.predicate:undefined,callbacks:{onCGRLoad:function(ar){if(Q&&Q.onProgress){Q.onProgress(ar)}},onReframe:function(ar){W.publish({event:"onReframe",data:ar})},onComplete:function(at){if(W){W._stopAsync({userFeedback:Q.userFeedback});var ar=W.getRoot({id:ag});if(ar){if(n.isPLMNode(ar)){Q.CVQuery3D=Q.CVQuery3D||Q.CVQuery3DToStoreOnObject;if(Q.configBin){ar.setConfigFilter(I)}else{ar.setConfigFilter(undefined)}if(Q.sequence_filter){ar.setSequenceFilter(E)}else{ar.setSequenceFilter(undefined)}if(Q.CVQuery3D){ar.setCVFilterQuery(Q.CVQuery3D)}else{ar.setCVFilterQuery(undefined)}}else{if(!ad){}}if(Q.onComplete){Q.onComplete(at)}}else{if(Q.onFailure){Q.onFailure()}}aq=null;y()}}}})}}var C=!W._useWrap&&!D?k.getSetting("enopad_webapis"):false;if(!O){var Y={enopad_webapis:C,data:G,expand3DType:ab,timeout:Z,onComplete:A,onCancel:!Q.userFeedback?(Q.onCancel?Q.onCancel:undefined):undefined,onFailure:function(al,ah,aj){W.navQueryProbe.end();delete W.navQueryProbe;var ai;try{ai=j.is(ah,"string")?JSON.parse(ah):ah;W._stopAsync({userFeedback:Q.userFeedback});if(!W._isAuthored()&&ai&&ai.error&&(ai.error.errorCode==="CLOUDVIEW_ERROR__INVALID_ROOT"||ai.error.errorMessage.search("No input query root")!==-1)){o.setAuthoringState(true,a.PADSession_disabling_index_object_not_found,true);W._load(Q)}else{if(Q.onFailure){Q.onFailure(al,ah,aj)}}y()}catch(ak){W._stopAsync({userFeedback:Q.userFeedback});if(Q.onFailure){Q.onFailure(al,null,aj)}y()}},onTimeout:function(){W.navQueryProbe.end();delete W.navQueryProbe;W._stopAsync({userFeedback:Q.userFeedback});if(Q.onTimeout){Q.onTimeout()}y()}};if(U&&ab!=="progressiveExpand"){delete Y.data.rootPhID;W._runningQuery=s.multiexpand(Y)}else{if(ab==="progressiveExpand"&&k.getSetting("enopad3dviewer_useNewProgressiveExpandAPI")){Y.FBIProxy=this._BIProxy._biFilter;W._runningQuery=s.progressiveExpand(Y)}else{delete Y.data.rootPhID;W._runningQuery=s.navigate(Y)}}}else{A(O)}},getAttributes:function(C){if(!j.is(C,"object")){throw new Error("No parameter defined")}if(!j.is(C.ids,"array")){throw new Error("No input ids defined")}if(!j.is(C.attributes,"array")){throw new Error("No attributes to load defined")}if(!j.is(C.callbacks,"object")){throw new Error("No callbacks function defined")}if(!j.is(C.callbacks.onComplete,"function")){throw new Error("No onComplete callback function defined")}if(!j.is(C.callbacks.onFailure,"function")){throw new Error("No onFailure callback function defined")}var B=this;var x=[];var A=[];for(var y=0;y<C.attributes.length;y++){var z=C.attributes[y];switch(z){case"type_icon_url":x.push("icon");break;case"cgr":if(B._stepcgrAvailableForRole){x.push("stepcgr")}x.push(z);x.push("assembly_cgr");break;case"thumbnail_3d":x.push(z);break;case"svg":x.push(z);break;default:A.push(z);break}}s.fetch({enopad_webapis:k.getSetting("enopad_webapis"),pids:C.ids,data:{authored:C.authored?C.authored:B._isAuthored(),intent:"fetch_3D",select_file:x.length?x:undefined,select_predicate:A.length?A:undefined,fcs_url_mode:k.getSetting("enopad3dviewer_useStaticURL")?"REDIRECT":undefined},onComplete:function(H){var L=j.is(H,"string")?JSON.parse(H):H;if(!L.results||L.results.length===0){var K=new Error("Cannot find object with the physicalid "+C.ids);C.callbacks.onFailure(K);throw K}if(L.results.length!==C.ids.length){console.warn("Warning : some results are missing from input")}var M={};for(var I=0;I<L.results.length;I++){var E=L.results[I];if(E.attributes!==undefined){var J=null,G={};for(var F=0;F<E.attributes.length;F++){var D=E.attributes[F];if(D.name==="resourceid"){J=D.value}else{if(D.name==="assembly_cgr"){G.cgr=D.value}else{if(!G[D.name]){G[D.name]=D.value}}}}if(G.stepcgr){G.cgr=G.stepcgr;delete G.stepcgr}M[J]=G}}C.callbacks.onComplete(M)},onFailure:function(F,D,E){C.callbacks.onFailure(F)}})},addFilter:function(x){this._commandProxy.addFilter(x)},volumeQueryFilter:function(D,x,E){var C=this;var z=(D.completion)?D.completion:false;var B=C.getRootBag();var A=parseInt(k.getSetting("webapi_timeout"));var y={enopad_webapis:false,data:D.data,timeout:A,onComplete:function(N){var S;try{S=j.is(N,"string")?JSON.parse(N):N}catch(K){C.publish({event:"onLoadingFailure",data:{message:m.cannotParseQueryResult}});D.callbacks.onFailure(K);E();return}var Q=S.error?S.error.errorCode:false;if(Q==="CLOUDVIEW_ERROR__SUMMARY"){D.callbacks.onFailure({errors:S.error.errors});E();return}else{if(z){C._model.buildFromJSON({rootIds:D.rootIds,json:S,parent:B,hidden:false,forceLoad:true,streamToLoad:C.getDefaultStreamToLoad(),nbRoot:C.getNbRoots(),callbacks:{onCGRLoad:function(U){C.nbCGRToLoad=U.nbCGRToLoad;C.publish({event:"onProgress",data:{progress:Math.floor((U.nbCGRLoaded/U.nbCGRToLoad)*100),message:m.displaying3D+": "+U.nbCGRLoaded+" of "+U.nbCGRToLoad+" "+m.parts,reframe:false}})},onComplete:function(U){if(U.createdPaths){x.createdPaths=x.createdPaths.concat(U.createdPaths)}if(U.selectedPaths){x.selectedPaths=x.selectedPaths.concat(U.selectedPaths)}E()}}})}else{var T=[];l.setText(m.parsingResponse);var J={};for(var O=0;O<S.results.length;O++){var L=S.results[O];if(L.attributes!==undefined){var R="",P="";for(var M=0;M<L.attributes.length;M++){var I=L.attributes[M];if(I.name==="did"){R=I.value}else{if(I.name==="physicalid"){P=I.value}}}J[R]=P}if(L.path!==undefined){var F=[];for(var M=0;M<L.path.length;M++){var H=J[L.path[M].toString()];if(H){F.push(H)}}if(F.length){var G=C.buildPathFromArray(F);if(G){T.push(G)}}}}if(N.selectedPaths){x.selectedPaths=x.selectedPaths.concat(N.selectedPaths)}E()}}},onFailure:function(H,F,G){C._stopAsync();C._querySuccess=false;D.callbacks.onFailure(H,F,G);E()}};if(k.getSetting("enopad3dviewer_lightNodeModel")===true){y.nbchildren=true}if(D.data.union||D.data.intersect||D.data.minus){s.multiexpand(y)}else{s.volumeQuery(y)}},volumeQuery:function(H){if(!j.is(H,"object")){throw new Error("No parameter defined")}if(!j.is(H.data,"object")){throw new Error("No input data defined")}if(!j.is(H.callbacks,"object")){throw new Error("No callbacks function defined")}if(!j.is(H.callbacks.onComplete,"function")){throw new Error("No onComplete callback function defined")}if(!j.is(H.callbacks.onFailure,"function")){throw new Error("No onFailure callback function defined")}var C=this;C._startAsync();this._filterCheckPromise=[];var F=C.getRootBag();var x=[];var D=[];var B=j.clone(k.getWebAPI_Options("navigate3D"),true);H.data.boundingbox=H.data.boundingbox===undefined?C._withBoundingBoxes():H.data.boundingbox;H.data.select_bo=H.data.select_bo===undefined?B.select_bo:H.data.select_bo;H.data.select_rel=H.data.select_rel===undefined?B.select_rel:H.data.select_rel;H.data.compute_select_bo=H.data.compute_select_bo===undefined?this.getDefaultStreamToLoad()==="thumbnail"?B.computeCGRsNThumbnails:B.computeCGRs:H.data.compute_select_bo;if(k.getSetting("enopad3dviewer_lightNodeModel")===true){H.data.nbchildren=true}var y=[];for(var A=0;A<H.data.root_path_physicalid.length;A++){y.push(H.data.root_path_physicalid[A][0])}if(y){l.setText(m.queryRunning);y.forEach(function(J){var K=C.getRoot({id:J});if(K.getConfigFilter()!==undefined||K.getSequenceFilter()!==undefined||K.getCVFilterQuery(C._BIProxy,"V1")!==undefined){x.push(K)}else{D.push(J)}});var G={createdPaths:[],selectedPaths:[]};var z=[];if(x.length>0){var I=j.clone(H,true);x.forEach(function(L){I.data.config_filter=L.getConfigFilter();I.data.sequence_filter=L.getSequenceFilter();var K=L.getCVFilterQuery(C._BIProxy,"V1");if(K){var J=C._BIProxy.completeCVQueryWithAppSpecs(K,{volume_filter:I.data.volume_filter},true);delete I.data.volume_filter;delete I.data.root_path_physicalid;I.data=j.extend(I.data,J)}else{if(I.data.config_filter&&I.data.volume_filter&&I.data.volume_filter.assemblyshape){I.data.volume_filter.assemblyshape.config_filter=I.data.config_filter}}I.rootIds=[L];C._filterCheckPromise.push(b.createPromise(function(M){C.volumeQueryFilter(I,G,M)},"filterCheckPromise"))})}if(D.length>0){C._filterCheckPromise.push(b.createPromise(function(M){var J=j.clone(H,true);var L=[];for(var K=0;K<D.length;K++){L.push([D[K]])}J.data.root_path_physicalid=L;J.rootIds=D;C.volumeQueryFilter(J,G,M)},"filterCheckPromise"))}var E=b.getPromises().slice();if(C._filterCheckPromise){d.all(E).then(function(){E=null;H.callbacks.onComplete({createdPaths:G.createdPaths,selectedPaths:G.selectedPaths,querySuccess:C._querySuccess});C._stopAsync();if(G.createdPaths.length){C.publish({event:"onCompletionCompleted",data:{nbPathLoaded:G.createdPaths.length,rootNodes:[C.getNode({id:G.createdPaths[0][1]})],reframe:false}})}delete C._filterCheckPromise})}}},switchNodeVisuStreamOnDemand:function(B){if(!j.is(B,"object")){throw new Error("No parameter defined")}if(!j.is(B.data,"array")){throw new Error("No input data defined")}var A=this,z=[];var y=B.data[0].stream==="thumbnail"?"thumbnail_3d":"cgr";var D=function(G,I,F,H){b.createPromise(function(K,J){A.getAttributes({ids:G,attributes:[F],callbacks:{onComplete:function(L){for(var M=0;M<G.length;M++){H.data.push({node:I[M].node,stream:I[M].stream,url:L[G[M]][F]})}K()},onFailure:function(L){A._stopAsync();A.publish({event:"onStreamSwitchFailure"});if(H.callbacks&&H.callbacks.onFailure){H.callbacks.onFailure(L)}if(K){K()}}}})},"switchNodeVisuStreamOnDemand")};var E={};E.applicativeContainers=B.applicativeContainers;E.noMeshInRAM=B.noMeshInRAM;E.callbacks=B.callbacks;E.data=[];A._startAsync();for(var x=0;x<B.data.length;x++){z.push(n.getNodeID(B.data[x].node))}if(z.length>0){while(z.length>1000){D(z.slice(0,1000),B.data.slice(0,1000),y,E);z=z.slice(1000);B.data=B.data.slice(1000)}D(z,B.data,y,E)}var C=b.getPromises().slice();d.all(C).then(function(F){C=null;A._model.switchNodeVisuStreamOnDemand({data:E.data,noMeshInRAM:undefined===E.noMeshInRAM?true:E.noMeshInRAM,applicativeContainers:undefined===E.applicativeContainers?undefined:E.applicativeContainers,callbacks:{onURLLoad:function(G){A.publish({event:"onProgress",data:{progress:Math.floor((G.nbURLLoaded/G.nbURLToLoad)*100),message:m.displaying3D+": "+G.nbURLLoaded+" of "+G.nbURLToLoad+" "+m.parts,reframe:false}})},onComplete:function(G){A._stopAsync();if(A._loadingQueue.length){A._processLoadingQueue()}A.publish({event:"onStreamSwitched"});if(E.callbacks&&E.callbacks.onComplete){E.callbacks.onComplete(G)}}}})})},expand:function(G,C,B,H){B=B===undefined?true:B;H=H===undefined?false:H;if(!j.is(G,"object")){throw new Error("No parameter defined")}if(G.paths===undefined){console.error("No paths array defined");return}if(G.reframe){H=G.reframe}G.singleAdd=G.singleAdd===undefined?true:G.singleAdd;var A=this;var F=[];var E=b.getPromises().slice();if(G.singleAdd){for(var z=0;z<G.paths.length;z++){var y=G.paths[z];b.createPromise(function(M,L){var K=y[0];var I=A.getNode({id:j.is(K,"array")?K[0]:K});if(I){var J={cancelable:false,path:y,parent:A.getRootBag(),hidden:false,intent:G.intent,progressiveExpand:G.progressiveExpand,expand_iter:G.expand_iter,forceLoad:G.forceLoad,sequence_filter:I.getSequenceFilter&&I.getSequenceFilter()?I.getSequenceFilter():undefined,configBin:I.getConfigFilter&&I.getConfigFilter()?I.getConfigFilter():undefined,CVQuery3D:I.getCVFilterQuery&&I.getCVFilterQuery(A._BIProxy,"V1")?I.getCVFilterQuery(A._BIProxy,"V1"):undefined,resolve:M,onComplete:function(Q){var O=new v();O.addElement(A.getRootBag());for(var N=0;N<y.length-1;N++){var P=A.getNode({id:y[N]});if(P){O.addElement(P)}}A.publish({event:"onExpandCompleted",data:{path:O,rootNodes:I,displayNotif:B}});if(M){M()}if(A._loadingQueue.length){A._processLoadingQueue()}else{if(G.onComplete){G.onComplete()}A.publish({event:"onComplete",data:{BS:Q.BS,reframe:H,displayNotif:B}})}},onProgress:function(N){A.publish({event:"onProgress",data:{progress:Math.floor((N.nbCGRLoaded/N.nbCGRToLoad)*100),message:m.displaying3D+": "+N.nbCGRLoaded+" of "+N.nbCGRToLoad+" "+m.parts,reframe:false}})},onFailure:function(){A.publish({event:"onLoadingFailure",data:{message:a.generic_service_failure,displayNotif:B}});if(M){M()}if(A._loadingQueue.length){A._processLoadingQueue()}else{if(G.onFailure){G.onFailure()}A.publish({event:"onComplete",data:{reframe:H,displayNotif:B}})}},onTimeout:function(){A.publish({event:"onLoadingFailure",data:{message:m.timeout,displayNotif:B}});if(M){M()}if(A._loadingQueue.length){A._processLoadingQueue()}else{if(G.onFailure){G.onFailure()}A.publish({event:"onComplete",data:{reframe:H,displayNotif:B}})}}};F.push(J)}else{console.warn("No root found");if(M){M()}}},"expand")}}else{var y=G.paths;var D=y[0][0];var x=A.getRoot({id:D});b.createPromise(function(K,J){var I={cancelable:false,paths:y,userFeedback:false,parent:A.getRootBag(),hidden:false,resolve:K,progressiveExpand:G.progressiveExpand,expand_iter:G.expand_iter,forceLoad:G.forceLoad,pixelCulling:G.pixelCulling,onComplete:function(L){if(K){K()}if(A._loadingQueue.length){A._processLoadingQueue()}else{if(G.onComplete){G.onComplete(L)}A.publish({event:"onComplete",data:{reframe:H,displayNotif:B}})}},onFailure:function(){A.publish({event:"onLoadingFailure",data:{message:a.generic_service_failure,displayNotif:B}});if(K){K()}if(A._loadingQueue.length){A._processLoadingQueue()}else{if(G.onFailure){G.onFailure()}A.publish({event:"onComplete",data:{reframe:H,displayNotif:B}})}},onCancel:function(){A.publish({event:"onLoadingCancel"});if(K){K()}if(A._loadingQueue.length){A._processLoadingQueue()}else{if(G.onFailure){G.onFailure()}}},onTimeout:function(){A.publish({event:"onLoadingFailure",data:{message:m.timeout,displayNotif:B}});if(K){K()}if(A._loadingQueue.length){A._processLoadingQueue()}else{if(G.onFailure){G.onFailure()}A.publish({event:"onComplete",data:{reframe:H,displayNotif:B}})}}};F.push(I)},"expand")}d.all(E).then(function(I){E=null;for(var J=0;J<F.length;J++){var K=F[J];A._loadingQueue.push(K)}A._processLoadingQueue()})},addRoots:function(B,T,O,x,Q){var D=this,N;var I=[];if(!j.is(B,"object")){throw new Error("No parameter defined")}if(B.pids===undefined&&B.paths===undefined&&B.structures===undefined&&B.objects===undefined&&B.rootsWithFilters===undefined){console.error("No ids or paths array defined");return}if(O!==undefined&&!j.is(O,"boolean")){throw new Error("displayNotif not correctely defined")}x=undefined===x?true:x;var z=B.objects!==undefined?B.objects:[];var R=B.pids_hidden!==undefined?B.pids_hidden:[];var y={};if(B.pids){for(N=0;N<B.pids.length;N++){var K=B.pids[N];z.push({id:K,hidden:R.indexOf(K)>=0?true:false})}}if(B.paths){for(N=0;N<B.paths.length;N++){var L=B.paths[N];z.push({path:L,hidden:R.indexOf(L[0])>=0?true:false})}}if(B.rootsWithFilters){var J=false;for(N=0;N<B.rootsWithFilters.length;N++){var K=B.rootsWithFilters[N].rootId;if(I.indexOf(K)===-1){I.push(K);var G=B.rootsWithFilters[N].filter.config_filter;var P=B.rootsWithFilters[N].filter.sequence_filter;var H=B.rootsWithFilters[N].filter.CVQuery3D;z.push({id:K,configBin:G,sequence_filter:P,CVQuery3D:H,hidden:R.indexOf(K)>=0?true:false})}else{J=true}}if(J===true){w.displayNotification({msg:a.filterMultipleSameRoot,eventID:"warning"})}}if(B.structures){for(N=0;N<B.structures.length;N++){z.push(B.structures[N])}}var E;if(B.loadWithFilter===true){if(k.getSetting("enopad3dviewer_lightNodeModel")===true){this.pauseProgressiveLoading()}E="0";this.publish({event:"onDisableUX"});this._wait4Filter=true}for(N=0;N<z.length;N++){var S=z[N];if(S.id){if(!y.pids){y.pids=[]}y.pids.push(S.id)}if(S.path){if(!y.paths){y.paths=[]}y.paths.push(S.path)}}O=O!==undefined?O:true;var A=[];var C=b.getPromises().slice();for(N=0;N<z.length;N++){var M=z[N];b.createPromise(function(ac,ae){var V=null,U=null,ad=null,ab=M.configBin!==undefined?M.configBin:undefined,aa=M.sequence_filter!==undefined?M.sequence_filter:undefined,Y=M.hidden!==undefined?M.hidden:false,X=M.CVQuery3D!==undefined?M.CVQuery3D:undefined,W=M.filterId!==undefined?M.filterId:undefined;if(M.structure&&M.rootID){V=M.structure;U=M.rootID;ad=[M.rootID]}else{if(M.id){U=M.id;ad=[M.id]}else{if(M.path){U=M.path[0];ad=M.path}}}var Z={cancelable:true,reframe:x,path:ad,structure:V,parent:D.getRootBag(),hidden:Y,configBin:ab,sequence_filter:aa,CVQuery3D:X,resolve:ac,intent:"addRoot",expand_iter:E,onComplete:function(ai){x=k.getSetting("enopad3dviewer_dynamicRepLoading")||k.getSetting("enopad3dviewer_lightNodeModel")?false:x;var ag=new v();ag.addElement(D.getRootBag());for(var af=0;af<=ad.length-1;af++){var ah=D.getNode({id:ad[af]});if(ah){ag.addElement(ah)}}if(D._rootIds.indexOf(U)===-1){D._rootIds.push(U);if(Y&&D.getHiddenRootIds().indexOf(U)===-1){D.getHiddenRootIds().push(U)}}D._model.addToRootLog(ad);D.publish({event:"onRootAdded",data:{path:ag,rootLog:D._model.getRootLog(),isFiltered:B.loadWithFilter,filterId:W,id:U,idPath:ad,displayNotif:O,reframe:x,inContext:ad.length>1?true:false,hidden:this.hidden,BS:ai.BS}});if(ac){ac()}if(D._loadingQueue.length){D._processLoadingQueue()}else{D.publish({event:"onComplete",data:{reframe:x,BS:ai.BS,intend:"addRoot"}});if(Q){Q()}}},onProgress:function(af){D.publish({event:"onProgress",data:{progress:Math.floor((af.nbCGRLoaded/af.nbCGRToLoad)*100),message:m.displaying3D+": "+af.nbCGRLoaded+" of "+af.nbCGRToLoad+" "+m.parts,reframe:x}})},onFailure:function(al,ag,aj){var ak=null;var ai=null;if(al&&al.filterMessage){ak=al.filterMessage}else{ak=a.generic_service_failure}if(al&&al.eventID){ai=al.eventID}var ah=j.is(ag,"string")?JSON.parse(ag):ag;if(ah&&ah.error&&ah.error.errorCode&&a[ah.error.errorCode]){ak=a[ah.error.errorCode]}var af=al&&al.display===true?al.display:O;D.publish({event:"onLoadingFailure",data:{displayNotif:af,message:ak,eventID:ai}});if(ac){ac()}if(D._loadingQueue.length){D._processLoadingQueue()}else{D.publish({event:"onComplete",data:{reframe:x}});if(Q){Q()}}},onTimeout:function(){if(O){D.publish({event:"onLoadingFailure",data:{displayNotif:O,message:m.timeout}})}if(ac){ac()}if(D._loadingQueue.length){D._processLoadingQueue()}else{D.publish({event:"onComplete",data:{reframe:x}});if(Q){Q()}}},onCancel:function(){D.removeRoots({pids:[U]});if(ac){ac()}if(D._loadingQueue.length){var af=D._loadingQueue.splice(0,1);if(af[0]&&af[0].onCancel){af[0].onCancel()}}else{D.publish({event:"onLoadingCanceled",data:{message:m.loadingCanceled}});D.publish({event:"onComplete",data:{reframe:x}});if(Q){Q()}}}};A.push(Z)},"addRoot")}d.all(C).then(function(U){C=null;for(var Y=0;Y<A.length;Y++){var aa=A[Y];var ab=aa.path;var W=false;for(var X=0;X<D._model.getRootLog().length;X++){var Z=D._model.getRootLog()[X];if(Z.length===ab.length){W=true;for(var V=0;V<ab.length;V++){if(Z[V]!==ab[V]){W=false}}if(W){break}}}if(W){D.publish({event:"onRootAlreadyExisting"});aa.resolve()}else{if(!aa.hidden){aa.hidden=D.getHiddenRootIds().indexOf(aa.path[0])>-1}D._loadingQueue.push(aa)}}if(k.getSetting("enopad3dviewer_initializeWithWrap")===true){D.setWrapUsage(true)}D._processLoadingQueue();if(k.getSetting("enopad3dviewer_initializeWithWrap")===true){D.setWrapUsage(false)}});if((T||(T===undefined))&&D._commandProxy){var F=require("DS/PADUtils/PADUtilsServices");y.tenant=F.getPlatformId();if(B.loadWithFilter===true){y.loadWithFilter=true}D._commandProxy.drop(y)}},attachRoot:function(y){if(!j.is(y,"object")){throw new Error("No parameter defined")}if(y.id===undefined){console.error("No ids array defined");return}var x=this;x._model.attachNode({id:y.id,parentId:x._model.getRootBagId()})},attachRoots:function(z,x){if(!j.is(z,"object")){throw new Error("No parameter defined")}if(z.pids===undefined){console.error("No ids array defined");return}var y=this;var A=b.getPromises().slice();b.createPromise(function(C,B){d.all(A).then(function(D){A=null;for(var G=0;G<z.pids.length;G++){var I=z.pids[G];var H=y.getNode({id:I});if(H){y.attachRoot({id:I});for(var E=y.getHiddenRootIds().length-1;E>=0;E--){if(y.getHiddenRootIds(E)===I){y.getHiddenRootIds().splice(E,1);break}}var F=y.getRootBagPath();F.addElement(H);y.publish({event:"onRootAttached",data:{path:F,id:I}})}}if((x||(x===undefined))&&y._commandProxy){y._commandProxy.attach(z)}C()})},"attachRoot")},removeRoots:function(B,z,x){if(!j.is(B,"object")){throw new Error("No parameter defined")}if(B.pids===undefined){console.error("No ids array defined");return}x=undefined===x?true:x;var A=this,y=false;var C=b.getPromises().slice();b.createPromise(function(E,D){d.all(C).then(function(F){C=null;for(var H=0;H<B.pids.length;H++){var K=B.pids[H];var I=A.getRoot({id:K});if(I){A.publish({event:"onBeginRootRemoved",data:{dispatch:z}});if(B.removeDetached===true){y=true}A._model.removeRoot({id:K,removeDetached:y});if(A._rootIds.indexOf(K)>-1){A._rootIds.splice(A._rootIds.indexOf(K),1);for(var J=A.getHiddenRootIds().length-1;J>=0;J--){if(A.getHiddenRootIds(J)===K){A.getHiddenRootIds().splice(J,1);break}}}var G=A.getRootBagPath();G.addElement(I);A.publish({event:"onRootRemoved",data:{path:G,id:K,reframe:x,rootLog:A._model.getRootLog(),dispatch:z}})}}if((z||(z===undefined))&&A._commandProxy){A._commandProxy.remove(B)}E();A.publish({event:"onEndRootRemoved",data:{ids:B.pids,dispatch:z||(z===undefined)}});x=null;A=null})},"RemoveRoot")},detachRoots:function(z,x){if(!j.is(z,"object")){throw new Error("No parameter defined")}if(z.pids===undefined){console.error("No ids array defined");return}var y=this;var A=b.getPromises().slice();b.createPromise(function(C,B){d.all(A).then(function(D){A=null;for(var F=0;F<z.pids.length;F++){var H=z.pids[F];var G=y.getNode({id:H});if(G&&y.getHiddenRootIds().indexOf(H)===-1){y._model.detachNode({id:H,parentId:y._model.getRootBagId()});y.getHiddenRootIds().push(H);var E=y.getRootBagPath();E.addElement(G);y.publish({event:"onRootDetached",data:{path:E,id:H}})}}if((x||(x===undefined))&&y._commandProxy){y._commandProxy.detach(z)}C()})},"detachRoot")},unparent:function(B){if(!j.is(B,"object")){throw new Error("No parameter defined")}if(!j.is(B.deleted,"array")){throw new Error("No deleted objects streamed")}var A=this;for(var y=0;y<B.deleted.length;y++){var C=B.deleted[y];var z=A.getNode({id:C});if(!z){continue}A.publish({event:"onBeginDelete",data:{pathToReparent:z}});var x=z.getRootReferences();A._model.removeNode({id:C});A.publish({event:"onEndDelete",data:{pathToReparent:z,rootNodes:x}})}},reparent:function(y){if(!j.is(y,"object")){throw new Error("No parameter defined")}if(!j.is(y.deleted,"array")){throw new Error("No deleted objects streamed")}if(!j.is(y.modified,"array")){throw new Error("No modified objects streamed")}if(!j.is(y.created,"array")){throw new Error("No created objects streamed")}var x=this;var z=b.getPromises().slice();b.createPromise(function(B,A){d.all(z).then(function(C){z=null;var G=x.getNode({id:y.deleted[0]});var H=x.getNode({id:y.modified[0]});var D=y.created[0];if(G&&H&&D){var J=G.path.clone();x.publish({event:"onBeginReparent",data:{pathToReparent:G.path}});var F=parseInt(k.getSetting("webapi_timeout"));var I=j.clone(k.getWebAPI_Options("navigate3D"),true);var E={root_physicalid:n.getNodeID(H),expand_iter:"1",select_bo:I.select_bo,select_rel:I.select_rel,compute_select_bo:x.getDefaultStreamToLoad()==="thumbnail"?I.computeCGRsNThumbnails:I.computeCGRs,intent:"explore_3D",authored:x._isAuthored(),boundingbox:x._withBoundingBoxes(),debug:k.getSetting("enopad_webapis_debug")};if(k.getSetting("enopad3dviewer_lightNodeModel")===true){E.nbchildren=true}x._startAsync();l.setText(m.queryRunning);s.navigate({enopad_webapis:k.getSetting("enopad_webapis"),data:E,timeout:F,expand3DType:"expand3D",onComplete:function(N){var L;try{L=j.is(N,"string")?JSON.parse(N):N}catch(M){x._stopAsync();B();x.publish({event:"onReparentFailure",data:{message:m.cannotParseQueryResult}});return}l.setText(m.parsingResponse);if(L.results.length===0){x._stopAsync();x.publish({event:"onReparentFailure",data:{message:m.cannotLoadSuchObject}})}else{var K=x._model.reparentNode({json:L,oldInstance:G,newParent:H,createdInstID:D});x._stopAsync();B();x.publish({event:"onEndReparent",data:{path:K.path,createdNode:K,modifiedNode:H,rootNodes:H.getRootReferences()}})}},onFailure:function(M,K,L){x._stopAsync();B();x.publish({event:"onReparentFailure",data:{message:a.generic_service_failure}})},onTimeout:function(M,K,L){x._stopAsync();B();x.publish({event:"onReparentFailure",data:{message:m.timeout}})}})}})},"reparent")},insertExisting:function(y){if(!j.is(y,"object")){throw new Error("No parameter defined")}if(!j.is(y.inserted,"array")){throw new Error("No inserted objects streamed")}if(!j.is(y.modified,"array")){throw new Error("No modified objects streamed")}if(!j.is(y.created,"array")){throw new Error("No created objects streamed")}var x=this;var A=y.inserted[0];var z=b.getPromises().slice();b.createPromise(function(C,B){d.all(z).then(function(M){z=null;if(!j.is(y.inserted[0],"array")){console.log("No inserted paths streamed");y.inserted=[y.inserted];A=y.modified}var K=y.inserted[0][y.inserted[0].length-1];var I=x.getNode({id:K});var N=x.getNode({id:y.modified[0]});if(!N){throw new Error("Object to modify not found")}var J=y.created[0];if(I){var D=parseInt(k.getSetting("webapi_timeout"));var E=j.clone(k.getWebAPI_Options("navigate3D"),true);var H={root_path_physicalid:[A],expand_iter:"-1",select_bo:E.select_bo,select_rel:E.select_rel,compute_select_bo:x.getDefaultStreamToLoad()==="thumbnail"?E.computeCGRsNThumbnails:E.computeCGRs,intent:"explore_3D",authored:x._isAuthored(),boundingbox:x._withBoundingBoxes(),debug:k.getSetting("enopad_webapis_debug")};if(k.getSetting("enopad3dviewer_lightNodeModel")===true){H.nbchildren=true}x._startAsync();l.setText(m.queryRunning);s.navigate({enopad_webapis:k.getSetting("enopad_webapis"),data:H,expand3DType:"expand3D",timeout:D,onComplete:function(R){var P;try{P=j.is(R,"string")?JSON.parse(R):R}catch(Q){x._stopAsync();C();x.publish({event:"onInsertExistingFailure",data:{message:m.cannotParseQueryResult}});return}l.setText(m.parsingResponse);if(P.results.length===0){x._stopAsync();C();x.publish({event:"onInsertExistingFailure",data:{message:m.cannotLoadSuchObject}})}else{l.setText(m.inserting);var O=x._model.insertExistingNode({json:P,toInsert:I,parent:N,createdInstID:J});x._stopAsync();C();x.publish({event:"onInsertExisting",data:{insertedNode:I,modifiedNode:N,createdNode:O,rootNodes:N.getRootReferences()}})}},onFailure:function(Q,O,P){x._stopAsync();C();x.publish({event:"onInsertExistingFailure",data:{message:a.generic_service_failure}})},onTimeout:function(Q,O,P){x._stopAsync();C();x.publish({event:"onInsertExistingFailure",data:{message:m.timeout}})}})}else{var L=y.modified[0];var G=y.inserted[0][y.inserted[0].length-1];var F=y.created[0];x._loadingQueue.push({cancelable:false,id:L,path:A,expand_iter:"-1",resolve:C,onComplete:function(R){var Q=x.getNode({id:L});var P=x.getNode({id:G});var O=x.getNode({id:F});if(Q&&P){x.publish({event:"onInsertExisting",data:{insertedNode:P,modifiedNode:Q,createdNode:O,rootNodes:Q.getRootReferences()}})}if(C){C()}},onFailure:function(){x.publish({event:"onInsertExistingFailure",data:{message:a.generic_service_failure}});if(C){C()}},onTimeout:function(){x.publish({event:"onInsertExistingFailure",data:{message:m.timeout}});if(C){C()}},onProgress:function(O){x.publish({event:"onProgress",data:{progress:Math.floor((O.nbCGRLoaded/O.nbCGRToLoad)*100),message:m.displaying3D+": "+O.nbCGRLoaded+" of "+O.nbCGRToLoad+" "+m.parts,reframe:false}})}});x._processLoadingQueue()}})},"insertExisting")},_replaceInstances:function(A){var z=this;A.dispatch=A.dispatch!==undefined?A.dispatch:true;var x=z.getPromises();var B=x.slice();var y=d.deferred();d.all(B).then(function(C){B.splice(0,B.length);z.publish({event:"onBeginReplaceInstance"});var D=[];for(var F=0;F<A.data.length;F++){var G={id:String(A.data[F].oldId)},H={id:String(A.data[F].newId)};var E=z._model.updateNode(G,H);if(E){D.push(E)}}if(A.dispatch){z._commandProxy.padRefresh({transactions:[{replaceInstances:{couples:A.data}}]})}z.publish({event:"onEndReplaceInstance",data:{nodes:D}});y.resolve(D);z=null});y.name="UpdateNode";x.push(y);return y.promise},replaceInstances:function(B,x){if(!j.is(B,"object")){throw new Error("replaceInstances: There is no parameter defined.")}if((B.data===undefined)||(B.data.length===0)){console.error("replaceInstances: Id pairs array is not defined.");return}else{var A=null,z=null,C=false;for(var y=0;y<B.data.length;y++){z=this.getNode({id:String(B.data[y].oldId)});if(z){C=z.isPLMInstance();if(!C){A="replaceInstances: One or several nodes are not instances."}}else{A="replaceInstances: One or several Ids are invalid."}if(A){if(x&&x.onFailure){x.onFailure.call(null,A);return}else{throw new Error(A)}}}}this._replaceInstances(B).then(function D(){if(x&&x.onComplete){x.onComplete.apply(null,arguments)}})},buildPathFromArray:function(B,C){var z=this.getRootBagPath();var x=this.getRoots();var y=false;for(var A=0;A<x.length;++A){if(n.getNodeID(x[A])===B[0]){y=true}}if(y===false){return null}for(var A=0;A<B.length;A++){var D=this.getNode({id:B[A]});if(D){z.addElement(D)}else{if(!C){console.warn(B[A]+" does not exist");return null}}}return z},buildArrayFromPath:function(z){var A=[];if(z.externalPath&&z.externalPath.length){for(var y=0;y<z.externalPath.length;y++){var x=z.externalPath[y];if(n.isPLMNode(x)){A.push(n.getNodeID(x))}}}return A},buildArrayFromPathWithType:function(B,C,x){var A=[];if(B.externalPath&&B.externalPath.length){for(var z=0;z<B.externalPath.length;z++){var y=B.externalPath[z];if(n.isPLMNode(y)){A.push(n.getNodeID(y));if(n.getNodeType(y)){x[n.getNodeID(y)]={type:n.getNodeType(y)}}}}C.push(A)}},flushModel:function(y,x){this.removeRoots({pids:this._rootIds.slice(0),removeDetached:true},false,x);if(y&&this._commandProxy){this._commandProxy.cleanAll()}},search:function(C){var x=this.getRoots();var B=this;var D=b.getPromises().slice();var y=[];if(x.length>0){var A=[];for(var z=0;z<x.length;z++){b.createPromise(function(G,F){var E={cancelable:false,forceIndex:true,findInCtx:C.searchQuery,path:[n.getNodeID(x[z])],parent:B._model.getRootBag(),sequence_filter:B._model.getRoot({id:n.getNodeID(x[z])}).getSequenceFilter(),configBin:B._model.getRoot({id:n.getNodeID(x[z])}).getConfigFilter(),CVQuery3D:B._model.getRoot({id:n.getNodeID(x[z])}).getCVFilterQuery(B._BIProxy,"V1"),resolve:G,intent:"searchInDsBoard",progressiveExpand:false,expand_iter:"-1",forceLoad:true,max_count_path:k.getSetting("enopad3dviewer_max_count_in_search"),onComplete:function(J){if(J&&J.selectedPaths&&J.selectedPaths.length){var L=[];var I=[];for(var H=0;H<J.selectedPaths.length;H++){A.push(J.selectedPaths[H]);var K=B.buildPathFromArray(J.selectedPaths[H]);if(K){if(!n.is3DLeaf(K.externalPath[K.externalPath.length-1])){if(J.selectedPaths[H].length===1){I.push(J.selectedPaths[H])}else{L.push(J.selectedPaths[H])}}}else{if(J.selectedPaths[H].length===1){I.push(J.selectedPaths[H])}else{L.push(J.selectedPaths[H])}}}if((L.length||I.length)&&!k.getSetting("enopad3dviewer_lightNodeModel")){B.expand({paths:I.length?I:L,expand_iter:"-1",onComplete:function(){var M={selectedPaths:A,searchQuery:C.searchQuery};B.publish({event:"onSearchCompleted",data:M})},onFailure:function(){B.publish({event:"onSearchFailure",data:J})},},false,false)}else{J.searchQuery=C.searchQuery;B.publish({event:"onSearchCompleted",data:J})}}else{B.publish({event:"onSearchCompleted",data:J})}if(G){G()}if(B._loadingQueue.length){B._processLoadingQueue()}else{B.publish({event:"onComplete",data:{reframe:false}})}},onFailure:function(H){B.publish({event:"onSearchFailure",data:H});if(G){G()}if(B._loadingQueue.length){B._processLoadingQueue()}else{B.publish({event:"onComplete",data:{reframe:false}})}},onTimeout:function(H){B.publish({event:"onSearchFailure",data:H});if(G){G()}if(B._loadingQueue.length){B._processLoadingQueue()}else{B.publish({event:"onComplete",data:{reframe:false}})}},};y.push(E)},"search")}}else{B.publish({event:"onSearchCompleted"})}d.all(D).then(function(E){D=null;for(var F=0;F<y.length;F++){var G=y[F];B._loadingQueue.push(G)}B._processLoadingQueue()})},refresh:function(H){var x=this._rootIds.slice();var C=this._model.getRootLog();var I=this.getHiddenRootIds().slice();var A=[];var z=x.concat(I);for(var D=0;D<z.length;D++){var E={filter:{}};var J=this.getRoot({id:z[D]});if(J.getConfigFilter){E.filter.config_filter=J.getConfigFilter()}if(J.getSequenceFilter){E.filter.sequence_filter=J.getSequenceFilter()}if(J.getCVFilterQuery){E.filter.CVQuery3D=J.getCVFilterQuery(this._BIProxy,"V1")}if(E.filter.config_filter||E.filter.sequence_filter||E.filter.CVQuery3D){E.rootId=z[D];A.push(E);for(var B=C.length-1;B>=0;B--){if(j.is(C[B],"array")){if(C[B][0]===z[D]){C.splice(B,1)}}}}}if(x.length){this.publish({event:"onRefreshBegin"});this._clearRootEvents();this.flushModel(false,false);var F=this;var G=0;var y=this.subscribe({event:"onRootRemoved"},function(){G++;if(G===x.length){F.unsubscribe(y);F.addRoots({paths:C.length>0?C:undefined,rootsWithFilters:A.length>0?A:undefined,pids_hidden:I},false,false,false,function(){this._restoreRootEvents();this.publish({event:"onRefreshCompleted"})}.bind(F))}});if(H&&this._commandProxy){this._commandProxy.refreshModel()}}},refreshGeometry:function(B){var z=this;var y={},A=[];z._startAsync();for(var x=0;x<B.ids.length;x++){y[B.ids[x]]=n.getLoadedStream(z.getNode({id:B.ids[x]}))==="thumbnail"?"thumbnail_3d":n.getLoadedStream(z.getNode({id:B.ids[x]}))}this.getAttributes({ids:B.ids,attributes:["cgr","thumbnail_3d"],callbacks:{onComplete:function(C){for(var D=0;D<B.ids.length;D++){A[D]={node:z.getNode({id:B.ids[D]}),stream:n.getLoadedStream(z.getNode({id:B.ids[D]})),url:C[B.ids[D]][y[B.ids[D]]]}}z._model.refreshStream({data:A,applicativeContainers:B.applicativeContainers,noMeshInRAM:undefined===B.noMeshInRAM?true:B.noMeshInRAM,callbacks:{onURLLoad:function(E){z.publish({event:"onProgress",data:{progress:Math.floor((E.nbURLLoaded/E.nbURLToLoad)*100),message:m.displaying3D+": "+E.nbURLLoaded+" of "+E.nbURLToLoad+" "+m.parts,reframe:false}})},onComplete:function(E){z._stopAsync();z.publish({event:"onGeometryRefreshed"});B.onComplete(E)}}})},onFailure:function(C){z._stopAsync();z.publish({event:"onRefreshGeometryFailure"});B.onFailure(C)},onTimeout:function(){z._stopAsync();z.publish({event:"onRefreshGeometryFailure"});B.onTimeout()}}})},lockNodes:function(x){if(!j.is(x.ids,"array")){console.error("Controller lockNodes(): Given array is not an array of IDs.");return}this._model.lockNodes(x)},unlockNodes:function(x){if(!j.is(x.ids,"array")){console.error("Controller unlockNodes(): Given array is not an array of IDs.");return}this._model.unlockNodes(x)},isRunning:function(){return this._operationInProgress},publish:function(x){this.getModelEvents().publish(x)},subscribe:function(x,y){return this.getModelEvents().subscribe(x,y)},unsubscribe:function(x){this.getModelEvents().unsubscribe(x)},getModelEvents:function(){return this._modelEvents},getNbRoots:function(){return this.getRoots().length},getRoots:function(){return this.getRootBag().children},getRootBagPath:function(){return this.getRootBag().path.clone()},getRootBag:function(){return this._model.getRootBag()},_setDefaultStreamToLoad:function(x){if(typeof x==="boolean"){x=x?"cgr":"thumbnail"}if(x){this._defaultStreamToLoad=x;this.publish({event:"onDefaultStreamChanged",data:{newStream:x}})}},getDefaultStreamToLoad:function(){return this._defaultStreamToLoad},getPromises:function(){return b.getPromises()},setWrapUsage:function(x){this._useWrap=x},getDecorationBag:function(){return this._model.getDecorationBag()},getLoadingBoxesBag:function(){return this._model.getLoadingBoxesBag()},getNode:function(y){if(!y.id){new Error("No id defined")}var x=null;if(this._model){x=this._model.getNode(y)}return x},getRoot:function(y){if(!y.id){new Error("No id defined")}var x=null;if(this._model){x=this._model.getRoot(y)}return x},abortLoading:function(){if(this._abortLoading){this._abortLoading();this._abortLoading=null}},_interruptLoading:function(x){if(this._runningQuery){this._runningQuery.cancel()}this._model.abort(x)},pauseLoading:function(){if(this._pauseLoading){this._pauseLoading();this._pauseLoading=null}},_pauseQuery:function(x){if(this._runningQuery){this._runningQuery.cancel()}},getReferenceBoundingSphere:function(x){return this._model.getReferenceBoundingSphere(x)},pauseProgressiveLoading:function(){--this._engineState;if(this._engineState===0){this._model.pause();this.pauseLoading()}},resumeProgressiveLoading:function(){++this._engineState;if(this._engineState>0){this._model.resume()}},unlockChildrenFromProgressiveExpand:function(D){var C=this,A=C._model.getRootLog(),B=null;for(var z=0;z<D.paths.length;z++){B=D.paths[z][D.paths[z].length-1];for(var y=0;y<A.length;y++){if(D.expand_level!==-1){for(var x=0;x<A[y].length-1;x+=2){if(A[y][x]===B){for(var E=x;E-x<=2*D.expand_level&&E<A[y].length-1;E+=2){C._model.unlockChildren({id:A[y][E]})}break}}}else{for(var x=0;x<A[y].length-1;x+=2){if(A[y][x]===B){for(var E=x;E<A[y].length-1;E+=2){C._model.unlockChildren({id:A[y][E]})}break}}}}}},getFcsUrls:function(A){if(!j.is(A.urls,"array")){throw new Error("No urls defined")}if(!j.is(A.callbacks.onComplete,"function")){throw new Error("No onComplete callback defined")}if(!j.is(A.callbacks.onFailure,"function")){throw new Error("No onFailure callback defined")}var z=0;function C(D){return decodeURIComponent((D+"").replace(/\+/g,"%20"))}var B=function(D){var I={};var J=document.createElement("a");J.href=D;var F=J.search.substring(1);var G=F.split("&");for(var E=0;E<G.length;E++){var H=G[E].split("=");I[H[0]]=C(H[1])}return I};var x={data:{boproxies:[]},onComplete:function(E){try{var D=!j.is(E,"object")?JSON.parse(E):E;A.callbacks.onComplete(D)}catch(F){console.warn("Error while parsing results")}},onFailure:function(D){A.callbacks.onFailure(D)}};for(z=0;z<A.urls.length;z++){var y=B(A.urls[z]);if(y.boid&&y.format&&y.filename){x.data.boproxies.push(y)}}if(x.data.boproxies.length){s.getFcsUrls(x)}},registerOverrideSet:function(x){if(k.getSetting("enopad3dviewer_lightNodeModel")===true){this._model.registerOverrideSet(x)}},setOverrideCB:function(y,z,x){if(k.getSetting("enopad3dviewer_lightNodeModel")===true){this._model.setOverrideCB(y,z,x)}},hasOverrideCB:function(y,x){var z=false;if(k.getSetting("enopad3dviewer_lightNodeModel")===true){z=this._model.hasOverrideCB(y,x)}return z},removeOverrideSet:function(x){if(k.getSetting("enopad3dviewer_lightNodeModel")===true){this._model.removeOverrideSet(x)}},createReferenceIterator:function(x){if(k.getSetting("enopad3dviewer_lightNodeModel")===true){return this._model._OOCManager.createReferenceIterator(x)}},getOOCSelectedReferenceID:function(){return this._model.getOOCSelectedReferenceID()},_withBoundingBoxes:function(){return this._context.isSelectiveLoadingActivated()},_disableFilterWaiting:function(B){var A=this;if(this._wait4Filter===true){delete this._wait4Filter;this.publish({event:"onEnableUX"});var y={paths:[],intent:"addRoot"};if(j.is(B.rootIds,"array")){for(var x=0;x<B.rootIds.length;x++){y.paths.push([B.rootIds[x]])}var z=k.getSetting("enopad3dviewer_dynamicRepLoading")||k.getSetting("enopad3dviewer_lightNodeModel")?false:true;this.expand(y,false,false,z)}else{w.displayNotification({msg:a.noRoot2Expand,eventID:"error"})}this._context._filterDrop=false}this._context.publish({event:"onVolumeOpen",data:{closePanel:true}})},get3DLayerController:function(){return this._layerController}});return j.namespace("DS/ENOPAD3DViewer/controller/PAD3DViewerController",t)});define("DS/ENOPAD3DViewer/PAD3DViewer",["css!DS/ENOPAD3DViewer/ENOPAD3DViewer","UWA/Core","UWA/Controls/Abstract","DS/ENOPAD3DViewer/controller/PAD3DViewerController","DS/ENOPAD3DViewer/mixins/PAD3DViewerLoadingBoxesEngine","DS/PADServices/utils/AttributesMgt","DS/PADUtils/PADSettingsMgt","DS/PADUtils/views/PADProgressBar","DS/PADUtils/PADContext","DS/ApplicationFrame/CommandsManager","DS/ApplicationFrame/FrameWindow3D","DS/Visualization/PathElement","DS/Visualization/SceneGraphUtils","DS/Selection/PSOManager","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/i3DXCompassServices/i3DXCompassPubSub","DS/Core/ModelEvents","DS/Utilities/Utils","DS/PADUtils/PADProbes","DS/PADUtils/PADPromise","DS/PADUtils/PADTypesMgt","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADWSAccess","DS/PADUtils/PADWebInWinServices","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/ENOPAD3DViewer/utils/PAD3DViewerChangeAction","DS/ENOPAD3DViewer/utils/PAD3DViewerVisuServices","UWA/Utils/InterCom","UWA/Promise","i18n!DS/ENOPAD3DViewer/assets/nls/PAD3DViewer.json","i18n!DS/PADUtils/assets/nls/PADUtils.json","DS/ENOXTriptych/js/ENOXTriptych","DS/ENOPAD3DViewer/commands/PAD3DViewerDebugVisuCmd","DS/PADUtils/PADSession","DS/ENOPAD3DViewer/views/PAD3DRootListMgt","DS/ENOPAD3DViewer/views/PAD3DFindInContextColorized","DS/Visualization/Viewpoint"],function(S,e,R,s,f,K,B,h,y,J,t,L,I,a,o,q,x,v,H,w,k,N,p,d,Q,u,c,r,M,D,P,A,G,l,g,C,F,i){var n=null;var O="2.0";var z=1;var b={version:O,results:[],structures:[],viewpoint:[]};var j={authorizedRootTypes:null};var E=false;var m=R.extend(f,C,F,{name:"ENOPAD3DViewer",init:function(U){var V=this;this._frmWindow=null;this._viewer=null;this._layout=null;this._UILoader=null;this._lockCSONotification=false;this._lockCSONotificationEmpty=false;this._modelEvents=null;this._controller=null;this._controllerTokens=[];this._csoTokens=[];this._psoTokens=[];this._hsoTokens=[];this._filteredIdToReload=[];this._hideShowController=null;this._authorizeSet3DStructure=false;this._isVolumeFilter=false;this._isFilterOpen=false;this._volumePanel=0;this._physicalId=[];this._hideShowControllerTokens=[];this._dndCB=[];this._defaultProgressBarVisibility=null;this._automaticReframePolicy=null;this._mouse={x:0,y:0};this._readyCheckPromises=[];this._platformServicesInitPromise=null;this._actionBarTokens=[];this._robotVisibility=true;this._defaultContextualBarVisibility=true;this._defaultContextualMenuVisibility=true;this._propertiesCommandAvailability=true;this._BIController=null;this._firstInit=true;this._interwidgetComAvailability=true;this._loadingDelegations=null;this._dropZoneContainer=null;this._actionBarCloseEvt=-1;this._actionBarOpenEvt=-1;var T=U.widget;if(T){this._lang=T.lang}else{this._lang=U.windowOptions?U.windowOptions.language:"en"}this.getWidget=function(){return T};window.nearFarBigScale=true;Q.initialize(U);this.setAutomaticReframePolicy(U.windowOptions.automaticReframePolicy===undefined?true:U.windowOptions.automaticReframePolicy);this.setDefaultProgressBarVisibility(U.windowOptions.defaultProgressBarVisibility===undefined?true:U.windowOptions.defaultProgressBarVisibility);B.setSetting("enopad3DViewer_enableStatusInfo",U.windowOptions.enableStatusInfo!==undefined?U.windowOptions.enableStatusInfo:true);if(B.app_context===null){B.set_app_context("enopad3dviewer",true);B.setSetting("lang",this._lang)}if(U.authorizedRootTypes!==null&&e.is(U.authorizedRootTypes,"array")){this.setAuthorizedRootTypes(U.authorizedRootTypes)}B.setSetting("enopad3dviewer_roles",[]);if(U.enableFiltering===true){B.setSetting("enopad3dviewer_FilterAvailable",true)}if(U.activateProbes===false){B.setSetting("probes_activated",false)}if(U.debugVisuCommand===true){B.setSetting("enopad3dviewer_debugvisucommand",true)}if(U.visuProgressiveTileModel!==undefined){B.setSetting("enopad3dviewer_lightNodeModel",U.visuProgressiveTileModel)}this._authorizeSet3DStructure=U.authorizeSet3DStructure===undefined?true:U.authorizeSet3DStructure;this._isVolumeFilter=U.isVolumeFilter===undefined?false:U.isVolumeFilter;this._propertiesCommandAvailability=undefined!==U.propertiesCommandAvailability?U.propertiesCommandAvailability:this._propertiesCommandAvailability;this.initProbe=w.createProbe("PAD3DViewer_init");this._parent(U);if(undefined!==U.interwidgetComAvailability){this._interwidgetComAvailability=U.interwidgetComAvailability}if(undefined!==U.loadingDelegations){this.setLoadingDelegations(U.loadingDelegations)}if(undefined!==U.loadCGRAsDefaultStream){B.setSetting("enopad3dviewer_CGRorTHB",U.loadCGRAsDefaultStream)}if(undefined!==U.dynamicRepLoading){B.setSetting("enopad3dviewer_dynamicRepLoading",U.dynamicRepLoading);B.setSetting("enopad3dviewer_useStaticURL",true)}if(undefined!==U.supportPgpBasedOnDescription){B.setSetting("supportPgpBasedOnDescription",U.supportPgpBasedOnDescription)}if(undefined!==U.selectionFilter){B.setSetting("enopad3dviewer_selectionFilter",U.selectionFilter)}if(undefined!==U.enableOcclusionTest){B.setSetting("enopad3dviewer_occlusionTest",U.enableOcclusionTest)}else{B.setSetting("enopad3dviewer_occlusionTest",true)}this._modelEvents=new v();if(U.widget){if(U.widget.lang){B.setSetting("lang",U.widget.lang)}}this._changeAction=new c();if(!U.offline){this.connectToPlatform(U)}else{this._platformServicesInitPromise=new D(function(W){W()})}if(!U.getPlatformServicesInBackground&&!U.offline){this._readyCheckPromises.push(this._platformServicesInitPromise)}this._buildSkeleton(U);this._buildComponent(U);D.all(this._readyCheckPromises).then(function(){delete V._readyCheckPromises;if(B.getSetting("enopad3dviewer_rotateFocusMode")){V.getViewpoint()._setFocusMode(i._FOCUS_MODE.ROTATION)}V.setupLoadingBoxesEngine();B.addEvent("onEnopad3dviewer_displayCandidateQueue",function(Y){V.setupLoadingBoxesEngine()});B.addEvent("onEnopad3dviewer_displayCandidateQueue_color",function(Y){V.setLoadingBoxesColor(Y);V.setupLoadingBoxesEngine()});var W=window.getComputedStyle(V.elements.container);if(V.getStatusBar()&&W&&Number(W.width.slice(0,-2))<900){V.getFrameWindow().getActionBar().elements.container.setStyle("bottom","0");V.getFrameWindow().getActionBar().close();V.getStatusBar().close()}V.publish({event:"onReady",data:V});if(V.isSelectiveLoadingActivated()){var X=p.isTouchDevice()?" touch-mode":"";var W={bottom:"0"};if(V._frmWindow.getActionBar().elements.container.getAttribute("data-open")==="true"){if(p.isTouchDevice()){W={bottom:"38px"}}else{W={bottom:"24px"}}}if(V.getOption("enableSidePanel")===true){V._frmWindow.getActionBar().inject(V.elements.main);V._frmWindow.getActionBar().elements.container.setStyles(W)}if(V._actionBarCloseEvt===-1){V._actionBarCloseEvt=V._frmWindow.getActionBar().onActionBarClose(function(){if(V.getStatusBar()){V.getStatusBar().close()}V.elements.container.firstChild.className="enopad3Dviewer_3dcontainer"+X;V._frmWindow.getActionBar().elements.container.setStyle("bottom","0")})}if(V._actionBarOpenEvt===-1){V._actionBarOpenEvt=V._frmWindow.getActionBar().onActionBarOpen(function(){var Y=p.isTouchDevice()?{bottom:"38px"}:{bottom:"24px"};if(V.getStatusBar()){V.getStatusBar().open()}V.elements.container.firstChild.className="enopad3Dviewer_3dcontainer"+X;V._frmWindow.getActionBar().elements.container.setStyles(Y)})}}if(U.objects2Load){V.openStoredObjects(U.objects2Load)}})},isSelectiveLoadingActivated:function(){return B.getSetting("enopad3dviewer_dynamicRepLoading")||B.getSetting("enopad3dviewer_lightNodeModel")},connectToPlatform:function(T){var U=this;this._platformServicesInitPromise=new D(function(V){p.app_initialization(function(){p.getGrantedRoles(function(W){B.setSetting("enopad3dviewer_roles",W)});U.publish({event:"grantedRoleRetrieved",data:B.getSetting("enopad3dviewer_roles")});if(T.allowAuthoring===false){B.setSetting("enopad_webapis",false)}else{B.setSetting("enopad_webapis",true)}if(T&&T.securityContext&&T.securityContextList){B.setSetting("pad_security_ctx",T.securityContext);B.setSetting("pad_security_ctx_list",T.securityContextList);V()}else{p.getSecurityContext(function(W){if(W&&W.securityContext&&W.securityContextList){B.setSetting("pad_security_ctx",W.securityContext);B.setSetting("pad_security_ctx_list",W.securityContextList)}V();if(!T.readyCB){T.readyCB=function(){}}T.readyCB()})}},T.plateformServices)})},render:function(){if(this.getOption("enableSidePanel")===true){return this.elements.triptych}else{return this}},getPropertiesFacet:function(){var T=this.getOption("propertiesFacet")?this.getOption("propertiesFacet"):[];return T},destroy:function(){var T=this;if(this._frmWindow){this._actionBarTokens.forEach(function(U){if(T._frmWindow.removeActionBarCallback){T._frmWindow.removeActionBarCallback(U)}});if(this._frmWindow.getActionBar()){if(this._actionBarCloseEvt!==-1){this._frmWindow.getActionBar().removeCallback(this._actionBarCloseEvt)}if(this._actionBarOpenEvt!==-1){this._frmWindow.getActionBar().removeCallback(this._actionBarOpenEvt)}}this._frmWindow.dispose();delete this._frmWindow}if(this._viewer){delete this._viewer}if(this._commandProxy){this._commandProxy.padDestroy();this._commandProxy.destroy();delete this._commandProxy}if(this._controller){this._controllerTokens.forEach(function(U){T._controller.unsubscribe(U)});this._controller.destroy();delete this._controller;delete this._controllerTokens}if(o){this._csoTokens.forEach(function(U){o.unsubscribe(U)});delete this._csoTokens}if(a){this._psoTokens.forEach(function(U){a.unsubscribe(U)});delete this._psoTokens}if(q){this._hsoTokens.forEach(function(U){q.unsubscribe(U)});delete this._hsoTokens}if(this._hideShowController){this._hideShowControllerTokens.forEach(function(U){T._hideShowController.unsubscribe(U)});this._hideShowController.destroy();delete this._hideShowController;delete this._hideShowControllerTokens}if(this._BIController){this._BIController.destroy();delete this._BIController}if(this._layout){if(this._layoutActivatedTokenBegin){this._layout.unsubscribe(this._layoutActivatedTokenBegin);delete this._layoutActivatedTokenBegin}if(this._layoutActivatedTokenEnd){this._layout.unsubscribe(this._layoutActivatedTokenEnd);delete this._layoutActivatedTokenEnd}this._layout.destroy();delete this._layout}if(this._dndCB&&this._dndCB.length){this.elements.container.removeEventListener("dragenter",this._dndCB[0]);this.elements.container.removeEventListener("dragover",this._dndCB[1]);this.elements.container.removeEventListener("dragleave",this._dndCB[2]);this.elements.container.removeEventListener("dragend",this._dndCB[3]);this.elements.container.removeEventListener("drop",this._dndCB[4]);delete this._dndCB}this.disposeLoadingBoxesEngine();T=null;y.reset();B.destroy();this._parent()},checkIfEmpty:function(){this.getController().checkIfEmpty()},_buildSkeleton:function(W){var Z=this;if(!e.is(this.elements.container)){this.elements.container=e.createElement("div",{"class":"enopad3Dviewer_container"});if(this.getOption("css_view_class")){this.elements.container.addClassName(this.getOption("css_view_class"))}var V="enopad3Dviewer_3dcontainer";var Y=p.isTouchDevice()?" touch-mode":"";V+=Y;this.elements.view_container=e.createElement("div",{"class":V}).inject(this.elements.container);var U=function(){if(B.getSetting("enopad3dviewer_debugvisucommand")===true){var aa=e.createElement("span",{"class":"fonticon fonticon-chart-gauge-angular enopad3dviewer_3dcontainer_debugvisuicon",id:"pad3dviewer_debugVisuCommandID"}).inject(Z.elements.container);aa.addEventListener("click",function(){var ab=new l();ab.execute()})}};if(B.getSetting("enopad3DViewer_enableStatusInfo")){var T=new D(function(aa){Z._platformServicesInitPromise.then(function(){if(!Z.isSelectiveLoadingActivated()){require(["DS/PADUtils/views/PADStatusInfos"],function(ab){Z.elements.padstatus=new ab({renderTo:Z.elements.container,events:{onShow:function(){var ac=o.get();Z.elements.padstatus.setStatus(ab.buildStatus({Tenant:p.getPlatformId(),tree_content:{nbObjectsSelected:ac.length}}))}},withProgress:B.getSetting("enopad3DViewer_lightLoaderForBackgroundLoad"),attention:P.progressiveExpandFullMemory});U();aa()})}else{require(["DS/PADUtils/views/PADStatusBar","DS/PADUtils/PADSession"],function(ac,ab){Z.elements.padstatusbar=new ac({renderTo:Z.getOption("enableSidePanel")===true?Z.elements.main:Z.elements.container,withLoader:true,perfoDebug:(B.getSetting("enopad3dviewer_debugvisucommand")===true),onPlay:function(){Z.getController().resumeProgressiveLoading();if(Z.getStatusBar()){Z.getStatusBar().restorePreviousLabel()}},onPause:function(){Z.getController().pauseProgressiveLoading();if((Z.getController().getRoots().length>0||Z._checkHiddenRoots())&&Z.getStatusBar()){Z.getStatusBar().pauseProgresslabel()}},onPerfoClicked:function(){var ad=new l();ad.execute()},onDragEvent:function(ad){var ae=this.set3DDragDropData(o.get());ad.dataTransfer.setData("text",JSON.stringify(ae))}.bind(Z)});aa()})}})});if(!W.getPlatformServicesInBackground){this._readyCheckPromises.push(T)}}else{U()}h.render({renderTo:this.elements.view_container})}if(this.getOption("enableSidePanel")===true){this.elements.main=e.createElement("div",{"class":"enopad3Dviewer_mainTriptych"});this.elements.borderedLayout=e.createElement("div",{"class":"enopad3Dviewer_borderedLayout"}).inject(document.body);this.elements.right=e.createElement("div",{"class":"enopad3Dviewer_rightTriptych rightSidePanel"});var X={left:{resizable:true,originalState:"close",overMobile:true,minWidth:300,withClose:true},container:this.elements.main,withtransition:true,withoverflowhidden:true,right:{resizable:true,originalState:"close",overMobile:true,minWidth:250,withClose:false}};this.elements.triptych=new G();this.elements.triptych.init(X,Z.createRootListSlidder(),this.elements.container,this.elements.right);Z.elements.triptych.togglePanel=function(aa){if(aa==="left"){Z.elements.triptych._modelEvents.publish({event:"triptych-toggle-panel",data:"left"})}else{Z.elements.triptych._modelEvents.publish({event:"triptych-toggle-panel",data:"right"})}};require(["DS/ApplicationFrame/CommandsManager"],function(aa){var ab=aa.getCommand("RootPanel");if(ab){RootPanel.addCallback()}});Z.publish({event:"on3DTriptychReady"})}},_buildComponent:function(V){var W=V.windowOptions?V.windowOptions:{};W.actionbar_corrected=V.actionbar_corrected;if(this._lang){W.language=this._lang}var U=B.getLayout_options("frmWindow_opts");var T=e.extend(U,W,true);this.setDefaultContextualBarVisibility(T.defaultContextualBarVisibility);this.setDefaultContextualMenuVisibility(T.defaultContextualMenuVisibility);if(V.selectiveLoading!==undefined){B.setSetting("enopad3dviewer_selectiveLoading",V.selectiveLoading)}else{if(V.widget&&V.widget.getValue("enopad3dviewer_selectiveLoading")){B.setSetting("enopad3dviewer_selectiveLoading",V.widget.getValue("enopad3dviewer_selectiveLoading"))}}this._initFrameWindow(T)},_initModelController:function(T){var U=this;var V=new D(function(W){U._controller=new s({viewer:U._viewer,context:U,selectiveLoading:T.selectiveLoading,initializeWithWrap:B.getSetting("enopad3dviewer_initializeWithWrap")===true,readyCB:function(){U._controllerTokens.push(U._controller.subscribe({event:"onRootDetached"},function(Y){U._viewer.render({updateInfinitePlane:true});U.reframe();U.publish({event:"onRootDetached",data:Y})}));U._controllerTokens.push(U._controller.subscribe({event:"onContentNameModified"},function(Y){U.publish({event:"onContentNameModified",data:Y.TitleInfo})}));U._controllerTokens.push(U._controller.subscribe({event:"onFilterApplied"},function(Y){if(U.isSelectiveLoadingActivated()){U.getController().getAttributes({ids:Y.filter.objects[0].path,attributes:["ds6w:label"],callbacks:{onComplete:function(Z){if(U.getStatusBar()){U.getStatusBar().setFilter({id:Y.filter.objects[0].path[0],message:Z[Y.filter.objects[0].path[0]]["ds6w:label"]})}},onFailure:function(Z){console.warn("Failed : "+Z)}}})}U.publish({event:"onFilterApplied",data:Y})}));U._controllerTokens.push(U._controller.subscribe({event:"onSearchCompleted"},function(aa){var Y=[],Z=false;if(aa&&aa.selectedPaths){U.applyGraphicPropertiesForFindInCtx(aa.selectedPaths,aa.searchQuery)}if(aa&&aa.selectedPaths&&aa.selectedPaths.length){aa.selectedPaths.forEach(function(ae){var ad=U.unstreamPath(ae);if((U._hideShowController&&!U._hideShowController.isVisible(ad)&&U._viewer.getVisibleSpace()===1)||(U._hideShowController&&U._hideShowController.isVisible(ad)&&U._viewer.getVisibleSpace()===0)){Z=true}Y.push({pathElement:ad})})}if(Y.length){U.lockSelectionBroadcast(true);o.empty();q.empty();var ac=aa.selectedPaths.length>1?P.multipleResultOfSearchInContext:P.singleResultOfSearchInContext;o.add(Y);o.get().forEach(function(ad){q.add(ad)});U.displayNotification({eventID:"info",msg:aa.selectedPaths.length+ac});if(Z){U.displayNotification({eventID:"info",msg:P.selectionInOtherSpace})}var ab=J.getCommand("PAD3DViewerNavigateOnSelectionHdr",U._context);if(ab){ab.execute(aa.selectedPaths).then(function(){U.publish({event:"onSearchCompleted",data:aa})});U.lockSelectionBroadcast(false)}}else{if(aa&&aa.tooManyPath){U.displayNotification({eventID:"info",msg:P.tooManyResultFound})}else{U.displayNotification({eventID:"info",msg:P.emptyResultOfSearchInContext})}U.publish({event:"onSearchCompleted",data:aa})}}));U._controllerTokens.push(U._controller.subscribe({event:"onSearchFailure"},function(Y){U.displayNotification({eventID:"error",msg:P.searchInContextFailed});U.publish({event:"onSearchFailure",data:Y})}));U._controllerTokens.push(U._controller.subscribe({event:"onRootAttached"},function(Y){if(U._dropZoneContainer){U._dropZoneContainer.hide()}U._viewer.render({updateInfinitePlane:true});U.reframe();U.publish({event:"onRootAttached",data:Y})}));U._controllerTokens.push(U._controller.subscribe({event:"onBeginRootRemoved"},function(Y){if(Y.dispatch===false){U.lockSelectionBroadcast(true)}}));U._controllerTokens.push(U._controller.subscribe({event:"onRootRemoved"},function(Z){if(!U.getController().getNbRoots()&&(!U.getController().getHiddenRootIds().length)&&U._dropZoneContainer){U._dropZoneContainer.show("drop");if(U.getStatusBar()){U.getStatusBar().setIsPaused(false);U.getStatusBar().resetPreviousLabel();U.getStatusBar().setLoader({status:"off"})}}U._viewer.render({updateInfinitePlane:true});if(Z.reframe){if(B.getSetting("enopad3dviewer_lightNodeModel")===true){if(U.getController()._model.getOOCManager().getReframeBoundingSphere){var Y=U.getController()._model._OOCManager.getReframeBoundingSphere();if(Y.radius!==0){U.reframe(Y)}else{U.reframe()}}}else{U.reframe()}}U.publish({event:"onRootRemoved",data:Z});if(Z.dispatch===false){U.lockSelectionBroadcast(false)}}));U._controllerTokens.push(U._controller.subscribe({event:"onBeginReplaceInstance"},function(){U.publish({event:"onBeginReplaceInstance",})}));U._controllerTokens.push(U._controller.subscribe({event:"onEndReplaceInstance"},function(Y){U.publish({event:"onEndReplaceInstance",data:Y});U.publish({event:"onModelUpdated",data:Y})}));U._controllerTokens.push(U._controller.subscribe({event:"onEndMatriceUpdate"},function(Y){U._viewer.render({updateInfinitePlane:true});U.publish({event:"onEndMatriceUpdate",data:Y});U.publish({event:"onModelUpdated",data:{rootNodes:U.getRoots()}})}));U._controllerTokens.push(U._controller.subscribe({event:"onBeginRootLoading"},function(Y){U._lastReframeRequiered=0;if(U._dropZoneContainer){U._dropZoneContainer.hide()}U.publish({event:"onBeginRootLoading"})}));U._controllerTokens.push(U._controller.subscribe({event:"onProgress"},function(Y){if(U.getDefaultProgressBarVisibility()){h.setText(Y.message);if(Y.progress%20===0&&Y.progress!==U._lastReframeRequiered){U._lastReframeRequiered=Y.progress;if(Y.reframe){U.reframe()}else{U._viewer.render({updateInfinitePlane:true})}}}else{U.publish({event:"onProgress",data:Y})}}));U._controllerTokens.push(U._controller.subscribe({event:"onRootAdded"},function(Y){U._viewer.render({updateInfinitePlane:true});if(Y.reframe){U.reframe(Y.BS)}if(Y.displayNotif){if(Y.hidden){U.displayNotification({eventID:"info",msg:P.addonDetachedRootSuccessNotif})}else{U.displayNotification({eventID:"success",msg:Y.inContext?P.addRootInContextSuccessNotif:P.addRootSuccessNotif})}}U.publish({event:"onRootAdded",data:Y})}));U._controllerTokens.push(U._controller.subscribe({event:"onApplyFilterBegin"},function(Y){U.publish({event:"onApplyFilterBegin",data:Y})}));U._controllerTokens.push(U._controller.subscribe({event:"onApplyFilterEnd"},function(Y){U.publish({event:"onApplyFilterEnd",data:Y})}));U._controllerTokens.push(U._controller.subscribe({event:"onReframe"},function(Y){if(!window.ENOPADNoReframe){if(Y.BS){U.getViewpoint().reframe(undefined,0,Y.BS)}if(!Y.rootBS){setTimeout(function(){U.reframe()},3000)}}}));U._controllerTokens.push(U._controller.subscribe({event:"onRootAlreadyExisting"},function(Y){U.displayNotification({eventID:"info",msg:P.rootAlreadyLoadedNotif});if(U._dropZoneContainer){U._dropZoneContainer.hide()}U.publish({event:"onRootAlreadyExisting",data:Y})}));U._controllerTokens.push(U._controller.subscribe({event:"onRetrieveFilterFailure"},function(aa){for(var Y=0;Y<aa.failure.length;Y++){var ab={msg:aa.failure[Y].msg,eventID:aa.failure[Y].eventID};U.displayNotification(ab)}if(U.checkIfEmpty()){if(U._dropZoneContainer){U._dropZoneContainer.show("drop")}var Z=require("DS/PADServices/utils/GlobalModelEvents");var ac=Z.getModelEvents();ac.publish({event:"ENXViews/WelcomePanel/activate"})}else{if(U._dropZoneContainer){U._dropZoneContainer.hide()}}}));U._controllerTokens.push(U._controller.subscribe({event:"onComplete"},function(Y){if(!U.isSelectiveLoadingActivated()){U._viewer.render({updateInfinitePlane:true})}if(Y.reframe){U.reframe(Y.BS)}if(Y.intend==="addRoot"){U.publish({event:"onComplete",data:{intend:"addRoot"}})}U.publish({event:"onLoadingComplete"});if(U.updatePager===true){U.updatePager=false;U.publish({event:"onUpdatePager",data:U.pagerData})}}));U._controllerTokens.push(U._controller.subscribe({event:"onLoadingFailure"},function(Z){if(!U._controller.getNbRoots()&&!U._checkHiddenRoots()&&U._dropZoneContainer&&!U._controller.isRunning()){U._dropZoneContainer.show("drop")}if(Z.displayNotif){var aa=P.addRootFailureNotif;var Y="error";if(Z&&Z.message){aa=Z.message}if(Z&&Z.eventID){Y=Z.eventID}U.displayNotification({eventID:Y,msg:aa})}U.publish({event:"onLoadingFailure"})}));U._controllerTokens.push(U._controller.subscribe({event:"onLoadingCanceled"},function(Y){if(!U._controller.getNbRoots()&&!U._checkHiddenRoots()&&U._dropZoneContainer){U._dropZoneContainer.show("drop")}var Z=P.addRootFailureNotif;if(Y&&Y.message){Z=Y.message}U.displayNotification({eventID:"info",msg:Z});U.publish({event:"onLoadingCanceled"})}));U._controllerTokens.push(U._controller.subscribe({event:"startAsync"},function(Z){var Y=Z===undefined||Z.userFeedback===undefined?true:Z.userFeedback;if(Y){U._frmWindow.getActionBar()._afr.elements.container.addClassName("enopad3Dviewer_actionbar_disabled");if(U.getDefaultProgressBarVisibility()){h.on(undefined,Z.onCancel,A.PADProgressBar_cancelAll);if(U.isSelectiveLoadingActivated()&&U.getStatusBar()){U.getStatusBar().setLoader({status:"hide"})}}else{U.publish({event:"onStartAsync"})}}else{U.publish({event:"onStartAsync"})}}));U._controllerTokens.push(U._controller.subscribe({event:"stopAsync"},function(Z){var Y=Z===undefined||Z.userFeedback===undefined?true:Z.userFeedback;if(Y){U._frmWindow.getActionBar()._afr.elements.container.removeClassName("enopad3Dviewer_actionbar_disabled");if(U.getDefaultProgressBarVisibility()){h.off();if(U.isSelectiveLoadingActivated()&&U.getStatusBar()){U.getStatusBar().setLoader({status:"show"})}}else{U.publish({event:"onStopAsync"})}}else{U.publish({event:"onStopAsync"})}}));U._controllerTokens.push(U._controller.subscribe({event:"onMove"},function(Y){U.publish({event:"onMove",data:Y})}));U._controllerTokens.push(U._controller.subscribe({event:"onEndReparent"},function(ab){if(ab.createdNode){var aa=U.getController().getRootBag();var ac=I.buildPathesLeadingToNode(ab.createdNode,aa);var Y=[];for(var Z=0;Z<ac.length;Z++){Y.push({pathElement:ac[Z]})}U.lockSelectionBroadcast(true);o.add(Y);q.add(Y);U.lockSelectionBroadcast(false)}U._viewer.render({updateInfinitePlane:true});U.reframe();U.displayNotification({eventID:"success",msg:P.reparentSuccessful});U.publish({event:"onEndReparent",data:ab});U.publish({event:"onModelUpdated",data:ab})}));U._controllerTokens.push(U._controller.subscribe({event:"onBeginReparent"},function(Y){U.publish({event:"onBeginReparent",data:Y})}));U._controllerTokens.push(U._controller.subscribe({event:"onReparentFailure"},function(Y){var Z=P.reparentFailure;if(Y&&Y.message){Z=Y.message}U.displayNotification({eventID:"error",msg:Z});U.publish({event:"onReparentFailure"})}));U._controllerTokens.push(U._controller.subscribe({event:"onInsertExistingFailure"},function(Y){var Z=P.insertFailure;if(Y&&Y.message){Z=Y.message}U.displayNotification({eventID:"error",msg:Z});U.publish({event:"onInsertExistingFailure"})}));U._controllerTokens.push(U._controller.subscribe({event:"onInsertExisting"},function(ab){if(ab.createdNode&&ab.insertedNode){var aa=U.getController().getRootBag();var ac=I.buildPathesLeadingToNode(ab.createdNode,aa);var Y=[];for(var Z=0;Z<ac.length;Z++){ac[Z].addElement(ab.insertedNode);Y.push({pathElement:ac[Z]})}o.add(Y);q.add(Y)}U._viewer.render({updateInfinitePlane:true});U.reframe();U.displayNotification({eventID:"success",msg:P.insertSuccessful});U.publish({event:"onInsertExisting",data:ab});U.publish({event:"onModelUpdated",data:ab})}));U._controllerTokens.push(U._controller.subscribe({event:"onStreamSwitched"},function(Y){U.publish({event:"onStreamSwitched"});U.publish({event:"onModelUpdated",data:{rootNodes:U.getRoots()}})}));U._controllerTokens.push(U._controller.subscribe({event:"onStreamSwitchFailure"},function(Y){U.publish({event:"onStreamSwitchFailure"})}));U._controllerTokens.push(U._controller.subscribe({event:"onGeometryRefreshed"},function(Y){U.publish({event:"onGeometryRefreshed"});U.publish({event:"onModelUpdated",data:{rootNodes:U.getRoots()}})}));U._controllerTokens.push(U._controller.subscribe({event:"onRefreshGeometryFailure"},function(Y){U.publish({event:"onRefreshGeometryFailure"})}));U._controllerTokens.push(U._controller.subscribe({event:"onEndDelete"},function(Y){U._viewer.render({updateInfinitePlane:true});U.reframe();U.displayNotification({eventID:"success",msg:P.deleteSuccessful});U.publish({event:"onEndDelete",data:Y});U.publish({event:"onModelUpdated",data:Y});U.lockSelectionBroadcast(false)}));U._controllerTokens.push(U._controller.subscribe({event:"onCompletionCompleted"},function(Y){U._viewer.render({updateInfinitePlane:true});U.displayNotification({eventID:"info",msg:Y.nbPathLoaded+P.completionCompleted});U.publish({event:"onCompletionCompleted"});U.publish({event:"onModelUpdated",data:Y})}));U._controllerTokens.push(U._controller.subscribe({event:"onBeginDelete"},function(Y){U.lockSelectionBroadcast(true);U.publish({event:"onBeginDelete",data:Y})}));U._controllerTokens.push(U._controller.subscribe({event:"onDefaultStreamChanged"},function(Z){if(Z.newStream){var Y=Z.newStream==="cgr";U.changeVisuModeCmdAvailability(Y)}U.publish({event:"onDefaultStreamChanged",data:Z})}));U._controllerTokens.push(U._controller.subscribe({event:"onIndexAvalabilityChange"},function(Y){U.publish({event:"onIndexAvalabilityChange",data:Y})}));U._controllerTokens.push(U._controller.subscribe({event:"onEndRootRemoved"},function(Y){U.publish({event:"onEndRootRemoved",data:Y})}));U._controllerTokens.push(U._controller.subscribe({event:"onRefreshCompleted"},function(Y){if(!U._controller.getNbRoots()&&!U._checkHiddenRoots()&&U._dropZoneContainer){U._dropZoneContainer.show("drop")}U.displayNotification({eventID:"info",msg:P.refreshCompleted});U.publish({event:"onRefreshCompleted",data:Y})}));U._controllerTokens.push(U._controller.subscribe({event:"onRefreshBegin"},function(Y){U.publish({event:"onRefreshBegin",data:Y})}));U._controllerTokens.push(U._controller.subscribe({event:"onAuthoringSwitch"},function(Y){if(Y.message&&Y.message!==""){U.displayNotification({eventID:"info",msg:Y.message})}U.getController().refreshAppliedFilters();U.publish({event:"onAuthoringSwitch",data:Y})}));U._controllerTokens.push(U._controller.subscribe({event:"onAuthoringTransactionBegin"},function(){o.empty();q.empty();U.publish({event:"onAuthoringTransactionBegin"})}));U._controllerTokens.push(U._controller.subscribe({event:"onAuthoringTransactionEnd"},function(){U.publish({event:"onAuthoringTransactionEnd"})}));U._controllerTokens.push(U._controller.subscribe({event:"onExpandCompleted"},function(Y){if(Y.displayNotif){U.displayNotification({eventID:"info",msg:P.expandCompleted})}U.publish({event:"onExpandCompleted"});U.publish({event:"onModelUpdated",data:Y})}));U._controllerTokens.push(U._controller.subscribe({event:"onDisableUX"},function(Y){require(["DS/UIKIT/Modal"],function(Z){U.elements.container.blockUX=new Z({className:"disableMainUX",closable:false,body:"",visible:true});U.elements.container.blockUX.inject(document.body)})}));U._controllerTokens.push(U._controller.subscribe({event:"onEnableUX"},function(Y){if(U.elements.container.blockUX){U.elements.container.blockUX.destroy();delete U.elements.container.blockUX}if(U.elements.container.blockActionBar){U.elements.container.blockActionBar.destroy();delete U.elements.container.blockActionBar}if(document.querySelector(".enopad3Dviewer_actionbar_disabled")){U._frmWindow.getActionBar()._afr.elements.container.removeClassName("enopad3Dviewer_actionbar_disabled")}}));U._controllerTokens.push(U._controller.subscribe({event:"onDisableActionBar"},function(Y){U._frmWindow.getActionBar()._afr.elements.container.addClassName("enopad3Dviewer_actionbar_disabled")}));U._controllerTokens.push(U._controller.subscribe({event:"PGPPostProcess"},function(Y){if(Y.hiddenPaths&&Y.hiddenPaths.length){var Z=[];Y.hiddenPaths.forEach(function(ab){var aa=U.unstreamPath(ab);Z.push(aa)});U.getHideShowController().hide({paths:Z,dispatch:false})}if((Y.references&&Y.references.length)||(Y.instances&&Y.instances.length)||(Y.occurrences&&Y.occurrences.length)){U.getBIController().applyPGPColor(Y);U.getHideShowController().applyPGPHideShow(Y)}}));U._controllerTokens.push(U._controller.subscribe({event:"onStartProgressiveLoad"},function(Y){if(U.isSelectiveLoadingActivated()){if(U.getStatusBar()){U.getStatusBar().setLoader({status:"on"});U.getStatusBar().setProgressLabel(P.PADStatus_loadingData);U.getStatusBar().clearWarning()}}U.publish({event:"onStartProgressiveLoad",data:Y})}));U._controllerTokens.push(U._controller.subscribe({event:"onEndProgressiveLoad"},function(Y){if(U.isSelectiveLoadingActivated()&&U.getStatusBar()){U.getStatusBar().setLoader({status:"off"});if(U.getRoots().length===0&&!U._checkHiddenRoots()){U.getStatusBar().setIsPaused(false);U.getStatusBar().resetProgressLabel()}else{if(Y.memoryFull===true){U.getStatusBar().setCustomProgressLabel({label:P.PADStatus_loadingStopped,tooltip:P.progressiveExpandFullMemory,severity:"warning"})}else{U.getStatusBar().setCustomProgressLabel({label:P.PADStatus_loadingComplete,tooltip:P.PADStatus_loadingComplete,severity:"success"})}}}U.publish({event:"onEndProgressiveLoad",data:Y})}));var X=false;U._controllerTokens.push(U._controller.subscribe({event:"onFilterRemoved"},function(Y){this._filteredIdToReload.push(Y.id);if(this.getStatusBar()){this.getStatusBar().clearFilter({id:Y.id})}if(!B.getSetting("enopad3dviewer_lightNodeModel")){if(X===false){X=true;require(["DS/ENOPAD3DViewer/views/PAD3DRemoveFilterPanel"],function(Z){var aa=new Z({container:U.elements.container,events:{onValidate:function(ab){X=false;if(ab){this.getController().removeFilterFullReload(this._filteredIdToReload)}this._filteredIdToReload=[]}.bind(this)}})}.bind(this))}}this.publish({event:"onFilterRemoved",data:Y})}.bind(U)));U._controllerTokens.push(U._controller.subscribe({event:"onUrlLoaded"},function(Y){U.publish({event:"onUrlLoaded",data:{nbCgrLoaded:Y.nbCgrLoaded,nbThbLoaded:Y.nbThbLoaded}})}));U._controllerTokens.push(U._controller.subscribe({event:"onVQDisabled"},function(Y){U.displayNotification({eventID:"warning",msg:P.queryFailed_VQDisabled})}));U._controllerTokens.push(U._controller.subscribe({event:"onLeafReferenceLoaded"},function(Y){U.publish({event:"onLeafReferenceLoaded",data:Y})}));U._controllerTokens.push(U._controller.subscribe({event:"onLeafReferenceUnloaded"},function(Y){U.publish({event:"onLeafReferenceUnloaded",data:Y})}));U.subscribe({event:"onFilterDropped"},function(){U.clearWidgetBorder()});W()}})});this._readyCheckPromises.push(V);return V},getCommandContext:function(){return this._context},changeVisuModeCmdAvailability:function(V){var ae=this.getCommandContext();var Z=J.getCommandCheckHeader("VisuFilterLines",ae);if(Z){if(V===true){Z.enable()}else{Z.disable()}}var ab=J.getCommandCheckHeader("VisuFilterPoints",ae);if(ab){if(V===true){ab.enable()}else{ab.disable()}}var ac=J.getCommandCheckHeader("VisuFilterAxis",ae);if(ac){if(V===true){ac.enable()}else{ac.disable()}}var Y=J.getCommand("VisuNoShadingEdges",ae);if(Y){if(V===true){Y.enable()}else{Y.disable()}}var W=J.getCommand("VisuShading",ae);if(W){if(V===true){W.enable()}else{W.begin()}}var X=J.getCommand("VisuShadingEdges",ae);if(X){if(V===true){X.enable()}else{X.disable()}}var ad=J.getCommand("VisuShadingEdgesNoSmoothEdges",ae);if(ad){if(V===true){ad.enable()}else{ad.disable()}}var aa=J.getCommand("VisuShadingEdgesHiddenEdges",ae);if(aa){if(V===true){aa.enable()}else{aa.disable()}}var U=J.getCommand("VisuShadingMaterial",ae);if(U){if(V===true){U.enable()}else{U.disable()}}var T=J.getCommand("VisuShadingMaterialEdges",ae);if(T){if(V===true){T.enable()}else{T.disable()}}},_initHideShowController:function(){var T=this;require(["DS/ENOPAD3DViewer/controller/PAD3DViewerHideShowController"],function(U){T._hideShowController=new U({context:T,viewer:T._viewer});T._hideShowControllerTokens.push(T._hideShowController.subscribe({event:"onHide"},function(V){T.publish({event:"onHide",data:V})}));T._hideShowControllerTokens.push(T._hideShowController.subscribe({event:"onShow"},function(V){T.publish({event:"onShow",data:V})}));T._hideShowControllerTokens.push(T._hideShowController.subscribe({event:"onExclusiveShow"},function(V){T.publish({event:"onExclusiveShow",data:V})}))})},_initFrameWindow:function(V){var U=this;y.set(this);V.context=V.context===undefined?null:V.context;V.viewerOptions.showReferenceAxisSystem=V.viewerOptions.showReferenceAxisSystem===undefined?true:V.viewerOptions.showReferenceAxisSystem;var T=null;if(V.workbench&&V.workbenchModule){T={workbench:V.workbench,workbenchModule:V.workbenchModule,};delete V.workbench;delete V.workbenchModule}this._context=V.context;this._readyCheckPromises.push(new D(function(W){V.uiOptions.displayTree=false;U.fWInitProbe=w.createProbe("FrameWindow3D_init");U.viewerInitProbe=w.createProbe("3DViewer_init");U._frmWindow=new t(V).inject(U.elements.view_container);U._frmWindow.onReady(function(){U._viewer=U._frmWindow.getViewer();U._robotVisibility=V.robotVisibility;if(V.viewerOptions.showReferenceAxisSystem){U._viewer.setRobot(U._robotVisibility,{snapOnFace:true})}U._viewer.setPicking(V.viewerOptions.highlight);U._viewer.setPrePicking(V.viewerOptions.pHighlight);U._viewer.displayPoints(true);U._viewer.restoreVisualizationMode();U._viewer.restoreAmbiance();U.getViewpoint().setDefaultController(true,V.mouseProfile);if(V.viewpointProjectionType!==undefined){var X=V.viewpointProjectionType==="PERSPECTIVE"?0:1;U.getViewpoint().setProjectionType(X)}else{U._viewer.restoreProjectionMode()}U.viewerInitProbe.end();delete U.viewerInitProbe;U.defAbDisplayProbe=w.createProbe("defaultActionBarDisplay");U.defAbReadyProbe=w.createProbe("defaultActionBarReady");U._frmWindow.getContextualUIManager().activateContextualBarOnLeftClicAfterCSOChange();if(V.contextualMenuContent&&V.contextualMenuContent.workbenchName&&V.contextualMenuContent.module&&V.contextualMenuContent.fileName){U._frmWindow.getContextualUIManager().register({workbenchName:V.contextualMenuContent.workbenchName,module:V.contextualMenuContent.module,cmdPrefix:"",fileName:V.contextualMenuContent.fileName,context:U.getCommandContext(),onContextualMenuReady:function(ad,aa){var ac=U.getViewer();var af=J.getCommand("FlyWalk",U.getCommandContext());var ae=true;if(af){ae=!af._isRunning}if(ae&&U._defaultContextualMenuVisibility&&undefined!==aa&&undefined!==aa.XmousePositionWithDevPxRatio&&undefined!==aa.YmousePositionWithDevPxRatio&&ac){var Z=ac.pick({xPix:aa.XmousePositionWithDevPxRatio,yPix:aa.YmousePositionWithDevPxRatio},"mesh",true).path;var Y=Z.length===0?true:false;var ab=[];if(Y){V.contextualMenuContent.emptiness.forEach(function(ah){ab.push({name:ah.name,line:1,hdr_list:[ah.header]})})}else{var ag=o.get();if(ag.length>0){if(U._areValidPaths(ag)){V.contextualMenuContent.geometry.forEach(function(ah){if(ah.header==="ActionBar_Attributes"){if(U._propertiesCommandAvailability){ab.push({name:ah.name,line:1,hdr_list:[ah.header]})}}else{ab.push({name:ah.name,line:1,hdr_list:[ah.header]})}})}}}return ab.length?{cmdList:ab}:undefined}},onContextualBarReady:function(ac,ab){var ad=U.getViewer();if(U._defaultContextualBarVisibility&&undefined!==ab&&undefined!==ab.XmousePositionWithDevPxRatio&&undefined!==ab.YmousePositionWithDevPxRatio&&ad){var Y=ad.pick({xPix:ab.XmousePositionWithDevPxRatio,yPix:ab.YmousePositionWithDevPxRatio},"mesh",true).path.length===0?true:false;if(Y){}else{var aa=[];var Z=o.get();if(Z.length>0){if(U._areValidPaths(Z)){if(Z.length===1){if(Z[0].pathElement.externalPath.length===2){aa.push({name:"RemoveRoot",line:1,hdr_list:["RemoveRootHdr"]})}else{aa.push({name:"LevelSelector",line:1,hdr_list:["LevelSelectorHdr"]})}}}}return aa.length?{cmdList:aa}:undefined}}}})}U._initModelController(V).then(function(){if(T){U.loadActionBar(T);U._actionBarTokens.push(U._frmWindow.onActionBarReady(function(){if(U._firstInit){U._firstInit=false;U._controller._setDefaultStreamToLoad(B.getSetting("enopad3dviewer_CGRorTHB"));U.defAbReadyProbe.end();delete U.defAbReadyProbe;U.fWInitProbe.end();delete U.fWInitProbe;U.initProbe.end();delete U.initProbe}else{if(U.abReadyProbe){U.abReadyProbe.end();delete U.abReadyProbe}}U.publish({event:"onActionBarReady",data:U});if(U._readyCheckPromises&&T){W()}else{U.publish({event:"onReady",data:U})}}))}U._initHideShowController();if(V.allowDnD){U._initDnD()}U._initInterwidgetCom();U._initCSOEvent(V);U.initFindInContextColorizedSubscription();if(undefined!==V.BIMode&&"OFF"!==V.BIMode){U.getController().toggleBetweenStandaloneAndSlaveMode(V.BIMode);if(V.BIMode==="STANDALONE"){U._isVolumeFilter=false}}setTimeout(function(){U.publish({event:"onViewerReady",data:U});if(!T){W()}})})})}))},_checkHiddenRoots:function(){var U=this;var T=U._controller.getHiddenRootIds()?U._controller.getHiddenRootIds().length:0;if(T===0){return false}else{return true}},_initDnD:function(){var T=this;if(!B.getSetting("activate_newDropInvite")){require(["DS/PADUtils/views/PADDnDInvite"],function(W){T._dropZoneContainer=new W({renderTo:T.elements.container,mode:"inviteWithFilter",filterActive:B.getSetting("enopad3dviewer_FilterAvailable"),dropOnInvite:function(aa){V(aa)}});function Z(aa){aa.preventDefault();T.addWidgetBorder();if(aa.shiftKey){T._dropZoneContainer.show("add_as_object")}else{T._dropZoneContainer.show("add_in_context")}}T._dndCB[0]=(Z);function Y(aa){T.clearWidgetBorder();if(T.getRoots().length===0&&!T._checkHiddenRoots()){T._dropZoneContainer.show("drop")}else{T._dropZoneContainer.hide()}}T._dndCB[1]=(Y);function V(aa){aa.preventDefault();aa.stopPropagation();if(T.elements.container.contains(aa.target)){T._dropZoneContainer.hide();var ab=true;if(aa.shiftKey){ab=false}T.addRootNodesFromContent({dndEvent:aa,dispatch:true,inContext:ab});T.clearWidgetBorder()}}T._dndCB[2]=(V);function U(aa){aa.preventDefault();T.clearWidgetBorder();if(aa.shiftKey){T._dropZoneContainer.show("add_as_object")}else{T._dropZoneContainer.show("add_in_context")}}T._dndCB[3]=(U);function X(aa){if(aa.relatedTarget==null||!aa.relatedTarget.classList.contains("paddnd_invite_container")){T._dropZoneContainer.hide();if(T.getRoots().length===0){T._dropZoneContainer.show()}T.clearWidgetBorder()}}T._dndCB[4]=(X);T.elements.container.addEventListener("dragenter",U);T.elements.container.addEventListener("dragover",Z);T.elements.container.addEventListener("dragleave",X);T.elements.container.addEventListener("dragend",Y);T.elements.container.addEventListener("drop",V)})}},addRootNodesFromContent:function(U){var V=this;U.dispatch=undefined===U.dispatch?true:U.dispatch;U.inContext=undefined===U.inContext?true:U.inContext;var T=null;if(U.json3DXContent){T=e.is(U.json3DXContent,"string")?JSON.parse(U.json3DXContent):U.json3DXContent}var W=U.dndEvent?{dataTransfer:U.dndEvent.dataTransfer}:undefined;N.retrieveAuthorizedObjects({displayNotif:false,X3DContentId:T?T:undefined,dnd_event:W?W:undefined,callback:function(Z){if(Z.unauthorized_objects.length){Z.unauthorized_objects.forEach(function(aa){if(V._loadingDelegations&&V._loadingDelegations["_"+aa.objectType]){var ab=V._loadingDelegations["_"+aa.objectType];ab(aa)}else{V.displayNotification({msg:A.replace(A.get("unsupported_type"),{type:aa.displayType,name:aa.displayName}),eventID:"warning"});if(V.getRoots().length===0&&!V._checkHiddenRoots()){require(["DS/PADServices/utils/GlobalModelEvents"],function(ac){var ad=ac.getModelEvents();ad.publish({event:"ENXViews/WelcomePanel/activate"})})}}})}if(Z.authorized_objects.length===0){if(V.getRoots().length===0&&!V._checkHiddenRoots()&&V._dropZoneContainer){V._dropZoneContainer.show("drop");require(["DS/PADServices/utils/GlobalModelEvents"],function(aa){var ab=aa.getModelEvents();ab.publish({event:"ENXViews/WelcomePanel/activate"})})}}else{var X=V.getRoots(),Y=Z.authorized_objects;p.multiTenantMgt(Y,X,function(aa){if(!aa.isMultiTenant){if(Z.authorizedWithKind){if(Z.authorizedWithKind.Product&&Z.authorizedWithKind.Product.length>0){var ab=[];Z.authorizedWithKind.Product.forEach(function(ac){var ad=ac.path&&U.inContext?ac.path.map(function(ae){return ae.resourceid}):[ac.objectId];ab.push({path:ad})});V.addRoots({objects:ab},U.dispatch)}if(Z.authorizedWithKind.Filter&&Z.authorizedWithKind.Filter.length>0){if(V.getController().isStandaloneFilterAvailable()===true){if(U.dispatch!==false){V._commandProxy.dropFilter3D({droppedFilters:Z.authorizedWithKind.Filter,broadcast:false})}V.getController().retrieveFilters(Z)}else{if(V.getController().isSlaveFilterAvailable()===true){V._commandProxy.dropFilter3D({droppedFilters:Z.authorizedWithKind.Filter})}else{if(V.getRoots().length===0&&!V._checkHiddenRoots()&&V._dropZoneContainer){V._dropZoneContainer.show("drop");require(["DS/PADServices/utils/GlobalModelEvents"],function(ac){var ad=ac.getModelEvents();ad.publish({event:"ENXViews/WelcomePanel/activate"})})}}}}if(Z.authorizedWithKind.Change&&Z.authorizedWithKind.Change.length>0){V.loadChange({objects:Z.authorizedWithKind.Change})}}else{var ab=[];Z.authorized_objects.forEach(function(ac){var ad=ac.path&&U.inContext?ac.path.map(function(ae){return ae.resourceid}):[ac.objectId];ab.push({path:ad})});V.addRoots({objects:ab},U.dispatch)}}V=null})}},version:"2.0"})},_areValidPaths:function(V){var U=true;if(V){for(var T=0;T<V.length;T++){if(!u.isAModelPath(V[T].pathElement)){U=false;break}}}return U},_initCSOEvent:function(X){var V=this;if(this.isInterwidgetComAvailable()){var W=function(){if(!V._lockCSONotification&&!V._lockCSONotificationEmpty){var ag=[];var af=[];var ab={};var ae=[];var ah=o.get();var Y={version:"1.1",paths:ag,POIs:af,attributes:ab,sharedID:p.getSharedId(),focusOn:V._reframeFocus};ah.forEach(function(ai){if(u.isAModelPath(ai.pathElement)){V.streamPathWithType(ai.pathElement,ag,ab)}if(u.isAPOIPath(ai.pathElement)){V.streamPOI(ai.pathElement,af);V.getDecorationBag()}});if(B.getSetting("authorizeChangeControl")){var ac=require("DS/CfgAuthoringContextUX/scripts/CfgAuthoringContext");Y.changeControl=ac.get()}var aa=V._searchRecent?V._searchRecent:false;if(aa===true){Y.searchDone=aa}V._commandProxy.select(Y);if(V._authorizeSet3DStructure===true){if(ag){ag.forEach(function(ai){ae.push(ai[ai.length-1])})}V.set3DXContentData({nodes2Open:ae,selectedPaths:Y});if(B.getSetting("settypes")!==true){var Z=V.set3DStructure4OpenInCV5({nodes2Open:ae,selectedPaths:Y});var ad=JSON.stringify(Z);x.publish("setStructure",{structure:ad})}else{V.setTypesFor3D(Y)}}}};if(o.onPostAdd){V._csoTokens.push(o.onPostAdd(W))}if(V.isSelectiveLoadingActivated()&&o.onChange){V._csoTokens.push(o.onChange(H.debounce(function(){if(V.getStatusBar()){var Y=o.get().length;if(Y){V.getStatusBar().setSelection({length:Y})}else{V.getStatusBar().clearSelection()}}})))}if(o.onPostRemove){V._csoTokens.push(o.onPostRemove(W))}else{V._csoTokens.push(o.onRemove(H.debounce(W,100)))}V._csoTokens.push(o.onPreEmpty(function(){V._lockCSONotificationEmpty=true}));V._csoTokens.push(o.onEmpty(function(){V._lockCSONotificationEmpty=false;if(!V._lockCSONotification){V._commandProxy.select({paths:[],sharedID:p.getSharedId(),focusOn:V._reframeFocus})}}));function U(Z){if(!Z||!Z.pathElement||!Z.pathElement.externalPath.length||!u.isAModelPath(Z.pathElement)){return Z}else{var aa=Z.pathElement;var Y=aa.getLastElement(true);while(aa&&!u.isReference(Y)){aa=aa.getParentPath();if(aa){Y=aa.getLastElement(true)}}Z.pathElement=aa;return Z}}function T(aa){if(!V._lockCSONotification&&B.getSetting("enopad3dviewer_selectionFilter")==="PRODUCT"){if(aa instanceof Array){var Z=0,Y=aa.length;for(Z=0;Z<Y;Z++){if(aa[Z].event){U(aa[Z])}}}else{if(aa.event){U(aa)}}}}V._psoTokens.push(a.onPreAdd(T));V._csoTokens.push(o.onPreAdd(T));V._hsoTokens.push(q.onPreAdd(T))}},set3DXContentData:function(U){if(!e.is(U.nodes2Open,"array")){throw new Error("set3DXContentData: Invalid init parameter nodes2Open")}var T=e.is(widget)&&widget.id?"padcompassSocket_"+widget.id:"padcompassSocket";if(n===null){n=new M.Socket(T);n.subscribeServer("com.ds.compass",window.parent)}if(U.nodes2Open.length===0){n.dispatchEvent("onResetX3DContent",{},T)}else{var V={protocol:"3DXContent",version:"1.0",source:widget&&widget.getValue("x3dAppId")?widget.getValue("x3dAppId"):"ENOSTDE_AP",data:{items:[]}};U.selectedPaths.paths.forEach(function(X){var Y=function(Z){var aa=[];Z.forEach(function(ab){aa.push({resourceid:ab,type:U.selectedPaths.attributes[ab].type})});return aa};var W=X[X.length-1];V.data.items.push({envId:p.getPlatformId(),serviceId:"3DSpace",contextId:B.getSetting("pad_security_ctx")?B.getSetting("pad_security_ctx"):undefined,objectId:W,objectType:U.selectedPaths.attributes[W].type,path:Y(X)})});n.dispatchEvent("onSetX3DContent",V,T)}},set3DDragDropData:function(T){var V={protocol:"3DXContent",version:"1.1",source:this.getWidget()&&this.getWidget().getValue("x3dAppId")?this.getWidget().getValue("x3dAppId"):"tmp",widgetId:p.getWidgetId(),data:{items:[]}};var U=this;T.forEach(function(Y){if(u.isAModelPath(Y.pathElement)){var ab=U.streamPath(Y.pathElement);var aa=U.getController().getNode({id:ab[ab.length-1]});if(ab.length>0){}var W=[];for(var X=0;X<ab.length;++X){var Z=U.getController().getNode({id:ab[X]});W.push({resourceid:ab[X],type:u.getNodeType(Z)})}V.data.items.push({envId:p.getPlatformId(),serviceId:"3DSpace",contextId:B.getSetting("pad_security_ctx")?B.getSetting("pad_security_ctx"):undefined,objectId:u.getNodeID(aa),objectType:u.getNodeType(aa),path:W})}});return V},buildStructure:function(U,T,W,Y){var V=0;for(var X in U){var Z=[];if((T[X].selected===true)&&(Y.length===0||(Y.length>0&&Y.indexOf(T[X].nodeId)!==-1))){W.push({id:T[X].idx,show:T[X].show,select:T[X].selected,children:[]})}else{W.push({id:T[X].idx,show:T[X].show,children:[]})}Z=this.buildStructure(U[X],T,W[V].children,Y);if(Z){W.push({children:Z})}V++}},setTypesFor3D:function(U){var V=this;if(!E){x.subscribe("setTypesCallback",function(ac){if(ac.widgetId===p.getWidgetId()){var af=[];var Z={};var aa=[];var ae=[];var ab=[];var ag=o.get();var X=V.getController()._model.getRootBag();var ad=[];var Y={version:"1.1",paths:af,attributes:Z};V.getRoots().forEach(function(ah){ad.push(u.getNodeID(ah))});ag.forEach(function(aj){if(u.isAModelPath(aj.pathElement)){var ak=aj.pathElement;var ai=ak.getLastElement(true);var ah=u.getNodeID(ai);if(ad.indexOf(ah)!==-1){af.push([ah])}if(ai.is3DLeaf){if(!ai.is3DLeaf()){var al={};ai.traverse(function(am){if(am.is3DLeaf&&am.is3DLeaf()&&!al[am.getID()]){al[am.getID()]=true;var an=I.buildPathesLeadingToNode(am,X);an.forEach(function(ao){if(ak.isAParentOf(ao)){aa.push(ao)}})}});aa.forEach(function(am){if(!V._hideShowController.isVisible(am)){ab.push(am.getLastElement(true).getID())}V.streamPathWithType(am,af,Z)})}else{V.streamPathWithType(aj.pathElement,af,Z)}}else{V.streamPathWithType(aj.pathElement,af,Z)}}});if(af){af.forEach(function(ah){ae.push(ah[ah.length-1])})}V.setTypesForOFW({nodes2Open:ae,hiddenNodes:ab,selectedPaths:Y},function(ak){var ai=V.getViewpoint();var ah=r.buildViewPoint(ai);if(ah!==null){ak.viewpoint.push(ah)}if(U.changeControl){ak.workUnder=U.changeControl}var al=JSON.stringify(ak);var aj={appId:ac.appId,widgetId:ac.widgetId,fileName:"-file",fileContent:al};x.publish("launchApp",aj)})}});E=true}var W={widgetId:V.getWidget().id};var T=o.get();if(T.length>0){x.publish("setTypes",W)}else{x.publish("resetType")}},setTypesForOFW:function(W,U){var X=this;if(!e.is(W.nodes2Open,"array")){throw new Error("settypes_open_in_web: Invalid init parameter nodes2Open")}var ac=e.clone(b);var ai=[],ak=[],Z="",ag=0,af=0,ab=1,Y={id:null,phid:null},aa,aj={},ah={};var T=[];W.selectedPaths.paths.forEach(function(ao){var an=function(aq){var ap=aj[aq];if(ap){if(!e.is(aa[ap.localid])){aa[ap.localid]={}}aa=aa[ap.localid]}};var am=function(aq){var ap=false;if(W.nodes2Open.indexOf(aq)===-1){ap=false}else{ap=true}return ap};var al=function(aq){var ap=false;if(W.hiddenNodes.indexOf(aq)===-1){ap=true}else{ap=false}return ap};if(ao.length===1){T.push(ao[0])}for(ag=0;ag<ao.length;ag++){Z=ao[ag];if(ai.indexOf(Z)===-1){ac.results.push({id:ab.toString(),phid:Z});aj[Z]={idx:ab,localid:af,};ah[af]={idx:ab.toString(),nodeId:Z,show:al(Z),selected:am(Z)};ab++;af++;ai.push(Z)}}aa=ak;ao.forEach(an)});for(var ae in ak){var ad=[];var V=[];if((ah[ae].selected===true)&&(T.length===0||(T.length>0&&T.indexOf(ah[ae].nodeId)!==-1))){ad.push({id:ah[ae].idx,show:ah[ae].show,select:ah[ae].selected,children:[]})}else{ad.push({id:ah[ae].idx,show:ah[ae].show,children:[]})}V=X.buildStructure(ak[ae],ah,ad[0].children,T);if(V){ad.push({children:V})}ac.structures.push({structure:ad})}U(ac)},set3DStructure4OpenInCV5:function(W){if(!e.is(W.nodes2Open,"array")){throw new Error("setStructure_4_open_in_cv5: Invalid init parameter nodes2Open")}var aa={version:"1",structures:{references:[],connections:[],trees:{}}};var Y=[],Z="",U=0,T=0,X,V={};W.selectedPaths.paths.forEach(function(ad){var ac=function(af){var ae=V[af];if(!e.is(X[ae.localid])){X[ae.localid]={};if(ae.selected){X[ae.localid].selected=ae.selected}}X=X[ae.localid]};var ab=function(af){var ae=false;if(W.nodes2Open.indexOf(af)===-1){ae=false}else{ae=true}return ae};for(U=0;U<ad.length;U++){Z=ad[U];if(Y.indexOf(Z)===-1){if(U%2!==0){aa.structures.connections.push({physicalid:ad[U],localid:T+""});V[Z]={localid:T,selected:ab(Z)};T++;Y.push(Z)}else{aa.structures.references.push({physicalid:ad[U],type:W.selectedPaths.attributes[ad[U]].type,localid:T+""});V[Z]={localid:T,selected:ab(Z)};T++;Y.push(Z)}}}X=aa.structures.trees;ad.forEach(ac)});return aa},_initInterwidgetCom:function(){var T=this;if(this.isInterwidgetComAvailable()){require(["DS/PADUtils/PADCommandProxy"],function(U){T._commandProxy=U.create({events:{onSharedAlert:function(V){var W=k.getPromises().slice();k.createPromise(function(Y,X){D.all(W).then(function(Z){W=null;if(T.getRoots().length===0&&!T._checkHiddenRoots()){T._dropZoneContainer.show("drop")}else{T._dropZoneContainer.hide()}T.displayNotification(V);Y()})},"SharedAlert")},onFilterWarn:function(V){var W=k.getPromises().slice();k.createPromise(function(Y,X){D.all(W).then(function(Z){W=null;if(T.getRoots().length===0&&!T._checkHiddenRoots()){T._dropZoneContainer.show("drop")}else{T._dropZoneContainer.hide()}var aa="";switch(V){case"inauthoring":aa=A.filterInAuthoring;break;case"notactivated":aa=A.filterNotActivated;break}T.displayNotification({eventID:"warning",msg:aa});Y()})},"FilterWarn")},onFocusChange:function(V){if(V.sharedID==p.getSharedId()){T.publish({event:"onFocusChange",data:V})}},onSelect:function(W,V){var X=k.getPromises().slice();k.createPromise(function(Z,Y){D.all(X).then(function(aa){X=null;if(W.focusOn===true&&W.sharedID&&W.sharedID!==p.getSharedId()){console.log("Call from another instance hence not selecting");Z();return}T.lockSelectionBroadcast(true);try{var ad=[];if(W.paths){var af=[];if(W.version==="2"){W.paths.forEach(function(ah){var ag=[];ah.forEach(function(ai){ag.push(ai.resourceid)});af.push(ag)})}else{af=W.paths}af.forEach(function(ah){if(ah.length){var ag=T.unstreamPath(ah);if(ag){ad.push({pathElement:ag})}}})}if(W.POIs){for(var ac=0;ac<W.POIs.length;ac++){var ab=T.getController().unstreamPOI(W.POIs[ac]);if(ab.length>0){ab.forEach(function(ag){ad.push({pathElement:ag})})}}}if(W.exclusiveShow===true){var ae=ad.map(function(ag){return ag.pathElement});T._hideShowController.exclusiveShow({paths:ae})}if(ad.length){o.empty();q.empty();o.add(ad);q.add(ad)}else{if(V.appid===U.appId()&&W.focusOn!==true){o.empty();q.empty()}else{T.publish({event:"onClosePager"})}}}finally{T.lockSelectionBroadcast(false);Z()}})},"select")},onReframeSelection:function(){T.reframe()},onFocus:function(W){if(B.getSetting("enopad3dviewer_lightNodeModel")===true){if(!W.paths){console.error("No path to focus on or call from another 3D widget reference");resolve();return}if(W.intent==="reframe"){var Y=[];W.paths.forEach(function(aa){if(aa.length){var Z=T.unstreamPath(aa);if(Z){Y.push(Z)}}});r.reframeOn({paths:Y,viewpoint:T.getViewpoint()});return}else{var V=J.getCommand("PAD3DViewerNavigateOnSelectionHdr",T.getCommandContext());if(V){V.execute(W.paths)}}}else{var X=k.getPromises().slice();k.createPromise(function(aa,Z){D.all(X).then(function(ab){X=null;if(!W.paths){console.error("No path to focus on or call from another 3D widget reference");aa();return}if(W.intent==="reframe"){var ad=[];W.paths.forEach(function(af){if(af.length){var ae=T.unstreamPath(af);if(ae){ad.push(ae)}}});r.reframeOn({paths:ad,viewpoint:T.getViewpoint()});aa()}else{var ac=J.getCommand("PAD3DViewerNavigateOnSelectionHdr",T.getCommandContext());if(ac){ac.execute(W.paths).then(function(){aa()})}}})},"focusOn")}},onPadDestroy:function(V){T.publish({event:"onWidgetDestroyed",data:V})},onRequestViewPoint:function(){var W=T.getViewpoint();var V=r.buildViewPoint(W);T._commandProxy.updateViewPoint(V)}}})})}},displayNotification:function(T){var U=this;require(["DS/PADUtils/views/PADAlert"],function(V){V.displayNotification(T);if(U.isSelectiveLoadingActivated()&&U.getStatusBar()){U.getStatusBar().setLatestNotification({notification:T})}})},streamPath:function(T){return this._controller.buildArrayFromPath(T)},streamPathWithType:function(U,V,T){return this._controller.buildArrayFromPathWithType(U,V,T)},streamPOI:function(U,T){return this.getController().streamPOI(U,T)},unstreamPath:function(T,U){return this._controller.buildPathFromArray(T,U)},loadActionBar:function(T){T.context=this.getCommandContext();this.abReadyProbe=w.createProbe("actionBarReady");T.language=this._lang;var U={};if(this.isSelectiveLoadingActivated()){if(p.isTouchDevice()){U={bottom:"38px"}}else{U={bottom:"24px"}}}if(this.getFrameWindow().getActionBar()){this.getFrameWindow().getActionBar().loadModel(T)}else{this.getFrameWindow().loadActionBar(T)}if(this.getOption("enableSidePanel")===true){this.getFrameWindow().getActionBar().inject(this.elements.main);this.getFrameWindow().getActionBar().elements.container.setStyles(U)}},displayTree:function(T){if(T){this._frmWindow.getTree().show()}else{this._frmWindow.getTree().hide()}},getBIController:function(){return this._controller},author:function(U){var T=true;if(e.is(U,"boolean")){T=U}this._controller.switchAuthoringMode(U)},addRoots:function(V,U,T){if(V.pids===undefined&&V.paths===undefined&&V.objects===undefined){console.error("No PIDs or paths or objects array defined");return}if(V.pids!==undefined||V.paths!==undefined){console.warn("The usage of pids or paths is deprecated, please use objects")}U=U===undefined?true:U;T=T===undefined?true:T;this._controller.addRoots(V,U,T,this.getAutomaticReframePolicy())},addFilter:function(T){this._controller.addFilter(T)},loadJSON:function(V){if(!e.is(V.data,"array")||e.is(V.data,"array")&&V.data.length===0){throw new Error("No data defined")}for(var U=0;U<V.data.length;U++){if(!e.is(V.data[U].rootID,"string")){throw new Error("No rootID defined for the data nÃ‚Â°"+(U+1))}if(!e.is(V.data[U].structure,"object")){throw new Error("No structure defined for the data nÃ‚Â°"+(U+1))}}var T=false;this._controller.addRoots({structures:V.data},T)},removeRoots:function(T){if(T.pids===undefined){console.error("No PID array defined");return}if(this.getStatusBar()){this.getStatusBar().clearFilter({ids:T.pids})}this._controller.removeRoots(T,true)},empty:function(T){if(this.getStatusBar()){this.getStatusBar().clearFilter()}T=T===undefined?true:T;this._controller.flushModel(T)},publish:function(T){this.getModelEvents().publish(T)},subscribe:function(T,U){return this.getModelEvents().subscribe(T,U)},unsubscribe:function(T){this.getModelEvents().unsubscribe(T)},getRootBagPath:function(){return this._controller.getRootBagPath()},getRoots:function(){return u.getRoots(this)},getModelEvents:function(){return this._modelEvents},reframe:function(T){if(T){this._frmWindow.getViewpoint().reframe(null,undefined,T)}else{this._frmWindow.getViewpoint().reframe()}},reframeSelection:function(){var T=this;T._commandProxy.reframeSelection()},setCurrentLayout:function(U){var T=this;if(U&&!this._layoutActivatedTokenBegin){this._layoutActivatedTokenBegin=U.subscribe({event:"onLayoutComputationBegin"},function(){T.publish({event:"onLayoutComputationBegin"})});this._layoutActivatedTokenEnd=U.subscribe({event:"onLayoutComputationEnd"},function(){T.publish({event:"onLayoutComputationEnd"})})}this._layout=U},getViewer:function(){return this._viewer},getCommandProxy:function(){return this._commandProxy},getHideShowController:function(){return this._hideShowController},getViewpoint:function(){return this._frmWindow.getViewpoint()},getViewpointParameters:function(){return r.buildViewPoint(this.getViewpoint())},getLevelSelectorCommand:function(X){var T=J.getCommand("LevelSelectorHdr",this.getCommandContext());if(!T){var W=this;var V="DS/ENOPAD3DViewer/commands/PAD3DViewerLevelSelectorCmd";var U=V.replace(/\./g,"/");require(["DS/ApplicationFrame/CommandFactory",U],function(Z,Y){T=Z._createCommand(Y,{context:W.getCommandContext(),ID:"LevelSelectorHdr"});X(T);W=null})}else{X(T)}},getContentName:function(W){if(!e.is(W.callbacks,"object")){throw new Error("No callbacks function defined")}if(!e.is(W.callbacks.onComplete,"function")){throw new Error("No onComplete callback function defined")}var T=this.getRoots();var U="";var X=(T.length===1&&this._controller.getHiddenRootIds().length===0)?u.getNodeID(T[0]):null;if(null===X&&(T.length===0&&this._controller.getHiddenRootIds().length===1)){X=this._controller.getHiddenRootIds(0)}if(X){var V=this;this._controller.getAttributes({ids:[X],attributes:["ds6w:label"],callbacks:{onComplete:function(Z){var Y=V.getRoots();if((Y.length>0||V._controller.getHiddenRootIds().length>0)&&Z[X]){U=Z[X]["ds6w:label"]}W.callbacks.onComplete({contentName:U});V=null},onFailure:function(){if(W.callbacks.onFailure){W.callbacks.onFailure({contentName:U})}V=null}}})}else{if(T.length+this._controller.getHiddenRootIds().length>1){U=(T.length+this._controller.getHiddenRootIds().length)+" "+P.contentNameSuffix;W.callbacks.onComplete({contentName:U})}else{W.callbacks.onComplete({contentName:U})}}},setRobotVisibility:function(T){this._robotVisibility=T;if(this._viewer.getRobot&&this._viewer.getRobot()){this._viewer.getRobot().setVisibility(T)}},isRobotVisible:function(){return this._robotVisibility},setDefaultContextualBarVisibility:function(T){this._defaultContextualBarVisibility=T},setDefaultProgressBarVisibility:function(T){this._defaultProgressBarVisibility=T},getDefaultProgressBarVisibility:function(){return this._defaultProgressBarVisibility},setAutomaticReframePolicy:function(T){this._automaticReframePolicy=T},getAutomaticReframePolicy:function(){return window.ENOPADNoReframe?false:this._automaticReframePolicy},isInterwidgetComAvailable:function(){return this._interwidgetComAvailability},isDefaultContextualBarVisible:function(){return this._defaultContextualBarVisibility},setDefaultContextualMenuVisibility:function(T){this._defaultContextualMenuVisibility=T},isDefaultContextualMenuVisible:function(){return this._defaultContextualMenuVisibility},getController:function(){return this._controller},getFrameWindow:function(){return this._frmWindow},deactivateCurrentLayout:function(U){var T=this;var V=k.getPromises().slice();k.createPromise(function(X,W){D.all(V).then(function(Y){V=null;var Z=false;if(T._layout){Z=T._layout.isActive();if(Z){T._layout.deactivate(false)}}if(U.disableCommand){var aa=document.querySelector("div[data-command=PAD3DLineLayoutHdr]");if(aa){aa.setAttribute("style","opacity: 0.5; pointer-events: none !important; -webkit-filter: grayscale(100%);")}}X();return Z})},"deactivateLayout")},activateCurrentLayout:function(){if(this._layout&&!this._layout.isActive()){this._layout.activate()}var T=document.querySelector("div[data-command=PAD3DLineLayoutHdr]");if(T){T.setAttribute("style","")}},getCurrentLayout:function(){return this._layout},refresh:function(T){T=T===undefined?true:T;this._controller.refresh(T)},search:function(U){if(e.is(U.searchQuery,"string")){var T=this;require(["DS/PADServices/utils/PredefinedQueryUtils"],function(V){V.isPredefinedQry(U.searchQuery).then(function(W){U.searchQuery=W;T._controller.search(U)})})}},setLoadingDelegations:function(T){if(!e.is(T,"object")){throw new Error("Wrong parameter for setLoadingDelegations")}this._loadingDelegations=T},getDecorationBag:function(){return this._controller.getDecorationBag()},lockSelectionBroadcast:function(T){this._lockCSONotification=T},setAuthorizedRootTypes:function(U){var W=[];var V=B.getSetting("supported_root_types");for(var T=0;T<U.length;T++){if(V.indexOf(U[T])>-1){W.push(U[T])}}B.setSetting("authorized_root_types",W)},setDefaultStreamToLoad:function(T){B.setSetting("enopad3dviewer_CGRorTHB",T);this.getController()._setDefaultStreamToLoad(T)},loadChange:function(T){if(this._changeAction){this._changeAction.loadChange({app:this,changes:T.objects})}},addWidgetBorder:function(){if(this.getOption("enableSidePanel")===true){this.elements.borderedLayout.addClassName("bordered")}else{this.elements.container.addClassName("bordered")}},clearWidgetBorder:function(){if(this.getOption("enableSidePanel")===true){this.elements.borderedLayout.removeClassName("bordered")}else{this.elements.container.removeClassName("bordered")}},getStatusBar:function(T){return this.elements.padstatusbar},openStoredObjects:function(V){if(V.unserializedData&&V.unserializedData.data.items.length>0){var W=p.getPlatformId();if(W){V.unserializedData.data.items.forEach(function(X){X.envId=W})}return this.openDroppedObjects(V)}var U=this;var T=function(ai,aa,af,ak){if(af===undefined){af=[]}var aj=Object.getOwnPropertyNames(aa);var ae,Y=aj.length;for(ae=0;ae<Y;ae++){var ad=Object.getOwnPropertyNames(aa[aj[ae]]);var ag,X=ad.length;if(X===0){var ab;if(ak===undefined){ab=[]}else{ab=ak.slice()}ab.push(aj[ae]);var Z=ab.join(",");if(af.indexOf(Z)===-1){af.push(Z);var ac={path:ab};ai.push(ac)}}else{for(ag=0;ag<X;ag++){var ah;if(ak===undefined){ah=[]}else{ah=ak.slice()}ah.push(aj[ae]);T(ai,aa[aj[ae]],af,ah)}}}};return new D(function(X){var ab=[];if(V.products){var aa=Object.getOwnPropertyNames(V.products);if(aa.length){var Y=new D(function(ae){var ad=k.getPromises();D.all(ad).then(function(){var ag=[];T(ag,V.products);if(ag.length){if(V.withFilter===true){var af=U.subscribe({event:"onRootAdded"},function(ah){U.unsubscribe(af);ae();if(V.fromProxy!==true){require(["DS/ApplicationFrame/CommandsManager"],function(ai){var aj=ai.getCommand("DefineFilterHdr",U.getCommandContext());if(aj){aj.setAppParams({widgetId:p.getWidgetId(),appId:p.getSharedId(),selectedId:ah.id});aj.begin()}})}})}U.addRoots({objects:ag,loadWithFilter:V.withFilter},false)}else{ae()}})});Y.name="AddRoots";ab.push(Y)}}if(V.filters){var ac=Object.getOwnPropertyNames(V.filters);if(ac.length){var Z=new D(function(ae){var ad=k.getPromises();D.all(ad).then(function(){var ai=[];var ah=p.getPlatformId();for(var ag=0;ag<ac.length;ag++){ai.push({envId:ah,serviceId:"3DSpace",objectId:ac[ag],objectType:"ENOStrRefinementSpecification"})}var af={protocol:"3DXContent",version:"1.1",source:p.getAppId(),widgetId:p.getWidgetId(),data:{items:ai}};U.addRootNodesFromContent({json3DXContent:af,inContext:false});ae()})});Z.name="AddFilters";ab.push(Z)}}D.all(ab).then(function(){X()})})},openDroppedObjects:function(U){var T=this;return new D(function(W){if(U.behavior==="FILTER"||U.withFilter===true){require(["DS/ApplicationFrame/CommandsManager"],function(X){var Y=X.getCommand("FilterDropObjects");if(Y){Y.execute(U.unserializedData,U.fromProxy,true)}else{console.error("PAD3DViewer## FilterDropObjects command is undefined")}W(Y&&U.unserializedData?undefined:{error:"noCommandAvailable"})})}else{var V=U.dispatch||false;T.addRootNodesFromContent({json3DXContent:U.unserializedData,inContext:U.behavior?U.behavior==="WITH_CONTEXT"?true:false:true,dispatch:V});W()}})},});return m});