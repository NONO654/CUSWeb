/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CAT3DComposeConstraints/CAT3DComposeConstraintsModel",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/CATCDSJS/CATCDS","DS/CATC3DGeometry/CATC3DGeometryEnums","DS/CATC3DGeometry/CATC3DEquivalentGeometry","DS/CAT3DComposeMoveManager/CAT3DComposeMoveManager"],function(e,d,f,a,c,h){var b=a.GeometryType,g=e.extend({init:function(v){var i=v.context;var k=[];var t=this;var q=null;var m=null;var u=null;var r=null;var o=false;var p=h.getMoveManager({context:i});this.createCst=function(w){var x={movable:w.movable,fixed:w.fixed,cstType:w.cstType};k.push(x);return x};this.getLastCst=function(){return k.length>0?k[k.length-1]:null};this.deleteLastCst=function(){k.splice(k.length-1,1)};this.deleteAllCst=function(){k=[]};this.count=function(){return k.length};var s=function(z,A){var C;switch(z.getType()){case b.POINT:var D=z.getPoint();C=f.CATICDSPoint.Create(A,D.x,D.y,D.z);break;case b.CIRCLE:case b.SPHERE:var w=z.getCenter();C=f.CATICDSPoint.Create(A,w.x,w.y,w.z);break;case b.LINE:case b.CYLINDER:case b.CONE:var E=z.getEndPoints();var x=E.endPoint.clone().sub(E.startPoint).normalize();C=f.CATICDSLine.Create(A,E.startPoint.x,E.startPoint.y,E.startPoint.z,x.x,x.y,x.z);break;case b.PLANE:case b.REFPLANE:var B=z.getPlane();C=f.CATICDSPlane.Create(A,B.origin.x,B.origin.y,B.origin.z,B.normal.x,B.normal.y,B.normal.z);break;case b.AXIS:case b.AXISX:case b.AXISY:case b.AXISZ:var y=z.getAxis();C=f.CATICDSLine.Create(A,y.origin.x,y.origin.y,y.origin.z,y.direction.x,y.direction.y,y.direction.z);break;default:window.console("Unknown type of geomtry")}return C};var l=function(){o=false;q=f.CATICDSAdvanced.Create();q.SetTolerances(0.001,0.000001);q.SetReplayMode(f.CATCDSReplayMode.rmREPLAY);m=q.GetFactory();r=f.CATICDSRigidSet.Create(m);r.FixToggle();u=f.CATICDSRigidSet.Create(m);for(var A=0;A<t.count();++A){var y=s(k[A].movable,m);u.AddGeometry(y);var w=s(k[A].fixed,m);r.AddGeometry(w);var z=k[A].movable.getType(),C=k[A].fixed.getType(),B=(z===b.AXISX||z===b.AXISY||z===b.AXISZ)&&(C===b.PLANE||C===b.REFPLANE)?"CATICDSParallelism":"CATICDSCoincidence",x=f[B].Create(m,y,w);if(k[A].cstType==="cstContact"||k[A].cstType==="cstAntiAlign"){x.SetAlignment(f.CATCAlignment.caANTIALIGN)}else{if(k[A].cstType==="cstCoincidence"||k[A].cstType==="cstAlign"){x.SetAlignment(f.CATCAlignment.caALIGN)}}if(x.IsRedundant().status===f.CATCDSRedundancyStatus.rsFULLYREDUNDANT){o=true}}};var j=function(){var w={};var z=q.Run();if(z===0){if(u.HasTransformation()){var y=u.GetTransformation();var x=new d.Matrix4(y.matrix[0][0],y.matrix[0][1],y.matrix[0][2],y.vector[0],y.matrix[1][0],y.matrix[1][1],y.matrix[1][2],y.vector[1],y.matrix[2][0],y.matrix[2][1],y.matrix[2][2],y.vector[2],0,0,0,1);w.matrix=x}}else{q.UndoRun()}f.CATICDSAdvanced.Remove(q);q=null;m=null;u=null;r=null;w.rc=z;w.redundancy=o;return w};this.simulateMoveWithCst=function(y){l();var x=[[1,0,0],[0,1,0],[0,0,1]];if(y.rotation){x=y.rotation}var z=new d.Vector3();if(y.translation){z=y.translation}if(y.movableReference){var w=f.CATICDSPoint.Create(m,y.movableReference.x,y.movableReference.y,y.movableReference.z);u.AddGeometry(w)}u.SetDynamicMove(x,[z.x,z.y,z.z]);return j()};this.simulateSolveCst=function(){l();return j()};this.moveWithCst=function(z){var x=z.alternative.alternativePosition;var w=z.objectsToMove;if(x){p.onMoveBegin({objectsMoved:w,from:t,moveMode:"Transient"});var y=new d.Matrix4().getInverse(w[0].initWorldMatrix).multiply(x);w.forEach(function(B){var C=new d.Matrix4().copy(B.initWorldMatrix).multiply(y);var A=new d.Matrix4().getInverse(B.path.getParentPath().getWorldMatrix());B.snappedPosition=new d.Matrix4().copy(A).multiply(C)});p.onMove({objectsMoved:w,transformation:y,from:t});if(z.callBackFct){z.callBackFct({objectsToMove:w,callBackAfterAnim:function(){p.onMoveEnd({from:t,status:"Moved"})}})}}};this.getConstraintForReverseDirection=function(x){var w=this.count()===1?this.getLastCst():null;if(!x||!w){return undefined}var y=w.movable.getType();if((y===b.AXISX||y===b.AXISY||y===b.AXISZ)&&x.isAParentOf(w.movable.getPathElement())){return w}return undefined};function n(w){var x;switch(w.getType()){case b.LINE:case b.CYLINDER:case b.CONE:var y=w.getEndPoints();x=y.endPoint.clone().sub(y.startPoint).normalize();break;case b.PLANE:case b.REFPLANE:x=w.getNormal();break;case b.AXIS:case b.AXISX:case b.AXISY:case b.AXISZ:x=w.getDirection();break;default:window.console.log("Unknown type of geomtry")}return x}this.simulateReverseDirection=function(y){var w=this.getConstraintForReverseDirection(y);if(w){if(w.cstType==="cstAntiAlign"||w.cstType==="cstAlign"){w.cstType=w.cstType==="cstAntiAlign"?"cstAlign":"cstAntiAlign";return this.simulateSolveCst()}else{var A=n(w.movable),x=n(w.fixed);if(A&&x){var z=A.angleTo(x);if(Math.abs(z)<0.000001||Math.abs(Math.PI-z)<0.000001){w.cstType=Math.abs(z)<0.000001?"cstAntiAlign":"cstAlign";return this.simulateSolveCst()}}}}return undefined};this.getAxisTypeIfCstOnProductAxis=function(x){var w=this.count()===1?this.getLastCst():null;if(!x||!w){return undefined}var y=w.movable.getType();if((y===b.AXISX||y===b.AXISY||y===b.AXISZ)&&x.isAParentOf(w.movable.getPathElement())){return y}return undefined};this.simulateSwitchAxis=function(z,w){var x=this.getAxisTypeIfCstOnProductAxis(z);if(x&&x!==w&&(w===b.AXISX||w===b.AXISY||w===b.AXISZ)){var y=this.getLastCst();this.deleteLastCst();this.createCst({movable:c.getEquivalentGeometry({pathElement:y.movable.getPathElement(),axis:w}),fixed:y.fixed});return this.simulateSolveCst()}return undefined}}});return g});define("DS/CAT3DComposeConstraints/CAT3DComposeConstraintsView",["UWA/Core","UWA/Class","DS/WebappsUtils/WebappsUtils","DS/CoreEvents/ModelEvents","DS/CATWebUXComponents/CATWebUXThumbnail","DS/CATWebUXComponents/CATWebUXPanel","DS/Visualization/ThreeJS_DS","DS/Visualization/Viewpoint","DS/CAT3DComposeBoxes/CAT3DComposeBoxController","DS/CAT3DComposeUtils/CAT3DCompose3DAnimation","DS/CAT3DComposeWidget/CAT3DComposeWidgetOptions","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/SceneGraphUtils","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(h,b,f,e,n,p,m,k,l,d,i,j,a,c){var g={};require(["i18n!DS/CAT3DComposeConstraints/assets/nls/CAT3DComposeConstraintsView"],function(q){g=q});var o=b.extend({init:function(w){if(!w){return}this._parent(w);var H=null;var s={div:null,thumbs:[]};var A=null;var x=null;var K=3394815,F=15355703;var I=w.context;var C=h.createElement("canvas");var B=null;var L=new e();var y=d.get3DComposeAnimationEngine({viewer:I.getViewer()});var u=f.getWebappsAssetUrl("CAT3DComposeConstraints","icons/32/");var t=function(P){var O=P.clone(),M=false,N;while(O&&!M){N=O.getLastElement(true);M=N&&c.is3DLeaf(N);if(!M){O=O.getParentPath()}}return O};var G=function(Q){var N=Q.getLastElement(true);var M=null;if(N){var P=t(Q);if(P){N=P.getLastElement(true);var O=N.getChildByName("AxisSystems");if(O){M={};M.axisBagNode=O}}}return M};var q=function(V,O,Z){var Q=2;var R={data:null,width:I.getViewer().SCREEN_WIDTH,height:I.getViewer().SCREEN_HEIGHT};I.getViewer().renderToTarget(R,V);var W=R.width/R.height;if(W>(O/Z)){C.height=Z;C.width=C.height*W}else{C.width=O;C.height=C.width/W}C.width*=Q;C.height*=Q;var N=C.getContext("2d");N.clearRect(0,0,C.width,C.height);var S=function(ad,ac,ab,ae,af){if(af){ac=ae-ac}return ab*Math.floor(ac)+Math.floor(ad)};var Y=N.getImageData(0,0,C.width,C.height);var X=(R.width-1)/(Y.width-1);var P=(R.height-1)/(Y.height-1);for(var T=0;T<Y.height;T++){for(var aa=0;aa<Y.width;aa++){var M=S(aa,T,Y.width,Y.height,false);var U=S(X*aa,P*T,R.width,R.height,true);Y.data[4*M]=R.data[4*U];Y.data[4*M+1]=R.data[4*U+1];Y.data[4*M+2]=R.data[4*U+2];Y.data[4*M+3]=R.data[4*U+3]}}N.putImageData(Y,0,0,0,0,C.width,C.height);return C.toDataURL("image/png")};var r=function(N){var O=new k({viewer:I.getViewer()});I.getViewer().addViewpoint(O);O.setEyePosition(I.getViewer().currentViewpoint.getEyePosition());O.setSightDirection(I.getViewer().currentViewpoint.getSightDirection());O.setUpDirection(I.getViewer().currentViewpoint.getUpDirection());O.setTargetDistance(I.getViewer().currentViewpoint.getTargetDistance());O.setProjectionType(I.getViewer().currentViewpoint.getProjectionType());var M=null;N.objectsToMove.forEach(function(P){if(!M){M=P.path.getBoundingSphere()}else{M.mergeWithSphere(P.path.getBoundingSphere(),M)}});M.mergeWithSphere(N.cstAssociated.fixed.getPathElement().getBoundingSphere(),M);O.reframe(null,0,M);return q(O,240,180)};var v=function(M){var T=new j(I.getRootBagPath().externalPath[0]);I.getViewer().getSceneGraphOverrideSetManager().pushSceneGraphOverrideSet(T);var U=I.getRootBagPath();var P=T.createOverride(U);var N=I.getViewer().getShadow();I.getViewer().setShadow(false);var O=I.getViewer().getGrid();I.getViewer().setGrid(false);var S=I.getViewer().getMirror();I.getViewer().setMirror(false);I.setRobotVisibility(false);var R=l.getBoxController({context:I});if(R){R.displayBoxes(false)}var Q=null;P.setOpacity(0,true);P.setPickability("IGNORED");var V=false;M.forEach(function(X){var Y=X.objectsToMove;var Z=new m.Matrix4().getInverse(Y[0].initWorldMatrix).multiply(X.alternativePosition);var W=new m.MeshBasicMaterial({side:m.DoubleSide,color:K,transparent:true,depthWrite:false,depthTest:false,opacity:0.7,overridable:false});a.applyMaterialToPath(X.cstAssociated.fixed.getPathElement(),W);X.objectsToMove.forEach(function(ab){var ad=T.createOverride(ab.path);if(!V){var af=T.createOverride(X.cstAssociated.fixed.getPathElement());af.setOpacity(1,true);af.setPickability("PICKABLE");ad.setOpacity(1,true);ad.setPickability("PICKABLE");var ae=G(X.cstAssociated.fixed.getPathElement());if(ae&&ae.axisBagNode){if(ae.axisBagNode.isVisible()){Q=ae.axisBagNode}}}var ac=new m.Matrix4().copy(ab.initWorldMatrix).multiply(Z);var aa=new m.Matrix4().getInverse(ab.path.getParentPath().getWorldMatrix());ad.setPosition(new m.Matrix4().copy(aa).multiply(ac))});X.preview=r(X);a.applyMaterialToPath(X.cstAssociated.fixed.getPathElement(),null);V=true});I.setRobotVisibility(true);if(Q){Q.setVisibility(true)}I.getViewer().setShadow(N);I.getViewer().setGrid(O);I.getViewer().setMirror(S);I.getViewer().getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(T);if(R){R.displayBoxes(true)}};var z=function(M){B.setDisplayFlag(false);M.thumbnail.setDisplayFlag(true);B=M.thumbnail};var J=function(O){if(O.color){var M=new m.MeshBasicMaterial({side:m.DoubleSide,color:O.color,transparent:true,depthWrite:false,depthTest:false,opacity:0.9,overridable:false});a.applyMaterialToPath(O.path,M);var N=800;if(F===O.color){N=1600}A=setTimeout(function(){clearTimeout(A);A=null;J(x)},N);x={path:O.path}}else{a.applyMaterialToPath(O.path,null);x={}}I.getViewer().render()};var D=function(N){var O;for(var M=0;M<s.thumbs.length;M++){if(s.thumbs[M].getThumbnailID()==="3DComposeConstraintsThumb_"+N.data.cstType){O=s.thumbs[M];break}}if(O&&B!==O&&!y.isRunning()){z({thumbnail:O});L.publish({event:"onAlternativeClick",data:N.data})}};var E=function(O){while(s.div.firstChild){s.div.firstChild.destroy();s.div.removeChild(s.div.firstChild)}for(var N=0;N<s.thumbs.length;N++){s.thumbs[N].clear()}s.thumbs.length=0;v(O.snapAlternatives);var M=i.getOption("cstDefaultType");O.snapAlternatives.forEach(function(P){var Q=new n({id:"3DComposeConstraintsThumb_"+P.cstType,data:{cstType:P.cstType},width:250,height:190,title:g[P.cstType],icon:u+"I_3DCompose"+P.cstType+".png",preview:P.preview,displayFlag:P.cstType===M,clickCB:D});s.thumbs.push(Q);s.div.appendChild(Q.getContent());if(P.cstType===M){B=Q}})};this.refreshView=function(N){if(!s.div){s.div=h.createElement("div")}if(!H){var M={id:"CAT3DComposeConstraintsViewPanel",className:"CAT3DComposeConstraintsViewPanel",title:g.sidePanel,showTitleFlag:false,icon:f.getWebappsAssetUrl("CAT3DComposeConstraints","icons/32/")+"I_3DComposecstContact.png",immersiveFrame:w.window.getImmersiveFrame(),content:s.div,minWidth:270,width:270,minHeight:410,height:410,resizableFlag:false,snappableFlag:false,position:{at:"top right"},allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea};H=new p(M)}E(N)};this.setUpMeshColor=function(M){if(A){clearTimeout(A);A=null;J(x)}if(M.result.rc===0&&!M.result.redundancy){J({path:M.path,color:K})}else{J({path:M.path,color:F})}};this.clear=function(){if(H){H.destroy();H=null}};this.subscribe=function(M,N){if(M==="onAlternativeClick"){return L.subscribe({event:M},N)}return undefined}}});return o});define("DS/CAT3DComposeConstraints/CAT3DComposeConstraintsController",["UWA/Core","UWA/Class","DS/CAT3DComposeUtils/CAT3DCompose3DAnimation","DS/CATC3DGeometry/CATC3DGeometryEnums","DS/Visualization/ThreeJS_DS","DS/CAT3DComposeWidget/CAT3DComposeWidgetOptions","DS/CAT3DComposeMoveManager/CATC3DMoveReferent","DS/CAT3DComposeMoveManager/CAT3DComposeMoveManager","DS/CAT3DComposeBoxes/CAT3DComposeBoxController","DS/CAT3DComposeConstraints/CAT3DComposeConstraintsView","DS/CATRelatedData3DGrid/CATRelatedData3DGridController"],function(l,m,c,e,k,h,g,d,j,n,a){var f=m.extend({init:function(p){var t=null,v=null,G=[],z=[],A=["cstContact","cstCoincidence"],E;h.setOption("cstDefaultType",A[0]);var y=p.context;if(!y){window.console.log("A context must be defined");return}var r=d.getMoveManager({context:y});var H=g.getMoveReferentManager({context:y});var D=y.getFrameWindow();if(!D){window.console.log("A window must be defined");return}var w=D.getViewer(),C;var u=function(){require(["DS/CAT3DComposeConstraints/CAT3DComposeConstraintsModel"],function(I){C=new I({context:y})})};var o=new n({window:D,viewer:w,context:y});var s=y.getRootBagPath().getChildrenPathes();if(s.length){u()}else{var F=y.subscribe({event:"onRootAdded"},function(){u();y.unsubscribe(F)})}var B=function(){var M=[];var L=h.getOption("cstDefaultType");var I=C.getLastCst();M.push({alternativePosition:z[0].initWorldMatrix,objectsToMove:z,cstType:L,cstAssociated:I});var K=I.movable.getType(),J=I.fixed.getType();if((K===e.GeometryType.PLANE||K===e.GeometryType.REFPLANE)&&(J===e.GeometryType.PLANE||J===e.GeometryType.REFPLANE)){A.forEach(function(P){if(P!==L){C.deleteLastCst();var R=C.createCst({movable:I.movable,fixed:I.fixed,cstType:P});var Q=C.simulateSolveCst().matrix;if(Q){var N=Q.multiply(new k.Matrix4().copy(z[0].initWorldMatrix));var O={alternativePosition:N,objectsToMove:z,cstType:P,cstAssociated:R};if(P==="cstCoincidence"){M.push(O)}else{M.unshift(O)}}}});C.deleteLastCst();C.createCst({movable:I.movable,fixed:I.fixed,cstType:I.cstType})}return M};r.subscribe("MoveBegin",function(I){if(I.objectsMoved.length>0){z=[];I.objectsMoved.forEach(function(J){z.push(J)})}});r.subscribe("MoveEnd",function(I){if(C&&C.count()>0&&z.length>0){z.forEach(function(J){var K=H.getMoveReferent(J.path);J.initWorldMatrix=K.getWorldMatrix();J.initMatrix=K.getLastElement(true).getMatrix()});if(I.status==="Moved"){if(I.from!==C){G=B()}if(G.length>1){if(I.from!==C){o.refreshView({snapAlternatives:G})}}else{o.clear()}}}});var q=c.get3DComposeAnimationEngine({viewer:w});var x=function(N){if(!C){return}var K=j.getBoxController({context:y}),M;if(K){M=K.getDisplayState();K.displayBoxes(false)}h.setOption("cstDefaultType",N.cstType);var I=C.getLastCst();C.deleteLastCst();C.createCst({movable:I.movable,fixed:I.fixed,cstType:N.cstType});var J=null;G.some(function(O){if(O.cstType===N.cstType){J=O;return true}return false});var L=a.give3DGridController({context:y});C.moveWithCst({alternative:J,objectsToMove:z,callBackFct:function(O){if(L){L.hide3DGrids()}q.addAnimation({animationType:"snap",createOverrideSet:true,objectListToAnimate:O.objectsToMove,callBackFct:function(){O.callBackAfterAnim();if(M&&K){K.displayBoxes(true)}if(L){L.display3DGrids()}}});q.startAnimation()}})};o.subscribe("onAlternativeClick",x);this.isLevelConstrained=function(I){if(!v||!I){return false}return v.isEqual(I)};this.createCst=function(N){if(!N||!N.movable||!N.fixed||!C){return undefined}var O=N.movable.equivalentGeometry;var L=N.fixed.equivalentGeometry;if(!O||!L){return undefined}var M=N.cstType,K=O.getType(),J=L.getType();if((K===e.GeometryType.PLANE||K===e.GeometryType.REFPLANE)&&(J===e.GeometryType.PLANE||J===e.GeometryType.REFPLANE)){M=h.getOption("cstDefaultType");if(!M){M="cstContact"}}var I=C.createCst({movable:O,fixed:L,cstType:M});v=H.getMoveReferent(I.movable.getPathElement());return I};this.deleteLastCst=function(){if(!C){return}t=C.getLastCst();C.deleteLastCst()};this.restoreLastDeletedCst=function(){if(!C){return}C.createCst({movable:t.movable,fixed:t.fixed,cstType:t.cstType})};this.deleteAllCst=function(){if(!C){return}C.deleteAllCst();if(o){o.clear()}t=null;v=null};this.count=function(){return C?C.count():undefined};this.simulateMoveWithCst=function(I){if(!I||(!I.translation&&!I.rotation)||!C){return undefined}var J=C.simulateMoveWithCst(I);return J};this.simulateSolveCst=function(){if(!C){return undefined}var N=C.simulateSolveCst();var M=N.rc;var I=C.getLastCst();if(M!==0&&I){var L=I.movable.getType(),K=I.fixed.getType();if((L===e.GeometryType.PLANE||L===e.GeometryType.REFPLANE)&&(K===e.GeometryType.PLANE||K===e.GeometryType.REFPLANE)){C.deleteLastCst();var J=null;A.some(function(O){if(O!==I.cstType){J=O;return true}return false})}C.createCst({movable:I.movable,fixed:I.fixed,cstType:J});N=C.simulateSolveCst()}o.setUpMeshColor({result:N,path:I.fixed.getPathElement()});return N};this.isThereACstSuppportingReverseDirection=function(I){return I&&C&&C.getConstraintForReverseDirection(I)};this.simulateReverseDirection=function(I){return C?C.simulateReverseDirection(I):null};this.getAxisTypeIfCstOnProductAxis=function(I){if(!I||!C){return undefined}return C.getAxisTypeIfCstOnProductAxis(I)};this.simulateSwitchAxis=function(J,I){return C?C.simulateSwitchAxis(J,I):null};this.getProductAxisForConstraint=function(){if(!E){var I=localStorage.getItem("PrdAxisForCst");E=I==="Y"?e.GeometryType.AXISY:I==="Z"?e.GeometryType.AXISZ:e.GeometryType.AXISX}return E};this.setProductAxisForConstraint=function(I){if(I===e.GeometryType.AXISX||I===e.GeometryType.AXISY||I===e.GeometryType.AXISZ){E=I;localStorage.setItem("PrdAxisForCst",I===e.GeometryType.AXISY?"Y":I===e.GeometryType.AXISZ?"Z":"X")}}}});var i=[],b=function(o){var p;if(o&&o.context){p=null;i.some(function(q){return(q.context===o.context)?(p=q):false})}return p};return m.singleton({init:function(){},giveConstraintsController:function(o){var p=b(o);return p?p.enveloppe:p},getConstraintsController:function(o){var q,p=b(o);if(p){p.count++;q=p.enveloppe}else{if(p===null){p={count:1,context:o.context,cstCtrl:new f(o),enveloppe:{unreference:function(){p.count--;if(p.count===0){p.cstCtrl=p.context=null;i.splice(i.indexOf(p),1)}}}};Object.keys(p.cstCtrl).forEach(function(r){var s=this;if(typeof s.cstCtrl[r]==="function"){s.enveloppe[r]=function(){var t;if(s.cstCtrl){t=s.cstCtrl[r].apply(s.cstCtrl,arguments)}else{window.console.log("Unexpected call")}return t}}},p);q=Object.freeze(p.enveloppe);i.push(p)}}return q}})});