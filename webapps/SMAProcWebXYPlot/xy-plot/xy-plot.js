require(["UWA/Core","DS/Controls/Toggle","DS/UIKIT/Input/Button","DS/D3js_external/D3js","DS/SMAProcWebXYPlot/xy-plot/xy-plot-decimator"],function(f,d,c,e,b){var a=window.Polymer;Polymer({is:"xy-plot",properties:{dataObject:{type:Object,value:{},notify:true}},clearMainPlot:function(){var g=this.children[0];while(g.hasChildNodes()){g.removeChild(g.lastChild)}if(this.querySelector(".plot-zoom")){this.querySelector(".plot-zoom").remove()}},resize:function(){var k=this;k.dimensions={totalWidth:k.children[0].getBoundingClientRect().width,main:{totalWidth:k.children[0].getBoundingClientRect().width-30>0?k.children[0].getBoundingClientRect().width-30:1200,totalHeight:k.children[0].getBoundingClientRect().height>0?k.children[0].getBoundingClientRect().height:150,leftPad:80,rightPad:10,topPad:20,bottomPad:40},zoom:{totalWidth:k.children[0].getBoundingClientRect().width-30,totalHeight:70,leftPad:80,rightPad:10,topPad:10,bottomPad:55}};var l=this.dimensions.main;l.plotWidth=l.totalWidth-(l.leftPad+l.rightPad);l.plotHeight=l.totalHeight-(l.topPad+l.bottomPad);var h=this.dimensions.zoom;h.plotWidth=h.totalWidth-(h.leftPad+h.rightPad);h.plotHeight=h.totalHeight-(h.topPad+h.bottomPad);var o=k.dataObject.data.droppedData.dataName[0];var m=k.dataObject.data.droppedData.plotTitle;var p=k.dataObject.data.droppedData.xAxisName;var g=k.dataObject.data.droppedData.grid;var n=k.dataObject.data.droppedData.backgroundColor;var i=k.dataObject.data.droppedData.yAxisName;var j=k.dataObject.data.droppedData.precision;if(e.select(k).select("#monitoring")[0][0]){var q=e.select(k).select("#monitoring")[0][0].textContent}k.clearMainPlot();if(!k.dataObject.data.droppedData.rawData[0]){k.dataObject.data.droppedData.rawData[0]=[0,0];k.setupMainPlot(o,p,m,g,n,i,j);k.dataObject.data.droppedData.rawData.splice(0)}else{if(k.dataObject.data.droppedData.rawData[0]){k.setupMainPlot(o,p,m,g,n,i,j)}}if(q){k.displayMessage(q,k)}},processData:function(q,l){var o=this;var k=q;k=k.split("\n").map(function(w){return w.split(",")}).filter(function(w){return w.length>0&&!isNaN(w[0])&&w[0]!==""});var r=q;r=r.split("\n").map(function(w){return w.split(",")}).filter(function(w){return w.length>0&&isNaN(w[0])&&w[0]!==""});var i="droppedData";o.dataObject={timeSeriesType:"indices",data:{},indexedColumns:0};o.dimensions={totalWidth:o.children[0].getBoundingClientRect().width,main:{totalWidth:o.children[0].getBoundingClientRect().width-30>0?o.children[0].getBoundingClientRect().width-30:1200,totalHeight:o.children[0].getBoundingClientRect().height>0?o.children[0].getBoundingClientRect().height:150,leftPad:80,rightPad:10,topPad:20,bottomPad:40},zoom:{totalWidth:o.children[0].getBoundingClientRect().width-30,totalHeight:70,leftPad:80,rightPad:10,topPad:10,bottomPad:55}};var p=this.dimensions.main;p.plotWidth=p.totalWidth-(p.leftPad+p.rightPad);p.plotHeight=p.totalHeight-(p.topPad+p.bottomPad);var j=this.dimensions.zoom;j.plotWidth=j.totalWidth-(j.leftPad+j.rightPad);j.plotHeight=j.totalHeight-(j.topPad+j.bottomPad);o.scales={};o.axisGenerators={};o.gridGenerators={};o.axes={};o.grids={};o.dataObject.data[i]={dataName:r,columns:k[0].length,rawData:k};if(l===true){var h=new b();h.downsample(o.dataObject,5000,false)}var n=0;for(var s in o.dataObject.data){if(o.dataObject.data[s].columns===1){n+=1}}o.dataObject.indexedColumns=n;if(this.dataObject.timeSeriesType==="indices"||Object.keys(this.dataObject.data).length===1){for(var s in this.dataObject.data){if(this.dataObject.data[s].columns===1){addIndexedTime(this.dataObject.data[s])}else{this.dataObject.data[s].data=this.dataObject.data[s].rawData}}}else{var u,v;if(this.dataObject.indexedColumns===1){for(var s in this.dataObject.data){if(this.dataObject.data[s].columns===2){u=this.dataObject.data[s];this.dataObject.data[s].data=this.dataObject.data[s].rawdata}else{v=this.dataObject.data[s]}}}else{if(this.dataObject.indexedColumns===2){var t=Object.keys(this.dataObject.data);u=addIndexedTime(this.dataObject.data[t[0]]);v=this.dataObject.data[t[1]]}else{if(this.dataObject.indexedColumns===2){}}}var g=u.data[0][0],m=u.data[u.data.length-1][0];addScaledTime(v,g,m)}o.dataObject.dataReceived=0},setupMainPlot:function(H,u,I,h,m,G,D){var r=this;if(!this.dataObject.selectedList){var v="selectedList";this.dataObject[v]={selectedList:[]};for(var C=0;C<this.dataObject.data.droppedData.rawData[0].length;C++){H[C]=this.dataObject.data.droppedData.dataName[0][C];this.dataObject.selectedList.selectedList[C]=1}}this.dataObject.data.droppedData.xAxisName=u;this.dataObject.data.droppedData.plotTitle=I;this.dataObject.data.droppedData.grid=h;this.dataObject.data.droppedData.backgroundColor=m;this.dataObject.data.droppedData.yAxisName=G;this.dataObject.data.droppedData.precision=D;var q=this.querySelector("xy-axis").getScales(this.dimensions.main);var y=e.select(this.children[0]).on("mousemove",this.mousemove.bind(this,q)).on("mouseleave",this.mouseleave.bind(this,q));var o=this.dimensions.main;this.scales.main=q;if(m){y.append("rect").attr("x",o.leftPad).attr("y",o.topPad).attr("width",o.plotWidth).attr("height",o.plotHeight).style("opacity",1).style("fill",m)}var B=this.querySelector("xy-line").plotLines(this.children[0],o,q);var F="lineClip"+Number(Math.random());var w=B.append("clipPath").attr("id",F);w.append("rect").attr("x",0).attr("y",0).attr("width",o.plotWidth).attr("height",o.plotHeight);B.selectAll("path").attr("clip-path","url(#"+F+")");var t;if(Math.abs(this.scales.main.yScale.domain()[1])<0.0001){t=e.format(".2e")}else{if(Math.abs(this.scales.main.yScale.domain()[1])>0.0001&&Math.abs(this.scales.main.yScale.domain()[1])<10000){t=e.format(".3g")}else{if(Math.abs(this.scales.main.yScale.domain()[1])>10000){t=e.format(".2e")}}}if(r.scales.main.yScale.domain()[0]===Infinity&&r.scales.main.yScale.domain()[1]===-Infinity){r.displayMessage("No data is available. Provide some data or select a variable in the legend.",r)}Math.log10=Math.log10||function(i){return Math.log(i)*Math.LOG10E};if(D!==undefined&&D!==null&&D!==""){var l=this.refreshXPrecision(D)}else{D=-Math.floor(Math.log10((this.scales.main.xScale.domain()[1]-this.scales.main.xScale.domain()[0])/((this.scales.main.xScale.domain()[0]+this.scales.main.xScale.domain()[1])/2)))+2;var l=e.svg.axis().scale(q.xScale).orient("bottom").ticks(this.dimensions.main.totalWidth/100).tickFormat(e.format("."+D+"g"))}var k=e.svg.axis().scale(q.xScale).orient("bottom").ticks(this.dimensions.main.totalWidth/100);var A=e.svg.axis().scale(q.yScale).orient("left").ticks(this.dimensions.main.totalHeight/50).tickFormat(t);var z=e.svg.axis().scale(q.yScale).orient("left").ticks(this.dimensions.main.totalHeight/50);var j=e.behavior.zoom().x(q.xScale).y(q.yScale).scaleExtent([1,10]).on("zoom",function(i){x.call(this,i)});this.zoomBehavior=j;y.call(j);function x(){r.dataObject.zoomValue=e.event.scale;r.children[2].plotLines(r.children[0],o,q);var R=r.axisGenerators.main.xAxisGenerator.scale(q.xScale);r.axes.main.xAxis.call(R);var i=r.gridGenerators.main.xGridGenerator.scale(q.xScale);if(r.grids.main.xGrid){r.grids.main.xGrid.call(i.tickSize(-o.plotHeight,0,0).tickFormat(""))}var M=r.axisGenerators.main.yAxisGenerator.scale(q.yScale);r.axes.main.yAxis.call(M);var P=r.gridGenerators.main.yGridGenerator.scale(q.yScale);if(e.event.scale===1){r.clearMainPlot();var Q=r.dataObject.data.droppedData.dataName[0];var N=r.dataObject.data.droppedData.plotTitle;var S=r.dataObject.data.droppedData.xAxisName;var J=r.dataObject.data.droppedData.grid;var O=r.dataObject.data.droppedData.backgroundColor;var K=r.dataObject.data.droppedData.yAxisName;var L=r.dataObject.data.droppedData.precision;r.clearMainPlot();if(!r.dataObject.data.droppedData.rawData[0]){r.dataObject.data.droppedData.rawData[0]=[0,0];r.setupMainPlot(Q,S,N,J,O,K,L);r.dataObject.data.droppedData.rawData.splice(0)}else{if(r.dataObject.data.droppedData.rawData[0]){r.setupMainPlot(Q,S,N,J,O,K,L)}}}}var p=new d({label:"zoom with rectangle selection"}).inject(this);p.elements.container.classList.add("plot-zoom");p.elements.container.style.marginBottom="10px";p.elements.container.style.marginLeft="10px";p.elements.container.style.color="black";p.elements.container.style.fontWeight=900;p.elements.container.style.fontFamily="sans-serif";p.addEventListener("buttonclick",function(i){r.rectZoom=i.dsModel.checkFlag;if(r.rectZoom===true){r.zoomBehavior.on("zoom",null)}else{if(r.rectZoom===false){r.zoomBehavior.on("zoom",function(J){x.call(this,J)})}}});y.on("mousedown",function(){if(r.rectZoom===true){r.mousedown=true}if(!r.rectZoom||r.rectZoom===false){return}var J=this.parentNode.dimensions.main.totalWidth;var i=this.parentNode.dimensions.main.totalHeight;var L=this;var M=e.mouse(this);var K=e.select(this).append("rect").attr("fill","grey").attr("opacity",0.5).attr("class","zoomrect");M[0]=Math.max(0,Math.min(J,M[0]));M[1]=Math.max(0,Math.min(i,M[1]));y.on("mousemove.zoomR",function(){var N=e.mouse(L);N[0]=Math.max(0,Math.min(J,N[0]));N[1]=Math.max(0,Math.min(i,N[1]));K.attr("x",Math.min(M[0],N[0])).attr("y",Math.min(M[1],N[1])).attr("width",Math.abs(N[0]-M[0])).attr("height",Math.abs(N[1]-M[1]))}).on("mouseup.zoomR",function(){r.mousedown=false;if(!r.rectZoom||r.rectZoom===false){return}var O=e.mouse(L);O[0]=Math.max(0,Math.min(J,O[0]));O[1]=Math.max(0,Math.min(i,O[1]));if(O[0]!==M[0]&&O[1]!==M[1]){if(N=e.select(this)[0][0]){var N=e.select(this)[0][0].parentNode.scales.main.xScale;var T=e.select(this)[0][0].parentNode.scales.main.yScale;j.x(N.domain([M[0]+(O[0]-M[0])-o.leftPad,M[0]+2*(O[0]-M[0])-o.leftPad].map(N.invert).sort(function(V,U){return V-U}))).y(T.domain([M[1]+(O[1]-M[1])-o.topPad,M[1]+2*(O[1]-M[1])-o.topPad].map(T.invert).sort(function(V,U){return V-U})));if(r.children[2]){r.children[2].plotLines(r.children[0],o,q)}var Q=r.axisGenerators.main.xAxisGenerator.scale(q.xScale);r.axes.main.xAxis.call(Q);var S=r.gridGenerators.main.xGridGenerator.scale(q.xScale);if(r.grids.main.xGrid){r.grids.main.xGrid.call(S.tickSize(-o.plotHeight,0,0).tickFormat(""))}var P=r.axisGenerators.main.yAxisGenerator.scale(q.yScale);r.axes.main.yAxis.call(P);var R=r.gridGenerators.main.yGridGenerator.scale(q.yScale)}r.zoomBehavior.x(q.xScale).y(q.yScale)}r.dataObject.zoomValue=Math.min(Math.abs(J/(O[0]-M[0])),Math.abs(i/(O[1]-M[1])));K.remove()},true);e.event.stopPropagation()});this.axisGenerators.main={xAxisGenerator:l,yAxisGenerator:A};this.gridGenerators.main={xGridGenerator:k,yGridGenerator:z};var s=y.append("g").attr("class","xAxis axis xy-plot").attr("transform","translate("+o.leftPad+","+(o.topPad+o.plotHeight)+")").call(l);if(h){var n=y.append("g").attr("class","grid xgrid").attr("transform","translate("+o.leftPad+","+(o.topPad+o.plotHeight)+")").call(k.tickSize(-o.plotHeight,0,0).tickFormat(""))}y.append("text").attr("class","x-axis-name").attr("transform","translate("+(o.leftPad+o.totalWidth/2-25)+","+(o.topPad+o.plotHeight+35)+")").style("text-anchor","middle").text(u);var g=y.append("g").attr("class","yAxis axis xy-plot").attr("transform","translate("+o.leftPad+","+(o.topPad)+")").call(A);if(h){var E=y.append("g").attr("class","grid ygrid").attr("transform","translate("+o.leftPad+","+(o.topPad)+")").call(z.tickSize(-o.plotWidth,0,0).tickFormat(""))}y.append("text").attr("class","y-axis-name").attr("transform","translate("+(o.leftPad)+","+(o.topPad-5)+")").style("text-anchor","middle").text(G);y.append("text").attr("class","plottitle").attr("transform","translate("+(o.leftPad+o.totalWidth/2-40)+","+(o.topPad-10)+")").style("text-anchor","middle").style("font-size","medium").text(I);this.axes.main={xAxis:s,yAxis:g};this.grids.main={xGrid:n,yGrid:E}},mousemove:function(p){if(this.mousedown===true){return}e.select(this.children[0]).selectAll("circle").remove();e.select(this.children[0]).selectAll("svg text").filter(function(k,j){return this.id.contains("variable")}).remove();e.select(this.children[0]).selectAll("svg text").filter(function(k,j){return this.id.contains("value")}).remove();e.select(this.parentElement).selectAll(".tooltip").remove();var t=[];for(var n=0;n<this.dataObject.data.droppedData.dataName[0].length;n++){t[n]=this.dataObject.data.droppedData.dataName[0][n]}if(arguments.length!==1){var r=p.xScale.invert(e.mouse(this.children[0])[0]-this.dimensions.main.leftPad);var q=p.yScale.invert(e.mouse(this.children[0])[1]-this.dimensions.main.topPad)}else{if(arguments.length===1){var r=0;var q=0}}if(this.dataObject.data.droppedData.rawData&&this.dataObject.data.droppedData.rawData[0]){var s=Math.abs(r-this.dataObject.data.droppedData.rawData[0][0]);var g=0;for(var n=0;n<this.dataObject.data.droppedData.rawData.length;n++){if(Math.abs(r-this.dataObject.data.droppedData.rawData[n][0])<s){s=Math.abs(r-this.dataObject.data.droppedData.rawData[n][0]);g=n}}}if(this.dataObject.data.droppedData.rawData&&this.dataObject.data.droppedData.rawData[g]){for(var l=1;l<this.dataObject.data.droppedData.rawData[g].length;l++){if(this.dataObject.selectedList.selectedList[l-1]===1){var o=[];o.push(this.dataObject.data.droppedData.rawData[g][0]);o.push(this.dataObject.data.droppedData.rawData[g][l]);break}}for(var m=l+1;m<this.dataObject.data.droppedData.rawData[g].length;m++){if(Math.abs(q-this.dataObject.data.droppedData.rawData[g][m])<Math.abs(q-o[1])&&this.dataObject.selectedList.selectedList[m-1]===1){o[1]=this.dataObject.data.droppedData.rawData[g][m]}}}if(o&&o[0]>=p.xScale.domain()[0]&&o[0]<=p.xScale.domain()[1]){var l=0;for(var n=1;n<o.length;n++){if(o[n]!=="NaN"&&o[n]>=p.yScale.domain()[0]&&o[n]<=p.yScale.domain()[1]){l++;this.showToolTip(this,o[0],o[1]);e.select(this.children[0]).append("circle").attr("r",3).attr("cx",p.xScale(Number(o[0]))).attr("cy",p.yScale(Number(o[n]))).attr("transform","translate("+this.dimensions.main.leftPad+","+this.dimensions.main.topPad+")");var h=new CustomEvent("hoverEvent",{detail:{x:Number(o[0]),y:Number(o[1])}});document.dispatchEvent(h)}}}},mouseleave:function(){e.select(this.children[0]).selectAll("svg text").filter(function(j,h){return this.id.contains("variable")}).remove();e.select(this.children[0]).selectAll("svg text").filter(function(j,h){return this.id.contains("value")}).remove();e.select(this.children[0]).selectAll("circle").remove();this.removeToolTip();var g=new CustomEvent("plotLeaveEvent",{detail:this});document.dispatchEvent(g)},highlight:function(h,g,j){var i=h.scales.main;e.select(this.children[0]).append("circle").attr("r",3).attr("cx",i.xScale(g)).attr("cy",i.yScale(j)).attr("transform","translate("+this.dimensions.main.leftPad+","+this.dimensions.main.topPad+")")},removeHighlight:function(k,g,m){var j=this;var l=k.scales.main;for(var h=0;h<e.select(j.children[0]).selectAll("circle")[0].length;h++){if(Number(Number(e.select(j.children[0]).selectAll("circle")[0][h].getAttribute("cx")).toFixed(2))===Number(l.xScale(g).toFixed(2))&&Number(Number(e.select(j.children[0]).selectAll("circle")[0][h].getAttribute("cy")).toFixed(2))===Number(l.yScale(m).toFixed(2))){e.select(j.children[0]).selectAll("circle")[0][h].parentNode.removeChild(e.select(j.children[0]).selectAll("circle")[0][h])}}},showToolTip:function(h,g,j){var i=e.select(h.parentElement).append("div").style("left",10+"px").style("top",10+"px").style("z-index",1).attr("transform","translate("+(h.dimensions.main.leftPad+5)+","+(h.dimensions.main.topPad-15)+")").attr("class","tooltip").style("background","#368ec4").style("padding","2px 3px").style("font-size","12px").style("text-align","center").style("color","#ffffff").style("border",0+"px").style("border-radius",2+"px").style("opacity",1);i.text("("+Number(g).toPrecision(3)+", "+Number(j).toPrecision(3)+")")},removeToolTip:function(){e.select(this.parentElement).selectAll(".tooltip").remove()},displayMessage:function(i,j){if(e.select(j).select("#monitoring")){e.select(j).select("#monitoring").remove()}var g=e.select(j).select("#mainPlot");var h=this.dimensions.main;g.append("text").attr("id","monitoring").attr("transform","translate("+(h.leftPad+h.totalWidth/2-25)+","+(h.topPad+h.plotHeight+35)/2+")").style("text-anchor","middle").text(i)},removeMessage:function(g){if(e.select(g).select("#monitoring")){e.select(g).select("#monitoring").remove()}},refreshXPrecision:function(g){var i=this.querySelector("xy-axis").getScales(this.dimensions.main);var h=e.svg.axis().scale(i.xScale).orient("bottom").ticks(this.dimensions.main.totalWidth/100).tickFormat(e.format(g));this.axes.main&&this.axes.main.xAxis.call(h);return h},updatePlot:function(y,z,k,v){var q=[];var w=Infinity;var x=-Infinity;var g=Infinity;var h=-Infinity;var n=this.dataObject.dataReceived;n=n+1;this.dataObject.dataReceived=n;y=y.split("\n").map(function(i){return i.split(",")}).filter(function(i){return i.length>0&&!isNaN(i[0])&&i[0]!==""});if(this.dataObject.zoomValue&&this.dataObject.zoomValue!==1){if(!this.dataObject.tempArray){this.dataObject.tempArray=[]}for(var t=0;t<y.length;t++){this.dataObject.tempArray.push(y[t])}}if(!this.dataObject.zoomValue||this.dataObject.zoomValue===1){if(this.dataObject.tempArray&&this.dataObject.tempArray.length>0){for(var t=0;t<this.dataObject.tempArray.length;t++){this.dataObject.data.droppedData.rawData.push(this.dataObject.tempArray[t])}this.dataObject.tempArray=[]}if(k===true){var u=new b();u.downsampleRT(y,z)}if(!this.dataObject.data.droppedData.originalData){this.dataObject.data.droppedData.originalData=[]}for(var t=0;t<y.length;t++){this.dataObject.data.droppedData.originalData.push(y[t])}if(u&&u.decimatedData){for(var r=0;r<u.decimatedData.length;r++){this.dataObject.data.droppedData.rawData.push(u.decimatedData[r])}}else{if(!u||!u.decimatedData){for(var t=0;t<y.length;t++){this.dataObject.data.droppedData.rawData.push(y[t])}}}var p=this.dataObject.data.droppedData.data;if(p){for(var t=0;t<p.length;t++){for(var r=1;r<p[t].length;r++){w=Math.min(w,p[t][0]);x=Math.max(x,p[t][0]);g=Math.min(g,p[t][r]);h=Math.max(h,p[t][r])}}}var m=this.scales.main;m.xScale.domain([w,z]);if(g===h){m.yScale.domain([g-1,h+1])}else{if(g!==h){m.yScale.domain([g,h])}}this.zoomBehavior.x(m.xScale).y(m.yScale);if(p[0]){for(var t=1;t<p[0].length;t++){q.push(p.map(function(i){return[i[0],i[t]]}))}}var s=e.select(this.$.mainPlot).selectAll(".lineGroup");var o=s.selectAll("path");var l=e.svg.line().x(function(i){return m.xScale(i[0])}).y(function(i){return m.yScale(i[1])});if(v!==undefined&&v!==null&&v!==""){this.refreshXPrecision(v)}else{this.axes.main.xAxis.transition().ease("linear").call(this.axisGenerators.main.xAxisGenerator)}this.axes.main.yAxis.transition().ease("linear").call(this.axisGenerators.main.yAxisGenerator);o.data(q);o.attr("d",l);s.selectAll("path").transition()}},clearZoomPlot:function(){this.children[3].clearZoomPlot()},setupZoomPlot:function(g){this.children[3].setupZoomPlot(g)},zoomMainPlot:function(g){this.children[3].zoomMainPlot(g)},attached:function(){this.fire("xyplotattached")},ready:function(){this.fire("xyplotready")}})});