/*!  Copyright 2018 Dassault Systemes. All rights reserved. */
define("DS/SMAPoweredByViews/Skeleton/Collection/ADFilesCollection",["UWA/Core","UWA/Class/Model","UWA/Class/Collection","WebappsUtils/WebappsUtils","DS/SMAPoweredByViews/Skeleton/Model/FileModel","DS/SMAPoweredByState/ad-state-store","DS/SMAPoweredByState/ad-state-defs","DS/SMAPoweredByState/ad-state-domain-managed-data/selectors","DS/SMAPoweredByState/ad-state-domain-study/selectors","DS/SMAPoweredByState/ad-state-domain-jobs/selectors","DS/SMAPoweredByState/ad-state-domain-managed-data/actions","DS/SMAPoweredByViews/Utils/ADDataFormatUtils","DS/SMAPoweredByState/ad-state-redux-observer","i18n!DS/SMAPoweredByViews/assets/nls/ADFileCollection"],function(e,F,b,E,o,D,C,j,A,y,v,d,f,r){var I={};var G={FOLDER:"Simulation Folder",VERSIONED_DOCUMENT:"Simulation Document - Versioned",NON_VERSIONED_DOCUMENT:"Simulation Document - NonVersioned",DESIGN_SIGHT:"DesignSight",PHYSICS_SIMULATION:"Physics Simulation",FILE:"file",FILE_VERSION:"fileversion",CORE_REFERENCE:"PLMCoreReference",REP_REFERENCE:"PLMCoreRepReference",VPM_REFERENCE:"VPMReference",PHYSICAL_PRODUCT:"Physical Product"},B={FOLDER:"folder",VERSIONED_DOCUMENT:"vdocument",NON_VERSIONED_DOCUMENT:"nvdocument",SIMULATION:"simulation",FILE:"file",VERSION:"version",INVALID_FILE:"invalidfile",PART:"part"},q={SAVING:"upload-cloud",DELETING:"trash",DONE:"check",INVALID:"alert"},s={SAVING:C.PersistenceOperation.CREATING,DELETING:C.PersistenceOperation.DELETING,DONE:"CLEAN",INVALID:"INVALID"},p="file-type-",c=p+"skeleton";var l=function(L){var M=c+" "+p;switch(L.type){case G.FOLDER:M+=B.FOLDER;break;case G.VERSIONED_DOCUMENT:M+=B.VERSIONED_DOCUMENT;break;case G.NON_VERSIONED_DOCUMENT:M+=B.NON_VERSIONED_DOCUMENT;break;case G.DESIGN_SIGHT:case G.PHYSICS_SIMULATION:case j.Types.PROJECTION3DX:M+=B.SIMULATION;break;case G.FILE:M+=(L.latestVersionInvalid?B.INVALID_FILE:B.FILE);break;case G.FILE_VERSION:M+=B.VERSION;break;case G.CORE_REFERENCE:case G.REP_REFERENCE:case G.VPM_REFERENCE:case G.PHYSICAL_PRODUCT:M+=B.PART;break;default:M+=(L.latestVersionInvalid?B.INVALID_FILE:B.FILE);break}return M},H=function(L){return L.sort(function(N,M){var P=N.name,O=M.name;if(typeof P==="undefined"){P=N.title}if(typeof O==="undefined"){O=M.title}if(P.toLowerCase()===O.toLowerCase()){return 0}else{return P.toLowerCase()<O.toLowerCase()?-1:1}})},a=function(L){return typeof L.name!=="undefined"?L.name:L.title},n=function(L){var M=L.type;if(L.type===j.Types.FILE){M=d.getFileExtension(a(L))}else{if(L.type===j.Types.SIMULATION_OBJECT){M=r.SimulationObject}}return M},u=function(L){return l(L)},t=function(M){var L="";if(M.type===j.Types.FILE){L=d.formatFileSize(M.size)}return L},J=function(M,O,N){var L=null;if(N.latestVersionInvalid){L=s.INVALID}else{if(M){L=s.SAVING}else{if(O){L=s.DELETING}else{L=s.DONE}}}return L},h=function(L,O,M){var N="";if(M.latestVersionInvalid){N=q.INVALID}else{if(L){N=q.SAVING}else{if(O){N=q.DELETING}else{N=q.DONE}}}return N},k=function(M,O,N){var L="";if(N.latestVersionInvalid){L=r.Invalid}else{if(M){L=r.Uploading}else{if(O){L=r.Deleting}else{L=r.Saved}}}return L},K=function(L,O,P,M){var Q=j.getFileUploadProgress(P,M),R=Q?Math.round(Q.uploaded/Q.total*100):null,N=k(L,O,M);if(R!==null){N=k(L,O,M)+" "+R+"%"}else{N=k(L,O,M);if(!O&&M.modified){N+=" ("+d.timeAgo(M.modified)+")"}}return N},x=function(O,N){var M=j.managedDataChildren(O,N.id,true),L="";if(M&&M.length>1){L=M.length+" "+r.Versions}return L},w=function(O,N){var M=[],L=x(O,N);if((N.type!==j.Types.PROJECTION3DX)&&L){M.push(L)}if((N.type!==j.Types.PROJECTION3DX)&&(N.type!==j.Types.PROJECTION)&&j.isFileParentReferenced(O,N)===true){M.push(r.Referenced)}if((N.type!==j.Types.PROJECTION3DX)&&(N.type!==j.Types.PROJECTION)&&j.managedDataParent(O,N.id,false).type===G.NON_VERSIONED_DOCUMENT){M.push(r.NonVersioned)}return M.join(", ")},g=function(M,N){if(typeof M==="undefined"||M.length!==N.length){return false}var L=function(O){return O.sort(function(Q,P){if(Q.id===P.id){return 0}else{return Q.id<P.id?-1:1}}).reduce(function(P,Q){return P+Q.persistenceOperation+Q.name+Q.description+Q.size+Q.modified+Q.referenced+(typeof Q.uploadProgress!=="undefined"?Q.uploadProgress.uploaded:"")},"")};return L(M)===L(N)},z=function(){var N=j.allManagedData(this.store.getState(),null,[j.Types.CATEGORY,j.Types.FOLDER,j.Types.DOCUMENT,j.Types.NVDOCUMENT,j.Types.RDOCUMENT,j.Types.FILEVERSION]),M=y.jobProjectedOutputs(this.store.getState(),null),L=A.isReadOnly(this.store.getState()),O=this.pluck("id");M.forEach(function(Q){var P=N.filter(function(S){return S.name===Q.name}),R=Q;if(P.length===0){N.push(Q)}else{R=P[0]}R.uploadingJob=Q.id});N=H(N);N.forEach(function(Z){var T=(j.isFileUploading(this.store.getState(),Z)||Z.uploadingJob),ag=j.isFileDeleting(this.store.getState(),Z),S=Z.id,ah=Z.type,U=u(Z),ad=a(Z),X=n(Z),ab=w(this.store.getState(),Z),aa=d.formatTimestamp(Z.modified).replace(/,/g,""),ai=null,W=t(Z),Q=J(T,ag,Z),R=h(T,ag,Z),ac=K(T,ag,this.store.getState(),Z),Y=k(T,ag,Z),af=Z.uploadingJob?Z.uploadingJob:null,P=Z.latestVersionInvalid,ae=Z.latestVersion;if(!Z.modified||Z.modified===""){ai=Date.now()}else{ai=Z.modified}if(O.indexOf(S)===-1){this.add(new o({id:S,image:U,title:ad,type:ah,fileType:X,subtitle:ab,modified:aa,modifiedTimeStamp:ai,size:W,status:Q,statusIcon:R,displayStatus:ac,statusTooltip:ac,displayStatusTable:Y,readOnly:L,latestVersionInvalid:P,latestVersion:ae,uploadingJob:af}))}else{var V=this.get({id:S});if(V.get("type")!==ah){V.set("type",ah)}if(V.get("title")!==ad){V.set("title",ad)}if(V.get("subtitle")!==ab){V.set("subtitle",ab)}if(V.get("modified")!==aa){V.set("modified",aa)}if(V.get("size")!==W){V.set("size",W)}if(V.get("image")!==U){V.set("image",U)}if(V.get("fileType")!==X){V.set("fileType",X)}if(V.get("readOnly")!==L){V.set("readOnly",L)}if(V.get("latestVersion")!==ae){V.set("latestVersion",ae)}if(V.get("latestVersionInvalid")!==P){V.set("latestVersionInvalid",P)}if(V.get("uploadingJob")!==af){V.set("uploadingJob",af)}if(V.get("status")!==Q||T){V.set("status",Q);V.set("statusIcon",R);V.set("displayStatus",ac);V.set("statusTooltip",ac);V.set("displayStatusTable",Y)}}}.bind(this));O.forEach(function(Q){var S=N.map(function(T){return T.id}),P=(S.indexOf(Q)===-1);if(P){var R=this.get(Q);R.dispatchEvent("onItemRemoved");this.remove({id:Q})}}.bind(this));this.sort()},m=function(Q,N){var R=N.get("id");var M=j.managedDataWithID(Q,R);var P=j.isFileUploading(Q,M)||M.type===j.Types.PROJECTION3DX,L=j.isFileDeleting(Q,M),O=K(P,L,Q,M);N.set("displayStatus",O);N.set("statusTooltip",O)},i=b.extend({models:[o],comparator:function(R,T){var M;var N=R.get("modifiedTimeStamp");var S=T.get("modifiedTimeStamp");var O=R.get("type")===j.Types.PROJECTION3DX;var P=T.get("type")===j.Types.PROJECTION3DX;var L=R.get("type")===j.Types.PROJECTION;var Q=T.get("type")===j.Types.PROJECTION;Number(N)>=Number(S)?M=-1:M=1;if(L||Q){M=(L)?-1:1}if(O||P){M=(O)?-1:1}return M},setup:function(){this.store=D.getStore();this._observer=new f();this._observer.observeStore({store:this.store,select:j.allManagedData,compareFunc:g,onChange:z.bind(this)});this._observer.observeStore({store:this.store,select:y.jobProjectedOutputs,selectArguments:[null],compareFunc:g,onChange:z.bind(this)});this._observer.observeStore({store:this.store,select:A.isReadOnly,onChange:function(){z.call(this,j.allManagedData(this.store.getState()))}.bind(this)})},sync:function(){}});I.getCollection=function(){return i};I.syncModelFromState=function(M,L){m(M,L)};return I});