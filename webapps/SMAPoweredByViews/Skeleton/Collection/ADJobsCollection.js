/*!  Copyright 2018 Dassault Systemes. All rights reserved. */
define("DS/SMAPoweredByViews/Skeleton/Collection/ADJobsCollection",["UWA/Core","UWA/Class/Model","UWA/Class/Collection","WebappsUtils/WebappsUtils","DS/SMAPoweredByViews/Skeleton/Model/JobModel","DS/SMAPoweredByState/ad-state-store","DS/SMAPoweredByState/ad-state-redux-observer","DS/SMAPoweredByState/ad-state-domain-jobs/actions","DS/SMAPoweredByState/ad-state-domain-jobs/selectors","DS/SMAPoweredByState/ad-state-domain-job-types/selectors","DS/SMAPoweredByState/ad-state-domain-study/selectors","DS/SMAPoweredByViews/Utils/ADDataFormatUtils","DS/SMAPoweredByState/ad-state-defs","DS/SMAPoweredByHandler/ADHandlerFactory"],function(j,q,z,h,g,t,u,v,w,o,p,n,l,f){var A={};var m=[];function e(B){return B?n.formatTimestamp(B).replace(/,/g,""):""}function i(D,C){var B=C?o.jobTypeWithID(D.getState(),C):null;return B?B.title:""}function c(E,C){var D=false;if(E.length<C.length){D=true}else{for(var B=0;B<C.length;B++){if(E.indexOf(C[B].id)===-1){D=true;break}}}return D}function x(C,B){if(C.started===B.started){return 0}else{if(C.started===0){return -1}else{if(B.started===0){return 1}else{return C.started>B.started?-1:1}}}}function b(D,C){if(typeof D==="undefined"||D.length!==C.length){return false}var B=function(E){return E.sort(function(G,F){if(G.id===F.id){return 0}else{return G.id<F.id?-1:1}}).reduce(function(F,G){return F+G.id+G.title+G.description+G.status+(G.progress?JSON.stringify(G.progress):"")+G.started+G.ended+G.jobType+G.uninitialized+G.persistenceOperation},"")};return B(D)===B(C)}var y=function(C,B){for(var D in B){if(C.get(D)!==B[D]){C.set(D,B[D])}}};var r=function(K,M,C){var E=w.batchJobIterations(K.getState(),C),G=E.length,D=M.Selectors.jobCompletedIteration(K.getState(),C),I=M.Selectors.jobRunningIteration(K.getState(),C),J=M.Selectors.jobFailedIteration(K.getState(),C),F=0,L=0,H="",B=0;if(D>J&&D>I&&D!==G){H=D+" / "+G+" Completed"}else{if(D===G){H=null}else{if(J>I&&J>D){H=J+" / "+G+" Failed"}else{if(I>D&&I>J){H=I+" / "+G+" Running"}}}}if(G>0){F=D/G*100;L=J/G*100;B=I/G*100}return{progressMessage:H,iterationsCompletedPer:F,iterationsFailedPer:L,iterationsRunningPer:B}};function a(B,D,G){var F=G.pluck("id"),E=p.isReadOnly(D.getState()),C=n.getLoadingJobData();if(c(F,B)&&F.length>0){G.reset();F=[]}B.sort(x);B.forEach(function(R){var L=G.get({id:R.id}),U=R.id,ab=R.title,P=R.description,V=R.jobType,S=w.isBatchJob(D.getState(),R.id),O=R.jobType,W={},N=i(D,V),I=e(R.started),M=e(R.ended),Y=E;if(S){O=O+" "+S}var T,X,Q,aa,K;if(V&&m[O]&&m[O].handler){var J=m[O].handler,H=J.getJobTile(U,D.getState()).stepsMapping,Z=n.getFormattedJobData(R,H);T=J.getJobTile(U,D.getState()).iconClass;X=R.status;Q=Z.status;aa=Z.tooltip;K=Z.icon;if(S){W=r(D,J,U)}}else{T=C.image;X=C.status;Q=C.displayStatus;aa=C.displayStatus;K=C.icon}if(L){y(L,{image:T,title:ab,subtitle:P,status:X,displayStatus:Q,displayStatusTable:Q,statusTooltip:aa,statusIcon:K,jobType:N,started:I,ended:M,readOnly:Y,progressMessage:W.progressMessage,iterationsCompletedPer:W.iterationsCompletedPer,iterationsFailedPer:W.iterationsFailedPer,iterationsRunningPer:W.iterationsRunningPer})}else{L=new g({id:U,image:T,title:ab,subtitle:P,status:X,displayStatus:Q,displayStatusTable:Q,statusTooltip:aa,statusIcon:K,jobType:N,started:I,ended:M,readOnly:Y,progressMessage:W.progressMessage,iterationsCompletedPer:W.iterationsCompletedPer,iterationsFailedPer:W.iterationsFailedPer,iterationsRunningPer:W.stepsRunningPer});G.add(L)}if(V&&m[O]){L.setFacets(m[O].facets);L.set("handler",m[O].handler)}});F.forEach(function(J){var I=B.map(function(L){return L.id}),H=(I.indexOf(J)===-1);if(H){var K=G.get(J);K.dispatchEvent("onItemRemoved");G.remove({id:J})}});G.dispatchEvent("collectionLoaded",{})}function k(B,C,E){var D=[];var F=C.getState();E.getJobFacets(B,F).forEach(function(H){var G=new Promise(function(I){require([H.amd.url],function(J){I({title:H.title,icon:H.icon,view:J})})});D.push(G)});return Promise.all(D).then(function(G){return Promise.resolve({handler:E,facets:G})})}function s(C){var B=w.toolJobs(C);return B.filter(function(D){return D.status!==w.JobStatus.CONFIGURING})}function d(B){var E=this.store,F=this,D=[];B.forEach(function(H){if(H.jobType){var J=w.isBatchJob(E.getState(),H.id);var G=H.jobType;if(J){G=G+" "+J}if(!m[G]){m[G]={};var I=f.getHandler({jobId:H.id,store:E}).then(k.bind(null,H.id,E)).then(function(K){m[G]={handler:K.handler,facets:K.facets}});D.push(I)}}});var C=w.isJobsInitialized(E.getState());if(C||F.length!==0){this.isReady=Promise.all(D).then(function(){var G=s(E.getState());a(G,E,F)})}}A.getCollection=function(){return z.extend({models:[g],setup:function(){this.store=t.getStore();this._observer=new u();this._observer.observeStore({store:this.store,select:s,compareFunc:b,onChange:d.bind(this)});this._observer.observeStore({store:this.store,select:p.isReadOnly,onChange:function(){if(p.studyID(this.store.getState())){d.call(this,s(this.store.getState()))}}.bind(this)})},sync:function(){}})};return A});