/*!  Copyright 2018 Dassault Systemes. All rights reserved. */
define(["DS/SMAPoweredByState/ad-state-app-alerts/actions","DS/SMAPoweredByState/ad-state-app-alerts/selectors","DS/SMAPoweredByState/ad-state-app/actions","DS/SMAPoweredByState/ad-state-domain-connector-definitions/actions","DS/SMAPoweredByState/ad-state-cos/actions","DS/SMAPoweredByState/ad-state-domain/actions","DS/SMAPoweredByState/ad-state-domain-job-types/actions","DS/SMAPoweredByState/ad-state-domain-study-templates/actions","DS/SMAPoweredByState/ad-state-app/selectors","DS/SMAPoweredByState/ad-state-domain-connector-definitions/selectors","DS/SMAPoweredByState/ad-state-cos/selectors","DS/SMAPoweredByState/ad-state-domain-job-types/selectors","DS/SMAPoweredByState/ad-state-domain-study/selectors","DS/SMAPoweredByState/ad-state-domain-study-templates/selectors","DS/SMAPoweredByState/ad-state-redux-observer","DS/SMAPoweredByViews/Utils/ADMonitorUtils"],function(w,k,p,A,d,u,o,l,q,v,m,f,n,x,r,a){var C={};C.AlertCodes={APP_REFRESH_STARTED:"SMAPoweredByViews.ad-refresh-utils.APP_REFRESH_STARTED",APP_REFRESH_COMPLETED:"SMAPoweredByViews.ad-refresh-utils.APP_REFRESH_COMPLETED",APP_REFRESH_FAILED:"SMAPoweredByViews.ad-refresh-utils.APP_REFRESH_FAILED",APP_REFRESH_TIMEOUT:"SMAPoweredByViews.ad-refresh-utils.APP_REFRESH_TIMEOUT",APP_REFRESH_ALREADY_REFRESHING:"SMAPoweredByViews.ad-refresh-utils.APP_REFRESH_ALREADY_REFRESHING"};var D={STARTING:"STARTING",COMPLETED:"COMPLETED",ABORTED:"ABORTED",FAILED:"FAILED"};var i=false;var b=25000,j="refreshApp";function B(E){return new Promise(function(G,F){if(i){E.status=D.ABORTED;E.errorCode=C.AlertCodes.APP_REFRESH_ALREADY_REFRESHING;F(E)}else{i=true;E.status=D.STARTING;G(E)}})}function s(E){return new Promise(function(H){if(E.dispatchAlerts){var G=j,J=null,F=null,I=null;switch(E.status){case D.STARTING:J=k.Level.INFO;F=C.AlertCodes.APP_REFRESH_STARTED;break;case D.COMPLETED:J=k.Level.SUCCESS;F=C.AlertCodes.APP_REFRESH_COMPLETED;break;case D.ABORTED:J=k.Level.WARNING;F=E.errorCode;break;case D.FAILED:default:J=k.Level.ERROR;F=E.errorCode;break}E.store.dispatch(w.addAlert(G,J,I,F))}H(E)})}function c(E){return new Promise(function(F){a.stopAllMonitors();F(E)})}function e(E){return new Promise(function(F){a.startAllMonitors();F(E)})}function t(E){return new Promise(function(G){var F=n.studyObject(E.store.getState());E.studyId=F?F.id:null;if(E.studyId){E.store.dispatch(u.reloadStudy(E.studyId))}E.store.dispatch(p.refreshApp());E.store.dispatch(A.refreshConnectorDefinitions());E.store.dispatch(d.refreshServers());E.store.dispatch(o.refreshJobTypes());E.store.dispatch(l.refreshStudyTemplates());G(E)})}function z(J){var E=q.isAppInitialized(J)&&!q.appPersistenceOperation(J),G=v.isConnectorDefinitionsInitialized(J)&&!v.connectorDefinitionsPersistenceOperation(J),F=m.isServersInitialized(J)&&!m.serversPersistenceOperation(J),H=f.isJobTypesInitialized(J)&&!f.jobTypesPersistenceOperation(J),L=x.isStudyTemplatesInitialized(J)&&!x.studyTemplatesPersistenceOperation(J);var I=n.studyObject(J),K=(I&&I.id)?!n.studyPersistenceOperation(J):true;return(E&&G&&F&&H&&L&&K)?null:false}function h(E){return new Promise(function(G,F){if(!E.observer){E.observer=new r()}E.observer.waitFor({store:E.store,select:z,timeout:b}).then(function(){E.status=D.COMPLETED;G(E)})["catch"](function(){E.status=D.FAILED;E.errorCode=C.AlertCodes.APP_REFRESH_TIMEOUT;F(E)})})}function g(E){return new Promise(function(F){i=false;F(E)})}function y(E){return B(E).then(s).then(c).then(t).then(h).then(e).then(s).then(g)["catch"](function(F){return e(F).then(s).then(function(H){if(H.errorCode!==C.AlertCodes.APP_REFRESH_ALREADY_REFRESHING){i=false}var G={errorCode:H.errorCode||C.AlertCodes.APP_REFRESH_FAILED};return Promise.reject(G)})})}C.refreshAll=y;return C});