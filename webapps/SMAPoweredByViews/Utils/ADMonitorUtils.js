/*!  Copyright 2018 Dassault Systemes. All rights reserved. */
define("DS/SMAPoweredByViews/Utils/ADMonitorUtils",["DS/Redux/Redux","DS/SMAPoweredByState/ad-state-store","DS/SMAPoweredByState/ad-state-domain-jobs/selectors","DS/SMAPoweredByState/ad-state-domain-work-data/selectors","DS/SMAPoweredByState/ad-state-cos/selectors","DS/SMAPoweredByState/ad-state-redux-observer","DS/SMAPoweredByMonitors/ad-monitor-jobs","DS/SMAPoweredByMonitors/ad-monitor-upload-jobs","DS/SMAPoweredByMonitors/ad-monitor-jobs-result","DS/SMAPoweredByMonitors/ad-monitor-work-data","DS/SMAPoweredByMonitors/ad-poll-work-directory","DS/SMAPoweredByState/ad-state-app-alerts/actions","DS/SMAPoweredByState/ad-state-app-alerts/selectors","DS/SMAPoweredByState/ad-state-app/selectors","DS/SMAPoweredByState/ad-state-app-credentials/selectors","DS/SMAPoweredByState/ad-state-app-credentials/actions","DS/SMAPoweredByState/ad-state-domain/actions","DS/SMAPoweredByState/ad-state-domain-study/selectors"],function(f,p,t,y,e,l,h,s,A,j,b,v,g,n,o,B,u,i){var F={};F.shouldPreventStopMonitoringOnce=false;var m={SHORT:10,MEDIUM:30,LONG:60},a=60000,x=null,G,k,C=function(I,H,K){var J;I=I?I:new l();return I.waitFor({store:p.getStore(),select:function(L){return t.jobWorkDirectory(L,H,K)},isResolved:function(O){J=O;var M=t.isTransientStation(p.getStore().getState(),H);var L=false,N=O&&O.path!==null&&O.path!=="";L=(O&&O.id&&M)||(N&&!M);return L},timeout:a}).then(function(){return{workDir:J,jobId:H}})["catch"](function(L){var M=I.getBoundActions(v,p.getStore().dispatch);M.addAlert("workDir",g.Level.ERROR,null,"SMAPoweredByViews.ad-monitor-utils.WorkDirNotLoaded");throw L})},w=function(H){if(!H){return Promise.reject(H)}x=x?x:new l();return x.waitFor({store:p.getStore(),select:e.runningStations,isResolved:function(L){var K=H.workDir;var J=false;var I=t.isTransientStation(p.getStore().getState(),H.jobId);if(I){return true}L.forEach(function(M){if(M.id===K.station){J=true;return false}return true});return J},timeout:a}).then(function(){return H})["catch"](function(I){var J=x.getBoundActions(v,p.getStore().dispatch);J.addAlert("station",g.Level.ERROR,null,"SMAPoweredByViews.ad-monitor-utils.StationNotLoaded");throw I})},z=function(H){return new Promise(function(K){H.needsCredentialsDlg=true;var J=t.jobWithID(p.getStore().getState(),H.workDir.mcsJobID);var I=e.isRunAsJob(p.getStore().getState(),J);if(I){H.needsCredentialsDlg=true;var M=y.getWorkDirUserInfo(p.getStore().getState(),H.workDir);var L=o.getCredentials(p.getStore().getState(),M.domainName,M.windowsUser,M.linuxUser);if(L){H.credentials=L;H.needsCredentialsDlg=false}}else{H.needsCredentialsDlg=false}K(H)})},c=function(H){return new Promise(function(Q,R){var K=e.serverWithID(p.getStore().getState(),H.workDir.server),O=e.stationWithID(p.getStore().getState(),K,H.workDir.station),M=t.jobDRMMode(p.getStore().getState(),H.workDir.mcsJobID),J=t.jobWithID(p.getStore().getState(),H.workDir.mcsJobID),I=t.jobOS(p.getStore().getState(),H.workDir.mcsJobID),N=e.isCustomDRMJob(p.getStore().getState(),J);if(H.needsCredentialsDlg){var L=y.getWorkDirUserInfo(p.getStore().getState(),H.workDir);if(!G){G=document.createElement("ad-credentials-dialog");G.store=p.getStore();document.querySelector("#skeletonHolder").appendChild(G)}var P=function(U){var T=U.detail;var S={};var V=i.studyObject(p.getStore().getState());S.serverId=H.workDir.server;S.domainName=T.domainName;S.windowsUser=T.windowsUser;S.linuxUser=T.linuxUser;S.windowsPassword=T.windowsPassword;S.linuxPassword=T.linuxPassword;S.enoviaUser=V.owner;S.drmMode=M;S.jobId=H.workDir.mcsJobID;this.store.dispatch(u.saveCredentials(S))};G.removeEventListener("saveCredentials",P);G.addEventListener("saveCredentials",P);G.resume=function(){return x.waitFor({store:this.store,select:function(T){var S=t.jobExecutionOptions(T,H.workDir.mcsJobID);return S.credentialsID},isResolved:function(S){if(S){return true}return false},timeout:a}).then(function(){var T=t.jobExecutionOptions(p.getStore().getState(),H.workDir.mcsJobID);if(T.credentialsID){var S=o.getCredentialsByID(p.getStore().getState(),T.credentialsID);H.credentials=S;Q(H)}else{R(new Error("credentials not supplied"))}})};G.rejectAction=function(){R(new Error("credentials not supplied"))};G.populateDialog(O,K,N,null,I);G.populateCredentials(L);G.showDialog()}else{Q(H)}})},q=function(J,H,K,I){return C(J,H,K).then(w).then(z).then(c).then(function(L){j.startExecDirMonitor(L.workDir.id,I,L.credentials)})["catch"](function(L){console.log(L)})},r=function(Q,M,J){var K=t.isJobDone(Q.getState(),M,J),H=t.isJobSuccessful(Q.getState(),M,J),I=K?m.LONG:m.SHORT,O=t.isTransientStation(Q.getState(),M),P=t.jobExecutionOptions(Q.getState(),M),R=P.removeWorkDir,N=true;var S=i.isReadOnly(Q.getState());N=!S;if(S){x=x?x:new l();var L=x.getBoundActions(v,p.getStore().dispatch);L.addAlert("workdiraccess",g.Level.INFO,null,"SMAPoweredByViews.ad-monitor-utils.InsufficientAccess")}N=N&&!(H&&R);N=N&&(!K||!O);if(N){x=x?x:new l();x.unsubscribeAll();k=new Promise(function(T){x.waitFor({store:p.getStore(),select:function(U){return t.isJobClaimed(U,M,J)},timeout:a,isResolved:function(U){return U}}).then(function(){q(x,M,J,I).then(function(){T()})})})}},E=function(K,I,H,J){Promise.resolve({workDir:K}).then(z).then(c).then(function(L){j.startTailMonitor(I,H,J,20,0,L.credentials)})},D=function(){h.stopJobMonitor();s.stopUploadJobMonitor();A.stopMonitor();j.stopAllExecDirMonitors();b.stopAllPollExecutionDir()},d=function(){h.startJobMonitor(m.SHORT);s.startUploadJobMonitor(m.SHORT);A.startMonitor(m.SHORT);b.startPollExecutionDir(m.MEDIUM)};F.startAllMonitors=function(){d()};F.getMonitoringPromise=function(){return k};F.waitForWorkDir=function(I,H,J){return C(I,H,J)};F.checkIfCredentialsReq=function(H){return z(H)};F.getCredentialsFromUser=function(H){return c(H)};F.waitForStation=function(H){return w(H)};F.stopAllMonitors=function(){D()};F.startTailMonitor=function(K,I,H,J){E(K,I,H,J)};F.startExecDirMonitor=function(H,J,I){r(p.getStore(),H,J,I)};F.stopExecDirMonitor=function(H){j.stopExecDirMonitor(H)};F.stopAllTailMonitors=function(){j.stopAllTailMonitors()};return F});