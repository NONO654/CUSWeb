/*!  Copyright 2017 Dassault Systemes. All rights reserved. */
define(["DS/SMAPoweredByState/ad-state-redux-observer","DS/SMAPoweredByHandler/common/selectors","DS/SMAPoweredByState/ad-state-app/selectors","DS/SMAPoweredByState/ad-state-cos/selectors","DS/SMAPoweredByState/ad-state-domain-jobs/actions","DS/SMAPoweredByState/ad-state-domain-jobs/selectors"],function(c,f,g,b,e,d){var a={store:null,jobIds:[],stateRedux:new c()};a.startListening=function(h){if(this.jobIds.indexOf(h)===-1){this.jobIds.push(h);var j=this.stateRedux.getBoundActions(e,this.store.dispatch);this.stateRedux.observeStore({store:this.store,select:g.currentWhereUsedTenantID,onChange:function(m){if(!m){var l=d.jobExecutionOptions(this.store.getState(),h);if(l&&l.drmMode==="Cloud"){j.setJobExecutionDRMMode(h,"fiper")}}}});var i=false;this.stateRedux.observeStore({store:this.store,select:d.isTransientStation,selectArguments:[h],onChange:function(l){if(l){i=true;j.setJobExecutionRemoveWorkDirectory(h,true)}else{if(i){j.setJobExecutionRemoveWorkDirectory(h,false)}}}});this.stateRedux.observeStore({store:this.store,select:b.allServers,onChange:function(o){var m=d.jobExecutionOptions(this.store.getState(),h);if(m){var l=o.map(function(p){return p.id});var n=l.indexOf(m.server)!==-1;if(!n){o.forEach(function(p){if(p.isDefault){j.setJobExecutionServer(h,p.id)}})}}},arrayCompare:true});var k=function(m){var n=b.runningStations(m),l=d.jobExecutionOptions(m,h);return n.filter(function(o){return o.server===l.server})};this.stateRedux.observeStore({store:this.store,select:k,onChange:function(p){var m=d.jobExecutionOptions(this.store.getState(),h);if(m){p=p.filter(function(q){return q.server===m.server});if(m.drmMode&&(m.drmMode===b.DRMMode.FIPER)){var l=p.map(function(q){return q.id});if(l.length>0){var n=l.indexOf(m.station)!==-1;if(!n){var o=l.indexOf("{localhost}")!==-1;if(o){j.setJobExecutionStation(h,"{localhost}")}else{j.setJobExecutionStation(h,l[0])}}}}}},arrayCompare:true})}};a.setStore=function(h){this.store=h;this.jobIds=[]};a.unsubscribeAll=function(){this.stateRedux.unsubscribeAll()};return a});