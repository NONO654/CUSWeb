define(["UWA/Class","DS/SMAPoweredByState/ad-state-defs","DS/SMAPoweredByState/ad-state-cos/selectors","DS/SMAPoweredByState/ad-state-domain-jobs/selectors","DS/SMAPoweredByState/ad-state-domain-job-types/selectors","DS/SMAPoweredByState/ad-state-domain-managed-data/selectors","DS/SMAPoweredByState/ad-state-domain-work-data/selectors"],function(a,h,e,d,j,i,c){var g={osCommand:"com.dassault_systemes.sma.adapter.OSCommand",script:"com.dassault_systemes.sma.adapter.Script",v6Utility:"com.dassault_systemes.sma.adapter.V6Utility",v6UtilityPISimImport:"com.dassault_systemes.sma.plugin.V6UtilPIsimImport",v6UtilityPIResultsGen:"com.dassault_systemes.sma.plugin.V6UtilPIPhyResGenerate",download:"com.dassault_systemes.sma.adapter.Download",upload:"com.dassault_systemes.sma.adapter.Upload",cae3dx:"com.dassault_systemes.smampa.adapter.cae3dx"},b={OSCommandEnvironmentVariable:"oscmd_env_vars",NewSimulationResults:"NewSimulation_Results",SimulationTitle:"Simulation_Title"},f="dataTransfer_Job",k="__AdHoc__rule__";return{ACTIVITY_ID_PREFIX:"__ActivityID=",DATA_TRANSFER_KEY:f,JOB_OBJECT_KEYS:b,store:null,getInitialJobState:function(l){return{persistenceStatus:h.PersistenceStatus.CLEAN,id:l.id,eedJobID:null,kind:d.JobKind.TOOL,jobType:null,title:l.attributes.title,description:l.attributes.description?l.attributes.description:"",ready:false,started:0,ended:0,status:d.JobStatus.CONFIGURING,inputs:[],mainInputFile:null,outputs:[],configuration:{},resultsOptions:{},executionOptions:{}}},setJobType:function(r,q,p){var l=null,m=this.getSteps(r);for(var o=0;o<m.length;o++){if((m[o].FlowItem.stepConfig.extensionName===g.osCommand)&&(l===null)){var n=m[o].FlowItem.stepConfig.properties.PredefinedCommandOptions.Application;l=j.latestJobTypeWithTitle(p,n.appName)}}q.jobType=l},setInputsState:function(l,p,m){var s=this.getDownloadStep(l),q=null,v,u,n,o,t,r;p.inputs=[];if(s&&s.FlowItem.stepConfig.properties.rules){v=s.FlowItem.stepConfig.properties.rules;Object.keys(v).forEach(function(w){q=null;if(v[w].name.indexOf(k)>=0){if(v[w].type.toLowerCase()!=="file"){q=v[w].referenceId}else{u=i.managedDataWithID(m,v[w].referenceId);if(u){n=i.managedDataChildren(m,u.id);if(n.length===1){if(v[w].sourceFileVersion){o=i.managedDataChildren(m,n[0].id);for(r=0;r<o.length;r++){if(o[r].version===v[w].sourceFileVersion){q=o[r].id;break}}}else{q=n[0].id}}else{for(t=0;t<n.length;t++){if(n[t].name===v[w].sourceFileName){if(v[w].sourceFileVersion){o=i.managedDataChildren(m,n[t].id);for(r=0;r<o.length;r++){if(o[r].version===v[w].sourceFileVersion){q=o[r].id;break}}}else{q=n[t].id}}if(q){break}}}}}}else{if(!p.activityTemplateRules){p.activityTemplateRules=[]}p.activityTemplateRules.push(v[w])}if(q){p.inputs.push(q)}})}},setConfigurationArgumentsState:function(o,l){var n=this.getOSCommandStep(o),m;l.configuration.arguments=[];if(n&&n.FlowItem.stepConfig.properties.PredefinedCommandOptions&&n.FlowItem.stepConfig.properties.PredefinedCommandOptions.Application){l.configuration.application={appName:n.FlowItem.stepConfig.properties.PredefinedCommandOptions.Application.appName,appVersion:n.FlowItem.stepConfig.properties.PredefinedCommandOptions.Application.appVersion};if(n.FlowItem.stepConfig.properties.PredefinedCommandOptions.Application.values){m=n.FlowItem.stepConfig.properties.PredefinedCommandOptions.Application.values;Object.keys(m).forEach(function(p){l.configuration.arguments.push({id:m[p].id,name:m[p].name,optionType:m[p].optionType,separatorValue:m[p].separatorValue?m[p].separatorValue:null,value:m[p].value?m[p].value:null,active:m[p].optionType==="Standalone"?true:null})})}}},setJobCommandState:function(n,l){var m=this.getOSCommandStep(n);l.configuration.command=null;if(m&&m.FlowItem.stepConfig.properties.command){l.configuration.command=m.FlowItem.stepConfig.properties.command}},setEnvironmentVariablesState:function(p,n){var o=this.getOSCommandStep(p),l,m;n.configuration.environmentVariables=[];if(o&&o.FlowItem.stepConfig.properties[b.OSCommandEnvironmentVariable]&&o.FlowItem.stepConfig.properties[b.OSCommandEnvironmentVariable].values){o.FlowItem.stepConfig.properties[b.OSCommandEnvironmentVariable].values.forEach(function(q){Object.keys(q).forEach(function(r){l=q[r];if(l){m=l.split("=");if(m.length===2){n.configuration.environmentVariables.push({name:m[0].trim(),value:m[1].trim()})}}})})}},setOutputFileSpecsState:function(n,m){var l=this.getUploadStep(n);m.configuration.outputFileSpecsEnabled=false;m.configuration.outputFileSpecs=[];if(l){if(l.FlowItem.ExecutionConfig&&(typeof(l.FlowItem.ExecutionConfig.isExecutable)==="undefined"||l.FlowItem.ExecutionConfig.isExecutable.toLowerCase()!=="false")){m.configuration.outputFileSpecsEnabled=true}if(l.FlowItem.stepConfig.properties.rules){l.FlowItem.stepConfig.properties.rules.forEach(function(o){if(o.sourceFileName&&(o.sourceFileName.length>0)&&o.enabled&&(o.enabled.toLowerCase()==="true")){m.configuration.outputFileSpecs.push(o.sourceFileName)}})}}},setExecutionOptionsState:function(p,o,n){var l=this.getExecutionConfig(p),m;o.executionOptions={drmMode:e.DRMMode.FIPER,os:e.OS.WINDOWS};if(l.drmMode){if(l.drmMode.toLowerCase()==="cloud"){o.executionOptions.drmMode=e.DRMMode.CLOUD;if(l.CloudConfig){if(l.CloudConfig.os&&(l.CloudConfig.os.toLowerCase()==="linux")){o.executionOptions.os=e.OS.LINUX}if(l.CloudConfig.numprocs){o.executionOptions.numProcs=l.CloudConfig.numprocs}}}else{if(l.drmMode.toLowerCase()==="fiper"){if(l.affinities&&l.affinities.Host){o.executionOptions.station=l.affinities.Host}}}}o.executionOptions.removeWorkDir=(l.keepdirtype!=="2");if(l.workingdir){m=c.workDataExecDirByLocation(n,o.executionOptions.station,l.workingdir);if(m){o.executionOptions.workDirectory=m.id}}},setOutputFileSpecsPLM:function(n,p){var m=this.getUploadStep(p),o,l=0;if(m){m.FlowItem.ExecutionConfig.isExecutable=n.configuration.outputFileSpecsEnabled?"true":"false";m.FlowItem.stepConfig.properties.rules=[];if(n.configuration.outputFileSpecs){n.configuration.outputFileSpecs.forEach(function(q){l++;o={enabled:"true",id:String(l),name:k+l,referenceId:null,sourceFileName:q,title:null,type:"Simulation Document - Versioned"};m.FlowItem.stepConfig.properties.rules.push(o)})}}},setResultsOptionsState:function(m,l){l.resultsOptions={generateResults:false,generateResultsUnitsDefault:null,generateResultsUnits:null,generateResultsUnitsEnabled:false}},setV6UtilityLanguagePLM:function(m){var l=this.getV6UtilitySteps(m);l.forEach(function(n){n.FlowItem.stepConfig["3DX_LANG"]=window.navigator.userLanguage||window.navigator.language})},getDownloadStep:function(o){var l=this.getSteps(o),n=null,m;for(m=0;m<l.length;m++){if(l[m].FlowItem.stepConfig.extensionName===g.download){n=l[m];break}}return n},getUploadStep:function(o){var l=this.getSteps(o),n=null,m;for(m=l.length-1;m>=0;m--){if(l[m].FlowItem.stepConfig.extensionName===g.upload){n=l[m];break}}return n},getOSCommandStep:function(o){var l=this.getSteps(o),n=null,m;for(m=0;m<l.length;m++){if(l[m].FlowItem.stepConfig.extensionName===g.osCommand){n=l[m];break}}return n},getV6UtilitySteps:function(o){var m=this.getSteps(o),l=[],n;for(n=0;n<m.length;n++){if(m[n].FlowItem.stepConfig.extensionName===g.v6Utility){l.push(m[n])}}return l},getSteps:function(m){var l=[];if(m.attributes&&m.attributes.definition&&m.attributes.definition.flowItem&&m.attributes.definition.flowItem.implementations&&(m.attributes.definition.flowItem.implementations.length>0)&&m.attributes.definition.flowItem.implementations[0].children){l=m.attributes.definition.flowItem.implementations[0].children}return l},getSimImportUtilityStep:function(p){var l=this.getSteps(p),o=null,n,m;for(n=0;n<l.length;n++){if(l[n].FlowItem.stepConfig.extensionName===g.v6Utility){if(l[n].FlowItem.stepConfig.childConfigs){for(m=0;m<l[n].FlowItem.stepConfig.childConfigs.length;m++){if(l[n].FlowItem.stepConfig.childConfigs[m].pluginConfig&&l[n].FlowItem.stepConfig.childConfigs[m].pluginConfig.extensionName&&l[n].FlowItem.stepConfig.childConfigs[m].pluginConfig.extensionName===g.v6UtilityPISimImport){o=l[n];break}}}}}return o},getResultsGenUtilityStep:function(p){var l=this.getSteps(p),o=null,n,m;for(n=0;n<l.length;n++){if(l[n].FlowItem.stepConfig.extensionName===g.v6Utility){if(l[n].FlowItem.stepConfig.childConfigs){for(m=0;m<l[n].FlowItem.stepConfig.childConfigs.length;m++){if(l[n].FlowItem.stepConfig.childConfigs[m].pluginConfig&&l[n].FlowItem.stepConfig.childConfigs[m].pluginConfig.extensionName&&l[n].FlowItem.stepConfig.childConfigs[m].pluginConfig.extensionName===g.v6UtilityPIResultsGen){o=l[n];break}}}}}return o},buildResultsOptionsUnitsState:function(p){var n={},l,o,m;if(p){l=p.split(":");for(o=0;o<l.length;o++){m=l[o].split("=");if(m.length===2){n[m[0]]=m[1]}}}return n},getExecutionConfig:function(m){var l=null;if(m.attributes&&m.attributes.definition&&m.attributes.definition.flowItem&&m.attributes.definition.flowItem.ExecutionConfig&&m.attributes.definition.flowItem.ExecutionConfig.properties){l=m.attributes.definition.flowItem.ExecutionConfig.properties}return l},getActivityConfig:function(m){var l=null;if(m.attributes&&m.attributes.definition&&m.attributes.definition.flowItem&&m.attributes.definition.flowItem.ActivityConfig&&m.attributes.definition.flowItem.ActivityConfig.properties){l=m.attributes.definition.flowItem.ActivityConfig.properties}return l},setInputsPLM:function(q,s,p){var m=this.getDownloadStep(s),o=0,l,r,n;if(m&&typeof(m.FlowItem.ExecutionConfig.isExecutable)==="undefined"){m.FlowItem.ExecutionConfig={isExecutable:true}}if(m){m.FlowItem.stepConfig.properties.rules=[];if(q.activityTemplateRules){q.activityTemplateRules.forEach(function(t){o++;m.FlowItem.stepConfig.properties.rules.push(t)})}q.inputs.forEach(function(t){o++;l=i.managedDataWithID(p,t);if(l){n=i.managedDataParent(p,l.id,false);r={id:String(o),values:[],name:k+o};if(l.type==="file"){r.referenceId=n.id;r.type="file";r.title=l.name;r.sourceFileName=l.name}else{if(l.type==="fileversion"){r.referenceId=i.managedDataParent(p,n.id,false).id;r.type="file";r.title=l.name;r.sourceFileName=n.name;r.sourceFileVersion=l.version}else{if(l.type==="Document"){r.referenceId=l.id;r.type="file";r.title=l.title;r.sourceFileName="*"}else{r.referenceId=l.id;r.type=l.type;r.title=l.title;r.sourceFileName="*"}}}m.FlowItem.stepConfig.properties.rules.push(r)}})}},setConfigurationArgumentsPLM:function(m,o){var n=this.getOSCommandStep(o),l;if(n&&typeof(n.FlowItem.ExecutionConfig.isExecutable)==="undefined"){n.FlowItem.ExecutionConfig={isExecutable:true}}if(n&&n.FlowItem.stepConfig.properties.PredefinedCommandOptions&&n.FlowItem.stepConfig.properties.PredefinedCommandOptions.Application){n.FlowItem.stepConfig.properties.PredefinedCommandOptions.Application.values=[];if(m.configuration.arguments){m.configuration.arguments.forEach(function(p){l={optionType:p.optionType,name:p.name,id:p.id};if(p.separatorValue){l.separatorValue=p.separatorValue}if(p.value){l.value=p.value}if((p.displayed!==false)&&(((p.optionType!=="Option-Value")&&(p.optionType!=="Standalone"))||(p.value)||(p.active))){n.FlowItem.stepConfig.properties.PredefinedCommandOptions.Application.values.push(l)}})}}},setJobCommandPLM:function(l,n){var m=this.getOSCommandStep(n);if(l.configuration.command){m.FlowItem.stepConfig.properties.command=l.configuration.command}},setEnvironmentVariablesPLM:function(m,p){var o=this.getOSCommandStep(p),n,l=0;if(o&&o.FlowItem.stepConfig.properties[b.OSCommandEnvironmentVariable]){o.FlowItem.stepConfig.properties[b.OSCommandEnvironmentVariable].values=[{0:null}];if(m.configuration.environmentVariables&&(m.configuration.environmentVariables.length>0)){o.FlowItem.stepConfig.properties[b.OSCommandEnvironmentVariable].values=[];m.configuration.environmentVariables.forEach(function(q){n={};n[String(l)]=q.name+"="+q.value;o.FlowItem.stepConfig.properties[b.OSCommandEnvironmentVariable].values.push(n);l++})}}},setResultsOptionsPLM:function(n,p){var m=this.getSimImportUtilityStep(p),l=this.getResultsGenUtilityStep(p),o;if(m&&l){m.FlowItem.ExecutionConfig.isExecutable=n.resultsOptions.generateResults?"true":"false";l.FlowItem.ExecutionConfig.isExecutable=n.resultsOptions.generateResults?"true":"false";m.FlowItem.stepConfig.childConfigs[0].pluginConfig.properties.ImportUnits=this.buildResultsOptionsUnitsPLM(n.resultsOptions);m.FlowItem.stepConfig.childConfigs[0].pluginConfig.properties.PLMBatchArguments[b.NewSimulationResults]=n.resultsOptions.generateResultsSourceFilename;o=(n.resultsOptions.generateResultsTitle&&(n.resultsOptions.generateResultsTitle.length>0))?n.resultsOptions.generateResultsTitle:n.resultsOptions.generateResultsSourceFilename;if(o){m.FlowItem.stepConfig.childConfigs[0].pluginConfig.properties.PLMBatchArguments[b.SimulationTitle]=o.replace(/\.[^/.]+$/,"")}}},buildResultsOptionsUnitsPLM:function(n){var l="",m,o,q,p;if(n){m=n.generateResultsUnitsEnabled?n.generateResultsUnits:n.generateResultsUnitsDefault;if(m){q=Object.keys(m);for(o=0;o<q.length;o++){p=m[q[o]];if(p){l+=(q[o]+"="+p);if(o<(q.length-1)){l+=":"}}}}}return l},setExecutionOptionsPLM:function(r,s,q){var m=this.getExecutionConfig(s),l=this.getActivityConfig(s),o,p=null,n;m.keepdirtype=((r.executionOptions===e.DRMMode.CLOUD)||r.executionOptions.removeWorkDir)?"0":"2";if(r.executionOptions.drmMode){if(r.executionOptions.drmMode===e.DRMMode.FIPER){m.drmMode="fiper";m.affinities={Host:r.executionOptions.station};delete m.CloudConfig}else{if(r.executionOptions.drmMode===e.DRMMode.CLOUD){m.drmMode="Cloud";m.CloudConfig={numprocs:r.executionOptions.numProcs};m.CloudConfig.os="windows";if(r.executionOptions.os===e.OS.LINUX){m.CloudConfig.os="linux"}m.monitorFiles=true;delete m.affinities}}}if(r.executionOptions.workDirectory){o=c.workDataWithID(q,r.executionOptions.workDirectory);if(o){p=o.path}}m.workingdir=p;n=this.getSteps(s);n.forEach(function(t){if(!t.FlowItem.ExecutionConfig){t.FlowItem.ExecutionConfig={}}t.FlowItem.ExecutionConfig.workingdir=p});if(r.executionOptions.licenseOptions){l.SXALicenseOptions=r.executionOptions.licenseOptions}},setJobTypeConfig:function(n,o,m){var l=j.jobTypeWithID(m,n.jobType);o.attributes.definition.flowItem.ActivityConfig.properties.jobType={title:l.title,revision:l.revision}},isApplicationDefined:function(m){var l=m.FlowItem.stepConfig.properties.PredefinedCommandOptions.Application;return l&&typeof l.appName!=="undefined"}}});