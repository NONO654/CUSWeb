/*!  Copyright 2017 Dassault Systemes. All rights reserved. */
define(["DS/SMAPoweredByState/ad-state-redux-observer","DS/SMAPoweredByState/ad-state-app/selectors","DS/SMAPoweredByState/ad-state-cos/selectors","DS/SMAPoweredByState/ad-state-domain-jobs/actions","DS/SMAPoweredByState/ad-state-app-alerts/actions","DS/SMAPoweredByState/ad-state-domain-jobs/selectors","DS/SMAPoweredByState/ad-state-domain-managed-data/selectors","DS/SMAPoweredByHandler/abaqus/selectors"],function(a,b,f,j,c,g,i,d){var e={store:null,jobIDs:[],stateRedux:new a()},h={SPACE_IN_JOB:"SMAPoweredByHandler.rules.SPACE_IN_JOB",LONG_JOB_NAME:"SMAPoweredByHandler.rules.LONG_JOB_NAME",ILLEGAL_CHARACTER_IN_JOB:"SMAPoweredByHandler.rules.ILLEGAL_CHARACTER_IN_JOB"};e.startListening=function(n){if(this.jobIDs.indexOf(n)===-1){this.jobIDs.push(n);var k=this.stateRedux.getBoundActions(j,this.store.dispatch),m=this.stateRedux.getBoundActions(c,this.store.dispatch);this.stateRedux.observeStore({store:this.store,select:g.jobArgumentValue,selectArguments:[n,"job"],onChange:function(o){if(o){k.setJobTitle(n,o);k.setJobGenerateResultsSourceFilename(n,o+".sim");k.setJobGenerateResultsTitle(n,o)}}});this.stateRedux.observeStore({store:this.store,select:g.jobArgumentValue,selectArguments:[n,"job"],onChange:function(o){if(o&&o.length>89){k.addJobArgument(n,"job",o.substr(0,89));m.addAlert("rules","warning",null,h.LONG_JOB_NAME)}}});this.stateRedux.observeStore({store:this.store,select:g.jobArgumentValue,selectArguments:[n,"job"],onChange:function(o){if(o&&(!d.isValidString(o,d.OBJECTTYPES.ACTIVITY)||o.indexOf("'")!==-1||o.indexOf(" ")!==-1)){k.addJobArgument(n,"job",o.replace(/["#$@%*,?\\<>[\]|:'\s]/g,"_"));m.addAlert("rules","warning",null,h.ILLEGAL_CHARACTER_IN_JOB)}}});this.stateRedux.observeStore({store:this.store,select:g.jobArgumentValue,selectArguments:[n,"input"],onChange:function(o){if(o){var q=o.split("\\");var p=q[q.length-1].split(".");p.pop();k.addJobArgument(n,"job",p.join(".").split(" ").join("_"))}}});this.stateRedux.observeStore({store:this.store,select:g.jobMainInput,selectArguments:[n],onChange:function(o){if(o){if(i.managedDataWithID(this.store.getState(),o).type!==i.Types.RDOCUMENT){k.addJobArgument(n,"input",i.managedDataWithID(this.store.getState(),o).name)}else{k.addJobArgument(n,"input",i.managedDataWithID(this.store.getState(),o).title)}}}});this.stateRedux.observeStore({store:this.store,select:g.jobExecutionOptions,selectArguments:[n],onChange:function(o){if(o&&o.licenseOptions){if(o.drmMode==="Cloud"&&o.licenseOptions.licenseType==="traditionalTokens"){k.setJobExecutionSXALicenseType(n,"credits")}}}});this.stateRedux.observeStore({store:this.store,select:d.isCloudEnabled,onChange:function(o){if(!o){var p=g.jobExecutionOptions(this.store.getState(),n);if(p&&p.drmMode==="Cloud"){k.setJobExecutionDRMMode(n,"fiper")}if(p&&p.licenseOptions&&p.licenseOptions.licenseType!=="traditionalTokens"){k.setJobExecutionSXALicenseType(n,"traditionalTokens")}}}});this.stateRedux.observeStore({store:this.store,select:b.currentWhereUsedTenantID,onChange:function(p){if(!p){var o=g.jobExecutionOptions(this.store.getState(),n);if(o&&o.licenseOptions&&o.licenseOptions.licenseType!=="traditionalTokens"){k.setJobExecutionSXALicenseType(n,"traditionalTokens")}}}});var l=false;this.stateRedux.observeStore({store:this.store,select:d.isGenerateResultsAllowed,selectArguments:[n],onChange:function(p){var o=g.jobGenerateResults(this.store.getState(),n);if(o&&!p){l=true;k.setJobGenerateResults(n,false)}else{if(!o&&p&&l){l=false;k.setJobGenerateResults(n,true)}}}})}};e.setStore=function(k){this.store=k;this.jobIDs=[]};e.unsubscribeAll=function(){this.stateRedux.unsubscribeAll()};return e});