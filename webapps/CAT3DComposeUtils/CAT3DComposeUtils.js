/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/CAT3DComposeUtils/CAT3DComposeAnimation",["UWA/Class"],function(a){var b=a.extend({init:function(c){var k=c||{};var d=0;var e=null;var h=false;var g=k.nbSteps;var j=k.animationTime/g;var f=1;var i=false;if(g&&g>0&&j&&j>0){i=typeof k.onAnimation==="function";if(k.onBeforeFirstAnimation&&i){i=i&&(typeof k.onBeforeFirstAnimation==="function")}if(k.onAnimationEnd&&i){i=i&&(typeof k.onAnimationEnd==="function")}}this.forceInitAnimation=function(){f=0;d=0;if(e){clearInterval(e);e=null}};this.animate=function(l){if(i){if(f!==l){clearInterval(e);e=null}f=l;if(!h){if(k.onBeforeFirstAnimation){k.onBeforeFirstAnimation()}h=true}e=setInterval(function(){var m=false;if(f===0){if(d>=100/g){d-=100/g;m=true}else{d=0}}else{if(d<=100-(100/g)){d+=100/g;m=true}else{d=100}}if(m){k.onAnimation(d,f)}else{clearInterval(e);e=null;if(k.onAnimationEnd){k.onAnimationEnd(d)}}},j)}}}});return b});define("DS/CAT3DComposeUtils/CAT3DCompose3DAnimation",["UWA/Core","UWA/Class","DS/Animation/PropertyAnimation","DS/Animation/ANIM","DS/Mesh/MeshUtils","DS/Visualization/ThreeJS_DS","DS/CAT3DComposeWidget/CAT3DComposeWidgetOptions","DS/SceneGraphOverrides/SceneGraphOverrideSet"],function(m,n,h,f,d,l,g,i){var e=function(o){if(o==="opacityOn"||o==="opacityOff"||o==="showAxis"||o==="hideAxis"){return 100}if(o==="cancel"||o==="unsnap"){return 200}if(o==="snap"){return 400}if(o==="move"||o==="rotate"){return 100}return null};var j=(function(){var t=new l.Quaternion(),u=new l.Quaternion();var q=new l.Vector3(),p=new l.Vector3(),r=new l.Vector3(),s=new l.Vector3();return function o(x){if(!x.matrixSource||!x.matrixTarget){return null}x.matrixSource.decompose(q,t,r);x.matrixTarget.decompose(p,u,s);var y=t.slerp(u,x.factor);var v=q.lerp(p,x.factor);var w=r.lerp(s,x.factor);return new l.Matrix4().compose(v,y,w)}}());var k=(function(){var p=new l.Vector3(),q=new l.Vector3(1,1,1);return function o(u){if(!u.obj.quaternionSource||!u.obj.quaternionTarget||!u.obj.centerRotation||!u.obj.matrixSource){return null}u.obj.quaternionSource=u.obj.quaternionSource.slerp(u.obj.quaternionTarget,u.factor);var t=new l.Matrix4().compose(p,u.obj.quaternionSource,q);var s=new l.Matrix4().setPosition(u.obj.centerRotation);var r=t.multiply(new l.Matrix4().getInverse(s).multiply(u.obj.matrixSource));return s.multiply(r)}}());var b=n.extend({init:function(p){var r={},u={},q=[],t=g.getOption("animationOff"),o=p.viewer,s=o.getSceneGraphOverrideSetManager();r.opacityOn=function(w){if(w.progress<0){return}var v=0.7;if(w.progress>=30){v=(w.progress-100)*(w.util.opacityOnEnd-0.7)/70+w.util.opacityOnEnd}if(v<0){v=0}w.util.objectListToAnimate.forEach(function(x){if(x.override){x.override.setOpacity(v,true)}});o.render()};r.opacityOff=function(w){if(w.progress<0){return}var v=0.3+0.7*(w.progress/100);if(w.progress===100||v>1){v=1}w.util.objectListToAnimate.forEach(function(x){if(x.override){x.override.setOpacity(v,true)}});o.render()};r.opacityOnOff=function(w){if(w.progress<0){return}var v=0.7;if(w.progress<=50){v=-0.014*w.progress+1}else{v=0.014*w.progress+1-1.4}if(w.progress===100||v>1){v=1}else{if(v<0){v=0}}w.util.objectListToAnimate.forEach(function(x){if(x.override){x.override.setOpacity(v,true)}});o.render()};r.snap=function(v){if(v.progress<0){return}v.util.objectListToAnimate.forEach(function(B){if(B.override){var y=null;var A=B.override.getPosition();if(A){y=new l.Matrix4().copy(A)}else{var x=new l.Matrix4().copy(B.initWorldMatrix);var w=new l.Matrix4().getInverse(B.path.getParentPath().getWorldMatrix());y=w.multiply(x)}var z=B.snappedPosition;B.override.setPosition(j({matrixSource:y,matrixTarget:z,factor:v.progress/100}))}});o.render()};r.unsnap=function(v){if(v.progress<0){return}v.util.objectListToAnimate.forEach(function(z){if(z.override){var x=null;if(z.currentPosition){x=new l.Matrix4().copy(z.currentPosition)}else{var y=z.override.getPosition();x=new l.Matrix4().copy(y)}var w=z.snappedPosition;z.override.setPosition(j({matrixSource:w,matrixTarget:x,factor:v.progress/100}))}});o.render()};r.cancel=function(v){if(v.progress<0){return}if(v.progress===100){v.util.objectListToAnimate.forEach(function(w){if(w.override){w.override.setPosition(null)}})}else{v.util.objectListToAnimate.forEach(function(w){w.lastMatrix=j({matrixSource:w.currentMatrix,matrixTarget:w.initMatrix,factor:v.progress/100});if(w.override){w.override.setPosition(w.lastMatrix)}})}o.render()};r.move=function(w){if(w.progress<0){return}if(!w.util.iterationData){w.util.iterationData=[];w.util.objectListToAnimate.forEach(function(x){w.util.iterationData.push({matrixSource:new l.Matrix4().copy(x.matrixSource),matrixTarget:x.matrixTarget,override:x.override})})}if(w.progress!==0){var v=w.progress/100;w.util.iterationData.forEach(function(y){if(y.override){var x=j({matrixSource:y.matrixSource,matrixTarget:y.matrixTarget,factor:v});y.override.setPosition(x);y.matrixSource=x}});o.render()}};r.rotate=function(w){if(w.progress<0){return}if(!w.util.iterationData){w.util.iterationData=[];var y=new l.Vector3(),x=new l.Vector3();w.util.objectListToAnimate.forEach(function(A){var C=new l.Quaternion();A.matrixRotation.decompose(y,C,x);var B=A.matrixParent?new l.Vector3().copy(A.centerRotation).applyMatrix4(A.matrixParent):A.centerRotation;var z=A.matrixParent?new l.Matrix4().multiplyMatrices(A.matrixParent,A.matrixSource):A.matrixSource;w.util.iterationData.push({quaternionSource:new l.Quaternion(),quaternionTarget:C,centerRotation:B,matrixSource:z,matrixParentInv:A.matrixParentInv,override:A.override})})}if(w.progress!==0){var v=w.progress/100;w.util.iterationData.forEach(function(A){if(A.override){var z=k({obj:A,factor:v});A.override.setPosition(A.matrixParentInv?new l.Matrix4().multiplyMatrices(A.matrixParentInv,z):z)}});o.render()}};r.color=function(v){if(v.progress<0){return}v.util.objectListToAnimate.forEach(function(w){if(w.override){w.override.setColor(v.util.color,true)}});o.render()};u.visibility=(function(){function w(y,x,z){y.setVisibility(x);y.setPickable(z?d.PICKABLE:d.NODRAWHL);y.getChildren().forEach(function(A){w(A,x,z)})}return function v(y){var x=y.progress/100;if(!y.util.visibility){x=1-x}y.util.objectListToAnimate.forEach(function(z){if(z.node||z.children){(z.node||z).children.forEach(function(A){if(A.setRatio){A.setRatio(x)}else{A.children.forEach(function(B){if(B.setRatio){B.setRatio(x)}})}})}});if(t||(y.progress===100&&y.util.visibility)||(y.progress===0&&!y.util.visibility)){y.util.objectListToAnimate.forEach(function(z){if(z.override){z.override.setPickability(y.util.pickability?"PICKABLE":null)}})}if(t||(y.progress===0&&y.util.visibility)||(y.progress===100&&!y.util.visibility)){y.util.objectListToAnimate.forEach(function(z){var A;if(z.override){z.override.setVisibilityFree(!y.util.visibility);z.override.setVisibility(y.util.visibility)}else{A=z.parents[0];if(A&&A.name==="AxisSystems"){A.setVisibilityFree(false)}z.setVisibilityFree(!y.util.visibility);w(z,y.util.visibility,y.util.pickability)}if(z.node||z.children){(z.node||z).children.forEach(function(B){if(B.setRatio){B.setRatio(1)}else{B.children.forEach(function(C){if(C.setRatio){C.setRatio(1)}})}})}})}o.render()}}());this.addAnimation=function(y){if(this.isRunning()){return{returnCode:-1}}if(!y||!y.objectListToAnimate||!y.animationType||(!r[y.animationType]&&y.animationType!=="mask"&&y.animationType!=="unmask"&&y.animationType!=="opacityOnOff")){return{returnCode:-1}}var w=y.objectListToAnimate,C=y.callBackFct;if(y.createOverrideSet===true){var z=new i(y.objectListToAnimate[0].path.externalPath[0]);s.pushSceneGraphOverrideSet(z);w=[];if(y.animationType==="mask"||y.animationType==="unmask"||y.animationType==="color"||y.animationType==="opacityOnOff"){var D=[];y.objectListToAnimate.forEach(function(E){if(!E.override&&E.path){D.push(E.path)}});if(D.length){w.push({override:z.createOverride({pathes:D})})}}else{y.objectListToAnimate.forEach(function(F){if(!F.override&&F.path){var E=m.extend({},F);E.override=z.createOverride({pathes:F.path});w.push(E)}})}C=function(){s.removeSceneGraphOverrideSet(z);if(y.callBackFct){y.callBackFct()}o.render()}}if(y.animationType==="mask"){return this.addAnimation({animationType:"opacityOn",duration:typeof y.duration==="number"?y.duration:e(y.animationType),opacityOnEnd:0,objectListToAnimate:w,offsetTime:y.offsetTime,callBackFct:function(){w.forEach(function(E){if(E.override){E.override.setVisibility(false);E.override.setVisibilityFree(true);E.override.setOpacity(null,null)}});if(C){C()}o.render()}})}else{if(y.animationType==="unmask"){w.forEach(function(E){if(E.override){E.override.setOpacity(0);E.override.setVisibility(true);E.override.setVisibilityFree(null)}});return this.addAnimation({animationType:"opacityOff",duration:typeof y.duration==="number"?y.duration:e(y.animationType),objectListToAnimate:w,offsetTime:y.offsetTime,callBackFct:function(){if(C){C()}w.forEach(function(E){if(E.override){E.override.setOpacity(null,null);E.override.setVisibility(null)}});o.render()}})}}var A={objectListToAnimate:w,callback:C};if(y.animationType==="opacityOn"){A.opacityOnEnd=typeof y.opacityOnEnd==="number"?y.opacityOnEnd:0.3}else{if(y.animationType==="color"){A.color=y.color}}var v=t?0:(typeof y.offsetTime==="number"?y.offsetTime:0);var x=t?0:(typeof y.duration==="number"?y.duration:e(y.animationType));if(w.length===0){x=0}var B={duration:function(){return x+v},valueAt:function(E){return{progress:E<v?-1:(x===0?100:((E-v)/x)*100),util:A}}};q.push(new h(r,y.animationType,B,function(E){if(E===f.State.STOPPED){if(C){C()}q.splice(q.indexOf(this),1)}else{if(E===f.State.RUNNING&&B.duration()===0){this.stop()}}}));return{returnCode:0}};this.startAnimation=function(){if(this.isRunning()){return{returnCode:-1}}q.slice().forEach(function(v){v.start()});return{returnCode:0}};this.isRunning=function(){return q.some(function(v){return v.state()===f.State.RUNNING})};this.forward=function(){q.forEach(function(v){v.setTime(v.duration())});this.stop()};this.stop=function(){q.slice().forEach(function(v){v.stop()})};this.axisSystemVisibility=function(w){var y={objectListToAnimate:w.objectListToAnimate,visibility:w.visibility,pickability:w.pickability},x=t?0:(typeof w.duration==="number"?w.duration:e(w.visibility?"showAxis":"hideAxis")),v={duration:function(){return x},valueAt:function(z){return{progress:x===0?100:(z/x)*100,util:y}}};new h(u,"visibility",v,function(z){if(z===f.State.STOPPED){if(w.callBackFct){w.callBackFct()}}else{if(z===f.State.RUNNING&&v.duration()===0){this.stop()}}}).start();return{returnCode:0}};this.getDefaultDuration=function(v){return e(v)}}});var c=[];var a=n.singleton({init:function(){},get3DComposeAnimationEngine:function(p){var q;if(p&&p.viewer){c.some(function(r){if(r.viewer===p.viewer){q=r.engine;return true}return false});if(!q){var o=new b({viewer:p.viewer});c.push({viewer:p.viewer,engine:o});q=o}}return q}});return a});define("DS/CAT3DComposeUtils/CAT3DComposeUnits",["i18n!DS/CAT3DComposeUtils/assets/nls/CAT3DComposeUtils"],function(a){var b={Types:{Length:{name:"Length",defaultValue:"mm"},Angle:{name:"Angle",defaultValue:"deg"},Volume:{name:"Volume",defaultValue:"mm3"},Area:{name:"Area",defaultValue:"mm2"}},Length:{mm:{name:"mm",nls:a.units.mm,ratio:1},cm:{name:"cm",nls:a.units.cm,ratio:Math.pow(10,-1)},m:{name:"m",nls:a.units.m,ratio:Math.pow(10,-3)},km:{name:"km",nls:a.units.km,ratio:Math.pow(10,-6)},inch:{name:"inch",nls:a.units.inch,ratio:1/25.4},foot:{name:"foot",nls:a.units.foot,ratio:1/304.8}},Angle:{deg:{name:"deg",nls:a.units.deg,ratio:1},rad:{name:"rad",nls:a.units.rad,ratio:Math.PI/180}},Volume:{mm3:{name:"mm3",nls:a.units.mm3,ratio:1},cm3:{name:"cm3",nls:a.units.cm3,ratio:Math.pow(10,-3)},m3:{name:"m3",nls:a.units.m3,ratio:Math.pow(10,-9)},km3:{name:"km3",nls:a.units.km3,ratio:Math.pow(10,-18)},inch3:{name:"inch3",nls:a.units.inch3,ratio:1/16387.064},foot3:{name:"foot3",nls:a.units.foot3,ratio:1/28316846.6}},Area:{mm2:{name:"mm2",nls:a.units.mm2,ratio:1},cm2:{name:"cm2",nls:a.units.cm2,ratio:Math.pow(10,-2)},m2:{name:"m2",nls:a.units.m2,ratio:Math.pow(10,-6)},km2:{name:"km2",nls:a.units.km2,ratio:Math.pow(10,-12)},inch2:{name:"inch2",nls:a.units.inch2,ratio:1/645.16},foot2:{name:"foot2",nls:a.units.foot2,ratio:1/92903.04}}};return Object.freeze(b)});define("DS/CAT3DComposeUtils/CATC3DUtils",["DS/PADUtils/PADSettingsMgt"],function(e){var d,b,g;function f(i,p,l,n){var k=l.length,h=i.getFrameWindow().getViewpoint().reframe,j,o,m=function(){k--;if(k===0){i.unsubscribe(j);i.unsubscribe(o);i.getFrameWindow().getViewpoint().reframe=h;n(l)}};j=i.subscribe({event:"onInsertExisting"},m);o=i.subscribe({event:"onInsertExistingFailure"},m);i.getFrameWindow().getViewpoint().reframe=function(){};l.forEach(function(q){if(q.instID){i.getController().switchAuthoringMode(true,true,"PADSession_disabling_index_authoring");i.getController().insertExisting({created:[q.instID],inserted:[[p,q.instID,q.childID]],modified:[p]})}else{m()}})}function c(l,h,k){if(h){var j={onComplete:function(){k()},onFailure:function(){k();window.console.log("Unable to store matrix")}};if(d==="DEC"){var i="";[0,1,2,4,5,6,8,9,10,12,13,14].forEach(function(m){i+=h.elements[m]+(m!==14?",":"")});j.enopad_webapis=e.getSetting("enopad_webapis");j.data=[{id:l,attributes:[{name:"matrixtxt",value:i}]}];if(b){b.modify(j)}else{k()}}else{if(d==="VPM"){j.instances=[{instance:l,hasPositioningMatrix:[0,1,2,4,5,6,8,9,10,12,13,14].map(function(m){return h.elements[m]})}];if(g){g.move3D(j)}}else{k()}}}else{k()}}function a(j){if(typeof j.parentID!=="string"||!(j.children instanceof Array)||typeof j.onCompleted!=="function"||!j.context){return}if(!d){var i=e.getSetting("appModelerType");if(i==="DEC"){require(["DS/PADUtils/PADWSAccess"],function(l){b=l;d=i;a(j)})}else{if(i==="VPM"){require(["DS/AuthGenericCommands/AuthGenericCmdWSAccess","DS/UPSCommands/UPSCmdUtils"],function(l,m){b=l;g=m;d=i;a(j)})}else{d="Error";window.console.error("Unknown modeler type");a(j)}}return}var k=j.parentID,h=[];if(d==="DEC"){j.children.forEach(function(l){b.insertExisting({data:{parent:k,child:l.id,commit:true},onComplete:function(n){var o=typeof n==="string"?JSON.parse(n):null;if(o&&o.status==="success"){var m=o.newNode.attributes[0].value;c(m,l.matrix,function(){h.push({instID:m,childID:l.id});if(j.children.length===h.length){f(j.context,k,h,j.onCompleted)}})}else{h.push({instID:null,childID:l.id,message:o&&o.message?o.message:undefined});if(j.children.length===h.length){f(j.context,k,h,j.onCompleted)}}},onFailure:function(m){var n=typeof m==="string"?JSON.parse(m):null;h.push({instID:null,childID:l.id,message:n&&n.message?n.message:undefined});if(j.children.length===h.length){f(j.context,k,h,j.onCompleted)}}})})}else{if(d==="VPM"){j.children.forEach(function(l){b.insertExisting({modeler:"product",data:{version:"1.0",hasParent:k,children:[{isInstanceOf:l.id}]},onComplete:function(n){var o=typeof n==="string"?JSON.parse(n):null;if(o&&o.status==="success"){var m=o.results[0].instance;c(m,l.matrix,function(){h.push({instID:m,childID:l.id});if(j.children.length===h.length){f(j.context,k,h,j.onCompleted)}})}else{h.push({instID:null,childID:l.id,message:o&&o.message?o.message:undefined});if(j.children.length===h.length){f(j.context,k,h,j.onCompleted)}}},onFailure:function(m){var n=typeof m==="string"?JSON.parse(m):null;h.push({instID:null,childID:l.id,message:n&&n.message?n.message:undefined});if(j.children.length===h.length){f(j.context,k,h,j.onCompleted)}}})})}}}return Object.freeze({insertExisting:a})});define("DS/CAT3DComposeUtils/CATC3DDropManager",["UWA/Class","DS/PADUtils/PADTypesMgt","DS/Visualization/ThreeJS_DS","DS/CAT3DComposeWidget/CAT3DComposeWidgetOptions","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/Selection/PSOManager","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/CATC3DGeometry/CATC3DGeometryEnums","DS/PADUtils/PADUtilsServices","DS/CoreEvents/ModelEvents","DS/CAT3DComposeMoveManager/CATC3DMoveReferent","DS/CAT3DComposeMoveManager/CAT3DComposeMoveManager","DS/ApplicationFrame/Command","DS/CAT3DComposeUtils/CATC3DUtils","i18n!DS/PADUtils/assets/nls/PADUtils.json","i18n!DS/CAT3DComposeUtils/assets/nls/CATC3DDropManager.json"],function(s,f,t,b,i,n,h,r,u,g,m,c,p,q,o,e,v){var k=b.getOption("authoring3d"),d=["CATProduct","CATPart","VPMReference","3DShape"],a=["CATProduct","VPMReference"];var l=s.extend({init:function(y){var F=y.context,D=F.getViewer(),E,C,I,H=this,N,J=new q({ID:"CATC3DDropMngFakeCmdHdr",context:F.getCommandContext?F.getCommandContext():null});function M(ab,R,V,Y){function W(ae){var ad=new t.Matrix4();ae.externalPath.forEach(function(af){ad.multiply(af.getMatrix())});return ad}if(V){if(V.length===1){Y();return}var U=W(R),Q=V.filter(function(ae,ad){return ad%2});F.getController().getAttributes({ids:Q,attributes:["matrixtxt"],callbacks:{onComplete:function(af){var ae=new t.Matrix4(),ad=new t.Matrix4();Q.forEach(function(ah){if(af[ah]&&af[ah].matrixtxt){var ag=af[ah].matrixtxt.replace(/^\[?|\]?$/g,"").split(",").map(parseFloat);ad.set(ag[0],ag[3],ag[6],ag[9],ag[1],ag[4],ag[7],ag[10],ag[2],ag[5],ag[8],ag[11],0,0,0,1);ae.multiply(ad)}});Y(ad.getInverse(U).multiply(ae))},onFailure:function(){Y()}}})}else{var Z,T=W(R),P=T.clone(),X=ab.equivalentGeometry?ab.equivalentGeometry.getType():null;switch(X){case u.GeometryType.POINT:Z=ab.equivalentGeometry.getPoint();break;case u.GeometryType.LINE:case u.GeometryType.CYLINDER:case u.GeometryType.CONE:var aa=ab.equivalentGeometry.getEndPoints();var ac=new t.Line3(aa.startPoint,aa.endPoint);Z=ab.position?ab.position.clone():null;if(Z){var S=ac.closestPointToPointParameter(Z,true);Z=ac.at(S>=0.5?1:0)}break;case u.GeometryType.CIRCLE:case u.GeometryType.SPHERE:Z=ab.equivalentGeometry.getCenter();break;case u.GeometryType.AXISSYSTEM:T=W(ab.pathElement);break;default:Z=ab.position?ab.position.clone():null}if(Z){T.setPosition(Z)}Y(new t.Matrix4().getInverse(P).multiply(T))}}function K(R){if(E){return{pathElement:E.clone()}}var P=D.pick(D.getMousePosition(new t.Vector2(R.offsetX,R.offsetY)),"primHybrid",true);if(!P||!P.path||P.path.length===0){return undefined}var Q=P.path[0];if(!Q||!Q.externalPath||Q.externalPath.length<2||!i.isAModelPath(Q)){return undefined}if(i.is3DLeaf(Q.externalPath[1])&&Q.externalPath.length>2){Q.externalPath.splice(2);Q.internalPath=[]}return{pathElement:Q,position:P.position}}function A(R,Q){try{f.retrieveAuthorizedObjects({displayNotif:false,dnd_event:R,version:"2.0",callback:function(T){var S={unauthorized:[],add:[],insert:[]};if(T.unauthorized_objects&&T.unauthorized_objects.length){S.unauthorized=T.unauthorized_objects}Object.keys(T.authorizedWithKind).forEach(function(U){if(U==="Product"){T.authorizedWithKind.Product.forEach(function(V){if(d.indexOf(V.objectType)===-1){S.add.push(V)}else{S.insert.push(V)}})}else{T.authorizedWithKind[U].forEach(function(V){S.add.push(V)})}});Q(S)}})}catch(P){window.console.log("")}}function w(Q){var P=n.get(),R=P.length?P[0].pathElement:null,S=!(R&&P[0].equivalentGeometry);return Q?!S:S}function G(){var P=i.getRoots(F);if(!P.length){return true}if(!P.some(function(R){return R&&!i.is3DLeaf(R)})){return true}var Q=E?E.getLastElement(true):null;if(Q&&Q.name==="RootBag"){return true}if(Q&&(!i.isPLMNode(Q)||a.indexOf(i.getNodeType(Q))===-1)){return true}return false}function x(T){if(G()){return}if(C){var R=C.getPosition();var S=C.getSize();if(R.x===0&&R.y===0){R.x=D.SCREEN_WIDTH/2-S.width/2;R.y=D.SCREEN_HEIGHT/2-S.height/2}if(R.x<=T.offsetX&&T.offsetX<=(R.x+S.width)&&R.y<=T.offsetY&&T.offsetY<=(R.y+S.height)){C.setOpacity(0)}else{var Q=Math.max(Math.min(T.offsetX,R.x+S.width),R.x);var V=Math.max(Math.min(T.offsetY,R.y+S.height),R.y);var U=Math.sqrt((T.offsetX-Q)*(T.offsetX-Q)+(T.offsetY-V)*(T.offsetY-V));if(U<200){C.setOpacity(U/200)}else{C.setOpacity(1)}}}var P=K(T);if(!P){n.empty();if(!E){return}}else{n.unique(P);n.get()[0].position=P.position}T.preventDefault();T.stopPropagation();F.elements.container.addClassName("bordered");document.querySelector(".paddnd_invite_display.insert .paddnd_invite_txt").setText(w(T.shiftKey)?"Insert object in position":"Insert");F._dropZoneContainer.show("insert")}function B(P){n.empty();h.empty();r.empty();C=document.querySelector(".paddnd_invite_container");return x(P)}function z(){if(C){C.setOpacity(1)}}function L(P){n.empty();return z(P)}function O(S){if(G()){return}if(C){C.setOpacity(1)}F._dropZoneContainer.hide();F.elements.container.removeClassName("bordered");var Q=n.get().slice();var P=E?E.clone():(Q.length?Q[0].pathElement:null);while(P){var R=P.getLastElement(true);if(R&&i.isReference(R)&&!i.is3DLeaf(R)){break}P=P.getParentPath()}if(!P){return}S.preventDefault();S.stopPropagation();A(S,function(X){if(X.unauthorized.length){X.unauthorized.forEach(function(aa){F.displayNotification({msg:e.replace(e.get("unsupported_type"),{type:aa.objectType,name:aa.displayName}),eventID:"warning"})})}if(X.insert.length){var T,U=false,Y=g.getPlatformId();for(T=0;T<X.insert.length;T++){if(Y!==X.insert[T].envId){X.insert.splice(T,1);U=true;T--}if(U){F.displayNotification({msg:v.Tenant_InsertInfo,eventID:"warning"})}}if(X.insert.length){var Z=i.getNodeID(P.getLastElement(true)),V=w(S.shiftKey),W=[];if(I){I.publish({event:"onBeginInsertDrop3D",data:{type:V?"inPosition":""}})}h.empty();r.empty();X.insert.forEach(function(ac){var aa=V?(ac.path?ac.path.map(function(ad){return ad.resourceid}):[ac.objectId]):null,ab=ac.objectId;M(Q[0],P,aa,function(ad){W.push({id:ab,matrix:ad});if(W.length===X.insert.length){J.begin();o.insertExisting({parentID:Z,children:W,context:F,onCompleted:function(ak){var ah=0,ae=r.get();ak.forEach(function(al){if(!al.instID){if(al.message){F.displayNotification({msg:al.message,eventID:"error"})}else{ah++}}});if(ah){F.displayNotification({msg:"Insertion failed",eventID:"error"})}var aj=p.getMoveManager({context:F});var af=c.getMoveReferentManager({context:F});ae.forEach(function(al){af.addMoveReferent(al.pathElement)});var ag=Q.length?Q[0].equivalentGeometry:null,ai=ag?ag.getType():null;if(ae.length&&(ai===u.GeometryType.LINE||ai===u.GeometryType.CYLINDER||ai===u.GeometryType.CONE||ai===u.GeometryType.PLANE||ai===u.GeometryType.REFPLANE)){require(["DS/CAT3DComposeConstraints/CAT3DComposeConstraintsController","DS/CATC3DGeometry/CATC3DEquivalentGeometry"],function(at,aq){if(!N){N=at.getConstraintsController({context:F})}N.deleteAllCst();var ao=aq.getEquivalentGeometry({pathElement:ae[0].pathElement,axis:N.getProductAxisForConstraint()});N.createCst({movable:{equivalentGeometry:ao},fixed:{equivalentGeometry:ag}});var ap=N.simulateSolveCst()||{};var am=ap.matrix||new t.Matrix4(),an=new t.Matrix4(),ar=ap.rc,al=ap.redundancy;if(ar===0&&!al){aj.onMoveBegin({objectsMoved:ae,from:H,moveMode:"Persistent"});ae.forEach(function(au){aj.onMove({objectsMoved:[{path:au.pathElement}],from:H,worldMatrix:an.multiplyMatrices(am,au.pathElement.getWorldMatrix())})});aj.onMoveEnd({from:H,status:"Moved"});F.getFrameWindow().getContextualUIManager().showContextualBar({x:S.offsetX+45,y:S.offsetY-45,hideWithDistance:true})}if(ae.length){require(["DS/CAT3DComposeBoxes/CAT3DComposeBoxController"],function(au){au.getBoxController({context:F}).refreshBoxes()})}if(I){I.publish({event:"onEndInsertDrop3D",data:{type:ae.length?(V?"inPosition":""):"cancelled"}})}})}else{if(ae.length){require(["DS/CAT3DComposeBoxes/CAT3DComposeBoxController"],function(al){al.getBoxController({context:F}).refreshBoxes()})}if(I){I.publish({event:"onEndInsertDrop3D",data:{type:ae.length?(V?"inPosition":""):"cancelled"}})}}}})}})})}}else{if(X.add.length){F.addRootNodesFromContent({json3DXContent:{data:{items:X.add}},dispatch:true,inContext:!S.shiftKey})}}})}this.connect=function(){if(!k){return}D.canvas.addEventListener("dragenter",B);D.canvas.addEventListener("dragover",x);D.canvas.addEventListener("dragleave",L);D.canvas.addEventListener("dragend",z);D.canvas.addEventListener("drop",O);E=null};this.disconnect=function(){if(!k){return}if(N){N.unreference()}D.canvas.removeEventListener("dragenter",B);D.canvas.removeEventListener("dragover",x);D.canvas.removeEventListener("dragleave",L);D.canvas.removeEventListener("dragend",z);D.canvas.removeEventListener("drop",O);E=null};this.setCurrentPath=function(P){E=P?P.clone():null};this.subscribe=function(P,Q){if(!I){I=new m()}return I.subscribe(P,Q)};this.unsubscribe=function(P){return I?I.unsubscribe(P):this}}});var j=[];return s.singleton({init:function(){},getDropManager:function(w){var x;if(w&&w.context&&w.context.name==="ENOPAD3DViewer"){j.some(function(y){if(y.context===w.context){x=y.dropMng;return true}return false});if(!x){x=new l({context:w.context});j.push({context:w.context,dropMng:x})}}return x},unreferenceDropManager:function(w){if(w&&w.context&&w.context.name==="ENOPAD3DViewer"){j.some(function(y,x){if(y.context===w.context){j.splice(x,1);return true}return false})}}})});