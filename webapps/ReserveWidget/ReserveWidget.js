define("DS/ReserveWidget/ReserveWidget",["UWA/Core","UWA/Controls/Abstract","DS/LifecycleControls/CommandDialog","DS/LifecycleServices/LifecycleServices","DS/WidgetServices/WidgetServices","DS/WidgetServices/securityContextServices/SecurityContextServices","DS/WAFData/WAFData","DS/Controls/Toggle","UWA/Utils/Cookie","css!DS/ReserveWidget/ReserveWidget","i18n!DS/ReserveWidget/assets/nls/ReserveWidgetNls","DS/LifecycleServices/LifecycleServicesSettings","DS/PADUtils/views/PADProgressBar","DS/Controls/ProgressBar"],function(i,g,h,f,d,m,k,l,a,c,o,e,n,b){var j=g.extend({TYPE_ROOT_FOLDER_1:"Workspace",TYPE_ROOT_FOLDER_2:"RootFolder",TYPE_FOLDER_1:"Workspace Vault",TYPE_FOLDER_2:"Folder",TYPE_FOLDER_3:"Workspace Folder",TYPE_PERSONAL_FOLDER_1:"Personal Workspace",instToggleCookieName:"ReserveWidget.Instance.Toggled",refToggleCookieName:"ReserveWidget.Reference.Toggled",CAD_ORIGIN_ATTR_NAME:"attribute[XCADExtension.V_CADOrigin]",defaultOptions:{serverName:"",serverUri:"",operation:"",currentUser:"",localContext:""},init:function(q){var s=this;this._parent(q);this.SelectedItems=[];this.FailureInfo=[];this.SuccessIds=[];this.V5DataIndex=[];this.SuccessInfo=[];this.listOfModified=[];var p={created:[],deleted:[],modified:[]};this.refreshDatas=p;this.labelWaitingOperation="";this.localContext=this.options.localContext;var r={context:this.localContext};m.getInstance(r).getSecurityContext()},isRootFolder:function(p){return p===this.TYPE_ROOT_FOLDER_1||p===this.TYPE_ROOT_FOLDER_2},isFolder:function(p){return(p===this.TYPE_FOLDER_1||p===this.TYPE_FOLDER_2||p===this.TYPE_FOLDER_3)},isPersonalFolder:function(p){return p===this.TYPE_PERSONAL_FOLDER_1},inFamilyFolder:function(p){return(this.isRootFolder(p)||this.isFolder(p)||this.isPersonalFolder(p))},setObjects:function(p){console.log("reserveWidget::SetObjects");console.log(p);if(p.length===0){throw o.noObject}var q=this;d.removeDuplicate(p,function(r){console.log("removing duplicates");return r.physicalId});p.forEach(function(r){if(r.hasOwnProperty("physicalId")&&r.physicalId!=""){console.log("adding an element in SelectedItems");q.SelectedItems.push(r)}else{console.log("the element has no physicalid")}})},updateDlg:function(){var q=this.instToggle.checkFlag;var p=this.refToggle.checkFlag;if(!q&&!p){this.cmdDlg._okButton.setDisabled(true)}else{this.cmdDlg._okButton.setDisabled(false)}},getDefaultToggles:function(){var r=a.get(this.instToggleCookieName);var q=a.get(this.refToggleCookieName);var s=r==="false"?false:true;var p=q==="false"?false:true;return[s,p]},saveDefaultToggles:function(){a.set(this.instToggleCookieName,this.instToggle.checkFlag);a.set(this.refToggleCookieName,this.refToggle.checkFlag)},onToggle:function(){this.updateDlg();this.saveDefaultToggles()},renderDlgContent:function(){var r=document.createElement("div");var p=this.getDefaultToggles();this.instToggle=new l({type:"checkbox",label:o.instance,checkFlag:p[0]});this.refToggle=new l({type:"checkbox",label:o.reference,checkFlag:p[1]});var q=this;this.instToggle.addEventListener("buttonclick",function(s){q.onToggle()});this.refToggle.addEventListener("buttonclick",function(s){q.onToggle()});this.instToggle.inject(r);this.refToggle.inject(r);return r},requestCADOrigins:function(t,p,q){var s=d.getTenantID();var r=["physicalid",this.CAD_ORIGIN_ATTR_NAME,"baseType"];f.listAttributes(s,t,r,p,q)},requestInstanceNames:function(s,p,r){var u=d.getTenantID();var q="/resources/v1/collabServices/reservation/op/getInstanceNames";var t=s.toString();f.post(u,q,t,p,r)},checkIfAllRoots:function(){var s=0;var p=this.SelectedItems.length;for(var r=0;r<p;r++){var t=this.SelectedItems[r];if(t.relID==""){s++}}var q=false;if(s==p){q=true}return q},checkIfAnyV6Instance:function(){var q=this.SelectedItems.length;for(var p=0;p<q;p++){if(this.SelectedItems[p].isV6Rel){return true}}return false},loadInstanceCADOrig:function(p,q){var t=this;var s=[];var u=this.SelectedItems.length;for(var r=0;r<u;r++){var v=this.SelectedItems[r].parentID;if(v!=""){s.push(v)}}if(s.length==0){p()}else{t.requestCADOrigins(s,function w(A){var B=A.results;var y=B.length;for(var C=0;C<y;C++){var G=B[C];var F=G.physicalid;var D=G.baseType;var E=true;if(D=="PLMEntity"&&G[t.CAD_ORIGIN_ATTR_NAME]){E=false}for(var z=0;z<u;z++){var x=t.SelectedItems[z];x.baseType=D;if((x.parentID==F)&&D=="PLMEntity"){x.isV6Rel=E}else{if(D!="PLMEntity"){x.isV6Rel=false}}}}p()},q)}},checkInputs:function(p,q){var r=this;this.loadInstanceCADOrig(function(){if(r.checkIfAllRoots()){p(false)}else{if(r.checkIfAnyV6Instance()){p(true)}else{p(false)}}},q)},launchCmd:function(){var r=this;r.checkInputs(function p(u){if(u){var t=r.renderDlgContent();var s=r.options.operation=="reserve"?o.reserveTitle:o.unreserveTitle;r.cmdDlg=new h();var v=r.cmdDlg.create(t,{title:s,closeButton:true,onOk:function(){r.execute();r.cmdDlg.destroy()}});v.inject(widget.body);v.setNewSize({});r.updateDlg()}else{r.execute()}},function q(s){console.log(s)})},reportV5Instances:function(p){if(p.length>0){var q=this;q.requestInstanceNames(p,function(s){var t=o.v5InstancesExcluded+"<br>";for(var r=0;r<s.length;r++){t+=s[r].name+"<br>"}q.showError(t)},function(r){q.showError(r)})}},startProgress:function(t,r){var u=this;u.chunkSize=r;if(t=="reserve"){u.labelWaitingOperation=UWA.i18n(o.reserving)}else{u.labelWaitingOperation=UWA.i18n(o.unreserving)}if(u.localContext){u.localContext.elements.container.addClassName("masked");var y=i.createElement("div",{"class":"mask"});var v=i.createElement("div",{"class":"PBwrapper"});var q=i.createElement("div",{"class":"PBcontent"});var x=i.createElement("span",{"class":"text",text:u.labelWaitingOperation});x.inject(q);var p=new UWA.Element("div",{"class":"wux-control-inline-container",style:{"vertical-align":"top"}});p.inject(q);q.inject(v);v.inject(y);y.inject(u.localContext.elements.container);u.options.renderTo=q;if(u.chunkSize>0){u.progressbar=new b({value:0}).inject(q)}else{u.progressbar=undefined;y.style.cursor="wait"}}u.modifiedElement=[];var s=[];var w=document.querySelectorAll(".wux-afr-cmdstarter");if(typeof w.forEach==="function"){w.forEach(function(z){if(!z.hasClassName("wux-ui-state-disabled")){z.addClassName("wux-ui-state-disabled");s.push(z)}})}u.modifiedElement=s},stopProgress:function(){var q=this;if(q.localContext){var r=q.localContext.elements.container.getElement(" > .mask");if(r){r.destroy()}q.localContext.elements.container.removeClassName("masked")}var p=[];p=q.modifiedElement;p.forEach(function(s){if(s.hasClassName("wux-ui-state-disabled")){s.removeClassName("wux-ui-state-disabled")}});q.options.renderTo=q.localContext.elements.container},updateProgress:function(q){var r=this;if(r.progressbar!=undefined){var p=r.progressbar;var s=p.value+((100/(q.length/r.chunkSize))/1);s=Math.min(s,100);console.log(s);p.value=s;console.log(p.value)}},getUrls:function(s,D,u){var A=this;var v=[];var q=[];var x=0;if(D==undefined){D=0;x=D+s.length-1}else{x=D+A.chunkSize-1}for(var E=D;E<=x&&E<s.length;E++){var p=s[E];if(!(p in v)){v[p]="";var F=p.split("/");var w="";if(F.length>0){w=F[F.length-1]}if(!(w in A.SuccessIds)){q.push(p)}if(u!=undefined&&u.length>0){var z=A.V5DataIndex[w];if(z>=0&&z<u.length){var r=u[z]["rel"];var y=r.split(",");for(var C=0;C<y.length;C++){if(y[C]&&y[C].length>0){var B="model/rel/"+y[C];v[B]="";var F=B.split("/");var w="";if(F.length>0){w=F[F.length-1]}if(!(w in A.SuccessIds)){q.push(p)}}}}}}}return JSON.stringify({urls:q})},ReserveUnreserveServiceRequest:function(q,v,p,r,u,t){var s=this;var w=[];if(v){v.forEach(function(y){if(!(y.physicalid in s.V5DataIndex)){var x=w.push(y);s.V5DataIndex[y.physicalid]=x-1}})}m.getInstance().getSecurityContext({onSuccess:function(x){if(p=="reserve"){s.ReserveServiceRequest(q,w,r,x,u,t)}else{if(p=="unreserve"){s.UnReserveServiceRequest(q,w,r,x,u,t)}}},onFailure:function(x){console.log("securityContext is null");s.stopProgress()}})},execute:function(){var r=(this.instToggle!=null)?this.instToggle.checkFlag:false;var t=(this.instToggle!=null)?this.refToggle.checkFlag:true;var y=this.options.operation;console.log("reserveWidget::launchCmd "+y);var u=this;var E=false;var v=[];var q=[];var z=0;var C=[];this.SelectedItems.forEach(function(I){if(t){v.push("model/"+I.getCategoryM1()+"/"+I.getPhysicalId());if(I.cadMaster!="3DEXPERIENCE"){C.push(I.physicalId)}z++}if(r&&I.baseType=="PLMEntity"){var H=I.relID;if(H!=""){if(I.isV6Rel){v.push("model/rel/"+I.relID);z++}else{q.push(H)}}}});var B=[];var D=[];v.forEach(function(H){if(!(H in D)){B.push(H);D[H]=""}});var G=[];var A=[];q.forEach(function(H){if(!(H in A)){G.push(H);A[H]=""}});var x=-1;if(this.SelectedItems.length>5){x=Math.ceil(B.length/20);if(x>50){x=50}else{if(x<5){x=5}}}this.startProgress(y,x);if(z>1){E=true}var p=JSON.stringify(this.SelectedItems);console.log("jsonSelectedItems = "+p);var s=undefined;if(u.chunkSize>0){s=0}if(C.length>0){var w=C.join();d.get3DSpaceUrlAsync({onComplete:function(K){var I="?";var J=d.getTenantID();if(J){I+="tenant="+J}var H=K+"/resources/v1/collabServices/reservation/op/getV5Instances"+I;k.authenticatedRequest(H,{method:"POST",type:"json",timeout:1000*60*60*3,data:w,headers:{Accept:"application/json","Content-Type":"application/json"},onComplete:function(L){u.ReserveUnreserveServiceRequest(G,L,y,B,E,s)}})}})}else{var F=undefined;u.ReserveUnreserveServiceRequest(G,F,y,B,E,s)}},onRefresh:function(){console.log("onRefresh->")},showNotification:function(p){var q={eventID:"primary",msg:p};this.dispatchEvent("onNotification",q)},showError:function(q){console.log("showError "+q);var p={eventID:"error",msg:q};this.dispatchEvent("onNotification",p)},refreshView:function(s){var r=this;console.log("******* refreshing PADCommandProxy *************");var q={authored:true};var p={authored:{modified:r.listOfModified}};var t=s.create();t.authored(q);t.refresh(p);if(typeof r.localContext.refreshView!=="undefined"){console.log("$$$ calling refreshView - Product Editor case $$$");r.localContext.refreshView(r.refreshDatas)}else{if(r.refreshDatas.modified.length>0){console.log("$$$ Folder Editor - RefreshView $$$");if(typeof r.localContext.RefreshView!=="undefined"){r.localContext.RefreshView(r.refreshDatas)}}}t.destroy()},showSuccessMessage:function(p,t){var s=this;if(s.SuccessInfo.length!=0){var r=t==true?UWA.i18n("reservationSucceeded"):UWA.i18n("unreservationSucceeded");if(p==true){var v=UWA.i18n("instance");var q=UWA.i18n("reference");var u=[];s.SuccessInfo.forEach(function(w){var x=w.url.includes("model/rel/")?v:q;x+=" "+w.title;if(u.indexOf(x)==-1){u.push(x);r+="<br>"+x}})}s.showNotification(r);console.log("RESERVE SUCCESS")}},ReserveServiceRequest:function(E,v,r,C,z,q){var B=this;console.log("RESERVE:");var t=B.getUrls(r,q,v);console.log(t);var x=this.localContext;B.fakeItemInProcess=q;var D=function(H){console.log("reserve: COMPLETED");B.updateProgress(r);var G=[];if(H.results){G=H.results}console.log(H.results);var I=G.length;G.forEach(function(K){if(K.errors){var J=K.errors.length;if(J<=0){B.FailureInfo[K.errors[J-1].physicalid]={physicalid:K.errors[J-1].physicalid,message:""}}else{var L=K.errors[J-1].message;B.FailureInfo[K.errors[J-1].physicalid]={physicalid:K.errors[J-1].physicalid,message:L}}}else{B.listOfModified.push(K.physicalid);var M="";if(typeof K.reservedby!=="undefined"){M=K.reservedby}if(typeof K.locker!=="undefined"){M=K.locker}console.log("&&&& locker ="+M);B.refreshDatas.modified.push({physicalid:K.physicalid,attributes:[{name:"ds6w:reserved",value:"TRUE"},{name:"ds6w:reservedBy",value:K.lockerName},{name:"ds6w:displayName",value:K.lockerName}]});B.SuccessInfo.push(K);B.SuccessIds[K.physicalid]=""}});if(q!=undefined&&q+B.chunkSize<r.length){B.ReserveServiceRequest(E,v,r,C,z,q+B.chunkSize)}else{require(["DS/PADUtils/PADCommandProxy"],function(M){var J=false;for(var N in B.FailureInfo){J=true;break}if(B.chunkSize>0){if(J==true){B.SuccessInfo.forEach(function(O){if(O.physicalid in B.FailureInfo){delete B.FailureInfo[O.physicalid]}})}}J=false;for(var K in B.FailureInfo){J=true;var L=B.FailureInfo[K].message;B.showError(L);console.log("RESERVE ERROR "+L)}B.reportV5Instances(E);B.showSuccessMessage(J,true);B.refreshView(M);B.stopProgress()})}};var u=function(G){console.log("Failed to reserve data");if(G.hasOwnProperty("error")){B.showError(G.error)}else{if(G.hasOwnProperty("message")){B.showError(G.message)}}B.showSuccessMessage(true,true);require(["DS/PADUtils/PADCommandProxy"],function(H){B.refreshView(H)});B.stopProgress()};var F=function(G){console.log("Timeout error");if(G.hasOwnProperty("error")){B.showError(G.error)}else{if(G.hasOwnProperty("message")){B.showError(G.message)}}B.showSuccessMessage(true,true);require(["DS/PADUtils/PADCommandProxy"],function(H){B.refreshView(H)});B.stopProgress()};var A;if(C!=null&&C!=""&&C.hasOwnProperty("SecurityContext")){var y="";if(C.SecurityContext.indexOf("ctx::")!=0){y="ctx::"}A=y+C.SecurityContext;console.log("SecurityContext=");console.log(A)}else{var w={message:UWA.i18n("ErrorSecurityContextEmpty"),code:"ERROR"};this.showError(w);console.log("***** Empty security context *****");return}var p=this.options.serverName;var s=this.options.serverUri;d.get3DSpaceUrlAsync({onComplete:function(M){var G=B.options.currentUser;G=null;var K="?";var L=d.getTenantID();if(L){K+="tenant="+L+"&"}if(G){console.log("user = "+G);K+="user="+G+"&"}if(z){K+="isMultiSel=1&"}else{K+="isMultiSel=0&"}var I=["physicalid"];I.forEach(function(N){K+="select="+N+"&"});var H=M+"/resources/v1/collabServices/reservation/op/reserve"+K;console.log("url="+H);var J=e.getHeaders(encodeURIComponent(A));k.authenticatedRequest(H,{method:"POST",type:"json",timeout:1000*60*60*3,headers:J,cache:-1,proxy:"passport",onComplete:D,data:t,onFailure:u,onTimeout:F})}})},UnReserveServiceRequest:function(D,v,r,B,y,q){var A=this;console.log("UNRESERVE:");var t=A.getUrls(r,q,v);console.log(t);var C=function(G){console.log("unreserve: COMPLETED");A.updateProgress(r);var F=[];if(G.results){F=G.results}console.log(G.results);F.forEach(function(I){if(I.errors){var H=I.errors.length;if(H<=0){A.FailureInfo[I.errors[H-1].physicalid]={physicalid:I.errors[H-1].physicalid,message:""}}else{var J=I.errors[H-1].message;A.FailureInfo[I.errors[H-1].physicalid]={physicalid:I.errors[H-1].physicalid,message:J}}}else{A.listOfModified.push(I.physicalid);A.refreshDatas.modified.push({physicalid:I.physicalid,operation:"update",attributes:[{name:"ds6w:reserved",value:"FALSE"},{name:"ds6w:reservedBy",value:""}]});A.SuccessInfo.push(I);A.SuccessIds[I.physicalid]=""}});if(q!=undefined&&q+A.chunkSize<r.length){A.UnReserveServiceRequest(D,v,r,B,y,q+A.chunkSize)}else{require(["DS/PADUtils/PADCommandProxy"],function(K){var H=false;for(var L in A.FailureInfo){H=true;break}if(A.chunkSize>0){if(H==true){A.SuccessInfo.forEach(function(M){if(M.physicalid in A.FailureInfo){delete A.FailureInfo[M.physicalid]}})}}H=false;for(var I in A.FailureInfo){H=true;var J=A.FailureInfo[I].message;A.showError(J);console.log("RESERVE ERROR "+J)}A.reportV5Instances(D);A.showSuccessMessage(H,false);A.refreshView(K);A.stopProgress()})}};var u=function(F){console.log("myOnFailure");if(F.hasOwnProperty("error")){A.showError(F.error)}else{if(F.hasOwnProperty("message")){A.showError(F.message)}}A.showSuccessMessage(true,false);require(["DS/PADUtils/PADCommandProxy"],function(G){A.refreshView(G)});A.stopProgress()};var E=function(F){console.log("Timeout error");if(F.hasOwnProperty("error")){A.showError(F.error)}else{if(F.hasOwnProperty("message")){A.showError(F.message)}}A.showSuccessMessage(true,false);require(["DS/PADUtils/PADCommandProxy"],function(G){A.refreshView(G)});A.stopProgress()};var z;if(B!=null&&B!=""&&B.hasOwnProperty("SecurityContext")){var x="";if(B.SecurityContext.indexOf("ctx::")!=0){x="ctx::"}z=x+B.SecurityContext;console.log("SecurityContext=");console.log(z)}else{var w={message:UWA.i18n("ErrorSecurityContextEmpty"),code:"ERROR"};this.showError(w);console.log("***** Empty security context *****");return}var p=this.options.serverName;var s=this.options.serverUri;d.get3DSpaceUrlAsync({onComplete:function(K){var I="?";var J=d.getTenantID();if(J){I+="tenant="+J+"&"}if(y){I+="isMultiSel=1&"}else{I+="isMultiSel=0&"}var G=["physicalid"];G.forEach(function(L){I+="select="+L+"&"});var F=K+"/resources/v1/collabServices/reservation/op/unreserve"+I;console.log("url="+F);var H=e.getHeaders(encodeURIComponent(z));k.authenticatedRequest(F,{method:"POST",type:"json",timeout:1000*60*60*3,headers:H,cache:-1,proxy:"passport",onComplete:C,data:t,onFailure:u,onTimeout:E})}})},});return j});