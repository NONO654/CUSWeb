/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/CAT3DComposeDirectMove/CAT3DComposeDirectMove",["UWA/Core","UWA/Class","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/CATC3DGeometry/CATC3DEquivalentGeometry","DS/Manipulators/ScreenPlaneManipulator","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/MeshUtils","DS/SceneGraphNodes/AxisSystemNode","DS/CAT3DComposeConstraints/CAT3DComposeConstraintsController","DS/CAT3DComposeCommands/CATC3DDefaultSelectionFilter","DS/CAT3DComposeUtils/CAT3DCompose3DAnimation","DS/CAT3DComposeWidget/CAT3DComposeWidgetOptions","DS/CAT3DComposeMoveManager/CATC3DMoveReferent","DS/CAT3DComposeMoveManager/CAT3DComposeMoveManager","DS/CATRelatedData3DGrid/CATRelatedData3DGridController","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/SceneGraphUtils","DS/CATC3DGeometry/CATC3DGeometryEnums","css!DS/CAT3DComposeCommands/CAT3DComposeCommands.css"],function(s,u,k,t,i,a,v,l,g,m,p,h,j,d,e,q,f,o,r,w){var c=10;var b=u.extend({init:function(){var y=false;var R;var L=null;var ac=null;var ax=null;var B=this;var P={};var ar=[];var aA="";var al=null;var ae=true;var x=null;var U=null;var am={};var Y=3394815;var az=false;var I={};var aq=[];var ak=null;var V=null;var Z=null;var ab=null;var O=null;var an=null;var A=null;var J=null;var F=null;var G=null;var av=null;var at=null;var aa=null;var ay=!d.getOption("animationOff");var E=false;var af={};var ai=false;var ag=null;var H=false;var X=null;var M=null;var au=function(){var aB=R.getRootBagPath();return aB?aB.getLastElement(true):null};var ap=function(aC){var aB=R.getRootBagPath();return aB.isAParentOf(aC)};var aj=new l("LocalAxisSystemNode");aj.exludeFromBounding(true);aj.setVisibilityInTree(false);aj.setPickable(g.NODRAWHL);aj.setVisibility(false);aj.setVisibilityFree(true);aj.updateDisplay=function(aB){if(aj.parents.length===0){ax.addNode(aj)}if(aB.visibility&&aB.pathElement&&aj.pathElement!==aB.pathElement){aj.pathElement=aB.pathElement;aj.setMatrix(aB.pathElement.getWorldMatrix());aj.setVisibility(true)}if(!aB.visibility){aj.pathElement=null;aj.setVisibility(false)}};var N=function(){var aB=au();if(!aB){return}if(A&&J){A.unlink(J);J=A.linkToNode(aB)}};var K=function(){ak=R.subscribe({event:"onRootAdded"},function(){N()});V=R.subscribe({event:"onRootRemoved"},function(){N()});Z=R.subscribe({event:"onRootAttached"},function(){N()});ab=R.subscribe({event:"onRootDetached"},function(){N()});O=R.subscribe({event:"onModelUpdated"},function(){N()})};var Q=function(){if(R){R.unsubscribe(ak);R.unsubscribe(V);R.unsubscribe(Z);R.unsubscribe(ab);R.unsubscribe(O);V=ak=Z=ab=O=null}};var D=function(aC){if(aC.color){var aB=new v.MeshBasicMaterial({side:2,forceSide:true,color:aC.color,transparent:true,depthWrite:false,depthTest:false,opacity:0.6,overridable:false});r.applyMaterialToPath(aC.path,aB)}else{r.applyMaterialToPath(aC.path,null)}};var S=function(aD){aD.objectToMove.override.setColor("#ffffff",false);var aB=function(aE){if(aD.objectToMove&&at&&!ai&&aE){aD.objectToMove.override.setColor("#E3004C",false);ax.render()}};var aC=L.isPathLocked({pathElement:aD.objectToMove.path,onCompleted:function(aE){if(!af.isRunning()){aB(aE.isLocked)}}});if(aC.returnCode===0&&aC.hasOwnProperty("isLocked")){aB(aC.isLocked);aB=function(){}}};var ao=function(){if(at){ax.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(at);at=null}if(az){aq.forEach(function(aB){if(aB.path){k.add({pathElement:aB.path})}});L.onMoveEnd({from:B,status:aA});if(x&&(x.simulateReverseDirection(P.pathElement)||x.getAxisTypeIfCstOnProductAxis(P.pathElement))){R.getFrameWindow().getContextualUIManager().showContextualBar({hideWithDistance:true})}}else{if(P.pathElement){if(!I.partIsInCSO){t.add({pathElement:P.pathElement,event:al});R.getFrameWindow().getContextualUIManager().showContextualBar({hideWithDistance:true})}}}if(aa){aa.display3DGrids()}an=null;y=false;P={};az=false;I={};U=null;am={};aA="";aq=[];ar=[];ai=false;if(ay){E=false;H=false}};var T={panInterval:undefined,viewpoint:undefined,panDuration:100,x:undefined,y:undefined},ad=function(){if(T.panInterval){clearInterval(T.panInterval)}T.panInterval=undefined;T.viewpoint=undefined;T.x=undefined;T.y=undefined;T.div=T.div?T.div.destroy():undefined;T.divL=T.divT=T.divR=T.divB=undefined},aw=function(aD){function aE(){if(!T.viewpoint){T.viewpoint=ax.currentViewpoint}if(T.viewpoint&&T.viewpoint.control&&T.x!==undefined&&T.y!==undefined){var aK=new v.Vector3(T.x,T.y,0),aJ,aH;aK.applyQuaternion(T.viewpoint.control.orientation);aK.setLength(0.05*T.viewpoint.control.distanceToTarget);aJ=T.viewpoint.target.clone().add(aK);aH=T.viewpoint.control.distanceToTarget;T.viewpoint.moveTo({eyePosition:aJ.add(T.viewpoint.getCamera().getLookAt().normalize().multiplyScalar(-aH)),duration:ay?T.panDuration:0});if(!T.div){var aG=R.getFrameWindow().getUIFrame();T.div=s.createElement("div",{id:"C3D-viewpoint",styles:{top:ax.SCREEN_HEIGHT/2+"px",left:ax.SCREEN_WIDTH/2+"px"}}).inject(aG);var aI=function(aM){var aN=s.createElement("div",{"class":aM.side}).inject(T.div);aN.setStyle(aM.posKey,aM.posValue+"px");var aL=s.createElement("div",{"class":"arrow"}).inject(aN);s.createElement("div",{"class":"borderBottom"}).inject(aL);s.createElement("div",{"class":"borderRight"}).inject(aL);return aN};var aF=Math.min(ax.SCREEN_WIDTH/10,ax.SCREEN_HEIGHT/10);T.divL=aI({side:"left",posKey:"left",posValue:-aF});T.divT=aI({side:"top",posKey:"top",posValue:-aF});T.divR=aI({side:"right",posKey:"left",posValue:aF});T.divB=aI({side:"bottom",posKey:"top",posValue:aF})}if(T.x<0){T.divL.addClassName("active")}else{T.divL.removeClassName("active")}if(T.x>0){T.divR.addClassName("active")}else{T.divR.removeClassName("active")}if(T.y<0){T.divB.addClassName("active")}else{T.divB.removeClassName("active")}if(T.y>0){T.divT.addClassName("active")}else{T.divT.removeClassName("active")}}}var aC=aD.event.gesture?aD.event.gesture.getEvents()[0]:aD.event.from[0];var aB=aC.getCurrentPosition(R.getViewer().canvas);T.x=(aB.x<=c-1)?-1:((aB.x>=ax.SCREEN_WIDTH-c-1)?1:0);T.y=(aB.y<=c-1)?1:((aB.y>=ax.SCREEN_HEIGHT-c-1)?-1:0);if(T.x===0&&T.y){T.x=(aB.x<ax.SCREEN_WIDTH/3)?-1:((aB.x>2*ax.SCREEN_WIDTH/3)?1:0)}else{if(T.y===0&&T.x){T.y=(aB.y<ax.SCREEN_HEIGHT/3)?1:((aB.y>2*ax.SCREEN_HEIGHT/3)?-1:0)}}if(T.x||T.y){clearInterval(T.panInterval);T.panInterval=setInterval(function(){aE()},T.panDuration);aE();return 1}else{ad()}return 0};var z;function ah(){if(!R||A){return}z=h.getDefaultSelectionFilter({context:R});z.activate();K();var aC=R.getFrameWindow();L=q.getMoveManager({context:R});ac=e.getMoveReferentManager({context:R});if(!x){x=p.getConstraintsController({context:R})}X=L.subscribe("onValidateMove",function(){if(x){x.deleteAllCst()}});M=L.subscribe("onCancelMove",function(aD){if(x&&aD.objectsCancelled.some(function(aE){return x.isLevelConstrained(aE.path)})){x.deleteAllCst()}});if(!aC){window.console.log("A frame window must be defined");return}if(!L){window.console.log("A move manager component must be defined");return}if(!ac){window.console.log("A move referent component must be defined");return}ax=aC.getViewer();af=j.get3DComposeAnimationEngine({viewer:ax});if(A&&J){A.unlink(J);J=A.linkToNode(au());return}else{A=new a();if(A.setPrePickingDuringManipulation){A.setPrePickingDuringManipulation(true)}if(A.setPreActivationDuringManipulation){A.setPreActivationDuringManipulation(true)}if(A.setPickingDuringManipulation){A.setPickingDuringManipulation(true)}A.setExclusive(true);J=A.linkToNode(au())}F=A.subscribe("BeginManipulate",function(aF){if(af.isRunning()){return}at=new o(R.getRootBagPath().externalPath[0]);ax.getSceneGraphOverrideSetManager().pushSceneGraphOverrideSet(at);ax.setCursor("pointer");y=aF.event.gesture.events[0].event.ctrlKey;if(z){var aE=ax.pick(ax.getMousePosition(aF.event.from[0].currentPosition),"primHybrid",false);P=z.filterPath({pathElement:aE.path[0]});P.pathReferent=ac.getMoveReferent(aE.path[0])}if(!P.pathElement||!P.pathReferent){return}al=aF.event;aq.push({path:P.pathElement});var aD=t.get();if(aD){aD.slice(0).forEach(function(aG){if(aG.pathElement){if(!aG.pathElement.isEqual(P.pathElement)){if(y){if(aG.pathElement.isAParentOf(P.pathElement)){I.fatherIsInCSO=true}aq.push({path:aG.pathElement})}else{t.remove({pathElement:aG.pathElement,event:aF.event});k.remove({pathElement:aG.pathElement})}}else{I.partIsInCSO=true}}})}aq.forEach(function(aG){if(aG.path){var aI=ar.slice(0).some(function(aJ){if(aJ.path){if((!aJ.path.isEqual(aG.path)&&aJ.path.isAParentOf(aG.path))||!ap(aG.path)){return true}}return false});if(!aI){var aH=ac.getMoveReferent(aG.path);ar.push({path:aH,override:at.createOverride(aH),initWorldMatrix:aH.getWorldMatrix(),initMatrix:aH.getLastElement(true).getMatrix(),selectionWorldMatrix:P.pathElement.getWorldMatrix(),isAxisSystem:P.pathElement.externalPath.some(function(aJ){return aJ.name==="AxisSystems"})})}}})});G=A.subscribe("Manipulate",function(aJ){if(af.isRunning()){return}ax.setCursor("pointer");if(aJ.event.from[0].currentPosition.equals(aJ.event.from[0].lastPosition)){return}if(!aa){aa=f.give3DGridController({context:R})}if(aa){aa.hide3DGrids()}if(ar.length>0){var aP=aJ.intersection.path[0];if(!az){if(!I.partIsInCSO){t.add({pathElement:P.pathElement})}aq.forEach(function(aQ){if(aQ.path){k.remove({pathElement:aQ.path})}});L.onMoveBegin({objectsMoved:ar,from:B,moveMode:"Transient"});ar.forEach(function(aQ){if(aQ.path){aQ.override.setPickability("IGNORED")}});ax.render();if(!P.equivalentGeometry){P.equivalentGeometry=i.getEquivalentGeometry({pathElement:P.pathReferent,axis:x.getProductAxisForConstraint()})}if(ay){af.addAnimation({animationType:"opacityOn",objectListToAnimate:ar,callBackFct:function(){if(P.equivalentGeometry&&P.equivalentGeometry.getMode()===w.GeometryMode.REAL){D({path:P.pathElement,color:Y})}ar.forEach(function(aQ){if(aQ.path){S({objectToMove:aQ})}})}});af.startAnimation()}else{if(P.equivalentGeometry&&P.equivalentGeometry.getMode()===w.GeometryMode.REAL){D({path:P.pathElement,color:Y})}ar.forEach(function(aQ){if(aQ.path){aQ.override.setOpacity(0.35,false);S({objectToMove:aQ})}})}if(x){if((x.count()>0&&!P.equivalentGeometry)||(x.count()>0&&!x.isLevelConstrained(P.pathReferent))){x.deleteAllCst()}}az=true}if(aw({event:aJ.event})){return}var aK=ax.pick(ax.getMousePosition(aJ.event.from[0].currentPosition),"primHybrid",false);var aG={pathElement:aK.path[0]};if(z){z.filterPath(aG)}var aH=false;if(aG.pathElement&&am.pathElement){aH=am.pathElement.isEqual(aG.pathElement)}am=aG;if(U&&!aH){x.deleteLastCst();U=null}var aF={},aE=null,aN=null;if(aG.pathElement!==undefined&&(aP&&!P.pathReferent.isAParentOf(aP))){aE=P.equivalentGeometry&&P.equivalentGeometry.getType()!==w.GeometryType.AXISSYSTEM;aN=aG.equivalentGeometry&&aG.equivalentGeometry.getType()!==w.GeometryType.AXISSYSTEM;if(aG.pathElement!==null&&!P.pathReferent.isAParentOf(aG.pathElement)&&aN&&aE){if(!aH){U=x.createCst({movable:P,fixed:aG});var aO=x.simulateSolveCst();if(aO){var aI=aO.matrix;aF.rc=aO.rc;aF.redundancy=aO.redundancy;if(aF.rc===0&&aI&&!aF.redundancy){aF.matrix=aI.multiply(P.pathReferent.getWorldMatrix())}else{if(aF.rc!==0||aF.redundancy){x.deleteLastCst();U=null}}am=aG}else{am={}}}}else{if(aG&&aG.pathElement){aF.matrix=aG.pathElement.getWorldMatrix();if(aG.pathElement.externalPath.some(function(aQ){return aQ.name==="AxisSystems"})){aF.isAxisSystem=true;aj.updateDisplay({visibility:false})}else{aj.updateDisplay({pathElement:aG.pathElement,visibility:true})}}}}if(aF.matrix){var aM;if(aF.isAxisSystem&&ar[0].isAxisSystem){var aL=new v.Matrix4().copy(aF.matrix);aL.multiply(new v.Matrix4().getInverse(ar[0].selectionWorldMatrix));aL.multiply(ar[0].initWorldMatrix);aM=new v.Matrix4().getInverse(ar[0].initWorldMatrix).multiply(aL)}else{aM=new v.Matrix4().getInverse(ar[0].initWorldMatrix).multiply(aF.matrix);aM.multiply(new v.Matrix4().getInverse(P.pathElement.getLastElement(true).getMatrix()))}ar.forEach(function(aW,aT){var aX=new v.Matrix4().copy(aW.initWorldMatrix).multiply(aM);if(aW.path){var aR=new v.Matrix4().getInverse(aW.path.getParentPath().getWorldMatrix());var aQ=new v.Matrix4().copy(aR).multiply(aX);var aZ=null;if(aW.snappedPosition){aZ=new v.Matrix4().copy(aW.snappedPosition)}var aU=aZ&&aZ.equals(aQ);aW.snappedPosition=new v.Matrix4().copy(aQ);if(ay){var aY=new v.Matrix4().copy(aW.initWorldMatrix);var aV=(new v.Vector3().getPositionFromMatrix(aW.initWorldMatrix)).add(aJ.translationVector);aY.setPosition(aV);var aS=new v.Matrix4().copy(aR).multiply(aY);if(!ai){aW.currentPosition=new v.Matrix4().copy(aS);if((x&&x.count()<=1&&aN&&aE)||(!aN&&!aE)||(aN&&!aE)){aW.override.setPosition(aS)}}else{if(!aU){aW.currentPosition=aQ}}if(aT===0){aW.snappedTarget=aG.pathElement;if(!aU&&aG.pathElement&&!aW.snappedTarget.isEqual(aG.pathElement)){clearTimeout(ag);ag=null}if(!ag&&(!aU||!ai)){ag=setTimeout(function(){af.addAnimation({animationType:"snap",objectListToAnimate:ar,callBackFct:function(){ai=true;ag=null;if(H){ao()}}});af.addAnimation({animationType:"opacityOff",offsetTime:af.getDefaultDuration("snap"),objectListToAnimate:ar,callBackFct:function(){ar.forEach(function(a0){a0.override.setColor(null,false)});if(P.equivalentGeometry){D({path:P.pathElement})}}});af.startAnimation()},500)}}}else{aW.override.setPosition(aQ);ai=true}}});ae=false;L.onMove({objectsMoved:ar,transformation:aM,from:B})}else{if(aj){aj.updateDisplay({visibility:false})}if(aG.pathElement===undefined||aG.pathElement===null||(aF.rc&&aF.rc!==0)||aF.redundancy){ae=true;L.onMove({objectsMoved:ar,vector:aJ.translationVector,from:B})}else{if(aN&&aE&&aF.rc===0){ae=false}}if(aG.pathElement!==undefined||aG.pathElement!==null){var aD=null;ar.forEach(function(aZ,aV){if(aZ.path){var aQ=null;if(x.count()===0||(x.count()===1&&U)){var a1=new v.Matrix4().copy(aZ.initWorldMatrix);var aY=(new v.Vector3().getPositionFromMatrix(aZ.initWorldMatrix)).add(aJ.translationVector);a1.setPosition(aY);var a2=aZ.path.getParentPath().getWorldMatrix();var aU=new v.Matrix4().getInverse(a2);aQ=aU.multiply(a1);if(!ai){aZ.override.setPosition(aQ)}aZ.currentPosition=new v.Matrix4().copy(aQ)}else{if(aV===0){aD=null;if(U){x.deleteLastCst()}var aT=new v.Vector3().addVectors(aJ.translationVector,A.initial3dIntersectionPoint);var aS=null;if(an){aS=new v.Vector3().subVectors(aJ.translationVector,an)}else{aS=aJ.translationVector}an=aJ.translationVector;var aW=x.simulateMoveWithCst({movableReference:aT,translation:aS});if(aW&&aW.rc===0&&aW.matrix){aD=aW.matrix.multiply(P.pathReferent.getWorldMatrix())}if(U){x.restoreLastDeletedCst()}}if(aD){var aX=new v.Matrix4().getInverse(ar[0].initWorldMatrix).multiply(aD);var a0=new v.Matrix4().copy(aZ.initWorldMatrix).multiply(aX);var aR=new v.Matrix4().getInverse(aZ.path.getParentPath().getWorldMatrix());aQ=new v.Matrix4().copy(aR).multiply(a0);if(!ai){aZ.override.setPosition(aQ)}}aZ.currentPosition=new v.Matrix4().copy(aZ.initMatrix)}}});if(ay){if(!aH){if(ag){clearTimeout(ag);ag=null}if(ai&&ae){af.addAnimation({animationType:"unsnap",objectListToAnimate:ar,callBackFct:function(){ai=false;ar.forEach(function(aQ){aQ.snappedPosition=null})}});af.addAnimation({animationType:"opacityOn",objectListToAnimate:ar,offsetTime:af.getDefaultDuration("unsnap"),callBackFct:function(){if(P.equivalentGeometry){D({path:P.pathElement,color:Y})}ar.forEach(function(aQ){if(aQ.path){S({objectToMove:aQ})}})}});af.startAnimation()}}}else{if(ai&&ae){ar.forEach(function(aQ){if(aQ.path&&aQ.currentPosition){aQ.override.setPosition(aQ.currentPosition)}});ai=false}}}}ax.render()}});av=A.subscribe("EndManipulate",function(aE){ad();if(!ae){ae=false;aA="Moved"}else{aA="Cancelled"}if(aj){aj.updateDisplay({visibility:false})}if(!az){aq.forEach(function(aF){if(aF.path){if(aF.path.isEqual(P.pathElement)){if(I.partIsInCSO){if(y){t.remove({pathElement:P.pathElement,event:aE.event});k.remove({pathElement:P.pathElement})}else{t.remove({pathElement:P.pathElement,event:aE.event});t.add({pathElement:P.pathElement,event:aE.event});R.getFrameWindow().getContextualUIManager().showContextualBar({hideWithDistance:true})}}else{k.add({pathElement:P.pathElement})}}else{if(aF.path.isAParentOf(P.pathElement)){if(y){if(I.partIsInCSO){t.remove({pathElement:P.pathElement,event:aE.event});k.remove({pathElement:P.pathElement})}}}}}});ao()}else{if(ay){if(ag){clearTimeout(ag);ag=null}af.forward();af.addAnimation({animationType:"opacityOff",objectListToAnimate:ar,callBackFct:function(){ar.forEach(function(aF){aF.override.setColor(null,false)});if(P.equivalentGeometry){D({path:P.pathElement})}}});if(aA==="Cancelled"){var aD=ax.getSceneGraphOverrideSetManager();ar.forEach(function(aF){aF.currentMatrix=aD.computeAppliedPosition(aF.path)});af.addAnimation({animationType:"cancel",objectListToAnimate:ar,callBackFct:function(){ao()}})}else{if(ai){ao()}else{if(E){H=true}else{H=true;af.addAnimation({animationType:"snap",objectListToAnimate:ar,callBackFct:function(){ai=true;ag=false;if(H){ao()}}})}}}af.startAnimation()}else{ao()}}ax.render()});if(aj.getChildren().length===0){var aB=new m({headLength:10,arrowLength:50,arrowWidth:2,head:m.types.ARROW});aj.addChild(aB)}aj.updateDisplay({visibility:false});ax.render({updateInfinitePlane:true})}this.activate=function(aB){R=aB.context;ah()};function W(){ad();Q();if(X){L.unsubscribe(X);X=null}if(M){L.unsubscribe(M);M=null}if(A){A.unsubscribe(F);A.unsubscribe(G);A.unsubscribe(av);A.unlink(J);A=F=G=av=J=null}if(aj){aj.removeChildren()}if(z){z.deactivate()}}this.deactivate=function(){W();R=null};function C(){W();if(x){x.deleteAllCst();x.unreference()}if(z){h.unreferenceDefaultSelectionFilter({context:R});z=null}if(aj){ax.removeNode(aj);aj=null}R=null}this.unreference=C}});var n;return u.singleton({init:function(){},activate:function(x){if(x&&x.context&&x.context.name==="ENOPAD3DViewer"){if(!n){n=new b()}n.activate({context:x.context})}},deactivate:function(x){if(x&&x.context&&x.context.name==="ENOPAD3DViewer"){if(n){n.deactivate()}}},unreference:function(x){if(x&&x.context&&x.context.name==="ENOPAD3DViewer"){if(n){n.unreference()}n=null}}})});