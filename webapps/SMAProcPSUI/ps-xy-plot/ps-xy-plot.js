/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
require(["UWA/Core","css!DS/SMAProcPSUI/ps-xy-plot/plot.css"],function(e){var j=function(){this.selectedRowData={};var m=this.DOM(this).find("#graphContainer").root[0];if(m.classList.contains("visible")){m.classList.remove("visible")}for(var n in this.xyplots){if(this.xyplots[n].clearMainPlot){this.xyplots[n].clearMainPlot()}}this.plotData={};while(m.firstChild){m.removeChild(m.firstChild)}var l=this.querySelector("#pagination");l.classList.add("hide");this.xyplots={}},d=function(q,n,m){for(var o=0;o<q[0];o+=1){var p=q.slice(1,q.length);if(p.length>0){var l="["+o+"]";if(n!==undefined||n!==null){l=n+"["+o+"]"}d(p,l,m)}else{m.push(n+"["+o+"]")}}return m},g=function(q,A){var l=this.DOM(this).find("#graphContainer").root[0];l.classList.add("visible");if(q.height){l.style.height=q.height}var u=q.columns[0].text;var p=0;for(var n=0;n<q.columns.length&&p<A.length;n++){var s=q.columns[n].text;if(s===A[p]){var t="",m;for(var o=0;o<q.data.length;o++){var r=q.data[o][u].split(".");m=r[r.length-1];var w=q.data[o][s];if(w&&w!=="NaN"&&w!=="Infinity"){t+=m+","+w+"\r\n"}}if(t.length>0){if(this.xyplots[s]){if(q.data.length>0){this.xyplots[s].updatePlot(t,m,false,"."+m.toString().length+"d")}}else{var C=q.columns[n].valuetype;var v=[];if(C==="array"){var B=q.columns[n].arraydim;if(B!==null&&B!==undefined&&B.length>1){B=B.substring(1,B.length-1);if(B.indexOf(",")>0){B=B.split(",");v=d(B,null,v)}}}var z=[u];if(v.length>0){for(var o=0;o<v.length;o++){z.push(String(s)+v[o])}}else{z.push(s)}h.call(this,t,u,s,z,m)}}p++}}},h=function(t,v,s,z,n){var m=this.DOM(this).find("#graphContainer").root[0],u=document.createElement("div"),A,q,o,l,r;q=e.createElement("div",{"class":"xyHeader"}).inject(u);u.header=q;l=e.createElement("span",{title:"Popup","class":"fonticon fonticon-popup icons",events:{click:function(){this.getParent("ps-xy-plot").style.position="inherit";u.header.maximize.classList.add("hidden");u.header.minimize.classList.remove("hidden");this.classList.add("hidden");u.classList.remove("maximized");u.classList.remove("graph");u.classList.add("popup");u.XYplot.parentNode.style.width="";u.XYplot.resize();u.XYplot.mode="popup"}}}).inject(q);u.header.popup=l;o=e.createElement("span",{title:"Maximize","class":"fonticon fonticon-resize-full icons",events:{click:function(){this.classList.add("hidden");u.header.minimize.classList.remove("hidden");u.header.popup.classList.remove("hidden");u.classList.remove("graph");u.classList.remove("popup");u.classList.add("maximized");u.XYplot.parentNode.style.width="";u.XYplot.resize();u.XYplot.mode="maximize";var B=u.previousSibling;if(B){var C=B.nodeName;if(C==="DIV"){var y=B.getBoundingClientRect(),x=u.parentElement;x.scrollTop=x.scrollTop+y.height+y.top-x.getBoundingClientRect().top}}}}}).inject(q);u.header.maximize=o;r=e.createElement("span",{title:"Minimize","class":"fonticon fonticon-resize-small icons hidden",events:{click:function(){u.header.popup.classList.remove("hidden");u.header.maximize.classList.remove("hidden");this.classList.add("hidden");u.classList.remove("maximized");u.classList.remove("popup");u.classList.add("graph");u.XYplot.resize();u.XYplot.mode="minimize";this.getParent("ps-xy-plot").style.position="relative"}}}).inject(q);u.header.minimize=r;A=e.createElement("xy-plot");A.classList.add("plot");u.XYplot=A;u.appendChild(A);u.classList.add("graph");Polymer.dom(m).appendChild(u);var w="";for(var p=0;p<z.length;p++){w=w+z[p]+","}w=w.substring(0,w.length-1);t=w+"\r\n"+t;A.processData(t);A.setupMainPlot(z,"",s,true,"white","","."+n.toString().length+"d");this.xyplots[s]=A;return u},c=function(){for(var l in this.xyplots){if(this.xyplots[l].mode){var m=this.xyplots[l].mode;if(m==="maximize"||m==="popup"){this.xyplots[l].resize()}}}},b=function(n){var l=n.userSelection;this.plotData.userSelection=n.userSelection;var m=false;this.resetPages(n)},f=function(){this.debounce("_resizeListner",function(){this.resetPages();this.resizePlots()},500)},a=function(l){if(l){var m=l.children[0].querySelector("circle");if(m){if(navigator.userAgent.search("Trident")>=0){m.parentNode.removeChild(m)}else{m.remove()}}}},i=function(){var l=this;this.showImprovments=false;this.xyplots={};this.selectedRowData={};window.addEventListener("resize",f.bind(this));window.addEventListener("message",k.bind(this),false);document.addEventListener("hoverEvent",function(n){n.stopPropagation();var r=n.detail;var w=r.x;for(var u in l.xyplots){if(l.xyplots.hasOwnProperty(u)){var s=l.selectedRowData.model;if(s&&s[u]){var m=l.xyplots[u];a(m)}}}var t=false;if(l.xyplots[u]){if(l.xyplots[u].dataObject.data.droppedData.dataName[0].length>2){t=true}}l.selectedRowData.model={};if(!t){l.selectedRowData.runId=w;for(var u in l.xyplots){l.xyplots[u].removeToolTip();if(l.xyplots.hasOwnProperty(u)){var v;var o=l.xyplots[u].dataObject.data.droppedData.data;for(var q=0;q<o.length;q+=1){var p=o[q][0];if(p===String(w)){v=o[q][1];break}}if(v){l.selectedRowData.model[u]=v;l.xyplots[u].highlight(l.xyplots[u],w,v);l.xyplots[u].showToolTip(l.xyplots[u],w,v)}}}}});document.addEventListener("plotLeaveEvent",function(){for(var n in l.xyplots){l.xyplots[n].removeToolTip();var m=l.xyplots[n];a(m)}})},k=function(m){var n;try{n=JSON.parse(m.data)}catch(q){n={}}if(n.operation==="highlight"){m.stopPropagation();for(var p in this.xyplots){if(this.xyplots.hasOwnProperty(p)){var l=this.selectedRowData.model;if(l&&l[p]){var o=this.xyplots[p].children[0].querySelector("circle");if(o){if(navigator.userAgent.search("Trident")>=0){o.parentNode.removeChild(o)}else{o.remove()}}}}}for(var p in this.xyplots){this.xyplots[p].removeToolTip();if(this.xyplots.hasOwnProperty(p)){this.selectedRowData=n;if(n.model[p]){this.xyplots[p].highlight(this.xyplots[p],n.runId,n.model[p]);this.xyplots[p].showToolTip(this.xyplots[p],n.runId,n.model[p])}}}}};Polymer({is:"ps-xy-plot",behaviors:[window.DS.SMAProcSP.SPBase],properties:{simId:{notify:true}},setPlotHeight:function(l){var m=this.DOM(this).find("#graphContainer").root[0];m.style.height=l},removePlotHeight:function(){var l=this.DOM(this).find("#graphContainer").root[0];l.style.height=""},hidePlot:function(){var l=this.DOM(this).find("#graphContainer").root[0];l.classList.remove("visible")},isPlotted:function(n){var m=false;for(var l=2;l<n.columns.length;l++){var o=n.columns[l].text;if(this.xyplots[o]){m=true;break}}return m},showPlot:function(o){if(!sessionStorage.getItem("plotSettingInfoShown")){sessionStorage.setItem("plotSettingInfoShown",true);this.$.notification.logMessage({type:"info",text:"Showing output plots, use filter to see other plots.",autoRemove:true})}if(this.plotData){if(this.plotData.data&&this.plotData.data.length!==o.data.length&&(this.plotData.selectedActivityPath===o.selectedActivityPath||o.jobExecutionStatus==="Completed")){for(var m=0;m<o.data.length;m++){this.plotData.data.push(o.data[m])}}}else{this.plotData=o}if(this.showImprovments!==o.showImprovments){this.clearXYPlot()}this.showImprovments=o.showImprovments;this.view=o.view;var n=this.isPlotted(o);if(n){var l=this.DOM(this).find("#graphContainer").root[0];l.classList.add("visible");if(o.height){l.style.height=o.height}}if(this.pageNumber===undefined){this.pageNumber=1}if(n){this.changePage(this.pageNumber,o)}else{this.resetPages(o)}},resetPages:function(u){if(this.plotData&&this.plotData.data===undefined){if(u){this.plotData=u}else{return}}if(!this.plotData){return}var l=document.getElementById("graphContainer");var v=l.offsetHeight*l.offsetWidth;var s=window.Math.floor(l.offsetWidth/402);if(s===0){s=1}var w=window.Math.floor(l.offsetHeight/180);if(w===0){w=1}this.nmbrOfGraphsPerPage=w*s;if(this.nmbrOfGraphsPerPage===0){return}var t=0;this.index=[];var x;for(var q=0;q<this.plotData.userSelection.length;q++){if(this.plotData.userSelection[q].isSelected===true){t++;this.index.push(this.plotData.userSelection[q].name)}}this.nmbrOfPages=window.Math.ceil(t/this.nmbrOfGraphsPerPage);if(this.nmbrOfPages===0){var m=document.createElement("div");m.classList.add("emptyDialog");m.innerHTML="No parameter is selected to display graph";var p=this.querySelector("#graphContainer");while(p.hasChildNodes()){p.removeChild(p.lastChild)}p.appendChild(m);var y=this.querySelector("#pagination");if(y){y.classList.add("hideDiv")}}else{var o=document.createElement("div");var y=this.querySelector("#pagination");if(y.classList.contains("hide")){y.classList.remove("hide")}if(y.classList.contains("hideDiv")){y.classList.remove("hideDiv")}var r=this.querySelector("#pageDropdown");var z;while(r.hasChildNodes()){r.removeChild(r.lastChild)}var n=document.createElement("select");n.setAttribute("style","width: 45px;border-radius: 5px;	height: 24px; margin-top: 1px;");n.onchange=function(){this.changePage(this.querySelector("#pageDropdown").firstElementChild.selectedIndex+1)}.bind(this);for(q=1;q<=this.nmbrOfPages;q++){z=document.createElement("option");z.value=q;z.innerHTML=q;n.appendChild(z)}r.appendChild(n);this.xyplots={};while(l.hasChildNodes()){l.removeChild(l.lastChild)}y.appendChild(o);this.changePage(1)}},changePage:function(t,s){var u=[];var q=(t*this.nmbrOfGraphsPerPage);var l=q-this.nmbrOfGraphsPerPage;q--;if(this.pageNumber!==t){var m=this.querySelector("#graphContainer");while(m.hasChildNodes()){m.removeChild(m.lastChild)}this.xyplots={};this.pageNumber=t}var n=this.querySelector("#prev");var r=this.querySelector("#next");if(this.pageNumber===1){if(n.classList.contains("arrows")){n.classList.remove("arrows");n.classList.add("arrows-inactive")}}else{if(n.classList.contains("arrows-inactive")){n.classList.remove("arrows-inactive");n.classList.add("arrows")}}if(this.pageNumber===this.nmbrOfPages){if(r.classList.contains("arrows")){r.classList.remove("arrows");r.classList.add("arrows-inactive")}}else{if(r.classList.contains("arrows-inactive")){r.classList.remove("arrows-inactive");r.classList.add("arrows")}}this.querySelector("#pageDropdown").firstElementChild.value=this.pageNumber;var v=this.querySelector("#pageInfo");for(var p=l;p<=q;p++){if(this.index[p]!==undefined||this.index[p]!==null){u.push(this.index[p])}}var o=s?s:this.plotData;this.plot(o,u)},forward:function(){var l;if(this.pageNumber<this.nmbrOfPages){l=this.pageNumber+1}else{return}this.changePage(l)},backward:function(){var l;if(this.pageNumber>1){l=this.pageNumber-1}else{return}this.changePage(l)},clearXYPlot:j,ready:i,plot:g,managePlots:b,resizePlots:c})});