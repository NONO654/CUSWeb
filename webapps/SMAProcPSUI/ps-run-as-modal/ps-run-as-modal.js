(function(n){var b;var o={NO_STATIONS_CONFIGURED:"You must use the Execution Options to specify a station name for each activity."};var r=function(){var C=this.$.dashboard.getMcsUri();this.globals.mcsBaseURL=C;this.$.mcsBaseURL.setValue(C);var B=C+"/resources/slmservices";this.globals.mcsWSBaseURL=B;this.$.mcsWSBaseURL.setValue(B);var D=this.querySelector("#close");D.addEventListener("click",this.closeModal.bind(this));this.fire("configrunready");b=u.bind(this)};var d=function(){var C=[];var B=appData.simData.stationNames;if(appData.stationList&&appData.stationList.length>0){B.forEach(function(E){for(var D=0;D<appData.stationList.length;D++){if(E.toUpperCase()===appData.stationList[D].name.toUpperCase()){return false}}if(E==="{localhost}"){C.push("Localhost")}else{C.push(E)}})}return C};var u=function(C){C.stopPropagation();if(C.target.value===""){C.target.style.borderColor="red"}else{C.target.style.borderColor="#cccccc"}var B=i.call(this);if(B){this.querySelector(".creds").children[0].classList.remove("hide");this.querySelector(".validation-error").classList.add("show")}else{this.querySelector(".creds").children[0].classList.add("hide");this.querySelector(".validation-error").classList.remove("show")}};var w=function(){this.validateFields=true;var C=this;var B=this.querySelectorAll(".show.credFieldsWrap");[].forEach.call(B,function(D){C.stationTypes.forEach(function(F){if(D.classList.contains(F)){var G=D.querySelectorAll("label");var E=D.querySelectorAll(".user-input");[].forEach.call(G,function(H){H.innerHTML=H.innerText+'<span><font color="#EA4F37"> *</font></span>'});[].forEach.call(E,function(H){H.querySelector("input").addEventListener("blur",b)})}})})};var g=function(){var B=this.querySelectorAll(".show.credFieldsWrap");[].forEach.call(B,function(D){var E=D.querySelectorAll("label");var C=D.querySelectorAll(".user-input");[].forEach.call(E,function(G){var F=G.querySelector("span");F&&G.removeChild(F)});[].forEach.call(C,function(F){F.querySelector("input").removeEventListener("blur",b)})})};var i=function(){var D=this;var C=false;var B=this.querySelectorAll(".show.credFieldsWrap");[].forEach.call(B,function(E){D.stationTypes.forEach(function(G){var F=E.querySelectorAll(".user-input");if(E.classList.contains(G)){[].forEach.call(F,function(I){var H=I.querySelector("input");if(H.value===""){D.querySelector(".validation-error").classList.add("show");C=true}})}})});return C};var p=function(E,D){var C=this.getElementsByClassName("station-details")[0];C.getElementsByClassName("label")[0].classList.remove("hide");var F="";if(E.length>0){E.forEach(function(G){F=F+'<span title = "This station is now running"> <font color="#57B840"> &#10003; '+G+", </font></span>"})}if(D.length>0){D.forEach(function(G){F=F+'<span title = "This station is not running"> <font color="#EA4F37"> X '+G+", </font></span>"})}var B=F.lastIndexOf(",");F=F.slice(0,B)+F.slice(B+1);return F};var k=function(){var D,F;var C=sessionStorage.getItem("windowsUser");var E=sessionStorage.getItem("linuxUser");var B=sessionStorage.getItem("isightUser");if(C){D=this.querySelector("#windowsUser");F=this.querySelector("#windowsPass");D.parentElement.previousElementSibling.classList.remove("hide");D.value=sessionStorage.getItem("windowsDomain")+"\\"+C;D.children[0].disabled=true;F.value=Array(Number(sessionStorage.getItem("windowsPwdLength"))+1).join("*");F.children[0].disabled=true;this.querySelector(".windowsEdit").classList.remove("hide")}else{D=this.querySelector("#windowsUser");D.parentElement.previousElementSibling.classList.add("hide")}if(E){D=this.querySelector("#linuxUser");F=this.querySelector("#linuxPass");D.parentElement.previousElementSibling.classList.remove("hide");D.value=E;D.children[0].disabled=true;F.value=Array(Number(sessionStorage.getItem("linuxPwdLength"))+1).join("*");F.children[0].disabled=true;this.querySelector(".linuxEdit").classList.remove("hide")}else{D=this.querySelector("#linuxUser");D.parentElement.previousElementSibling.classList.add("hide")}if(sessionStorage.getItem("isightUser")){D=this.querySelector("#isightV5User");F=this.querySelector("#isightV5Password");D.parentElement.previousElementSibling.classList.remove("hide");D.value=B;D.children[0].disabled=true;F.value=Array(Number(sessionStorage.getItem("isightPwdLength"))+1).join("*");F.children[0].disabled=true;this.querySelector(".isightEdit").classList.remove("hide")}else{D=this.querySelector("#isightV5User");D.parentElement.previousElementSibling.classList.add("hide")}};var A=function(){var G=this.credentials;var D=appData.self.id;var F=this.$.spEncryption;if(G.windowsUser&&G.windowsPass&&sessionStorage.getItem("windowsEncrypted")===null){var B=F.encryptSingleCredential(G.domainName,G.windowsUser,D,G.windowsPass,appData.pubKey);sessionStorage.setItem("windowsEncrypted",B);sessionStorage.setItem("windowsDomain",G.domainName);sessionStorage.setItem("windowsUser",G.windowsUser);sessionStorage.setItem("windowsPwdLength",G.windowsPass.length)}if(G.linuxUser&&G.linuxPass&&sessionStorage.getItem("linuxEncrypted")===null){var E=F.encryptSingleCredential(F.ENCRYPTIONTYPES.LINUX,G.linuxUser,D,G.linuxPass,appData.pubKey);sessionStorage.setItem("linuxEncrypted",E);sessionStorage.setItem("linuxUser",G.linuxUser);sessionStorage.setItem("linuxPwdLength",G.linuxPass.length)}if(G.isightV5User&&G.isightV5Password&&sessionStorage.getItem("isightEncrypted")===null){var C=F.encryptSingleCredential(F.ENCRYPTIONTYPES.ISIGHT,G.isightV5User,D,G.isightV5Password,appData.pubKey);sessionStorage.setItem("isightEncrypted",C);sessionStorage.setItem("isightUser",G.isightV5User);sessionStorage.setItem("isightPwdLength",G.isightV5Password.length)}this.fire("exeOptionsUpdate",{level:"success"})};var x=function(){var C=this.parentElement.$.runner;var D={that:C};var B={uri:this.$.mcsBaseURL.getValue()+"/resources/slmservices/cos/ticket",onComplete:function(E){D.EEDTicket=E.response.ticket;C.getCOSPubkey(D).then(function(F){appData.pubKey=F.pubkeyValue;if(this.credentials&&this.querySelector("sp-checkbox").hasAttribute("checked")){A.call(this)}}.bind(this))}.bind(this),onError:function(E){console.log(E)}};this.$.eedTicket_ws.sendRequest(B)};var c=function(){var I;if(!this.validateFields){I=false}else{I=i.call(this)}if(!I){var J=this.$.configAndRun,G,N,C=J.getElementsByClassName("show");this.credentials={};for(var E=0;E<C.length;E+=1){N=C[E].getElementsByTagName("sp-input");for(var D=0;D<N.length;D++){var B=N[D].getAttribute("id"),M=N[D].value;if(M&&M.length>0){if(B==="windowsUser"){var F=M.split(/\\(.+)/);if(F.length>1){if(errMsgWindowsUser.classList){errMsgWindowsUser.classList.add("hide")}this.credentials.domainName=F[0];this.credentials.windowsUser=F[1]}else{if(errMsgWindowsUser.classList){errMsgWindowsUser.classList.remove("hide")}return}}else{this.credentials[B]=M}}}}if(this.editedCreds&&this.editedCreds.length>0){this.editedCreds.forEach(function(P){var O=P.replace("Edit","");sessionStorage.removeItem(O+"Encrypted");sessionStorage.removeItem(O+"User");sessionStorage.removeItem(O+"PwdLength");if(O==="windows"){sessionStorage.removeItem(O+"Domain")}})}if(!appData.pubKey){x.call(this)}else{if(this.querySelector("sp-checkbox").hasAttribute("checked")){appData.encryptedCredsForSelectedProcess={};A.call(this)}else{var K=j.call(this);appData.encryptedCredsForSelectedProcess=K;var L=document.querySelector("ps-simulation-contents");L&&L.enableRunButton&&L.enableRunButton()}}for(var H=0;H<this.simulations.length;H+=1){G=this.simulations[H];this.$.simOptionsWs.uri=this.$.mcsBaseURL.getValue()+"/resources/e6w/service/SMA_SimExeOption?objectId="+G;this.$.simOptionsWs.getData()}this.closeModal()}};var j=function(){var H={OS:[],IsightV5:[],credentialsEncrypted:true};var G=this.credentials;var D=appData.self.id;var F=this.$.spEncryption;if(sessionStorage.getItem("windowsEncrypted")!==null){H.OS.push(sessionStorage.getItem("windowsEncrypted"))}else{if(G.windowsUser&&G.windowsPass){var B=F.encryptSingleCredential(G.domainName,G.windowsUser,D,G.windowsPass,appData.pubKey);H.OS.push(B)}}if(sessionStorage.getItem("linuxEncrypted")!==null){H.OS.push(sessionStorage.getItem("linuxEncrypted"))}else{if(G.linuxUser&&G.linuxPass){var E=F.encryptSingleCredential(F.ENCRYPTIONTYPES.LINUX,G.linuxUser,D,G.linuxPass,appData.pubKey);H.OS.push(E)}}if(sessionStorage.getItem("isightEncrypted")!==null){H.IsightV5.push(sessionStorage.getItem("isightEncrypted"))}else{if(G.isightV5User&&G.isightV5Password){var C=F.encryptSingleCredential(F.ENCRYPTIONTYPES.ISIGHT,G.isightV5User,D,G.isightV5Password,appData.pubKey);H.IsightV5.push(C)}}return H};var z=function(){if(n.widget){return n.widget.getValue("tenantId")}else{return appData.WUPlatformId}};var a=function(C){var B,D={};if(C.detail.result){B=C.detail.result;D.simId=B.context.simulationId;D.MCSJobID=B.MCSJobID;D.eedjobId=B.EEDJobID;D.state="Initializing";this.fire("simulationstarted",D)}C.stopPropagation()};var f=function(G){var F,C="Unexpected character '%' (code 37) in prolog; expected '<'",D=G.detail.result.context,E;E=D.simulationId;if(G.detail.status===0){F="Your job failed to start.Please contact your administrator to confirm that the execution engine is running, then abort your job to try starting it again."}else{if(G.detail.status===404){F="Your job failed to start.Please contact your administrator to confirm that web services are deployed, then abort your job to try starting it again."}else{if(G.detail.status===500){F=G.detail.response;if(C===F.substring(0,C.length)){F="Your job failed to start.Please rename your job if it contains non latin characters, then abort your job to try starting it again."}}}}if(F&&F.length>500){F=F.substring(0,500)}var B={simId:E,error:F};this.fire("simulationfailed",B);G.stopPropagation()};var h=function(){var I=this.$.simOptionsWs.data,C="Information",E=I.objectId;var D=new n.DS.SMAProcSP.SPRun(),G=this;this.parentElement.changeJobStatusForNewJob&&this.parentElement.changeJobStatusForNewJob();var J=I.datarecords.datagroups[0].dataelements;if(J&&J.logLevel&&J.logLevel.value[0]&&J.logLevel.value[0].value){C=J.logLevel.value[0].value}D.runURL=this.globals.eedBaseURL+"/execution/run/workflow";D.jobXMLURL=this.globals.mcsWSBaseURL+"/jobs";D.cosPubkeyURL=this.globals.eedBaseURL+"/execution/pubkey";D.encryptURL=this.globals.mcsWSBaseURL+"/data/getEncryptedCreds";D.mcsTicketURL=this.globals.mcsBaseURL+"/ticket/get";D.tenantID=z();if(C){if(C==="SysError"){D.runInfo="<RunInfo logLevel='System Error' submissionHost=''></RunInfo>"}else{D.runInfo="<RunInfo logLevel='"+C+"' submissionHost=''></RunInfo>"}}else{D.runInfo="<RunInfo logLevel='Information' submissionHost=''></RunInfo>"}D.mcsURL=this.globals.mcsBaseURL;D.simOID=E;D.timeout="150000";var F={context:{id:E}};D.addEventListener("success",function(K){a.call(G,K);G.fire("event-manager",{name:"job-started",data:F})});D.addEventListener("error",function(K){f.call(G,K)});var B={simulationId:E};var H;if(appData.isRunAsEnabled==="true"){H=j.call(this)}else{H={}}if(!H.credentialsEncrypted){D.runSimulation(B,E,"")}else{D.runSimulationAs(B,E,"",false,H)}};var e=function(){var C=this.$.simOptionsWs.data;var B=C.datarecords.datagroups[0].dataelements;if(!this.isFromSimList){this.modifyExeOptions(B)}else{this.runJob()}};var q=function(B){if(this.simulations.length===1){var E=this.simulations[0];var D,C,G,F;appData.simData.exeOptions.forEach(function(H){if(H.title_display==="Job Title"){D=H.value}if(H.title_display==="Job Description"){C=H.value}});G=this.querySelector("#jobTitle").value;F=this.querySelector("#jobDescription").value;if((G===undefined||G===D)&&(F===undefined||F===C)){}else{this.getLatestCEStamp(B).then(function(H){H.jobTitle.value[0].value=G;H.jobDescription.value[0].value=F;H.SCExecutionDirectories.value[0].value="";appData.simData.exeOptions.forEach(function(K){if(K.title_display==="Job Title"){K.value=G}if(K.title_display==="Job Description"){K.value=F}});var J={datarecords:{datagroups:[{updateAction:"MODIFY",objectId:E[0],dataelements:H}],name:""},name:""};J.name="SMA_SimExeOption";J.datarecords.name="SMA_SimExeOption";var I="updateWidget="+encodeURIComponent(JSON.stringify(J));this.$.modSimOptionsWs.uri=this.$.mcsBaseURL.getValue()+"/resources/e6w/service/SMA_SimExeOption";this.$.modSimOptionsWs.sendRequest({headers:{"Content-Type":"application/x-www-form-urlencoded"},verb:"POST",context:this,onComplete:function(){},onError:function(){console.log("Failed")},data:I,physicalId:E[0]})}.bind(this))}}};var y=function(B){return new Promise(function(D,C){this.$.SMAProcess.uri=this.$.mcsBaseURL.getValue()+"/resources/e6w/service/SMA_Process?objectId="+this.simulations[0];this.$.SMAProcess.verb="GET";var E=function(H){if(H.status===200){var F=H.response,G=F.datarecords.datagroups;B.cestamp={value:[{value:G[0].cestamp}]};D(B)}};this.$.SMAProcess.getData(E)}.bind(this))};var t=function(){var B=this.getElementsByClassName("station-details")[0];B.getElementsByClassName("label")[0].classList.remove("hide");this.getElementsByClassName("windows")[0].classList.add("show");this.getElementsByClassName("linux")[0].classList.add("show");this.getElementsByClassName("isight")[0].classList.add("show");this.querySelector(".creds").children[0].classList.add("hide")};var s=function(){this.stationTypes=[];this.editCreds=false;this.editedCreds=[];var C=appData.simData.isIsightConfigured;this.getElementsByClassName("windows")[0].classList.remove("show");this.getElementsByClassName("linux")[0].classList.remove("show");this.getElementsByClassName("isight")[0].classList.remove("show");this.getElementsByClassName("warn-station")[0].classList.remove("showError");this.getElementsByClassName("message")[0].classList.remove("showError");this.getElementsByClassName("warning-icon")[0].classList.remove("showError");this.getElementsByClassName("creds")[0].classList.remove("hide");this.getElementsByClassName("saveCheck")[0].classList.remove("hide");this.getElementsByClassName("validation-error")[0].classList.remove("show");this.getElementsByClassName("general-info")[0].classList.remove("remove-margin");var D=this.querySelectorAll("sp-input.user-input");[].forEach.call(D,function(G){G.querySelector("input").style.borderColor="#CCCCCC"});this.validateFields=false;k.call(this);if(appData.simData.stationNames.length===0&&appData.simData.operatingStystems.length===0&&C!=="true"){t.call(this);this.getElementsByClassName("warn-station")[0].classList.add("showError");this.getElementsByClassName("warning-icon")[0].classList.add("showError");this.getElementsByClassName("warn-message")[0].innerText=o.NO_STATIONS_CONFIGURED}else{var E=d();var F=[];appData.simData.stationNames.forEach(function(H){if(appData.stationList&&appData.stationList.length>0){for(var G=0;G<appData.stationList.length;G++){if(appData.stationList[G].name.toUpperCase()==="{LOCALHOST}"&&appData.stationList[G].status==="Running"&&H.toUpperCase()==="{LOCALHOST}"){if(F.indexOf("Localhost")<0){F.push("Localhost")}}else{if(H.toUpperCase()===appData.stationList[G].name.toUpperCase()&&appData.stationList[G].disableRunAs!=="disabled"){switch(appData.stationList[G].os){case"WINDOWS":this.getElementsByClassName("windows")[0].classList.add("show");F.push(H);if(this.stationTypes.indexOf("windows")<0){this.stationTypes.push("windows")}break;case"UNIX":this.getElementsByClassName("linux")[0].classList.add("show");F.push(H);if(this.stationTypes.indexOf("linux")<0){this.stationTypes.push("linux")}break;default:F.push(H);return}}}}}}.bind(this));appData.simData.operatingStystems.forEach(function(G){var H=G.toUpperCase();switch(H){case"WINDOWS":this.getElementsByClassName("windows")[0].classList.add("show");break;case"UNIX":case"LINUX":this.getElementsByClassName("linux")[0].classList.add("show");break;default:}}.bind(this));if(C==="true"){t.call(this);this.stationTypes.push("isight")}if(F.length>0||E.length>0){this.getElementsByClassName("message")[0].classList.add("showError");this.getElementsByClassName("general-info")[0].classList.remove("remove-margin");this.getElementsByClassName("message")[0].innerHTML=p.call(this,F,E)}else{this.getElementsByClassName("general-info")[0].classList.add("remove-margin")}if(E.length===0&&F.length===0){var B=this.getElementsByClassName("station-details")[0];B.getElementsByClassName("label")[0].classList.add("hide")}if(E.length>0){this.getElementsByClassName("warning-icon")[0].classList.add("showError")}if(this.querySelectorAll(".credFieldsWrap.show").length<=0){this.getElementsByClassName("creds")[0].classList.add("hide");this.getElementsByClassName("saveCheck")[0].classList.add("hide")}if(this.stationTypes.length>0){w.call(this)}}if(!appData.pubKey){x.call(this)}};var m=function(){this.getElementsByClassName("general-info")[0].classList.add("hide");this.getElementsByClassName("credentials-section")[0].classList.add("show");this.getElementsByClassName("windows")[0].classList.add("show");this.getElementsByClassName("linux")[0].classList.add("show");this.getElementsByClassName("isight")[0].classList.add("show");this.validateFields=false;k.call(this);this.stationTypes=["windows","linux","isight"];if(!appData.pubKey){x.call(this)}};var l=function(){this.getElementsByClassName("station-details")[0].classList.add("hide");this.getElementsByClassName("general-info")[0].classList.add("remove-margin")};var v=function(E){this.editedCreds=[];var D=E.target.parentNode;var B=D.nextElementSibling;var G=B.getElementsByTagName("input")[0];var C=B.nextElementSibling.getElementsByTagName("sp-input")[0];var F=["windowsEdit","linuxEdit","isightEdit"];F.forEach(function(H){if(D.classList.toString().search(H)>0){this.editedCreds.push(H)}}.bind(this));G.disabled=false;C.children[0].disabled=false;C.value="";G.focus();this.editCreds=true};Polymer({is:"ps-run-as-modal",properties:{globals:{type:Object,value:function(){return{}}},simulations:{type:Array,value:function(){return[]}}},showModal:function(F,E){var D,C;this.simulations=[];this.getElementsByTagName("H4")[0].style.fontSize="20px";this.getElementsByTagName("H4")[0].style.fontWeight="normal";this.querySelector("#close").style.height="44px";this.querySelector("#body").style.maxHeight="450px";var B=n.widget&&n.widget.options&&n.widget.options.title;this.isFromSimList=(B==="My Simulations"||E===true);if(!this.isFromSimList){if(F.length===1){this.simulations.push(F)}if(appData.isRunAsEnabled===undefined||appData.isRunAsEnabled==="false"){this.getElementsByClassName("credentials-section")[0].classList.add("hide");l.call(this)}else{s.call(this);this.getElementsByClassName("credentials-section")[0].classList.remove("hide")}appData.simData.exeOptions.forEach(function(G){if(G.title_display==="Job Title"){D=G.value}if(G.title_display==="Job Description"){C=G.value}});this.querySelector("#jobTitle").value=D;this.querySelector("#jobDescription").value=C;this.querySelector("#runAs").innerText="Ok"}else{F.forEach(function(G){this.simulations.push(G)}.bind(this));this.querySelector("#runAs").innerText="Run";m.call(this)}this.$.configAndRun.show()},closeModal:function(){g.call(this);this.$.configAndRun.hide()},ready:r,useSimOptionsLogLevel:e,configAndRun:c,getWUTenantId:z,runJob:h,onRunStarted:a,onRunError:f,modifyExeOptions:q,getLatestCEStamp:y,editCredentials:v})}(this));