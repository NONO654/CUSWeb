define("DS/IssueAttachmentManager/services/AttachmentServices",["UWA/Core","UWA/Promise","UWA/Controls/Input","DS/DocumentManagement/DocumentManagement","DS/i3DXCompassPlatformServices/OpenWith","DS/WAFData/WAFData","DS/IssueServices/Contexts","DS/IssueServices/services/PlatformServices","i18n!DS/IssueAttachmentManager/assets/nls/IssueAttachmentManager"],function(e,h,g,j,b,i,c,a,k){var f={EXTENSIONS:{JPG:"image",JPEG:"image",PNG:"image",BMP:"image",GIF:"image",MP3:"audio",MPEG:"audio",OGG:"audio",FLAC:"audio",MP4:"video",AVI:"video",MPG:"video",MKV:"video",WEBM:"video",MOV:"video",PDF:"office",PPT:"office",PPTX:"office",DOC:"office",OTHER:"other"},TEN_MINUTES:600000,CACHE_LIMIT:5,FETCH_DOCUMENT_PREDICATES:["resourceid","ds6w:identifier","ds6w:label","ds6w:type","ds6w:modified","ds6w:created","preview_url","type_icon_url","ds6w:responsible","owner","ds6w:docextension","ds6w:organizationResponsible"],DOCUMENTS_SERVICE_ROOT_URL:"/resources/v1/modeler/documents/",DOCUMENTS_SERVICE_REL_OWNER_DATE_ARGS:"$include=versions,parents,relOwnerInfo&$fields=parents.originated",SET_AS_PRIMARY:{EXTENSION:".png"}};var d={getCurrentSecurityContext:function(){return a.getSecurityContext()},getCurrentTenant:function(){return a.getTenant()},parseDocument:function(q,l){if(!e.is(q,"object")){var n=k.replace(k.error.common.incorrectArgument,{arg:0,type:"Object"});throw new Error(n)}if(e.is(l)&&!e.is(l,"string")){var t=k.replace(k.error.common.incorrectArgument,{arg:1,type:"String"});throw new Error(t)}var p;try{p={id:q.id,title:q.dataelements.title||q.dataelements.name,type:q.type,thumbnailUrl:q.dataelements.image,owner:{firstName:q.relateddata.ownerInfo[0].dataelements.firstname,fullName:q.relateddata.ownerInfo[0].dataelements.firstname+" "+q.relateddata.ownerInfo[0].dataelements.lastname,lastName:q.relateddata.ownerInfo[0].dataelements.lastname,user:q.relateddata.ownerInfo[0].dataelements.name},created:q.dataelements.originated,modified:q.dataelements.modified};if(l&&q.relateddata.hasOwnProperty("parents")){var r=q.relateddata.parents.find(function(u){return u.id===l});if(r){p.relOwner={firstName:r.relateddata.relOwnerInfo[0].dataelements.firstname,fullName:r.relateddata.relOwnerInfo[0].dataelements.firstname+" "+r.relateddata.relOwnerInfo[0].dataelements.lastname,lastName:r.relateddata.relOwnerInfo[0].dataelements.lastname,user:r.relateddata.relOwnerInfo[0].dataelements.name};p.relOriginated=r.relelements.originated}}if(q.type==="Document"&&q.relateddata.files.length){p.title=q.relateddata.files[0].dataelements.title;var m=q.relateddata.files[0].dataelements.title.split(".");var s=m[m.length-1];if(f.EXTENSIONS.hasOwnProperty(s.toUpperCase())){p.documentType=f.EXTENSIONS[s.toUpperCase()]}else{p.documentType=f.EXTENSIONS.OTHER}}}catch(o){throw o}return p},parseFromSearch:function(n){if(!e.is(n,"object")){var l=k.replace(k.error.common.incorrectArgument,{arg:0,type:"Object"});throw new Error(l)}var m={id:n.id,title:n["ds6w:label"],type:n["ds6w:type"],modified:n["ds6w:modified"],created:n["ds6w:created"],thumbnailUrl:n.preview_url,iconUrl:n.type_icon_url,owner:{firstName:"",fullName:n["ds6w:responsible"],lastName:"",user:n.owner}};if(m.type==="Document"&&n.hasOwnProperty("ds6w:docExtension")){var o=n["ds6w:docExtension"];m.title+="."+o;if(f.EXTENSIONS.hasOwnProperty(o.toUpperCase())){m.documentType=f.EXTENSIONS[o.toUpperCase()]}else{m.documentType=f.EXTENSIONS.OTHER}}return m},parseFromFetch:function(p){if(!e.is(p,"object")||!e.is(p.attributes,"array")){var m=k.replace(k.error.common.incorrectArgument,{arg:0,type:"Object"});throw new Error(m)}p.attributes.sort(function(s,r){if(s.name==="ds6w:docextension"){return 1}else{if(r.name==="ds6w:docextension"){return -1}}return 0});var n={owner:{}};for(var o=0;o<p.attributes.length;o++){var l=p.attributes[o];if(l.name==="resourceid"){n.id=l.value}if(l.name==="ds6w:label"){n.title=l.value}if(l.name==="ds6w:type"){n.type=l.value}if(l.name==="ds6w:modified"){n.modified=l.value}if(l.name==="ds6w:created"){n.created=l.value}if(l.name==="preview_url"){n.thumbnailUrl=l.value}if(l.name==="type_icon_url"){n.iconUrl=l.value}if(l.name==="ds6w:responsible"){n.owner.fullName=l.value}if(l.name==="owner"){n.owner.user=l.value}if(l.name==="ds6w:docextension"&&n.type==="Document"){var q=l.value;n.title+="."+q;if(f.EXTENSIONS.hasOwnProperty(q.toUpperCase())){n.documentType=f.EXTENSIONS[q.toUpperCase()]}else{n.documentType=f.EXTENSIONS.OTHER}}}return n},parseFromDragEvent:function(m){if(!(m instanceof DragEvent)){var o=k.replace(k.error.common.incorrectArgument,{arg:0,type:"DragEvent"});throw new Error(o)}var n=null;var u=e.is(m.dataTransfer.types.indexOf,"function")?"indexOf":"contains",r="";var p=["text/searchitems","text/plain","Text","Files"];for(var t=0;t<p.length&&r==="";t++){var s=m.dataTransfer.types[u](p[t]);if((e.is(s,"number")&&s>=0)||(e.is(s,"boolean")&&s===true)){r=p[t]}}var l={};if(r==="Files"){n={files:m.dataTransfer.files}}else{if(r!==""){l=m.dataTransfer.getData(r);try{n=JSON.parse(l)}catch(q){}}}return n},getDocumentsFrom:function(n){var m=this;if(!e.is(n,"string")){var l=k.replace(k.error.common.incorrectArgument,{arg:0,type:"String"});return h.reject(Error(l))}return new h(function(q,p){var o=c.get("widget")||window.widget;j.getDocumentsFromParent({getVersions:false,additionalURLParams:f.DOCUMENTS_SERVICE_REL_OWNER_DATE_ARGS,relInfo:{parentId:n,parentRelName:"Reference Document"},tenantUrl:a.get3DSpaceUrl(),tenant:m.getCurrentTenant(),securityContext:"ctx::"+m.getCurrentSecurityContext(),onComplete:function(s){var r={id:n,primaryAttachment:"",attachments:[]};for(var t=0;t<s.data.length;t++){var u=s.data[t];var v=m.parseDocument(u,n);r.attachments.push(v)}q(r)},onFailure:p})})},getDocuments:function(m){var n=this;if(!e.is(m,"array")){var l=k.replace(k.error.common.incorrectArgument,{arg:0,type:"Array<String>"});return h.reject(Error(l))}return new h(function(q,p){var o=c.get("widget")||window.widget;j.getDocuments(m,{getVersions:false,additionalURLParams:f.DOCUMENTS_SERVICE_REL_OWNER_DATE_ARGS,tenantUrl:a.get3DSpaceUrl(),tenant:n.getCurrentTenant(),securityContext:"ctx::"+n.getCurrentSecurityContext(),onComplete:function(s){var r={attachments:[]};for(var t=0;t<s.data.length;t++){var u=s.data[t];var v=n.parseDocument(u);r.attachments.push(v)}q(r)},onFailure:p})})},fetch:function(m){var n=this;if(!e.is(m,"array")){var l=k.replace(k.error.common.incorrectArgument,{arg:0,type:"Array<String>"});return h.reject(Error(l))}return new h(function(s,r){var q=c.get("widget")||window.widget;var p={label:q.name+"-"+a.getUserName()+"-"+Date.now(),nresults:m.length,physicalid:m,start:0,tenantUrl:a.get3DSpaceUrl(),tenant:n.getCurrentTenant(),select_predicate:f.FETCH_DOCUMENT_PREDICATES};var o={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:"ctx::"+n.getCurrentSecurityContext()},timeout:f.TEN_MINUTES,onComplete:function(x){var t;try{t=JSON.parse(x)}catch(v){r(v)}if(Array.isArray(t.results)&&t.results.length===m.length){s(t)}else{var y=[];if(Array.isArray(t.results)){var u=t.results.map(function(z){return n.parseFromFetch(z)});var w=u.reduce(function(z,A){z.push(A.id);return z},[]);y=m.filter(function(z){return w.indexOf(z)===-1})}else{y=m}n.recent().then(function(z){if(Array.isArray(z.results)){var B=e.clone(t);if(!Array.isArray(B.results)){B.results=[]}for(var A=0;A<z.results.length;A++){var C=n.parseFromFetch(z.results[A]);if(y.indexOf(C.id)!==-1){B.results.push(z.results[A]);B.infos.nhits++;B.infos.nresults++}}s(B)}else{s(t)}})["catch"](function(){s(t)})}},onFailure:r,data:JSON.stringify(p)};i.authenticatedRequest(a.get3DSpaceUrl()+"/cvservlet/fetch/v2",o)})},recent:function(){var l=this;return new h(function(r,q){var p=c.get("widget")||window.widget;var o={label:p.name+"-"+a.getUserName()+"-"+Date.now(),nresults:100,delta_time_interval:300,tenant:l.getCurrentTenant(),select_predicate:f.FETCH_DOCUMENT_PREDICATES,select_file:["icon","thumbnail_2d"]};var n={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},timeout:f.TEN_MINUTES,onComplete:function(t){try{var s=JSON.parse(t);r(s)}catch(u){q(u)}},onFailure:q,data:JSON.stringify(o)};var m=a.get3DSearchUrl()+"/recent?tenant="+l.getCurrentTenant()+"&_="+Date.now();i.authenticatedRequest(m,n)})},downloadDocuments:function(n,q){var p=this;if(!e.is(n,"array")){var l=k.replace(k.error.common.incorrectArgument,{arg:0,type:"Array<String>"});return h.reject(Error(l))}if(e.is(q)&&!e.is(q,"boolean")){var o=k.replace(k.error.common.incorrectArgument,{arg:1,type:"Boolean"});return h.reject(Error(o))}var m=new h(function(s){var r=j._prepareService(s,{tenantUrl:a.get3DSpaceUrl(),tenant:p.getCurrentTenant(),securityContext:p.getCurrentSecurityContext()});if(!r){s()}});return m.then(function(){return new h(function(v,u){var s=a.get3DSpaceUrl()+f.DOCUMENTS_SERVICE_ROOT_URL+"DownloadTicket";if(!q){s+="?fileStream=true"}else{s+="?zipFiles=true"}s+="&tenant="+p.getCurrentTenant();s+="&SecurityContext=ctx%3A%3A"+p.getCurrentSecurityContext();var t={csrf:j.getCsrf(a.get3DSpaceUrl()),data:n.map(function(w){return{id:w}})};var r={method:"PUT",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:"ctx::"+p.getCurrentSecurityContext()},timeout:f.TEN_MINUTES,onComplete:function(y){try{var x=JSON.parse(y);var B=[];if(x&&x.success){if(x&&x.data&&x.data.length){var C=x.data.length;for(var w=0;w<C;w++){var D=x.data[w];var A={id:D.id,errorMessage:D.updateMessage};if(D.dataelements&&D.dataelements.ticketURL){A.downloadUrl=D.dataelements.ticketURL;if(D.dataelements.fileName){A.fileName=D.dataelements.fileName}if(D.dataelements.fileNames){A.fileNames=D.dataelements.fileNames}}B.push(A)}v(B)}}else{u(x)}}catch(z){u(z)}},onFailure:u,data:JSON.stringify(t)};i.authenticatedRequest(s,r)})})},uploadFile:function(n,s,q){var p=this;var r;if(!(n instanceof File||n instanceof Blob)){var l=k.replace(k.error.common.incorrectArgument,{arg:0,type:"File"});r=h.reject(Error(l));return r}if(e.is(s,"string")&&s===""){var m=k.replace(k.error.common.incorrectArgument,{arg:1,type:"String"});r=h.reject(Error(m));return r}var o=new h(function(u){var t=j._prepareService(u,{tenantUrl:a.get3DSpaceUrl(),tenant:p.getCurrentTenant(),securityContext:p.getCurrentSecurityContext()});if(!t){u()}});r=o.then(function(){return new h(function(x,w){var v=a.get3DSpaceUrl()+f.DOCUMENTS_SERVICE_ROOT_URL+"files/CheckinTicket";v+="?tenant="+p.getCurrentTenant();v+="&SecurityContext=ctx%3A%3A"+p.getCurrentSecurityContext();var y={csrf:j.getCsrf(a.get3DSpaceUrl())};var t={method:"PUT",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:"ctx::"+p.getCurrentSecurityContext()},timeout:f.TEN_MINUTES,onComplete:function(F){var E=JSON.parse(F);if(e.is(q,"object")&&e.is(q.onTicketComplete,"function")){q.onTicketComplete(E)}if(E&&E.success){var H=E.data[0].dataelements;j.setCsrf(E.csrf,a.get3DSpaceUrl());var D=H.ticketURL;var z={csrf:"notNeeded",documentInfo:{fileInfo:{file:n}}};if(e.is(s,"string")&&s!==""){z.documentInfo.relInfo={parentId:s,parentRelName:"Reference Document"}}var A=e.extend(z,H);var B=new FormData();B.append(H.ticketparamname,H.ticket);B.append("file_0",n,n.name);var C={method:"POST",onComplete:function(L){if(e.is(q,"object")&&e.is(q.onCheckinComplete,"function")){q.onCheckinComplete(L)}var J=a.get3DSpaceUrl()+f.DOCUMENTS_SERVICE_ROOT_URL;var I=Object.create(null);j._buildDocumentDataElements(I,A);A.fcsReceipt=L;j._buildFilesRelatedData(I,A);var K={csrf:y.csrf,data:[I]};var M={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",SecurityContext:"ctx::"+p.getCurrentSecurityContext()},timeout:f.TEN_MINUTES,onComplete:function(O){var P=JSON.parse(O);if(e.is(q,"object")&&e.is(q.onConnectComplete,"function")){q.onConnectComplete(P)}x(P)},onFailure:w,onCancel:w,onTimeout:w,data:JSON.stringify(K)};var N=i.authenticatedRequest(J,M);if(e.is(q,"object")&&e.is(q.onConnectStart,"function")){q.onConnectStart(N)}},onFailure:w,onCancel:w,data:B,timeout:0};if(e.is(q,"object")&&e.is(q.onCheckinProgress,"function")){C.onUploadProgress=q.onCheckinProgress}var G=i.authenticatedRequest(D,C);if(e.is(q,"object")&&e.is(q.onCheckinStart,"function")){q.onCheckinStart(G)}}else{w(E)}},onFailure:w,onCancel:w,onTimeout:w,data:JSON.stringify(y)};var u=i.authenticatedRequest(v,t);if(e.is(q,"object")&&e.is(q.onTicketStart,"function")){q.onTicketStart(u)}})});return r},connectDocumentToParent:function(n,p){var o=this;if(!e.is(n,"string")){var m=k.replace(k.error.common.incorrectArgument,{arg:0,type:"String"});return h.reject(Error(m))}if(!e.is(p,"string")){var l=k.replace(k.error.common.incorrectArgument,{arg:1,type:"String"});return h.reject(Error(l))}return new h(function(s,r){var q=c.get("widget")||window.widget;j.connectDocumentToParent(n,{relInfo:{parentId:p,parentRelName:"Reference Document"},tenantUrl:a.get3DSpaceUrl(),tenant:o.getCurrentTenant(),securityContext:"ctx::"+o.getCurrentSecurityContext(),onComplete:s,onFailure:r})})},connectDocumentsToParent:function(r,o){var q=this;if(!e.is(r,"array")){var p=k.replace(k.error.common.incorrectArgument,{arg:0,type:"Array<String>"});return h.reject(Error(p))}if(!e.is(o,"string")){var m=k.replace(k.error.common.incorrectArgument,{arg:1,type:"String"});return h.reject(Error(m))}var s=[];for(var n=0;n<r.length;n++){var l=r[n];var t=function(v){var u=this;return{documentId:u.documentId,parentId:u.parentId,response:v}};s.push(q.connectDocumentToParent(l,o).then(t.bind({documentId:l,parentId:o}))["catch"](t.bind({documentId:l,parentId:o})))}return h.all(s)},disconnectDocumentFromParent:function(n,p){var o=this;if(!e.is(n,"string")){var m=k.replace(k.error.common.incorrectArgument,{arg:0,type:"String"});return h.reject(Error(m))}if(!e.is(p,"string")){var l=k.replace(k.error.common.incorrectArgument,{arg:1,type:"String"});return h.reject(Error(l))}return new h(function(s,r){var q=c.get("widget")||window.widget;j.disconnectDocumentFromParent(n,{relInfo:{parentId:p,parentRelName:"Reference Document"},tenantUrl:a.get3DSpaceUrl(),tenant:o.getCurrentTenant(),securityContext:"ctx::"+o.getCurrentSecurityContext(),onComplete:s,onFailure:r})})},disconnectDocumentsFromParent:function(r,o){var q=this;if(!e.is(r,"array")){var p=k.replace(k.error.common.incorrectArgument,{arg:0,type:"Array<String>"});return h.reject(Error(p))}if(!e.is(o,"string")){var m=k.replace(k.error.common.incorrectArgument,{arg:1,type:"String"});return h.reject(Error(m))}var s=[];for(var n=0;n<r.length;n++){var l=r[n];var t=function(v){var u=this;return{documentId:u.documentId,parentId:u.parentId,response:v}};s.push(q.disconnectDocumentFromParent(l,o).then(t.bind({documentId:l,parentId:o}))["catch"](t.bind({documentId:l,parentId:o})))}return h.all(s)},deleteDocument:function(m){var n=this;if(!e.is(m,"string")){var l=k.replace(k.error.common.incorrectArgument,{arg:0,type:"String"});return h.reject(Error(l))}return new h(function(q,p){var o=c.get("widget")||window.widget;j.deleteDocument(m,{tenantUrl:a.get3DSpaceUrl(),tenant:n.getCurrentTenant(),securityContext:"ctx::"+n.getCurrentSecurityContext(),onComplete:q,onFailure:p})})},deleteDocuments:function(r){var p=this;if(!e.is(r,"array")){var l=k.replace(k.error.common.incorrectArgument,{arg:0,type:"Array<String>"});return h.reject(Error(l))}var n=[];for(var m=0;m<r.length;m++){var o=r[m];var q=function(t){var s=this;return{documentId:s.documentId,response:t}};n.push(p.deleteDocument(o).then(q.bind({documentId:o}))["catch"](q.bind({documentId:o})))}return h.all(n)},browseFileFromLocalDisk:function(){return new h(function(m){var l=new g.File("Input.File",{visibility:"hidden",styles:{display:"none"}});l.elements.container.setStyle("display","none");l.elements.input.accept="all";l.elements.input.multiple=true;l.elements.input.addEventListener("change",function(o){l.destroy();l=null;var n=o.target.files;m(n)},false);l.elements.input.addEventListener("click",function(n){n.stopPropagation()});l.elements.input.click()})},getPrimary:function(n){var l=this;if(!e.is(n,"string")){var m=k.replace(k.error.common.incorrectArgument,{arg:0,type:"String"});return h.reject(Error(m))}return new h(function(q,p){var o={};o.method="GET";o.headers={Accept:"application/json","Content-Type":"application/json",SecurityContext:"ctx::"+l.getCurrentSecurityContext()};o.onComplete=function(s){var r=(JSON.parse(s)).body;var t=f.SET_AS_PRIMARY.EXTENSION;if(r.fileName&&r.fileName.indexOf(t)===(r.fileName.length-t.length)){r.documentId=r.fileName.slice(0,-t.length)}q(JSON.stringify(r))};o.onFailure=p;i.authenticatedRequest(a.assembleURLFor3DSpace("/resources/issues/"+n+"/images/primary"),o)})},setAsPrimary:function(o,r,n){var p=this;if(!e.is(o,"string")){var q=k.replace(k.error.common.incorrectArgument,{arg:0,type:"String"});return h.reject(Error(q))}if(!e.is(r,"string")){var l=k.replace(k.error.common.incorrectArgument,{arg:1,type:"String"});return h.reject(Error(l))}if(e.is(n)&&!e.is(n,"boolean")){var m=k.replace(k.error.common.incorrectArgument,{arg:2,type:"Boolean"});return h.reject(Error(m))}return new h(function(v,u){var t={document:o,lock:n||false};var s={};s.method="PUT";s.headers={Accept:"application/json","Content-Type":"application/json",SecurityContext:"ctx::"+p.getCurrentSecurityContext()};s.data=JSON.stringify(t);s.onComplete=function(x){var w=(JSON.parse(x)).body;var y=f.SET_AS_PRIMARY.EXTENSION;if(w.fileName&&w.fileName.indexOf(y)===(w.fileName.length-y.length)){w.documentId=w.fileName.slice(0,-y.length)}v(JSON.stringify(w))};s.onFailure=u;i.authenticatedRequest(a.assembleURLFor3DSpace("/resources/issues/"+r+"/images/primary"),s)})},unsetAsPrimary:function(n){var m=this;if(!e.is(n,"string")){var l=k.replace(k.error.common.incorrectArgument,{arg:0,type:"String"});return h.reject(Error(l))}return new h(function(q,p){var o={};o.method="DELETE";o.headers={Accept:"application/json","Content-Type":"application/json",SecurityContext:"ctx::"+m.getCurrentSecurityContext()};o.onComplete=q;o.onFailure=p;i.authenticatedRequest(a.assembleURLFor3DSpace("/resources/issues/"+n+"/images/primary"),o)})},getCompatibleApps:function(n){var l=[];if(!e.is(n,"array")){var m=k.replace(k.error.common.incorrectArgument,{arg:0,type:"Array"});return h.reject(Error(m))}return new h(function(s,r){if(n.length===0){s([])}else{for(var o=0;o<n.length;o++){var t=n[o];l.push({serviceId:"3DSpace",objectId:t.id,objectType:t.get("type"),displayName:t.get("title")?t.get("title"):t.get("name")})}var q=c.get("widget")||window.widget;var p=(new b()).set3DXContent({protocol:"3DXContent",version:"1.1",source:q.name,widgetId:q.id,data:{items:l}},true);p.retrieveCompatibleApps(s,r)}})}};return d});define("DS/IssueAttachmentManager/components/Item",["UWA/Class/Model","UWA/Core","DS/Logger/Logger","DS/WebappsUtils/WebappsUtils","i18n!DS/IssueAttachmentManager/assets/nls/IssueAttachmentManager"],function(f,g,b,d,e){var a={EXTENSIONS:{JPG:"image",JPEG:"image",PNG:"image",BMP:"image",GIF:"image",MP3:"audio",MPEG:"audio",OGG:"audio",FLAC:"audio",MP4:"video",AVI:"video",MPG:"video",MKV:"video",WEBM:"video",MOV:"video",PDF:"office",PPT:"office",PPTX:"office",DOC:"office",OTHER:"other"},MIMETYPE:{IMAGE:"image",AUDIO:"audio",VIDEO:"video",APPLICATION:"other"}};var c=f.extend({name:"DS/IssueAttachmentManager/components/Item",_logger:null,defaults:{id:null,type:null,title:"",owner:null,relOwner:null,created:"",modified:"",relOriginated:"",isProcessing:false,isFailed:false,isFile:false,isPrimary:false},init:function(h,i){var j=this;if(!h.hasOwnProperty("id")||g.is(h.id,null)||g.equals(h.id,"")||!g.is(h.id,"string")){throw new Error(e.replace(e.error.common.incorrectInitArgument,{className:"Item",property:"id",type:"String"}))}if(!h.hasOwnProperty("type")||g.is(h.type,null)||g.equals(h.type,"")||!g.is(h.type,"string")){throw new Error(e.replace(e.error.common.incorrectInitArgument,{className:"Item",property:"type",type:"String"}))}if(!h.hasOwnProperty("title")||g.is(h.title,null)||!g.is(h.title,"string")){throw new Error(e.replace(e.error.common.incorrectInitArgument,{className:"Item",property:"title",type:"String"}))}if(h.hasOwnProperty("documentType")&&!g.is(h.documentType,"string")){throw new Error(e.replace(e.error.common.incorrectInitArgument,{className:"Item",property:"documentType",type:"String"}))}if(h.hasOwnProperty("owner")&&!g.is(h.owner,"object")){throw new Error(e.replace(e.error.common.incorrectInitArgument,{className:"Item",property:"owner",type:"Object"}))}if(h.hasOwnProperty("relOwner")&&!g.is(h.relOwner,"object")){throw new Error(e.replace(e.error.common.incorrectInitArgument,{className:"Item",property:"relOwner",type:"Object"}))}if(h.hasOwnProperty("created")&&!(g.is(h.created,"string")||g.is(h.created,"date"))){throw new Error(e.replace(e.error.common.incorrectInitArgument,{className:"Item",property:"created",type:"String"}))}if(h.hasOwnProperty("modified")&&!(g.is(h.modified,"string")||g.is(h.modified,"date"))){throw new Error(e.replace(e.error.common.incorrectInitArgument,{className:"Item",property:"modified",type:"String"}))}if(h.hasOwnProperty("relOriginated")&&!(g.is(h.relOriginated,"string")||g.is(h.relOriginated,"date"))){throw new Error(e.replace(e.error.common.incorrectInitArgument,{className:"Item",property:"relOriginated",type:"String"}))}if(h.hasOwnProperty("thumbnailUrl")&&!g.is(h.thumbnailUrl,"string")){throw new Error(e.replace(e.error.common.incorrectInitArgument,{className:"Item",property:"thumbnailUrl",type:"String"}))}if(h.hasOwnProperty("iconUrl")&&!g.is(h.iconUrl,"string")){throw new Error(e.replace(e.error.common.incorrectInitArgument,{className:"Item",property:"iconUrl",type:"String"}))}if(h.hasOwnProperty("contentUrl")&&!g.is(h.contentUrl,"string")){throw new Error(e.replace(e.error.common.incorrectInitArgument,{className:"Item",property:"contentUrl",type:"String"}))}j._parent(h,i)},setup:function(){var i=this;i.set("modified",new Date(i.get("modified")));i.set("created",new Date(i.get("created")));i.set("relOriginated",new Date(i.get("relOriginated")));if(i.get("iconUrl")===undefined){var h=d.getWebappsAssetUrl("IssueAttachmentManager","images/I_MultipleDocuments22x22.png");i.set("iconUrl",h)}i._logger=b.getLogger(i.name);i.selected=false;i.hidden=false},setDocumentType:function(h){if(!g.is(h,"string")){throw new Error(e.replace(e.error.common.incorrectArgument,{arg:0,type:"String"}))}if(a.EXTENSIONS.hasOwnProperty(h.toUpperCase())){this.set("documentType",a.EXTENSIONS[h.toUpperCase()])}else{this.set("documentType",a.EXTENSIONS.OTHER)}return this},setDocumentTypeByMIME:function(i){if(!g.is(i,"string")){throw new Error(e.replace(e.error.common.incorrectArgument,{arg:0,type:"String"}))}var j=i.split("/");if(j.length===2){var h=j[0];if(a.MIMETYPE.hasOwnProperty(h.toUpperCase())){this.set("documentType",a.MIMETYPE[h.toUpperCase()])}else{this.set("documentType",a.EXTENSIONS.OTHER)}}else{this.set("documentType",a.EXTENSIONS.OTHER)}return this},select:function(){if(this.selected===false){this.selected=true;this.dispatchEvent("onSelect",{id:this.id,props:this.toJSON()})}return this},unselect:function(){if(this.selected===true){this.selected=false;this.dispatchEvent("onUnselect",{id:this.id,props:this.toJSON()})}return this},hide:function(){if(this.hidden===false){this.hidden=true;this.dispatchEvent("onHide",{id:this.id,props:this.toJSON()})}return this},show:function(){if(this.hidden===true){this.hidden=false;this.dispatchEvent("onShow",{id:this.id,props:this.toJSON()})}return this}});return c});define("DS/IssueAttachmentManager/components/Collection",["UWA/Core","UWA/Class/Collection","DS/Logger/Logger","DS/IssueAttachmentManager/components/Item","i18n!DS/IssueAttachmentManager/assets/nls/IssueAttachmentManager"],function(g,e,b,c,f){var a={ONSELECT_TIMEOUT:0,ONUNSELECT_TIMEOUT:0,SORT:{MODE:{DATE:"relOriginated",TITLE:"title"},ORDER:{ASCENDING:1,DESCENDING:-1},TYPE:{DOCUMENT:1,OTHER:2},DOCUMENTTYPE:{IMAGE:1,VIDEO:2,AUDIO:3,OFFICE:4,OTHER:5}}};var d=e.extend({name:"DS/IssueAttachmentManager/components/Collection",model:c,_logger:null,init:function(h,i){var k=this;if(!h.hasOwnProperty("id")||g.is(h.id,null)||g.equals(h.id,"")||!g.is(h.id,"string")){throw new Error(f.replace(f.error.common.incorrectInitArgument,{className:"Collection",property:"id",type:"String"}))}if(h.hasOwnProperty("primaryAttachment")&&!g.is(h.primaryAttachment,"string")){throw new Error(f.replace(f.error.common.incorrectInitArgument,{className:"Collection",property:"primaryAttachment",type:"String"}))}if(h.hasOwnProperty("attachments")&&!g.is(h.attachments,"array")){throw new Error(f.replace(f.error.common.incorrectInitArgument,{className:"Collection",property:"attachments",type:"Array"}))}k.id=h.id;k.primaryAttachment=h.primaryAttachment;var j=g.merge(i||{},{comparator:k._sortComparator.bind(k)});k._parent(h.attachments,j)},setup:function(){var h=this;h._logger=b.getLogger(h.name);h.sortMode="date";h.sortOrder="descending";h.groupByType=false;h._selectedItems=[];h._unselectedItems=[];h._eventCallbacks._debounced._onItemSelect=h.debounce(h._eventCallbacks._unbounced._onItemSelect,a.ONSELECT_TIMEOUT);h._eventCallbacks._debounced._onItemUnselect=h.debounce(h._eventCallbacks._unbounced._onItemUnselect,a.ONUNSELECT_TIMEOUT)},select:function(m){var n=this;if(g.is(m,"string")){if(!n.get(m)){var j=f.replace(f.error.components.Collection.common.itemNotExist,{id:m});throw new Error(j)}else{n.get(m).select()}}else{if(g.is(m,"array")){var o=[];for(var k=0;k<m.length;k++){if(n.get(m[k])){n.get(m[k]).select()}else{o.push(m[k])}}if(o.length>0){var l=f.replace(f.error.components.Collection.common.itemNotExist,{id:o});n._logger.error(l)}}else{var h=f.replace(f.error.common.incorrectArgument,{arg:0,type:"String or Array<String>"});throw new Error(h)}}return this},unselect:function(m){var n=this;if(g.is(m,"string")){if(!n.get(m)){var j=f.replace(f.error.components.Collection.common.itemNotExist,{id:m});throw new Error(j)}else{n.get(m).unselect()}}else{if(g.is(m,"array")){var o=[];for(var k=0;k<m.length;k++){if(n.get(m[k])){n.get(m[k]).unselect()}else{o.push(m[k])}if(o.length>0){var l=f.replace(f.error.components.Collection.common.itemNotExist,{id:m[k]});n._logger.error(l)}}}else{var h=f.replace(f.error.common.incorrectArgument,{arg:0,type:"String or Array<String>"});throw new Error(h)}}return this},selectAll:function(){var h=this.map(function(i){return i.id});return this.select(h)},unselectAll:function(){var h=this.map(function(i){return i.id});return this.unselect(h)},getItems:function(m){var n=this;if(g.is(m,"array")){var k=[];var o=[];for(var j=0;j<m.length;j++){if(n.get(m[j])){k.push(n.get(m[j]))}else{o.push(m[j])}if(o.length>0){var l=f.replace(f.error.components.Collection.common.itemNotExist,{id:m[j]});n._logger.error(l)}}return k}else{var h=f.replace(f.error.common.incorrectArgument,{arg:0,type:"array"});throw new Error(h)}},getSelectedItems:function(){var j=[];for(var h=0;h<this.size();h++){var k=this.at(h);if(k.selected){j.push(k)}}return j},_sortComparator:function(k,j){var i=this.groupByType?this._groupByType(k,j):0;if(i===0){switch(a.SORT.MODE[this.sortMode.toUpperCase()]){case a.SORT.MODE.DATE:i=this._sortByRelOriginatedDate(k,j);break;case a.SORT.MODE.TITLE:i=this._sortByTitle(k,j);break;default:i=this._sortByRelOriginatedDate(k,j);break}var h=a.SORT.ORDER.ASCENDING;if(a.SORT.ORDER.hasOwnProperty(this.sortOrder.toUpperCase())){h=a.SORT.ORDER[this.sortOrder.toUpperCase()]}i=i*h}return i},_groupByType:function(l,j){var i=0;var n=a.SORT.TYPE[l.get("type").toUpperCase()]||a.SORT.TYPE.OTHER;var m=a.SORT.TYPE[j.get("type").toUpperCase()]||a.SORT.TYPE.OTHER;i=n-m;if(i===0&&n===a.SORT.TYPE.DOCUMENT){if(l.get("documentType")&&j.get("documentType")){var k=a.SORT.DOCUMENTTYPE[l.get("documentType").toUpperCase()]||a.SORT.TYPE.OTHER;var h=a.SORT.DOCUMENTTYPE[j.get("documentType").toUpperCase()]||a.SORT.TYPE.OTHER;i=k-h}}return i},_sortByRelOriginatedDate:function(k,j){var i=k.get("relOriginated");if(isNaN(i)){return -1}var h=j.get("relOriginated");if(isNaN(h)){return 1}return(i-h)},_sortByTitle:function(k,j){var i=k.get("title");var h=j.get("title");return i.localeCompare(h)},_onItemSelect:function(h){this._selectedItems.push(h.id);this._eventCallbacks._debounced._onItemSelect.call(this)},_onItemUnselect:function(h){this._unselectedItems.push(h.id);this._eventCallbacks._debounced._onItemUnselect.call(this)},_eventCallbacks:{_unbounced:{_onItemSelect:function(){this.dispatchEvent("onSelect",{ids:this._selectedItems.slice(0)});this._selectedItems=[]},_onItemUnselect:function(){this.dispatchEvent("onUnselect",{ids:this._unselectedItems.slice(0)});this._unselectedItems=[]}},_debounced:{}},_onModelEvent:function(){if(arguments[0]==="onSelect"){return this._onItemSelect(arguments[1])}if(arguments[0]==="onUnselect"){return this._onItemUnselect(arguments[1])}return this._parent.apply(this,arguments)},_debounceTimeouts:[],debounce:function(j,l,h){var i=this;var k;return function(){var q=this,p=arguments;var n=function(){k=null;if(!h){j.apply(q,p)}};var m=h&&!k;clearTimeout(k);var o=i._debounceTimeouts.indexOf(k);if(o!==-1){i._debounceTimeouts.splice(o,1)}k=setTimeout(n,l);i._debounceTimeouts.push(k);if(m){j.apply(q,p)}}}});return d});define("DS/IssueAttachmentManager/views/Attachment",["UWA/Class/View","UWA/Core","DS/Logger/Logger","DS/UIKIT/Input/Button","DS/UIKIT/Mask","DS/IssueServices/services/PlatformServices","DS/IssueServices/utils/Performance","DS/IssueAttachmentManager/components/Item","css!DS/IssueAttachmentManager/IssueAttachmentManager.css","i18n!DS/IssueAttachmentManager/assets/nls/IssueAttachmentManager"],function(b,i,e,k,h,c,d,f,a,l){var j={CSS:{ELEMENTS:{THUMBNAIL:"isu-am-attachment-thumbnail",ERROR:"isu-am-attachment-error",ERRORICON:"fonticon-alert isu-am-attachment-error-icon",ERRORTEXT:"isu-am-attachment-error-text",ICON:"isu-am-attachment-icon",TITLE:"isu-am-attachment-title",DATE:"isu-am-attachment-date",RELOWNER:"isu-am-attachment-rel-owner",PRIMARYICON:"fonticon-star isu-am-attachment-primary-icon",CANCELBUTTON:"isu-am-attachment-cancelbtn default btn-sm",DISCARDBUTTON:"isu-am-attachment-discardbtn default btn-sm"},STATUS:{FAILED:"is-failed",PRIMARY:"is-primary",PROCESSING:"is-processing",CANCELABLE:"is-cancelable"}}};var g=b.extend({name:"DS/IssueAttachmentManager/views/Attachment",tagName:"div",className:"isu-am-attachment",_logger:null,model:null,id:null,elements:{thumbnail:null,icon:null,title:null,date:null,relOwner:null},init:function(m){if(!m.hasOwnProperty("model")||i.is(m.model,null)||!(m.model instanceof f)){throw new Error(l.replace(l.error.common.incorrectInitArgument,{className:"Attachment",property:"model",type:"DS/IssueAttachmentManager/components/Item"}))}this._parent(m)},setup:function(m){d.start(this.name+" setup");this._parent(m);this._logger=e.getLogger(this.name);this.id=this.model.id;this.container.id=this.id;this.listeners={};this.listenTo(this.model,"onSelect",this._onSelect);this.listenTo(this.model,"onUnselect",this._onUnselect);this.listenTo(this.model,"onChange:thumbnailUrl",this._onChangeThumbnailUrl);this.listenTo(this.model,"onChange:contentUrl",this._onChangeContentUrl);this.listenTo(this.model,"onChange:iconUrl",this._onChangeIconUrl);this.listenTo(this.model,"onChange:title",this._onChangeTitle);this.listenTo(this.model,"onChange:isProcessing",this._onChangeIsProcessing);this.listenTo(this.model,"onChange:isCancelable",this._onChangeIsCancelable);this.listenTo(this.model,"onChange:isFailed",this._onChangeIsFailed);this.listenTo(this.model,"onChange:isPrimary",this._onChangeIsPrimary);this.listenTo(this.model,"onChange:requestProgress",this._onChangeRequestProgress);d.end(this.name+" setup")},render:function(){var s=this;d.start(this.name+" render");this.container.setAttribute("id","attachment-"+this.id);this.container.setData("id",this.id);if(this.model.get("isProcessing")===true){this.container.addClassName(j.CSS.STATUS.PROCESSING);h.mask(this.container)}if(this.model.get("isCancelable")===true){this.container.addClassName(j.CSS.STATUS.CANCELABLE)}if(this.model.get("isPrimary")===true){this.container.addClassName(j.CSS.STATUS.PRIMARY)}var m=["thumbnail","error","icon","title","date","relOwner"];m.forEach(function(w){s.elements[w]=i.createElement("div",{"class":j.CSS.ELEMENTS[w.toUpperCase()]}).inject(s.container)});var t=i.createElement("img",{src:this.model.get("thumbnailUrl")||"",alt:this.model.get("type"),title:this.model.get("type")});t.inject(s.elements.thumbnail);s.elements.thumbnailImg=t;var r=i.createElement("span",{"class":"fonticon "+j.CSS.ELEMENTS.PRIMARYICON,title:l.views.Attachment.isPrimary});r.inject(s.container);var p=i.createElement("img",{src:this.model.get("iconUrl")||"",alt:"",title:""});p.inject(s.elements.icon);s.elements.iconImg=p;s.elements.title.innerHTML=this.model.get("title");s.elements.title.title=this.model.get("title");if(this.model.get("relOriginated") instanceof Date){if(!isNaN(this.model.get("relOriginated"))){var u=this.model.get("relOriginated").toLocaleString();s.elements.date.innerHTML=u;s.elements.date.title=l.replace(l.views.Attachment.relDateTooltip,{date:u})}else{s.elements.date.innerHTML=l.views.Attachment.Unknown;s.elements.date.title=l.views.Attachment.Unknown}}var o=l.replace(l.views.Attachment.relOwnerTooltip,{name:this.model.get("relOwner").fullName+" ("+this.model.get("relOwner").user+")"});var n=c.getUserImage(this.model.get("relOwner").user);var q=i.createElement("img",{src:n,alt:o,title:o});this.listeners.relOwnerImgOnClick=q.addEventListener("click",this._onRelOwnerIconClick.bind(this));var v=i.createElement("div",{html:this.model.get("relOwner").fullName,title:this.model.get("relOwner").fullName});s.elements.relOwnerImg=q;q.inject(s.elements.relOwner);s.elements.relOwnerText=v;v.inject(s.elements.relOwner);s.elements.cancelBtn=new k({value:l.views.Attachment.cancelButton,className:j.CSS.ELEMENTS.CANCELBUTTON});s.elements.cancelBtn.addEvent("onClick",function(){if(s.model.get("request")){var w=s.model.get("request");if(i.is(w.cancel,"function")){w.cancel();s.model.set("isFailed",true);s.model.set("isProcessing",false)}}});s.elements.cancelBtn.inject(this.container);s.elements.discardBtn=new k({value:l.views.Attachment.discardButton,className:j.CSS.ELEMENTS.DISCARDBUTTON});s.elements.discardBtn.addEvent("onClick",function(){if(s.model.collection){s.model.collection.unselectAll();s.model.collection.remove(s.model)}});s.elements.discardBtn.inject(this.container);d.end(this.name+" render");return this},_onSelect:function(){this.container.addClassName("selected")},_onUnselect:function(){this.container.removeClassName("selected")},_onChangeThumbnailUrl:function(m){this.elements.thumbnailImg.src=m.get("thumbnailUrl")},_onChangeContentUrl:function(m){if(m.get("documentType")==="image"){this.elements.thumbnailImg.src=m.get("contentUrl")}},_onChangeIconUrl:function(m){this.elements.iconImg.src=m.get("iconUrl")},_onChangeTitle:function(m){this.elements.title.innerHTML=m.get("title");this.elements.title.title=m.get("title")},_onChangeIsProcessing:function(n){if(n.get("isProcessing")===true){this.container.addClassName(j.CSS.STATUS.PROCESSING);h.mask(this.container)}else{if(n.get("contentUrl")!==undefined&&n.get("contentUrl")!==null){this.elements.thumbnailImg.src=n.get("contentUrl")}else{if(n.get("thumbnailUrl")!==undefined&&n.get("thumbnailUrl")!==null){this.elements.thumbnailImg.src=n.get("thumbnailUrl")}}if(n.get("iconUrl")!==undefined&&n.get("iconUrl")!==null){this.elements.iconImg.src=n.get("iconUrl")}this.elements.title.innerHTML=this.model.get("title");this.elements.title.title=this.model.get("title");if(this.model.get("relOriginated") instanceof Date){if(!isNaN(this.model.get("relOriginated"))){var o=this.model.get("relOriginated").toLocaleString();this.elements.date.innerHTML=o;this.elements.date.title=o}else{this.elements.date.innerHTML=l.views.Attachment.Unknown;this.elements.date.title=l.views.Attachment.Unknown}}var m=l.replace(l.views.Attachment.relOwnerTooltip,{name:this.model.get("relOwner").fullName+" ("+this.model.get("relOwner").user+")"});var p=c.getUserImage(this.model.get("relOwner").user);this.elements.relOwnerImg.src=p;this.elements.relOwnerImg.alt=m;this.elements.relOwnerImg.title=m;this.elements.relOwnerText.innerHTML=this.model.get("relOwner").fullName;this.elements.relOwnerText.title=this.model.get("relOwner").fullName;if(this.listeners.relOwnerImgOnClick){this.elements.relOwnerImg.removeEventListener("click",this.listeners.relOwnerImgOnClick)}this.listeners.relOwnerImgOnClick=this.elements.relOwnerImg.addEventListener("click",this._onRelOwnerIconClick.bind(this));this.container.id=n.get("id");this.container.setAttribute("id","attachment-"+n.get("id"));this.container.setData("id",n.get("id"));this.container.removeClassName(j.CSS.STATUS.PROCESSING);this.container.removeClassName(j.CSS.STATUS.CANCELABLE);h.unmask(this.container)}},_onChangeIsCancelable:function(m){if(m.get("isCancelable")===true){if(m.get("isProcessing")===true){this.container.addClassName(j.CSS.STATUS.CANCELABLE)}}else{this.container.removeClassName(j.CSS.STATUS.CANCELABLE)}},_onChangeIsFailed:function(m){if(m.get("isFailed")===true){this.container.addClassName(j.CSS.STATUS.FAILED);i.createElement("span",{"class":"fonticon "+j.CSS.ELEMENTS.ERRORICON}).inject(this.elements.error);i.createElement("span",{html:l.views.Attachment.Failures.Upload,"class":j.CSS.ELEMENTS.ERRORTEXT}).inject(this.elements.error)}else{this.container.removeClassName(j.CSS.STATUS.FAILED)}},_onChangeIsPrimary:function(m){if(m.get("isPrimary")===true){this.container.addClassName(j.CSS.STATUS.PRIMARY)}else{this.container.removeClassName(j.CSS.STATUS.PRIMARY)}},_onChangeRequestProgress:function(m){if(m.get("isProcessing")&&h.isMasked(this.container)){var n=this.container.getElement(".mask").getElement("span.text");if(n){n.innerHTML=Math.floor(m.get("requestProgress")*100)+"%"}}},_onRelOwnerIconClick:function(){c.getUserProfile(this.model.get("relOwner").user)}});return g});define("DS/IssueAttachmentManager/components/ContextualMenu",["UWA/Controls/Abstract","UWA/Class/Listener","UWA/Class/Promise","UWA/Core","DS/Menu/ContextualMenu","DS/Menu/Menu","DS/IssueAttachmentManager/components/Collection","DS/IssueAttachmentManager/services/AttachmentServices","i18n!DS/IssueAttachmentManager/assets/nls/IssueAttachmentManager"],function(f,j,h,c,a,b,d,g,i){var e=f.extend(j,{name:"DS/IssueAttachmentManager/components/ContextualMenu",defaultOptions:{authoring:true},init:function(k){if(!k.hasOwnProperty("collection")||c.is(k.collection,null)||!(k.collection instanceof d)){throw new Error(i.replace(i.error.common.incorrectInitArgument,{className:"ContextualMenu",property:"collection",type:"DS/IssueAttachmentManager/components/Collection"}))}if(k.hasOwnProperty("authoring")){if(!c.is(k.authoring,"boolean")){throw new Error(i.replace(i.error.common.incorrectInitArgument,{className:"ContextualMenu",property:"authoring",type:"Boolean"}))}}this._parent(k);this.authoring=this.options.authoring;this.collection=k.collection;this.customCommands=[]},register:function(k){var l=this;a.addEventListener(k,{callback:function(){return l.getCommands()}})},hide:function(){b.hide()},getCommands:function(){var n=this;var k=[];var m=n.collection.getSelectedItems();var l=m.some(function(p){return p.get("isProcessing")||p.get("isFailed")});var o=new h(function(p){if(m.length===0||l){k.push({name:"groupByType",title:i.views.Header.Iconbar.actions.sort.groupByType,type:"RadioItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-media-gallery"},data:null,state:n.collection.groupByType?"selected":"unselected",action:{callback:function(){n.dispatchEvent("request:groupByType")}}});k.push({name:"sort",title:i.views.Header.Iconbar.actions.sort.dropdown,type:"PushItem",data:null,fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-sorting"},submenu:[{name:"sortAscDate",title:i.views.Header.Iconbar.actions.sort.ascDate,type:"RadioItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-sort-num-asc"},data:null,state:(n.collection.sortOrder==="ascending"&&n.collection.sortMode==="date")?"selected":"unselected",action:{callback:function(){n.dispatchEvent("request:sort",{sortOrder:"ascending",sortMode:"date"})}}},{name:"sortDescDate",title:i.views.Header.Iconbar.actions.sort.descDate,type:"RadioItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-sort-num-desc"},state:(n.collection.sortOrder==="descending"&&n.collection.sortMode==="date")?"selected":"unselected",data:null,action:{callback:function(){n.dispatchEvent("request:sort",{sortOrder:"descending",sortMode:"date"})}}},{name:"sortAscTitle",title:i.views.Header.Iconbar.actions.sort.ascTitle,type:"RadioItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-sort-alpha-asc"},data:null,state:(n.collection.sortOrder==="ascending"&&n.collection.sortMode==="title")?"selected":"unselected",action:{callback:function(){n.dispatchEvent("request:sort",{sortOrder:"ascending",sortMode:"title"})}}},{name:"sortDescTitle",title:i.views.Header.Iconbar.actions.sort.descTitle,type:"RadioItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-sort-alpha-desc"},state:(n.collection.sortOrder==="descending"&&n.collection.sortMode==="title")?"selected":"unselected",data:null,action:{callback:function(){n.dispatchEvent("request:sort",{sortOrder:"descending",sortMode:"title"})}}}]});k.push({name:"switchCatalogLayout",title:i.views.Header.Iconbar.actions.switchCatalogLayout,type:"RadioItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x "+((n.catalogLayout+1)%2===1?"fonticon-view-small-thb":"fonticon-view-list")},data:null,action:{callback:function(){n.dispatchEvent("request:catalogSwitchLayout")}}});k.push({type:"SeparatorItem"})}p()});o=o.then(function(){if(m.length>0){if(!l){return g.getCompatibleApps(m).then(function(q){var p=[];if(c.is(q,"array")&&q.length>0){p=q.map(function(t){var s={name:t.name,type:"PushItem",title:t.text,fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-"+t.fonticon},action:{callback:function(){n.dispatchEvent("request:openWith",{app:t,objects:m,arguments:arguments,context:this,})}}};return s})}else{p=[{name:"openWithNoApps",type:"PushItem",title:i.views.Header.Iconbar.actions.openWithNoApps,}]}k.push({name:"openWith",type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-export"},title:i.views.Header.Iconbar.actions.openWith,submenu:p});var r=m.every(function(s){return s.get("type")==="Document"});if(r){k.push({name:"download",title:i.views.Header.Iconbar.actions.download,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-download"},data:null,action:{callback:function(){n.dispatchEvent("request:downloadFile")}}});if(n.authoring&&m.length===1&&m[0].get("documentType")==="image"){k.push({name:"annotate",title:i.views.Header.Iconbar.actions.annotate,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-highlighter"},data:null,action:{callback:function(){n.dispatchEvent("request:annotate")}}})}if(n.authoring&&m.length===1&&m[0].get("documentType")==="image"){k.push({name:"setAsPrimary",title:i.views.Header.Iconbar.actions.setAsPrimary,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-star"},data:null,action:{callback:function(){n.dispatchEvent("request:setAsPrimary",{item:m[0],lock:true})}}})}}if(n.authoring){k.push({type:"SeparatorItem"});k.push({name:"detachDelete",title:i.views.Header.Iconbar.actions.detachDelete.title,type:"PushItem",data:null,fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-doc-delete"},submenu:[{name:"detach",title:i.views.Header.Iconbar.actions.detachDelete.detach,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-flow-branch-delete"},data:null,action:{callback:function(){n.dispatchEvent("request:detach")}}},{name:"delete",title:i.views.Header.Iconbar.actions.detachDelete["delete"],type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-trash"},data:null,action:{callback:function(){n.dispatchEvent("request:delete")}}}]})}})}else{return h.resolve()}}else{if(n.authoring){k.push({name:"annotate",title:i.views.Header.Iconbar.actions.annotate,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-highlighter"},data:null,action:{callback:function(){n.dispatchEvent("request:annotate")}}});k.push({type:"SeparatorItem"})}return h.resolve()}});o=o.then(function(){if(n.authoring&&m.length===0||l){k.push({name:"attach",title:i.views.Header.Iconbar.actions.attach.title,type:"PushItem",data:null,fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-doc-add"},submenu:[{name:"attachFrom3DX",title:i.views.Header.Iconbar.actions.attach.title+" "+i.views.Header.Iconbar.actions.attach.from3DX,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-flow-branch-add"},data:null,action:{callback:function(){n.dispatchEvent("request:attachFrom3DX")}}},{name:"attachFromLocalDisk",title:i.views.Header.Iconbar.actions.attach.title+" "+i.views.Header.Iconbar.actions.attach.fromLocalDisk,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-upload"},data:null,action:{callback:function(){n.dispatchEvent("request:attachFromLocalDisk")}}}]})}});o=o.then(function(){if((m.length===0||l)&&n.customCommands.length>0){k.push({type:"SeparatorItem"});n.customCommands.forEach(function(p){k.push(p)})}return k});return o},});return e});define("DS/IssueAttachmentManager/views/Header",["UWA/Class/View","UWA/Core","DS/Logger/Logger","DS/UIKIT/Iconbar","DS/UIKIT/Mask","DS/ENO6WPlugins/jQuery","DS/PlatformAPI/PlatformAPI","DS/PADUtils/views/PADAlert","DS/IssueServices/Contexts","DS/IssueServices/services/PlatformServices","DS/IssueServices/utils/Performance","DS/IssueAttachmentManager/components/Collection","DS/IssueAttachmentManager/components/Item","DS/IssueAttachmentManager/services/AttachmentServices","DS/IssueAttachmentManager/views/Attachment","css!DS/IssueAttachmentManager/IssueAttachmentManager.css","i18n!DS/IssueAttachmentManager/assets/nls/IssueAttachmentManager"],function(n,f,q,a,s,i,c,o,g,h,d,r,b,j,p,l,e){var k={CSS:{ELEMENTS:{INFO:"isu-am-header-info",INFO_REL_OWNER_CONTAINER:"isu-am-header-info-rel-owner-ctn",INFO_REL_OWNER_ICON:"isu-am-header-info-rel-owner-icon",INFO_REL_OWNER_TEXT:"isu-am-header-info-rel-owner-txt",INFO_DATE_CONTAINER:"isu-am-header-info-date-ctn",INFO_DATE_ICON:"fonticon-calendar isu-am-header-info-date-icon",INFO_DATE_TEXT:"isu-am-header-info-date-txt",INFO_MULTI_CONTAINER:"isu-am-header-info-multi-ctn",INFO_MULTI_ICON:"fonticon-docs isu-am-header-info-multi-icon",INFO_MULTI_TEXT:"isu-am-header-info-multi-txt",ICONBAR_CTN:"isu-am-header-iconbar-ctn",ICONBAR_TOGGLE_ACTIVE:"active",ANNOTATION:"isu-am-annotation"},STATUS:{EMPTY:"is-empty",MULTI:"is-multi"}}};var m=n.extend({name:"DS/IssueAttachmentManager/views/Header",tagName:"div",className:"isu-am-header",_logger:null,defaultOptions:{authoring:true,annotationPreLaunchCallback:function(){},annotationSaveCallback:function(){},annotationExitCallback:function(){}},init:function(t){if(!t.hasOwnProperty("collection")||f.is(t.collection,null)||!(t.collection instanceof r)){throw new Error(e.replace(e.error.common.incorrectInitArgument,{className:"Header",property:"collection",type:"DS/IssueAttachmentManager/components/Collection"}))}if(t.hasOwnProperty("authoring")){if(!f.is(t.authoring,"boolean")){throw new Error(e.replace(e.error.common.incorrectInitArgument,{className:"Header",property:"authoring",type:"Boolean"}))}}if(t.hasOwnProperty("annotationSaveCallback")){if(!f.is(t.annotationSaveCallback,"function")){throw new Error(e.replace(e.error.common.incorrectInitArgument,{className:"Header",property:"annotationSaveCallback",type:"Function"}))}}if(t.hasOwnProperty("annotationPreLaunchCallback")){if(!f.is(t.annotationPreLaunchCallback,"function")){throw new Error(e.replace(e.error.common.incorrectInitArgument,{className:"Header",property:"annotationPreLaunchCallback",type:"Function"}))}}if(t.hasOwnProperty("annotationExitCallback")){if(!f.is(t.annotationExitCallback,"function")){throw new Error(e.replace(e.error.common.incorrectInitArgument,{className:"Header",property:"annotationExitCallback",type:"Function"}))}}this._parent(t)},setup:function(t){var u=this;d.start(u.name+" setup");u._parent(t);u._logger=q.getLogger(u.name);u.authoring=u.options.authoring;u.current=null;u.annotation=null;u.listeners={};this.listenTo(this.collection,"onSelect",this._onCollectionSelect.bind(this));this.listenTo(this.collection,"onUnselect",this._onCollectionUnselect.bind(this));d.end(u.name+" setup")},render:function(){var u=this;d.start(this.name+" render");this.container.addClassName(k.CSS.STATUS.EMPTY);u.elements.info=f.createElement("div",{"class":k.CSS.ELEMENTS.INFO});u.elements.infoRelOwnerCtn=f.createElement("div",{"class":k.CSS.ELEMENTS.INFO_REL_OWNER_CONTAINER}).inject(u.elements.info);u.elements.infoRelOwnerIcon=f.createElement("img",{"class":k.CSS.ELEMENTS.INFO_REL_OWNER_ICON});u.elements.infoRelOwnerIcon.inject(u.elements.infoRelOwnerCtn);u.elements.infoRelOwnerTxt=f.createElement("div",{"class":k.CSS.ELEMENTS.INFO_REL_OWNER_TEXT}).inject(u.elements.infoRelOwnerCtn);u.elements.info.inject(u.container);u.elements.infoDateCtn=f.createElement("div",{"class":k.CSS.ELEMENTS.INFO_DATE_CONTAINER}).inject(u.elements.info);u.elements.infoDateIcon=f.createElement("span",{"class":"fonticon fonticon-2x "+k.CSS.ELEMENTS.INFO_DATE_ICON}).inject(u.elements.infoDateCtn);u.elements.infoDateIcon.inject(u.elements.infoDateCtn);u.elements.infoDateTxt=f.createElement("div",{"class":k.CSS.ELEMENTS.INFO_DATE_TEXT}).inject(u.elements.infoDateCtn);u.elements.info.inject(u.container);u.elements.infoMultiCtn=f.createElement("div",{"class":k.CSS.ELEMENTS.INFO_MULTI_CONTAINER}).inject(u.elements.info);u.elements.infoMultiIcon=f.createElement("span",{"class":"fonticon fonticon-2x "+k.CSS.ELEMENTS.INFO_MULTI_ICON}).inject(u.elements.infoMultiCtn);u.elements.infoMultiIcon.inject(u.elements.infoMultiCtn);u.elements.infoMultiTxt=f.createElement("div",{"class":k.CSS.ELEMENTS.INFO_MULTI_TEXT}).inject(u.elements.infoMultiCtn);u.elements.info.inject(u.container);u.elements.iconBarCtn=f.createElement("div",{"class":k.CSS.ELEMENTS.ICONBAR_CTN});var t=[{name:"openWith",fonticon:"export",text:e.views.Header.Iconbar.actions.openWith,content:{type:"dropdownmenu",options:{items:[{id:"openWithNoApps",text:e.views.Header.Iconbar.actions.openWithNoApps,selectable:false,}],events:{onShow:function(){var w=this;u._setOpenWithSubMenus(w,u.collection.getSelectedItems())}}}}},{id:"download",fonticon:"download",text:e.views.Header.Iconbar.actions.download,selectable:true,handler:function(){u.dispatchEvent("request:downloadFile")}}];var v=[{className:"divider"},{id:"groupByType",type:"checkbox",fonticon:"media-gallery",className:u.collection.groupByType?k.CSS.ELEMENTS.ICONBAR_TOGGLE_ACTIVE:"",text:e.views.Header.Iconbar.actions.sort.groupByType,selectable:true,handler:function(){u.dispatchEvent("request:groupByType")}},{id:"sort",fonticon:"sorting",text:e.views.Header.Iconbar.actions.sort.dropdown,selectable:true,content:{type:"icondropdown",options:{items:[{id:"sortAscDate",fonticon:"sort-num-asc",description:e.views.Header.Iconbar.actions.sort.ascDate,selected:u.collection.sortOrder==="ascending"&&u.collection.sortMode==="date",handler:function(){u.dispatchEvent("request:sort",{sortOrder:"ascending",sortMode:"date"})}},{id:"sortDescDate",fonticon:"sort-num-desc",description:e.views.Header.Iconbar.actions.sort.descDate,selected:u.collection.sortOrder==="descending"&&u.collection.sortMode==="date",handler:function(){u.dispatchEvent("request:sort",{sortOrder:"descending",sortMode:"date"})}},{id:"sortAscTitle",fonticon:"sort-alpha-asc",description:e.views.Header.Iconbar.actions.sort.ascTitle,selected:u.collection.sortOrder==="ascending"&&u.collection.sortMode==="title",handler:function(){u.dispatchEvent("request:sort",{sortOrder:"ascending",sortMode:"title"})}},{id:"sortDescTitle",fonticon:"sort-alpha-desc",description:e.views.Header.Iconbar.actions.sort.descTitle,selected:u.collection.sortOrder==="descending"&&u.collection.sortMode==="title",handler:function(){u.dispatchEvent("request:sort",{sortOrder:"descending",sortMode:"title"})}}]}}},{id:"switchCatalogLayout",type:"checkbox",fonticon:"view-list",text:e.views.Header.Iconbar.actions.switchCatalogLayout,selectable:true,handler:function(){u.dispatchEvent("request:catalogSwitchLayout")}}];if(u.authoring){t.unshift({className:"divider"});t.unshift({id:"attach",fonticon:"plus",text:e.views.Header.Iconbar.actions.attach.title,content:{type:"dropdownmenu",options:{items:[{id:"attachFrom3DX",text:e.views.Header.Iconbar.actions.attach.from3DX,fonticon:"list-add",selectable:false,handler:function(){u.dispatchEvent("request:attachFrom3DX")}},{id:"attachFromLocalDisk",fonticon:"upload",text:e.views.Header.Iconbar.actions.attach.fromLocalDisk,selectable:false,handler:function(){u.dispatchEvent("request:attachFromLocalDisk")}}]}}});t.push({id:"annotate",fonticon:"highlighter",text:e.views.Header.Iconbar.actions.annotate,selectable:true,handler:function(){u.dispatchEvent("request:annotate")}});t.push({id:"setAsPrimary",fonticon:"star",text:e.views.Header.Iconbar.actions.setAsPrimary,selectable:true,handler:function(){u.dispatchEvent("request:setAsPrimary",{item:u.current,lock:true})}});t.push({id:"detachDelete",fonticon:"trash",text:e.views.Header.Iconbar.actions.detachDelete.title,content:{type:"dropdownmenu",options:{items:[{id:"detach",fonticon:"list-delete",text:e.views.Header.Iconbar.actions.detachDelete.detach,selectable:false,handler:function(){u.dispatchEvent("request:detach")}},{id:"delete",fonticon:"database-delete",text:e.views.Header.Iconbar.actions.detachDelete["delete"],selectable:false,handler:function(){u.dispatchEvent("request:delete")}}]}}})}u.iconBar=new a({renderTo:u.elements.iconBarCtn,items:t.concat(v)});u.elements.iconBarCtn.inject(u.container);u.listenTo(u.iconBar.overflowMenu,"onShow",function(){u.iconBar.overflowMenu.menus.forEach(function(w){if(w.parentItem&&w.parentItem.name==="openWith"){u._setOpenWithSubMenus(w,u.collection.getSelectedItems())}})});u.refresh();d.end(this.name+" render");return this},refresh:function(){var x=this;this.iconBar.enableItem("openWith");this.iconBar.enableItem("download");this.iconBar.enableItem("detachDelete");this.iconBar.enableItem("annotate");this.iconBar.enableItem("setAsPrimary");var w=this.collection.getSelectedItems();if(w.length===1){this.current=w[0];this.container.removeClassName(k.CSS.STATUS.EMPTY);this.container.removeClassName(k.CSS.STATUS.MULTI);var v=e.replace(e.views.Attachment.relOwnerTooltip,{name:this.current.get("relOwner").fullName+" ("+this.current.get("relOwner").user+")"});this.elements.infoRelOwnerIcon.src=h.getUserImage(this.current.get("relOwner").user);this.elements.infoRelOwnerIcon.alt=v;this.elements.infoRelOwnerIcon.title=v;this.elements.infoRelOwnerTxt.innerHTML=this.current.get("relOwner").fullName;this.elements.infoRelOwnerTxt.relOwner=this.current.get("relOwner").fullName;this.elements.infoRelOwnerTxt.title=v;if(this.listeners.infoRelOwnerIconOnClick){this.elements.infoRelOwnerIcon.removeEventListener("click",this.listeners.infoRelOwnerIconOnClick)}this.listeners.infoRelOwnerIconOnClick=this.elements.infoRelOwnerIcon.addEventListener("click",function(){h.getUserProfile(x.current.get("relOwner").user)});if(this.current.get("relOriginated") instanceof Date){if(!isNaN(this.current.get("relOriginated"))){var z=this.current.get("relOriginated");z=z.toLocaleString(g.get("widget").lang);this.elements.infoDateTxt.innerHTML=z;this.elements.infoDateIcon.title=e.replace(e.views.Attachment.relDateTooltip,{date:z});this.elements.infoDateTxt.title=e.replace(e.views.Attachment.relDateTooltip,{date:z})}else{this.elements.infoDateTxt.innerHTML=e.views.Attachment.Unknown;this.elements.infoDateTxt.title=e.views.Attachment.Unknown}}if(this.current.get("type")!=="Document"){this.iconBar.disableItem("download")}if(this.current.get("type")!=="Document"||this.current.get("documentType")!=="image"){this.iconBar.disableItem("annotate");this.iconBar.disableItem("setAsPrimary")}if(this.current.get("isProcessing")===true||this.current.get("isFailed")===true){this.iconBar.disableItem("openWith");this.iconBar.disableItem("download");this.iconBar.disableItem("detachDelete");this.iconBar.disableItem("annotate");this.iconBar.disableItem("setAsPrimary")}}else{if(w.length>1){this.current=null;this.container.removeClassName(k.CSS.STATUS.EMPTY);this.container.addClassName(k.CSS.STATUS.MULTI);var u=e.replace(e.views.Header.Info.Multi.title,{count:w.length});this.elements.infoMultiTxt.innerHTML=u;this.elements.infoMultiTxt.title=u;var y=w.every(function(A){return A.get("type")==="Document"});if(!y){this.iconBar.disableItem("download")}var t=w.some(function(A){return A.get("isProcessing")===true||A.get("isFailed")===true});if(t){this.iconBar.disableItem("openWith");this.iconBar.disableItem("download");this.iconBar.disableItem("detachDelete")}this.iconBar.disableItem("annotate");this.iconBar.disableItem("setAsPrimary")}else{this.current=null;this.container.addClassName(k.CSS.STATUS.EMPTY);this.container.removeClassName(k.CSS.STATUS.MULTI);this.iconBar.disableItem("openWith");this.iconBar.disableItem("download");this.iconBar.disableItem("detachDelete");this.iconBar.disableItem("setAsPrimary");this.iconBar.disableItem("detachDelete")}}this.iconBar.resize()},_setOpenWithSubMenus:function(w,v){var u=this;var t=w.items.reduce(function(y,x){y.push(x.id);return y},[]);t.forEach(function(x){w.removeItem(x)});if(Array.isArray(w.menus)){w.menus.length=1}j.getCompatibleApps(v).then(function(y){if(f.is(y,"array")&&y.length>0){var x=y.map(function(A){var z={id:A.name,fonticon:A.fonticon,text:A.text,selectable:false,handler:function(){u.dispatchEvent("request:openWith",{app:A,objects:v,arguments:arguments,context:this})}};return z});x.forEach(function(z){w.addItem(z)})}else{w.addItem({id:"openWithNoApps",text:e.views.Header.Iconbar.actions.openWithNoApps,selectable:false})}})},_onCollectionSelect:function(t){if(!t.hasOwnProperty("ids")||f.is(t.ids,null)||!f.is(t.ids,"array")){var u=e.replace(e.error.common.incorrectArgument,{arg:0,type:"Array"});this._logger.error(u);return}if(t.ids.length>1||this.collection.getSelectedItems().length>1){}else{}this.refresh()},_onCollectionUnselect:function(t){if(!t.hasOwnProperty("ids")||f.is(t.ids,null)||!f.is(t.ids,"array")){var u=e.replace(e.error.common.incorrectArgument,{arg:0,type:"Array"});this._logger.error(u);return}this.refresh()}});return m});define("DS/IssueAttachmentManager/views/Catalog",["UWA/Class/View","UWA/Core","DS/Logger/Logger","DS/UIKIT/Input/Button","DS/UIKIT/Scroller","DS/IssueComponents/utils/Utils","DS/IssueServices/utils/Performance","DS/IssueAttachmentManager/components/Collection","DS/IssueAttachmentManager/components/ContextualMenu","DS/IssueAttachmentManager/components/Item","DS/IssueAttachmentManager/views/Attachment","css!DS/IssueAttachmentManager/IssueAttachmentManager.css","i18n!DS/IssueAttachmentManager/assets/nls/IssueAttachmentManager"],function(b,i,d,m,f,n,c,j,l,g,h,a,o){var k={CSS:{LAYOUTS:{1:"isu-am-catalog-grid",2:"isu-am-catalog-list"},ELEMENTS:{PLACEHOLDER:"isu-am-catalog-placeholder",PLACEHOLDERTEXT:"isu-am-catalog-placeholdertext",PLACEHOLDERBUTTONS:"isu-am-catalog-placeholder-buttons",PLACEHOLDERBUTTON:"isu-am-catalog-placeholder-button",SCROLLCONTENT:"isu-am-catalog-scroll-content",SCROLLCONTAINER:"isu-am-catalog-scroll-container"},CATALOG:{PADDINGRIGHT:5,PADDINGLEFT:5},ATTACHMENT:{CLASSNAME:"isu-am-attachment",WIDTH:150,MARGINRIGHT:10,MARGINLEFT:0},STATUS:{EMPTY:"is-empty"}}};var e=b.extend({name:"DS/IssueAttachmentManager/views/Catalog",tagName:"div",className:"isu-am-catalog",_logger:null,defaults:{layout:1},defaultOptions:{authoring:true},init:function(p){if(!p.hasOwnProperty("collection")||i.is(p.collection,null)||!(p.collection instanceof j)){throw new Error(o.replace(o.error.common.incorrectInitArgument,{className:"Catalog",property:"collection",type:"DS/IssueAttachmentManager/components/Collection"}))}if(p.hasOwnProperty("authoring")){if(!i.is(p.authoring,"boolean")){throw new Error(o.replace(o.error.common.incorrectInitArgument,{className:"Catalog",property:"authoring",type:"Boolean"}))}}if(p.hasOwnProperty("contextualMenu")){if(i.is(p.contextualMenu,null)||!(p.contextualMenu instanceof l)){throw new Error(o.replace(o.error.common.incorrectInitArgument,{className:"Catalog",property:"contextualMenu",type:"DS/IssueAttachmentManager/components/ContextualMenu"}))}}if(p.hasOwnProperty("layout")){if(!i.is(p.layout,"number")){throw new Error(o.replace(o.error.common.incorrectInitArgument,{className:"Catalog",property:"layout",type:"Number"}))}else{if(!k.CSS.LAYOUTS.hasOwnProperty(p.layout)){throw new Error(o.replace(o.error.views.Catalog.unsupportedLayout,{layout:p.layout}))}}}this._parent(p)},setup:function(p){var q=this;c.start(q.name+" setup");q._parent(p);q._logger=d.getLogger(q.name);this.contextualMenu=p.contextualMenu;this.layout=i.is(p.layout)?p.layout:this.defaults.layout;this.authoring=this.options.authoring;this.listenTo(this.collection,"onSelect",this._onCollectionSelect.bind(this));this.listenTo(this.collection,"onUnselect",this._onCollectionUnselect.bind(this));this.listenTo(this.collection,"onSort",this._onCollectionSort.bind(this));this.listenTo(this.collection,"onAdd",this._onCollectionAdd.bind(this));this.listenTo(this.collection,"onRemove",this._onCollectionRemove.bind(this));this.listenTo(this.collection,"onReset",this._onCollectionReset.bind(this));c.end(q.name+" setup")},render:function(){var u=this;c.start(this.name+" render");this.container.addClassName(k.CSS.LAYOUTS[this.layout]);if(u.collection.size()===0){this.container.addClassName(k.CSS.STATUS.EMPTY)}u.elements.placeholder=i.createElement("div",{"class":k.CSS.ELEMENTS.PLACEHOLDER});u.elements.placeholder.inject(u.container);var w=i.createElement("div",{"class":k.CSS.ELEMENTS.PLACEHOLDERTEXT,html:u.authoring?o.views.Placeholder.text:o.views.Placeholder.textNoAuthoring,title:u.authoring?o.views.Placeholder.text:o.views.Placeholder.textNoAuthoring,});w.inject(u.elements.placeholder);var t=i.createElement("div",{"class":k.CSS.ELEMENTS.PLACEHOLDERBUTTONS});t.inject(u.elements.placeholder);if(u.authoring){var v=new m({className:k.CSS.ELEMENTS.PLACEHOLDERBUTTON+" primary",value:o.views.Placeholder.addExisting,events:{onClick:function(){u.dispatchEvent("request:attachFrom3DX")}}});v.inject(t);var x=new m({className:k.CSS.ELEMENTS.PLACEHOLDERBUTTON+" default",value:o.views.Placeholder.upload,events:{onClick:function(){u.dispatchEvent("request:attachFromLocalDisk")}}});x.inject(t)}this.elements.scrollContent=i.createElement("div",{"class":k.CSS.ELEMENTS.SCROLLCONTENT}).inject(this.container);this.elements.scrollContainer=i.createElement("div",{"class":k.CSS.ELEMENTS.SCROLLCONTAINER}).inject(u.container);this.attachments={};for(var q=0;q<this.collection.size();q++){var s=this.collection.at(q);var r=new h({model:s,domEvents:{click:this._onAttachmentClick.bind(this),contextmenu:this._onAttachmentClick.bind(this),dragstart:this._onAttachmentDrag.bind(this)}});this.attachments[s.id]=r;r.container.style.order=q;r.container.setAttribute("draggable",true);r.render().inject(this.elements.scrollContent)}u._scroller=new f({element:this.elements.scrollContent}).inject(this.elements.scrollContainer);var p=function(A){var z=A.target.getParents();var y=z.some(function(B){return B.hasOwnProperty("hasClassName")&&B.hasClassName(k.CSS.ATTACHMENT.CLASSNAME)});if(!y){u.collection.unselectAll()}};u.container.addEventListener("click",p);u.container.addEventListener("contextmenu",p);if(this.contextualMenu instanceof l){this.contextualMenu.register(this.container)}c.end(this.name+" render");return this},switchLayout:function(p){if(!i.is(p,"number")){throw new Error(o.replace(o.error.common.incorrectArgument,{arg:0,type:"Number"}))}else{if(!k.CSS.LAYOUTS.hasOwnProperty(p)){throw new Error(o.replace(o.error.views.Catalog.unsupportedLayout,{layout:p}))}}this.container.removeClassName(k.CSS.LAYOUTS[this.layout]);this.container.addClassName(k.CSS.LAYOUTS[p]);this.layout=p;this.dispatchEvent("onSwitchLayout",{layout:this.layout});return this},goToNext:function(t){var r=this;if(this.collection.size()){var s=-1;if(this.currentPos!==null&&this.currentPos!==undefined){s=this.collection.indexOf(this.currentPos)}if(s<this.collection.size()-1){var q=1;var p=(s>=0)?this.collection.size()-s:2;while(q<p){var u=this.attachments[this.collection.at(s+q).id];if(u.model.get("isProcessing")){q++}else{if(t){if(u.model.selected){if(r.currentPos!==undefined&&r.currentPos.selected){r.currentPos.unselect()}}}this._goTo(u,t);r.currentPos=u.model;q=this.collection.size()}}}}return this},goToPrevious:function(s){var q=this;if(this.collection.size()){var r=1;if(this.currentPos!==null&&this.currentPos!==undefined){r=this.collection.indexOf(this.currentPos)}if(r>0){var p=1;while(p<r+1){var t=this.attachments[this.collection.at(r-1).id];if(t.model.get("isProcessing")){p++}else{if(s){if(t.model.selected){if(q.currentPos!==undefined&&q.currentPos.selected){q.currentPos.unselect()}}}this._goTo(t,s);q.currentPos=t.model;p=r+1}}}}return this},goToNextLine:function(u){var v=this;if(this.layout===2){this.goToNext(u);return}if(this.collection.size()){var q=this.container.clientWidth;var y=k.CSS.CATALOG.PADDINGRIGHT+k.CSS.CATALOG.PADDINGLEFT;var t=k.CSS.ATTACHMENT.WIDTH;var r=k.CSS.ATTACHMENT.MARGINRIGHT+k.CSS.ATTACHMENT.MARGINLEFT;var p=Math.floor((q-y)/(t+r));var w=-p;if(this.currentPos!==null&&this.currentPos!==undefined){w=this.collection.indexOf(this.currentPos)}else{this.currentPos=this.collection.at(0)}if(w<this.collection.size()-p){var s=this.attachments[this.collection.at(w+p).id];var x=this.attachments[this.currentPos.id];this._goTo(s,u,x,true);if(u){x.shiftKeySelected=true}v.currentPos=s.model}}},goToPreviousLine:function(u){var v=this;if(this.layout===2){this.goToPrevious(u);return}if(this.collection.size()){var q=this.container.clientWidth;var y=k.CSS.CATALOG.PADDINGRIGHT+k.CSS.CATALOG.PADDINGLEFT;var t=k.CSS.ATTACHMENT.WIDTH;var r=k.CSS.ATTACHMENT.MARGINRIGHT+k.CSS.ATTACHMENT.MARGINLEFT;var p=Math.floor((q-y)/(t+r));var w=+p;if(this.currentPos!==null&&this.currentPos!==undefined){w=this.collection.indexOf(this.currentPos)}else{this.currentPos=this.collection.at(0)}if(w>=p){var s=this.attachments[this.collection.at(w-p).id];var x=this.attachments[this.currentPos.id];this._goTo(s,u,x,true);if(u){x.shiftKeySelected=true}v.currentPos=s.model}}},_goTo:function(v,y,B,t){var z=this;if(y&&B){var A=this.collection.getSelectedItems().map(function(D){if(z.attachments.hasOwnProperty(D.id)){return z.attachments[D.id]}else{return undefined}});if(A.length>0){if(A.length===1&&A[0]===v){v.model.select()}else{var p=[];var s=Math.min(v.container.style.order,B.container.style.order);var u=Math.max(v.container.style.order,B.container.style.order);for(var q in z.attachments){if(z.attachments.hasOwnProperty(q)){if(s<=z.attachments[q].container.style.order&&z.attachments[q].container.style.order<=u&&z.attachments[q].model.get("isProcessing")===false){if(t){z.attachments[q].shiftKeySelected=true}p.push(q)}}}var r=z.collection.getSelectedItems().filter(function(D){return z.attachments[D.id].shiftKeySelected&&(p.indexOf(D.id)===-1)}).map(function(D){return D.id});p=p.concat(r);var x=this.collection.toArray().map(function(D){return D.id});x=x.filter(function(D){return p.indexOf(D)<0});this.collection.unselect(x);this.collection.select(p)}}else{v.model.select()}}else{if(!y){var C=this.collection.toArray().map(function(D){return D.id});var w=C.indexOf(v.id);C.splice(w,1);this.collection.unselect(C)}if(!v.model.selected){v.model.select()}}},_onAttachmentClick:function(r){var q=this;if(this.attachments.hasOwnProperty(r.currentTarget.getData("id"))){var s=this.attachments[r.currentTarget.getData("id")];if(r.ctrlKey){if(s.model.selected&&r.type!=="contextmenu"){s.model.unselect()}else{s.model.select();s.shiftKeySelected=false}}else{if(r.shiftKey){var t=this.attachments[this.currentPos.id];q._goTo(s,true,t,true)}else{var p=(r.type==="contextmenu"&&s.model.selected)||(r.type==="dragstart"&&s.model.selected);q._goTo(s,p);s.shiftKeySelected=false}}q.currentPos=s.model}},_onAttachmentDrag:function(u){var t=this;t._onAttachmentClick(u);if(this.attachments.hasOwnProperty(u.currentTarget.getData("id"))){var v=this.attachments[u.currentTarget.getData("id")];u.dataTransfer.setDragImage(v.container,u.offsetX,u.offsetY);var s=this.collection.getSelectedItems();var p=s.map(function(w){return{options:{id:w.id,type:w.get("type"),name:w.get("title")}}});var q=n.setDroppableData(p);var r={type:q.type,data:JSON.stringify(q.data)};u.dataTransfer.setData(r.type,r.data)}},_onCollectionSelect:function(q){if(!q.hasOwnProperty("ids")||i.is(q.ids,null)||!i.is(q.ids,"array")){var t=o.replace(o.error.common.incorrectArgument,{arg:0,type:"Array"});this._logger.error(t);return}var p=this.collection.getSelectedItems();if(p.length>0){if(p.length===1){this.current=this.attachments[p[0].id]}if(this.currentPos){var u=this.attachments[this.currentPos.id];var s={x:this._scroller._infos.x.scrollPosition,xSize:this._scroller._infos.x.offsetSize,y:this._scroller._infos.y.scrollPosition,ySize:this._scroller._infos.y.offsetSize};var r={x:u.container.offsetLeft,y:u.container.offsetTop};if(r.y<=s.y){this._scroller.scrollToElement(u.container,"top")}else{if(r.y>=(s.y+s.ySize)){this._scroller.scrollToElement(u.container,"bottom")}}}}else{this.current=null}},_onCollectionUnselect:function(q){if(!q.hasOwnProperty("ids")||i.is(q.ids,null)||!i.is(q.ids,"array")){var r=o.replace(o.error.common.incorrectArgument,{arg:0,type:"Array"});this._logger.error(r);return}for(var p=0;p<q.ids.length;p++){var s=q.ids[p];if(this.attachments.hasOwnProperty(s)){this.attachments[s].model.shiftKeySelected=false}}if(this.collection.getSelectedItems().length===0){this.current=null}},_onCollectionSort:function(){for(var p=0;p<this.collection.size();p++){var q=this.collection.at(p);var r=this.attachments[q.id];r.container.style.order=p}},_onCollectionAdd:function(p){var q=new h({model:p,domEvents:{click:this._onAttachmentClick.bind(this),contextmenu:this._onAttachmentClick.bind(this),dragstart:this._onAttachmentDrag.bind(this)}});this.attachments[p.id]=q;q.container.style.order="-1";q.render().inject(this._scroller.getInnerElement());this.container.toggleClassName(k.CSS.STATUS.EMPTY,this.collection.size()===0)},_onCollectionRemove:function(p){if(this.attachments.hasOwnProperty(p.id)){this.attachments[p.id].destroy();delete this.attachments[p.id]}this.container.toggleClassName(k.CSS.STATUS.EMPTY,this.collection.size()===0)},_onCollectionReset:function(){var s=Object.keys(this.attachments);for(var q=0;q<s.length;q++){this.attachments[s[q]].destroy();delete this.attachments[s[q]]}this.attachments={};for(var r=0;r<this.collection.size();r++){var p=this.collection.at(r);var t=new h({model:p,domEvents:{click:this._onAttachmentClick.bind(this),contextmenu:this._onAttachmentClick.bind(this),dragstart:this._onAttachmentDrag.bind(this)}});this.attachments[p.id]=t;t.container.style.order=r;t.render().inject(this.elements.scrollContent)}this.container.toggleClassName(k.CSS.STATUS.EMPTY,this.collection.size()===0)}});return e});define("DS/IssueAttachmentManager/views/Viewer",["UWA/Class/View","UWA/Core","DS/Logger/Logger","DS/Controls/Button","DS/Controls/Slider","DS/PADUtils/views/PADAlert","DS/UIKIT/Input/Button","DS/IssueCommon/utils/Utils","DS/IssueServices/utils/Performance","DS/IssueAttachmentManager/components/Collection","DS/IssueAttachmentManager/components/ContextualMenu","DS/IssueAttachmentManager/components/Item","DS/IssueAttachmentManager/services/AttachmentServices","DS/IssueAttachmentManager/views/Attachment","css!DS/IssueAttachmentManager/IssueAttachmentManager.css","i18n!DS/IssueAttachmentManager/assets/nls/IssueAttachmentManager"],function(n,g,q,l,e,o,i,c,d,r,m,b,h,p,k,f){var j={REFRESH_DEBOUNCE_TIMEOUT:100,CSS:{ELEMENTS:{PLACEHOLDER:"isu-am-viewer-placeholder",PLACEHOLDERTEXT:"isu-am-viewer-placeholdertext",PLACEHOLDERBUTTONS:"isu-am-viewer-placeholder-buttons",PLACEHOLDERBUTTON:"isu-am-viewer-placeholder-button",CONTENT:"isu-am-viewer-content",FOOTERTITLECONTAINER:"isu-am-viewer-footer-titlectn",FOOTERTITLEICON:"isu-am-viewer-footer-titleicon",FOOTERTITLETEXT:"isu-am-viewer-footer-titletxt",FOOTERZOOMCONTAINER:"isu-am-viewer-footer-zoomctn",FOOTERZOOMTXT:"isu-am-viewer-footer-zoomtxt",FOOTERZOOMCMDCONTAINER:"isu-am-viewer-footer-zoomcmdctn",FOOTERZOOMSLIDER:"isu-am-viewer-footer-zoomslider",BODY:"isu-am-viewer-body",BODYIMAGE:"isu-am-viewer-body-image",BODYVIDEO:"isu-am-viewer-body-video",BODYAUDIO:"isu-am-viewer-body-audio",BODYNOPREVIEW:"isu-am-viewer-body-nopreview",FOOTER:"isu-am-viewer-footer"},STATUS:{EMPTY:"is-empty",MULTI:"is-multi",FAILED:"is-failed"}}};var a=n.extend({name:"DS/IssueAttachmentManager/views/Viewer",tagName:"div",className:"isu-am-viewer",_logger:null,defaultOptions:{authoring:true},init:function(s){if(!s.hasOwnProperty("collection")||g.is(s.collection,null)||!(s.collection instanceof r)){throw new Error(f.replace(f.error.common.incorrectInitArgument,{className:"Viewer",property:"collection",type:"DS/IssueAttachmentManager/components/Collection"}))}if(s.hasOwnProperty("authoring")){if(!g.is(s.authoring,"boolean")){throw new Error(f.replace(f.error.common.incorrectInitArgument,{className:"Viewer",property:"authoring",type:"Boolean"}))}}if(s.hasOwnProperty("contextualMenu")){if(g.is(s.contextualMenu,null)||!(s.contextualMenu instanceof m)){throw new Error(f.replace(f.error.common.incorrectInitArgument,{className:"Viewer",property:"contextualMenu",type:"DS/IssueAttachmentManager/components/ContextualMenu"}))}}this._parent(s)},setup:function(s){var t=this;d.start(t.name+" setup");t._parent(s);t._logger=q.getLogger(t.name);t.contextualMenu=s.contextualMenu;t.current=null;t._listeners={};t.elements={};t.authoring=t.options.authoring;this.listenTo(this.collection,"onSelect",this._onCollectionSelect.bind(this));this.listenTo(this.collection,"onUnselect",this._onCollectionUnselect.bind(this));this.listenTo(this.collection,"onAdd",this._onCollectionAdd.bind(this));this.listenTo(this.collection,"onRemove",this._onCollectionRemove.bind(this));this.refresh=this.debounce(this._refresh.bind(this),j.REFRESH_DEBOUNCE_TIMEOUT);d.end(t.name+" setup")},render:function(){var w=this;d.start(this.name+" render");this.container.toggleClassName(j.CSS.STATUS.EMPTY,this.collection.size()===0);if(this.contextualMenu instanceof m){this.contextualMenu.register(this.container)}w.elements.placeholder=g.createElement("div",{"class":j.CSS.ELEMENTS.PLACEHOLDER});w.elements.placeholder.inject(w.container);var v=g.createElement("div",{"class":j.CSS.ELEMENTS.PLACEHOLDERTEXT,html:w.authoring?f.views.Placeholder.text:f.views.Placeholder.textNoAuthoring,title:w.authoring?f.views.Placeholder.text:f.views.Placeholder.textNoAuthoring,});v.inject(w.elements.placeholder);var t=g.createElement("div",{"class":j.CSS.ELEMENTS.PLACEHOLDERBUTTONS});t.inject(w.elements.placeholder);if(w.authoring){var s=new i({className:j.CSS.ELEMENTS.PLACEHOLDERBUTTON+" primary",value:f.views.Placeholder.addExisting,events:{onClick:function(){w.dispatchEvent("request:attachFrom3DX")}}});s.inject(t);var u=new i({className:j.CSS.ELEMENTS.PLACEHOLDERBUTTON+" default",value:f.views.Placeholder.upload,events:{onClick:function(){w.dispatchEvent("request:attachFromLocalDisk")}}});u.inject(t)}w.elements.content=g.createElement("div",{"class":j.CSS.ELEMENTS.CONTENT});w.elements.content.inject(w.container);w.elements.body=g.createElement("div",{"class":j.CSS.ELEMENTS.BODY});w.elements.body.inject(w.elements.content);w.elements.footer=g.createElement("div",{"class":j.CSS.ELEMENTS.FOOTER});w.elements.footerTitleCtn=g.createElement("div",{"class":j.CSS.ELEMENTS.FOOTERTITLECONTAINER}).inject(w.elements.footer);w.elements.footerTitleIcon=g.createElement("img",{"class":j.CSS.ELEMENTS.FOOTERTITLEICON});w.elements.footerTitleIcon.inject(w.elements.footerTitleCtn);w.elements.footerTitleTxt=g.createElement("div",{"class":j.CSS.ELEMENTS.FOOTERTITLETEXT}).inject(w.elements.footerTitleCtn);w.elements.footer.inject(w.elements.content);w.elements.footerZoomCtn=g.createElement("div",{"class":j.CSS.ELEMENTS.FOOTERZOOMCONTAINER}).inject(w.elements.footer);w.elements.footerZoomTxt=g.createElement("div",{"class":j.CSS.ELEMENTS.FOOTERZOOMTXT,html:"100%"}).inject(w.elements.footerZoomCtn);w.elements.footerZoomCmdCtn=g.createElement("div",{"class":j.CSS.ELEMENTS.FOOTERZOOMCMDCONTAINER}).inject(w.elements.footerZoomCtn);w.elements.footerZoomMinus=new l({emphasize:"secondary",type:"button",icon:{iconName:"minus"},onClick:function(){var x=50;if(w.elements.footerZoomSlider.value-x>w.elements.footerZoomSlider.minValue){w.elements.footerZoomSlider.value-=x}else{w.elements.footerZoomSlider.value=w.elements.footerZoomSlider.minValue}},allowUnsafeHTMLLabel:true}).inject(w.elements.footerZoomCmdCtn);w.elements.footerZoomSlider=new e({className:j.CSS.ELEMENTS.FOOTERZOOMSLIDER,value:100,minValue:100,maxValue:500,stepValue:2}).inject(w.elements.footerZoomCmdCtn);w.elements.footerZoomSlider.addEventListener("change",function(x){w.elements.footerZoomTxt.innerHTML=x.dsModel.value+"%";if(w.elements.bodyImage){w.elements.bodyImage.setStyle("transform","scale("+(x.dsModel.value/100)+")")}});w.elements.footerZoomPlus=new l({emphasize:"secondary",type:"button",icon:{iconName:"plus"},onClick:function(){var x=50;if(w.elements.footerZoomSlider.value+x<w.elements.footerZoomSlider.maxValue){w.elements.footerZoomSlider.value+=x}else{w.elements.footerZoomSlider.value=w.elements.footerZoomSlider.maxValue}},allowUnsafeHTMLLabel:true}).inject(w.elements.footerZoomCmdCtn);w.elements.footerZoomReset=new l({emphasize:"secondary",type:"button",icon:{iconName:"refresh"},onClick:function(){w.elements.footerZoomSlider.value=100;w.elements.bodyImage.style.top="0px";w.elements.bodyImage.style.left="0px"},allowUnsafeHTMLLabel:true}).inject(w.elements.footerZoomCmdCtn);d.end(this.name+" render");return this},destroy:function(){var s=this;s._debounceTimeouts.forEach(function(t){clearTimeout(t)});s._debounceTimeouts=[];s._parent()},_refresh:function(){var s=this.collection.getSelectedItems();this.container.toggleClassName(j.CSS.STATUS.EMPTY,this.collection.size()===0);this.container.removeClassName(j.CSS.STATUS.MULTI);this.elements.footer.hide();this.elements.footerTitleCtn.setStyle("max-width","100%");this.elements.footerZoomCtn.hide();if(this._listeners.wheel){this.elements.content.removeEventListener("wheel",this._listeners.wheel)}if(this.elements.bodyImage){this.elements.bodyImage.destroy();delete this.elements.bodyImage}if(this.elements.bodyVideo){this.elements.bodyVideo.destroy();delete this.elements.bodyVideo}if(s.length===1){this.current=s[0];this.listenTo(this.current,"onChange:contentUrl",this._onCurrentItemChangeContentUrl);this.container.toggleClassName(j.CSS.STATUS.FAILED,this.current.get("isFailed"));this.elements.footer.show();if(!this.current.get("isFailed")){this.elements.footerTitleIcon.src=this.current.get("iconUrl");this.elements.footerTitleIcon.alt=this.current.get("type");this.elements.footerTitleIcon.title=this.current.get("type")}this.elements.footerTitleTxt.innerHTML=this.current.get("title");this.elements.footerTitleTxt.title=this.current.get("title");this.elements.body.setContent(g.createElement("span",{html:f.views.Viewer.noPreview,"class":j.CSS.ELEMENTS.BODYNOPREVIEW}));if(!this.current.get("isFailed")&&!this.current.get("isProcessing")){if(this.current.get("type")==="Document"){switch(this.current.get("documentType")){case"image":this._renderBodyForImage();break;case"video":this._renderBodyForVideo();break;case"audio":this._renderBodyForAudio();break;default:break}}}}else{if(s.length>1){this.current=null;this.elements.body.setContent(g.createElement("span",{html:f.views.Viewer.noPreview,"class":j.CSS.ELEMENTS.BODYNOPREVIEW}));this.container.addClassName(j.CSS.STATUS.MULTI)}else{this.current=null;this.elements.body.setContent(g.createElement("span",{html:f.views.Viewer.noSelection,"class":j.CSS.ELEMENTS.BODYNOPREVIEW}))}}},_renderBodyForImage:function(){var v=this;this.elements.body.empty();this.elements.bodyImage=g.createElement("div",{"class":j.CSS.ELEMENTS.BODYIMAGE,title:this.current.get("title")});if(this.current.get("contentUrl")){this.elements.bodyImage.setStyle("background-image","url("+this.current.get("contentUrl")+")")}this.elements.bodyImage.inject(this.elements.body);this.elements.footerZoomSlider.value=100;this.elements.footerZoomCtn.show();this.elements.footerTitleCtn.setStyle("max-width","calc(100% - "+this.elements.footerZoomCtn.clientWidth+"px)");v._listeners.wheel=v._onImageMouseWheel.bind(v);this.elements.content.addEventListener("wheel",v._listeners.wheel);var A=0,y=0,x=0,w=0;var t=this.elements.bodyImage;t.style.top="0px";t.style.left="0px";var z=function(B){if(B.target===t){B.preventDefault();x=B.clientX;w=B.clientY;t.setStyle("z-index","91");v.container.addEventListener("mouseup",u);t.addEventListener("mousemove",s)}};v.container.addEventListener("mousedown",z);var u=function(){t.setStyle("z-index","89");v.container.removeEventListener("mouseup",u);t.removeEventListener("mousemove",s)};var s=function(D){D.preventDefault();A=x-D.clientX;y=w-D.clientY;x=D.clientX;w=D.clientY;var C=t.clientTop-y;var B=t.clientLeft-A;t.style.top=parseInt(t.style.top.replace("px",""))+C+"px";t.style.left=parseInt(t.style.left.replace("px",""))+B+"px"}},_renderBodyForVideo:function(){var s=this;c.Mask.mask(s.elements.body);h.downloadDocuments([s.current.id]).then(function(t){if(t[0].id===s.current.id){if(t.length===1){s.elements.body.empty();s.elements.bodyVideo=g.createElement("video",{"class":j.CSS.ELEMENTS.BODYVIDEO,src:t[0].downloadUrl,controls:true});setTimeout(function(){if(g.is(s.elements.bodyVideo)){s.elements.bodyVideo.inject(s.elements.body)}},j.REFRESH_DEBOUNCE_TIMEOUT);s.current.set("contentUrl",t[0].downloadUrl)}else{throw new Error("Unexpected downloadDocuments response when rendering Attachment Viewer.")}}else{}})["catch"](function(t){s._logger.error(t);o.displayNotification({msg:f.notifications.Download.failure,eventID:"error"})})["finally"](function(){c.Mask.unmask(s.elements.body)})},_renderBodyForAudio:function(){var s=this;c.Mask.mask(s.elements.body);h.downloadDocuments([s.current.id]).then(function(t){if(t[0].id===s.current.id){if(t.length===1){s.elements.body.empty();s.elements.bodyVideo=g.createElement("audio",{"class":j.CSS.ELEMENTS.BODYAUDIO,src:t[0].downloadUrl,controls:true});setTimeout(function(){if(g.is(s.elements.bodyVideo)){s.elements.bodyVideo.inject(s.elements.body)}},j.REFRESH_DEBOUNCE_TIMEOUT);s.current.set("contentUrl",t[0].downloadUrl)}else{throw new Error("Unexpected downloadDocuments response when rendering Attachment Viewer.")}}else{}})["catch"](function(t){s._logger.error(t);o.displayNotification({msg:f.notifications.Download.failure,eventID:"error"})})["finally"](function(){c.Mask.unmask(s.elements.body)})},_onCollectionSelect:function(s){if(!s.hasOwnProperty("ids")||g.is(s.ids,null)||!g.is(s.ids,"array")){var t=f.replace(f.error.common.incorrectArgument,{arg:0,type:"Array"});this._logger.error(t);return}if(s.ids.length>1||this.collection.getSelectedItems().length>1){}else{}this.refresh()},_onCollectionUnselect:function(t){if(!t.hasOwnProperty("ids")||g.is(t.ids,null)||!g.is(t.ids,"array")){var u=f.replace(f.error.common.incorrectArgument,{arg:0,type:"Array"});this._logger.error(u);return}for(var s=0;s<t.ids.length;s++){var v=t.ids[s];if(this.current&&this.current.id===v){this.stopListening(this.current,"onChange:contentUrl")}}this.refresh()},_onCollectionAdd:function(){this.refresh()},_onCollectionRemove:function(){this.refresh()},_onCurrentItemChangeContentUrl:function(t){var s=this;switch(this.current.get("documentType")){case"image":s.elements.bodyImage.setStyle("background-image","url("+t.get("contentUrl")+")");break;case"video":break;default:break}},_onImageMouseWheel:function(u){var t=this;u.preventDefault();if(u.deltaY<0){var s=-u.deltaY*2/10;if(t.elements.footerZoomSlider.value+s<t.elements.footerZoomSlider.maxValue){t.elements.footerZoomSlider.value+=s}else{t.elements.footerZoomSlider.value=t.elements.footerZoomSlider.maxValue}}else{var v=u.deltaY*2/10;if(t.elements.footerZoomSlider.value-v>t.elements.footerZoomSlider.minValue){t.elements.footerZoomSlider.value-=v}else{t.elements.footerZoomSlider.value=t.elements.footerZoomSlider.minValue}}},_debounceTimeouts:[],debounce:function(u,w,s){var t=this;var v;return function(){var B=this,A=arguments;var y=function(){v=null;if(!s){u.apply(B,A)}};var x=s&&!v;clearTimeout(v);var z=t._debounceTimeouts.indexOf(v);if(z!==-1){t._debounceTimeouts.splice(z,1)}v=setTimeout(y,w);t._debounceTimeouts.push(v);if(x){u.apply(B,A)}}}});return a});define("DS/IssueAttachmentManager/views/Slider",["UWA/Class/View","UWA/Core","DS/Logger/Logger","DS/UIKIT/Scroller","DS/IssueComponents/utils/Utils","DS/IssueServices/utils/Performance","DS/IssueAttachmentManager/components/Collection","DS/IssueAttachmentManager/components/ContextualMenu","DS/IssueAttachmentManager/components/Item","DS/IssueAttachmentManager/views/Attachment","css!DS/IssueAttachmentManager/IssueAttachmentManager.css","i18n!DS/IssueAttachmentManager/assets/nls/IssueAttachmentManager"],function(b,i,d,e,m,c,j,l,f,g,a,n){var k={CSS:{ELEMENTS:{NAVIGATIONBUTTON:"isu-am-slider-navigation-button",PREVIOUSBUTTON:"isu-am-slider-navigation-button-previous",PREVIOUSICON:"fonticon-chevron-left",NEXTICON:"fonticon-chevron-right",NEXTBUTTON:"isu-am-slider-navigation-button-next",SCROLLCONTENT:"isu-am-slider-scroll-content",SCROLLCONTAINER:"isu-am-slider-scroll-container"}}};var h=b.extend({name:"DS/IssueAttachmentManager/views/Slider",tagName:"div",className:"isu-am-slider",_logger:null,init:function(o){if(!o.hasOwnProperty("collection")||i.is(o.collection,null)||!(o.collection instanceof j)){throw new Error(n.replace(n.error.common.incorrectInitArgument,{className:"Slider",property:"collection",type:"DS/IssueAttachmentManager/components/Collection"}))}if(o.hasOwnProperty("contextualMenu")){if(i.is(o.contextualMenu,null)||!(o.contextualMenu instanceof l)){throw new Error(n.replace(n.error.common.incorrectInitArgument,{className:"Slider",property:"contextualMenu",type:"DS/IssueAttachmentManager/components/ContextualMenu"}))}}this._parent(o)},setup:function(o){var p=this;c.start(p.name+" setup");p._parent(o);p._logger=d.getLogger(p.name);this.contextualMenu=o.contextualMenu;this.listenTo(this.collection,"onSelect",this._onCollectionSelect.bind(this));this.listenTo(this.collection,"onUnselect",this._onCollectionUnselect.bind(this));this.listenTo(this.collection,"onSort",this._onCollectionSort.bind(this));this.listenTo(this.collection,"onAdd",this._onCollectionAdd.bind(this));this.listenTo(this.collection,"onRemove",this._onCollectionRemove.bind(this));this.listenTo(this.collection,"onReset",this._onCollectionReset.bind(this));c.end(p.name+" setup")},render:function(){var q=this;c.start(this.name+" render");this.elements.prevBtn=i.createElement("div",{"class":k.CSS.ELEMENTS.NAVIGATIONBUTTON+" "+k.CSS.ELEMENTS.PREVIOUSBUTTON}).inject(this.container);this.elements.prevBtn.addEventListener("click",this.slideToPrevious.bind(this));this.elements.prevBtn.hide();i.createElement("span",{"class":"fonticon fonticon-2x "+k.CSS.ELEMENTS.PREVIOUSICON}).inject(this.elements.prevBtn);this.elements.nextBtn=i.createElement("div",{"class":k.CSS.ELEMENTS.NAVIGATIONBUTTON+" "+k.CSS.ELEMENTS.NEXTBUTTON}).inject(this.container);this.elements.nextBtn.hide();this.elements.nextBtn.addEventListener("click",this.slideToNext.bind(this));i.createElement("span",{"class":"fonticon fonticon-2x "+k.CSS.ELEMENTS.NEXTICON}).inject(this.elements.nextBtn);this.elements.scrollContent=i.createElement("div",{"class":k.CSS.ELEMENTS.SCROLLCONTENT}).inject(this.container);this.elements.scrollContainer=i.createElement("div",{"class":k.CSS.ELEMENTS.SCROLLCONTAINER}).inject(q.container);var t=i.createElement("div",{"class":"isu-am-slider-block"});t.style.order=-2;t.inject(this.elements.scrollContent);this.elements.firstEmptyBlock=t;var r=i.createElement("div",{"class":"isu-am-slider-block"});r.style.order=this.collection.size()+1;r.inject(this.elements.scrollContent);this.elements.lastEmptyBlock=r;this.attachments={};for(var p=0;p<this.collection.size();p++){var o=this.collection.at(p);var s=new g({model:o,domEvents:{click:this._onAttachmentClick.bind(this),contextmenu:this._onAttachmentClick.bind(this),dragstart:this._onAttachmentDrag.bind(this)}});this.attachments[o.id]=s;s.container.style.order=p;s.container.setAttribute("draggable",true);s.render().inject(this.elements.scrollContent);if(this.contextualMenu instanceof l){this.contextualMenu.register(s.container)}}q._scroller=new e({element:this.elements.scrollContent,options:{snap:true,momentum:true,scrollDrag:true}}).inject(this.elements.scrollContainer);c.end(this.name+" render");return this},refresh:function(){var p=this;var o=this.collection.getSelectedItems();if(o.length===1){if(this.current&&this.current.model.id!==o[0].id){this.current.container.removeClassName("selected")}this.current=this.attachments[o[0].id];this.current.container.addClassName("selected");setTimeout(function(){if(p.current){var s=p.collection.indexOf(p.current.model);var r=p.container.scrollWidth/2-(s===0?100:140);p._scroller.scrollTo(p.current.container.offsetLeft-r,0,10)}},200);var q=this.collection.indexOf(this.current.model);if(q===0){this.elements.prevBtn.hide()}else{this.elements.prevBtn.show()}if(q===this.collection.size()-1){this.elements.nextBtn.hide()}else{this.elements.nextBtn.show()}}else{if(o.length>1){if(this.current){this.current.container.removeClassName("selected");this.current=null}this.elements.prevBtn.hide();this.elements.nextBtn.hide()}else{this.elements.prevBtn.hide();this.elements.nextBtn.hide()}}},slideToNext:function(){if(this.collection.size()){var o=-1;if(this.current!==null&&this.current!==undefined){o=this.collection.indexOf(this.current.model)}if(o<this.collection.size()-1){var p=this.attachments[this.collection.at(o+1).id];this._slideTo(p)}}return this},slideToPrevious:function(){if(this.collection.size()){var o=1;if(this.current!==null&&this.current!==undefined){o=this.collection.indexOf(this.current.model)}if(o>0){var p=this.attachments[this.collection.at(o-1).id];this._slideTo(p)}}return this},_slideTo:function(r){var o=this.collection.toArray().map(function(s){return s.id});var p=o.indexOf(r.id);o.splice(p,1);this.collection.unselect(o);if(!r.model.selected){r.model.select()}else{var q=this.container.scrollWidth/2-100;this._scroller.scrollTo(r.container.offsetLeft-q,0,10)}},_onAttachmentClick:function(o){if(this.attachments.hasOwnProperty(o.currentTarget.getData("id"))){var p=this.attachments[o.currentTarget.getData("id")];this._slideTo(p)}},_onAttachmentDrag:function(s){var r=this;r._onAttachmentClick(s);if(this.attachments.hasOwnProperty(s.currentTarget.getData("id"))){var t=this.attachments[s.currentTarget.getData("id")];s.dataTransfer.setDragImage(t.container,s.offsetX,s.offsetY);var o=[{options:{id:t.model.id,type:t.model.get("type"),name:t.model.get("title")}}];var p=m.setDroppableData(o);var q={type:p.type,data:JSON.stringify(p.data)};s.dataTransfer.setData(q.type,q.data)}},_onCollectionSelect:function(p){var o=this;if(!p.hasOwnProperty("ids")||i.is(p.ids,null)||!i.is(p.ids,"array")){var q=n.replace(n.error.common.incorrectArgument,{arg:0,type:"Array"});this._logger.error(q);return}if(p.ids.length>1||o.collection.getSelectedItems().length>1){}this.refresh()},_onCollectionUnselect:function(o){if(!o.hasOwnProperty("ids")||i.is(o.ids,null)||!i.is(o.ids,"array")){var p=n.replace(n.error.common.incorrectArgument,{arg:0,type:"Array"});this._logger.error(p)}if(this.collection.getSelectedItems().length===0){this.refresh()}},_onCollectionSort:function(){for(var o=0;o<this.collection.size();o++){var p=this.collection.at(o);var q=this.attachments[p.id];q.container.style.order=o}this.elements.lastEmptyBlock.style.order=this.collection.size()+1},_onCollectionAdd:function(o){var p=new g({model:o,domEvents:{click:this._onAttachmentClick.bind(this),contextmenu:this._onAttachmentClick.bind(this),dragstart:this._onAttachmentDrag.bind(this)}});this.attachments[o.id]=p;p.container.style.order="-1";p.render().inject(this._scroller.getInnerElement());if(this.contextualMenu instanceof l){this.contextualMenu.register(p.container)}},_onCollectionRemove:function(o){if(this.attachments.hasOwnProperty(o.id)){this.attachments[o.id].destroy();delete this.attachments[o.id]}},_onCollectionReset:function(){var r=Object.keys(this.attachments);for(var p=0;p<r.length;p++){this.attachments[r[p]].destroy();delete this.attachments[r[p]]}this.attachments={};for(var q=0;q<this.collection.size();q++){var o=this.collection.at(q);var s=new g({model:o,domEvents:{click:this._onAttachmentClick.bind(this),contextmenu:this._onAttachmentClick.bind(this),dragstart:this._onAttachmentDrag.bind(this)}});this.attachments[o.id]=s;s.container.style.order=q;s.render().inject(this.elements.scrollContent);if(this.contextualMenu instanceof l){this.contextualMenu.register(s.container)}}}});return h});define("DS/IssueAttachmentManager/IssueAttachmentManager",["UWA/Class/View","UWA/Core","UWA/Class/Promise","DS/Logger/Logger","DS/UIKIT/Mask","DS/UIKIT/Scroller","DS/UIKIT/SuperModal","DS/ENO6WPlugins/jQuery","DS/ENO6WPlugins/jQueryUI","DS/PADUtils/views/PADAlert","DS/PlatformAPI/PlatformAPI","DS/UIBehaviors/CommandsRegistry","DS/WebappsUtils/WebappsUtils","DS/WAFData/WAFData","DS/2DAnnotation/2DAnnotation","DS/IssueCommon/utils/Utils","DS/IssueServices/Contexts","DS/IssueServices/services/IssueServices","DS/IssueServices/services/PlatformServices","DS/IssueServices/utils/Performance","DS/IssueAttachmentManager/components/Collection","DS/IssueAttachmentManager/components/ContextualMenu","DS/IssueAttachmentManager/components/Item","DS/IssueAttachmentManager/services/AttachmentServices","DS/IssueAttachmentManager/views/Catalog","DS/IssueAttachmentManager/views/Header","DS/IssueAttachmentManager/views/Slider","DS/IssueAttachmentManager/views/Viewer","css!DS/IssueAttachmentManager/IssueAttachmentManager.css","i18n!DS/IssueAttachmentManager/assets/nls/IssueAttachmentManager"],function(z,k,g,D,F,C,x,n,v,A,e,y,i,b,t,f,l,h,m,d,E,r,c,o,B,u,s,a,q,j){var p={CSS:{ELEMENTS:{IS_EMPTY:"is-empty",TOPFRAME:"isu-am-topframe",CENTERFRAME:"isu-am-centerframe",RIGHTFRAME:"isu-am-rightframe",RIGHTFRAMECOLLAPSER:"isu-am-rightframe-collapser",RIGHTFRAMECOLLAPSERBUTTONCLOSE:"fonticon-chevron-right",RIGHTFRAMECOLLAPSERBUTTONOPEN:"fonticon-chevron-left",INNERRIGHT:"isu-am-innerright",LEFTFRAME:"isu-am-leftframe",BOTTOMFRAME:"isu-am-bottomframe",BOTTOMFRAMECOLLAPSER:"isu-am-bottomframe-collapser",BOTTOMFRAMECOLLAPSERBUTTONCLOSE:"fonticon-chevron-down",BOTTOMFRAMECOLLAPSERBUTTONOPEN:"fonticon-chevron-up",INNERBOTTOM:"isu-am-innerbottom",FRAMECLOSED:"closed",DELETE_DIALOG:"isu-am-delete-confirm-dialog",ANNOTATION:"isu-am-annotation"},LAYOUTS:{CATALOG:{1:"grid",2:"list"},MODE:{1:"full",2:"catalog-only"}},DIMENSIONS:{RIGHTFRAME:{MINWIDTH:185},BOTTOMFRAME:{HEIGHT:150},LEFTFRAME:{MINWIDTH:280}},STATUS:{}},ILLEGAL_CHARACTERS:/[/\\?%*:|"<>]/g};var w=z.extend({name:"DS/IssueAttachmentManager/IssueAttachmentManager",tagName:"div",className:"isu-am",_logger:null,defaultOptions:{authoring:true,mode:1,catalogLayout:1,catalogVisibility:true,sliderVisibility:true,annotationPreLaunchCallback:function(){},annotationSaveCallback:function(){},annotationExitCallback:function(){}},init:function(G){if(!G.hasOwnProperty("id")||k.is(G.id,null)||k.equals(G.id,"")||!k.is(G.id,"string")){throw new Error(j.replace(j.error.common.incorrectInitArgument,{className:"IssueAttachmentManager",property:"id",type:"String"}))}if(G.hasOwnProperty("authoring")){if(!k.is(G.authoring,"boolean")){throw new Error(j.replace(j.error.common.incorrectInitArgument,{className:"IssueAttachmentManager",property:"authoring",type:"Boolean"}))}}if(G.hasOwnProperty("mode")){if(!k.is(G.mode,"number")){throw new Error(j.replace(j.error.common.incorrectInitArgument,{className:"IssueAttachmentManager",property:"mode",type:"Number"}))}else{if(!p.CSS.LAYOUTS.MODE.hasOwnProperty(G.mode)){throw new Error(j.replace(j.error.manager.unsupportedMode,{mode:G.mode}))}}}if(G.hasOwnProperty("catalogLayout")){if(!k.is(G.catalogLayout,"number")){throw new Error(j.replace(j.error.common.incorrectInitArgument,{className:"IssueAttachmentManager",property:"catalogLayout",type:"Number"}))}else{if(!p.CSS.LAYOUTS.CATALOG.hasOwnProperty(G.catalogLayout)){throw new Error(j.replace(j.error.views.Catalog.unsupportedLayout,{layout:G.catalogLayout}))}}}if(G.hasOwnProperty("catalogVisibility")){if(!k.is(G.catalogVisibility,"boolean")){throw new Error(j.replace(j.error.common.incorrectInitArgument,{className:"IssueAttachmentManager",property:"catalogVisibility",type:"Boolean"}))}}if(G.hasOwnProperty("sliderVisibility")){if(!k.is(G.sliderVisibility,"boolean")){throw new Error(j.replace(j.error.common.incorrectInitArgument,{className:"IssueAttachmentManager",property:"sliderVisibility",type:"Boolean"}))}}if(G.hasOwnProperty("groupByType")){if(!k.is(G.groupByType,"boolean")){throw new Error(j.replace(j.error.common.incorrectInitArgument,{className:"IssueAttachmentManager",property:"groupByType",type:"Boolean"}))}}if(G.hasOwnProperty("sortMode")){if(!k.is(G.sortMode,"string")){throw new Error(j.replace(j.error.common.incorrectInitArgument,{className:"IssueAttachmentManager",property:"sortMode",type:"String"}))}}if(G.hasOwnProperty("sortOrder")){if(!k.is(G.sortOrder,"string")){throw new Error(j.replace(j.error.common.incorrectInitArgument,{className:"IssueAttachmentManager",property:"sortOrder",type:"String"}))}}if(G.hasOwnProperty("annotationPreLaunchCallback")){if(!k.is(G.annotationPreLaunchCallback,"function")){throw new Error(j.replace(j.error.common.incorrectInitArgument,{className:"IssueAttachmentManager",property:"annotationPreLaunchCallback",type:"Function"}))}}if(G.hasOwnProperty("annotationSaveCallback")){if(!k.is(G.annotationSaveCallback,"function")){throw new Error(j.replace(j.error.common.incorrectInitArgument,{className:"IssueAttachmentManager",property:"annotationSaveCallback",type:"Function"}))}}if(G.hasOwnProperty("annotationExitCallback")){if(!k.is(G.annotationExitCallback,"function")){throw new Error(j.replace(j.error.common.incorrectInitArgument,{className:"IssueAttachmentManager",property:"annotationExitCallback",type:"Function"}))}}this._parent(G)},setup:function(G){var H=this;d.start(H.name+" setup");H._parent(G);H.mode=H.options.mode;H.authoring=H.options.authoring;H.catalogLayout=H.options.catalogLayout;H.bottomFrameIsClosed=!H.options.sliderVisibility;H.rightFrameIsClosed=!H.options.catalogVisibility;H._rightFrameWidth=H.options.catalogWidth||p.CSS.DIMENSIONS.RIGHTFRAME.MINWIDTH;H._logger=D.getLogger(H.name);d.end(H.name+" setup")},render:function(){var G=this;d.start(this.name+" render");G.isLoaded=new g(function(I,H){G._deferred={};G._deferred.resolve=I;G._deferred.reject=H});G.container.setAttribute("id","isu-am-"+this.id+"-"+Date.now());G.container.setData("id",this.id);F.mask(G.container);o.getDocumentsFrom(this.id).then(function(H){G.collection=new E(H);if(G.options.hasOwnProperty("groupByType")){G.collection.groupByType=G.options.groupByType}if(G.options.hasOwnProperty("sortMode")){G.collection.sortMode=G.options.sortMode}if(G.options.hasOwnProperty("sortOrder")){G.collection.sortOrder=G.options.sortOrder}return o.getPrimary(G.id).then(function(I){var J=JSON.parse(I);if(k.is(J.documentId,"string")&&J.documentId!==""&&G.collection.get(J.documentId)){G.collection.get(J.documentId).set("isPrimary",true)}})}).then(function(){G.container.empty();if(G.collection===null){return g.resolve()}G.contextualMenu=new r({authoring:G.authoring,collection:G.collection});G.elements.topFrame=k.createElement("div",{"class":p.CSS.ELEMENTS.TOPFRAME}).inject(G.container);G.elements.rightFrame=k.createElement("div",{"class":p.CSS.ELEMENTS.RIGHTFRAME+" "+p.CSS.ELEMENTS.FRAMECLOSED}).inject(G.container);G.elements.innerRight=k.createElement("div",{"class":p.CSS.ELEMENTS.INNERRIGHT}).inject(G.elements.rightFrame);G.elements.centerFrame=k.createElement("div",{"class":p.CSS.ELEMENTS.CENTERFRAME}).inject(G.container);G.elements.bottomFrame=k.createElement("div",{"class":p.CSS.ELEMENTS.BOTTOMFRAME}).inject(G.container);G.elements.innerBottom=k.createElement("div",{"class":p.CSS.ELEMENTS.INNERBOTTOM}).inject(G.elements.bottomFrame);G.views={};G.views.catalog=new B({authoring:G.authoring,collection:G.collection,contextualMenu:G.contextualMenu,layout:G.catalogLayout}).render().inject(G.elements.innerRight);G.views.header=new u({authoring:G.authoring,collection:G.collection,annotationPreLaunchCallback:G.options.annotationPreLaunchCallback,annotationSaveCallback:G.options.annotationSaveCallback,annotationExitCallback:G.options.annotationExitCallback}).render().inject(G.elements.topFrame);G.views.slider=new s({collection:G.collection,contextualMenu:G.contextualMenu}).render().inject(G.elements.innerBottom);G.views.viewer=new a({authoring:G.authoring,collection:G.collection,contextualMenu:G.contextualMenu,}).render().inject(G.elements.centerFrame);var K=(G.container.getDimensions().innerWidth>(p.CSS.DIMENSIONS.LEFTFRAME.MINWIDTH+p.CSS.DIMENSIONS.RIGHTFRAME.MINWIDTH))?G.container.getDimensions().innerWidth-p.CSS.DIMENSIONS.LEFTFRAME.MINWIDTH:p.CSS.DIMENSIONS.RIGHTFRAME.MINWIDTH;G.resizable=n(G.elements.rightFrame).resizable({handles:"w",maxWidth:K,minWidth:p.CSS.DIMENSIONS.RIGHTFRAME.MINWIDTH,stop:function(M,N){G._rightFrameWidth=N.size.width;G._updatePreferences()}});G.elements.rightFrameCollapser=k.createElement("div",{"class":p.CSS.ELEMENTS.RIGHTFRAMECOLLAPSER}).inject(G.elements.rightFrame);G.elements.rightFrameCollapserButton=k.createElement("span",{"class":"fonticon fonticon-2x "+p.CSS.ELEMENTS.RIGHTFRAMECOLLAPSERBUTTONOPEN}).inject(G.elements.rightFrameCollapser);G.elements.rightFrameCollapserButton.addEventListener("click",G._onRightFrameCollapserClick.bind(G));G.elements.bottomFrameCollapser=k.createElement("div",{"class":p.CSS.ELEMENTS.BOTTOMFRAMECOLLAPSER}).inject(G.elements.bottomFrame);G.elements.bottomFrameCollapserButton=k.createElement("span",{"class":"fonticon fonticon-2x "+p.CSS.ELEMENTS.BOTTOMFRAMECOLLAPSERBUTTONOPEN}).inject(G.elements.bottomFrameCollapser);G.elements.bottomFrameCollapserButton.addEventListener("click",G._onBottomFrameCollapserClick.bind(G));G._currentMode=null;G._toggleMode(G.mode,true);if(G.rightFrameIsClosed!==true||G.mode===2){G._showRightFrame()}if(G.collection.size()!==0&&G.bottomFrameIsClosed!==true){G._showBottomFrame()}F.unmask(G.container);G.listenTo(G.collection,"onAdd",G.resize.bind(G));G.listenTo(G.collection,"onRemove",G.resize.bind(G));G.listenTo(G.collection,"onReset",G.resize.bind(G));G.listenTo(G.contextualMenu,"request:groupByType",G._onRequestGroupByType.bind(G));G.listenTo(G.contextualMenu,"request:sort",G._onRequestSort.bind(G));G.listenTo(G.contextualMenu,"request:catalogSwitchLayout",G._onRequestCatalogSwitchLayout.bind(G));G.listenTo(G.contextualMenu,"request:downloadFile",G._onRequestDownloadFile.bind(G));G.listenTo(G.contextualMenu,"request:openWith",G._onRequestOpenWith.bind(G));G.listenTo(G.contextualMenu,"request:annotate",G._onRequestAnnotate.bind(G));G.listenTo(G.contextualMenu,"request:setAsPrimary",G._onRequestSetAsPrimary.bind(G));G.listenTo(G.contextualMenu,"request:detach",G._onRequestDetach.bind(G));G.listenTo(G.contextualMenu,"request:delete",G._onRequestDelete.bind(G));G.listenTo(G.contextualMenu,"request:attachFrom3DX",G._onRequestAttachFrom3DX.bind(G));G.listenTo(G.contextualMenu,"request:attachFromLocalDisk",G._onRequestAttachFromLocalDisk.bind(G));G._listeners=[];G._listeners.push({target:G.container,event:"keydown",listener:G._onKeyDown.bind(G)});for(var H=0;H<G._listeners.length;H++){var L=G._listeners[H];L.target.addEventListener(L.event,L.listener)}G.listenTo(G.views.header,"request:uploadFile",G._onRequestUploadFile.bind(G));G.listenTo(G.views.header,"request:attachFrom3DX",G._onRequestAttachFrom3DX.bind(G));G.listenTo(G.views.header,"request:attachFromLocalDisk",G._onRequestAttachFromLocalDisk.bind(G));G.listenTo(G.views.header,"request:detach",G._onRequestDetach.bind(G));G.listenTo(G.views.header,"request:delete",G._onRequestDelete.bind(G));G.listenTo(G.views.header,"request:downloadFile",G._onRequestDownloadFile.bind(G));G.listenTo(G.views.header,"request:openWith",G._onRequestOpenWith.bind(G));G.listenTo(G.views.header,"request:annotate",G._onRequestAnnotate.bind(G));G.listenTo(G.views.header,"request:groupByType",G._onRequestGroupByType.bind(G));G.listenTo(G.views.header,"request:sort",G._onRequestSort.bind(G));G.listenTo(G.views.header,"request:catalogSwitchLayout",G._onRequestCatalogSwitchLayout.bind(G));G.listenTo(G.views.header,"request:updatePreferences",G._updatePreferences.bind(G));G.listenTo(G.views.header,"request:setAsPrimary",G._onRequestSetAsPrimary.bind(G));G.listenTo(G.views.catalog,"onSwitchLayout",G._onCatalogSwitchLayout.bind(G));G.listenTo(G.views.catalog,"request:attachFrom3DX",G._onRequestAttachFrom3DX.bind(G));G.listenTo(G.views.catalog,"request:attachFromLocalDisk",G._onRequestAttachFromLocalDisk.bind(G));G.listenTo(G.views.viewer,"request:attachFrom3DX",G._onRequestAttachFrom3DX.bind(G));G.listenTo(G.views.viewer,"request:attachFromLocalDisk",G._onRequestAttachFromLocalDisk.bind(G));G._addDropEvent(G.views.viewer.container);G._addDropEvent(G.views.catalog.container);G._addDropEvent(G.views.slider.container);G.container.addEventListener("paste",G._onPasteEvent.bind(G));var J=G.collection.map(function(M){return M.id});if(J.length>0){var I=o.fetch(J).then(function(N){if(N.hasOwnProperty("results")){for(var P=0;P<N.results.length;P++){var T=N.results[P].attributes.find(function(U){return U.name==="resourceid"}).value;var O=G.collection.get(T);if(O){var R=N.results[P].attributes.find(function(U){return U.name==="ds6w:label"});if(O.get("type")!=="Document"&&R&&R.value){O.set("title",R.value)}var Q=N.results[P].attributes.find(function(U){return U.name==="type_icon_url"});if(Q&&Q.value){O.set("iconUrl",Q.value)}var M=N.results[P].attributes.find(function(U){return U.name==="preview_url"});if(M&&M.value){O.set("thumbnailUrl",M.value)}var S=N.results[P].attributes.find(function(U){return U.name==="ds6w:docextension"});if(S&&S.value){O.setDocumentType(S.value)}}}}});o.downloadDocuments(J).then(function(O){if(G.collection===null){return}for(var N=0;N<O.length;N++){var P=O[N].id;var M=G.collection.get(P);if(M){if(O[N].downloadUrl&&O[N].errorMessage===undefined){M.set("contentUrl",O[N].downloadUrl)}}}});return I}else{return g.resolve()}}).then(function(){if(G.collection===null){G._deferred.resolve();return}if(G.collection.size()>0){G.container.removeClassName(p.CSS.ELEMENTS.IS_EMPTY);G.collection.sort();G.listenTo(G.collection,"onSelect",function(){G.stopListening(G.collection,"onSelect");G._deferred.resolve()});G.collection.select(G.collection.at(0).id)}else{G.container.addClassName(p.CSS.ELEMENTS.IS_EMPTY);if(G._currentMode===1){G._closeRightFrame()}G._deferred.resolve()}})["catch"](function(H){A.displayNotification({msg:j.notifications.Init.failure,eventID:"error"});G._deferred.reject(H)});d.end(this.name+" render");return this},destroy:function(){var H=this;if(k.is(H.contextualMenu,"object")){H.contextualMenu.hide()}H.collection=null;H.contextualMenu=null;if(Array.isArray(H._listeners)){for(var G=0;G<H._listeners.length;G++){var I=H._listeners[G];I.target.removeEventListener(I.event,I.listener)}}H._listeners=[];Object.keys(H.views).forEach(function(J){H.views[J].destroy()});H.container.empty()},refresh:function(I){var H=this;if(I!==null&&I!==undefined){if(!k.is(I,"string")||I.length===0){var G=j.replace(j.error.common.incorrectArgument,{arg:0,type:"String"});return g.reject(Error(G))}else{this.id=I}}return new g(function(K,J){H.isLoaded.then(function(){F.mask(H.container);H.destroy();H.render();H.isLoaded.then(function(){H.resize();H.dispatchEvent("onRefresh");F.unmask(H.container);K()})["catch"](J)})})},resize:function(){var H=this;if(H.container.clientWidth>=(p.CSS.DIMENSIONS.LEFTFRAME.MINWIDTH+p.CSS.DIMENSIONS.RIGHTFRAME.MINWIDTH)){H._toggleMode(1);var G=(H.container.getDimensions().innerWidth>(p.CSS.DIMENSIONS.LEFTFRAME.MINWIDTH+p.CSS.DIMENSIONS.RIGHTFRAME.MINWIDTH))?H.container.getDimensions().innerWidth-p.CSS.DIMENSIONS.LEFTFRAME.MINWIDTH:p.CSS.DIMENSIONS.RIGHTFRAME.MINWIDTH;H.resizable=n(H.elements.rightFrame).resizable({handles:"w",maxWidth:G,minWidth:p.CSS.DIMENSIONS.RIGHTFRAME.MINWIDTH,stop:function(I,J){H._rightFrameWidth=J.size.width;H._updatePreferences()}});if(H.collection!==null&&H.collection.size()===0){H._closeRightFrame()}if(H.rightFrameIsClosed!==true){H.elements.rightFrame.setStyle("transition","width 200ms");if(H._rightFrameWidth>G){H.elements.rightFrame.setStyle("width",p.CSS.DIMENSIONS.RIGHTFRAME.MINWIDTH)}else{H.elements.rightFrame.setStyle("width",H._rightFrameWidth)}setTimeout(function(){H.elements.rightFrame.setStyle("transition","none")},200)}}else{H._toggleMode(2)}H.views.header.iconBar.resize()},_closeBottomFrame:function(){var G=this;G.elements.bottomFrame.setStyle("transition","height 200ms");G.elements.bottomFrame.setStyle("height",0);G.elements.bottomFrameCollapserButton.removeClassName(p.CSS.ELEMENTS.BOTTOMFRAMECOLLAPSERBUTTONCLOSE);G.elements.bottomFrameCollapserButton.addClassName(p.CSS.ELEMENTS.BOTTOMFRAMECOLLAPSERBUTTONOPEN);G.bottomFrameIsClosed=true;setTimeout(function(){G.elements.bottomFrame.setStyle("transition","none")},200)},_showBottomFrame:function(){var G=this;G.elements.bottomFrame.setStyle("transition","height 200ms");G.elements.bottomFrame.setStyle("height",p.CSS.DIMENSIONS.BOTTOMFRAME.HEIGHT);G.elements.bottomFrameCollapserButton.removeClassName(p.CSS.ELEMENTS.BOTTOMFRAMECOLLAPSERBUTTONOPEN);G.elements.bottomFrameCollapserButton.addClassName(p.CSS.ELEMENTS.BOTTOMFRAMECOLLAPSERBUTTONCLOSE);G.bottomFrameIsClosed=false;setTimeout(function(){G.elements.bottomFrame.setStyle("transition","none")},200)},_closeRightFrame:function(){var G=this;G.elements.rightFrame.setStyle("transition","width 200ms");G.elements.rightFrame.addClassName(p.CSS.ELEMENTS.FRAMECLOSED);G.elements.innerRight.setStyle("visibility","hidden");G.elements.rightFrame.setStyle("width",0);G.elements.rightFrameCollapserButton.removeClassName(p.CSS.ELEMENTS.RIGHTFRAMECOLLAPSERBUTTONCLOSE);G.elements.rightFrameCollapserButton.addClassName(p.CSS.ELEMENTS.RIGHTFRAMECOLLAPSERBUTTONOPEN);G.rightFrameIsClosed=true;setTimeout(function(){G.elements.rightFrame.setStyle("transition","none")},200)},_showRightFrame:function(){var G=this;G.elements.rightFrame.setStyle("transition","width 200ms");G.elements.rightFrame.removeClassName(p.CSS.ELEMENTS.FRAMECLOSED);G.elements.innerRight.setStyle("visibility","visible");G.elements.rightFrame.setStyle("width",G._rightFrameWidth);G.elements.rightFrameCollapserButton.removeClassName(p.CSS.ELEMENTS.RIGHTFRAMECOLLAPSERBUTTONOPEN);G.elements.rightFrameCollapserButton.addClassName(p.CSS.ELEMENTS.RIGHTFRAMECOLLAPSERBUTTONCLOSE);G.rightFrameIsClosed=false;setTimeout(function(){G.elements.rightFrame.setStyle("transition","none")},200)},_toggleMode:function(H){var G=this;if(!k.is(H,"number")){throw new Error(j.replace(j.error.common.incorrectArgument,{arg:0,type:"Number"}))}else{if(!p.CSS.LAYOUTS.MODE.hasOwnProperty(H)){throw new Error(j.replace(j.error.manager.unsupportedMode,{mode:H}))}}if(H!==G._currentMode){if(H===1){G.container.removeClassName("isu-am-catalog-only")}else{if(H===2){G.container.addClassName("isu-am-catalog-only");G.elements.rightFrame.setStyle("width","calc(100%)");G.elements.innerRight.setStyle("visibility","visible")}}G._currentMode=H}},_onBottomFrameCollapserClick:function(){var G=this;if(G.elements.bottomFrame.clientHeight===0){G._showBottomFrame()}else{G._closeBottomFrame()}G._updatePreferences()},_onRightFrameCollapserClick:function(){var G=this;if(G.elements.rightFrame.clientWidth===0){G._showRightFrame()}else{G._closeRightFrame()}G._updatePreferences()},_onKeyDown:function(I){var H=this;var G=k.Event.whichKey(I);if(H._onKeyDownCallbacks.hasOwnProperty(G)){H._onKeyDownCallbacks[G].call(H,I)}},_onKeyDownCallbacks:{right:function(){this.contextualMenu.hide();this.views.catalog.goToNext()},"shift+right":function(){this.contextualMenu.hide();this.views.catalog.goToNext(true)},left:function(){this.contextualMenu.hide();this.views.catalog.goToPrevious()},"shift+left":function(){this.contextualMenu.hide();this.views.catalog.goToPrevious(true)},down:function(){this.contextualMenu.hide();this.views.catalog.goToNextLine()},"shift+down":function(){this.contextualMenu.hide();this.views.catalog.goToNextLine(true)},up:function(){this.contextualMenu.hide();this.views.catalog.goToPreviousLine()},"shift+up":function(){this.contextualMenu.hide();this.views.catalog.goToPreviousLine(true)},"ctrl+a":function(G){G.preventDefault();this.contextualMenu.hide();this.collection.selectAll()}},_onRequestUploadFile:function(I){var H=this;var G=I.fileList;H._addFiles(G)},_addFiles:function(P){var K=this;if(K.collection.size()===0){K._showRightFrame()}var L=function(V){this.set("isCancelable",true);this.set("request",V)};var M=function(W){if(W.lengthComputable){var V=W.loaded/W.total;this.set("requestProgress",V)}};var N=function(){this.set("isCancelable",false);this.set("request",null)};var G=[];var H=[];for(var J=0;J<P.length;J++){var I=P[J];var R="temporary_"+Math.floor(Date.now())+"_"+J;var U=I.type;var T={id:R,title:I.name,type:"Document",owner:{firstName:e.getUser().firstName,fullName:e.getUser().firstName.trim()+" "+e.getUser().lastName.trim(),lastName:e.getUser().lastName,user:e.getUser().login},relOwner:{firstName:e.getUser().firstName,fullName:e.getUser().firstName.trim()+" "+e.getUser().lastName.trim(),lastName:e.getUser().lastName,user:e.getUser().login},relOriginated:(new Date()).toString()};if(I.hasOwnProperty("lastModifiedDate")){if(I.lastModifiedDate instanceof Date){T.modified=I.lastModifiedDate.toString();T.created=I.lastModifiedDate.toString()}else{T.modified=(new Date(I.lastModifiedDate)).toString();T.created=(new Date(I.lastModifiedDate)).toString()}}else{T.modified=(new Date()).toString();T.created=(new Date()).toString()}var Q=new c(T);Q.set("isProcessing",true);Q.setDocumentTypeByMIME(U);G.push(Q);var O=function(W){var V=this;return{file:{tempId:V.tempId,type:V.type},response:W}};var S=o.uploadFile(I,K.collection.id,{onCheckinStart:L.bind(Q),onCheckinProgress:M.bind(Q),onCheckinComplete:N.bind(Q)});H.push(S.then(O.bind({tempId:R,type:U}))["catch"](O.bind({tempId:R,type:U})))}K.collection.add(G,{sort:false});return g.all(H).then(function(X){var Z=[];var ab=0;var V=[];for(var Y=0;Y<X.length;Y++){var ad=X[Y].file.tempId;var af=X[Y].file.type;var W=X[Y].response;if(W.success){ab++;var aa=W.data[0];var ae=o.parseDocument(aa);ae.relOwner={firstName:e.getUser().firstName,fullName:e.getUser().firstName.trim()+" "+e.getUser().lastName.trim(),lastName:e.getUser().lastName,user:e.getUser().login};ae.relOriginated=(new Date()).toString();var ac=new c(ae);ac.set("iconUrl",ac.get("thumbnailUrl"));ac.setDocumentTypeByMIME(af);K.collection.remove(ad);K.collection.add(ac);V.push(ac);Z.push(ac.id)}else{K.collection.get(ad).set("isFailed",true);K.collection.get(ad).set("isProcessing",false);K.collection.get(ad).set("isCancelable",false);K.collection.get(ad).set("request",null);if(W instanceof Error){K._logger.error(W)}}}if(ab>0){if(ab===X.length&&V.length===1&&V[0].get("documentType")==="image"){K._onRequestSetAsPrimary({item:V[0],lock:false})}else{K.dispatchEvent("onUpdate",{objects:[{physicalId:K.collection.id}]})}A.displayNotification({msg:j.replace(j.notifications.Upload.success,{count:ab}),eventID:"info"});K.container.removeClassName(p.CSS.ELEMENTS.IS_EMPTY)}if(ab!==X.length){A.displayNotification({msg:j.replace(j.notifications.Upload.failure,{count:X.length-ab}),eventID:"error"})}if(Z.length){o.downloadDocuments(Z).then(function(ai){for(var ah=0;ah<ai.length;ah++){var aj=ai[ah].id;var ag=K.collection.get(aj);if(ag){if(ai[ah].downloadUrl&&ai[ah].errorMessage===undefined){ag.set("contentUrl",ai[ah].downloadUrl)}}}})}})["catch"](function(V){K._logger.error(V)})},_onRequestAttachFrom3DX:function(){var J=this;var K=l.get("application");var M=k.is(K,"object")&&K.isStandalone;if(M){var I=l.get("component");if(k.is(I,"object")&&k.is(I.taskManager,"object")){var H=I.taskManager.addObjectsTask(function L(O){if(Array.isArray(O.physicalIds)){var N=O.physicalIds;o.fetch(N).then(function(P){if(!k.is(P.results,"array")||P.results.length!==N.length){throw new Error("Unexpected number of fetch results for attachments.")}else{var Q=P.results.map(function(R){return o.parseFromFetch(R)});return J._add3DXObjects(Q)}})["finally"](function(){I.unmaskForTask(H)})}else{I.unmaskForTask(H)}},function G(){I.unmaskForTask(H)});I.maskForTask(H)}else{}}else{m.search({title:j.Attach.SearchTitle,default_search_criteria:"",multiSel:true,callback:function(N){var O=N.map(function(P){return o.parseFromSearch(P)});J._add3DXObjects(O)},cancel:function(){}})}},_onRequestAttachFromLocalDisk:function(){var H=this;var G=o.browseFileFromLocalDisk()["catch"](function(I){A.displayNotification({msg:j.replace(j.notifications.BrowseFile.failure),eventID:"error"});H._logger.error(I)});G.then(function(I){return H._addFiles(I)})},_add3DXObjects:function(L){var K=this;var G=L.filter(function(O){return K.collection.get(O.id)===undefined});if(G.length!==L.length){A.displayNotification({msg:j.replace(j.notifications.Attach.alreadyAttached,{count:L.length-G.length}),eventID:"warning"})}if(G.length>0){if(K.collection.size()===0){K._showRightFrame()}var N=[];for(var I=0;I<G.length;I++){var H=G[I];H.relOwner={firstName:e.getUser().firstName,fullName:e.getUser().firstName.trim()+" "+e.getUser().lastName.trim(),lastName:e.getUser().lastName,user:e.getUser().login};H.relOriginated=(new Date()).toString();var J=new c(H);J.set("isProcessing",true);N.push(J)}K.collection.add(N,{sort:false});var M=G.map(function(O){return O.id});o.connectDocumentsToParent(M,K.collection.id).then(function(S){var X=0;var Q=[];var P=[];var U=[];for(var T=0;T<S.length;T++){var O=S[T].documentId;var R=S[T].response;var V=K.collection.get(O);if(R.success){X++;Q.push(V);P.push(O);if(V.get("type")==="Document"){U.push(O)}}else{V.set("isFailed",true);V.set("isProcessing",false)}}K.collection.sort();if(X>0){if(X===S.length&&Q.length===1&&Q[0].get("documentType")==="image"){K._onRequestSetAsPrimary({item:Q[0],lock:false})}else{K.dispatchEvent("onUpdate",{objects:[{physicalId:K.collection.id}]})}A.displayNotification({msg:j.replace(j.notifications.Attach.success,{count:X}),eventID:"info"});K.container.removeClassName(p.CSS.ELEMENTS.IS_EMPTY)}if(X!==S.length){A.displayNotification({msg:j.replace(j.notifications.Attach.failure,{count:S.length-X}),eventID:"error"})}var W=[g.resolve()];if(P.length>0){W.push(o.fetch(P).then(function(Z){for(var ab=0;ab<Z.results.length;ab++){var af=Z.results[ab].attributes.find(function(ag){return ag.name==="resourceid"}).value;var aa=K.collection.get(af);if(aa){var ad=Z.results[ab].attributes.find(function(ag){return ag.name==="ds6w:label"});if(ad&&ad.value){aa.set("title",ad.value)}var Y=Z.results[ab].attributes.find(function(ag){return ag.name==="owner"});var ac=Z.results[ab].attributes.find(function(ag){return ag.name==="ds6w:responsible"});if(Y&&Y.value&&ac&&ac.value){aa.set("owner",{user:Y.value,fullName:ac.value,firstName:"",lastName:""})}var ae=Z.results[ab].attributes.find(function(ag){return ag.name==="ds6w:docextension"});if(ae&&ae.value){aa.setDocumentType(ae.value)}aa.set("isProcessing",false)}}})["catch"](function(Y){A.displayNotification({msg:j.replace(j.notifications.Fetch.failure),eventID:"error"});K._logger.error(Y)}))}if(U.length>0){W.push(o.downloadDocuments(U).then(function(aa){for(var Z=0;Z<aa.length;Z++){var ab=aa[Z].id;var Y=K.collection.get(ab);if(Y){if(aa[Z].downloadUrl&&aa[Z].errorMessage===undefined){Y.set("contentUrl",aa[Z].downloadUrl)}}}})["catch"](function(Y){A.displayNotification({msg:j.replace(j.notifications.Download.failure),eventID:"error"});K._logger.error(Y)}))}})["catch"](function(O){K._logger.error(O)})}},_onRequestOpenWith:function(I){var L=I.objects;var M=I.app;var J=I.context;var H=I.arguments;var G=l.get("component");if(k.is(G,"object")&&k.is(G.utils,"object")&&k.is(G.utils.setTypesCallbackForOFW,"function")){var K=L.reduce(function(O,N){O.push(N.id);return O},[]);G.utils.setTypesCallbackForOFW(K)}M.handler.apply(J,H)},_onRequestDownloadFile:function(){var I=this;var H=I.collection.getSelectedItems();var G=H.map(function(J){return J.id});if(G.length>0){o.downloadDocuments(G,G.length>1).then(function(K){var L=K[0].downloadUrl;var M=k.createElement("a",{id:"download-image",target:"_blank"});M.href=L;var J=document.createEvent("MouseEvents");J.initEvent("click",false,true);M.dispatchEvent(J)})["catch"](function(J){A.displayNotification({msg:j.replace(j.notifications.Download.failure),eventID:"error"});I._logger.error(J)})}},_onRequestAnnotate:function(){var G=this;var H=l.get("widget")||window.widget;f.Mask.mask(H.body);G.options.annotationPreLaunchCallback.call(G);var I=G.collection.getSelectedItems()[0];var J=new g(function(M,L){var K={className:p.CSS.ELEMENTS.ANNOTATION,saveCallback:G._annotationSaveCallback.bind(G),exitCallback:G._annotationExitCallback.bind(G)};if(I&&I.get("contentUrl")){o.downloadDocuments([I.id]).then(function(N){if(N.length===1&&N[0].id===I.id){I.set("contentUrl",N[0].downloadUrl);K.imageURL=I.get("contentUrl");M(K)}else{throw new Error("Unexpected downloadDocuments response when launching Annotation from Attachment.")}})["catch"](L);return}else{if(G.annotationCanvasTarget!==null&&G.annotationCanvasTarget!==undefined){K.captureTarget=G.annotationCanvasTarget}else{if(G.annotationCanvasDefaultDimensions!==null&&G.annotationCanvasDefaultDimensions!==undefined){K.defaultDimensions=G.annotationCanvasDefaultDimensions}}}M(K)});J.then(function(L){var K=new t(L);K.render();return K.isLoaded.then(function(){K.container.inject(H.body);G.annotation=K})})["catch"](function(K){if(G.annotation){G.annotation.destroy();G.annotation=null}A.displayNotification({msg:j.replace(j.notifications.Annotation.initFailure),eventID:"error"});G._logger.error(K)})["finally"](function(){f.Mask.unmask(H.body)})},_annotationSaveCallback:function(L){var J=this;var K=l.get("widget")||window.widget;F.mask(K.body);F.mask(J.annotation.immersiveFrame.elements.container);var N=J.collection.id;var G=new Date().toLocaleString();G=G.replace(p.ILLEGAL_CHARACTERS,"-");var M=j.replace(j.annotate.defaultName,{date:G});var H=new File([L.blob],M,{type:"image/png",lastModified:Date.now()});o.uploadFile(H,N).then(function(O){A.displayNotification({msg:j.replace(j.notifications.Annotation.uploadSuccess,{fileName:M}),eventID:"info"});if(O&&O.data&&O.data.length>0&&O.data[0].id){var Q=O.data[0];return o.setAsPrimary(Q.id,N).then(function(R){J.dispatchEvent("onUpdate",{objects:[{physicalId:N}]});var S=JSON.parse(R);if(Q.id===S.documentId){A.displayNotification({msg:j.notifications.SetAsPrimary.success,eventID:"info"})}J.refresh()},function P(R){A.displayNotification({msg:j.notifications.SetAsPrimary.failure,eventID:"error"});J.annotation._logger.error(R)})}else{return g.reject(new Error("Unexpected empty response for upload."))}},function I(O){A.displayNotification({msg:j.notifications.Annotation.uploadFailure,eventID:"error"});J._logger.error(O)})["finally"](function(){J.options.annotationSaveCallback(L);F.unmask(K.body);F.unmask(J.annotation.immersiveFrame.elements.container);J.annotation.destroy();J.annotation=null})},_annotationExitCallback:function(G){this.options.annotationExitCallback(G);this.annotation.destroy();this.annotation=null},_onRequestDetach:function(){var K=this;var I=K.collection.getSelectedItems();var H=[];for(var G=0;G<I.length;G++){var J=I[G];J.set("isProcessing",true);H.push(J.id)}K.collection.unselectAll();o.disconnectDocumentsFromParent(H,K.collection.id).then(function(L){var Q=0;var N=[];for(var M=0;M<L.length;M++){var R=L[M].documentId;var P=L[M].response;var O=K.collection.get(R);if(P.success){Q++;if(O.get("isPrimary")===true){N.push(o.unsetAsPrimary(K.collection.id))}K.collection.remove(O)}else{O.set("isProcessing",false)}}if(Q>0){K.dispatchEvent("onUpdate",{objects:[{physicalId:K.collection.id}]});A.displayNotification({msg:j.replace(j.notifications.Detach.success,{count:Q}),eventID:"info"})}if(Q!==L.length){A.displayNotification({msg:j.replace(j.notifications.Detach.failure,{count:L.length-Q}),eventID:"error"})}if(N.length>0){g.all(N).then(function(){K.dispatchEvent("onUpdate",{objects:[{physicalId:K.collection.id}]})})}if(K.collection.size()===0){K.container.addClassName(p.CSS.ELEMENTS.IS_EMPTY);if(K._currentMode===1){K._closeRightFrame()}}})["catch"](function(L){A.displayNotification({msg:j.replace(j.notifications.Detach.failure),eventID:"error"});K._logger.error(L)})},_onRequestDelete:function(){var H=this;var G=new x({renderTo:H.container,className:p.CSS.ELEMENTS.DELETE_DIALOG});G.confirm(j.Delete.confirm.text,j.Delete.confirm.title,function(I){if(I){var L=H.collection.getSelectedItems();var K=[];for(var J=0;J<L.length;J++){var M=L[J];M.set("isProcessing",true);K.push(M.id)}H.collection.unselectAll();o.deleteDocuments(K).then(function(N){var S=0;var P=[];for(var O=0;O<N.length;O++){var T=N[O].documentId;var R=N[O].response;var Q=H.collection.get(T);if(R.success){S++;if(Q.get("isPrimary")===true){P.push(o.unsetAsPrimary(H.collection.id))}H.collection.remove(Q)}else{Q.set("isProcessing",false)}}if(S>0){H.dispatchEvent("onUpdate",{objects:[{physicalId:H.collection.id}]});A.displayNotification({msg:j.replace(j.notifications.Delete.success,{count:S}),eventID:"info"})}if(S!==N.length){A.displayNotification({msg:j.replace(j.notifications.Delete.failure,{count:N.length-S}),eventID:"error"})}if(P.length>0){g.all(P).then(function(){H.dispatchEvent("onUpdate",{objects:[{physicalId:H.collection.id}]})})}if(H.collection.size()===0){H.container.addClassName(p.CSS.ELEMENTS.IS_EMPTY);if(H._currentMode===1){H._closeRightFrame()}}})["catch"](function(N){A.displayNotification({msg:j.replace(j.notifications.Delete.failure),eventID:"error"});H._logger.error(N)})}},j.Delete.confirm.okButton,j.Delete.confirm.cancelButton)},_onRequestGroupByType:function(){this.collection.groupByType=!this.collection.groupByType;this.collection.sort();this._updatePreferences();this.views.header.iconBar.getItem("groupByType").elements.container.toggleClassName("active",this.collection.groupByType)},_onRequestSort:function(G){this.collection.sortOrder=G.sortOrder;this.collection.sortMode=G.sortMode;this.collection.sort();this._updatePreferences();var H="sort"+(G.sortOrder==="ascending"?"Asc":"Desc")+G.sortMode.charAt(0).toUpperCase()+G.sortMode.slice(1);this.views.header.iconBar.getItem("sort").content.component.setActiveItem(H)},_onRequestCatalogSwitchLayout:function(){this.catalogLayout=this.views.catalog.layout%2+1;this.views.catalog.switchLayout(this.catalogLayout);this._updatePreferences()},_onCatalogSwitchLayout:function(){this.views.header.iconBar.getItem("switchCatalogLayout").elements.icon.toggleClassName("fonticon-view-small-thb",(this.views.catalog.layout+1)%2===1);this.views.header.iconBar.getItem("switchCatalogLayout").elements.icon.toggleClassName("fonticon-view-list",this.views.catalog.layout%2===1);this.contextualMenu.catalogLayout=this.views.catalog.layout},_onRequestSetAsPrimary:function(G){var J=this;var M=J.collection.id;var I=G.item;var H=G.lock;J.views.header.iconBar.disableItem("setAsPrimary");var K=J.collection.filter(function(N){return N.get("isPrimary")===true});var L=K.some(function(N){return N.get("id")===I.get("id")});I.set("isProcessing",true);if(L){o.unsetAsPrimary(J.collection.id).then(function(){I.set("isPrimary",false);J.dispatchEvent("onUpdate",{objects:[{physicalId:M}]});A.displayNotification({msg:j.notifications.UnsetAsPrimary.success,eventID:"info"})})["catch"](function(N){A.displayNotification({msg:j.notifications.UnsetAsPrimary.failure,eventID:"error"});J._logger.error(N)})["finally"](function(){I.set("isProcessing",false);J.views.header.iconBar.enableItem("setAsPrimary")})}else{o.setAsPrimary(I.get("id"),M,H).then(function(N){var P=JSON.parse(N);if(I.get("id")===P.documentId){for(var O=0;O<K.length;O++){K[O].set("isPrimary",false)}I.set("isPrimary",true);J.dispatchEvent("onUpdate",{objects:[{physicalId:M}]});A.displayNotification({msg:j.notifications.SetAsPrimary.success,eventID:"info"})}})["catch"](function(N){A.displayNotification({msg:j.notifications.SetAsPrimary.failure,eventID:"error"});J._logger.error(N)})["finally"](function(){I.set("isProcessing",false);J.views.header.iconBar.enableItem("setAsPrimary")})}},_onDrop:function(I){var H=this;I.preventDefault();I.stopPropagation();var J=o.parseFromDragEvent(I);if(J.hasOwnProperty("files")&&(J.files instanceof FileList)){H._addFiles(J.files)}else{if(f.isValid3DXContent(J)){var G=J.data.items.map(function(K){return K.objectId});o.fetch(G).then(function(K){if(k.is(K.results,"array")){var L=K.results.map(function(M){return o.parseFromFetch(M)});H._add3DXObjects(L)}else{throw new Error("Unexpected empty fetch results.")}})["catch"](function(K){A.displayNotification({msg:j.replace(j.notifications.Attach.failure,{count:G.length}),eventID:"error"});H._logger.error(K)})}else{A.displayNotification({msg:j.notifications.Drop.unsupported,eventID:"error"})}}},_onPasteEvent:function(M){var L=this;M.preventDefault();M.stopPropagation();var H=M.clipboardData.items;if(H!==undefined&&H.length>0){var I=[];for(var J=0;J<H.length;J++){var K=H[J];if(K.type.indexOf("image")!==-1){var G=K.getAsFile();I.push(G)}else{break}}if(I.length>0){L._addFiles(I)}}},_addDropEvent:function(I){var H=this;if(H.authoring){var G=0;I.addEventListener("drop",function(){I.removeClassName("dragenter");H._onDrop.apply(H,arguments)});I.addEventListener("dragenter",function(){I.addClassName("dragenter");G++});I.addEventListener("dragleave",function(){G--;if(G<=0){I.removeClassName("dragenter")}});I.addEventListener("mouseenter",function(){if(I.hasClassName("dragenter")){G++}});I.addEventListener("mouseleave",function(){if(I.hasClassName("dragenter")){G--;if(G<=0){I.removeClassName("dragenter")}}});I.addEventListener("dragover",function(J){J.preventDefault();J.dataTransfer.dropEffect="copy";J.dataTransfer.effectAllowed="copy"})}},_updatePreferences:function(){var G=this;var H=l.get("widget")||window.widget;H.setValue("attachmentManagerPreferences",{mode:G._currentMode,catalogLayout:G.views.catalog.layout,catalogVisibility:!G.rightFrameIsClosed,catalogWidth:G._rightFrameWidth,sliderVisibility:!G.bottomFrameIsClosed,groupByType:G.collection.groupByType,sortMode:G.collection.sortMode,sortOrder:G.collection.sortOrder});G.views.header.refresh()}});return w});