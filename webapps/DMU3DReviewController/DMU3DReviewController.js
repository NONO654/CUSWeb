define("DS/DMU3DReviewController/DMU3DReviewController",["UWA/Class","DS/DMUPersistence/DMULoadMarkupServices","DS/DMUBaseExperience/DMUContextManager","DS/DMUBaseExperience/EXPManagerSet","DS/ApplicationFrame/CommandsManager","DS/PADUtils/views/PADProgressBar","DS/DMUMeasurable/DMUToolsSceneGraph","DS/Selection/CSOManager","DS/CoreEvents/ModelEvents","DS/DMUControls/DMU2DSheetManager","DS/DMUPlaySlide/controllers/DMUSlideShowController","DS/PADUtils/PADUtilsServices","DS/PADUtils/PADSettingsMgt","DS/VisuDataAccess/Ox4TypeHelper","DS/DMUBaseExperience/EXPUtils","DS/DMUPlaySlide/DMUSlideServices","i18n!DS/DMU3DReviewController/assets/nls/DMU3DReviewController"],function(o,e,s,l,a,g,f,q,k,r,d,i,h,t,c,p,m){var b=o.extend({init:function(L){this._parent(L);var x=L||{};var H=false;var R=x.ctxViewer;var O=this;var T=new k(),I;var D={},N=null,F={},y;var K,u,P;var E,V,z,U;var A;function S(){var X=s.getReviewContext({context:R});if(X){var ac=q.get();if(ac.length){var ab=X.getCurrentReview();if(ab&&!ab.isReadOnly()&&ab.getCurrentSlide()){var ag=false,Z=false,aa=null,ad=false;for(var af=0;af<ac.length;af++){aa=f.getLastReference(ac[af].pathElement);if(c.getTypeLastElement(ac[af])){ag=true;break}if(aa&&f.isReference(aa.getLastElement(true))){Z=true}}if(!ag){var ae=ac[ac.length-1];if(ae&&ae.event&&ae.event.lastPosition&&ae.event.startPosition&&ae.event.startPosition.equals(ae.event.lastPosition)){ad=true}var W=Z?[{name:"DMUHideShowOverloadStr",line:1,hdr_list:["DMUHideShowOverloadHdr"]}]:[];if(aa&&aa.externalPath&&aa.externalPath.length){W.push({name:"DMUColorOpacityOverloadStr",line:1,hdr_list:["DMUColorOpacityOverloadHdr"]})}var Y=aa?aa.getParentPath():null;if(ad&&Y&&!Y.isEqual(R.getRootBagPath())){W.push({name:"DMULevelSelectorStr",line:1,hdr_list:["DMULevelSelectorHdr"]})}return{cmdList:W}}}}}return{cmdList:[]}}function M(ah,ab){if(P&&P.getActiveState()){return{cmdList:[]}}var ag=q.get();if(!ag.length){var aa=R.getViewer().pick({xPix:ab.XmousePositionWithDevPxRatio,yPix:ab.YmousePositionWithDevPxRatio},"mesh",true).path;if(aa.length===0){return{cmdList:[{line:1,name:"VisuV6EnvStr",hdr_list:["VisuV6Env"]},{line:1,name:"VisuCleanSpaceEnvStr",hdr_list:["VisuCleanSpaceEnv"]},{line:1,name:"VisuDarkBlueEnvStr",hdr_list:["VisuDarkBlueEnv"]},{line:1,name:"VisuDarkGreyEnvStr",hdr_list:["VisuDarkGreyEnv"]},{line:1,name:"VisuShinyEnvStr",hdr_list:["VisuShinyEnv"]},{line:1,name:"VisuNoEnvStr",hdr_list:["VisuNoEnv"]}]}}return{cmdList:[]}}var X=s.getReviewContext({context:R});var ad=X?X.getCurrentReview():null;var ac=[];var W=false,Z=true,Y=false;for(var ai=0;ai<ag.length;ai++){if(ad&&!ad.isReadOnly()&&ad.getCurrentSlide()){Y=true;var af=ad.getDMUObjectFromPathElement(ag[ai].pathElement,false,false);if(af&&af.GetType&&af.GetType()==="DMUOccurrenceOverloader"&&af.isOverloadedInCurrentSlide()){W=true}}if(Z){for(var ae=0;ae<ag[ai].pathElement.externalPath.length;ae++){if(ag[ai].pathElement.externalPath[ae].getDMUType){Z=false}}}}if(Z&&Y){ac=[{line:1,name:"FocusOn",hdr_list:["FocusOnHdr"]},{line:1,name:"ReframeOn",hdr_list:["ReframeOnHdr"]},{line:1,name:"DMUHideShowOverloadStr",hdr_list:["DMUHideShowOverloadHdr"]},{line:1,name:"EditPropertiesCmd",hdr_list:["ActionBar_Attributes"]},{line:1,name:"SwitchVisuOnDemandStr",hdr_list:["SwitchVisuOnDemandHdr"]}]}else{if(Z){ac=[{line:1,name:"FocusOn",hdr_list:["FocusOnHdr"]},{line:1,name:"ReframeOn",hdr_list:["ReframeOnHdr"]},{line:1,name:"EditPropertiesCmd",hdr_list:["ActionBar_Attributes"]},{line:1,name:"SwitchVisuOnDemandStr",hdr_list:["SwitchVisuOnDemandHdr"]}]}}if(W){ac.unshift({line:1,name:"DMURemoveOverloadStr",hdr_list:["DMURemoveOverloadHdr"]})}return{cmdList:ac}}function C(){setTimeout(function(){var Z;if(!R){return}var W=H&&R.getViewer().getVisibleSpace()!==0&&f.getRoots(R).length!==0;var Y=["CATWebUXSlideShowHdr","loadCmdHdr","saveCmdHdr","measureCmdHdr","thicknessCmdHdr","sectionCmdHdr","LockUnlockSectionHdr","markerTextCmdHdr","markerCircleCmdHdr","markerArrowCmdHdr","markerPictureCmdHdr","marker2DTextCmdHdr","marker2DPictureCmdHdr","slideCmdHdr","slidePlayCmdHdr","3DcompareCmdHdr","normalViewCmdHdr"];for(var X=0;X<Y.length;X++){Z=a.getCommand(Y[X],R.getCommandContext());if(!Z){Z=a.getCommandCheckHeader(Y[X],R.getCommandContext())}if(Z){if(W&&!Z.isPermanentlyDisabled){Z.enable()}else{Z.disable()}}}})}function w(X){var W;K.load2DDocument({phyID:X,parentNode:R.getRootBagPath().getChildrenPathes()[0].getLastElement(true),onLoadingStarted:function(){g.on();W=1},onComplete:function(){if(W){g.off();W=0}},onFailure:function(){R.removeRoots({pids:[X]});R.displayNotification({msg:m.fileWithNoSVG,eventID:"error"});if(W){g.off();W=0}}})}function Q(Y,ab){var Z=[];var W=f.getRoots(R);for(var X=0;X<W.length;X++){if(!Y||f.getNodeType(W[X])===Y){var aa=f.getNodeID(W[X]);if(aa!==ab){Z.push(aa)}}}R.removeRoots({pids:Z})}function G(W,Y){try{t.InitWithUrl(i.get3DSpaceUrl(),h.getSetting("x3dPlatformId"),"passport");if(t.IsInit()){t.GetParentsBusType(W,function(Z){Y([W].concat(Z))})}else{Y()}}catch(X){Y()}}function J(Z){if(!H){return}if(K){K.clean2DDocument()}var aa=f.getNodeID(Z.getLastElement()),W=f.getNodeType(Z.getLastElement());var Y=function(){if(A){Q(A,aa);A=undefined}if(u!=="3D"){O.publish("onReviewContextModified",{type:"3D"})}u="3D";C()};var X=function(){if(u!=="2D"){O.publish("onReviewContextModified",{type:"2D"})}u="2D";A=W;Q(null,aa);var ab=setInterval(function(){if(R.getRootBagPath().getChildrenPathes().length===1){clearInterval(ab);w(aa)}},100);C()};if(W==="Drawing"&&Z.getParentPath().isEqual(R.getRootBagPath())){X()}else{G(f.getNodeType(Z.getLastElement(true)),function(ab){if(ab&&ab.length&&ab.indexOf("Drawing")!==-1&&Z.getParentPath().isEqual(R.getRootBagPath())){X()}else{Y()}})}C()}function B(W){if(!H){return}if(P&&P.getActiveState()){P.setActiveState(false)}J(W.path)}function v(){if(!H){return}if(P&&P.getActiveState()){P.setActiveState(false)}if(K){K.clean2DDocument()}C();if(!R.getRootBagPath().getChildrenPathes().length){s.setReviewContext({context:R})}}this.setActiveState=function(ad){if(ad===H){return}H=ad;if(H){R.setLoadingDelegations({_Markup:function(ae){if(H&&O&&ae){i.multiTenantMgt([ae],f.getRoots(R),function(af){if(!af.isMultiTenant){O.loadReview(ae.objectId)}})}}});I=e.getLoadMarkupServices({context:R});F.onReviewLoaded=I.subscribe("onReviewLoaded",function(ae){O.publish("onReviewLoaded",ae)});F.onReviewLoadFailed=I.subscribe("onReviewLoadFailed",function(ae){O.publish("onReviewLoadFailed",ae)});y=R.getFrameWindow().getActionBar().onActionBarReady(C);if(!K){K=new r({ctxViewer:R});l.addManager({name:"DMU2DSheetManager",context:R.getFrameWindow(),manager:K})}if(!P){P=new d({context:R})}D.onRootAdded=R.subscribe({event:"onRootAdded"},B);D.onRootRemoved=R.subscribe({event:"onRootRemoved"},v);D.onRootAttached=R.subscribe({event:"onRootAttached"},B);D.onRootDetached=R.subscribe({event:"onRootDetached"},v);N=R.getViewer().onSwapVisibleSpace(C);if(R.getFrameWindow().removeReviewModel){R.getFrameWindow().removeReviewModel()}var W=s.getSavedReviewContext({context:R});if(W&&W.isInitialized()){s.setReviewContext({context:R,controller:W});W.setActiveFlag(true)}s.setSavedReviewContext({context:R});U=R.getViewer().sectionCappingEnabled;R.getViewer().setSectionCapping(true);z=R.isRobotVisible();if(z){R.setRobotVisibility(false)}R.getFrameWindow().getContextualUIManager().register({subscriberId:"3DReviewWebAppCtxElements",workbenchName:"DMU3DReviewController",context:R.getCommandContext(),module:"DMU3DReviewController",cmdPrefix:"",directory:"assets/afr/",merge:true,onContextualBarReady:S,onContextualMenuReady:M});E=R.isDefaultContextualBarVisible();if(E){R.setDefaultContextualBarVisibility(false)}V=R.isDefaultContextualMenuVisible();if(V){R.setDefaultContextualMenuVisibility(false)}p.setSlidePreferences({context:R.getFrameWindow(),preferences:{playMode:false,displayNominal:true,publisher:O}});if(R.getRootBagPath()&&R.getRootBagPath().getChildrenPathes().length===1){J(R.getRootBagPath().getChildrenPathes()[0])}}else{R.setLoadingDelegations({});R.getFrameWindow().getActionBar().removeCallback(y);R.getFrameWindow().getContextualUIManager().unregister("3DReviewWebAppCtxElements");if(E!==undefined){R.setDefaultContextualBarVisibility(E)}E=undefined;if(V!==undefined){R.setDefaultContextualMenuVisibility(V)}V=undefined;if(z!==undefined){R.setRobotVisibility(z)}z=undefined;if(U!==undefined){R.getViewer().setSectionCapping(U)}U=undefined;if(K.isADocumentDisplayed()){K.clean2DDocument();var ab=[];var X=f.getRoots(R);for(var Y=0;Y<X.length;Y++){ab.push(f.getNodeID(X[Y]))}R.removeRoots({pids:ab})}else{var ac=s.getReviewContext({context:R});if(ac){ac.setActiveFlag(false);s.setSavedReviewContext({context:R,controller:ac});s.setReviewContext({context:R})}}q.empty();var aa=Object.keys(D),Z;for(Z=0;Z<aa.length;Z++){R.unsubscribe(D[aa[Z]])}D={};aa=Object.keys(F);for(Z=0;Z<aa.length;Z++){I.unsubscribe(F[aa[Z]])}F={};if(P){P.clean();P=null}if(N){R.getViewer().unsubscribe(N);N=null}l.removeManager({name:"DMU2DSheetManager",context:R.getFrameWindow()});K=null;e.unreferenceLoadMarkupServices({context:R})}C()};this.subscribe=function(X,W){if(!X||!W||!T){return undefined}return T.subscribe({event:X},W)};this.unsubscribe=function(W){if(T&&W){T.unsubscribe(W)}};this.getActiveState=function(){return H};this.clearController=function(){O.setActiveState(false);R=O=T=D=K=null};this.loadReview=function(W){var X=false;var Y=s.getReviewContext({context:R});if(Y){X=Y.checkCurrentReviewInSession(W)}if(W&&X===false&&I){I.load(W)}};this.refreshContext=function(){var W=s.getReviewContext({context:R});if(W){W.refreshNode();R.getViewer().render()}};this.publish=function(X,W){if(H){T.publish({event:X,data:W,context:O})}}}});var n=[];var j=o.singleton({init:function(){},give3DReviewController:function(v){if(v&&v.context){for(var u=0;u<n.length;u++){if(n[u].context===v.context){return n[u].controller}}}return undefined},get3DReviewController:function(v){var w;if(v&&v.context){w=this.give3DReviewController(v);if(!w){var u=new b({ctxViewer:v.context});w=Object.freeze({setActiveState:function(x){if(u){u.setActiveState(x)}},getActiveState:function(){if(u){return u.getActiveState()}return undefined},subscribe:function(x,y){if(u){return u.subscribe(x,y)}return undefined},unsubscribe:function(x){if(u){u.unsubscribe(x)}},clearController:function(){if(u){u.clearController();u=null}},loadReview:function(x){if(u){u.loadReview(x)}},refreshContext:function(){if(u){u.refreshContext()}},publish:function(y,x){if(u){u.publish(y,x)}}});n.push({context:v.context,controller:w})}}return w},unreference3DReviewController:function(v){if(v&&v.context){for(var u=0;u<n.length;u++){if(n[u].context===v.context){n[u].controller.clearController();n.splice(u,1);break}}}}});return j});