/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/CAT3DComposeRobot/CAT3DComposeRobot",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Robot/FreeRobot","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/Selection/PSOManager","DS/SceneGraphNodes/AxisSystemNode","DS/Mesh/MeshUtils","DS/CAT3DComposeConstraints/CAT3DComposeConstraintsController","DS/CoreEvents/Events","DS/Visualization/Node3D","DS/CAT3DComposeCommands/CATC3DDefaultSelectionFilter","DS/CATC3DGeometry/CATC3DGeometryEnums","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/CAT3DComposeMoveManager/CATC3DMoveReferent","DS/CAT3DComposeMoveManager/CAT3DComposeMoveManager","DS/CATRelatedData3DGrid/CATRelatedData3DGridController","DS/Visualization/PathElement"],function(C,D,r,l,A,v,q,g,s,t,p,i,E,m,e,w,f,y){var h=95;var a=150;var o=10,z=4,k=10;var u=function(H){if(!H||!H.externalPath){return false}for(var F=H.externalPath.length-1;F>=0;--F){var G=H.externalPath[F];if(m.isPLMNode(G)){break}if(G.name==="AxisSystems"){return true}}return false};var B=function(H,F,I){var G=z;H.setRatio(G/k);F=setInterval(function(){if(G===(k+1)){clearInterval(F);F=null;return}G++;H.setRatio(4*G/k);I.render()},o)};var b=function(F){var G=[];A.get().forEach(function(H){var I=F.getMoveReferent(H.pathElement);if(I){G.push({path:I})}});return G};var j=function(){A.get().forEach(function(F){if(!l.isIn(F)){l.add(F)}})};var x=function(){var F=A.get();F.forEach(function(G){l.remove(G)})};var c=function(F,H){F.scalingNodeX.setVisibility(false);F.scalingNodeY.setVisibility(false);F.scalingNodeZ.setVisibility(false);var G=(H&&H.hasOwnProperty("translate")&&(typeof H.translate==="boolean"))?H.translate:true;F.arrowX.setVisibility(G);F.arrowY.setVisibility(G);F.arrowZ.setVisibility(G);G=(H&&H.hasOwnProperty("rotate")&&(typeof H.rotate==="boolean"))?H.rotate:true;F.rotationArcXY.setVisibility(G);F.rotationArcXZ.setVisibility(G);F.rotationArcYZ.setVisibility(G);G=(H&&H.hasOwnProperty("translatePlane")&&(typeof H.translatePlane==="boolean"))?H.translatePlane:true;F.translationPlaneXY.setVisibility(G);F.translationPlaneXZ.setVisibility(G);F.translationPlaneYZ.setVisibility(G);G=(H&&H.hasOwnProperty("robotMove")&&(typeof H.robotMove==="boolean"))?H.robotMove:true;F.robotHandle.setVisibility(G)};var d=C.extend({init:function(ag){var ab=ag.context;var F=ab.getFrameWindow();var aL=F.getViewer();var U=w.getMoveManager({context:ab});var av=e.getMoveReferentManager({context:ab});var H=s.getConstraintsController({context:ab});var aQ=F.getContextualUIManager();var aC="";var aw=0;var J=new D.Vector3();var aT=function(aZ){var a0={};var aW=null;if(aZ.translationVector){aW=H.simulateMoveWithCst({translation:aZ.translationVector})}else{if(aZ.rotationMatrix){var aY=[[aZ.rotationMatrix.elements[0],aZ.rotationMatrix.elements[4],aZ.rotationMatrix.elements[8]],[aZ.rotationMatrix.elements[1],aZ.rotationMatrix.elements[5],aZ.rotationMatrix.elements[9]],[aZ.rotationMatrix.elements[2],aZ.rotationMatrix.elements[6],aZ.rotationMatrix.elements[10]]];aW=H.simulateMoveWithCst({rotation:aY})}}if(aW&&aW.matrix){var aX=new D.Matrix4().multiplyMatrices(aW.matrix,aZ.objectMoved.path.getWorldMatrix());a0.worldMatrix=aX}return a0};var aK=function(){var aW=A.get();if(aW.length>1||(H.count()>0&&aW.length===1&&!H.isLevelConstrained(av.getMoveReferent(aW[0].pathElement)))){H.deleteAllCst()}};var aG=true;var aj=i.getDefaultSelectionFilter({context:ab});if(!F){window.console.error("A frame window must be defined");return}if(!ab){window.console.error("A context must be defined");return}if(!U){window.console.error("A move manager component must be defined");return}if(!av){window.console.error("A move referent component must be defined");return}aL.setRobot(true,{snapOnFace:false,showOnlyManipulated:false});var ar=aL.getRobot();c(ar);ar.setAddToCSO(false);ar.setAddToHSO(false);ar.setDisplayScalingNodes(false);ar.setMoveMode("CALLBACK_ONLY");ar.setCheckTarget(false);ar.CallBackEventHandlerViewPoint();var Y=[],az=[],aH=[],W,L,P,ao,af,O={},R,am,aa=null,an=null,aN=[],X=[],ae={origin:new D.Vector3(),initOrigin:new D.Vector3(),direction:null,initValue:null,value:null},ak={origin:null,originVector:null,direction:null,initValue:null,value:null,path:null},aF=false,aU=null;var aS=function(){if(R){R.clear()}};var at=function(){if(am){am.clear()}};var ac=function(){if(az.length){return}az.push(U.subscribe("MoveBegin",function(){af=ar.getMatrix();ao=new D.Matrix4().getInverse(L.getWorldMatrix()).multiply(af)}));az.push(U.subscribe("Move",function(aX){if(ao&&af){if(aX.from===O){return}aS();at();if(this.isVisible()){this.setVisibility(false)}if(aX.moveMode==="Persistent"){var aW=L.getWorldMatrix().multiply(ao);ar.setMatrix(aW)}}}.bind(this)));az.push(U.subscribe("MoveEnd",function(aX){if(ao&&af){if(aX.status==="Cancelled"){ar.setRobotMatrix(af)}if(aX.from===O){return}this.setVisibility(true);if(aX.status==="Moved"){var aW=L.getWorldMatrix().multiply(ao);ar.setRobotMatrix(aW)}aU={};ao=af=undefined}}.bind(this)))}.bind(this);var N=function(){az.forEach(function(aW){U.unsubscribe(aW)});az.length=0};var Q=function(){ar.ScreenPlaneTranslationEndCB({intersection:{}})};var aB=function(aW){if(Array.isArray(aW)){if(L){aW.some(function(aY){var aX=U.getSubPathToMovable(aY.path);if(aX&&aX.isAParentOf(L)){Q();return true}return false})}return 0}return -1};var ai=function(aX){var aY=null;var aW=ab.getRootBagPath().getLastElement(true);aX.some(function(aZ){if(aZ.externalPath.some(function(a0){return aW===a0})){aY=aZ;return true}return false});return aY};var T=function(aY,a0){var a1={pathElement:null};var aX=ab.getRootBagPath().getLastElement(true);if(aX&&aY&&aY.externalPath&&aY.externalPath.some(function(a2){return aX===a2})){a1.pathElement=aY}if(a1.pathElement&&a0&&a0.event){var aZ=a0.event.gesture?a0.event.gesture.getEvents()[0]:a0.event.from[0];var aW=aL.pick(aL.getMousePosition(aZ.getCurrentPosition(aL.canvas)),"primHybrid",false);a1=aj.filterPath({pathElement:ai(aW.path)})}return a1};ar.setSnapFilterCallback(function(aX){var aW=T(aX);return aW.pathElement});ar.setSnapTranslationCallback(function(aX){if(R){var aW=R.getSnappedTranslationVector(aX);if(aW.returnCode!==0){return null}return aW.snappedTranslationVector}return aX.translationVector});ar.setSnapRotationCallback(function(aY){if(am){var aW=am.getSnappedRotationValue(aY);if(aW.returnCode!==0){return{value:undefined,axis:null}}return{value:aW.snappedRotationAngle,axis:aW.axis}}var aX=aY.angle*180/Math.PI;if(ak.direction.dot(aY.axis)<0){aX=360-aX}return{value:aX,axis:aY.axis}});var ad=function(){if(R){R.direction=null;R.origin=new D.Vector3();R.origin3DPos=null;R.setValue(0)}if(am){am.direction=null;am.origin=null;am.originVector=null;am.setValue(0)}aS();at()};var aA=new p("RobotLocalAxisSystem");var V=new q({headLength:10,arrowLength:50,arrowWidth:2,head:q.types.ARROW,colors:{colorX:new g.Color(1,0,0,0),colorY:new g.Color(0,1,0,0),colorZ:new g.Color(0,0,1,0)}});aA.exludeFromBounding(true);aA.setVisibilityFree(true);aA.setVisibilityInTree(false);aA.setPickable(g.NODRAWHL);aA.addChild(V);aA.updateDisplay=function(aW){if(aA.parents.length===0){aL.addNode(aA)}if(aW.visibility&&aW.pathElement&&aW.pathElement.internalPath.length===0){aA.setMatrix(aW.pathElement.getWorldMatrix());aA.setVisibility(true)}if(!aW.visibility){aA.setVisibility(false)}};aA.updateDisplay({visibility:false});var aD=null;var ap=new r("RobotLocalAxisSystem",aL,false,false);ap.exludeFromBounding(true);ap.setVisibilityFree(true);ap.setVisibilityInTree(false);ap.setPickable(g.NODRAWHL);ap.setVisibility(false);c(ap,{robotMove:false,translate:false});ap.updateDisplay=function(aW){if(ap.parents.length===0){aL.addNode(ap)}if(aW.visibility&&aW.pathElement){if(aD){clearInterval(aD);aD=null}ap.setMatrix(aW.pathElement.getWorldMatrix());B(ap.fixedSizeNode3D,aD,aL);ap.setVisibility(true);if(aG){ar.setVisibility(false)}}if(!aW.visibility){clearInterval(aD);aD=null;ap.setVisibility(false);if(aG){ar.setVisibility(true)}}};var aO=function(){require(["DS/LevelSelector/LevelSelector"],function(aW){aW.destroyView()});aQ.hideContextualMenus()};var I=function(){aO();if(L){var aW=[{name:"CAT3DComposeRobotLevelSelectorStr",line:1,hdr_list:["CAT3DComposeRobotLevelSelectorHdr"]}];var aX=b(av).some(function(aY){var aZ=aY.path.getMatrix();if(aZ.elements[0]!==1||aZ.elements[5]!==1||aZ.elements[10]!==1||aZ.elements[15]!==1||aZ.elements[1]!==0||aZ.elements[2]!==0||aZ.elements[3]!==0||aZ.elements[4]!==0||aZ.elements[6]!==0||aZ.elements[7]!==0||aZ.elements[8]!==0||aZ.elements[9]!==0||aZ.elements[11]!==0||aZ.elements[12]!==0||aZ.elements[13]!==0||aZ.elements[14]!==0){return true}return false});if(aX){aW.push({name:"CAT3DComposeSetIdentityPositionStr",line:1,hdr_list:["CAT3DComposeSetIdentityPositionHdr"]})}if(aW.length>0){aQ.showContextualBar({hideWithDistance:true,fillingList:[{onContextualBarReady:function(){return{cmdList:aW}},context:ab.getCommandContext?ab.getCommandContext():null,workbenchName:"CAT3DComposeWidgetWkb",module:"CAT3DComposeWidget",cmdPrefix:""}]})}}};var aP=function(aW){[ar.arrowX,ar.arrowY,ar.arrowZ,ar.translationPlaneYZ,ar.translationPlaneXY,ar.translationPlaneXZ,ar.rotationArcYZ,ar.rotationArcXZ,ar.rotationArcXY].forEach(function(aX){if(aX&&aX.manipulator&&aX.manipulator!==aW){aX.setToGhostState()}});ar.robotHandle.setToGhostState()};var aI=function(){ar.arrowX.mat.opacity=0.2;ar.arrowY.mat.opacity=0.2;ar.arrowZ.mat.opacity=0.2;ar.translationPlaneYZ.planeMat.opacity=0.2;ar.translationPlaneXY.planeMat.opacity=0.2;ar.translationPlaneXZ.planeMat.opacity=0.2;ar.rotationArcYZ.planeMat.opacity=0.2;ar.rotationArcXZ.planeMat.opacity=0.2;ar.rotationArcXY.privilegedPlaneMat.opacity=0.2};var aq=function(){ar.setToNonGhostState()};var K=function(){var aW=new y(L.externalPath);while(aW&&!m.isPLMNode(aW.getLastElement(true))){aW=aW.getParentPath()}if(!ak.path){ak.path=aW;return true}var aX=aW?aW.isEqual(ak.path):false;ak.path=aW;return aX};var aR,ay;var G=function(aX){var a2,a0,a3;if(aX.eventName==="RulerManipulateBegin"||aX.eventName==="AngularRulerManipulateBegin"){aO();x(L,U);aR=new D.Vector3();ay=0;var a4={objectsMoved:b(av),from:O,moveMode:"Persistent"};if(aX.eventName==="AngularRulerManipulateBegin"){aU={};a4.axis=new D.Vector3().copy(aX.direction);a4.center=new D.Vector3().getPositionFromMatrix(ar.getMatrix())}a3=f.give3DGridController({context:ab});if(a3){a3.hide3DGrids()}U.onMoveBegin(a4)}else{if(aX.eventName==="RulerManipulate"){aK();a2={objectsMoved:b(av),from:O};if(!aX.rulerDragged){j()}aR.add(aX.translationVector);ar.setMatrix(new D.Matrix4().copy(af).setPosition(new D.Vector3().getPositionFromMatrix(af).add(aR)));if(H.count()===0||a2.objectsMoved.length===0){a2.vector=aR}else{a0=aT({translationVector:aX.translationVector,objectMoved:a2.objectsMoved[0]});if(a0.worldMatrix){a2.worldMatrix=a0.worldMatrix}}U.onMove(a2);aL.render()}else{if(aX.eventName==="AngularRulerManipulate"){aK();a2={objectsMoved:b(av),from:O};if(!aX.rulerDragged){j()}var aZ=aX.diffAngle*Math.PI/180;ay+=aZ;var a1=new D.Matrix4().makeRotationAxis(aX.direction,ay).multiply(new D.Matrix4().extractRotation(af));ar.setMatrix(a1.setPosition(new D.Vector3().getPositionFromMatrix(af)));ak.value=am.value;var aY=new D.Matrix4().makeRotationAxis(aX.direction,aZ);if(H.count()===0||a2.objectsMoved.length===0){a2.angle=ay}else{a0=aT({rotationMatrix:aY,objectMoved:a2.objectsMoved[0]});if(a0.worldMatrix){a2.worldMatrix=a0.worldMatrix}}U.onMove(a2);aL.render()}else{if(aX.eventName==="RulerManipulateEnd"||aX.eventName==="AngularRulerManipulateEnd"){j();var aW={from:O,status:"Moved"};if(aX.status==="Cancelled"){aW.status="Cancelled"}else{ar.setRobotMatrix(ar.getMatrix())}a3=f.give3DGridController({context:ab});if(a3){a3.display3DGrids()}U.onMoveEnd(aW)}}}}};var al=function(a0){if(!L){return}aL.setCursor("pointer");aO();aS();at();aw=0;J=new D.Vector3();aC="";x(L,U);aP(a0.manipulator);var aZ=b(av),aY;var bb={objectsMoved:aZ,from:O,moveMode:"Persistent"};if(a0.eventChannel==="LineTranslationBegin"){var a7=0;for(;a7<a0.manipulator.manipulatedPaths[0].externalPath.length;a7++){if(a0.manipulator.manipulatedPaths[0].externalPath[a7].name.startsWith("arrow")){aC=a0.manipulator.manipulatedPaths[0].externalPath[a7].name;break}}aY=new D.Vector3().copy(a0.manipulator.axis);var a4=new D.Vector3().getPositionFromMatrix(ar.getMatrix());var a6=new D.Vector3().copy(aY).multiplyScalar(new D.Vector3().copy(ae.baseOrigin).sub(a4).dot(aY));ae.initOrigin=new D.Vector3().copy(a4).add(a6);var bc=new D.Vector3().copy(ae.initOrigin);var a3=null,aX;if(aU&&typeof aC==="string"){if(aC.match("arrowX")&&aU.X3Dpos){a3=new D.Vector3().copy(aU.X3Dpos)}else{if(aC.match("arrowY")&&aU.Y3Dpos){a3=new D.Vector3().copy(aU.Y3Dpos)}else{if(aC.match("arrowZ")&&aU.Z3Dpos){a3=new D.Vector3().copy(aU.Z3Dpos)}}}if(a3){aX=new D.Line3(ae.initOrigin,new D.Vector3().copy(ae.initOrigin).add(aY));bc=aX.closestPointToPoint(a3,false)}}ae.origin=bc;var aW=new D.Vector3().copy(ae.origin).sub(a4).dot(aY);ae.direction=aY;ae.value=bc.distanceTo(a4)*(aW>0?-1:1);ae.initValue=ae.value;if(R){R.origin=ae.origin;R.origin3DPos=a3;R.initOrigin=ae.initOrigin;R.setValue(ae.value);R.direction=ae.direction;R.initValue=ae.initValue;R.displayOrigin=!(R.origin.equals(R.initOrigin));R.display();R.beginManipulation()}}else{if(a0.eventChannel==="RotationBegin"){aU={};bb.center=new D.Vector3().getPositionFromMatrix(ar.getMatrix());aY=new D.Vector3().copy(a0.manipulator.axis);if(!ak.direction||Math.round(aY.dot(ak.direction)*100)===0||!K()){var ba=new D.Vector3(),a8=new D.Vector3(),a5=new D.Vector3();ar.getMatrix().extractBasis(ba,a8,a5);ba.normalize();a8.normalize();var a2=Math.round(ba.dot(aY)*100);var a1=Math.round(a8.dot(aY)*100);if(a2===0){ak.originVector=new D.Vector3().copy(ba)}else{if(a1===0){ak.originVector=new D.Vector3().copy(a8)}}ak.value=0;ak.direction=aY}bb.axis=new D.Vector3().copy(ak.direction);ak.origin=new D.Vector3().getPositionFromMatrix(ar.getMatrix());ak.initValue=ak.value;if(am){am.originVector=ak.originVector;am.setValue(ak.value);am.origin=ak.origin;am.direction=ak.direction;am.initValue=ak.initValue;am.display();am.beginManipulation()}}}var a9=f.give3DGridController({context:ab});if(a9){a9.hide3DGrids()}U.onMoveBegin(bb)};var aE=function(a1){if(!L){return}aL.setCursor("pointer");if(a1.eventChannel==="LineTranslationManipulation"){ae.value=ae.initValue+a1.translationVector.length()*(ae.direction.dot(a1.translationVector)>0?1:-1);if(R){R.setValue(ae.value)}}else{if(a1.eventChannel==="RotationManipulation"){aU={};var a0=new D.Vector3().copy(a1.axis);var aW=ak.direction.dot(a0);var a2=aW<0?2*Math.PI-a1.angle:a1.angle;ak.value=ak.initValue+a2*180/Math.PI;if(am){am.setValue(ak.value)}}}aK();var aY={objectsMoved:b(av),from:O},aX;if(a1.translationVector){if(H.count()===0||aY.objectsMoved.length===0){aY.vector=a1.translationVector}else{aX=aT({translationVector:new D.Vector3().subVectors(a1.translationVector,J),objectMoved:aY.objectsMoved[0]});if(aX.worldMatrix){aY.worldMatrix=aX.worldMatrix}}J=a1.translationVector}else{if(H.count()===0||aY.objectsMoved.length===0){aY.angle=a1.angle}else{var aZ=new D.Matrix4().makeRotationAxis(a1.axis,a1.angle-aw);aX=aT({rotationMatrix:aZ,objectMoved:aY.objectsMoved[0]});if(aX.worldMatrix){aY.worldMatrix=aX.worldMatrix}}aw=a1.angle}U.onMove(aY);aL.render()};var S=function(aX){if(!L){return}I();j();aq();if(aX.eventChannel==="LineTranslationEnd"){if(R){R.endManipulation();R.display()}}else{if(aX.eventChannel==="RotationEnd"){if(am){am.endManipulation();am.display()}}}var aW=f.give3DGridController({context:ab});if(aW){aW.display3DGrids()}U.onMoveEnd({from:O,status:"Moved"})};var aV,ax;var aJ=function(){if((!R||!am)&&!aF){aF=true;require(["DS/Ruler/Ruler","DS/Ruler/AngularRuler"],function(aW,aX){R=new aW(F,{displayOrigin:false,offset:h,mainGrad:100,nbSecondaryGrads:9,displayUnit:true,lockedOrigin:false});if(!aa){aa=R.subscribe("OriginManipulateBegin",function(){ax=null;if(!aV){aV=new D.Vector3().copy(R.origin)}});aN.push(aa)}if(!an){an=R.subscribe("OriginManipulateEnd",function(){if(!aU){aU={}}if(aC.match("arrowX")){aU.X3Dpos=ax?new D.Vector3().copy(ax):null}else{if(aC.match("arrowY")){aU.Y3Dpos=ax?new D.Vector3().copy(ax):null}else{if(aC.match("arrowZ")){aU.Z3Dpos=ax?new D.Vector3().copy(ax):null}}}ax=null;v.empty()});aN.push(an)}R.onOriginManipulator=function(a2){var a6,a1=null,a4=Math.pow(10,6),aY=aL.pick(aL.getMousePosition(a2.event.from[0].getCurrentPosition(aL.canvas)),"primHybrid",false);if(0===aY.path.length||!aY.path[0]){R.displayOrigin=false;ax=null;return aV}a6=aj.filterPath({pathElement:ai(aY.path)});v.empty();if(!a6||!a6.pathElement){if(m.isAModelPath(aY.path[0])){v.add({pathElement:aY.path[0]})}R.displayOrigin=false;return aV}if(typeof a6!=="undefined"&&a6&&a6.equivalentGeometry){var a3=a6.equivalentGeometry.getType(),a0=0;switch(a3){case E.GeometryType.POINT:a1=a6.equivalentGeometry.getPoint();break;case E.GeometryType.CYLINDER:case E.GeometryType.CONE:var a5=a6.equivalentGeometry.getEndPoints(),aZ=new D.Line3(a5.startPoint,a5.endPoint);a0=Math.round(aZ.delta().angleTo(a2.translationVector)*a4)/a4;if(a0===(Math.round((Math.PI*3/2)*a4)/a4)||a0===(Math.round((Math.PI/2)*a4)/a4)){a1=aZ.center()}break;case E.GeometryType.CIRCLE:a0=Math.round(a6.equivalentGeometry.getNormal().angleTo(a2.translationVector)*a4)/a4;if(a0===(Math.round((Math.PI*3/2)*a4)/a4)||a0===(Math.round((Math.PI/2)*a4)/a4)){a1=a6.equivalentGeometry.getCenter()}break;case E.GeometryType.PLANE:case E.GeometryType.REFPLANE:a0=Math.round(a6.equivalentGeometry.getNormal().angleTo(a2.translationVector)*a4)/a4;if(a0===0||a0===(Math.round(Math.PI*a4)/a4)){a1=aY.position}break;case E.GeometryType.SPHERE:a1=a6.equivalentGeometry.getCenter();break;case E.GeometryType.AXISSYSTEM:a1=new D.Vector3().getPositionFromMatrix(a6.equivalentGeometry.getMatrix());break;default:a1=null}}if(!a1){a6.pathElement.internalPath.length=0;if(aj.getFiltersState().product){a1=new D.Vector3().getPositionFromMatrix(a6.pathElement.getWorldMatrix())}}v.add(a6);if(a1){R.displayOrigin=true;ax=new D.Vector3().copy(a1);return a1}R.displayOrigin=false;ax=null;return aV};R.setVisibilityFree(true);aN.push(R.subscribe("RulerManipulateBegin",function(aY){G(aY)}));aN.push(R.subscribe("RulerManipulate",function(aY){G(aY)}));aN.push(R.subscribe("RulerManipulateEnd",function(aY){G(aY)}));am=new aX(F,{radius:a,mainGrad:10,nbSecondaryGrads:4,displayUnit:true});am.setVisibilityFree(true);X.push(am.subscribe("AngularRulerManipulateBegin",function(aY){G(aY)}));X.push(am.subscribe("AngularRulerManipulate",function(aY){G(aY)}));X.push(am.subscribe("AngularRulerManipulateEnd",function(aY){G(aY)}))})}aL.setCursor("pointer");N();aI();aO();x(L,U)};var aM=function(aW){aL.setCursor("pointer");aS();at();if(aW.intersection.path.length){var aX=T(aW.intersection.path[0],aW).pathElement;if(!L||!aX||!L.isEqual(aX)){L=aX?aX.clone():null;if(aX){if(u(aX)){aA.updateDisplay({visibility:false});ap.updateDisplay({pathElement:aX,visibility:true})}else{aA.updateDisplay({pathElement:aX,visibility:true});ap.updateDisplay({visibility:false})}}else{aA.updateDisplay({visibility:false});ap.updateDisplay({visibility:false})}}}else{aA.updateDisplay({visibility:false});ap.updateDisplay({visibility:false});L=null}};var M=function(aZ){var a3={};a3=T(aZ.target,aZ);L=a3.pathElement;P=L;ar.target=L;aU={};aq();aS();at();aA.updateDisplay({visibility:false});ap.updateDisplay({visibility:false});if(L){l.empty();A.empty();l.add(a3);A.add(a3);var aY=L.getWorldMatrix();if(a3.equivalentGeometry){var a5=new D.Vector3().copy(aZ.intersection.position),a1,a2=a3.equivalentGeometry.getType();if(a2===E.GeometryType.POINT){a5=a3.equivalentGeometry.getPoint()}else{if(a2===E.GeometryType.LINE||a2===E.GeometryType.CYLINDER||a2===E.GeometryType.CONE){var a6=a3.equivalentGeometry.getEndPoints();var a7=new D.Line3(a6.startPoint,a6.endPoint);a1=a7.delta();a5=a7.closestPointToPoint(a5)}else{if(a2===E.GeometryType.CIRCLE){a1=a3.equivalentGeometry.getNormal();a5=a3.equivalentGeometry.getCenter()}else{if(a2===E.GeometryType.PLANE||a2===E.GeometryType.REFPLANE){a1=a3.equivalentGeometry.getNormal()}else{if(a2===E.GeometryType.SPHERE){a5=a3.equivalentGeometry.getCenter()}else{if(a2===E.GeometryType.AXISSYSTEM){a5=null}}}}}}if(a1){var aX=new D.Vector3(),a0=new D.Vector3(),a4=new D.Vector3();aY.extractBasis(aX,a0,a4);aX.normalize();a0.normalize();a4.normalize();a1.normalize();var aW=new D.Vector3().crossVectors(aX,a1);if(aW.length()<1e-9){aX.copy(a0).projectOnPlane(a1);aX.normalize()}else{aX.projectOnPlane(a1);aX.normalize()}a0.crossVectors(a1,aX);a0.normalize();aY.makeBasis(aX,a0,a1)}if(a5){aY.setPosition(a5)}ar.setRobotMatrix(aY)}else{ar.setRobotMatrix(aY.setPosition(new D.Vector3().copy(aZ.intersection.position)))}ae.origin=new D.Vector3().getPositionFromMatrix(aY);ae.initOrigin=new D.Vector3().getPositionFromMatrix(aY);ae.baseOrigin=new D.Vector3().getPositionFromMatrix(aY);if(R){R.initOrigin=ae.initOrigin;R.origin=ae.origin;aU={}}}ad();if(L){ac();I()}else{N();j();if(aZ.target){Q()}}};var au=false;var ah=function(aW){if(aG){if(aW.eventType==="@onViewpointBeginMove"){au=true}else{if(aW.eventType==="@onViewpointChange"){if(au){ar.setVisibility(false);aL.render()}}else{if(aW.eventType==="@onViewpointEndMove"){ar.setVisibility(true);au=false;aL.render()}}}}};var Z=function(aY){L=T(aY).pathElement;ar.target=L;var aX=ar.getMatrix();var aW=L.getWorldMatrix();aW.setPosition(new D.Vector3().getPositionFromMatrix(aX));ae.origin=new D.Vector3().getPositionFromMatrix(aW);ae.initOrigin=new D.Vector3().getPositionFromMatrix(aW);ae.baseOrigin=new D.Vector3().getPositionFromMatrix(aW);if(R){R.initOrigin=ae.initOrigin;R.origin=ae.origin;aU={}}ar.setRobotMatrix(aW);ad()};require(["DS/ApplicationFrame/CommandsManager"],function(aW){aW.onCommandStart(function(aX){if(!Y.length){return}if(aX._id==="CAT3DComposeRobotLevelSelectorHdr"){aQ.hideContextualMenus();if(P&&P.externalPath){aX.setRobotParams({pathContext:P,pathCurrent:L,selectCB:function(aY){Z(aY.pathElement)}})}}else{if(aX._id==="CAT3DComposeSetIdentityPositionHdr"){aQ.hideContextualMenus();Q()}else{if(aX._id==="CAT3DComposeWidgetDefaultHdr"||aX._id==="CAT3DComposeMoveHdr"){if(!W){W=t.subscribe({event:"/VISU/"},ah)}if(aX._id==="CAT3DComposeWidgetDefaultHdr"){Q()}}else{if(aX._id==="LevelSelectorHdr"||aX._id==="HideShowHdr"||aX._id==="CAT3DComposeMoveCmd"){}else{if(aX._mode==="exclusive"){Q()}}}}}},ab.getCommandContext&&ab.getCommandContext()?ab.getCommandContext():undefined)});this.setVisibility=function(aW){if(typeof aW!=="boolean"){return undefined}if(aW){if(!W){W=t.subscribe({event:"/VISU/"},ah)}if(R){R.setVisibleFlag(true)}if(am){am.setVisibleFlag(true)}}else{if(W){if(R){R.setVisibleFlag(false)}if(am){am.setVisibleFlag(false)}t.unsubscribe(W);W=undefined}}aG=aW;var aX=ar.isVisible();if((aX&&aW)||(!aX&&!aW)){return 0}ar.setVisibility(aW);aL.render();return 0};this.isVisible=function(){return aG?ar.isVisible():false};this.activate=function(){if(!Y.length){Y.push(ar.subscribe("LineTranslationBegin",function(aY){al(aY)}));Y.push(ar.subscribe("RotationBegin",function(aY){al(aY)}));Y.push(ar.subscribe("ScalingBegin",function(aY){al(aY)}));Y.push(ar.subscribe("PlaneTranslationBegin",function(aY){al(aY)}));Y.push(ar.subscribe("LineTranslationManipulation",function(aY){aE(aY)}));Y.push(ar.subscribe("RotationManipulation",function(aY){aE(aY)}));Y.push(ar.subscribe("ScalingManipulation",function(aY){aE(aY)}));Y.push(ar.subscribe("PlaneTranslationManipulation",function(aY){aE(aY)}));Y.push(ar.subscribe("LineTranslationEnd",function(aY){S(aY)}));Y.push(ar.subscribe("RotationEnd",function(aY){S(aY)}));Y.push(ar.subscribe("ScalingEnd",function(aY){S(aY)}));Y.push(ar.subscribe("PlaneTranslationEnd",function(aY){S(aY)}));Y.push(ar.subscribe("ScreenPlaneTranslationBegin",function(aY){aJ(aY)}));Y.push(ar.subscribe("ScreenPlaneTranslationManipulation",function(aY){aM(aY)}));Y.push(ar.subscribe("ScreenPlaneTranslationEnd",function(aY){M(aY)}))}if(!aH.length){var aW,aX;aH.push(ab.subscribe({event:"onRootRemoved"},function(aY){aB([aY])}));aH.push(ab.subscribe({event:"onRootDetached"},function(aY){aB([aY])}));aH.push(ab.subscribe({event:"onHide"},function(aZ){var aY=[];aZ.paths.forEach(function(a0){aY.push({path:a0})});aB(aY)}));aH.push(ab.subscribe({event:"onBeginReparent"},function(aY){if(L&&((aY.reparentedInstance&&L.externalPath.some(function(aZ){return aZ===aY.reparentedInstance}))||(aY.pathToReparent&&aY.pathToReparent.isAParentOf(L)))){aW=ab.subscribe({event:"onReparentFailure"},function(){ab.unsubscribe(aW);ab.unsubscribe(aX)});aX=ab.subscribe({event:"onEndReparent"},function(){ab.unsubscribe(aW);ab.unsubscribe(aX);Q()})}}))}W=t.subscribe({event:"/VISU/"},ah)};this.deactivate=function(){Y.forEach(function(aW){ar.unsubscribe(aW)});Y.length=0;aH.forEach(function(aW){ab.unsubscribe(aW)});aH.length=0;N();t.unsubscribe(W);W=null};this.unreference=function(){this.deactivate();aL.setRobot(false);aL.removeNode(aA);aL.removeNode(ap);aS();at();aN.forEach(function(aW){R.unsubscribe(aW)});X.forEach(function(aW){am.unsubscribe(aW)});if(H){H.unreference()}ar=ab=F=aL=U=av=H=aU=null;aa=an=aQ=aj=R=am=aA=ap=null}}});var n=[];return C.singleton({init:function(){},giveComposeRobot:function(F){var G;if(F&&F.context){G=null;n.some(function(H){return(H.context===F.context)?(G=H.enveloppe):false})}return G},getComposeRobot:function(H){var K;if(H&&H.context){n.some(function(L){return(L.context===H.context)?(K=L.enveloppe):false});if(!K){var J=new d({context:H.context}),F=H.context.setRobotVisibility,I=H.context.isRobotVisible;J.activate();var G={unreference:function(){if(!J){return}J.unreference();J=null;n.some(function(M,L){if(M.enveloppe===G){n.splice(L,1);M.context.setRobotVisibility=F;F=null;M.context.isRobotVisible=I;I=null;G=null;return true}return false})},setVisibility:function(L){return J?J.setVisibility(L):null},isVisible:function(){return J?J.isVisible():null}};Object.freeze(G);H.context.setRobotVisibility=function(L){return G?G.setVisibility(L):null};H.context.isRobotVisible=function(){return G?G.isVisible():null};n.push({context:H.context,enveloppe:G});K=G}}return K}})});