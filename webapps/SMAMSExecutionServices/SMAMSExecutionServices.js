/*! Copyright 2015 Dassault Systemes */
define("DS/SMAMSExecutionServices/SMAMSExecutionServices",["module","DS/Logger/Logger","DS/SMAProcWebCMMUtils/SMAJSCMMAuthoringUtils","DS/SMAProcWebCMMUtils/SMAJSCMMWebServicesUtils","DS/SMAMSExecutionServices2/SMAMSExecutionServices2","DS/SMAMSExecutionServices2Unqueued/Constants","i18n!DS/SMAMSWebUI/assets/nls/SMAMSMessages"],function(a,e,i,b,c,h,f){var g=e.getLogger(a);var d={mcsUrl:null,dslsServer:null,WUTenantID:null,WATenantID:null,myAppsUrl:null,isCloud:false,executeProcess:function(o,n,k,q){var p=new SPRun();var m=i.getCurrentContext();var j={eedBaseURL:n,runURL:n+"/execution/run/workflow",jobXMLURL:this.mcsUrl+"/resources/slmservices/jobs?SecurityContext="+m,cosPubkeyURL:n+"/execution/pubkey",encryptURL:this.mcsUrl+"/resources/slmservices/data/getEncryptedCreds?SecurityContext="+m,mcsTicketURL:this.mcsUrl+"/ticket/get?SecurityContext="+m,runInfo:'<RunInfo logLevel="Debug" submissionHost=""></RunInfo>',mcsURL:this.mcsUrl,timeout:150000};if(!p||!j){var l="Could not initialize sp-run.";g.error(l);q.onError(l);return}p.runURL=j.runURL;p.jobXMLURL=j.jobXMLURL;p.cosPubkeyURL=j.cosPubkeyURL;p.encryptURL=j.encryptURL;p.mcsTicketURL=j.mcsTicketURL;p.runInfo=j.runInfo;p.mcsURL=j.mcsURL;p.simOID=o;p.timeout=j.timeout;if(this.isCloud){p.tenantID=this.WUTenantID}p.addEventListener("success",function(r){g.info("sp-run success");q.onSuccess(r.detail.result.MCSJobID)});p.addEventListener("error",function(t){var s="sp-run error";g.error(s,t);var r;if(t.detail&&t.detail.response){r=t.detail.response;if(t.detail.response.contains("No private station")){r=f.get("exec_07");if(r==="exec_07"){r="No running private station found"}}}else{r=f.get("exec_11");if(r==="exec_11"){r=r="Job submission failed."}}q.onError(r)});if(k!==null&&k!==undefined){p.runSimulationAs(null,o,"",false,k)}else{p.runSimulation(null,o)}},getResultsSO:function(j,k){i.openProcess(j,{onSuccess:function(m){var l=m.getActivityByName(h.RESULTS_GENERATION);i.getParametersInPLM(l,{onSuccess:function(n){var o=n.findParameterByName(h.RESULTS,false);g.info("SO webservice success");i.getAllSimulationData(l,{onSuccess:function(){var p=l.getSimulationData(o.getValueAsString());k.onSuccess(p.getPhysicalId(),p.getName())},onFailure:function(p){k.onFailure(p);g.error("SO webservice failure")}})},onFailure:function(n){k.onFailure(n);g.error("SO webservice failure")}})},onFailure:function(l){k.onFailure(l);g.error("SO webservice failure")}})},getResults:function(j,k){i.getParametersInPLM(j,{onSuccess:function(l){var m=l.findParameterByName(h.RESULTS,false);g.info("FMU webservice success");i.getAllSimulationData(j,{onSuccess:function(){var n=j.getSimulationData(m.getValueAsString());k.onSuccess(n.getPhysicalId(),n._data.dataelements.modified.value[0].actualValue,n._data.dataelements.description.value[0].value)},onFailure:function(n){k.onFailure(n);g.error("FMU webservice failure")}})},onFailure:function(l){k.onFailure(l);g.error("FMU webservice failure")}})}};return d});
/*! Copyright 2015 Dassault Systemes */
define("DS/SMAMSExecutionServices/SMAMSCommonServices",["UWA/Core","UWA/Class","DS/SMAProcWebCMMUtils/SMAJSCMMAuthoringUtils","DS/SMAProcWebCMMUtils/SMAJSCMMWebServicesUtils"],function(f,b,c,d){var e="multiScaleModel.json";var a=f.Class.extend({init:function(){this.eedUrl=null},getEEDUrl:function(g,i){if(this.EEDUrl){g(this.eedUrl)}else{var h=this;var j=function(k){h.eedUrl=k;g(k)};c.getEEDUrl({onSuccess:j,onFailure:i})}},getJobs:function(k,j,i){var h=c.ThreeDSpaceUrl;var g=h+"/resources/slmservices/simulations/"+k+"/jobs?_="+Math.random();d.get(null,g,{onComplete:j,onError:i})},getJobInfo:function(m,l,j){var i={};var h=function(){var o=c.ThreeDSpaceUrl+"/resources/slmservices/cos/ticket?physicalid="+i.jobPhysicalId+"&SecurityContext="+d.Context;var n={onComplete:function(p){i.cosTicket=p.ticket;l(i)},onError:function(){j("getJobInfo failed.")}};d.get(null,o,n)};var g=function(o){var p=c.ThreeDSpaceUrl+"/resources/slmservices/jobinfo/job/"+o+"/getExeTicket?_="+Math.random();var n={method:"GET",data:null,onComplete:function(q){i.eedTicket=q;h()},onError:function(){j("getJobInfo failed.")}};d._request(p,n)};var k=function(n){if(!n[0]){l(null)}else{i.eedJobId=n[0].eedJobId;i.status=n[0].status;i.jobPhysicalId=n[0].physicalId;g(n[0].physicalId)}};this.getJobs(m,k,j)},getJobStatus:function(j,i,g){var h=function(k){if(!k[0]){i("notstarted")}else{i(k[0].status)}};this.getJobs(j,h,g)},getExecOptions:function(l,k,i){var g=c.ThreeDSpaceUrl+"/resources/slmservices/simulations/"+l+"/executionoptions";var j={onComplete:k,onError:i};var h=g+"?_="+Math.random();d.get(null,h,j)},saveExecOptions:function(l,k,j,i){this.setExperimentActivityExecOptions(k);var h=c.ThreeDSpaceUrl+"/resources/slmservices/simulations/"+l+"/executionoptions";var g={method:"PUT",data:JSON.stringify(k),onComplete:j,onFailure:i};d._request(h,g)},setExperimentActivityExecOptions:function(o){var n=null;var m=null;var h=null;var g=null;for(var l=0;l<o.length;l++){if(o[l]["title_display"]==="CSE-Director"||o[l]["title_display"]==="Co-simulation Master"){for(var j=l;j<o.length;j++){if(o[j]["title"]==="StationName"){n=o[j]}if(o[j]["title"]==="CosimGroup"){h=o[j]}if(o[j]["title"]==="drmMode"){m=o[j]}if(o[j]["title"]==="RunTimeLimit"){g=o[j];break}}break}}for(var l=0;l<o.length;l++){if(o[l]["title_display"]==="Experiment"){for(var j=l;j<o.length;j++){if(o[j]["title"]==="StationName"){if(n!==null){o[j].value=n.value}}if(o[j]["title"]==="drmMode"){if(m!==null){o[j].value=m.value}}if(o[j]["title"]==="RunTimeLimit"){o[j]=g;break}}break}}},saveModel:function(g,h,l,j){var k=new DS.SMAProcSP.SPFileContent();var i=JSON.stringify(h);i=new File([i],e,{type:"application/json"});k.uploadFile({documentid:g,newFileName:e,file:i}).then(l)["catch"](j)},readModel:function(g,j,h){var i=new DS.SMAProcSP.SPFileContent();i.getFileContent(g,e,"json").then(function(k){j(k.response)})["catch"](h)},getDrms:function(i,h){var g=function(l){var k=l+"/admin/drm";var j={method:"GET",type:"json",responseType:"json",onComplete:i,onFailure:h};d.normalRequest(k,j)};this.getEEDUrl(g,h)}});return new a()});
/*! Copyright 2016 Dassault Systemes */
define("DS/SMAMSExecutionServices/SMAMSSolverMessageProcessing",["module","DS/Logger/Logger","UWA/Core","UWA/Json"],function(c,b,d){var a=function(){var e={};var m={};var g={};var k=true;var h=function(o,n){this.onServiceReceive=o;this.onEnd=n;this.active=true};var f=function(o,p,n,r){if(!o.hasOwnProperty(n)){o[n]=[]}var q=o[n];if(!q.hasOwnProperty(p)){q[p]=[]}q[p].push(r)};var i=function(){for(var q in e){if(e.hasOwnProperty(q)){var n=q;var s=e[q];for(var p in s){if(s.hasOwnProperty(p)){var r=s[p];for(var o=0;o<r.length;o++){f(m,p,n,r[o])}}}}}e={}};var l=function(o){var n=null;if(o.hasOwnProperty("jobName")){n=o.jobName.nodeValue}else{if(o.hasOwnProperty("servantAppID")){n=o.servantAppID.nodeValue}}return n};var j={putMessages:function(r){var t=d.Json.xmlToJson(r);var s={};for(var p in t){if(t.hasOwnProperty(p)){s=t[p];break}}for(var p in s){if(s.hasOwnProperty(p)){var q=s[p];if(Array.isArray(q)){for(var o=0;o<q.length;o++){var n=l(q[o]);if(n!==null&&n!==undefined){f(e,p,n,q[o])}}}else{var n=l(q);if(n!==null&&n!==undefined){f(e,p,n,q)}}}}for(var p in g){if(g.hasOwnProperty(p)&&g[p].active){var q=e[p];g[p].onServiceReceive(e[p])}}i()},getAllMessages:function(n){return m[n]},getMessages:function(n,q,o){if(m[n]!==undefined&&m[n]!==null){q(m[n])}var p=n;g[p]=new h(q,o)},clear:function(){e={};m={};g={}},stopMessages:function(n){k=false}};return j};return new a()});
/*! Copyright 2015 Dassault Systemes */
define("DS/SMAMSExecutionServices/SMAMSMonitoringAPI",["module","DS/ExperienceKernel/ExperienceKernel","DS/SMAProcWebCMMUtils/SMAJSCMMAuthoringUtils","DS/SMAProcWebCMMUtils/SMAJSCMMWebServicesUtils","DS/Logger/Logger","DS/SMAMSExecutionServices/SMAMSCommonServices"],function(e,g,c,d,b,a){var f=function(){var q=null;var h,n;var j={};var k=false;var o=null;var l=null;var p=b.getLogger(e);var i=function(s,r){this.onServiceReceive=s;this.onEnd=r;this.active=true};var m={getServices:function(r,z,u){var A=function(){if(l){l=l.toLowerCase()}u(l)};var v=null;var x=function(){var F=false;var C;var E=false;var B=function(G){if(!G){p.info("Experiment is not running");A()}else{if(G.status==="Running"){l=G.status;k=false;clearInterval(C);F=true;if(!E){E=true;w(G.eedJobId,G.eedTicket)}}else{l=G.status;F=true;A()}}};var D=function(){F=true;k=true;A()};C=setInterval(function(){if(F){clearInterval(C)}else{a.getJobInfo(r,B,D)}},5000)};var w=function(D,C){var E=v+"/job/"+D+"/monitor?TimeStamp=0&Topic=WEBSOCKET";var B={method:"GET",headers:{EEDTicket:C},onComplete:s,onFailure:A};d.normalRequest(E,B)};var s=function(C){var F=new DOMParser();var E=F.parseFromString(C,"text/xml");var B=E.firstChild;var D=B.getElementsByTagName("Message");if(D.length===0){setTimeout(x(),10000)}else{t(D[0].textContent)}};var y=function(B){v=B;x()};a.getEEDUrl(y,A);var t=function(C){j={};var E=function(G){if(widget.editor.model.experiment){widget.editor.model.experiment.monitoring.EKconnectionOK=true}if(G==="succeeded"||G==="failed"){k=true;for(var H in j){if(j.hasOwnProperty(H)&&j[H].onEnd!==null&&j[H].onEnd!==undefined&&j[H].active){j[H].active=false;j[H].onEnd(G)}}}else{if(G.startsWith("failedComponent:")){var I="notifyFailedComponent";if(j.hasOwnProperty(I)){j[I].onServiceReceive(G.replace("failedComponent:",""))}}else{if(G.startsWith("cssError:")){var I="cssError";if(j.hasOwnProperty(I)){j[I].onServiceReceive(G.replace("cssError:",""))}}else{var K=new DOMParser();var J=K.parseFromString(G,"text/xml");var F=J.firstChild;var I=F.getAttribute("serviceName");if(j[I]){if(j[I].active){j[I].onServiceReceive(G)}}}}}};var B=function(){k=true;for(var F in j){if(j.hasOwnProperty(F)&&j[F].onEnd!==null&&j[F].onEnd!==undefined&&j[F].active){j[F].active=false;j[F].onEnd("Co-simulation Completed")}}};var D="SMC";q=new g.Node({onText:E,onHypervisorDisconnect:B,hypervisorUrl:C,ssl:true});h=q.connect(D);n=h.select();q.subscribe(n,"end");q.subscribe(n,"messages");o={getProgress:function(H,I,F){j.getProgress=new i(I,F);var G=setInterval(function(){if(k||!j.getProgress.active){clearInterval(G)}else{q.sendText(n,"getProgress")}},H*1000)},getSolverMessages:function(H,I,F){j.getSolverMessages=new i(I,F);var G=setInterval(function(){if(k||!j.getSolverMessages.active){clearInterval(G)}else{q.sendText(n,"getSolverMessages")}},H*1000)},getAllSolverMessages:function(G,F){j.getAllSolverMessages=new i(G,F);q.sendText(n,"getAllSolverMessages")},pause:function(F){j.pause=new i(F);q.sendText(n,"pause")},cssError:function(F){j.cssError=new i(F);q.subscribe(n,"cssError")},resume:function(F){j.resume=new i(F);q.sendText(n,"resume")},stop:function(F){j.stop=new i(F);q.sendText(n,"stop");k=true},notifyFailedComponent:function(F){j.notifyFailedComponent=new i(F);q.subscribe(n,"failedComponent")},subscribe:function(J,K,O,M,N,P,G){var L=K+"_"+O;j[L]=new i(P,G);var R=q.connect(K);var I=R.select();var F=0;var H=false;var S="subscribe,"+K+","+O+","+M+","+N+","+H;var Q=setInterval(function(){if(k||!j[L].active){clearInterval(Q)}else{if(F===0){H=true}else{if(F>0){H=false}}F++;q.sendText(I,S)}},J*1000)},unsubscribe:function(M,L,I,G){var H=M+"_"+L;j[H].active=false;var F=q.connect(M);var K=F.select();var J="unsubscribe,"+M+","+L+","+I+","+G;q.sendText(K,J)},stopAllServices:function(){for(var F in j){if(j.hasOwnProperty(F)&&j[F].active){j[F].active=false}}}};z(o)}}};return m};return new f()});