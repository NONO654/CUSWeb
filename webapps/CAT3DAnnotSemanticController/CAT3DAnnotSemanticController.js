/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CAT3DAnnotSemanticController/CAT3DAnnotSemanticController",[],function(){});define("DS/CAT3DAnnotSemanticController/CAT3DAnnotSemanticContInstance",["DS/CAT3DAnnotationExpController/CAT3DAnnotExpControllerInstance","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils","DS/CATWebUXSlideShow/CATWebUXSlideShowController"],function(f,c,e,d,b){var a=f.extend({init:function(p){var g=p||{};g.workbenchName="CAT3DAnnotSemanticWidgetWkb";g.moduleName="CAT3DAnnotSemanticWidget";g.annotLoaderLib="DS/CAT3DAnnotSemanticModel/CAT3DAnnotSemanticLoader";this._parent(g);var l=false;var t=true;var v=this;var w=g.ctxViewer;var m;var A=this.setActiveState;this.setActiveState=function(C){A(C);var D=b.giveSlideShowController({context:w.getFrameWindow(),id:"CAT3DAnnotationSlideShow"});if(D){D.setListOfCommandsAllowed(["CAT3DAnnotInsightWidgetDefaultHdr"])}};var o=this.onAdditionalInfosRequired;this.onAdditionalInfosRequired=function(C){if(C.controller==="AnnotAttrBrowser"){require(["DS/CAT3DAnnotSemanticCmds/controllers/CAT3DAnnotSemanticAttrBrowserCtr"],function(D){var E=D.give3DAnnotAttrBrowserController({context:w});if(E&&E.setDataModelMethod){E.setDataModelMethod(v._getJSONModel)}C.cb()})}else{o(C)}};this.getAnnotationControllerType=function(){return"3DAnnotationInsight"};var i=this._disableAnnotUI;this._disableAnnotUI=function(){require(["DS/CAT3DAnnotSemanticCmds/controllers/CAT3DAnnotSemanticAttrBrowserCtr"],function(C){var D=C.give3DAnnotAttrBrowserController({context:w});if(D&&D.getActiveState()){m=D.getPanelVisibilityFlag();D.setPanelVisibilityFlag(false)}});i()};var x=this._enableAnnotUI;this._enableAnnotUI=function(){require(["DS/CAT3DAnnotSemanticCmds/controllers/CAT3DAnnotSemanticAttrBrowserCtr"],function(C){var D=C.give3DAnnotAttrBrowserController({context:w});if(D){D.setPanelVisibilityFlag(m)}});x()};var u=function(G){var C=G.children;var H;for(var D=0;D<C.length;D++){if(H){break}if(!C[D].getAnnotationClassType){var F=C[D].children;for(var E=0;E<F.length;E++){if(F[E].getPathElement&&F[E].setInternalSceneGraph){H=F[E];break}}}}return H};var z=this.clearController;this.clearController=function(){z();w=v=null};var s=this._onCommandStartCB;this._onCommandStartCB=function(F){s(F);if(F._id==="CAT3DAnnotationLevelSelectorHdr"){t=false;F.onEnd(function(){t=true})}var E=["CAT3DAnnotSemanticShowGeomAttachHdr","CAT3DAnnotSemanticShowRelatedAnnotHdr"];var D=function(){setTimeout(v._refreshContextualBar)};for(var C=0;C<E.length;C++){if(F._id===E[C]){F.onEnd(D)}}};var q=this.getAnnotControllerPrototype;this.getAnnotControllerPrototype=function(){var C=q();C.getRelatedGeometryPaths=function(D){if(v){return v.getRelatedGeometryPaths(D)}return undefined};C.getReferencedAnnotations=function(D){if(v){return v.getReferencedAnnotations(D)}return undefined};C.getPontingAnnotations=function(D,E){if(v){return v.getPontingAnnotations(D,E)}return undefined};return C};var r=this.getContextualCommandList;this.getContextualCommandList=function(){if(!w){return[]}var G=r();var P=[],M,R;var O=c.get();var D=w.getRootBagPath();var S=false;var F=true;for(M=0;M<O.length;M++){if(O[M].pathElement&&D.isAParentOf(O[M].pathElement)){P.push(O[M].pathElement);var Q=O[M].pathElement.getLastElement(true);if(Q.getAnnotationClassType){S=true;if(Q.getAnnotationClassType()!=="tps"){F=false;break}}else{F=false;break}}}var K;if(F){K=false;for(M=0;M<P.length;M++){if(K){break}if(!P[M].getLastElement(true).isVisible()){continue}var L=P[M].getLastElement(true);var T=L.getGeometricalAttachmentList!==undefined?L.getGeometricalAttachmentList():null;if(T&&T.length){var C=P[M].getParentPath().getParentPath();var I=C.getLastElement(true).children;for(R=0;R<I.length;R++){if(I[R].getAnnotationType()!=="RootViews"&&I[R].getAnnotationType()!=="RootCaptures"&&I[R].getAnnotationType()!=="RootGeometries"){var N=I[R].children;for(var E=0;E<N.length;E++){var J=T.indexOf(N[E].getAnnotationID());if(J!==-1&&!N[E].isVisible()){G.unshift({name:"CAT3DAnnotInsightShowGeomAttachStr",line:1,hdr_list:["CAT3DAnnotSemanticShowGeomAttachHdr"]});K=true;break}}}if(K){break}}}}}if(!S){K=false;for(M=0;M<P.length;M++){if(K){break}var H=v.getPontingAnnotations(P[M]);if(H&&H.length){for(R=0;R<H.length;R++){if(!H[R].getLastElement(true).isVisible()){G.unshift({name:"CAT3DAnnotInsightShowRelatedAnnotStr",line:1,hdr_list:["CAT3DAnnotSemanticShowRelatedAnnotHdr"]});K=true;break}}}}}return G};var B=function(D){var C=D.clone();while(C){if(C.getLastElement(true).getAnnotationClassType()==="tpsAnnotationSet"){break}else{C=C.getParentPath()}}return C};this.getRelatedGeometryPaths=function(S){var L=[],M,T;var Q=S&&S.length?S:[S],E;for(M=0;M<Q.length;M++){E=Q[M];if(E){var O=E.getLastElement(true);if(!O.getAnnotationClassType){return L}var C=B(E);var K=O.getAnnotationTTRS!==undefined?O.getAnnotationTTRS():[];var F=O.getAnnotationTTRSRep!==undefined?O.getAnnotationTTRSRep():null;if(F&&F.length){K=K.concat(F)}if(K&&K.length){var P=C.getLastElement(true).getTTRSs();var H=[];for(M=0;M<K.length;M++){for(T=0;T<P.length;T++){if(K[M]===P[T].tpsID){var N=P[T].geoP;if(N&&N.length){H=H.concat(N)}break}}}if(H.length){var U=v.getCGRPath(C);if(U){var W=U.getLastElement(true);var R=W.getPathElement(H,U);if(!R||(R&&!R.length)){var I=C.getLastElement(true).getRootAnnotationNode("RootGeometries");var J=I.children;for(M=0;M<J.length;M++){var V=u(J[M]);if(V){R=W.getPathElement(H,U);if(R&&R.length){var G=[];for(T=0;T<R.length;T++){G.push({pathElement:R[T]})}e.remove(G);var D=C.clone();D.addElement(I);D.addElement(J[M]);L.push(D);L=L.concat(v.getRelatedGeometryPaths(D));break}}}}else{L=L.concat(R)}}}}}}return L};function k(F,E){var D=v.getRelatedGeometryPaths([F]);if(D.length){var G=[];for(var C=0;C<D.length;C++){G.push({pathElement:D[C]})}if(E){e.add(G)}else{e.remove(G)}}}this.getReferencedAnnotations=function(D){var G=D.getLastElement(true);if(G.getAnnotationClassType()!=="tps"){return[]}var N=B(D);var J=G.getAnnotationReferenceFrame!==undefined?G.getAnnotationReferenceFrame():null;var E=[],O,I;if(J||G.getAnnotationType()===32){var F=N.getLastElement(true).getReferenceFrames();var M;for(O=0;O<F.length;O++){if(F[O].tpsID===J||G.getAnnotationUuid()===F[O].uuid){M=F[O].datums;break}}if(M!==undefined){var K=N.getLastElement(true).getRootAnnotationNode("RootDatums");var C=K.children;var H=N.clone();H.addElement(K);for(O=0;O<M.length;O++){for(I=0;I<C.length;I++){if(C[I].getAnnotationID()===M[O]){var L=H.clone();L.addElement(C[I]);E.push(L);break}}}}}return E};this.getPontingAnnotations=function(T,O){var V=[],E,H;var M=[],N,W,G;var U=T.internalPath;for(N=0;N<U.length;N++){E=U[N].getCGMID?U[N].getCGMID():null;if(E!==null&&E!==undefined){H=U[N].getType();V.push(E);M.push(H)}}var S=T.clone();while(S){if(d.getNodeID(S.getLastElement(true))){break}else{S=S.getParentPath()}}if(!S){return[]}var J=S.getChildrenPathes();var C;for(N=0;N<J.length;N++){if(J[N].getLastElement(true).getAnnotationClassType&&J[N].getLastElement(true).getAnnotationClassType()==="tpsAnnotationSet"){C=J[N]}}if(C){var L=C.getLastElement(true).getTTRSs();if(L){var K=[];for(N=0;N<L.length;N++){if(L[N].geoP&&L[N].geoP.length){for(var Q=0;Q<L[N].geoP.length;Q++){var F=L[N].geoP[Q];if(!O){if(F.equals(V)&&M[M.length-1]==="primitive"){if(K.indexOf(L[N].tpsID)===-1){K.push(L[N].tpsID)}}}else{var R=true;for(W=0;W<F.length;W++){if(F[W]!==V[W]){R=false;break}}if(R&&M[M.length-1]==="primitive"&&K.indexOf(L[N].tpsID)===-1){K.push(L[N].tpsID)}}}}}if(K.length){var P=[];var D=function(ae,aa){var Z=ae?ae.getLastElement(true):null;if(!Z||!Z.getAnnotationClassType){return}var Y=Z.getAnnotationTTRS!==undefined?Z.getAnnotationTTRS():null;if(Y&&Y.indexOf(aa)!==-1){var ab=false;for(var ad=P.length-1;ad>=0;ad--){if(P[ad].isEqual(ae)){ab=true;break}if(P[ad].isAParentOf(ae)){P.splice(ad,1)}}if(!ab){P.push(ae)}}var ac=ae.getChildrenPathes();for(var af=0;af<ac.length;af++){D(ac[af],aa)}};for(G=0;G<K.length;G++){var I=C.getChildrenPathes();for(N=0;N<I.length;N++){H=I[N].getLastElement(true).getAnnotationType();if(H&&H!=="RootViews"&&H!=="RootCaptures"){var X=I[N].getChildrenPathes();for(W=0;W<X.length;W++){D(X[W],K[G])}}}}return P}}}return[]};this.onAttributeClicked=function(C){require(["DS/CAT3DAnnotSemanticCmds/controllers/CAT3DAnnotSemanticAttrBrowserCtr"],function(D){var E=D.give3DAnnotAttrBrowserController({context:w});if(E){E.solveAttributeLink(C)}})};var n=function(E){var F;var D=E.getLastElement(true);if(D.getDatumTargetList&&D.getDatumTargetList()){var G=D.getDatumTargetList();var K=B(E);var C=K.getLastElement(true).getRootAnnotationNode("RootDatums");var I=K.clone();I.addElement(C);var H=I.getChildrenPathes();F=[];for(var J=0;J<H.length;J++){if(G.indexOf(H[J].getLastElement(true).getAnnotationID())!==-1){F.push(H[J].clone())}}}return F};var y=function(E){var D=E.getLastElement(true);var I;if(D.getAssociatedBasicDims&&D.getAssociatedBasicDims()){var C=D.getAssociatedBasicDims();var L=B(E);var F=L.getChildrenPathes();I=[];for(var K=0;K<F.length;K++){var J=F[K].getLastElement(true);if(J.getAnnotationType()!=="RootViews"&&J.getAnnotationType()!=="RootCaptures"&&J.getAnnotationType()!=="RootGeometries"){var G=F[K].getChildrenPathes();for(var H=0;H<G.length;H++){if(C.indexOf(G[H].getLastElement(true).getAnnotationID())!==-1){I.push(G[H].clone())}}}}}return I};var j=function(D,C){if(C&&C.length){if(D&&D.length){D=D.concat(C)}else{D=C}}return D};var h=function(G,H){if(l||!t||!G||!G.pathElement||typeof H!=="boolean"){return}l=true;var F=G.pathElement.getLastElement(true);if(g.ctxViewer.getRootBagPath().isAParentOf(G.pathElement)){var D;if(F.getAnnotationClassType&&F.getAnnotationClassType()==="tps"){if(F.getAnnotationSupertype()===8){k(G.pathElement,H);D=v.getPontingAnnotations(G.pathElement);D=j(D,v.getReferencedAnnotations(G.pathElement))}else{k(G.pathElement,H);D=v.getReferencedAnnotations(G.pathElement);D=j(D,n(G.pathElement));D=j(D,y(G.pathElement))}}else{if(G.pathElement&&G.pathElement.externalPath[0].name==="RootBag"){D=v.getPontingAnnotations(G.pathElement)}}if(D){var C=[];for(var E=0;E<D.length;E++){C.push({pathElement:D[E]})}if(H){e.add(C)}else{e.remove(C)}}}l=false};this.onAddHSOCB=function(C){h(C,true)};this.onRemoveHSOCB=function(C){h(C,false)}}});return a});