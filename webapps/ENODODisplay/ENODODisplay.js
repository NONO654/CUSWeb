define("DS/ENODODisplay/views/DerivedOutputList",["UWA/Controls/Abstract","DS/Tree/TreeDocument","DS/TreeModel/DataModelSet","DS/Tree/TreeNodeModel","DS/DataGridView/DataGridView","DS/DataGridView/DataGridViewLayout","i18n!DS/ENODODisplay/assets/nls/ENODisplayDO.json","DS/ENODOUtilsServices/DOServices","DS/Utilities/UUID","DS/Notifications/NotificationsManagerViewOnScreen","DS/Notifications/NotificationsManagerUXMessages","DS/Controls/TooltipModel","DS/Controls/Popup","DS/Controls/Button","text!DS/ENODOUtilsServices/assets/catrsc/ENODOFormat.xml"],function(h,a,g,f,b,i,d,j,q,o,n,k,c,m,p){var e={downloadTicket:{url:"/resources/v2/PLMDerivedOutputEntityWSAPI/derivedoutputentity_services/getDerivedOutputDownloadTicketFromKeys",verb:"POST"},doInformation:{url:"/resources/v1/ENODerivedOutputStreamServices/derivedformat_services/getStreamInformation",verb:"POST"},generateJob:{url:"/resources/PLMDerivedOutputWSAPI/derivedoutput_services/createDerivedFormatJobs",verb:"POST"},fetch:{url:"/cvservlet/fetch/v2",verb:"POST"}};var l=h.extend({_treelistview:null,_model:null,_informationBox:null,_actionAuthorized:false,_formatList:[],init:function(s){var v=this;this._parent(s);this._actionAuthorized=(!UWA.is(this.options)||!UWA.is(this.options.activateActions))?false:this.options.activateActions;this.elements.container=UWA.createElement("div",{"class":"derivedoutputs_container"});this._formatList=this._getFormatList();var u=new g();this._model=new a({dataModelSet:u});var t=this._treelistview=new b({treeDocument:this._model,rowSelection:"single",cellSelection:"none",selectionBehavior:{toggle:true,unselectAllOnEmptyArea:true},layout:new i({cellHeight:26,columnHeaderHeight:38,rowsHeader:false}),columns:[{text:d.columns.status,dataIndex:"Status",alwaysVisibleFlag:true,width:50,sortableFlag:true,resizableFlag:true,editableFlag:false,getCellTypeRepresentation:function(w){if(w.nodeModel&&w.nodeModel.options.grid.Status===true){w.cellView.tooltipInfos=new k({shortHelp:d.buttons.uptodate.shortHelp,allowUnsafeHTMLTitle:false,allowUnsafeHTMLShortHelp:false,allowUnsafeHTMLLongHelp:false});return"statusCheck"}else{if(w.nodeModel&&w.nodeModel.options.grid.Status===false){w.cellView.tooltipInfos=new k({shortHelp:d.buttons.refresh.shortHelp,longHelp:d.buttons.refresh.longHelp,});return"statusRefresh"}}},getCellSemantics:function(w){if((w.nodeModel&&w.nodeModel.options.grid.Status===true)||v._actionAuthorized!==true||v._getFormatIndex(v._formatList,w.nodeModel.options.grid.Format)===-1){return{disabled:true}}}},{text:d.columns.format,dataIndex:"Format",width:100},{text:d.columns.name,dataIndex:"Filename",width:"auto"},{dataIndex:"Download",alwaysVisibleFlag:true,width:30,sortableFlag:false,resizableFlag:false,editableFlag:false,getCellTypeRepresentation:function(w){if(w.nodeModel&&typeof w.nodeModel.options.grid.Download!=="undefined"&&w.nodeModel.options.grid.Download===true){w.cellView.tooltipInfos=new k({shortHelp:d.buttons.download.shortHelp});return"actionDownload"}else{return"string"}},getCellSemantics:function(w){if(w.nodeModel&&typeof w.nodeModel.options.grid.Download==="undefined"){return{disabled:true,allowUnsafeHTMLLabel:false}}}}],defaultColumnDef:{width:"auto"}}).inject(this.elements.container);this._treelistview.onContextualEvent=function(x){var w=[];return w};var r={actionDownload:{stdTemplate:"functionIcon",semantics:{icon:{iconName:"download",fontIconFamily:WUXManagedFontIcons.Font3DS}}},statusCheck:{stdTemplate:"functionIcon",semantics:{icon:{iconName:"check",fontIconFamily:WUXManagedFontIcons.Font3DS}}},statusRefresh:{stdTemplate:"functionIcon",semantics:{icon:{iconName:"refresh",fontIconFamily:WUXManagedFontIcons.Font3DS}}}};t.getTypeRepresentationFactory().registerTypeRepresentations(JSON.stringify(r));t.getContent().addClassName("do-datagridview");var v=this;t.onReady(function(){t.addEventListener("click",v._cellClicked.bind(v))});this._informationBox=UWA.createElement("div",{"class":"enoderivedoutputs_information"});UWA.createElement("span",{"class":"enoderivedoutputs_information_icon wux-ui-3ds wux-ui-3ds-5x wux-ui-3ds-docs"}).inject(this._informationBox);this._messageInformationBox=UWA.createElement("h2",{"class":"enoderivedoutputs_information_msg"}).inject(this._informationBox);this._informationBox.hide();this._informationBox.inject(this.elements.container)},_cellClicked:function(r,s){if(s&&s.nodeModel&&s.nodeModel.options.grid){switch(this._treelistview.layout.getDataIndexFromColumnIndex(s.columnID)){case"Download":if(typeof s.nodeModel.options.grid.Download!=="undefined"&&s.nodeModel.options.grid.Download===true){this._downloadDerivedOutput(s.nodeModel.options.grid)}break;case"Status":if(this._actionAuthorized!==false&&s.nodeModel.options.grid.Status===false&&this._getFormatIndex(this._formatList,s.nodeModel.options.grid.Format)>-1){this._updateDerivedOutput(s.nodeModel.options.grid,s)}break}}},_displayConversionOptions:function(y){if(y.nodeModel&&y.nodeModel.options.grid.ConverterAtt){y.nodeModel.options.grid.ConverterAtt=[["option1","value1"],["option2","value2"]];var t=y.nodeModel.options.grid.ConverterAtt;if(y.nodeModel.options.grid.ConverterAtt.length>0){var z=UWA.createElement("table",{"class":"do_conversion_options"});var w="<tr><th>"+d.popup.option+"</th><th>"+d.popup.value+"</th></tr>";var v,x,A;for(var u=0;u<t.length;u++){A=t[u];v=(typeof A[0]!=="undefined")?A[0]:undefined;x=(typeof A[1]!=="undefined")?A[1]:undefined;if(v!==undefined&&x!==undefined){w+="<tr><td>"+v+"</td><td>"+x+"</td></tr>"}}z.innerHTML=w;var s=y.cellView;var r=new c({target:s,trigger:"hover"});r.setBody(z)}}},_updateDerivedOutputCall:function(u,y){var v=this;var s=[];var t="DFUpdate"+q.v4();var x=u.Format;var w={model_identifier:{type:"VPMReference",id:this.nodeId[0]},target:x,title:t,batch_parameters:{version:"2.0",convinputs:[],inputs:[]}};s.push(w);var r={data:{DoJobs:s},webService:{url:e.generateJob.url,verb:e.generateJob.verb},callback:{onComplete:function(z){v._displayNotification("info",d.info.title,d.info.updateOK);y.disabled=true},onFailure:function(z){v._displayNotification("error",d.error.title,d.replace(d.error.updateFailed,{oMsg:z}))}}};j.SendServerRequest(r)},_updateDerivedOutput:function(r,t){var s=this;s._updateDerivedOutputCall(r,t)},_downloadDerivedOutput:function(t){if(!UWA.is(t)){throw new Error("## DerivedOutputList._downloadDerivedOutput: Invalid inputs")}var u=this;var s=t.Filename;var w=t.Format;var v=t.ObjectID;var r={data:{reps:[{id:v,keys:[{format:w,filename:s}]}]},webService:{url:e.downloadTicket.url,verb:e.downloadTicket.verb},callback:{onComplete:function(y){var x=UWA.is(y,"string")?JSON.parse(y):y;if(typeof y.ticketURL!=="undefined"&&typeof y.ticket!=="undefined"){var z=y.ticketURL+"?__fcs__jobTicket="+encodeURIComponent(y.ticket);u._downloadURL(z,s)}},onFailure:function(x){if(x){console.error(x)}}}};j.SendServerRequest(r)},_downloadURL:function(t,r){var s=new XMLHttpRequest();s.open("POST",t);s.responseType="blob";s.onload=function(){if(!window.navigator.msSaveBlob){var u=document.createElement("a");u.href=window.URL.createObjectURL(s.response);if(r){u.download=r}u.style.display="none";document.body.appendChild(u);u.click();u=undefined}else{window.navigator.msSaveBlob(s.response,r)}};s.send()},clickHandler:function(r){},_displayInformationBox:function(r){if(r==="noselection"){this._messageInformationBox.setText(d.derivedOutputsNoSelection)}else{if(r==="multiselection"){this._messageInformationBox.setText(d.derivedOutputsMultiSelection)}else{if(r==="noderivedoutputs"){this._messageInformationBox.setText(d.noderivedoutputs)}}}this._treelistview.getContent().hide();this._informationBox.show()},_getDerivedOutputs:function(s){this.nodeId=s.ids;if(!UWA.is(s)||!UWA.is(s.ids)){throw new Error("## DerivedOutputList.getDerivedOutputs: Invalid inputs")}var r={data:{ids:s.ids,attributes:s.attributes},webService:{url:e.doInformation.url,verb:e.doInformation.verb},callback:{onComplete:function(u){var t=UWA.is(u,"string")?JSON.parse(u):u;s.onComplete(t)},onFailure:function(t){s.onFailure(t)}}};j.SendServerRequest(r)},_getFormatList:function(){var w=[];var s,v,x,u,t;x=new DOMParser();u=x.parseFromString(p,"text/xml");var r=u.getElementsByTagName("Format");for(t=0;t<r.length;t++){v=r[t].getAttribute("ID");w.push(v)}return w},_getFormatIndex:function(u,t){t=t.toLowerCase();var r=-1;for(var s=0;s<u.length;s++){if(u[s].toLowerCase()===t){r=s;break}}return r},_getFormat:function(t,u){u=u.toLowerCase();var s;for(var r=0;r<t.length;r++){if(t[r].toLowerCase()===u){s=t[r];break}}return s},_generateNodesFromResults:function(A){A=UWA.is(A,"string")?JSON.parse(A):A;var D=[];for(var y=0;y<A.ids.length;y++){var x=A.ids[y];var C=x.id;if(x.streams){for(var r=0;r<x.streams.length;r++){var G=x.streams[r],C=x.id,s=G.filename,E=G.format,H=(G.isSync==="true"||G.isSync===true)?true:false,F=(G.downloadable==="true"||G.downloadable===true)?true:"",B=G.visible;var w=[];if(typeof G.converterAttributes!=="undefined"){w=Object.entries(G.converterAttributes)}if(B){var v={ObjectID:C,Status:H,Format:E,Filename:s,Download:F,ConverterAtt:w};D.push(v)}}}}this._model.prepareUpdate();for(var z=0;z<D.length;z++){var t=D[z];var u=f.createTreeNodeDataModel(this._model.options.dataModelSet,{label:t.text,grid:t});this._model.addChild(u)}this._model.expandAll();this._model.pushUpdate()},selectionModified:function(t){var r=this,s=0;if(UWA.is(t)){s=t.length}this._treelistview.getContent().show();this._informationBox.hide();r._model.empty();if(!UWA.is(t)||t.length===0){this._displayInformationBox("noselection")}else{if(t.length===1){r.physicalid=t[0].getID?t[0].getID():t[0];this._getDerivedOutputs({ids:[r.physicalid],attributes:["filename","format","isSync","downloadable","visible","converterAttributes"],onComplete:function(u){var x={};var v={};try{x=UWA.is(u,"string")?JSON.parse(u):u}catch(w){}if(!x||!x.ids||!x.ids[0]||x.ids[0].streams.length===0){r._displayInformationBox("noderivedoutputs");return}r._generateNodesFromResults(x)},onFailure:function(){r._displayInformationBox("noderivedoutputs")}})}else{this._displayInformationBox("multiselection")}}},_displayNotification:function(u,s,r){window.notifs=n;o.setNotificationManager(window.notifs);var t={level:u,title:s,message:r,sticky:false};window.notifs.addNotif(t)}});return l});define("DS/ENODODisplay/commands/facets/DerivedOutputFacet",["css!DS/ENODODisplay/ENODODisplay","UWA/Core","UWA/Controls/Abstract","UWA/Class","i18n!DS/ENODODisplay/assets/nls/ENODisplayDO.json","DS/ENODODisplay/views/DerivedOutputList"],function(a,h,g,c,b,e){var d=require("DS/EditPropWidget/facets/Common/FacetsBase");var f=c.extend(g,d,{_derivedOutputList:null,_actionAuthorized:true,init:function(i){i.action=["link"];this._parent(i);this._actionAuthorized=(!h.is(this.options)||!h.is(this.options.activateActions))?true:this.options.activateActions;this._initUI()},_initUI:function(){var i=this;if(i._derivedOutputList===null){i.elements.container=h.createElement("div",{"class":"do-evolution",});this._derivedOutputList=new e({action:["refresh"],activateActions:this._actionAuthorized});this._derivedOutputList.elements.container.inject(this.elements.container)}},updateFacet:function(){var j=this;var i=this.getModel();if(i){var k=i.get("objectId");this._derivedOutputList.selectionModified([k])}else{this._derivedOutputList.selectionModified([])}},destroyComponent:function(){},onResize:function(){},onRefresh:function(){this.updateFacet()}});return f});