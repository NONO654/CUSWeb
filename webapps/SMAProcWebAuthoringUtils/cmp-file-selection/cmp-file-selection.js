require(["DS/JSCMM/SMAJSCMMBase","DS/JSCMM/SMAJSCMMDataHandler","DS/SMAProcWebCMMUtils/SMAJSCMMUtils","DS/SMAProcWebCMMUtils/SMAJSCMMAuthoringUtils","DS/JSCMM/SMAJSCMMContent","DS/JSCMM/SMAJSCMMParameter","DS/JSCMM/SMAJSCMMObjectParameterHandler","DS/SMAProcWebCommonControls/ParameterChooser"],function(h,f,b,i,a,e,d){var g={ONFILESELECT:"fileselected",ONFILEDOWNLOAD:"filedownloaded",ONFILEDOWNLOADFAILED:"filenotdownloaded",ONMULTIPLEFILESMATCHED:"multiplefilesfound",ONFILESELECTIONREADY:"pcwFileSelectionReady"};var c=0;Polymer({is:"cmp-file-selection",properties:{activity:{notify:true,observer:"activityChanged"},datahandlerconfigstring:{type:String,notify:true,observer:"datahandlerconfigstringChanged"},filetypes:{type:String,notify:true},actionType:{type:String,value:"download",observer:"_actionTypeChange"},selectedDocument:{value:null},selectedFile:{value:null},contentType:{type:String,value:"content",observer:"_contentTypeChanged"},disabled:{type:Boolean,value:false,reflectToAttribute:true}},listeners:{"contentChooser.change":"_contentChooserChanged","ruleInput.change":"_ruleInputChanged","contentGroup.change":"_contentTypeClicked","parameterChooser.pcw-parameter-selected":"_parameterSelected"},_actionTypeChange:function(){if(this._dataHandler){this._dataHandler.type=this.actionType}if(this.paramHandler){this.paramHandler.type=this.actionType}},_contentTypeChanged:function(){if(this.$&&this.$.contentChooser){if(this.contentType==="parameter"){this.$.rdParam.checked=true}else{this.$.rdContent.checked=true}this._toggleContentMode(this.contentType)}},_contentTypeClicked:function(k){var j=this;console.log(k);this.contentType=k.target.value;k.stopPropagation();var l=this.querySelector("datalist");if(l){Polymer.dom(this.root).removeChild(l)}this.setSilently("ruleInput",function(){j.$.ruleInput.value=""});if(this.contentType==="content"){if(this.$.contentChooser.getSelectedContent){this._contentChooserChanged()}}else{if(this.$.parameterChooser.getSelectedParameter){var m=this.$.parameterChooser.getSelectedParameter();if(m&&m.parameter){this._parameterSelected({detail:m})}}}},_toggleContentMode:function(j){var k=j==="parameter";this.$.contentChooser.style.display=k?"none":"block";this.$.parameterChooser.style.display=k?"block":"none"},isParamObjectMode:function(){return this.$.rdParam.checked},_parameterSelected:function(n){var l=this;var j=function(p){return new Promise(function(r,q){if(l._cache._files[p._data.objectId]){r(l._cache._files[p._data.objectId])}else{l.$.spFileContent.getContentInfo(p._data.objectId).then(function(t){var s=JSON.parse(t);l._cache._files[p._data.objectId]=s;r(s)},function(s){q(s)})}})};var o=n.detail.parameter;var k=o.getValue();var m=o.getName();l.selectedDocument=o;k&&j(k).then(function(s){var p=l.populateObjectParameterFiles(s);var q=l._cache._selectedFile||"";if(!q&&p.length>0){q=p[0].value;l._cache._selectedFile=q}if(q){l.setSilently("ruleInput",function(){l.$.ruleInput.value=q});l.paramHandler.createDataHandlerConfig(l.actionType,l.activity,m,q);var r=l.paramHandler.getRuleString();if(r){l.setPropSilently("datahandlerconfigstring",r);l.fire(g.ONFILESELECT,l)}}},function(p){console.error(p)})},setPropSilently:function(k,j){this._suppress[k]=true;this[k]=j;this._suppress[k]=false},setSilently:function(k,j){this._suppress[k]=true;j.call(this);this._suppress[k]=false},_contentChooserChanged:function(){var j=this.$.contentChooser.getSelectedContent();var k=j&&j.getObjectType();if(k==="Document"||/Simulation Document/.test(k)){this.selectedDocument=j;this.populateFileList(j);var l=this.querySelector("datalist option");this.$.ruleInput.value=l?l.value:"";this._ruleInputChanged()}},_ruleInputChanged:function(){if(this._suppress.ruleInput){return}var l=this.$.ruleInput.value;if(this.selectedDocument instanceof e){var n=this.selectedDocument;var k=this._cache._selectedFile;if(k!==l){this._cache._selectedFile=l;this.paramHandler.createDataHandlerConfig(this.actionType,this.activity,n.getName(),l);var m=this.paramHandler.getRuleString();if(m){this.setPropSilently("datahandlerconfigstring",m);this.fire(g.ONFILESELECT,this)}}}else{var k=this._dataHandler.getFileName();var j=this._dataHandler.getDocument();if(!this.datahandlerconfigstring||l!==k||this.selectedDocument!==j){if(this._dataHandler.ruleObj&&this._dataHandler.ruleObj.rule){this.activity.removeTempSimulationData(this._dataHandler.ruleObj.rule.referenceId)}this._dataHandler.setFileName(l);this._dataHandler.setDocument(this.selectedDocument);this.datahandlerconfigstring=this._dataHandler.createDataHandlerConfig(this.activity,this.selectedDocument,l)}}},ready:function(){this._dataHandler=new f("com.dassault_systemes.sma.datahandler.DataHandlerPLM",this.actionType);this.paramHandler=new d();this._suppress.datahandlerconfigstring=false;this.$.contentChooser.activity=this.activity;if(this.$.parameterChooser.setDataContainer){this.$.parameterChooser.setDataContainer(this.activity)}this.datahandlerconfigstringChanged(this.datahandlerconfigstring);this._contentTypeChanged()},created:function(){this._suppress={datahandlerconfigstring:true};this._cache={_files:{},_selectedFile:null}},attached:function(){this.fire(g.ONFILESELECTIONREADY)},activityChanged:function(j){if(j instanceof h){this.activity=j;this.$.parameterChooser.setDataContainer(j);this.$.contentChooser.activity=this.activity}else{console.warn("<"+this.is+"> activityChanged but new value is not activity:",j)}},datahandlerconfigstringChanged:function(k){console.log("New rule string generated",this.datahandlerconfigstring);if(this._suppress.datahandlerconfigstring){return}if(k){var l=this.datahandlerconfigstring.match(/\s+parameterName\s*=\s*"/);if(l&&l.length>0){if(this.activity){this.paramHandler.parseRuleString(this.datahandlerconfigstring,this.activity);this.contentType="parameter";var m=this.paramHandler.getParameter();var n=this.paramHandler.getFileName();this._cache._selectedFile=n;this.selectedDocument=m;var j=m.getName&&m.getName();if(j){this.$.parameterChooser.selectParameterByName(j)}}}else{if(!this.activity){console.warn("<"+this.is+"> datahandlerconfigstringChanged falsy activity:",this.activity);return}if(!this._dataHandler.parseDataHandlerConfig(this.datahandlerconfigstring,this.activity)){return}this.contentType="content";this.selectedDocument=this._dataHandler.getDocument();this.$.ruleInput.value=this._dataHandler.getFileName();this._ruleInputChanged();if(this.selectedDocument instanceof a){this.$.contentChooser.selectedobject=this.selectedDocument;this.fire(g.ONFILESELECT,this)}else{console.warn("<"+this.is+"> datahandlerconfigstringChanged selectedDocument is not instanceof content: ",this.selectedDocument,"\n  New datahandlerconfigstring:",k,"\n  Activity:",this.activity,"\n  Data Handler:",this._dataHandler)}}}},populateFileList:function(j){var o=this;if(j instanceof h){var n=o._createNewFileDataList();var m=j.getFiles();var l=m.map(function(p){return p.getName()});var k=l.filter(function(p){return o.$.contentChooser.checkFileTypeSupport(o.filetypes,p)});k.forEach(function(p){var q=document.createElement("option");q.value=p;Polymer.dom(n).appendChild(q)})}},_createNewFileDataList:function(){var k=this.querySelector("datalist");if(k){Polymer.dom(this.root).removeChild(k)}var j=document.createElement("datalist");j.id="cmpDatalist"+c++;this.$.ruleInput.setAttribute("list",j.id);Polymer.dom(this.root).appendChild(j);return j},populateObjectParameterFiles:function(k){var j=this;var l=j._createNewFileDataList();return k.map(function(m){return m.basics.name}).filter(function(m){return j.$.contentChooser.checkFileTypeSupport(j.filetypes,m)}).map(function(m){var n=document.createElement("option");n.value=m;Polymer.dom(l).appendChild(n);return n})},saveDataHandlerConfig:function(){if(this.activity&&this.selectedDocument){if(this.datahandlerconfigstring){this._dataHandler.parseDataHandlerConfig(this.datahandlerconfigstring,this.activity)}else{var j=this.$.idValue.value;if(j){this.datahandlerconfigstring=this._dataHandler.createDataHandlerConfig(this.activity,this.selectedDocument,j)}}}},getSelectedFile:function(){if(this.isParamObjectMode()){return this.paramHandler.getFileName()}else{var j=this._dataHandler.getFileName();var k=this._dataHandler.getFile(j);return k}},getSelectedFileDownloaded:function(){var n=this;var l=this.getSelectedFile();if(l===null){console.warn("<"+n.is+"> entered pattern"+this._dataHandler.getFileName()+" mathced to multiple files. Single file download is not possible. Quitting File Download");n.fire(g.ONMULTIPLEFILESMATCHED,n);return}var j=this.isParamObjectMode();var k=j?l:l.getName();var m=j?this.selectedDocument.getValue()._data.objectId:this.selectedDocument.getPhysicalId();if(m&&k){i.downloadFileFromDocument(m,k,null,{onSuccess:function(o){n._fileObj=o;console.info("<"+n.is+'> successfully downloaded file "'+k+'" from document: '+m);n.fire(g.ONFILEDOWNLOAD,n)},onFailure:function(){console.warn("<"+n.is+'> failed to download file "'+k+'" from document: '+m);n.fire(g.ONFILEDOWNLOADFAILED,n)}})}}})});