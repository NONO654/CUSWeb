require(["DS/SMAProcWebCMMUtils/SMAJSCMMAuthoringUtils","DS/JSCMM/SMAJSCMMActivity","DS/JSCMM/SMAJSCMMDataContainer","DS/DataDragAndDrop/DataDragAndDrop","DS/SMAProcWebCMMUtils/SMAJSCMMWebInWinUtils","DS/SMAProcWebCMMUtils/SMAWINAuthoringUtils","DS/SMAProcWebCMMException/SMAProcWebCMMError","DS/SMAProcWebExceptionManager/SMAProcWebErrorManager","DS/Logger/Logger","module"],function(m,g,l,e,f,h,d,c,b,a){var i={ONCONTENTSELECT:"change",CONTENTCHOOSERREADY:"pcwContentChooserReady"};var j=function(n){return n instanceof g||n instanceof l};var k=b.getLogger(a);Polymer({is:"cmp-content-chooser",properties:{activity:{notify:true,observer:"activityChanged"},selectedobject:{notify:true,observer:"selectedobjectChanged"},documentcreate:{type:Boolean,value:false,reflectToAttribute:true},objectTypes:{type:String,value:"",notify:true,reflectToAttribute:true},filetypes:{type:String,notify:true,reflectToAttribute:true},_contentContainer:{type:Object},_isVersioned:{type:Boolean,value:false},disabled:{type:Boolean,value:false,reflectToAttribute:true}},listeners:{"contentDropDown.item-clicked":"_contentListItemClicked","searchWidget.change":"_searchWidgetChanged","contentChooserFile.change":"_contentChooserChanged",PCWSelectedContentChanged:"_PCWSelectedContentChanged"},_contentListItemClicked:function(o){var p=o&&o.detail&&o.detail.selectedItem;var n=p.value;if(j(n)||(n&&n.isContentContainer())){o.stopPropagation();this._containerSelected(n)}else{this.selectedobject=n;var q=this.$.contentDropDown;q.label=p.label;q.icon=p.icon;q.visible=false;this.fire(i.ONCONTENTSELECT,this)}},_searchWidgetChanged:function(s){if(s){s.stopPropagation()}var t=this.$.searchWidget.getSelectedObjects();var q=t[0];var p=q.objectType;if(!this.checkTypeCompatibility(p)){var r="This type of content ("+p+") can not be added. Please choose from following types"+this.objectTypes;c.notifyError(new d("Error",r),{target:this.$.notification,autoRemove:false})}else{var o=this.$.searchWidget.getSelectedObjectIds();var n=o[0];this.addRefContent(n);k.log("Selected object is"+n)}},_contentChooserChanged:function(o){if(o){o.stopPropagation()}var n=o.target.files;if(this.documentcreate===true){this.createDocument(n,this._isVersioned)}},_PCWSelectedContentChanged:function(n){k.log("<"+this.is+"> PCWSelectedContentChanged handler: new content selected");this.selectedobject=n.detail.content;this.fire(i.ONCONTENTSELECT,this)},attached:function(){var n=this;n.fire(i.CONTENTCHOOSERREADY,n);this.async(function(){if(window.widget){Polymer.dom(n.$.searchWidget).setAttribute("widgetId",window.widget&&window.widget.id)}var o=n.querySelector("#contentDropDown");e.droppable(o,{drop:function(t,u,q){var s=null;var r;var z;try{s=JSON.parse(t||"")}catch(v){s=null;r=v;try{t=q.dataTransfer.getData("text/searchitems")||"";s=JSON.parse(t)}catch(w){if(q.dataTransfer.files.length){if(n.documentcreate===false){z="File is not valid type of content. Please consider choosing PLMObject from following types: "+n.objectTypes;c.notifyError(new d("Error",z),{target:this.$.notification,autoRemove:false})}else{n.createDocument(q.dataTransfer.files,false)}}s=null;r=w}if(!s){k.log("Failed to parse data",r,t)}}if(s!==undefined&&s!==null&&"data" in s&&"items" in s.data){var y=s.data.items[0];var p=y.objectType;if(!n.checkTypeCompatibility(p)){z="This type of content can not be added. Please choose from following types"+n.objectTypes;c.notifyError(new d("Error",z),{target:this.$.notification,autoRemove:false})}else{var x=y.objectId;n.addRefContent(x)}}}})})},ready:function(){this.componentReady=false;if(this.activity){this.activityChanged(this.activity)}if(this.selectedobject){this.selectedobjectChanged()}},onSearchClicked:function(){k.log("<"+this.is+"> onSearchClicked");if(h.isWebInWin()){var n=this.objectTypes;var o="ReferencedContent";this._handleWebInWin(n,o)}else{this.$.searchWidget.search()}},onNVDocCreateClicked:function(){this._showFileCreationDialog(false)},onVDocCreateClicked:function(){this._showFileCreationDialog(true)},_showFileCreationDialog:function(o){if(h.isWebInWin()){var n="Simulation Document - "+(o?"Versioned":"Non Versioned");var q="OwnedContent";this._handleWebInWin(n,q)}else{this._isVersioned=o;var p=Polymer.dom(this.root).querySelector("#contentChooserFile");p.click()}},activityChanged:function(n){if(n){this._containerSelected(n)}else{k.warn("<"+this.is+"> activityChanged but new value is not activity:",n)}},_containerSelected:function(n){var p=this;if(j(n)){p.activity=n;p._contentContainer=null;var o=p.activity.getContentChildren();var q=null;o.forEach(function(r){q=q||r;if(r.getObjectType()==="Simulation Category - Internal Data"){p._contentContainer=r}});if(!p._contentContainer){k.info("<"+this.is+"> could not select internal data category, fallbacking on: ",q);p._contentContainer=q}}else{p._contentContainer=n}p.updateContentDropdown(n)},updateContentDropdown:function(p){var o=this;var q=o.$.contentDropDown;q.removeAll();if(!j(p)){q.addItem("Go Home...",this.activity,null,"fonticon-home");q.addItem("Go Up One Level",p.getParent(),null,"fonticon-level-up")}var n=p.getContentChildren();n.forEach(function(r){if(r.isContentContainer()||o.checkTypeCompatibility(r._data.busType)){q.addItem(r.getName(),r,r.getFieldValue("image","imageValue"))}})},addRefContent:function(n){if(this.activity&&this._contentContainer){var o=this;m.addReferencedContent(this.activity,this._contentContainer,n,{onSuccess:function(p){o.selectedobject=p;o.fire(i.ONCONTENTSELECT,o);k.log("Content added succesfully")},onError:function(){var p="Failed to add a new content.";c.notifyError(new d("Error",p),{target:this.$.notification,autoRemove:false})}})}else{k.warn("<"+this.is+"> addRefContent skipped as activity ("+this.activity+") or content container ("+this._contentContainer+") is not available")}},checkTypeCompatibility:function(n){if(!this.objectTypes){return true}var o=this.objectTypes.split(/, */);if(o.indexOf("DOCUMENTS")>=0){o.push("Simulation Document")}if(o.indexOf("Simulation Document")>=0){o.push("Simulation Document - Versioned");o.push("Simulation Document - NonVersioned")}return o.indexOf(n)>-1},checkFileTypeSupport:function(p,n){if(!p){return true}var r=/(?:\.([^.]+))?$/;var o=r.exec(n)[0];var q=(p||"").split(/, */);return q.indexOf(o)>-1},getSelectedContent:function(){return this.selectedobject},createDocument:function(n,o){k.log("<"+this.is+"> createDocument activity:",this.activity);var q=n[0];var p=q.name.split(".")[0];var v=null;var t=0;var u=this;var r=false;if(j(this.activity)){v=this.activity}else{v=this.activity.getParent()}for(t=0;t<n.length;t++){var s=n[t].name;var w=u.checkFileTypeSupport(u.filetypes,s);if(!w){r=false;var x='File "'+this.fileName+'" is not supported. Document create aborting.';c.notifyError(new d("Error",x),{target:this.$.notification,autoRemove:false});break}else{r=true}}if(r){m.createOwnedDocument(v,this._contentContainer,o,p,{onSuccess:function(z){for(t=0;t<n.length;t++){q=n[t];var y=q.name;if(u.checkFileTypeSupport(u.filetypes,y)){m.uploadFileToDocument(z,q,y,{onSuccess:function(){k.log("<"+u.is+'> createDocument file "'+y+'" added successfully');if(t===n.length){u.selectedobject=z;u.fire(i.ONCONTENTSELECT,this)}},onError:function(){k.log("<"+u.is+"> createDocument File upload to document failed")}})}else{var A="Failed to upload following file "+y+". Please choose from following types"+u.filetypes;c.notifyError(new d("Error",A),{target:this.$.notification,autoRemove:false})}}}})}},selectedobjectChanged:function(){var n=this.selectedobject;if(n){this.$.contentDropDown.icon=n.getFieldValue("image","imageValue");this.$.contentDropDown.label=n.getName()}},_handleWebInWin:function(v,t){var r;var q=this.activity.getContentChildren();for(var n=0;n<q.length;n++){var o=q[n];if(o.getObjectType()==="Simulation Category - Internal Data"){r=o}}var p=r.getId();var u=f.createContentMessage(t,"POST",p,v,this.id);var s=(new XMLSerializer()).serializeToString(u);h.sendMessage(s)},_isStrictlyTrue:function(n){return n===true},createXMLMessageForWebInWin:function(){var o=new DOMParser();var n=o.createElement("DataForWebInWin");o.appendChild(n)}})});