define("DS/SMAProcWebAuthoringUtils/cmp-parameter-table/ParameterTableGridView",["UWA/Core","UWA/Controls/Abstract","DS/SMAProcWebAuthoringUtils/cmp-parameter-table/RulesEditorDataGrid","DS/Tree/TreeDocument","DS/Tree/TreeNodeModel","DS/TreeModel/DataModelSet","DS/DataGridView/DataGridView","DS/SMAProcWebCMMUtils/SMAJSCMMUtils","DS/Logger/Logger","DS/SMAProcWebAuthoringUtils/ParameterUIUtil","DS/SMAProcWebContents/WUXControlUtil","module","css!DS/SMAProcWebAuthoringUtils/cmp-parameter-table/ParameterTableGridView.css","css!DS/UIKIT/UIKIT.css"],function(p,m,j,a,k,l,b,c,f,e,n,d){var h,g,o,i,q;q=f.getLogger(d);g=function(F){var w;var u=F.nodeModel;var z=this;if(!F.isHeader){var B=u.options.grid.Name+"_"+F.dataIndex;var D=u.options&&u.options.grid&&u.options.grid.parameter;var r=u.options.grid;var E=r.Value;var y=false;var x=n.decideEditor(r,y);var v={readonly:y,choices:r.Choices,type:r.Type};if(x==="contentchooser"){var t,A,s,G,C;if(D.getValue()&&D.getValue()._data){t=D.getValue()._data.busType;if(t===undefined){t=D.getValue()._data.objectTypeValue}A=D.getValue()._data.dataelements&&D.getValue()._data.dataelements.title&&D.getValue()._data.dataelements.title.value[0].value;s=D.getValue()._data.dataelements&&D.getValue()._data.dataelements.name&&D.getValue()._data.dataelements.name.value[0].value;G=D.getValue()._data.displayName;C=D.getValue()._data.objectId}if(A===""){A=s}else{if(A===undefined){A=G}}v={displayName:A,busType:t,objectId:C,readonly:y}}w=n.createControl(B,x,E,v);if(p.is(w)){F.cellView.elements.container.setContent(w)}w.addEventListener("onChange",function(N){N.preventDefault();N.stopImmediatePropagation();var M,L,I={name:"Value"};D=u.options&&u.options.grid&&u.options.grid.parameter;if(D){if(x==="contentchooser"){I.newObject=N.detail.newObject;I.value=N.detail.newObject;L={grid:{Value:N.detail.newObject.displayName}}}else{M=N.options.value;var J=u.options.grid.Type;if(J==="Integer"){M=Number(M);if(typeof M==="number"){I.value=M;L={grid:{Value:M}}}else{I.value=u.options.grid.Value;L={grid:{Value:u.options.grid.Value}}}}else{I.value=M;L={grid:{Value:M}}}}z.updateNodeOptions(u,L,true);z.dispatchEvent("updateparameter",[D,I,F.nodeModel])}else{if(!D){var H;var K=u.getParent().options.grid.parameter;H=u.options.grid.Name;M=N.options.value;I={name:"Value",value:M,index:H};L={grid:{Value:M}};z.updateNodeOptions(u,L,true);z.dispatchEvent("updateparameter",[K,I,F.nodeModel.getParent()])}}});w.addEventListener("onClear",function(J){J.preventDefault();J.stopImmediatePropagation();D=u.options&&u.options.grid&&u.options.grid.parameter;if(D){var I={grid:{Value:""}};z.updateNodeOptions(u,I,true);var H={name:"Value",value:""};z.dispatchEvent("updateparameter",[D,H,F.nodeModel])}})}return w};i=function(v){var u;var w=v.nodeModel;var t=this;if(!v.isHeader){if(!w.options.grid.nonValueColumnReadOnly){var r;var s=w.options.grid.Name+"_Edit";u=document.createElement("div");r=document.createElement("span");r.setAttribute("id",s);r.setAttribute("title","Edit");r.classList.add("fonticon");r.classList.add("fonticon-pencil");r.classList.add("icon");u.appendChild(r);r.addEventListener("click",function(x){x.preventDefault();x.stopImmediatePropagation();t.nodeToModify=v.nodeModel;t.dispatchEvent("editParameterInDetail",[[{parameter:v.nodeModel.options.grid.parameter,node:v.nodeModel}]])});v.cellView.elements.container.setContent(u)}}return u};o=m.extend({name:"ParameterTableGridView",_initDefaultOptions:function(){this.nodeParamUpdateCache={};h=[{dataIndex:"tree",text:"Name",width:220,pinned:"left"},{dataIndex:"Mode",text:"Mode",width:88,isFilterable:true,typeRepresentation:"Mode"},{dataIndex:"Type",text:"Type",width:110,isFilterable:true,typeRepresentation:"Type"},{dataIndex:"Value",text:"Value",width:200,getCellEditableState:function(r){if(r.nodeModel.options.nonValueColumnReadOnly){return false}return true},onCellRequest:g.bind(this)},{dataIndex:"Expression",text:"Expression",width:100},{dataIndex:"Description",text:"Description",width:"200"},{dataIndex:"Action",text:"",width:40,sortableFlag:false,onCellRequest:i.bind(this)}]},publishedProperties:{state:{type:"string",defaultValue:"",noNeedToApplyFlag:true}},init:function(r){this.nodeToModify=null;this._parent(r);this._initDefaultOptions();this._buildParameterView()},addNodes:function(s){var v,t,u=[],r=false;this._model.prepareUpdate();r=s&&s.length===1;s.forEach(function(y){y.text=y.Name;y.tree=y.Name;t=k.createTreeNodeDataModel(this.dataModelSet,{label:y.text,grid:y});if(typeof y.Value==="object"){for(v in y.Value){var x={text:v,tree:v,Value:y.Value[v],Mode:"",Expression:"",Description:"",Type:y.Type,Choices:"",nonValueColumnReadOnly:true,parent:y.Name};var w=k.createTreeNodeDataModel(this.dataModelSet,{label:x.tree,grid:x});t.addChild(w)}}this._model.addRoot(t)}.bind(this));this.rulesEditor&&this.rulesEditor.onAddRows(s,0);this._model.pushUpdate();if(r&&(s.length!==u.length)){this.scrollToNode(t)}},addToNodeUpdateCache:function(t){var r,s;t&&t.forEach(function(u){s=u.parameter;r=u.node;if(s.getState()===c.State.Modified){if(!this.nodeParamUpdateCache[s.getId()]){this.nodeParamUpdateCache[s.getId()]={node:r,oldParameter:s.getReference()}}}}.bind(this))},updateParameterToNodeAfterSave:function(){var r,s=[];for(r in this.nodeParamUpdateCache){if(this.nodeParamUpdateCache.hasOwnProperty(r)){s.push({node:this.nodeParamUpdateCache[r].node,parameter:this.nodeParamUpdateCache[r].oldParameter})}}this.updateNodes(s,false);this.nodeParamUpdateCache={}},unselectAll:function(){this.elements._dataGridView&&this.elements._dataGridView.unselectAll()},scrollToNode:function(r){setTimeout(function(){r.highlight();setTimeout(function(){r.unhighlight()},2000)},500)},updateNodeOptions:function(s,u,r){var t={grid:{}};t.grid[u.name]=u.value;p.extend(s.options,t,r);u.grid&&u.grid.parameter&&this.addToNodeUpdateCache([{node:s,parameter:u.grid.parameter}])},updateNodes:function(t,s){var r=[];this._model.prepareUpdate();t.forEach(function(v){var u=this.getDataToBeModified(v.parameter);r.push(v.parameter);u.text=u.Name;u.tree=u.Name;v.node.updateOptions({label:u.text,grid:u});if(v.node.getChildren()){this.updateChildNodes(v.node)}}.bind(this));this.rulesEditor&&this.rulesEditor.onAddRows(r,0);this._model.pushUpdate();if(!s){this.addToNodeUpdateCache(t)}},updateView:function(){this.elements._dataGridView.updateView(true)},updateChildNodes:function(s){var v=false;if(s&&s.options.grid.parameter._getStructureName()==="Array"){var r=s.options.grid.parameter;var t=e.calculateDisplayValue(r);v=s.isExpanded();this._model.prepareUpdate();s.removeChildren();for(var w in t){var u=k.createTreeNodeDataModel(this.dataModelSet,{label:w,grid:{text:w,Name:w,Value:t[w],Mode:"",Expression:"",Description:"",Type:r._getDataTypeName(),Choices:"",nonValueColumnReadOnly:true,parent:r.getName()}});s.addChild(u)}}if(v){s.expand()}this._model.pushUpdate()},getDataToBeModified:function(t){var r;if(t._getDataTypeName()==="Object"){if(t.getValue()){r=t.getValue()._data.displayName}else{r=" "}}var s={text:t.getName(),Name:t.getName(),Value:r||e.calculateDisplayValue(t),Mode:t._getModeName(),Expression:t.getExpression()||"",Description:t.getDescription(),Type:t._getDataTypeName(),parameter:t,Choices:!t.getDimensions?t.getLimits().join(", "):""};return s},_fireSelectedNodesEvent:function(){var r=this.getSelectedNodeParameter();this.dispatchEvent("parameterSelected",[r])},_loadDocument:function(){this.dataModelSet=new l();var r=new a({dataModelSet:this.dataModelSet});r.prepareUpdate();var u=this.options.data;for(var s=0;s<u.length;s+=1){u[s].text=u[s].Name;u[s].tree=u[s].Name;var v=k.createTreeNodeDataModel(this.dataModelSet,{label:u[s].text,grid:u[s]});if(typeof u[s].Value==="object"){for(var w in u[s].Value){var t=k.createTreeNodeDataModel(this.dataModelSet,{label:w,grid:{tree:w,Name:w,Value:u[s].Value[w],Mode:"",Expression:"",Description:"",Type:u[s].Type,Choices:"",nonValueColumnReadOnly:true,parent:u[s].Name}});v.addChild(t)}}r.addRoot(v)}r.pushUpdate();this._model=r;setTimeout(function(){this.dispatchEvent("parametertableready");this._fireSelectedNodesEvent()}.bind(this),50)},unloadDocument:function(){try{this._model=null;this.elements._dataGridView.layout.destroy();this.elements._dataGridView.destroy();this.elements.body.destroy();this.elements.tableContainer.empty();this.rulesEditor&&this.rulesEditor.destroy();this.rulesEditor=null}catch(r){q.warn(r)}},getColumnIndexDataIndex:function(s,u){var r=-1,t=0;s.forEach(function(v){if(v.dataIndex===u){r=t}t+=1});return r},_buildParameterView:function(){var u,s,w,x=this;this.elements=this.options.elements;this.elements.tableContainer.classList.add("wux-controls-input-output");this._model=new a({useAsyncPreExpand:false});u=this.options.columns||h;s=this.getColumnIndexDataIndex(u,"Type");w=this.getColumnIndexDataIndex(u,"Mode");if(s!==-1){u[s].isFilterable=this.options.filterType}if(w!==-1){u[w].isFilterable=this.options.filterMode}x._loadDocument();this.elements._dataGridView=new b({treeDocument:x._model,columns:u,selectionMode:"cell",defaultColumnDef:{width:"auto",typeRepresentation:"string",editableFlag:true,resizableFlag:true,sortableFlag:true,editionPolicy:"EditionOnOver",getCellEditableState:function(z){if(z.nodeModel.options.grid.nonValueColumnReadOnly){return false}return true}}});this.elements._dataGridView.addEventListener("postEdit",function(G,I){G.preventDefault();G.stopImmediatePropagation();var A=I.nodeModel;var H=A.options.grid.parameter;var D=h[I.columnID].text;var z=I.cellModel;var C={};var B=true;if(D==="Name"){if(z!==H.getName()){var F=e.validateParameterName(H.getParent(),z,H.getName());if(!F.isValid){z=F.validValue;x.dispatchEvent("notify",[F.errorMsg]);var E=[{node:A,parameter:H}];x.updateNodes(E,false);B=false}else{C.name="Name"}}}else{if(["Mode","Type","Expression","Description"].indexOf(D)>-1){C.name=D}}if(B){C.value=z;x.updateNodeOptions(A,C,true);x.dispatchEvent("updateparameter",[H,C,I.nodeModel])}});var r=this._model.getXSO();r.onChange(function(){var z=this.getSelectedNodeParameter();this.dispatchEvent("parameterSelected",[z])}.bind(this));var v={In:"In",Out:"Out","In/Out":"In/Out",Neutral:"Neutral"};var y={String:"String",Boolean:"Boolean",Integer:"Integer",Real:"Real",Timestamp:"Timestamp",Object:"Object"};var t={Mode:{stdTemplate:"enumCombo",semantics:{possibleValues:v,valueType:"enumCustom"}},Type:{stdTemplate:"enumCombo",semantics:{possibleValues:y,valueType:"enumCustom"}}};this.elements._dataGridView.getTypeRepresentationFactory().registerTypeRepresentations(JSON.stringify(t));this.elements._dataGridView.elements.container.addClassName("wux-controls-parameter-table-view");this.elements.body=new p.createElement("div",{"class":"wux-controls-parameter-body",html:[{tag:"div",styles:{position:"relative",height:"100%"},html:this.elements._dataGridView}]});this.elements.body.inject(this.elements.tableContainer);this.elements._dataGridView.onReady(function(){x.rulesEditor&&x.rulesEditor.destroy();x.rulesEditor=new j({spreadsheet:x.elements._dataGridView,container:x.options.elements.filterContainer,searchDelay:500,columns:x.columns,show:{download:false,tablePreferences:false,subscription:false}})})},getSelectedNodeParameter:function(){var s=this._model.getSelectedNodes(),r=[];s.forEach(function(t){if(t&&t.options&&t.options.grid&&t.options.grid.parameter){r.push({parameter:t.options.grid.parameter,node:t})}});return r},getSelectedNodes:function(){var r=this._model.getSelectedNodes();return r},getNodesFromParameterTitles:function(t){var s=[];var r=this._model.getRoots();if(r&&r.length>0){t.forEach(function(u){r.forEach(function(v){if(v.options.grid.parameter.getName()===u){s.push({title:u,node:v})}})})}return s},removeNodes:function(r){this._model.prepareUpdate();r.forEach(function(s){s.node.remove()});this._model.pushUpdate();this._fireSelectedNodesEvent()}});return o});