define("DS/SMAProcWebAuthoringUtils/cmp-parameter-auto-mapping/cmp-parameter-auto-mapping",["DS/SMAProcWebCommonControls/utils","text!DS/SMAProcWebAuthoringUtils/cmp-parameter-auto-mapping/cmp-parameter-auto-mapping.html","DS/SMAProcWebCMMUtils/SMAJSCMMDataFlowUtils","DS/SMAProcWebCMMUtils/SMAJSCMMParameterUtils","DS/SMAProcWebCMMUtils/SMAJSCMMDataContainerUtils","DS/JSCMM/SMAJSCMMUtils","DS/Controls/Toggle","DS/Controls/TooltipModel","UWA/Core","DS/SMAProcWebAuthoringUtils/cmp-parameter-auto-mapping/PendingMappingTableView","DS/SMAProcWebAuthoringUtils/ParameterUIUtil","DS/SMAProcWebCMMUtils/SMAJSCMMDataFlowUtilsNLSUtils","i18n!DS/SMAProcWebCMMUtils/assets/nls/SMAJSCMMDataFlowUtilsNLS"],function(m,i,k,q,c,b,p,n,g,a,d,o,j){m.registerDomModule(i);var h={ONETOMANY:"ONETOMANY",ROUTE:"ROUTE"};var f={INVALID_RELATIONSHIP:"INVALID_RELATIONSHIP",INVALID_STRUCTURE:"INVALID_STRUCTURE",INVALID_DATATYPE:"INVALID_DATATYPE",SEQUENCE_BROKEN:"SEQUENCE_BROKEN",ALREADY_MAPPED:"ALREADY_MAPPED"};var e={ONETOMANY:{TITLE:j["Dataflow.Mode.oneToMany"],MESSAGE:j["Dataflow.Mode.oneToManyToolTip"]},ROUTE:{TITLE:j["Dataflow.Mode.sequential"],MESSAGE:j["Dataflow.Mode.sequentialToolTip"]}};var l="320";return window.Polymer({is:"cmp-parameter-auto-mapping",properties:{mode:{type:String,value:h.ONETOMANY,observer:"onModeChange"},placeholderstate:{type:String,value:"1"},selectionstate:{type:Boolean,value:false}},ready:function(){this._mappings=[];this._mappingCache={};this._paramNameCache={};this.relationshipCache={};this._fromSideDataContainer=undefined;this._fromParameters=[];this._toDataContainers=[]},attached:function(){this._createModeControl(this.$.routemodecontainer);this.fire(this.is+"-attached")},detached:function(){this._paramNameCache={};this.$.routemodecontainer.innerHTML=""},onModeChange:function(s,r){if(r!==undefined&&s!==undefined){this.clearMappingCache();this.execute(this.mode,this._fromParameters,[],this._toDataContainers,false)}},resetSelection:function(r){r&&r.stopPropagation();if(this._fromParameters){this.fire("cmp-parameter-unselect")}if(this._toDataContainers){this.fire("cmp-activitities-unselect")}},_calculateSelectionState:function(r){return !r},_createModeControl:function(r){var s,t;s=new p({type:"radio",label:"Sequential",value:h.ROUTE,allowUnsafeHTMLLabel:false});s.elements.container.setStyle("display","inline-block");s.addEventListener("change",function(u){u.preventDefault();u.stopPropagation();if(u.dsModel.checkFlag){this.mode=u.dsModel.value;this.fire("auto-mapping-mode-changed",this.mode)}}.bind(this));t=new p({type:"radio",label:"One to many",value:h.ONETOMANY,checkFlag:true,allowUnsafeHTMLLabel:false});t.elements.container.setStyle("display","inline-block");t.addEventListener("change",function(u){u.preventDefault();u.stopPropagation();if(u.dsModel.checkFlag){this.mode=u.dsModel.value;this.fire("auto-mapping-mode-changed",this.mode)}}.bind(this));t.inject(r);this._addTooltip(e.ONETOMANY.TITLE,e.ONETOMANY.MESSAGE,t);new g.Element("span",{styles:{"padding-left":"25px"}}).inject(r);s.inject(r);this._addTooltip(e.ROUTE.TITLE,e.ROUTE.MESSAGE,s)},_addTooltip:function(t,r,s){s.tooltipInfos=new n({title:t,longHelp:r,allowUnsafeHTMLTitle:false,allowUnsafeHTMLLongHelp:false});s.tooltipInfos.initialDelay=0},clear:function(){this._resetPrivateViariables();this.clearMappingCache();this.clearParameterCache();this.clearRelationShipCache()},_resetPrivateViariables:function(){this._fromSideDataContainer=undefined;this._fromParameters=[];this._toDataContainers=[];this._allToSideDataContainers=[]},clearMappingCache:function(){this.mappingCache={}},clearParameterCache:function(r){if(r){this._paramNameCache&&(this._paramNameCache[r]={})}else{this._paramNameCache={}}},clearRelationShipCache:function(){this.relationshipCache={}},isDirty:function(){var t,s,r=false,u;for(t in this.mappingCache){if(!r){for(s in this.mappingCache[t]){u=this.mappingCache[t][s];if(!r&&(u.isValidForMapping||u.isValidAfterToCreate)&&!(u.isValidAfterToModeChange||u.isValidAfterFromModeChange)){r=true;break}}}}return r},setActivitySelection:function(t,r,s){this.setFromSideDataContainer(t,function(){this.setToSideDataContainers(r);s()}.bind(this))},refreshView:function(){this.clearMappingCache();this.clearParameterCache();this.setToSideDataContainers(this._toDataContainers,true)},setFromSideDataContainer:function(r,s){if(r!==this._fromSideDataContainer){this.fire("confirm-pending-changes",{callback:function(){this.clearMappingCache();this.clearParameterCache();this._fromSideDataContainer=r;s()}.bind(this),cancelCallback:function(){var t=[];for(var u=0;u<this._toDataContainers.length;u+=1){t.push(c.getFI(this._toDataContainers[u]))}this.fire("update-selection",{sourceActivity:c.getFI(this._fromSideDataContainer),destinationActivities:t,source:"SWAP"})}.bind(this)})}else{s()}},setFromSideParameters:function(r){this._fromParameters=r;this.execute(this.mode,this._fromParameters,[],this._toDataContainers,false)},updateMappingForParameters:function(t,s){var u=[],r;t.forEach(function(v){if(v.getState()===b.State.Modified){this.addIfNotExist(u,v.getReference().getName())}this.addIfNotExist(u,v.getName())}.bind(this));s&&s.forEach(function(v){if(v.getState()===b.State.Modified){this.addIfNotExist(u,v.getReference().getName())}else{if(v.getState()===b.State.Created){this.addIfNotExist(u,v.getName())}}}.bind(this));this.mappingCache=this.clearMappingCacheForParameters(u,this.mappingCache);r=t.length>0?this.updateFromParameterList(this._fromParameters,t):this._fromParameters;this.setFromSideParameters(r)},clearMappingCacheForParameters:function(u,t){var r={},s;for(s in t){if(t.hasOwnProperty(s)&&u.indexOf(s)===-1){r[s]=t[s]}}return r},updateFromParameterList:function(t,v){var r=[],u=[],s=-1;u=t.slice();v.forEach(function(w){if(w.getState()===b.State.Modified){s=u.indexOf(w);if(s===-1){s=u.indexOf(w.getReference())}r.push(w);u.splice(s,1)}});u.forEach(function(w){r.push(w)});return r},setToSideDataContainers:function(s,r){var t=s||[];var u;this._allToSideDataContainers=this._allToSideDataContainers||[];setTimeout(function(){this.addMultipleIfNotExist(this._allToSideDataContainers,t)}.bind(this),1000);u=this.getToSideDataContainersChange(this._toDataContainers,t);this._toDataContainers=t.slice();if(u.isChanged||r){this.execute(this.mode,this._fromParameters,u.dataContainersRemoved,this._toDataContainers,u.isSequenceChanged,u.dataContainersAdded)}},getToSideDataContainersChange:function(y,A){var v=0,x=0,r=0,u=0,z=false,t=false,w=[],s=[];r=y.length;u=A.length;z=r!==u;x=r<u?r:u;for(v=0;v<x;v++){if(y[v]!==A[v]){t=true;z=true;break}}y.forEach(function(B){if(A.indexOf(B)===-1){z=true;s.push(B)}});A.forEach(function(B){if(y.indexOf(B)===-1){z=true;w.push(B)}});return{isChanged:z,isSequenceChanged:t,dataContainersRemoved:s,dataContainersAdded:w}},execute:function(u,r,t,w,s,v){if(this._fromSideDataContainer){this.updatePlaceHolderState(r.length,w.length);this.mappingCache=this._initMappingCache(this.mappingCache,r,t,w,s,u,v);if(u===h.ONETOMANY){this.mappingCache=this._processOneToManyMappings(this.mappingCache,r,w)}else{if(u===h.ROUTE){this.mappingCache=this._processSequentialsMappings(this.mappingCache,r,w)}}this.updatePendingMappingTable(this._fromSideDataContainer,w,this.mappingCache)}},_initMappingCache:function(y,A,t,u,r,v,x){var z={},s,w=-1;if(x&&x.length>0){w=u.length-x.length-1;s=w!==-1?u[w]:undefined}A.forEach(function(B){if(y[B.getName()]){z[B.getName()]=y[B.getName()];if(v===h.ONETOMANY){t.forEach(function(C){delete z[B.getName()][C.getId()]})}else{if(v===h.ROUTE&&r){z[B.getName()]={}}else{if(v===h.ROUTE){t.forEach(function(C){delete z[B.getName()][C.getId()]});if(s){delete z[B.getName()][s.getId()]}}}}}else{z[B.getName()]={}}});return z},updatePendingMappingTable:function(r,s,t){if(this.pendingMappingTable){this.pendingMappingTable.updateTable(r,s,t)}else{this.pendingMappingTable=new a({elements:{tableContainer:this.$.tableContent},fromSideDataContainer:r,events:{changeModeForMapping:function(w){var v,u=30,y=30;v=w.mappingObject;this.$.modeChangeConfirmation.style.left=(w.xAxis-30)+"px";this.$.modeChangeInfo.innerHTML="";if(v.isValidAfterFromModeChange){this.$.modeChangeInfo.appendChild(this._getModeInfoMsg(v.fromParameter,v.modeChangeForFromParam));u+=100}if(v.isValidAfterToModeChange){this.$.modeChangeInfo.appendChild(this._getModeInfoMsg(v.toParameter,v.modeChangeForToParam));if(v.isValidAfterFromModeChange){u+=35}else{u+=100}}this.$.modeChangeConfirmation.style.top=(w.yAxis-u)+"px";var x=document.body.getBoundingClientRect().width;if((x-w.xAxis)<l){this.$.modeChangeConfirmation.style.left=(x-l)+"px"}else{this.$.modeChangeConfirmation.style.left=(w.xAxis-y)+"px"}this.$.modeChangeConfirmation.style.display="block";if(this.tempHandler){this.$.modeChangeOkButton.removeEventListener("click",this.tempHandler)}this.tempHandler=function(z){z.stopPropagation();z.preventDefault();this.$.modeChangeOkButton.removeEventListener("click",this.tempHandler);this.modeChangeOKButtonHandler(v)}.bind(this);this.$.modeChangeOkButton.addEventListener("click",this.tempHandler)}.bind(this)}})}},_getModeInfoMsg:function(t,s){var r;r=document.createElement("li");r.innerText=o.translate("Dataflow.Mapping.ModeChangeMessage",t.getParent().getName()+"."+t.getName(),b.Mode.client.properties[s.from].name,b.Mode.client.properties[s.to].name);return r},modeChangeCancelButton:function(){this.$.modeChangeConfirmation.style.display="none";if(this.tempHandler){this.$.modeChangeOkButton.removeEventListener("click",this.tempHandler)}},modeChangeOKButtonHandler:function(t){var v,r,u=[],s=[];if(t.isValidAfterFromModeChange){v=d.modifyParameter(t.fromParameter,{name:"Mode",value:b.Mode.client.properties[t.modeChangeForFromParam.to].name},true);this.clearParameterCache(t.fromParameter.getParent().getId())}if(t.isValidAfterToModeChange){r=d.modifyParameter(t.toParameter,{name:"Mode",value:b.Mode.client.properties[t.modeChangeForToParam.to].name},true);this.clearParameterCache(r.getParent().getId())}if(v&&v.getParent()===this._fromSideDataContainer){u.push(v);this.fire("parameterModified",v)}else{if(v){s.push(v)}else{if(r){s.push(r)}}}this.modeChangeCancelButton();this.updateMappingForParameters(u,s)},updatePlaceHolderState:function(t,r){var s="1",u=false;if(t===0){s="1"}else{if(t!==0&&r===0){s="2"}else{if(t!==0&&r!==0){s="3"}}}if(t!==0||r!==0){u=true}this.selectionstate=u;this.placeholderstate=s},_processSequentialsMappings:function(x,y,z){var w={},v,u,s,t,A=false,r;y.forEach(function(B){w[B.getName()]=x[B.getName()];if(z[0]!==undefined){if(x[B.getName()][z[0].getId()]){s=x[B.getName()][z[0].getId()]}else{s=this._calculateMappingObject(B.getParent(),z[0],B,true,A,false,z.length===1)}w[B.getName()][z[0].getId()]=s;r=this._calculateStateFromLastMapping(s,B);t=r.lastFromParam;A=r.isSequenceBroken;u=r.fromSideParamWillBeCreated}for(v=1;v<z.length;v++){if(x[B.getName()][z[v].getId()]){s=x[B.getName()][z[v].getId()]}else{s=this._calculateMappingObject(z[v-1],z[v],t,true,A,u,v===z.length-1)}w[B.getName()][z[v].getId()]=s;r=this._calculateStateFromLastMapping(s,t);t=r.lastFromParam;A=r.isSequenceBroken;u=r.fromSideParamWillBeCreated}A=false;t=undefined;u=false}.bind(this));return w},_calculateStateFromLastMapping:function(r,t){var s,v,u;s=r.isValidAfterToCreate;v=r.error!==undefined||r.isValidAfterFromModeChange||r.isValidAfterToModeChange;if(!v){if(r.isValidAfterToCreate){u=r.fromParameter||t}else{u=r.toParameter}}else{u=undefined}return{fromSideParamWillBeCreated:s,lastFromParam:u,isSequenceBroken:v}},_processOneToManyMappings:function(u,s,t){var r={};s.forEach(function(v){r[v.getName()]=u[v.getName()];t.forEach(function(w){if(u[v.getName()][w.getId()]){r[v.getName()][w.getId()]=u[v.getName()][w.getId()]}else{r[v.getName()][w.getId()]=this._calculateMappingObject(v.getParent(),w,v)}}.bind(this))}.bind(this));return r},_calculateMappingObject:function(E,u,I,v,w,D,y){var x,H,G,t,r,J,A,C,s,F;x=this.getRelationshipInfoFromCache(E,u);H={error:undefined,mappingAlreadyAvailable:false,fromParameter:undefined,toParameter:undefined,isValidForMapping:false,dataFlowContainer:undefined,isValidAfterFromModeChange:false,isValidAfterToModeChange:false,isValidAfterToCreate:false};G=v&&D;if(w&&v){H.error={type:f.SEQUENCE_BROKEN}}else{if(x.isValid){C=this.getParamByNameFromCache(u,I.getName());s=k.isValidFromParameterMode(I.getMode(),x.relation);J=k.isFromParameterAlreadyMapped(I,u,C);if(!J.isAlreadyMapped){if(C){J=k.isToParameterAlreadyMapped(I,C);if(!J.isAlreadyMapped){r=k.structureCompatiblityCheck(I,undefined,C,undefined);if(r.value){A=k.dataTypeCompatiblityCheck(I,C,k.MappingDirection.FirstToSecond);if(A.value){F=k.isValidToParameterMode(C.getMode(),x.relation);if((G||s.isValid)&&F.isValid){if(!G&&this.isMappingAvailableBetweenParameters(I,C)){H.mappingAlreadyAvailable=true;H.toParameter=C}else{H.fromParameter=I;H.toParameter=C;H.isValidForMapping=true;H.dataFlowContainer=x.dataflowContainer}}else{H.fromParameter=I;H.toParameter=C;H.dataFlowContainer=x.dataflowContainer;if(!s.isValid&&!G){H.isValidAfterFromModeChange=true;H.modeChangeForFromParam=s.details}if(!F.isValid){H.isValidAfterToModeChange=true;H.modeChangeForToParam=F.details}}}else{H.error={type:f.INVALID_DATATYPE,details:{errorStr:A.errorCode}};H.fromParameter=I;H.toParameter=C}}else{H.error={type:f.INVALID_STRUCTURE,details:{errorStr:r.errorCode}};H.fromParameter=I;H.toParameter=C}}else{var B=J.dataflow.getFromParameter().getParent().getName()+"."+J.dataflow.getFromParameter().getName();var z=J.dataflow.getToParameter().getParent().getName()+"."+J.dataflow.getToParameter().getName();H.error={type:f.ALREADY_MAPPED,details:{errorStr:o.translate("Dataflow.AlreadyMapped",B,z)}};H.fromParameter=I;H.toParameter=C}}else{t=v&&!y;H.fromParameter=I;H.toParameterContainer=u;H.isValidAfterToCreate=true;H.modeForNewToParam=t?b.Mode.InOut:k.getMinValidModeToCreateMapping(x.relation);H.dataFlowContainer=x.dataflowContainer;if(!s.isValid&&!G){H.isValidAfterFromModeChange=true;H.modeChangeForFromParam=s.details}}}else{H.mappingAlreadyAvailable=true;H.toParameter=J.dataflow.getToParameter()}}else{H.error={type:f.INVALID_RELATIONSHIP,details:{relationship:x.relation,errorStr:j["Dataflow.NoRelation"]}}}}H.fromParameter=G?undefined:H.fromParameter;return H},commitDataMapping:function(){return new Promise(function(s,r){this.commitMapping(this.mode,this.mappingCache,this._fromSideDataContainer,this._toDataContainers,s,r)}.bind(this))},applyDataMapping:function(){var r=this._getOriginalParameterList(this._fromParameters);return new Promise(function(t,s){if(this._fromSideDataContainer){this.commitMapping(this.mode,this.mappingCache,this._fromSideDataContainer,this._toDataContainers,function(){this.clearMappingCache();this.clearParameterCache();this.setFromSideParameters(r);t()}.bind(this),s)}else{t()}}.bind(this))},_getOriginalParameterList:function(s){var r=[];s.forEach(function(t){if(t.getState()===b.State.Modified){r.push(t.getReference())}else{r.push(t)}});return r},commitMapping:function(u,v,B,y,z,D){var t,s,r=[],C=[],w,A,x;for(w in v){if(v.hasOwnProperty(w)){A=v[w];for(t=0;t<y.length;t++){x=A[y[t].getId()];if(x.isValidForMapping){k.addDataflow(k.createDataFlowObject(x.fromParameter,x.toParameter),x.dataFlowContainer);this.addIfNotExist(C,x.dataFlowContainer);if(x.toParameter.getState()===b.State.Modified){this.addIfNotExist(r,x.toParameter.getParent())}}else{if(x.isValidAfterToCreate&&!x.isValidAfterFromModeChange){s=d.cloneParameterWithMode(x.fromParameter,x.toParameterContainer,x.modeForNewToParam);k.addDataflow(k.createDataFlowObject(x.fromParameter,s),x.dataFlowContainer);this.addIfNotExist(C,x.dataFlowContainer);this.addIfNotExist(r,x.toParameterContainer);if(u===h.ROUTE&&t<y.length-1){A[y[t+1].getId()].fromParameter=s}}}}}}r.push(B);q.saveAllParameters(r,{onSuccess:function(){if(C.length===0){z()}else{k.saveAllDataFlows(C,{onSuccess:function(){var E=new CustomEvent("refreshnTwoViewWebinWinEditor",{bubbles:true,detail:{}});this.dispatchEvent(E);z()}.bind(this),onFailure:function(E){this.$.notification.logMessage({type:"error",text:E,autoRemove:false});D(new Error(E))}.bind(this)})}}.bind(this),onFailure:function(E){this.$.notification.logMessage({type:"error",text:E,autoRemove:false});D(new Error(E))}.bind(this)})},addIfNotExist:function(s,r){if(s&&s.indexOf&&s.indexOf(r)===-1){s.push(r)}},addMultipleIfNotExist:function(s,r){r&&r.forEach&&r.forEach(function(t){this.addIfNotExist(s,t)}.bind(this))},abortDataMapping:function(){this._allToSideDataContainers&&this._allToSideDataContainers.forEach&&this._allToSideDataContainers.forEach(function(r){q.clearTemporaryParameters(r);r.removeParameterObservers()});this._allToSideDataContainers=[]},hasValidRelation:function(r){return r===k.Relation.Parent||r===k.Relation.Child||r===k.Relation.SiblingUpstream},getRelationshipInfoFromCache:function(r,s){if(!(this.relationshipCache[r.getId()]&&this.relationshipCache[r.getId()][s.getId()])){if(!this.relationshipCache[r.getId()]){this.relationshipCache[r.getId()]={}}this.relationshipCache[r.getId()][s.getId()]=this._calculateRelationshipCache(r,s)}return this.relationshipCache[r.getId()][s.getId()]},_calculateRelationshipCache:function(s,u){var r,t;r=k.getRelationship(s,u).value;if(this.hasValidRelation(r)){t={isValid:true,relation:r,dataflowContainer:k.getDataFlowDataContainerForDataContainers(s,u,r)}}else{t={isValid:false,relation:r}}return t},getParamByNameFromCache:function(r,s){if(!(this._paramNameCache[r.getId()]&&this._paramNameCache[r.getId()][s])){this._paramNameCache[r.getId()]=this._calculateParamNameMap(r)}return this._paramNameCache[r.getId()][s]},_calculateParamNameMap:function(t){var s,r={};s=q.getAllParameters(t);s.forEach(function(u){r[u.getName()]=u});return r},isMappingAvailableBetweenParameters:function(t,s){var r;r=k.getDataFlowSpaceForDataContainer(t.getParent()).value;return k.isDataFlowAvailableBetweenParameters(r,t,s,k.MappingDirection.FirstToSecond)}})});