define("DS/SMAProcJobListingUI/Model/SimulationJob",["UWA/Core","UWA/Utils","UWA/Class/Model","UWA/Class/Timed","UWA/Ajax","DS/W3DXComponents/Collections/ActionsCollection","DS/SMAProcJobListingUI/Data"],function(l,m,g,k,d,i,n){var h={JOB_STATUS_STARTED:"Started",JOB_STATUS_RUNNING:"Running",JOB_STATUS_PAUSED:"Paused",JOB_STATUS_WAITING:"Waiting",JOB_STATUS_DONE:"Done"},j={COMPLETED:"OK",ABORTED:"Canceled",FAILED:["Failed","System Failed"]},c={JOB_STATUS_NOT_STARTED:"NotStarted",JOB_STATUS_RUNNING:"Running",JOB_STATUS_PAUSED:"Paused",JOB_STATUS_WAITING:"Waiting",JOB_STATUS_COMPLETED:"Completed",JOB_STATUS_ABORTED:"Aborted",JOB_STATUS_FAILED:"Failed",JOB_STATUS_INITIALIZING:"Initializing"},f={COS_TICKET:270000,SUMMARY_BRIEF:5000};var b={"summary-brief":null};function a(o){var p=window.widget.getValue("collab-space"),q=o;if(p){q="/common/emxFrameworkContextManager.jsp?"+m.toQueryString({SecurityContext:p,forwardUrl:o})}return n.myAppsURL+q}var e=g.extend(k,{defaults:{objectId:"",type:"",owner:"",eedJobId:"",createdDate:"",endDate:"",description:"",title:"",startDate:"",status:"",simulationId:"",serverId:""},totalRuns:-1,idAttribute:"physicalId",actions:function(){var o=this.get("status"),r=[],q={id:"pause",title:"Pause",icon:"pause"},t={id:"abort",title:"Abort",icon:"stop"},p={id:"resume",title:"Resume",icon:"play"},s={id:"interactive",title:"Claim",icon:"user"};switch(o){case c.JOB_STATUS_RUNNING:r=r.concat([q,t]);break;case c.JOB_STATUS_PAUSED:r=r.concat([p,t]);break;case c.JOB_STATUS_WAITING:r=r.concat([s,t]);break;default:}return new i(r)},init:function(o,p){p=l.is(p)?l.merge(l.clone(p,false),{silent:true}):{};this._parent(o,p)},isAlive:function(o){o=o||this.get("status");if(o===c.JOB_STATUS_RUNNING||o===c.JOB_STATUS_PAUSED||o===c.JOB_STATUS_WAITING){return true}return false},parse:function(p){var o={};o.objectId=p.objectId;o.physicalId=p.physicalId;o.type=p.busType;o.owner=p.dataelements.owner.value[0]&&p.dataelements.owner.value[0].value;o.eedJobId=p.dataelements.eedJobId.value[0]&&p.dataelements.eedJobId.value[0].value;o.createdDate=p.dataelements.createdDate.value[0]&&parseInt(p.dataelements.createdDate.value[0].actualValue,10);o.endDate=p.dataelements.endDate.value[0]&&parseInt(p.dataelements.endDate.value[0].actualValue,10);o.description=p.dataelements.description.value[0]&&p.dataelements.description.value[0].value;o.title=p.dataelements.title.value[0]&&p.dataelements.title.value[0].value;o.simulationId=p.dataelements.simulationId.value[0]&&p.dataelements.simulationId.value[0].value;o.startDate=p.dataelements.startDate.value[0]&&parseInt(p.dataelements.startDate.value[0].actualValue,10);o.status=p.dataelements.status.value[0]&&p.dataelements.status.value[0].value;o.serverId=p.dataelements.eedServerName.value["0"]&&p.dataelements.eedServerName.value["0"].value;var q;for(q in o){if(l.owns(o,q)&&!l.is(o[q])){delete o[q]}}return o},setup:function(){var o=this.get("status"),q=this;var r=function(){q.setPeriodical("summary-brief",q.getSummaryBrief,f.SUMMARY_BRIEF,true,q)};var p=function(){if(q.totalRuns===-1&&q.isAlive(o)){q.setPeriodical("cos-ticket",q.getCOSTicket,f.COS_TICKET,false,q);q.getTotalRuns({onComplete:r})}};if(this.isAlive(o)){this.getCOSTicket({onComplete:p})}},getCOSTicket:function(q){q=q||{};if(!this.get("objectId")){throw new Error("Simulation Job is invalid.",this)}var p=this.get("serverId"),s=this,t=q.onComplete,r=q.onFailure,o=n.getCosTicketURL;q.url=o.slice(0,o.indexOf("<"));q.url+=p;q.url+=o.slice(o.indexOf(">")+1,o.lastIndexOf("t")+1);q.onComplete=function(u){s.COSTicket=u;if(t){t.call(null,s.COSTicket)}};q.onFailure=function(u){window.console.error("Unable to get COS ticket for Simulation "+s.get("simulationId"),u);if(r){r.call(null,u)}};q.urlParams={access:"modify",id:this.id};q.type="text/plain";return n.request(q)},getTotalRuns:function(p){p=p||{};var r=this,o=this.get("eedJobId"),s,t=p.onComplete,q=p.onFailure;if(!o){window.console.error("Simulation Job is either completed or yet to be spawned on COS.",this);return}s=n.jobTotalRunsURL.format(o);p.url=s;p.onComplete=function(u){r.totalRuns=parseInt(u);if(t){t.call(null,r.totalRuns)}};p.onFailure=function(u){window.console.error("Unable to get total runs for Simulation Job"+r.id,u);if(q){q.call(null,u)}};p.headers={EEDTicket:this.COSTicket};p.allowCrossOriginRequest=true;d.request(p.url,p)},getSummaryBrief:function(q){q=q||{};var t=this,p=this.get("eedJobId"),o,s,u=q.onComplete,r=q.onFailure;if(!p){window.console.error("Simulation Job is either completed or yet to be spawned on COS.",this);return}o=n.jobSummaryBriefURL.format(p);q.url=o;q.onComplete=function(z){var w=z.JobInfoBrief,v=w["@status"],x=w["@completionCode"],y=w.PendingWI,A=w.JobSummary["@nFinished"];if(y&&(v!==h.JOB_STATUS_PAUSED&&v!==h.JOB_STATUS_DONE)){v=h.JOB_STATUS_WAITING}if(v===h.JOB_STATUS_DONE){if(x===j.COMPLETED){v=c.JOB_STATUS_COMPLETED}else{if(x===j.ABORTED){v=c.JOB_STATUS_ABORTED}else{v=c.JOB_STATUS_FAILED}}t.dispatchEvent("onLoad",[v,A,t.totalRuns])}t.dispatchEvent("onProgress",[v,A,t.totalRuns]);t.set("status",v);if(u){u.call(null,w)}};q.onFailure=function(v){window.console.error("Unable to get brief summary for Simulation Job"+t.id,v);switch(s.status){case 410:t.clearAllTimed();t.fetch();break;case 401:break;default:t.clearAllTimed();break}if(r){r.call(null,v)}};q.responseType="json";q.headers={EEDTicket:this.COSTicket,Accept:"application/json,text/javascript,*/*"};q.allowCrossOriginRequest=true;b["summary-brief"]=s=d.request(q.url,q)},pause:function(p){p=p||{};var r=this,o=this.get("eedJobId"),t,s=p.onComplete,q=p.onFailure;if(!o){window.console.error("Simulation Job is either completed or yet to be spawned on COS.",this);return}t=n.executionPauseURL.format(o);p.url=t;p.method="PUT";p.onComplete=function(){if(s){s()}};p.onFailure=function(u){window.console.error("Unable to pause execution for Simulation Job"+r.id,u);if(q){q.call(null,u)}};p.headers={EEDTicket:this.COSTicket,Accept:"*/*"};p.cors=false;p.request=d.request(p.url,p)},resume:function(p){p=p||{};var s=this,o=this.get("eedJobId"),r,t=p.onComplete,q=p.onFailure;if(!o){window.console.error("Simulation Job is either completed or yet to be spawned on COS.",this);return}r=n.executionResumeURL.format(o);p.url=r;p.method="PUT";p.onComplete=function(){if(t){t()}};p.onFailure=function(u){window.console.error("Unable to pause execution for Simulation Job"+s.id,u);if(q){q.call(null,u)}};p.headers={EEDTicket:this.COSTicket,Accept:"*/*"};p.cors=false;p.request=d.request(p.url,p)},showInteractive:function(){var o=a("/simulationcentral/smaJobsShowInteractive.jsp?"+m.toQueryString({suiteKey:"SimulationCentral",HelpMarker:"SMAJobs_ShowInteractive",StringResourceFileId:"smaSimulationCentralStringResource",SuiteDirectory:"simulationcentral",objectId:this.get("simulationId"),jobObjectId:this.get("objectId")}));window.DS.SMAProcSP.SPBase.WIN.openInWindow(o)},abort:function(p){p=p||{};var s=this,o=this.get("eedJobId"),q,t=p.onComplete,r=p.onFailure;if(!o){window.console.error("Simulation Job is either completed or yet to be spawned on COS.",this);return}q=n.executionAbortURL.format(o);p.url=q;p.method="PUT";p.onComplete=function(){if(t){t()}};p.onFailure=function(u){window.console.error("Unable to abort execution for Simulation Job"+s.id,u);if(r){r.call(null,u)}};p.headers={EEDTicket:this.COSTicket,Accept:"*/*"};p.cors=false;d.request(p.url,p)},getSimulationJobDetails:function(){setTimeout(function(){this.fetch()}.bind(this),3000)},fetch:function(o){var r=this,s,p,q;if(this.fetching){return}this.fetching=true;o=o?l.clone(o):{};if(o.parse===undefined){o.parse=true}s=o.onComplete;o.onComplete=function(u){if(!u.success){o.onFailure(u);return}var t=u.datarecords.datagroups[0].dataelements.status.value[0].value;r.fetching=false;if(t===c.JOB_STATUS_COMPLETED||t===c.JOB_STATUS_ABORTED||t===c.JOB_STATUS_FAILED){if(!r.set(r.parse(u.datarecords.datagroups[0]),o),o){return false}if(s){s(r,u,o)}return r.dispatchEvent("onSync",[r,u,o])}else{r.getSimulationJobDetails()}};p=o.onFailure;o.onFailure=function(t){r.fetching=false;if(p){p(r,t,o)}r.dispatchEvent("onError",[r,t,o])};o.method="GET";o.url=n.jobDetailsURL;o.urlParams={jobId:this.id};setTimeout(function(){q=o.request=n.request(o)},2500);this.dispatchEvent("onRequest",[this,q,o])},"onChange:status":function(p,o){if(o===c.JOB_STATUS_COMPLETED||o===c.JOB_STATUS_ABORTED||o===c.JOB_STATUS_FAILED){p.clearAllTimed();this.fetch()}}});return e});