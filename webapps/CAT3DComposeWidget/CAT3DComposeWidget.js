window.top.performance.mark("C3D_jsAppLoad");
/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/CAT3DComposeUtils/CAT3DComposeAnimation",["UWA/Class"],function(a){var b=a.extend({init:function(c){var k=c||{};var d=0;var e=null;var h=false;var g=k.nbSteps;var j=k.animationTime/g;var f=1;var i=false;if(g&&g>0&&j&&j>0){i=typeof k.onAnimation==="function";if(k.onBeforeFirstAnimation&&i){i=i&&(typeof k.onBeforeFirstAnimation==="function")}if(k.onAnimationEnd&&i){i=i&&(typeof k.onAnimationEnd==="function")}}this.forceInitAnimation=function(){f=0;d=0;if(e){clearInterval(e);e=null}};this.animate=function(l){if(i){if(f!==l){clearInterval(e);e=null}f=l;if(!h){if(k.onBeforeFirstAnimation){k.onBeforeFirstAnimation()}h=true}e=setInterval(function(){var m=false;if(f===0){if(d>=100/g){d-=100/g;m=true}else{d=0}}else{if(d<=100-(100/g)){d+=100/g;m=true}else{d=100}}if(m){k.onAnimation(d,f)}else{clearInterval(e);e=null;if(k.onAnimationEnd){k.onAnimationEnd(d)}}},j)}}}});return b});(function(){var b=[];b.giveNavigationObject=function(c){var d;if(c&&c.context){d=null;b.some(function(e){if(e.context===c.context){d=e;return true}return false})}return d};b.getNavigationObject=function(c){var d=this.giveNavigationObject(c);if(d===null){d={context:c.context,onStart:null,onExit:null,controller:null,activated:false};b.push(d)}return d};define("DS/CATC3DNavigation/CATD3CBoxNavigation",["UWA/Core","UWA/Class","DS/VisuEvents/EventsManager","DS/Visualization/PathElement","DS/CAT3DComposeUtils/CAT3DCompose3DAnimation","DS/PADUtils/PADWSAccess","DS/Visualization/ThreeJS_DS","DS/Selection/PSOManager","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/WebappsUtils/WebappsUtils","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/Mesh/MeshUtils","DS/SceneGraphNodes/FixedSizeNode3D","DS/CATC3DNavigation/CATBreadCrumbs","DS/ApplicationFrame/CommandsManager","DS/CATWebUXTooltipManager/CATWebUXTooltipManager","DS/CAT3DComposeUtils/CATC3DDropManager","DS/SceneGraphNodes/AxisSystemNode","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/CAT3DComposeWidget/CAT3DComposeWidgetOptions","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(M,D,s,S,A,j,R,f,z,x,P,X,U,E,u,I,O,G,t,r,N,w,B){var F=function(aa){this.pts=[new R.Vector3(),new R.Vector3(),new R.Vector3(),new R.Vector3(),new R.Vector3(),new R.Vector3(),new R.Vector3(),new R.Vector3()];this.vecU=new R.Vector3();this.vecV=new R.Vector3();this.vecW=new R.Vector3();if(aa){this.pts[0].set(aa.min.x,aa.min.y,aa.min.z);this.pts[1].set(aa.max.x,aa.min.y,aa.min.z);this.pts[2].set(aa.min.x,aa.max.y,aa.min.z);this.pts[3].set(aa.max.x,aa.max.y,aa.min.z);this.pts[4].set(aa.min.x,aa.min.y,aa.max.z);this.pts[5].set(aa.max.x,aa.min.y,aa.max.z);this.pts[6].set(aa.min.x,aa.max.y,aa.max.z);this.pts[7].set(aa.max.x,aa.max.y,aa.max.z);this.vecU.subVectors(this.pts[1],this.pts[0]);this.vecV.subVectors(this.pts[2],this.pts[0]);this.vecW.subVectors(this.pts[4],this.pts[0])}};F.prototype={constructor:F,copy:function(ab){for(var aa=0;aa<8;++aa){this.pts[aa].copy(ab.pts[aa])}this.vecU.copy(ab.vecU);this.vecV.copy(ab.vecV);this.vecW.copy(ab.vecW);return this},clone:function(){return new this.constructor().copy(this)},center:function(ab){var aa=ab||new R.Vector3();return aa.set((this.pts[0].x+this.pts[7].x)*0.5,(this.pts[0].y+this.pts[7].y)*0.5,(this.pts[0].z+this.pts[7].z)*0.5)},applyMatrix4:function(aa){for(var ac=0;ac<8;++ac){this.pts[ac].applyMatrix4(aa)}var ab=new R.Matrix4().extractRotation(aa);this.vecU.applyMatrix4(ab);this.vecV.applyMatrix4(ab);this.vecW.applyMatrix4(ab);return this},containsPoint:function(aa){if(aa.x<this.pts[0].x||aa.x>this.pts[7].x||aa.y<this.pts[0].y||aa.y>this.pts[7].y||aa.z<this.pts[0].z||aa.z>this.pts[7].z){return false}return true},minX:function(){var aa=this.pts[0].x;for(var ab=1;ab<8;++ab){aa=Math.min(aa,this.pts[ab].x)}return aa},maxX:function(){var ab=this.pts[0].x;for(var aa=1;aa<8;++aa){ab=Math.max(ab,this.pts[aa].x)}return ab},minY:function(){var ab=this.pts[0].y;for(var aa=1;aa<8;++aa){ab=Math.min(ab,this.pts[aa].y)}return ab},maxY:function(){var ab=this.pts[0].y;for(var aa=1;aa<8;++aa){ab=Math.max(ab,this.pts[aa].y)}return ab},minZ:function(){var ab=this.pts[0].z;for(var aa=1;aa<8;++aa){ab=Math.min(ab,this.pts[aa].z)}return ab},maxZ:function(){var ab=this.pts[0].z;for(var aa=1;aa<8;++aa){ab=Math.max(ab,this.pts[aa].z)}return ab},min:function(){var ab=new R.Vector3().copy(this.pts[0]);for(var aa=1;aa<8;++aa){ab.x=Math.min(ab.x,this.pts[aa].x);ab.y=Math.min(ab.y,this.pts[aa].y);ab.z=Math.min(ab.z,this.pts[aa].z)}return ab},max:function(){var aa=new R.Vector3().copy(this.pts[0]);for(var ab=1;ab<8;++ab){aa.x=Math.max(aa.x,this.pts[ab].x);aa.y=Math.max(aa.y,this.pts[ab].y);aa.z=Math.max(aa.z,this.pts[ab].z)}return aa}};var q=function(){var ae,af,aa,ab,ac,ad;this.store=function(ah,ag){var aj=ag?new R.Matrix4().getInverse(ag):null,ai=aj?new R.Matrix4().extractRotation(aj):null;ae=ah.getEyePosition();if(aj){ae.applyMatrix4(aj)}af=ah.getUpDirection();if(ai){af.applyMatrix4(ai)}aa=ah.getSightDirection();if(ai){aa.applyMatrix4(ai)}ab=ah.getTargetDistance();ac=ah.getProjectionType();ad=ah.getAngle()};this.restore=function(ai,ag){if(ae){var ah=ag?new R.Matrix4().extractRotation(ag):null;ai.moveTo({eyePosition:ag?ae.applyMatrix4(ag):ae,upDirection:ah?af.applyMatrix4(ah):af,sightDirection:ah?aa.applyMatrix4(ah):aa,distanceToTarget:ab});ai.setProjectionType(ac);ai.setAngle(ad)}}};q.prototype={constructor:q};Object.freeze(q);var d=function(ad){var ab,aa,ac,af,ae=ad&&ad.externalPath.length>1;for(ab=0,aa=ad.externalPath.length-1;ae&&ab<aa;++ab){ac=ad.externalPath[ab];af=ad.externalPath[ab+1];if(ac.children.indexOf(af)<0){ae=false}}return ae};var v=function(ab){if(!ab){return false}if(B.isReference(ab)){return true}var aa=B.getNodeType(ab);if(aa==="CATDrawing"||aa==="Drawing"||aa==="CATAnalysis"||aa==="CATProcess"){return true}return false};var k=function(ab){if(!ab){return false}if(B.isInstance(ab)){return true}var aa=B.getNodeType(ab);if(aa==="CatDrawing"||aa==="CatAnalysis"||aa==="CatProcess"){return true}return false};var n=-1,C=144,e=108,V=0.000001,y=w.getOption("C3DSTR"),T=new R.Vector3(0,0,1),Q=new R.Vector3(1,0,0),Y=new R.Vector3(-1,0,0),o=Math.PI,L=0.5*Math.PI,K=0.25*Math.PI,W=0.75*Math.PI,p=new R.Color("rgb(202,202,202)").getHex(),m=new R.Color("rgb(54,142,196)").getHex(),c=0,h,i,H={},J=new R.MeshBasicMaterial({map:new R.ImageUtils.loadTexture(P.getWebappsAssetUrl("CATC3DNavigation","icons")+"/iconLargeDefault.png",undefined,null,null,true),side:R.DoubleSide,force:true,transparent:true}),l=new R.MeshBasicMaterial({map:new R.ImageUtils.loadTexture(P.getWebappsAssetUrl("CATC3DNavigation","icons")+"/iconLargeDefault.png",undefined,null,null,true),side:R.DoubleSide,force:true,transparent:true});function g(){h=new R.MeshBasicMaterial({color:p,opacity:0.95});i=new R.MeshBasicMaterial({color:m,opacity:0.95});h.line=i.line=new R.LineBasicMaterial({color:c,opacity:0.95});h.force=i.force=true}g();var Z=D.extend({init:function(aM){var aI=aM.context,a6=aI.getViewer(),ay=a6.getSceneGraphOverrideSetManager(),a1,aV=false,an,aG,ak,ao,a9=aI.getRootBagPath().getLastElement(true),ad,bb=A.get3DComposeAnimationEngine({viewer:a6}),aR={},al=[],aP,aW,at,ag,aH,ax,a5,a4,aQ=[],ba,aK,a7;function aT(be,bd,bi){var bc=be.pathElement.getLastElement(true);if(bc&&bc.navigationAssociatedPath){if(bd===2){be.pathElement=bc.navigationAssociatedPath.clone()}else{be.pathElement=new S(be.pathElement.externalPath.slice(0,3))}}else{if(be.pathElement.externalPath[0]===a9){if(bd===1&&bi){var bh=aR.levels[aR.levels.length-1].node.getChildByName("EmptyNodes");if(bh){bh.getChildren().some(function(bj){if(bj.children.length&&be.pathElement.isAParentOf(bj.navigationAssociatedPath)){var bk=M.extend({},be,false);bk.pathElement=new S([aR.levels[aR.levels.length-1].node,bh,bj,bj.children[0]]);if(!z.isIn(bk)){z.add(bk)}return true}return false})}}var bg=ak.clone(),bf=ak.getLastElement(true);if(be.pathElement.externalPath.length>bg.externalPath.length){bg.addElement(be.pathElement.externalPath[bg.externalPath.length]);if(bf!==a9&&be.pathElement.externalPath.length>bg.externalPath.length){bg.addElement(be.pathElement.externalPath[bg.externalPath.length])}be.pathElement=bg}}}return be}function aw(be,bc,bd){if(Array.isArray(be)){be.forEach(function(bf){aT(bf,bc,bd)})}else{aT(be,bc,bd)}}function au(bc){aw(bc,0,true)}function aA(bc){aw(bc,1,true)}function aF(bc){aw(bc,2,true)}function ah(bc){aw(bc,1,false)}function aq(bc){return aT({pathElement:bc},2,true).pathElement}function ai(bg){if(!bg||!bg.completed){return}if(!bg.arrayPath||bg.arrayPath.length!==1||!bg.token){bg.completed();return}var bh=aq(bg.arrayPath[0]);if(!bh){bg.completed();return}var bc=bh.getLastElement(true),bd=bc?B.getNodeID(bc):undefined,bf;if(!bd){bg.completed();return}if(bh.externalPath.length>1&&B.isInstance(bh.externalPath[bh.externalPath.length-2])){bf=B.getNodeID(bh.externalPath[bh.externalPath.length-2])}var be=[bd];if(bf){be.push(bf)}aI.getController().getAttributes({ids:be,attributes:["ds6w:label","type_icon_url"],callbacks:{onComplete:function(bi){var bl,bk=bi[bd]?bi[bd]["ds6w:label"]:"";if(bf&&bi[bf]&&bi[bf]["ds6w:label"]){bk+=" ("+bi[bf]["ds6w:label"]+")"}if(bk&&(typeof bk==="string")&&bk.trim().length!==0){bl=M.createElement("div");bl.setText(bk);var bj=bi[bd].type_icon_url;if(bj&&(typeof bj==="string")&&bj.length>0){bl.setStyles({"background-image":"url("+bj+")","background-repeat":"no-repeat","background-position-y":"center"});bl.setStyle("padding-left","21px")}}bg.completed({token:bg.token,div:bl})},onFailure:function(){bg.completed({token:bg.token})}}})}function aU(){if(!aW){aW=new q();aI.getFrameWindow().getViewpoint().reframe(null)}else{aW.restore(aI.getFrameWindow().getViewpoint(),ak.getWorldMatrix())}}function aE(be,bd){var bc=a1.createOverride({pathes:be});bd.push(bc);return bc}function a8(bg){var bc=bg.getLastElement(true),bd=ay.getCurrentVisibility(bg)===true?0:(ay.getCurrentVisibilityFree(bg)===true?-1:1);if(v(bc)||B.is3DLeaf(bc)){return bd}var be=bc.getChildren();if(be.length!==1){M.log("Instance or RepInstance with no or more than one Reference or RepReference");return bd}var bf=bg.clone();bf.addElement(be[0]);return ay.getCurrentVisibility(bf)===true?0:(ay.getCurrentVisibilityFree(bf)===true?-1:1)}function aj(bc,bf){if(!bc){return undefined}var bd=null,be=bc.angleTo(bf);if(be>V&&(o-be)>V){bd=new R.Matrix4();if(be<=L||(be-L)<V){bd.makeRotationAxis(new R.Vector3().crossVectors(bc,bf).normalize(),be)}else{bd.makeRotationAxis(new R.Vector3().crossVectors(bc,bf).normalize().negate(),o-be)}}return bd}function af(bc,bd,bk){if(!y){return undefined}var bi=bc.clone(),bl,bp;var bj=bi.vecU.length(),bh=bi.vecV.length(),bg=bi.vecW.length();var be,bo=bi.vecU,bn=bi.vecV,bm=bi.vecW,bf;if(bk){bf=bm.angleTo(T);if(bf>V){bl=new R.Matrix4().makeRotationAxis(new R.Vector3().crossVectors(bm,T).normalize(),bf);bi.applyMatrix4(bl)}bf=bo.angleTo(Q);if(bf>V&&(o-bf)>V&&Math.abs(bf-L)>V){bp=new R.Matrix4();if(bf<=K){bp.makeRotationAxis(new R.Vector3().crossVectors(bo,Q).normalize(),bf)}else{if(bf>=W){bp.makeRotationAxis(new R.Vector3().crossVectors(bo,Y).normalize(),o-bf)}else{bf=bn.angleTo(Q);if(bf<=K){bp.makeRotationAxis(new R.Vector3().crossVectors(bn,Q).normalize(),bf)}else{bp.makeRotationAxis(new R.Vector3().crossVectors(bn,Y).normalize(),o-bf)}}}bl=bl?bp.multiply(bl):bp}}else{if(bg<=bj&&bg<=bh){bo=bi.vecU;bn=bi.vecV;be=bi.vecW}else{if(bj<=bh&&bj<bg){bo=bi.vecV;bn=bi.vecW;be=bi.vecU}else{bo=bi.vecW;bn=bi.vecU;be=bi.vecV}}bl=aj(be,T);if(bl){bi.applyMatrix4(bl)}if(bd){bj=bo.length();bh=bn.length();if(bj===bh){be=bd.x?bo:bn}else{be=bj>bh?bo:bn}bp=aj(be,bd);if(bp){bl=bl?bp.multiply(bl):bp}}}return bl}function aJ(be,bg,bd){var bf=new R.Matrix4().setPosition(be);var bc=new R.Matrix4().copy(bg).multiply(new R.Matrix4().getInverse(bf).multiply(bd));return bf.multiply(bc)}function aL(be,bd){var bc=new R.Vector3(0,0,0);bc.applyMatrix4(bd);if(!be.containsPoint(bc)){be.center(bc)}return bc}function az(be,bd,bc){be.setSSAO(false);be.setShadow(false,false);be.setRenderDepth(1);if(!bd){be.excludeFromCSO(true);be.excludeFromHighlight(true,true);be.exludeFromBounding(true)}if(bc){be.name=bc}return be}function av(bk){if(!bk.box){return}var bg=false;if(bk.node.children.length===1){var bf=bk.node.children[0];if(B.is3DLeaf(bf)||B.is3DLeaf(bk.node)||(k(bk.node)&&!v(bf))||(v(bk.node)&&!k(bf))){bg=true}}var bl=bk.box;var bj=bl.minX(),bd=bl.maxX(),bi=bl.minY(),bc=bl.maxY(),bh=bl.minZ();if((bd-bj)>0&&(bc-bi)>0){var be=U.createRectangleNode({width:bd-bj,height:bc-bi,fill:true,material:bg?i:h});be.setMatrix(new R.Matrix4().setPosition(new R.Vector3(bj,bi,bh)));aR.levels[aR.levels.length-1].node.addChild(az(be))}}function ap(bc){var be=Math.sqrt(bc);var bd=Math.floor(be);return be-bd<0.5?bd:bd+1}function a3(bc){return Math.ceil(Math.sqrt(bc))}function aZ(bl,bk,bt){if(bl.length){var bs=new u({name:"EmptyNodes",ratio:1});bs.setMatrix(new R.Matrix4().setPosition(new R.Vector3(bt.max.x,(bk.minY()+bk.maxY())/2,bt.min.z)));aR.levels[aR.levels.length-1].node.addChild(bs);var bg=5,bo={},bh={};var be=bl.length>3?ap(bl.length):1,bc=bl.length>3?a3(bl.length):bl.length;var bi=(be*0.5-1)*(e+2*bg),bv=0,bn;for(var bm=0;bm<be;++bm){var bj=0;for(var bq=0;bq<bc;++bq){var bp=bl[bv].node,br=false;if(bp.children.length===0){if(!v(bp)){M.log("Inst or RepInst with no Ref or RepRef");br=true}}else{if(bp.children.length!==1&&!v(bp)){M.log("Inst or RepInst with more than one Ref or RepRef");br=false}else{if(B.isRepInstance(bp)||B.is3DLeaf(bp.children[0])){br=true}else{if(B.is3DLeaf(bp)){br=true}}}}var bu=U.createRectangleNode({width:C+2*bg,height:e+2*bg,fill:true,material:br?i:h});bu.setMatrix(new R.Matrix4().setPosition(new R.Vector3(bj,bi,0)));bs.addChild(az(bu,false,"Node_"+bl[bv].id));bu.navigationAssociatedPath=bl[bv].pathElement;bn=H[bl[bv].type];if(!bn){bn=br?J:l;if(!bo[bl[bv].type]){bo[bl[bv].type]=bl[bv].id}bh[bl[bv].id]=bl[bv].type}var bd=U.createRectangleNode({width:C,height:e,fill:true,noEdge:true,material:bn});bd.setMatrix(new R.Matrix4().setPosition(new R.Vector3(bg,bg,bg)));bj+=C+2*bg;bu.addChild(az(bd,true,"Texture_"+bl[bv].id));bd.navigationAssociatedPath=bl[bv].pathElement;bv++;if(bv>=bl.length){break}}bi-=e+2*bg;if(bv>bl.length){break}}var bf=Object.keys(bo).map(function(bw){return bo[bw]});if(!bf.length){return}j.fetch({enopad_webapis:require("DS/PADUtils/PADSettingsMgt").getSetting("enopad_webapis"),data:{intent:"explore_2D",select_file:["preview_url","thumbnail_2d"],select_predicate:["physicalid"]},pids:bf,onComplete:function(bx){var by=JSON.parse(bx),bw={};((by&&by.results)||[]).forEach(function(bE){if(bE.attributes){var bD,bB;for(var bC=0,bA=bE.attributes.length;bC<bA&&(!bD||!bB);++bC){var bz=bE.attributes[bC];if(!bD&&bz.name==="ds6w:type"){bD=bz.value}else{if(!bB&&(bz.name==="preview_url"||bz.name==="thumbnail_2d")){bB=bz.value}}}if(bD&&bB){bw[bD]=bB}}});bs.getChildren().forEach(function(bD){var bC=bD.getChildren();if(bC&&bC.length){var bB=bC[0].name.replace("Texture_",""),bA,bz;if(bh[bB]){bA=H[bh[bB]];if(!bA&&bw[bh[bB]]){bz=new R.ImageUtils.loadTexture(bw[bh[bB]],undefined,function(){if(!H[bh[bB]]){H[bh[bB]]=bA=new R.MeshBasicMaterial({map:bz,side:R.DoubleSide,force:true,transparent:true})}else{bA=H[bh[bB]]}bC[0].setMaterial(bA)},function(){},true)}if(bA){bC[0].setMaterial(bA)}}}});a6.render()},onFailure:function(){}})}}function aX(be,bg){var bd=null,bf,bh,bc;if(v(be)||B.is3DLeaf(be)){bd=bg.clone();bd.addElement(be);bh=B.getNodeID(be);bc=B.getNodeType(be)}else{if((bf=be.getChildren()).length===1){bd=bg.clone();bd.addElement(be);bd.addElement(bf[0]);bh=B.getNodeID(bf[0]);bc=B.getNodeType(bf[0])}}return{id:bh,node:be,pathElement:bd,type:bc}}function aS(bd,bc){return bd.valueForSort<bc.valueForSort?-1:(bd.valueForSort>bc.valueForSort?1:0)}function ar(bd,bc){return bd.valueForSort>bc.valueForSort?-1:(bd.valueForSort<bc.valueForSort?1:0)}function aa(bd,bc){var be=new R.Box3();bd.forEach(function(bf){be.union(new R.Box3(bf.box.min(),bf.box.max()))});bd.delta=0;if(bc.min.y>be.min.y){bd.delta=bc.min.y-be.min.y}if(bc.max.y<be.max.y){bd.delta=Math.min(bd.delta,be.max.y-bc.max.y)}}function ac(bd,bc){var be=new R.Box3();bd.forEach(function(bf){be.union(new R.Box3(bf.box.min(),bf.box.max()))});bd.delta=0;if(bc.min.x>be.min.x){bd.delta=bc.min.x-be.min.x}if(bc.max.x<be.max.x){bd.delta=Math.min(bd.delta,be.max.x-bc.max.x)}}function aB(bh,bd,bg,bf,bc){var be=new R.Matrix4().setPosition(new R.Vector3().copy(bf.dir).multiplyScalar(bc));bg.box.applyMatrix4(be);bg.worldMatrixTarget=bg.worldMatrixSource.multiplyMatrices(be,bg.worldMatrixSource);bg.matrixTarget=new R.Matrix4().multiplyMatrices(bh,bg.worldMatrixTarget);delete bg.worldMatrixSource;if(bg.centerRotation){bg.centerRotation.applyMatrix4(be)}bd.union(new R.Box3(bg.box.min(),bg.box.max()));return bd}function aO(){var bc=aI.getFrameWindow();if(bc&&bc.removeReviewModel){bc.removeReviewModel()}}function am(bj){bb.forward();aI.getFrameWindow().getContextualUIManager().hideContextualMenus();if(bj.div===aR.levels[aR.levels.length-1].button){return}var bl=[],be=[],bg=[],bh=[],bm,bi,bf,bn;while(aR.levels.length){var bd=aR.levels.pop();if(bd.button===bj.div){aR.levels.push(bd);ak=bd.path;if(at){at.setCurrentPath(ak)}break}else{var bk;if(aR.levels.length===1){for(bm=aR.levels[0].overridesMove.length-1;bm>=0;--bm){bf=aR.levels[0].overridesMove[bm];bn=bf.getPathes();if(bn.length!==1){M.log("More than one path in override, not expected")}if(bn[0].isEqual(bd.path)){bk=bf.getPosition();break}}}for(bm=0,bi=bd.overridesMove?bd.overridesMove.length:0;bm<bi;++bm){bf=bd.overridesMove[bm];bl.push(bf);bn=bf.getPathes();if(bn.length!==1){M.log("More than one path in override, not expected")}var bc=bn[0].getLastElement(true).getMatrix();if(bk&&bn[0].isEqual(bd.path)){bc=bk;bk=null}bh.push({override:bf,matrixSource:bf.getPosition(),matrixTarget:bc})}for(bm=0;bm<(bd.overridesHide?bd.overridesHide.length:0);++bm){bl.push(bd.overridesHide[bm]);be.push({override:bd.overridesHide[bm]})}aR.mainDiv.removeBreadCrumb(bd.button.idthumb);a6.removeNode(bd.node);al.push({path:bd.path,pathReference:bd.pathReference})}}aO();bb.addAnimation({animationType:"unmask",objectListToAnimate:be,duration:1000});bb.addAnimation({animationType:"move",objectListToAnimate:bh,duration:1000,callBackFct:function(){a1.deleteOverrides(bl);a1.deleteOverrides(bg);a6.addNode(aR.levels[aR.levels.length-1].node);a6.render({updateInfinitePlane:true})}});bb.startAnimation();a6.render({updateInfinitePlane:true})}function ab(bf,bc,bd){if(!aW&&bd){aI.getFrameWindow().getViewpoint().reframe("iso",0)}var bg=new r({headLength:10,arrowLength:50,arrowWidth:2,head:r.types.ARROW});bg.exludeFromBounding(true);bg.setVisibilityInTree(false);bg.setPickable(E.NODRAWHL);var be=aR.levels[aR.levels.length-2].node.getChildByName("EmptyNodes");if(be){bg.setMatrix(be.getMatrix())}aR.levels[aR.levels.length-1].node.addChild(bg);bb.axisSystemVisibility({objectListToAnimate:[bg],visibility:true,pickability:false,callBackFct:function(){a6.addNode(aR.levels[aR.levels.length-1].node);if(!aW){aU()}}});bb.startAnimation()}function aN(bo,bj){ak=bo;if(at){at.setCurrentPath(ak)}var be=a6.getVisibleSpace(),bn={button:aR.mainDiv.addHomeBreadCrumb({cb:am}),path:bo};bn.node=new X("Navigation_"+aR.levels.length);bn.node.setVisibility(a6.getVisibleSpace()===1);bn.node.setVisibilityFree(false);bn.node.setVisibilityInTree(false);a6.addNode(bn.node);aR.levels.push(bn);var bc=[],bi,bd,bm,bg=[],bh=[],bf,bl,bk=bo.getLastElement(true);aR.levels[aR.levels.length-1].overridesMove=bc;bk.getChildren().forEach(function(bs){var bA=bo.clone();bA.addElement(bs);var br=a8(bA);if(br===-1){return}bd=bA.getBoundingBox(null,a6,"visibleSpace");bm=bA.getBoundingBox(null,a6,"invisibleSpace");if((!bd||bd.isNaN())&&(!bm||bm.isNaN())){if((br===0&&be)||(br===1&&!be)){bh.push(aX(bs,bo))}}else{bi=be?bd:bm;if(bi&&!bi.isNaN()){bi=new F(bi);var bz=bo.clone();bz.addElement(bs);var bv=bz.getMatrix(),bp=new R.Matrix4().copy(bv);var by=bz.getWorldMatrix();bi.applyMatrix4(by);var bq=bi.center();var bx=af(bi,null,true);if(bx){bp=aJ(bq,bx,by);by=bp;bi=new F(bA.getBoundingBox(null,a6,be?"visibleSpace":"invisibleSpace"));bi.applyMatrix4(bp);bq=bi.center()}if(!bf){bl=new R.Vector3().copy(bq);bf=new R.Box3(bi.min(),bi.max());bg.push({override:aE(bz,bc),matrixSource:bv,matrixTarget:bp,box:bi,node:bs})}else{var bt=bi.min(),bu=new R.Vector3();bu.x=(bq.x<bl.x)?(bf.min.x-Math.abs(bq.x-bt.x)):(bf.max.x+Math.abs(bq.x-bt.x));bu.y=bl.y;bu.z=bf.min.z+(bq.z-bt.z);var bw=new R.Matrix4().setPosition(bu.sub(bq));bi.applyMatrix4(bw);bp=new R.Matrix4().copy(bw).multiply(bp);bg.push({override:aE(bz,bc),matrixSource:bv,matrixTarget:bp,box:bi,node:bs});bf.union(new R.Box3(bi.min(),bi.max()))}}}});if(!bf){bf=new R.Box3(new R.Vector3(),new R.Vector3())}if(!aW&&bj){aI.getFrameWindow().getViewpoint().reframe("iso",0)}bb.addAnimation({animationType:"move",objectListToAnimate:bg,duration:bj?1000:0,callBackFct:function(){if(bj){a6.render({updateInfinitePlane:true});if(!aW){aU()}}}});bb.startAnimation();aZ(bh,new F(bf),bf);bg.forEach(av)}function a2(bC){var bo=bC.path.getWorldMatrix(),bd=new R.Matrix4().getInverse(bo),by=a6.getVisibleSpace(),bA=bC.pathReference?bC.pathReference.getLastElement(true):null,bl,bm=[],bB;if(!bA){var bw=0;bC.pathsToExplode.forEach(function(bH){var bF=bH.getBoundingBox(null,a6,"visibleSpace"),bE=bH.getBoundingBox(null,a6,"invisibleSpace"),bG;if((bF&&!bF.isNaN())||(bE&&!bE.isNaN())){if(!bF||bF.isNaN()){bG=0}else{bF=new F(bF);bF.applyMatrix4(bo);bG=(bF.maxX()-bF.minX())*(bF.maxY()-bF.minY())}if(bG>bw){bw=bG;bC.pathReference=bH;bA=bH.getLastElement(true)}}})}if(!aW&&bC.applyViewpoint){aI.getFrameWindow().getViewpoint().reframe("iso",0)}if(!bC.pathReference){var bn=aR.levels[aR.levels.length-2].node.getChildByName("EmptyNodes");bC.pathsToExplode.forEach(function(bE){bm.push(aX(bE.getLastElement(true),bC.path))});var bu=new R.Vector3().getPositionFromMatrix(bn?bn.getMatrix():bo);bB=new R.Box3(new R.Vector3(bu.x-C,bu.y-e/2,bu.z),new R.Vector3(bu.x,bu.y+e/2,bu.z));bl=new F(bB);bb.startAnimation();aZ(bm,bl,bB);if(bC.startAnimation){a6.addNode(aR.levels[aR.levels.length-1].node);a6.render({updateInfinitePlane:true})}if(bC.applyViewpoint){aU()}return}var be=[];aR.levels[aR.levels.length-1].overridesMove=be;var bD=bC.pathReference.getMatrix(),bh=new R.Matrix4().multiplyMatrices(bo,bD);bl=bC.pathReference.getBoundingBox(null,a6,by?"visibleSpace":"invisibleSpace");if(!bl||bl.isNaN()){bl=new R.Box3(new R.Vector3(),new R.Vector3())}bl=new F(bl);bl.applyMatrix4(bh);var bv=aL(bl,bh);var bx=af(bl,null,false);if(bx){var bp={override:aE(bC.path,be),matrixSource:bo,matrixRotation:bx,centerRotation:bv,matrixParentInv:new R.Matrix4().getInverse(bC.path.getParentPath().getWorldMatrix())};bb.addAnimation({animationType:"rotate",objectListToAnimate:[bp],duration:bC.startAnimation?500:0,callBackFct:function(){if(bC.startAnimation){a6.render({updateInfinitePlane:true})}}});bo=aJ(bv,bx,bo);bd=new R.Matrix4().getInverse(bo);bh=new R.Matrix4().multiplyMatrices(bo,bD);bl=new F(bC.pathReference.getBoundingBox(null,a6,by?"visibleSpace":"invisibleSpace"));bl.applyMatrix4(bh);bv=aL(bl,bh)}var bf=bl.minZ();if(!y){var bk=bC.path.getBoundingBox(null,a6,by?"visibleSpace":"invisibleSpace");if(bk){bk.applyMatrix4(bo);bf=bk.min.z}}var bi={path:bC.pathReference,override:aE(bC.pathReference,be),node:bA,matrixSource:bD,matrixTarget:bD,worldMatrixTarget:bh,box:bl};bi.vectorZMatrix=new R.Matrix4().setPosition(new R.Vector3(0,0,bf-bl.minZ()));bl.applyMatrix4(bi.vectorZMatrix);var br=[bi];var bt={min:[],max:[]},bq={min:[],max:[]};bt.min.dir=new R.Vector3(-1,0,0);bt.max.dir=new R.Vector3(1,0,0);bq.min.dir=new R.Vector3(0,-1,0);bq.max.dir=new R.Vector3(0,1,0);bC.pathsToExplode.forEach(function(bK){if(bK.isEqual(bC.pathReference)){return}var bH=bK.getBoundingBox(null,a6,"visibleSpace"),bO=bK.getBoundingBox(null,a6,"invisibleSpace");if((!bH||bH.isNaN()||bH.min.distanceTo(bH.max)<=0)&&(!bO||bO.isNaN()||bO.min.distanceTo(bO.max)<=0)){bm.push(aX(bK.getLastElement(true),bC.path))}else{var bL=by?bH:bO;if(bL&&!bL.isNaN()){bL=new F(bL);var bP={path:bK,node:bK.getLastElement(true)};br.push(bP);bP.override=aE(bP.path,be);bP.matrixSource=bP.path.getMatrix();var bM=new R.Matrix4().multiplyMatrices(bo,bP.matrixSource),bF=new R.Matrix4().getInverse(bM);bL.applyMatrix4(bM);bP.worldMatrixSource=bM.clone();var bG;var bE=new R.Vector3();bL.center(bE);var bJ=Math.abs(bL.maxX()-bL.minX()),bI=Math.abs(bL.maxY()-bL.minY());if(bJ>bI){bP.valueForSort=bE.y;if(bE.y<bv.y){bq.min.push(bP)}else{bq.max.push(bP)}bG=new R.Vector3().copy(bt.max.dir)}else{bP.valueForSort=bE.x;if(bE.x<bv.x){bt.min.push(bP)}else{bt.max.push(bP)}bG=new R.Vector3().copy(bq.max.dir)}var bN=af(bL,bG,false);if(bN){bP.matrixRotation=bN;bP.centerRotation=bE;bP.matrixParent=bo;bP.matrixParentInv=bd;bM=aJ(bE,bN,bM);bL.applyMatrix4(bF);bL.applyMatrix4(bM);bF.getInverse(bM)}bP.vectorZMatrix=new R.Matrix4().setPosition(new R.Vector3(0,0,bf-bL.minZ()));bL.applyMatrix4(bP.vectorZMatrix);bP.box=bL}}});bt.min.sort(ar);bt.max.sort(aS);bq.min.sort(ar);bq.max.sort(aS);var bs=0;bs+=bt.min.length?0:1;bs+=bt.max.length?0:1;bs+=bq.min.length?0:1;bs+=bq.max.length?0:1;if(bs===3){if(bt.min.length||bt.max.length){bv.x=bt.min.length?bt.min[0].box.maxX():bt.max[0].box.minX()}else{bv.y=bq.min.length?bq.min[0].box.maxY():bq.max[0].box.minY()}}bB=new R.Box3(new R.Vector3(bl.minX(),bl.minY(),bl.minZ()),new R.Vector3(bl.maxX(),bl.maxY(),bl.maxZ()));aa(bt.min,bB);aa(bt.max,bB);ac(bq.min,bB);ac(bq.max,bB);var bg=[bt.min,bt.max,bq.min,bq.max];bg.sort(function(bF,bE){return bF.delta-bE.delta});bg.forEach(function(bE){if(bE===bt.min){bt.min.forEach(function(bH,bF,bG){bB=aB(bd,bB,bH,bG,-1*((bB?bB.min.x:bv.x)-bH.box.maxX()))})}else{if(bE===bt.max){bt.max.forEach(function(bH,bF,bG){bB=aB(bd,bB,bH,bG,(bB?bB.max.x:bv.x)-bH.box.minX())})}else{if(bE===bq.min){bq.min.forEach(function(bH,bF,bG){bB=aB(bd,bB,bH,bG,-1*((bB?bB.min.y:bv.y)-bH.box.maxY()))})}else{if(bE===bq.max){bq.max.forEach(function(bH,bF,bG){bB=aB(bd,bB,bH,bG,(bB?bB.max.y:bv.y)-bH.box.minY())})}}}}});var bz=[],bc=[],bj;br.forEach(function(bE){if(bE.matrixRotation){bj=M.extend({},bE);bc.push(bj);bj.matrixSource=bE.matrixTarget;bj.worldMatrixTarget=aJ(bE.centerRotation,bE.matrixRotation,bE.worldMatrixTarget);bE.centerRotation.applyMatrix4(bd);bj.matrixTarget=new R.Matrix4().multiplyMatrices(bd,bj.worldMatrixTarget);bE=bj}bj=M.extend({},bE);bz.push(bj);bj.matrixSource=bE.matrixTarget;bj.worldMatrixTarget.multiplyMatrices(bE.vectorZMatrix,bE.worldMatrixTarget);bj.matrixTarget=new R.Matrix4().multiplyMatrices(bd,bj.worldMatrixTarget)});bb.addAnimation({animationType:"move",objectListToAnimate:br,duration:bC.startAnimation?300:0,offsetTime:bx?500:0});bb.addAnimation({animationType:"rotate",objectListToAnimate:bc,duration:bC.startAnimation?400:0,offsetTime:bx?800:300});bb.addAnimation({animationType:"move",objectListToAnimate:bz,duration:bC.startAnimation?300:0,offsetTime:bx?(bc.length?1200:800):(bc.length?700:300),callBackFct:function(){if(bC.startAnimation){a6.addNode(aR.levels[aR.levels.length-1].node);a6.render({updateInfinitePlane:true})}if(bC.applyViewpoint){aU()}}});bb.startAnimation();a6.render({updateInfinitePlane:true});aZ(bm,bl,bB);br.forEach(av)}function ae(br,bh,bn,bo){bb.forward();var be=[],bg=[],bf=br.getLastElement(true),bj=false;if(v(bf)&&!B.is3DLeaf(bf)){bj=true;bf.children.forEach(function(bs){var bt=br.clone();bt.addElement(bs);if(a8(bt)!==-1){be.push(bt)}})}else{if(k(bf)){var bm=br.clone();bm.addElement(bf.children[0]);ae(bm,bh,bn,bo)}}if(be.length||bj){ak=br;aO();if(at){at.setCurrentPath(ak)}if(aR.levels&&aR.levels.length&&aR.levels[aR.levels.length-1].node){a6.removeNode(aR.levels[aR.levels.length-1].node)}var bk=[];var bl=ak.externalPath.length>1?ak.externalPath[ak.externalPath.length-2]:null;if(k(bl)&&bl.parents.length===1){bg=bg.concat(ak.getParentPath().getSiblingsPathes())}else{if(bl&&bl===a9){bg=bg.concat(ak.getSiblingsPathes())}}if(bg.length){bb.addAnimation({animationType:"mask",objectListToAnimate:[{override:aE(bg,bk),duration:bn?1000:0}]})}var bq={path:ak,node:new X("Navigation_"+aR.levels.length),overridesHide:bk,pathReference:bh};bq.node.setVisibility(a6.getVisibleSpace()===1);bq.node.setVisibilityFree(false);bq.node.setVisibilityInTree(false);aR.levels.push(bq);var bp=bf.getChildren().every(function(bt){var bs=bt.getChildren();if(bs.length===0){return true}if(bs.length!==1){M.log("Instance or RepInstance with no or more than one Reference or RepReference");return false}if(!B.isPLMNode(bs[0])){M.log("Navigation to a non PAD3DViewer node should not be possible");return true}if(B.is3DLeaf(bs[0])){return true}return false}),bd=B.getNodeID(bf),bc=[bd],bi=B.getNodeID(ak.externalPath[ak.externalPath.length-2]);if(bi){bc.push(bi)}if(!bq.button){bq.button=aR.mainDiv.addBreadCrumb({cb:am,lastBreadCrumb:bp})}aI.getController().getAttributes({ids:bc,attributes:["ds6w:label"],callbacks:{onComplete:function(bt){var bs=bt[bd]?bt[bd]["ds6w:label"]:"";if(bi&&bt[bi]&&bt[bi]["ds6w:label"]){bs+=" ("+bt[bi]["ds6w:label"]+")"}if(aR.mainDiv){aR.mainDiv.setLabel(bq.button.idthumb,bs)}},onFailure:function(){}}});if(be.length){a2({path:bq.path,pathsToExplode:be,pathReference:bq.pathReference,startAnimation:bn,applyViewpoint:bo})}else{ab(br)}}}function aD(bh){var bf=bh.gesture?bh.gesture.getEvents()[0]:bh.from[0];var be=a6.pick(a6.getMousePosition(bf.getCurrentPosition(a6.canvas)),"mesh",false);if(be.path&&be.path.length&&ak){var bd=be.path[0].getLastElement(true);if(bd.navigationAssociatedPath){be.path[0]=bd.navigationAssociatedPath}var bi=ak.clone();if(be.path[0].externalPath.length>bi.externalPath.length){bi.addElement(be.path[0].externalPath[bi.externalPath.length]);var bc=k(bi.externalPath[bi.externalPath.length-1])?[0,1]:[0];var bg;if(be.path[0].externalPath.length>=(bi.externalPath.length+bc.length)){bg=bi.clone();bc.forEach(function(bj){bg.addElement(be.path[0].externalPath[bi.externalPath.length+bj])})}z.empty();x.empty();al=[];ae(bi,bg,true,false)}}}function aC(bc){if(bc.key==="ArrowLeft"||bc.keyCode===37||bc.key==="ArrowUp"||bc.keyCode===38){if(aR.levels.length>1){document.removeEventListener("keydown",aC);aR.mainDiv.activate(aR.levels[aR.levels.length-2].button.idthumb);document.addEventListener("keydown",aC)}}else{if(bc.key==="ArrowRight"||bc.keyCode===39||bc.key==="ArrowDown"||bc.keyCode===40){if(al.length>0){var bd=al.pop();document.removeEventListener("keydown",aC);ae(bd.path,bd.pathReference,true,false);document.addEventListener("keydown",aC)}}}}var aY=(function(){var bc;return function(bh,bg){var bd,bm,bi,bj,bf,bn;if(bg===aQ[2]){bc=true;aR.levels.forEach(function(bo){a6.removeNode(bo.node);bo.node=null});for(bm=aR.levels.length-1;bm>0;--bm){aR.mainDiv.removeBreadCrumb(bm-1)}return}else{if(bg===aQ[3]||bg===aQ[10]){bc=false;var be=aI.getController();aR.levels.forEach(function(bu,bp,br){if(bp===0){return}var bt=bu.path,bq=br[bp-1].path.clone();for(bi=bq.externalPath.length,bj=bt.externalPath.length;bi<bj;++bi){bd=B.getNodeID(bt.externalPath[bi]);bf=be.getNode({id:bd});if(bf){bq.addElement(bf)}else{break}}var bo=bu.pathReference,bs=bo?bq.clone():undefined;if(bs){for(bi=bs.externalPath.length,bj=bo.externalPath.length;bi<bj;++bi){bd=B.getNodeID(bo.externalPath[bi]);bf=be.getNode({id:bd});if(bf){bs.addElement(bf)}else{break}}}bu.path=bq;bu.pathReference=bs})}}if(bc){return}bb.forward();ay.removeSceneGraphOverrideSet(a1);a1=null;aR.mainDiv.destroy();ao=[];aR.levels.forEach(function(bo){a6.removeNode(bo.node);bo.node=null;ao.push({path:bo.path,pathReference:bo.pathReference})});aR.mainDiv=new I({parentFrame:aI.getFrameWindow().getUIFrame()});aR.levels=[];a1=new N(aI.getRootBagPath().externalPath[0]);ay.pushSceneGraphOverrideSet(a1);var bk=ao,bl;if(bg===aQ[0]&&(bl=B.getRoots(aI))&&bl.length===1&&!B.is3DLeaf(bl[0])&&(bk.length===1||(bk.length>1&&!d(bk[1].path)))){bn=bk[0].path.clone();bn.addElement(bl[0]);bk.length=1;bk.push({path:bn})}else{if(bg===aQ[1]&&bk.length>1&&!d(bk[1].path)&&(bl=B.getRoots(aI))&&bl.length===1&&!B.is3DLeaf(bl[0])){bn=bk[0].path.clone();bn.addElement(bl[0]);bk.length=1;bk.push({path:bn})}}if(at){at.setCurrentPath(ak=null)}for(bm=0;bm<bk.length;++bm){if(bm===0){aN(bk[bm].path,(bk.length-1)===bm)}else{bn=bk[bm].path;if(!d(bn)||a8(bn)===-1){bb.startAnimation();a6.addNode(aR.levels[aR.levels.length-1].node);a6.render({updateInfinitePlane:true});break}ae(bn,bk[bm].pathReference,(bk.length-1)===bm,false)}}bb.forward()}}());function a0(){aI.getFrameWindow().getContextualUIManager().register({onContextualBarReady:function(bf,bj){var be=x.get();if(be.length===0){return undefined}var bh=B.getRoots(aI);var bi=[],bd=false,bg=be.some(function(bl){var bk=bl.pathElement.getLastElement(true);return bh.some(function(bm){var bo=bm!==bk;var bn=bl.pathElement.externalPath.some(function(bp){return bm===bp});if(!bd&&bn){bd=true}return bo&&bn})});if(bd&&bj&&bj.withContextMenu&&typeof bj.XmousePosition==="number"&&typeof bj.YmousePosition==="number"){var bc=a6.pick(a6.getMousePosition(new R.Vector2(bj.XmousePosition,bj.YmousePosition)),"mesh",false);if(bc.path.length===0){bg=bd=false}}if(bg&&O.getCommand("CAT3DComposeExamineSelectionHdr",aI.getCommandContext?aI.getCommandContext():null).canBeEnabled(be)){bi.push({name:"CATC3DNavigationExamineSelectionStr",line:1,hdr_list:["CAT3DComposeExamineSelectionHdr"]})}if(!y&&bd&&be.length===1&&!B.is3DLeaf(be[0].pathElement.getLastElement(true))){bi.push({name:"CATC3DNavigationOnChildStr",line:1,hdr_list:["CATC3DNavigationOnChildHdr"]})}return bi.length?{cmdList:bi}:undefined},context:aI.getCommandContext?aI.getCommandContext():null,workbenchName:"CATC3DNavigation",module:"CATC3DNavigation",cmdPrefix:"",merge:true,subscriberId:"CATC3DNavigation_"+(++n)})}this.start=function(){aV=true;aP=new q();var bd=aI.getFrameWindow().getViewpoint();aP.store(bd);c=a6.backgroundColor;g();ag=aI.isRobotVisible();aI.setRobotVisibility(false);aI.setDefaultContextualBarVisibility(false);aG=a6.picking.primitive;an=a6.pPicking.primitive;a6.setPrePicking({primitive:0});a6.setPicking({primitive:0});aH=f.onPreAdd(au);ax=z.onPreAdd(aA);a5=z.onRemove(ah);a4=x.onPreAdd(aF);ad=G.getTooltipManager({context:aI});ba=ad.register({onTooltipReady:ai,filterPath:aq});aQ.push(aI.subscribe({event:"onLoadingComplete"},aY));aQ.push(aI.subscribe({event:"onEndRootRemoved"},aY));aQ.push(aI.subscribe({event:"onRefreshBegin"},aY));aQ.push(aI.subscribe({event:"onRefreshCompleted"},aY));aQ.push(aI.subscribe({event:"onRootDetached"},aY));aQ.push(aI.subscribe({event:"onRootAttached"},aY));aQ.push(aI.subscribe({event:"onAuthoringTransactionEnd"},aY));aQ.push(aI.subscribe({event:"onShow"},aY));aQ.push(aI.subscribe({event:"onHide"},aY));aQ.push(aI.subscribe({event:"onExpandCompleted"},aY));aQ.push(aI.subscribe({event:"onEndDelete"},aY));aQ.push(aI.subscribe({event:"onEndMatriceUpdate"},aY));a7=a6.onSwapVisibleSpace?a6.onSwapVisibleSpace(aY):null;at=t.getDropManager({context:aI});at.connect();aK=at.subscribe({event:"onEndInsertDrop3D"},aY);a1=new N(aI.getRootBagPath().externalPath[0]);ay.pushSceneGraphOverrideSet(a1);s.addEvent(a6.canvas,"onLeftDoubleClick",aD);s.addEvent(a6.canvas,"onDoubleTap",aD);aR.mainDiv=new I({parentFrame:aI.getFrameWindow().getUIFrame()});aR.levels=[];var bg=[],bf;if(!ak||!d(ak)||!ao||ao.length===0){bg.push({path:aI.getRootBagPath()});var bc=B.getRoots(aI);if(bc.length===1&&!B.is3DLeaf(bc[0])){bf=bg[0].path.clone();bf.addElement(bc[0]);bg.push({path:bf})}aW=null}else{bg=ao}ak=null;if(at){at.setCurrentPath(ak)}for(var be=0;be<bg.length;++be){if(be===0){aN(bg[be].path,(bg.length-1)===be)}else{bf=bg[be].path;if(!d(bf)||a8(bf)===-1){bb.startAnimation();a6.addNode(aR.levels[aR.levels.length-1].node);a6.render({updateInfinitePlane:true});aU();break}ae(bf,bg[be].pathReference,(bg.length-1)===be,(bg.length-1)===be)}}document.addEventListener("keydown",aC);a0()};this.end=function(){aV=false;bb.stop();aI.getFrameWindow().getContextualUIManager().unregister("CATC3DNavigation_"+n);document.removeEventListener("keydown",aC);aO();aI.setRobotVisibility(ag);aI.setDefaultContextualBarVisibility(false);a6.setPicking({primitive:aG});a6.setPrePicking({primitive:an});at.disconnect();at.unsubscribe(aK);f.unsubscribe(aH);z.unsubscribe(ax);x.unsubscribe(a4);z.unsubscribe(a5);ad.unregister(ba);G.unreferenceTooltipManager({context:aI});aH=ax=a4=a5=ba=at=aK=null;for(var bd=z.get(),be=bd.length-1;be>=0;--be){var bf=bd[be];if(bf&&bf.pathElement.externalPath[0]!==a9&&bf.pathElement.getLastElement(true).navigationAssociatedPath){z.remove(bf);bf.pathElement=bf.pathElement.getLastElement(true).navigationAssociatedPath.clone();if(!z.isIn(bf)){z.add(bf)}}}aQ.forEach(function(bg){aI.unsubscribe(bg)});aQ=[];a6.unsubscribe(a7);a7=null;var bc=aI.getFrameWindow().getViewpoint();if(aW){aW.store(bc,d(ak)?ak.getWorldMatrix():null)}aP.restore(bc);ay.removeSceneGraphOverrideSet(a1);a1=null;s.removeEvent(a6.canvas,"onLeftDoubleClick",aD);s.removeEvent(a6.canvas,"onDoubleTap",aD);aR.mainDiv.destroy();ao=[];aR.levels.forEach(function(bg){a6.removeNode(bg.node);ao.push({path:bg.path,pathReference:bg.pathReference})});aR={};al=[];a6.render({updateInfinitePlane:true})};this.pause=function(){if(aH&&aV){document.removeEventListener("keydown",aC);a6.setPicking({primitive:aG});a6.setPrePicking({primitive:an});f.unsubscribe(aH);aH=undefined;z.unsubscribe(ax);ax=undefined;z.unsubscribe(a5);a5=undefined;x.unsubscribe(a4);a4=undefined;ad.unregister(ba);ba=undefined;s.removeEvent(a6.canvas,"onLeftDoubleClick",aD);s.removeEvent(a6.canvas,"onDoubleTap",aD);aI.getFrameWindow().getContextualUIManager().unregister("CATC3DNavigation_"+n);aR.mainDiv.hide();if(aR.levels[aR.levels.length-1].node){a6.removeNode(aR.levels[aR.levels.length-1].node)}}};this.resume=function(){if(!aH&&aV){aG=a6.picking.primitive;an=a6.pPicking.primitive;a6.setPrePicking({primitive:0});a6.setPicking({primitive:0});aH=f.onPreAdd(au);ax=z.onPreAdd(aA);a5=z.onRemove(ah);a4=x.onPreAdd(aF);ba=ad.register({onTooltipReady:ai,filterPath:aq});s.addEvent(a6.canvas,"onLeftDoubleClick",aD);s.addEvent(a6.canvas,"onDoubleTap",aD);document.addEventListener("keydown",aC);a0();aR.mainDiv.show();if(aR.levels[aR.levels.length-1].node){a6.addNode(aR.levels[aR.levels.length-1].node)}}};this.navigateOnChild=function(bd){var bc=bd&&bd.pathToExplode?bd.pathToExplode:null;if([1,2].some(function(){bc=bc?bc.getParentPath():null;return bc?bc.isEqual(ak):null})){z.empty();x.empty();al=[];ae(bd.pathToExplode,null,true,false)}}}});return Z});define("DS/CATC3DNavigation/CATC3DNavigationStartCmd",["DS/ApplicationFrame/Command","DS/PADUtils/PADContext","DS/ApplicationFrame/CommandsManager","DS/CATC3DNavigation/CATD3CBoxNavigation","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(h,i,c,g,d){var e="CATC3DNavigation";e+=require("DS/PADUtils/PADSettingsMgt").getSetting("appModelerType")==="DEC"?"DEC":"";e+=".xml";var f=h.extend({init:function(k){var n=this;this._parent(k,{mode:"exclusive",isAsynchronous:false});this.setRepeatMode(false);this.execute=function(){var p=b.getNavigationObject({context:i.get()}),o=this._ctx;if(p.onExit&&p.onExit.actionBar&&p.onExit.actionBar.length){if(p.onStart&&p.onStart.onStart){p.done=function(){delete p.done;var q=p.context.subscribe({event:"onActionBarReady"},function(){p.context.unsubscribe(q);c.setDefaultCommand({ID:"CATD3CNavigationDefaultHdr",className:"DS/CATC3DNavigation/CATC3DNavigationDefaultCmd",context:o});p.activated=true;if(!p.controller){p.controller=new g({context:p.context})}p.controller.start()});p.context.loadActionBar({merge:false,file:e,module:"CATC3DNavigation"})};p.onStart.onStart(p)}}};this.onNavigationStart=function(p){var o=b.getNavigationObject({context:i.get()});if(!o.activated){o.onStart=p}};this.onNavigationExit=function(p){var o=b.getNavigationObject({context:i.get()});if(!o.activated){o.onExit=p}};var j=i.get(),l=j.subscribe({event:"onRootAdded"},function(){if(d.getRoots(j).length===1){n.enable()}}),m=j.subscribe({event:"onEndRootRemoved"},function(){if(d.getRoots(j).length===0){n.disable()}});if(d.getRoots(j).length===0){this.disable()}this._destroy=function(){j.unsubscribe(l);l=null;j.unsubscribe(m);m=null;Object.getPrototypeOf(this)._destroy.apply(this,arguments);n=null}}});return f});var a=function(e,c,d){["_commands","_cmdCheckHeader"].forEach(function(g){var f=d?e[g][d]:e[g];if(f[c]){if(f[c]._destroy){f[c]._destroy()}delete f[c]}})};define("DS/CATC3DNavigation/CATC3DNavigationEndCmd",["DS/ApplicationFrame/Command","DS/PADUtils/PADContext","DS/ApplicationFrame/CommandsManager"],function(g,h,d){var e="CATC3DNavigation",c;e+=require("DS/CAT3DComposeWidget/CAT3DComposeWidgetOptions").getOption("authoring3d")&&require("DS/PADUtils/PADSettingsMgt").getSetting("appModelerType")!=="DEC"?"Next":"";require(["text!DS/CATC3DNavigation/assets/afr/"+e+".xml"],function(i){c=i});var f=g.extend({init:function(i){this._parent(i,{mode:"exclusive",isAsynchronous:false});this.setRepeatMode(false);this.execute=function(){var p=b.getNavigationObject({context:h.get()});p.activated=false;if(p.controller){p.controller.end()}var q={lastCommand:[],currentCommand:null,defaultCommand:null};if(this._ctx){d._commandsState[this._ctx]=q}else{d._commandsState=q}d.resetDefaultCommand(this._ctx);a(d,"CATD3CNavigationDefaultHdr",this._ctx);var n=new DOMParser().parseFromString(c,"text/xml").getElementsByTagName("CATCommandHeader");for(var m=n.length-1;m>=0;--m){var k=n[m].attributes.getNamedItem("ClassName").value;if(!k.startsWith("DS/ViewerCommands")&&!k.startsWith("DS/ENOPAD3DViewer")){var j=n[m].attributes.getNamedItem("ID").value;if(j!=="CAT3DComposeExamineSelectionHdr"){a(d,j,this._ctx)}}}var o=0;var l=p.context.subscribe({event:"onActionBarReady"},function(){if(p.onExit.actionBar[o-1].onActionBarReady){p.onExit.actionBar[o-1].onActionBarReady()}if(o<p.onExit.actionBar.length){p.context.loadActionBar({merge:true,file:p.onExit.actionBar[o].file,module:p.onExit.actionBar[o].module});o++}else{p.context.unsubscribe(l)}});p.context.loadActionBar({merge:false,file:p.onExit.actionBar[0].file,module:p.onExit.actionBar[0].module});o++}}});return f});define("DS/CATC3DNavigation/CATC3DNavigationOnChildCmd",["DS/ApplicationFrame/Command","DS/PADUtils/PADContext","DS/Selection/CSOManager"],function(d,e,c){return d.extend({init:function(f){this._parent(f,{mode:"exclusive",isAsynchronous:false});this.setRepeatMode(false);this.execute=function(){var g=e.get(),i=c.get(),j=i.length===1?i[0].pathElement:null,h=j?b.giveNavigationObject({context:g}):null;g.getFrameWindow().getContextualUIManager().hideContextualMenus();if(h){setTimeout(function(){h.controller.navigateOnChild({pathToExplode:j})},0)}}}})});define("DS/CATC3DNavigation/CATC3DNavigationContoller",["UWA/Class"],function(d){var c=d.singleton({init:function(){},getNavigationContoller:function(f){var e=b.getNavigationObject({context:f.context});return e.controller},isNavigationActivated:function(f){var e=b.giveNavigationObject({context:f.context});return e?e.activated:false}});return c})}());define("DS/CAT3DComposeCommands/CATC3DCommandsUtils",["DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(b){var c=function(g){return g&&b.isPLMNode(g)};var e=function(g){return g&&b.isReference(g)};var a=function(g){return g&&b.isInstance(g)};var f=function(g){return g&&b.is3DLeaf(g)};var d={};d.isPLMNode=c;d.isPLMReferenceNode=e;d.isPLMInstanceNode=a;d.isPLMLeafNode=f;d.getLevelSelectorLevels=function(w){if(!w){return undefined}var p=w.pathElement,h=w.pathElementCurrent,g=w.onInfoCompleted,i=w.context;if(!p||!i){return undefined}var l=[],s=[],k=[],q=null,v=i.getBIController()?i.getBIController().isColorizeActivated():false;var n={levels:l};var t=p.clone(),u=t.getLastElement(true),j=false;while(u){var m={};if(a(u)&&l.length===0&&u.children.length===1){m.pathElement=t.clone();var o=u.children[0];m.pathElement.addElement(o);if(!v){k.push(m.modifID=b.getNodeID(u))}else{m.canvasColor=b.getBIColor(o)}s.push(m.idRef=b.getNodeID(o));s.push(m.idInst=b.getNodeID(u));q=1}else{if(e(u)){m.pathElement=t.clone();s.push(m.idRef=b.getNodeID(u));var x=t.externalPath.length>1?t.externalPath[t.externalPath.length-2]:null;if(a(x)){s.push(m.idInst=b.getNodeID(x));if(!v){k.push(m.modifID=b.getNodeID(x))}}else{j=true}if(v){m.canvasColor=b.getBIColor(u)}}else{if(f(u)){m.pathElement=t.clone();s.push(m.idRef=b.getNodeID(u));if(v){m.canvasColor=b.getBIColor(u)}}else{if(j){if(c(u)){var r=t.externalPath.length>1?t.externalPath[t.externalPath.length-2]:null;if(!c(r)){m.pathElement=t.clone();s.push(m.idRef=b.getNodeID(u));if(!v){k.push(m.modifID=b.getNodeID(u))}else{m.canvasColor=b.getBIColor(u)}j=false}}}}}}if(m.pathElement){if(q===null&&h&&h.isEqual(m.pathElement)){q=l.length}l.push(m)}t=t.getParentPath();u=t?t.getLastElement(true):undefined}if(q!==null){n.currentLevel=q}i.getController().getAttributes({ids:s,attributes:["ds6w:label","type_icon_url"],callbacks:{onComplete:function(y){l.forEach(function(z){z.name=y[z.idRef]?y[z.idRef]["ds6w:label"]:"";if(z.idInst&&y[z.idInst]&&y[z.idInst]["ds6w:label"]){z.name+=" ("+y[z.idInst]["ds6w:label"]+")"}z.icon=y[z.idRef]?y[z.idRef].type_icon_url:undefined;delete z.idRef;delete z.idInst});if(g){g()}},onFailure:function(){l.forEach(function(y){delete y.idRef;delete y.idInst})}}});if(!v&&k.length&&require("DS/PADUtils/PADSettingsMgt").getSetting("appModelerType")==="DEC"){i.getController().getEditability({data:k,intent:"MOVE",callbacks:{onComplete:function(y){l.forEach(function(z){if(z.modifID in y&&!y[z.modifID]){z.canvasColor="#FF6565"}delete z.modifID});if(g){g()}},onFailure:function(){}}})}return n};return d});define("DS/CAT3DComposeWidget/CAT3DComposeWidgetOptions",["UWA/Core","UWA/Class","UWA/Class/Options","UWA/Utils"],function(b,e,c,a){var d=e.singleton(c,{init:function(){var f={};if(window.c3dUrlComplementForODT){f=a.parseQuery(window.c3dUrlComplementForODT)}if(window.location.search!==""){b.extend(f,a.parseQuery(window.location.search));if(f.widgetDomain){b.extend(f,a.parseQuery(f.widgetDomain))}}var g={};if("c3dAnim" in f){g.animationOff=f.c3dAnim==="no"}if("C3DSTR" in f){g.C3DSTR=true}if("debug_me" in f){g.debug=true}if("testWkb" in f){g.testWkb=true}if("authoring3d" in f){g.authoring3d=true}this.setOptions(g)}});return d});
/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CAT3DComposeMoveManager/CAT3DComposeMoveManager",["UWA/Core","UWA/Class","DS/ApplicationFrame/Command","DS/CoreEvents/ModelEvents","DS/Visualization/PathElement","DS/Visualization/ThreeJS_DS","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(o,p,a,e,h,m,j,c){var b=require("DS/PADUtils/PADSettingsMgt").getSetting("appModelerType");function k(s){var r=[];if(!s||!s.modelController){o.log("Creation fails");return r}r.modelController=s.modelController;r.isIn=function(t){var u;this.some(function(v){return(u=v.path.isEqual(t)?v:null)});return u};r.initMove=function(t){var u=this.isIn(t);if(!u){u={path:t.clone(),initMatrix:t.getMatrix()};this.push(u)}return u};r.addMove=function(u){var t=this.isIn(u);if(t){t.moved=true;if(!t.hasOwnProperty("isLocked")){if(b==="DEC"){if(!t.editabilityRequested){this.modelController.getEditability({data:[c.getNodeID(u.getLastElement(true))],intent:"MOVE",callbacks:{onComplete:function(v){delete t.editabilityRequested;t.isLocked=!v[c.getNodeID(t.path.getLastElement(true))]},onFailure:function(){delete t.editabilityRequested;t.isLocked=false}}});t.editabilityRequested=true}}else{t.isLocked=false}}}return t};return r}function i(r){return r&&c.isPLMNode(r)}function g(r){return r&&c.isReference(r)}function n(r){return r&&c.isInstance(r)}function l(u,A,t){var y,B;if(!u||!u.path){return undefined}if(A&&t){y=A.getUniqueOverrideFromPathElement(u.path);if(!y){y=A.createOverride({pathes:[u.path]})}}if(u.transformation){B=new m.Matrix4().copy(u.initWorldMatrix).multiply(u.transformation)}else{if(u.leafMatrix){if(y){y.setPosition(u.leafMatrix)}else{u.path.getLastElement(true).setMatrix(u.leafMatrix)}return 0}else{if(u.worldMatrix){B=u.worldMatrix}else{if(u.vector){var x=new m.Vector3().getPositionFromMatrix(u.initWorldMatrix).add(u.vector);B=new m.Matrix4().copy(u.initWorldMatrix).setPosition(x)}else{if(u.axis&&u.center&&u.angle!==undefined){var s=new m.Matrix4().copy(u.initWorldMatrix);var w=new m.Matrix4().makeRotationAxis(u.axis,u.angle);var C=new m.Matrix4().setPosition(u.center);var v=new m.Matrix4().getInverse(C).multiply(s);var z=new m.Matrix4().copy(w).multiply(v);B=new m.Matrix4().copy(C).multiply(z)}}}}}if(B){var r=new m.Matrix4().getInverse(u.path.getParentPath().getWorldMatrix());if(y){y.setPosition(r.multiply(B))}else{u.path.getLastElement(true).setMatrix(r.multiply(B))}return 0}return undefined}var d=p.extend({init:function(y){var A=this,t,s,E=new e(),x=y.context,C=[],J=new k({modelController:x.getController()}),H,w="Persistent",D,v,G=[];function z(){if(!x){return}J=new k({modelController:x.getController()});C=[];w=null;if(s&&t){t.removeSceneGraphOverrideSet(s);if(x.getViewer()){x.getViewer().render()}}s=t=null}function I(){var L=[],O=[],K=[],N={};function P(){E.publish({event:"onValidateMove",data:{objectsMoved:O,objectsCancelled:L,splitInstances:K,eventID:"success"}});if(x.getController().onMove3D&&Array.isArray(N.instances)){var Q=N.instances.filter(function(R){return !K.some(function(S){return S.oldId===R.instance})});if(Q.length){x.getController().onMove3D({instances:Q})}}z()}function M(){O.forEach(function(Q){Q.path.getLastElement(true).setMatrix(Q.initMatrix)});E.publish({event:"onValidateMove",data:{objectsMoved:[],objectsCancelled:L.concat(O),eventID:"error"}});z()}J.forEach(function(R){if(R.moved){var Q={};(R.isLocked&&!s?L:O).push(Q);Q.path=R.path;Q.initMatrix=R.initMatrix;Q.currentMatrix=R.path.getMatrix();Q.isLocked=R.isLocked;if(R.isLocked){if(!s){R.path.getLastElement(true).setMatrix(R.initMatrix)}}delete R.moved;delete R.isLocked}});if(s){E.publish({event:"onValidateMove",data:{objectsMoved:O,eventID:"success"}});z();return}if(b==="DEC"){N={data:O.map(function(R){var Q=R.path.getLastElement(true);return{id:c.getNodeID(Q),matrix:Q.getMatrix()}}),userFeedback:true,callbacks:{onComplete:function(){E.publish({event:"onValidateMove",data:{objectsMoved:O,objectsCancelled:L,eventID:"success"}});z()},onFailure:function(){O.forEach(function(Q){Q.path.getLastElement(true).setMatrix(Q.initMatrix)});E.publish({event:"onValidateMove",data:{objectsMoved:[],objectsCancelled:L.concat(O),eventID:"error"}});z()}}};if(N.data.length){x.getController().storePositions(N)}else{E.publish({event:"onValidateMove",data:{objectsMoved:[],objectsCancelled:L,eventID:"success"}});z()}}else{if(b==="VPM"){N={onComplete:function(Q){if(Q.status!=="success"){M();return}if(Q.results&&Q.results.length){Q.results.forEach(function(R){if(R.status!=="success"){window.console.log("Whole transaction is OK but it fails for an instance. Unexpected!!")}if(R.instanceOut&&R.instance&&R.instance!==R.instanceOut){K.push({oldId:R.instance,newId:R.instanceOut})}})}if(O.length){x.getController().switchAuthoringMode(true,true,"PADSession_disabling_index_authoring")}if(K.length){x.getController().replaceInstances({data:K},{onComplete:P,onFailure:function(){window.console.log("An id has no node associated. Unexpected!!");P()}})}else{P()}},onFailure:M,instances:O.map(function(S){var R=S.path.getLastElement(true),Q=R.getMatrix();return{instance:c.getNodeID(R),hasPositioningMatrix:[0,1,2,4,5,6,8,9,10,12,13,14].map(function(T){return Q.elements[T]})}})};if(N.instances.length){H.move3D(N)}else{P()}}}}function F(L){var K=[];L.forEach(function(O){if(O.moved){var M={};K.push(M);M.path=O.path;M.initMatrix=O.initMatrix;M.currentMatrix=O.path.getMatrix();M.isLocked=O.isLocked;if(!s){O.path.getLastElement(true).setMatrix(O.initMatrix)}else{var N=s.getUniqueOverrideFromPathElement(O.path);if(N){N.setPosition(null)}}delete O.moved;delete O.isLocked}});E.publish({event:"onCancelMove",data:{objectsCancelled:K,bEmptyMove:!J.some(function(M){return M.moved}),someMovedObjectsAreLocked:J.some(function(M){return M.isLocked})}});if(x){if(x.getViewer()){x.getViewer().render();x.publish({event:"onModelUpdated",data:{rootNodes:x.getRoots()}})}}}function r(){var M=[];for(var K=J.length-1;K>=0;--K){var L=J[K];if(L.moved&&L.isLocked){M.push(L);J.splice(K,1)}}F(M)}function B(){var M=[];for(var K=J.length-1;K>=0;--K){var L=J[K];if(L.moved){M.push(L);J.splice(K,1)}}F(M);z()}G.push(x.subscribe({event:"onRootRemoved"},function(M){var K=[],L=new k({modelController:x.getController()});J.forEach(function(N){if(!M.path.isAParentOf(N.path)){L.push(N)}else{K.push(N)}});if(L.length!==J.length){F(K);J=L}}));G.push(x.subscribe({event:"onEndDelete"},function(N){var O=[],L=c.getNodeID(N.pathToReparent);for(var M=J.length-1;M>=0;--M){var K=J[M];if(K.path.externalPath.some(function(P){return c.getNodeID(P)===L})){O.push(K);J.splice(M,1)}}F(O)}));G.push(x.subscribe({event:"onBeginReparent"},function(){B()}));G.push(x.subscribe({event:"onEndMatriceUpdate"},function(K){K.instances.forEach(function(N){for(var M=J.length-1;M>=0;--M){var L=c.getNodeID(J[M].path.getLastElement(true));if(L===N.instance){J.splice(M,1)}}});B()}));function u(L){var K=[];L.forEach(function(P){if(P.path||P.pathElement){var O=A.getSubPathToMovable(P.path||P.pathElement);var M=K.some(function(Q){if(Q.path.isEqual(O)){return true}return false});if(!M){var N={path:O};K.push(N)}}});return K}this.setMode=function(K){var L=(typeof K.useOverride==="boolean")?K.useOverride:true;if((L&&s)||(!L&&!s)){return}if(J.length){B()}z();if(L){t=x.getViewer().getSceneGraphOverrideSetManager();s=new j(x.getRootBagPath().externalPath[0]);t.pushSceneGraphOverrideSet(s)}};this.setMode({useOverride:y.useOverride});if(b==="VPM"){require(["DS/UPSCommands/UPSCmdUtils"],function(K){H=K})}else{if(b!=="DEC"){o.log("Unknown modeler type")}}this.cancelLocked=function(){r()};this.onMoveBegin=function(K){C=[];if(!K||!K.objectsMoved||!K.from||!K.moveMode){return}if(K.moveMode!=="Persistent"&&K.moveMode!=="Transient"){return}w=K.moveMode;D=undefined;v=undefined;var L=u(K.objectsMoved);L.forEach(function(N){var M={path:N.path,initMatrix:N.path.getLastElement(true).getMatrix(),initWorldMatrix:N.path.getWorldMatrix()};if(K.axis&&K.center){M.axis=K.axis;M.center=K.center;M.angle=0}else{M.vector=new m.Vector3()}C.push(M);J.initMove(N.path)});E.publish({event:"MoveBegin",data:{objectsMoved:L,from:K.from,moveMode:w}})};this.onMove=function(N){if(!N||!N.objectsMoved||!N.from){return}if(!N.vector&&N.angle===undefined&&!N.transformation&&!N.leafMatrix&&!N.worldMatrix){return}if(w!=="Persistent"&&w!=="Transient"){return}if(N.transformation||N.leafMatrix||N.worldMatrix){D=undefined;v=undefined}else{if(D===undefined&&N.vector){D=new m.Vector3()}else{if(v===undefined&&N.angle!==undefined){v=0}else{if((v&&N.angle===undefined)||(D&&N.vector===undefined)){return}}}}var O=u(N.objectsMoved);var M,L;if(D){M=new m.Vector3().subVectors(N.vector,D);D=new m.Vector3().copy(N.vector)}else{if(v!==undefined){L=N.angle-v;v=N.angle}}var K=false;O.forEach(function(P){C.some(function(Q){if(P.path.isEqual(Q.path)){if(N.transformation){Q.transformation=N.transformation;Q.vector=Q.angle=Q.leafMatrix=Q.worldMatrix=undefined}else{if(N.leafMatrix){Q.leafMatrix=N.leafMatrix;Q.vector=Q.angle=Q.transformation=Q.worldMatrix=undefined}else{if(N.worldMatrix){Q.worldMatrix=N.worldMatrix;Q.vector=Q.angle=Q.transformation=Q.leafMatrix=undefined}else{if(Q.vector){Q.vector.add(M);Q.transformation=Q.leafMatrix=Q.worldMatrix=undefined}else{if(Q.axis&&Q.axis!==undefined){Q.angle+=L;Q.transformation=Q.leafMatrix=Q.worldMatrix=undefined}}}}}if(w==="Transient"||(w==="Persistent"&&0===l(Q,s,x))){K=true}return true}return false})});if(O.length>0&&w==="Persistent"){O.forEach(function(Q){var P=Q.path.getLastElement(true);if(n(P)){J.addMove(Q.path);J.bPersistantMoved=true}})}if(K){E.publish({event:"Move",data:{objectsMoved:O,from:N.from,moveMode:w}})}};this.onMoveEnd=function(L){if(!L||!L.from||!L.status){return}if(w!=="Persistent"&&w!=="Transient"){return}if(w==="Persistent"&&L.status==="Cancelled"){C.forEach(function(O){if(!s){O.path.getLastElement(true).setMatrix(O.initMatrix)}else{var N=s.getUniqueOverrideFromPathElement(O.path);if(N){N.setPosition(null)}}})}else{if(w==="Transient"&&L.status==="Moved"){var K=[];C.forEach(function(N){if(l(N,s,x)===0){var O={path:N.path.clone()};K.push(O)}});if(K.length>0){var M={objectsMoved:[],from:L.from,moveMode:"Persistent"};K.forEach(function(P){var N=P.path.getLastElement(true);if(n(N)){var O=J.addMove(P.path);if(O){M.objectsMoved.push(O)}}});E.publish({event:"Move",data:M})}}}E.publish({event:"MoveEnd",data:{from:L.from,status:L.status}});x.publish({event:"onModelUpdated",data:{rootNodes:x.getRoots()}});C=[]};this.subscribe=function(K,M){var L;if(K==="MoveBegin"||K==="Move"||K==="MoveEnd"||K==="onValidateMove"||K==="onCancelMove"){L=E.subscribe({event:K},M)}return L};this.unsubscribe=function(K){E.unsubscribe(K)};this.getSubPathToMovable=function(L){if(!L){return undefined}var M=new h(L.externalPath),N;while(M&&!n(M.getLastElement(true))){M=M.getParentPath()}if(!M){N=new h();var O=L.externalPath.some(function(P){N.addElement(P);return g(P)});if(O){M=N}}if(!M){N=new h();var K=L.externalPath.some(function(P){N.addElement(P);return i(P)});if(K){M=N}}return M};this.terminateMove=function(K){if((typeof K.save==="boolean")&&K.save){I()}else{B()}};this.isPathLocked=function(N){if(!N||!N.pathElement||!N.onCompleted){return{returnCode:-1}}var M=N.pathElement.getLastElement(true),O,L=c.getRoots(x);if(L.some(function(P){return P===M})){O={returnCode:0,pathElement:N.pathElement,isLocked:false};setTimeout(function(){N.onCompleted(O)},0);return O}if(!c.isInstance(M)){return{returnCode:-2}}O={returnCode:0};var K=J.isIn(N.pathElement);if(K&&K.hasOwnProperty("isLocked")){O.pathElement=N.pathElement;O.isLocked=K.isLocked;setTimeout(function(){N.onCompleted({pathElement:N.pathElement,isLocked:K.isLocked})},0)}else{if(b==="DEC"){x.getController().getEditability({data:[c.getNodeID(N.pathElement.getLastElement(true))],intent:"MOVE",callbacks:{onComplete:function(P){var Q=!P[c.getNodeID(N.pathElement.getLastElement(true))];if(J.bPersistantMoved===true){if(!K){K=J.initMove(N.pathElement)}K.isLocked=Q}N.onCompleted({pathElement:N.pathElement,isLocked:Q})},onFailure:function(){N.onCompleted({pathElement:N.pathElement,isLocked:false})}}})}else{if(!K){K=J.initMove(N.pathElement)}K.isLocked=false;O.pathElement=N.pathElement;O.isLocked=K.isLocked;setTimeout(function(){N.onCompleted({pathElement:N.pathElement,isLocked:K.isLocked})},0)}}return O};this._destroy=function(){G.forEach(function(K){x.unsubscribe(K)});G=[];B();z();x=t=A=null}}});var q=[];var f=p.singleton({init:function(){},getMoveManager:function(s){var t;if(s&&s.context){q.some(function(u){if(u.context===s.context){t=u.moveManager;return true}return false});if(!t){var r=new d(s);q.push({context:s.context,moveManager:r});t=r}}return t},unreferenceMoveManager:function(r){q.some(function(t,s){if(t.context===r.context){q.splice(s,1);t.moveManager._destroy();return true}return false})}});return f});define("DS/CAT3DComposeWidget/CATC3DAppInit",["DS/WAfrContainer/App"],function(b){var a;function c(e,d){return e.extend({setUp:function(f){if(!f.sourceApp){var h=this;require(["DS/CAT3DComposeWidget/CAT3DComposeWidgetMain"],function(i){a=i.getApp({widget:window.widget,viewerAttachment:function(j){h.pad3DViewer=j.pad3DViewer;f.done(j.pad3DViewer.render())},modelerType:d})});return}if(!f.sourceApp.pad3DViewer){window.console.log("pad3DViewer property must be valuated");f.done();return}this.pad3DViewer=f.sourceApp.pad3DViewer;function g(i){if(i.sourceApp&&!i.sourceApp.isDisposeCalled()){i.sourceApp.dispose()}a.setUp(i)}if(!a){require(["DS/CAT3DComposeWidget/CAT3DComposeWidgetMain"],function(i){a=i.getApp({widget:window.widget,pad3DViewer:f.sourceApp.pad3DViewer});g(f)})}else{g(f)}},dispose:function(f){a.dispose(f);this._parent(f)}})}return c(b,"VPM")});define("DS/CAT3DComposeWidget/CATC3DAppTransition",["DS/WAfrContainer/App"],function(b){var a;function c(e,d){return e.extend({setUp:function(f){if(!f.sourceApp){var h=this;require(["DS/CAT3DComposeWidget/CAT3DComposeWidgetMain"],function(i){a=i.getApp({widget:window.widget,viewerAttachment:function(j){h.pad3DViewer=j.pad3DViewer;f.done(j.pad3DViewer.render())},modelerType:d})});return}if(!f.sourceApp.pad3DViewer){window.console.log("pad3DViewer property must be valuated");f.done();return}this.pad3DViewer=f.sourceApp.pad3DViewer;function g(i){if(i.sourceApp&&!i.sourceApp.isDisposeCalled()){i.sourceApp.dispose()}a.setUp({done:i.done})}if(!a){require(["DS/CAT3DComposeWidget/CAT3DComposeWidgetMain"],function(i){a=i.getApp({widget:window.widget,pad3DViewer:f.sourceApp.pad3DViewer});g(f)})}else{g(f)}},dispose:function(f){a.dispose();this._parent(f)}})}return c(b,"DEC")});define("DS/CAT3DComposeUtils/CAT3DComposeUnits",["i18n!DS/CAT3DComposeUtils/assets/nls/CAT3DComposeUtils"],function(a){var b={Types:{Length:{name:"Length",defaultValue:"mm"},Angle:{name:"Angle",defaultValue:"deg"},Volume:{name:"Volume",defaultValue:"mm3"},Area:{name:"Area",defaultValue:"mm2"}},Length:{mm:{name:"mm",nls:a.units.mm,ratio:1},cm:{name:"cm",nls:a.units.cm,ratio:Math.pow(10,-1)},m:{name:"m",nls:a.units.m,ratio:Math.pow(10,-3)},km:{name:"km",nls:a.units.km,ratio:Math.pow(10,-6)},inch:{name:"inch",nls:a.units.inch,ratio:1/25.4},foot:{name:"foot",nls:a.units.foot,ratio:1/304.8}},Angle:{deg:{name:"deg",nls:a.units.deg,ratio:1},rad:{name:"rad",nls:a.units.rad,ratio:Math.PI/180}},Volume:{mm3:{name:"mm3",nls:a.units.mm3,ratio:1},cm3:{name:"cm3",nls:a.units.cm3,ratio:Math.pow(10,-3)},m3:{name:"m3",nls:a.units.m3,ratio:Math.pow(10,-9)},km3:{name:"km3",nls:a.units.km3,ratio:Math.pow(10,-18)},inch3:{name:"inch3",nls:a.units.inch3,ratio:1/16387.064},foot3:{name:"foot3",nls:a.units.foot3,ratio:1/28316846.6}},Area:{mm2:{name:"mm2",nls:a.units.mm2,ratio:1},cm2:{name:"cm2",nls:a.units.cm2,ratio:Math.pow(10,-2)},m2:{name:"m2",nls:a.units.m2,ratio:Math.pow(10,-6)},km2:{name:"km2",nls:a.units.km2,ratio:Math.pow(10,-12)},inch2:{name:"inch2",nls:a.units.inch2,ratio:1/645.16},foot2:{name:"foot2",nls:a.units.foot2,ratio:1/92903.04}}};return Object.freeze(b)});define("DS/CATC3DGeometry/CATC3DGeometryEnums",[],function(){var a={};a.GeometryType={POINT:0,CURVE:2,LINE:3,CIRCLE:4,SURFACE:5,PLANE:6,CYLINDER:7,CONE:8,SPHERE:9,AXISSYSTEM:11,AXISSYSTEMAXIS:12,AXISSYSTEMORIGIN:13,AXIS:14,AXISX:15,AXISY:16,AXISZ:17,REFPLANE:18};a.GeometryMode={REAL:0,TRANSIENT:1};Object.freeze(a);return a});define("DS/CAT3DComposeMoveManager/CATC3DMoveReferent",["UWA/Class","DS/Visualization/PathElement","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(j,c,a){var f=function(l){return l&&a.isPLMNode(l)},b=function(l){return l&&a.isReference(l)},i=function(l){return l&&a.isInstance(l)},g=function(m){if(!m||!m.externalPath||m.externalPath.length===0||(m.internalPath&&m.internalPath.length>0)){return false}if(!f(m.externalPath[m.externalPath.length-1])){return false}for(var l=m.externalPath.length-2;l>=0;--l){if(f(m.externalPath[l])){return false}}return true},h=function(n){if(!n||!n.externalPath){return undefined}for(var l=0;l<n.externalPath.length;l++){var m=n.externalPath[l];if(f(m)){return m}}return undefined},d=j.extend({init:function(m){var o=[],l=m.context,n=(function(){function q(s,r){if(!b(s)){s.getChildren().forEach(function(t){q(t,r)})}else{s.getChildren().forEach(function(u){if(i(u)){var t=u.children.length===1?u.children[0]:undefined;if(t){if(!r.some(function(v){return t===v})){r.push(t)}}}})}}return function p(t){var r=t.path?h(t.path):t;if(r&&!(o.some(function(u){return u.rootNode===r}))){var s=[];o.push({rootNode:r,referentList:s});q(r,s)}}})();l.subscribe({event:"onRootAdded"},n);a.getRoots(l).forEach(n);l.subscribe({event:"onRootRemoved"},function(p){var q=h(p.path);if(!q){return}o.some(function(s,r){if(s.rootNode===q){o.splice(r,1);return true}return false})});l.subscribe({event:"onInsertExisting"},function(p){if(!b(p.modifiedNode)||!i(p.createdNode)||!b(p.insertedNode)){return}o.forEach(function(r){var q=r.rootNode;if(q===p.modifiedNode){if(!r.referentList.some(function(s){return s===p.insertedNode})){r.referentList.push(p.insertedNode)}return}if(b(q)){return}q.getChildren().forEach(function(s){if(s.children&&s.children.length===1&&s.children[0]===p.modifiedNode){if(!r.referentList.some(function(t){return t===p.insertedNode})){r.referentList.push(p.insertedNode)}}})})});this.addMoveReferent=function(q){var p=h(q);if(!p){return}o.some(function(s){if(s.rootNode===p){var r=false;q.externalPath.slice().reverse().forEach(function(u){if(!r){if(i(u)){var t=u.children&&u.children.length>0?u.children[0]:null;if(!b(t)){return}if(!s.referentList.some(function(v){return v===t})){s.referentList.push(t)}r=true}}else{if(b(u)){s.referentList.some(function(w,v){if(w===u){s.referentList.splice(v,1);return true}return false})}}});return true}return false})};this.getMoveReferent=function(s){var t;if(s){if(g(s)){t=s.clone()}else{t=new c();var r=this.getSubPathToMovable(s);var q=h(r);var p=o.some(function(z){if(z.rootNode===q){for(var x=0;x<r.externalPath.length;x++){var v=false;var y=r.externalPath[x];if(i(y)){var w=y.children[0];for(var u=0;u<z.referentList.length;u++){if(z.referentList[u]===w){v=true;break}}}t.addElement(y);if(v){break}}return true}return false});if(!p){t=undefined}}}return t};this.getSubPathToMovable=function(q){if(!q){return undefined}var r=new c(q.externalPath),s;while(r&&!i(r.getLastElement(true))){r=r.getParentPath()}if(!r){s=new c();var t=q.externalPath.some(function(u){s.addElement(u);return b(u)});if(t){r=s}}if(!r){s=new c();var p=q.externalPath.some(function(u){s.addElement(u);return f(u)});if(p){r=s}}return r}}}),e=[],k=j.singleton({init:function(){},getMoveReferentManager:function(m){var n;if(m&&m.context){e.some(function(o){if(o.context===m.context){n=o.moveReferent;return true}return false});if(!n){var l=new d(m);e.push({context:m.context,moveReferent:l});n=l}}return n}});return k});define("DS/CATC3DNavigation/CATBreadCrumbs",["UWA/Core","UWA/Class","DS/CoreEvents/Events","css!DS/CATC3DNavigation/CATC3DNavigation.css"],function(b,d,a){var c=d.extend({init:function(j){var o=10000;var e;var C=[];var l=j.parentFrame;var r,A,u;var g=null;var f=function(){if(!r){return}r.div.setStyle("z-index",o+1);if(C.length){r.div.setStyle("border-top-right-radius","0px");r.div.setStyle("border-bottom-right-radius","0px")}else{r.div.setStyle("border-top-right-radius","5px");r.div.setStyle("border-bottom-right-radius","5px")}};var B=function(){for(var D=0;D<C.length;D++){C[D].div.removeClassName("first-crumb");C[D].div.removeClassName("crumbs-with-home");C[D].div.removeClassName("last-crumb");if(D===0){C[D].div.addClassName("first-crumb");if(r){C[D].div.addClassName("crumbs-with-home")}}if(C[D].lastBreadCrumb){C[D].div.addClassName("last-crumb")}C[D].div.setStyle("z-index",o-D)}f()};var n=function(H){var F=null;var E=H.changedTouches[0].clientX,D=H.changedTouches[0].clientY;var G=e.getPosition();e.getChildren().some(function(L){var N=L.getPosition(),J=L.getDimensions();var K=N.x+G.x,O=K+J.width;var I=N.y+G.y,M=I+J.height;if(typeof L.idthumb==="number"&&(L.idthumb<C.length-1)){O+=16}if(K<=E&&E<=O&&I<=D&&D<=M){F=L;return true}return false});return F};var k=function(D){if(D&&A===D){D.addClassName("navigationBreadCrumbActivated")}if(D&&D.idthumb!=="Home"&&!g){g=setTimeout(function(){D.querySelector("p").addClassName("navigationBreadCrumbExpand");g=null},1000)}};var s=function(D){if(D){D.removeClassName("navigationBreadCrumbActivated")}if(D&&D.idthumb!=="Home"){if(g){clearTimeout(g);g=null}else{if(!A||A!==D){D.querySelector("p").removeClassName("navigationBreadCrumbExpand")}}}};var y=function(D){if(A&&D&&A===D.div){A.removeClassName("navigationBreadCrumbActivated");D.cb()}A=null};var p=function(D){if(D.touches.length!==1){return}D.preventDefault();D.stopPropagation();k(A=u=n(D))};var t=function(E){if(E.touches.length!==1){return}E.preventDefault();E.stopPropagation();var D=n(E);if(D!==u){s(u);k(D);u=D}};var m=function(D){D.preventDefault();D.stopPropagation();var E=n(D);y(E?(E.idthumb==="Home"?r:C[E.idthumb]):null);s(E)};var h=function(D){var E=D.target.idthumb;k(E==="Home"?r.div:C[E].div)};var x=function(D){var E=D.target.idthumb;s(E==="Home"?r.div:C[E].div)};var v=function(E){if(E.button!==0||E.buttons!==1){return}var F=E.target.idthumb;k(A=F==="Home"?r.div:C[F].div);var D=a.subscribe({event:"/VISU/onLeftMouseUp"},function(G){a.unsubscribe(D);D=undefined;var I=G.from[0].event.target.idthumb;var H=I==="Home"?r.div:(typeof I==="number"?C[I].div:null);if(H!==A){A.querySelector("p").removeClassName("navigationBreadCrumbExpand");A=null}})};var z=function(D){if(!A||D.button!==0||D.buttons!==0){return}var E=D.target.idthumb;y(E==="Home"?r:C[E])};this.activate=function(D){if(e){if(D!=="Home"){C[D].cb()}else{r.cb()}}};function q(){if(!e){e=b.createElement("ul",{"class":"navigationBreadCrumb"}).inject(l)}}function i(){if(e){if(C.length===0&&!r){e.destroy();e=null}else{B()}}}this.addHomeBreadCrumb=function(E){if(!E||r){return undefined}q();r={};r.div=b.createElement("li",{"class":"navigationBreadCrumb homeBreadCrumb"});var D=b.createElement("span",{"class":"homeBreadCrumb fonticon fonticon-home"}).inject(r.div);D.idthumb="Home";if(C.length===0){e.appendChild(r.div)}else{e.insertBefore(r.div,C[0].div)}r.cb=function(){return E.cb?E.cb({div:r.div}):undefined};r.div.setStyle("opacity","1");r.div.setStyle("right","0px");r.div.idthumb="Home";r.div.addEvents({mousedown:v,mouseup:z,mouseenter:h,mouseleave:x});r.div.addEvents({touchstart:p,touchmove:t,touchend:m});B();return r.div};this.removeHomeBreadCrumb=function(){if(e&&r){r.div.removeEvents();e.removeChild(r.div);r=null}i()};this.addBreadCrumb=function(F){q();var D=b.createElement("li",{"class":"navigationBreadCrumb"}).inject(e);D.idthumb=C.length;var G=b.createElement("p").inject(D);G.idthumb=C.length;G.innerHTML=b.is(F.label)&&b.is(F.label,"string")?F.label:"";var E=b.createElement("span").inject(D);E.idthumb=C.length;C.push({div:D,cb:function(){return F.cb?F.cb({div:D}):undefined},lastBreadCrumb:F.lastBreadCrumb});D.addEvents({mousedown:v,mouseup:z,mouseenter:h,mouseleave:x});D.addEvents({touchstart:p,touchmove:t,touchend:m});B();setTimeout(function(){D.setStyle("opacity","1");D.setStyle("right","0px")},10);return D};function w(E,D){if(e){C[E].div.setStyle("opacity","0");C[E].div.setStyle("right","25px");C[E].div.removeEvents();e.removeChild(C[E].div);C.splice(E,1)}if(D){i()}}this.removeBreadCrumb=function(D){w(D,true)};this.setLabel=function(E,D){if(!e){return}if(E!=="Home"&&E<C.length){C[E].div.querySelector("p").innerHTML=D}};this.destroy=function(){for(var D=C.length-1;D>=0;D--){w(D,false)}this.removeHomeBreadCrumb()};this.show=function(){if(e){e.show()}};this.hide=function(){if(e){e.hide()}}}});return c});define("DS/CAT3DComposeUtils/CATC3DUtils",["DS/PADUtils/PADSettingsMgt"],function(e){var d,b,g;function f(i,p,l,n){var k=l.length,h=i.getFrameWindow().getViewpoint().reframe,j,o,m=function(){k--;if(k===0){i.unsubscribe(j);i.unsubscribe(o);i.getFrameWindow().getViewpoint().reframe=h;n(l)}};j=i.subscribe({event:"onInsertExisting"},m);o=i.subscribe({event:"onInsertExistingFailure"},m);i.getFrameWindow().getViewpoint().reframe=function(){};l.forEach(function(q){if(q.instID){i.getController().switchAuthoringMode(true,true,"PADSession_disabling_index_authoring");i.getController().insertExisting({created:[q.instID],inserted:[[p,q.instID,q.childID]],modified:[p]})}else{m()}})}function c(l,h,k){if(h){var j={onComplete:function(){k()},onFailure:function(){k();window.console.log("Unable to store matrix")}};if(d==="DEC"){var i="";[0,1,2,4,5,6,8,9,10,12,13,14].forEach(function(m){i+=h.elements[m]+(m!==14?",":"")});j.enopad_webapis=e.getSetting("enopad_webapis");j.data=[{id:l,attributes:[{name:"matrixtxt",value:i}]}];if(b){b.modify(j)}else{k()}}else{if(d==="VPM"){j.instances=[{instance:l,hasPositioningMatrix:[0,1,2,4,5,6,8,9,10,12,13,14].map(function(m){return h.elements[m]})}];if(g){g.move3D(j)}}else{k()}}}else{k()}}function a(j){if(typeof j.parentID!=="string"||!(j.children instanceof Array)||typeof j.onCompleted!=="function"||!j.context){return}if(!d){var i=e.getSetting("appModelerType");if(i==="DEC"){require(["DS/PADUtils/PADWSAccess"],function(l){b=l;d=i;a(j)})}else{if(i==="VPM"){require(["DS/AuthGenericCommands/AuthGenericCmdWSAccess","DS/UPSCommands/UPSCmdUtils"],function(l,m){b=l;g=m;d=i;a(j)})}else{d="Error";window.console.error("Unknown modeler type");a(j)}}return}var k=j.parentID,h=[];if(d==="DEC"){j.children.forEach(function(l){b.insertExisting({data:{parent:k,child:l.id,commit:true},onComplete:function(n){var o=typeof n==="string"?JSON.parse(n):null;if(o&&o.status==="success"){var m=o.newNode.attributes[0].value;c(m,l.matrix,function(){h.push({instID:m,childID:l.id});if(j.children.length===h.length){f(j.context,k,h,j.onCompleted)}})}else{h.push({instID:null,childID:l.id,message:o&&o.message?o.message:undefined});if(j.children.length===h.length){f(j.context,k,h,j.onCompleted)}}},onFailure:function(m){var n=typeof m==="string"?JSON.parse(m):null;h.push({instID:null,childID:l.id,message:n&&n.message?n.message:undefined});if(j.children.length===h.length){f(j.context,k,h,j.onCompleted)}}})})}else{if(d==="VPM"){j.children.forEach(function(l){b.insertExisting({modeler:"product",data:{version:"1.0",hasParent:k,children:[{isInstanceOf:l.id}]},onComplete:function(n){var o=typeof n==="string"?JSON.parse(n):null;if(o&&o.status==="success"){var m=o.results[0].instance;c(m,l.matrix,function(){h.push({instID:m,childID:l.id});if(j.children.length===h.length){f(j.context,k,h,j.onCompleted)}})}else{h.push({instID:null,childID:l.id,message:o&&o.message?o.message:undefined});if(j.children.length===h.length){f(j.context,k,h,j.onCompleted)}}},onFailure:function(m){var n=typeof m==="string"?JSON.parse(m):null;h.push({instID:null,childID:l.id,message:n&&n.message?n.message:undefined});if(j.children.length===h.length){f(j.context,k,h,j.onCompleted)}}})})}}}return Object.freeze({insertExisting:a})});define("DS/CAT3DComposeCommands/CAT3DComposeSetIdentityMatrixCmd",["DS/ApplicationFrame/Command","DS/Selection/CSOManager","DS/PADUtils/PADContext","DS/Visualization/ThreeJS_DS","DS/CAT3DComposeMoveManager/CATC3DMoveReferent","DS/CAT3DComposeMoveManager/CAT3DComposeMoveManager"],function(e,c,f,d,a,g){var b=e.extend({init:function(i){this._parent(i,{mode:"shared",isAsynchronous:false});this.setRepeatMode(false);var k=this;var h=g.getMoveManager({context:f.get()});var j=a.getMoveReferentManager({context:f.get()});this.execute=function(){var l=[];c.get().forEach(function(n){var m=j.getMoveReferent(n.pathElement);if(m){l.push({path:m})}});if(l.length){h.onMoveBegin({objectsMoved:l,from:k,moveMode:"Persistent"});h.onMove({objectsMoved:l,from:k,leafMatrix:new d.Matrix4()});h.onMoveEnd({from:k,status:"Moved"})}}}});return b});define("DS/CAT3DComposeCommands/CATC3DPasteAtLocalCoordinatesCmd",["DS/ApplicationFrame/CommandCheckHeader","DS/Selection/CSOManager","DS/PADUtils/PADContext","DS/Visualization/ThreeJS_DS","DS/ApplicationFrame/CommandsManager","DS/CAT3DComposeMoveManager/CAT3DComposeMoveManager"],function(f,c,e,d,b,h){var g=new d.Matrix4();var a=f.extend({init:function(j){this._parent(j);var k=this,i=h.getMoveManager({context:e.get()});this.onStateChange(function(){if(k.getState()){var m=[];c.get().forEach(function(n){m.push({path:n.pathElement})});if(m.length){i.onMoveBegin({objectsMoved:m,from:k,moveMode:"Persistent"});i.onMove({objectsMoved:m,from:k,leafMatrix:g});i.onMoveEnd({from:k,status:"Moved"});e.get().getViewer().render()}var l=e.get();b.getCommandCheckHeader("CATC3DPasteAtOriginalPositionHdr",l.getCommandContext?l.getCommandContext():null).setState(false)}});this.toggleState=function(){if(!k.getState()){k.setState(true)}};this._destroy=function(){if(Object.getPrototypeOf(this)._destroy){Object.getPrototypeOf(this)._destroy.apply(this,arguments)}k=undefined}}});return a});define("DS/CAT3DComposeWidget/CAT3DComposeWidgetMain",["DS/CAT3DComposeWidget/CAT3DComposeWidgetOptions"],function(b){var c;function a(i){if(c||null===c){return c}var z=i.widget,B=i.pad3DViewer,g,H,j,o,D,F,v=B?B.getCommandContext():null;if(B){j=require("DS/PADUtils/PADSettingsMgt").getSetting("appModelerType")}if(j!=="DEC"||j!=="VPM"){j=i.modelerType==="DEC"?"DEC":"VPM";if(B){require("DS/PADUtils/PADSettingsMgt").setSetting("appModelerType",j)}}var d,E,y,m,n=(j==="DEC"?"DEC":"")+".xml",q=b.getOption("testWkb")?{module:"CAT3DComposeWebUXTstUtils",file:"CAT3DComposeWidgetWkb_TST.xml",xmlPath:"text!DS/CAT3DComposeWebUXTstUtils/assets/afr/CAT3DComposeWidgetWkb_TST.xml"}:b.getOption("authoring3d")&&j!=="DEC"?{module:"CAT3DComposeWidget",file:"CAT3DComposeWidgetNextWkb.xml",xmlPath:"text!DS/CAT3DComposeWidget/assets/afr/CAT3DComposeWidgetNextWkb.xml"}:b.getOption("authoring3d")&&j==="DEC"?{module:"CAT3DComposeWidget",file:"CAT3DComposeWidgetNextWkbDEC.xml",xmlPath:"text!DS/CAT3DComposeWidget/assets/afr/CAT3DComposeWidgetNextWkbDEC.xml"}:{module:"CAT3DComposeWidget",file:"CAT3DComposeWidgetWkb"+n,xmlPath:"text!DS/CAT3DComposeWidget/assets/afr/CAT3DComposeWidgetWkb"+n};require([q.xmlPath],function(I){q.xml=I});function t(K,J,I){window.top.performance.measure(z.id+K,I?z.id+J:J)}function G(I){window.top.performance.mark(z.id+I)}function A(){if(B){B.getContentName({callbacks:{onComplete:function(I){z.setTitle(I.contentName)},onFailure:function(){}}})}}function w(J,I){["_commands","_cmdCheckHeader"].forEach(function(L){var K=v?J[L][v]:J[L];if(K[I]){if(K[I]._destroy){K[I]._destroy()}delete K[I]}})}function p(L,I,J){var K=L.getCommand("CATC3DNavigationStartHdr",v);if(K){K.onNavigationStart({onStart:function(Q){var R={lastCommand:[],currentCommand:null,defaultCommand:null};if(v){L._commandsState[v]=R}else{L._commandsState=R}L.resetDefaultCommand(v);I.getDropManager({context:B}).disconnect();var N=m.giveComposeRobot({context:B});if(N){N.unreference()}H=Q;w(L,"CAT3DComposeWidgetDefaultHdr");var P=q.xml?new DOMParser().parseFromString(q.xml,"text/xml").getElementsByTagName("CATCommandHeader"):[];for(var O=P.length-1;O>=0;--O){var M=P[O].attributes.getNamedItem("ID").value;if(M!=="CAT3DComposeExamineSelectionHdr"){w(L,M)}}Q.done()}});K.onNavigationExit({actionBar:[{file:"ENOPAD3DViewer.xml",module:"ENOPAD3DViewer"},{file:q.file,module:q.module,onActionBarReady:function(){L.setDefaultCommand({ID:"CAT3DComposeWidgetDefaultHdr",className:"DS/CAT3DComposeCommands/CAT3DComposeWidgetDefaultCmd",context:v});J.getComposeRobot({context:B});H=null;B.setDefaultContextualBarVisibility(false);B.setDefaultContextualMenuVisibility(true);I.getDropManager({context:B}).connect()}}]})}}function k(I){if(!d||!m||!y||!E||o){return}p(E,y,m);g({pad3DViewer:I});g=null;require(["DS/ENOPAD3DViewer/utils/PAD3DViewerRestoreSession"],function(J){J.restoreSession()});t("_C3D_Global widget creation time","C3D_jsAppLoad",false);z.dispatchEvent("onWidgetAndAppReady",z.getValue("widgetForODTReplay")==="1"?[{pad3DViewer:I}]:undefined)}function h(I){I.unsubscribe(D);D=null;I.getController()._model._modelLoader.setCGRWithSG(true);G("_C3D_beforeRobotAndDirectMoveLoad");require(["DS/CAT3DComposeRobot/CAT3DComposeRobot","DS/CAT3DComposeMoveManager/CAT3DComposeMoveManager","DS/CAT3DComposeUtils/CATC3DDropManager"],function(L,M,J){t("_C3D_Applicative Init JS Loading","_C3D_beforeRobotAndDirectMoveLoad",true);G("_C3D_afterRobotAndDirectMoveLoad");d=M;var K=d.getMoveManager({context:I});K.setMode({useOverride:false});m=L;m.getComposeRobot({context:I});I.getFrameWindow().getContextualUIManager().activateContextualBarOnLeftClicAfterCSOChange();t("_C3D_Applicative Init","_C3D_afterRobotAndDirectMoveLoad",true);y=J;y.getDropManager({context:I}).connect();k(I)})}function u(I){I.unsubscribe(F);F=null;var J=I.subscribe({event:"onActionBarReady"},function(){t("_C3D_Action Bar merge app commands","_C3D_ownCommands",true);G("_C3D_beforeDefaultCmdLoad");I.unsubscribe(J);J=null;v=B.getCommandContext();E=require("DS/ApplicationFrame/CommandsManager");E.setDefaultCommand({ID:"CAT3DComposeWidgetDefaultHdr",className:"DS/CAT3DComposeCommands/CAT3DComposeWidgetDefaultCmd",context:v});t("_C3D_Default Cmd Init","_C3D_beforeDefaultCmdLoad",true);k(I)});G("_C3D_ownCommands");I.loadActionBar({merge:true,file:q.file,module:q.module})}function x(I){t("_C3D_PAD3DViewer creation","_C3D_PAD3DViewerReady",true);I.unsubscribe(o);o=null;k(I)}var s=function(J){s=function(){};var M,K,N=[],P=[],L=require("DS/PADUtils/PADSettingsMgt"),O=require("DS/PADUtils/PADCommandProxy"),I=["DS/CAT3DComposeUtils/CAT3DComposeUnits","i18n!DS/CAT3DComposeWidget/assets/nls/CAT3DComposeWidget","DS/PADUtils/PADSharedSettings","i18n!DS/PADUtils/assets/nls/PADUtils"];if(j!=="DEC"){I.push("DS/CfgAuthoringContextUX/scripts/CfgAuthoringContext")}require(I,function(W,R,Q,T,U){K=U;function V(){N.forEach(function(X){var Z=X.preference.name;var aa=z.getValue(Z),Y=L.getSetting(Z);aa=X.preference.type==="boolean"&&(typeof aa!=="boolean")?"true"===aa:aa;if(aa!==Y){L.setSetting(Z,aa)}if(X.fct){X.fct(aa)}});L.updateWidgetPreferences();if(!M&&N.length){M=O.create({events:{onPreferenceModification:function(X){N.some(function(Y){if(X.name===Y.preference.name){if(typeof X.value!=="boolean"&&typeof X.value!=="string"){throw new Error("Value must be a string or a boolean")}if(L.getSetting(X.name)!==X.value){if(Y.preference.type==="boolean"&&typeof X.value!=="boolean"){throw new Error("Preference is a boolean type so value must be a boolean")}Y.debounce=true;z.setValue(X.name,Y.preference.type==="boolean"?(X.value?"true":"false"):X.value);L.setSetting(X.name,X.value)}if(Y.fct){Y.fct(X.value)}return true}return false})}}});N.forEach(function(X){if(X.cb){L.addEvent(X.cb,function(Y){if(!X.debounce){M.preferenceModification({name:X.preference.name,value:Y})}else{X.debounce=false}})}})}}function S(){var aa=Q.listAvailableSharedSettings(),Z=Q.usedSharedSettings,Y=[],X;X=aa.indexOf("useIndexAccleration");if(X!==-1){aa.splice(X,1);if(Z.indexOf("useIndexAccleration")===-1){Y.push("useIndexAccleration")}}Q.addSharedSettings(z,Y);if(b.getOption("debug")){if(!z.hasPreference("populateTags")){N.push({preference:{name:"populateTags",type:"boolean",label:T.activateFilter_label,defaultValue:"false"},fct:function(ab){var ac=J.getBIController();if(ac){ac.toggleBetweenStandaloneAndSlaveMode(ab?"STANDALONE":"SLAVE")}}})}if(!z.hasPreference("webapi_timeout")){N.push({preference:{name:"webapi_timeout",type:"text",label:"Query timeout",defaultValue:"60000"}})}}else{P=["populateTags","webapi_timeout"]}P.forEach(function(ab){z.deleteValue(ab)});P.length=0;N.forEach(function(ab){z.mergePreferences([ab.preference])});aa.forEach(function(ab){if(Z.indexOf(ab)===-1){Y.push(ab)}});Q.addSharedSettings(z,Y);if(!z.hasPreference(W.Types.Length.name)){z.addPreference({name:W.Types.Length.name,type:"list",label:R.UnitsLengthText,defaultValue:W.Types.Length.defaultValue,options:[{label:R.Millimeter,value:W.Length.mm.name},{label:R.Centimeter,value:W.Length.cm.name},{label:R.Meter,value:W.Length.m.name},{label:R.Kilometer,value:W.Length.km.name},{label:R.Inch,value:W.Length.inch.name},{label:R.Foot,value:W.Length.foot.name}]});z.addPreference({name:W.Types.Angle.name,type:"list",label:R.UnitsAngleText,defaultValue:W.Types.Angle.defaultValue,options:[{label:R.Degree,value:W.Angle.deg.name},{label:R.Radian,value:W.Angle.rad.name}]});z.addPreference({name:W.Types.Area.name,type:"list",label:R.UnitsAreaText,defaultValue:W.Types.Area.defaultValue,options:[{label:R.SquareMillimeter,value:W.Area.mm2.name},{label:R.SquareCentimeter,value:W.Area.cm2.name},{label:R.SquareMeter,value:W.Area.m2.name},{label:R.SquareKilometer,value:W.Area.km2.name},{label:R.SquareInch,value:W.Area.inch2.name},{label:R.SquareFoot,value:W.Area.foot2.name}]});z.addPreference({name:W.Types.Volume.name,type:"list",label:R.UnitsVolumeText,defaultValue:W.Types.Volume.defaultValue,options:[{label:R.CubicMillimeter,value:W.Volume.mm3.name},{label:R.CubicCentimeter,value:W.Volume.cm3.name},{label:R.CubicMeter,value:W.Volume.m3.name},{label:R.CubicKilometer,value:W.Volume.km3.name},{label:R.CubicInch,value:W.Volume.inch3.name},{label:R.CubicFoot,value:W.Volume.foot3.name}]})}if(N.length||Y.length){V();z.addEvent("endEdit",V)}}if(K&&!z.hasPreference("changeControlActivation")){K.initialize2(J.getFrameWindow().getViewerFrame(),O.appId(),"hide","top-right",function(X){K=null;if(X&&X.isLicenseValid===true){K=U;N.push({preference:{name:"changeControlActivation",type:"boolean",label:T.changeControlActivation_label,defaultValue:"true"},fct:function(Y){K[Y?"show":"hide"]()},cb:"onChangeControlActivation",debounce:false});N.push({preference:{name:"changeControlPosition",type:"list",label:T.changeControlPosition_label,defaultValue:"top-right",options:[{label:T["top-right_label"],value:"top-right"},{label:T["top-left_label"],value:"top-left"},{label:T["bottom-left_label"],value:"bottom-left"},{label:T["bottom-right_label"],value:"bottom-right"}]},fct:function(Y){K.setPosition(Y)}});L.setSetting("authorizeChangeControl",true)}else{P.push("changeControlActivation");P.push("changeControlPosition")}S()})}else{S()}})};function e(){if(!B){t("_C3D_UWA widget loading","_C3D_widgetLoad",true);G("_C3D_LoadJSPAD3DViewer");require(["DS/ENOPAD3DViewer/PAD3DViewer","DS/ENOPAD3DViewer/utils/PAD3DViewerRestoreSession","text!DS/CAT3DComposeWidget/assets/json/CATC3DWindowOptions.json"],function(I,L,J){t("_C3D_PAD3DViewer load JS","_C3D_LoadJSPAD3DViewer",true);G("_C3D_PAD3DViewerReady");var M=JSON.parse(J);M.context="Default";B=new I({widget:z,windowOptions:M,actionbar_corrected:true});var K=require("DS/PADUtils/PADSettingsMgt");K.setSetting("appModelerType",j);if(j!=="DEC"){K.setSetting("settypes",true)}B.setAuthorizedRootTypes(K.getSetting(j==="DEC"?"dec_authorized_root_types":"ups_authorized_root_types"));B.setDefaultContextualBarVisibility(false);B.setDefaultContextualMenuVisibility(true);D=B.subscribe({event:"onViewerReady"},h);F=B.subscribe({event:"onActionBarReady"},u);o=B.subscribe({event:"onReady"},x);L.init({widget:z,pad3DViewer:B});B.subscribe({event:"onRootAdded"},A);B.subscribe({event:"onRootRemoved"},A);B.subscribe({event:"onRootAttached"},A);B.subscribe({event:"onRootDetached"},A);B.subscribe({event:"onContentNameModified"},A);s(B)})}}function r(){if(B){B.refresh()}}function f(){if(y){y.unreferenceDropManager({context:B})}if(d){d.unreferenceMoveManager({context:B})}if(m){var I=m.giveComposeRobot({context:B});if(I){I.unreference()}}c=z=B=v=g=H=null;j=d=E=y=m=q=null}function C(){var I=B;f();if(I){I.destroy()}}function l(I){if(B){B.search({searchQuery:I})}}if(!B){t("_C3D_JS dependencies loading","C3D_jsAppLoad",false);G("_C3D_widgetLoad");if(i.viewerAttachment){g=i.viewerAttachment;e()}else{g=function(I){z.setBody(I.pad3DViewer.render())};z.addEvent("onLoad",e)}z.addEvent("onRefresh",r);z.addEvent("onDestroy",C);z.addEvent("onSearch",l);z.setMetas({helpPath:"CAT3DComposeWidget/assets/help"})}else{s(B);z.addEvent("onDestroy",f)}return(c=Object.freeze({setUp:function(M){if(!E){require(["DS/ApplicationFrame/CommandsManager"],function(N){E=N;c.setUp(M)});return}var L={lastCommand:[],currentCommand:null,defaultCommand:null};if(v){E._commandsState[v]=L}else{E._commandsState=L}E.resetDefaultCommand(v);E._isCommandEnding=false;E._ignoreCommandBeginWhileEndingCommand=false;["_commands","_cmdCheckHeader"].forEach(function(O){var N=v?E[O][v]:E[O];Object.keys(N).forEach(function(P){var Q=N[P];if(Q&&Q._destroy){Q._destroy()}delete N[P]})});if(M.sourceApp&&M.sourceApp.pad3DViewer!==B){if(y){y.unreferenceDropManager({context:B})}y=null;if(d){d.unreferenceMoveManager({context:B})}d=null;if(m){var I=m.giveComposeRobot({context:B});if(I){I.unreference()}}m=null;B=M.sourceApp.pad3DViewer}z.setMetas({helpPath:"CAT3DComposeWidget/assets/help"});var K=0;var J=B.subscribe({event:"onActionBarReady"},function(){K++;if(K===1){B.loadActionBar({merge:true,file:q.file,module:q.module})}else{B.unsubscribe(J);E.setDefaultCommand({ID:"CAT3DComposeWidgetDefaultHdr",className:"DS/CAT3DComposeCommands/CAT3DComposeWidgetDefaultCmd",context:v});B.getFrameWindow().getContextualUIManager().activateContextualBarOnLeftClicAfterCSOChange();B.setDefaultContextualBarVisibility(false);B.setDefaultContextualMenuVisibility(true);require(["DS/CAT3DComposeRobot/CAT3DComposeRobot","DS/CAT3DComposeMoveManager/CAT3DComposeMoveManager","DS/CAT3DComposeUtils/CATC3DDropManager"],function(P,Q,N){var O;m=P;m.getComposeRobot({context:B});d=Q;O=d.getMoveManager({context:B});O.setMode({useOverride:false});y=N;y.getDropManager({context:B}).connect();p(E,y,m);M.done()})}});B.loadActionBar({merge:false,file:"ENOPAD3DViewer.xml",module:"ENOPAD3DViewer"})},dispose:function(){if(H&&H.controller){H.activated=false;H.controller.end();H=null}if(m){var I=m.giveComposeRobot({context:B});if(I){I.unreference()}}if(d){d.unreferenceMoveManager({context:B})}if(B){B.setDefaultContextualBarVisibility(true);B.setDefaultContextualMenuVisibility(true)}if(y){y.getDropManager({context:B}).disconnect()}}}))}return Object.freeze({getApp:a})});define("DS/CATC3DNavigation/CATC3DNavigationDefaultCmd",["DS/ApplicationFrame/Command","DS/CATRelatedDataLauncher/CATRelatedDataController","DS/PADUtils/PADContext","DS/CATC3DNavigation/CATC3DNavigationContoller","DS/ApplicationFrame/CommandsManager"],function(d,f,e,b,a){var c=d.extend({init:function(j){this._parent(j,{mode:"exclusive",isAsynchronous:true});this.setRepeatMode(false);var i=e.get(),h=i.getCommandContext?i.getCommandContext():null;var g=b.getNavigationContoller({context:i});var k=f.giveDataLauncherController({context:i});this.beginExecute=function(){k.setActiveState(true);a.getCommand("CAT3DComposeExamineSelectionHdr",h).activate();if(g){g.resume()}};this.endExecute=function(){k.setActiveState(false);var l=a.getCommand("CAT3DComposeExamineSelectionHdr",h);if(l){l.deactivate()}if(g){g.pause()}};this.pauseExecute=function(){k.setActiveState(false);var l=a.getCommand("CAT3DComposeExamineSelectionHdr",h);if(l){l.deactivate()}if(g){g.pause()}};this.resumeExecute=function(){k.setActiveState(true);var l=a.getCommand("CAT3DComposeExamineSelectionHdr",h);if(l){l.activate()}if(g){g.resume()}}}});return c});define("DS/CAT3DComposeCommands/CATC3DPasteAtOriginalPositionCmd",["DS/ApplicationFrame/CommandCheckHeader","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/PADUtils/PADContext","DS/Visualization/ThreeJS_DS","DS/CAT3DComposeMoveManager/CAT3DComposeMoveManager","DS/ApplicationFrame/CommandsManager"],function(i,d,c,f,h,b,a){var e=new h.Matrix4();var g=i.extend({init:function(r){this._parent(r);var n=this,q,o=false,p=[],k=f.get().getFrameWindow().getContextualUIManager(),m=b.getMoveManager({context:f.get()}),j=function(){q=[];k.hideContextualMenus();d.get().forEach(function(t){var u=m.getSubPathToMovable(t.pathElement);var s=u.getLastElement(true).getMatrix();if(!s.equals(e)){q.push({pathElement:t.pathElement,path:u,matrix:s})}});if(q.length>0){k.showContextualBar({x:f.get().getViewer().SCREEN_WIDTH/2,y:f.get().getViewer().SCREEN_HEIGHT/2,hideWithDistance:false,fillingList:[{onContextualBarReady:function(){return{cmdList:[{name:"CATC3DPasteAtOriginalPositionStr",line:1,hdr_list:["CATC3DPasteAtOriginalPositionHdr"]},{name:"CATC3DPasteAtLocalCoordinatesStr",line:1,hdr_list:["CATC3DPasteAtLocalCoordinatesHdr"]}]}},context:f.get().getCommandContext?f.get().getCommandContext():null,workbenchName:"CAT3DComposeWidgetWkb",module:"CAT3DComposeWidget",cmdPrefix:""}]});o=true;n.setState(true)}},l=f.get().subscribe({event:"onAuthoringTransactionEnd"},j);require(["DS/CAT3DComposeUtils/CATC3DDropManager"],function(t){var s=t.getDropManager({context:f.get()});p.push(s.subscribe({event:"onBeginInsertDrop3D"},function(){f.get().unsubscribe(l)}));p.push(s.subscribe({event:"onEndInsertDrop3D"},function(u){if(u&&u.type==="inPosition"){j()}l=f.get().subscribe({event:"onAuthoringTransactionEnd"},j)}))});this.onStateChange(function(){if(n.getState()){if(!o){if(q.length>0){m.onMoveBegin({objectsMoved:q,from:n,moveMode:"Persistent"});q.forEach(function(u){var t=u.path.getLastElement(true).getMatrix();if(!t.equals(u.matrix)&&d.isIn(u)){m.onMove({objectsMoved:[u],from:n,leafMatrix:u.matrix})}});m.onMoveEnd({from:n,status:"Moved"});f.get().getViewer().render()}}else{o=false}var s=f.get();a.getCommandCheckHeader("CATC3DPasteAtLocalCoordinatesHdr",s.getCommandContext?s.getCommandContext():null).setState(false)}});this.toggleState=function(){if(!this.getState()){n.setState(true)}};this._destroy=function(){f.get().unsubscribe(l);require(["DS/CAT3DComposeUtils/CATC3DDropManager"],function(t){var s=t.getDropManager({context:f.get()});if(s){p.forEach(function(u){s.unsubscribe(u)})}p=[]});if(Object.getPrototypeOf(this)._destroy){Object.getPrototypeOf(this)._destroy.apply(this,arguments)}m=q=o=l=k=j=n=undefined}}});return g});define("DS/CAT3DComposeCommands/CAT3DComposeLevelSelectorCmd",["DS/ApplicationFrame/Command","DS/LevelSelector/LevelSelector","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/PADUtils/PADContext","DS/VisuEvents/EventsManager","DS/VisuEvents/ScreenEvent","DS/CAT3DComposeMoveManager/CATC3DMoveReferent","DS/CAT3DComposeCommands/CATC3DCommandsUtils"],function(a,f,d,c,h,b,g,e,j){var i=a.extend({init:function(t){this._parent(t,{mode:"shared",isAsynchronous:true});this.setRepeatMode(false);var m=this;var k=h.get();var s;var o;var n;var l;var p;var r=function(u){p=null;if(u&&u.from&&u.from.length===1&&u.from[0].event&&u.from[0].event.type==="touchend"&&u.from[0].event.changedTouches.length===1){p=u.from[0]}};b.addEvent(document,"onRelease",r);this.execute=function(){l=d.onChange(function(){m.end()});var w=s;if(!w){var B=d.get();s=B.length>0?B[B.length-1]:undefined;w=s;o=s?s.pathElement:undefined}if(w&&w.pathElement){k.getFrameWindow().getContextualUIManager().hideContextualMenus();var u={x:0,y:0};if(p){var A=p.event.changedTouches[0];u.x=A.clientX;u.y=A.clientY}else{var v=b.getMouseEvents(g.MouseButton.NONE);if(v&&v.length){u.x=v[0].event.clientX;u.y=v[0].event.clientY}}p=null;var y=o;if(!m.setRobotParams){y=e.getMoveReferentManager({context:k}).getMoveReferent(o);var x=y.getLastElement(true);if(x&&j.isPLMInstanceNode(x)&&x.children.length){y.addElement(x.children[0])}}var z={display:{type:"position",x:u.x,y:u.y},uiFrame:k.getFrameWindow().getUIFrame(),getLevels:function(C){var G=j.getLevelSelectorLevels({pathElement:w.pathElement,pathElementCurrent:y,onInfoCompleted:C,context:k});if(G&&!m.setRobotParams){G.selectColor="#ff821e";G.selectOverColor="#ffb477";for(var D=G.levels.length-1;D>=0;--D){var F=G.levels[D];var E=F.pathElement.getLastElement(true);if(!j.isPLMReferenceNode(E)){F.selection="notCurrent";continue}F.selection="notCurrent";if(G.currentLevel>=D){delete G.currentLevel}break}}return G},onHover:function(C){c.empty();c.add(C)},onLeave:function(C){if(s){c.remove(C);c.add(s)}},onSelect:function(E){l=d.unsubscribe(l);if(E&&E.pathElement&&E.pathElement.internalPath.length===0){if(!m.setRobotParams){e.getMoveReferentManager({context:k}).addMoveReferent(E.pathElement)}s.pathElement=E.pathElement;c.empty();d.empty();var D=s,C=n;setTimeout(function(){c.add(D);d.add(D);if(C){C(E)}k.getFrameWindow().getContextualUIManager().showContextualBar({hideWithDistance:true})},0)}m.end()}};f.createView(z)}else{m.end()}};this.endExecute=function(){l=d.unsubscribe(l);n=undefined;s=undefined;o=undefined;f.destroyView()};this.pauseExecute=function(){m.endExecute()};this.resumeExecute=function(){m.execute()};if(t.ID==="CAT3DComposeRobotLevelSelectorHdr"){this.setRobotParams=function(u){n=u.selectCB;s={pathElement:u.pathContext.clone()};o=u.pathCurrent.clone()}}var q=this._destroy;this._destroy=function(){if(!m){return}b.removeEvent(document,"onRelease",r);q.call(m);m=k=null}}});return i});define("DS/CAT3DComposeBoxes/CAT3DComposeBoxManipulator",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/CoreEvents/ModelEvents","DS/Mesh/MeshUtils","DS/Visualization/SceneGraphFactory","DS/Manipulators/Manipulator","DS/CAT3DComposeUtils/CAT3DComposeAnimation","DS/SceneGraphOverrides/SceneGraphOverrideSet"],function(a,k,g,c,d,j,b,i,f){var h=0.001;var l=b.extend({init:function(n){var m=n||{};this._parent(m);this._manipulation=0;this.setExclusive(true)},PrimaryPointerClick:function(n,m,p){this._parent(n,m,p);var o={element:n,event:m,intersection:p};this.publish("BoxClick",o)},BeginManipulate:function(n,m,o){this._parent(n,m,o);this._manipulation=0},Manipulate:function(n,m,p){this._parent(n,m,p);this._manipulation++;if(this._manipulation===3){var o={element:n,event:m,intersection:p};this.publish("BoxBeginManipulate",o)}},EndManipulate:function(n,m,p){this._parent(n,m,p);if(this._manipulation>3){var o={element:n,event:m,intersection:p};this.publish("BoxEndManipulate",o)}},BeginPreactivate:function(n,m,p){this._parent(n,m,p);var o={element:n,event:m,intersection:p};this.publish("BoxBeginPreactivate",o)},EndPreactivate:function(n,m,p){this._parent(n,m,p);var o={element:n,event:m,intersection:p};this.publish("BoxEndPreactivate",o)}});var e=a.extend({init:function(af){var E=af||{};this._parent(E);var M=E.fstAxis,u=M.length();var D=E.sndAxis,C=D.length();var v=E.thdAxis,y=v.length();var r=E.cornerPoint;var ai=E.pathElement;var V=E.matrix||new k.Matrix4();var X=E.rootBagPath;var aa=E.viewer;var N=new g();N.name="boxManipulatorNode";N.setNoZ(true);N.setVisibilityInTree(false);N.setVisibility(Boolean(aa.getVisibleSpace()));N.side=k.DoubleSide;N.exludeFromBounding(true);N._getExcludeFromCSO=function(){return true};var ag=new g();ag.name="lineicPreviewRepsBag";ag.setPickable(d.NODRAWHL);var S=new g();S.name="boxPreviewNodeBag";S.setPickable(d.NODRAWHL);var W=null;var ah=new c();var B=false;var K=16744448;var ab=new k.MeshBasicMaterial({side:k.DoubleSide,color:16744448,transparent:true});var n=E.edgeMaterial;var Z=false;var Y=null;var R=null;var aj=null;var F=new d.VertexComponent();F.component=d.VertexComponentEnum.POSITION;F.nbVertices=2;F.nbValuesPerVertex=3;F.format=d.DataTypeEnum.FLOAT;F.cardinality=0;F.bufferId=0;F.indices=new d.IndexArray();F.indices.format=d.DataTypeEnum.UINT;F.indices.bufferId=1;F.indices.offset=0;var ad=new d.Buffer();ad.indexBuffer=true;ad.size=2;ad.format=d.DataTypeEnum.UINT;ad.dimension=1;ad.data=new Uint16Array(2);ad.data[0]=0;ad.data[1]=1;var p=new d.FillAttributes();var H=new d.LineAttributes();var P=new d.PointAttributes();var x=null;var t=null;var L=null;var m=null;var G=null;var s=function(al,am){if(al){if(al.material){if(al.material.map&&am){al.material.map.dispose()}al.material.dispose()}for(var ak=al.children.length-1;ak>=0;ak--){s(al.children[ak])}al.removeChildren()}};var ae=function(al){if(!Y&&X){Y=new f(X.externalPath[0]);aa.getSceneGraphOverrideSetManager().pushSceneGraphOverrideSet(Y);var ak=Y.createOverride(ai);ak.setColor(K,true);if(al){ak.setOpacity(1,true);ak=Y.createOverride(X);ak.setColor("white",false);ak.setOpacity(0.1,false)}}};var o=function(){if(Y){aa.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(Y);Y=null}};var ac=function(at,ao){var ap=new d.PrimitiveGroup();ap.fillAttr=p;ap.lineAttr=H;ap.pointAttr=P;ap.noz=false;var an=new d.Buffer();an.size=6;an.component=d.VertexComponentEnum.POSITION;an.format=d.DataTypeEnum.FLOAT;an.dimension=3;an.data=new Float32Array(6);ap.addBuffer(0,an);ap.addBuffer(1,ad);var al=an.data;var am=0;al[am++]=at.x;al[am++]=at.y;al[am++]=at.z;var ar=new k.Vector3().copy(at).add(ao);al[am++]=ar.x;al[am++]=ar.y;al[am++]=ar.z;var ak=new d.Primitive();ak.nbIndices=2;ak.connectivity=d.ConnectivityTypeEnum.LINE_STRIP;ak.attr={fill:p,line:H,point:P};ak.material=n;ak.addVertexComponent(F);ap.addPrimitive(ak);var aq=j.createMeshNode(ap);aq.setSSAO(false);aq.setShadow(false,false);aq.excludeFromCSO(true);aq.excludeFromHighlight(true,true);return aq};var Q=function(av,at,au,ak){var ap=new d.PrimitiveGroup();ap.noz=false;ap.fillAttr=p;ap.lineAttr=H;ap.pointAttr=P;var an=new d.Buffer();an.size=12;an.component=d.VertexComponentEnum.POSITION;an.format=d.DataTypeEnum.FLOAT;an.dimension=3;an.data=new Float32Array(12);if(!L){L=new d.Buffer();L.indexBuffer=true;L.size=4;L.format=d.DataTypeEnum.UINT;L.dimension=1;L.data=new Uint16Array(4);L.data[0]=0;L.data[1]=1;L.data[2]=3;L.data[3]=2}if(!m){m=new d.Buffer();m.size=3;m.component=d.VertexComponentEnum.NORMAL;m.format=d.DataTypeEnum.FLOAT;m.dimension=3;m.data=new Float32Array(3);m.data[0]=0;m.data[1]=0;m.data[2]=1}if(!G){G=new d.Buffer();G.indexBuffer=true;G.size=4;G.format=d.DataTypeEnum.UINT;G.dimension=1;G.data=new Uint16Array(4);G.data[0]=0;G.data[1]=0;G.data[2]=0;G.data[3]=0}ap.addBuffer(0,an);ap.addBuffer(1,L);ap.addBuffer(2,m);ap.addBuffer(3,G);var al=an.data;var am=0;al[am++]=av.x;al[am++]=av.y;al[am++]=av.z;var ar=new k.Vector3().copy(av).add(at);al[am++]=ar.x;al[am++]=ar.y;al[am++]=ar.z;ar=new k.Vector3().copy(av).add(at).add(au);al[am++]=ar.x;al[am++]=ar.y;al[am++]=ar.z;ar=new k.Vector3().copy(av).add(au);al[am++]=ar.x;al[am++]=ar.y;al[am++]=ar.z;var ao=new d.Primitive();ao.nbIndices=4;ao.connectivity=d.ConnectivityTypeEnum.TRIANGLE_STRIP;ab.opacity=ak/10;ab.needsUpdate=true;ao.material=ab;if(!x){x=new d.VertexComponent();x.component=d.VertexComponentEnum.POSITION;x.nbVertices=4;x.nbValuesPerVertex=3;x.format=d.DataTypeEnum.FLOAT;x.cardinality=0;x.bufferId=0;x.indices=new d.IndexArray();x.indices.format=d.DataTypeEnum.UINT;x.indices.bufferId=1;x.indices.offset=0}if(!t){t=new d.VertexComponent();t.component=d.VertexComponentEnum.NORMAL;t.nbVertices=4;t.nbValuesPerVertex=3;t.format=d.DataTypeEnum.FLOAT;t.cardinality=0;t.bufferId=2;t.indices=new d.IndexArray();t.indices.format=d.DataTypeEnum.UINT;t.indices.bufferId=3;t.indices.offset=0}ao.addVertexComponent(x);ao.addVertexComponent(t);ap.addPrimitive(ao);var aq=j.createMeshNode(ap);aq.setSSAO(false);aq.setShadow(false,false);aq.excludeFromCSO(true);aq.excludeFromHighlight(true,true);return aq};var J=function(at,ap){for(var aq=0;aq<6;aq++){var av,al,aw,ar,an,au,am;switch(aq){case 0:av=r;al=D;aw=M;ar=C;an=u;break;case 1:av=r;al=v;aw=D;ar=y;an=C;break;case 2:av=r;al=M;aw=v;ar=u;an=y;break;case 3:av=new k.Vector3().copy(r).add(M);al=D;aw=v;ar=C;an=y;break;case 4:av=new k.Vector3().copy(r).add(D);al=v;aw=M;ar=y;an=u;break;default:av=new k.Vector3().copy(r).add(v);al=M;aw=D;ar=u;an=C;break}if(ar>=h&&an>=h){if(ap!==1){var ao=0.5*ap;am=new k.Vector3().copy(av);var ak=new k.Vector3().copy(al).setLength(ar*ao);au=ac(am,ak);at.addChild(au);am=new k.Vector3().copy(av).add(al);ak=new k.Vector3().copy(aw).setLength(an*ao);au=ac(am,ak);at.addChild(au);am=new k.Vector3().copy(av).add(al).add(aw);ak=new k.Vector3().copy(al).setLength(ar*ao).multiplyScalar(-1);au=ac(am,ak);at.addChild(au);am=new k.Vector3().copy(av).add(aw);ak=new k.Vector3().copy(aw).setLength(an*ao).multiplyScalar(-1);au=ac(am,ak);at.addChild(au)}else{au=ac(av,al);at.addChild(au);am=new k.Vector3().copy(av).add(al);au=ac(am,aw);at.addChild(au)}}}};var T=function(an,ap){if(an){for(var ao=0;ao<6;ao++){var am=null,ak=null,al=null;switch(ao){case 0:am=r;ak=D;al=M;break;case 1:am=r;ak=v;al=D;break;case 2:am=r;ak=M;al=v;break;case 3:am=new k.Vector3().copy(r).add(M);ak=D;al=v;break;case 4:am=new k.Vector3().copy(r).add(D);ak=v;al=M;break;default:am=new k.Vector3().copy(r).add(v);ak=M;al=D;break}an.addChild(Q(am,ak,al,ap))}}};var I=function(am){ab.opacity=Math.round(am/12)/100;ab.needsUpdate=true;var ak=am/(100/(ag.children.length-1));for(var al=0;al<ag.children.length;al++){if(al===ak){ag.children[al].setVisibility(Boolean(aa.getVisibleSpace()));ag.children[al].setVisibilityFree(false)}else{ag.children[al].setVisibility(false);ag.children[al].setVisibilityFree(true)}}aa.render()};var A=function(){var al=0.5;var am=null;for(var ak=0;ak<6;ak++){am=new g();am.setVisibility(false);am.setVisibilityFree(true);J(am,al);ag.addChild(am);al=Math.round(al*10+1)/10}N.addChild(ag);T(S,K,0);N.addChild(S)};var w=function(al){var ak={pathElement:ai,position:al.event.from[0].currentPosition};ah.publish({event:"onBoxClick",data:ak})};var O=function(){Z=true;B=false;ae(true);R.animate(1);aa.currentViewpoint.getControl()._changeState(3);aj={};aj.eyePosition=aa.currentViewpoint.getEyePosition();aj.upDirection=aa.currentViewpoint.getUpDirection();aj.sightDirection=aa.currentViewpoint.getSightDirection();aj.distanceToTarget=aa.currentViewpoint.getTargetDistance();ah.publish({event:"onBoxBeginManipulate",data:{pathElement:ai}})};var z=function(){o();aa.setCursor("auto");Z=false;R.animate(0);aa.currentViewpoint.moveTo({eyePosition:aj.eyePosition,upDirection:aj.upDirection,sightDirection:aj.sightDirection,distanceToTarget:aj.distanceToTarget,duration:100});aj=null;ah.publish({event:"onBoxEndManipulate",data:{pathElement:ai}})};var U=function(){if(!Z){aa.setCursor("pointer");B=true;ae(false);R.animate(1)}};var q=function(){if(!Z){aa.setCursor("auto");B=false;o();R.animate(0)}};this.show=function(){J(N,0.5);aa.addNode(N,false);R=new i({animationTime:5,nbSteps:5,onBeforeFirstAnimation:A,onAnimation:I,onAnimationEnd:function(){if(Z||B){I(100)}else{I(0)}}});if(!W){W=new l();W.subscribe("BoxClick",w);W.subscribe("BoxBeginManipulate",O);W.subscribe("BoxEndManipulate",z);W.subscribe("BoxBeginPreactivate",U);W.subscribe("BoxEndPreactivate",q);W.linkToNode(N)}N.setMatrix(V);aa.render()};this.hide=function(){o();N.setVisibility(false);N.setVisibilityFree(true);W=null;s(N,true);aa.removeNode(N)};this.setMatrix=function(ak){V.copy(ak);N.setMatrix(V)};this.setVisibleFlag=function(ak){if(!ak&&Z){return}if(!ak){N.setVisibility(false);N.setVisibilityFree(true)}else{N.setVisibility(Boolean(aa.getVisibleSpace()));N.setVisibilityFree(false)}};this.getVisibleFlag=function(){if(!N){return false}return !N.visibilityFree};this.getAssociatedPath=function(){return ai};this.subscribe=function(ak,al){return(ak==="onBoxClick"||ak==="onBoxBeginManipulate"||ak==="onBoxEndManipulate")?ah.subscribe({event:ak},al):undefined};this.unsubscribe=function(ak){ah.unsubscribe(ak)}}});return e});define("DS/CAT3DComposeUtils/CAT3DCompose3DAnimation",["UWA/Core","UWA/Class","DS/Animation/PropertyAnimation","DS/Animation/ANIM","DS/Mesh/MeshUtils","DS/Visualization/ThreeJS_DS","DS/CAT3DComposeWidget/CAT3DComposeWidgetOptions","DS/SceneGraphOverrides/SceneGraphOverrideSet"],function(m,n,h,f,d,l,g,i){var e=function(o){if(o==="opacityOn"||o==="opacityOff"||o==="showAxis"||o==="hideAxis"){return 100}if(o==="cancel"||o==="unsnap"){return 200}if(o==="snap"){return 400}if(o==="move"||o==="rotate"){return 100}return null};var j=(function(){var t=new l.Quaternion(),u=new l.Quaternion();var q=new l.Vector3(),p=new l.Vector3(),r=new l.Vector3(),s=new l.Vector3();return function o(x){if(!x.matrixSource||!x.matrixTarget){return null}x.matrixSource.decompose(q,t,r);x.matrixTarget.decompose(p,u,s);var y=t.slerp(u,x.factor);var v=q.lerp(p,x.factor);var w=r.lerp(s,x.factor);return new l.Matrix4().compose(v,y,w)}}());var k=(function(){var p=new l.Vector3(),q=new l.Vector3(1,1,1);return function o(u){if(!u.obj.quaternionSource||!u.obj.quaternionTarget||!u.obj.centerRotation||!u.obj.matrixSource){return null}u.obj.quaternionSource=u.obj.quaternionSource.slerp(u.obj.quaternionTarget,u.factor);var t=new l.Matrix4().compose(p,u.obj.quaternionSource,q);var s=new l.Matrix4().setPosition(u.obj.centerRotation);var r=t.multiply(new l.Matrix4().getInverse(s).multiply(u.obj.matrixSource));return s.multiply(r)}}());var b=n.extend({init:function(p){var r={},u={},q=[],t=g.getOption("animationOff"),o=p.viewer,s=o.getSceneGraphOverrideSetManager();r.opacityOn=function(w){if(w.progress<0){return}var v=0.7;if(w.progress>=30){v=(w.progress-100)*(w.util.opacityOnEnd-0.7)/70+w.util.opacityOnEnd}if(v<0){v=0}w.util.objectListToAnimate.forEach(function(x){if(x.override){x.override.setOpacity(v,true)}});o.render()};r.opacityOff=function(w){if(w.progress<0){return}var v=0.3+0.7*(w.progress/100);if(w.progress===100||v>1){v=1}w.util.objectListToAnimate.forEach(function(x){if(x.override){x.override.setOpacity(v,true)}});o.render()};r.opacityOnOff=function(w){if(w.progress<0){return}var v=0.7;if(w.progress<=50){v=-0.014*w.progress+1}else{v=0.014*w.progress+1-1.4}if(w.progress===100||v>1){v=1}else{if(v<0){v=0}}w.util.objectListToAnimate.forEach(function(x){if(x.override){x.override.setOpacity(v,true)}});o.render()};r.snap=function(v){if(v.progress<0){return}v.util.objectListToAnimate.forEach(function(B){if(B.override){var y=null;var A=B.override.getPosition();if(A){y=new l.Matrix4().copy(A)}else{var x=new l.Matrix4().copy(B.initWorldMatrix);var w=new l.Matrix4().getInverse(B.path.getParentPath().getWorldMatrix());y=w.multiply(x)}var z=B.snappedPosition;B.override.setPosition(j({matrixSource:y,matrixTarget:z,factor:v.progress/100}))}});o.render()};r.unsnap=function(v){if(v.progress<0){return}v.util.objectListToAnimate.forEach(function(z){if(z.override){var x=null;if(z.currentPosition){x=new l.Matrix4().copy(z.currentPosition)}else{var y=z.override.getPosition();x=new l.Matrix4().copy(y)}var w=z.snappedPosition;z.override.setPosition(j({matrixSource:w,matrixTarget:x,factor:v.progress/100}))}});o.render()};r.cancel=function(v){if(v.progress<0){return}if(v.progress===100){v.util.objectListToAnimate.forEach(function(w){if(w.override){w.override.setPosition(null)}})}else{v.util.objectListToAnimate.forEach(function(w){w.lastMatrix=j({matrixSource:w.currentMatrix,matrixTarget:w.initMatrix,factor:v.progress/100});if(w.override){w.override.setPosition(w.lastMatrix)}})}o.render()};r.move=function(w){if(w.progress<0){return}if(!w.util.iterationData){w.util.iterationData=[];w.util.objectListToAnimate.forEach(function(x){w.util.iterationData.push({matrixSource:new l.Matrix4().copy(x.matrixSource),matrixTarget:x.matrixTarget,override:x.override})})}if(w.progress!==0){var v=w.progress/100;w.util.iterationData.forEach(function(y){if(y.override){var x=j({matrixSource:y.matrixSource,matrixTarget:y.matrixTarget,factor:v});y.override.setPosition(x);y.matrixSource=x}});o.render()}};r.rotate=function(w){if(w.progress<0){return}if(!w.util.iterationData){w.util.iterationData=[];var y=new l.Vector3(),x=new l.Vector3();w.util.objectListToAnimate.forEach(function(A){var C=new l.Quaternion();A.matrixRotation.decompose(y,C,x);var B=A.matrixParent?new l.Vector3().copy(A.centerRotation).applyMatrix4(A.matrixParent):A.centerRotation;var z=A.matrixParent?new l.Matrix4().multiplyMatrices(A.matrixParent,A.matrixSource):A.matrixSource;w.util.iterationData.push({quaternionSource:new l.Quaternion(),quaternionTarget:C,centerRotation:B,matrixSource:z,matrixParentInv:A.matrixParentInv,override:A.override})})}if(w.progress!==0){var v=w.progress/100;w.util.iterationData.forEach(function(A){if(A.override){var z=k({obj:A,factor:v});A.override.setPosition(A.matrixParentInv?new l.Matrix4().multiplyMatrices(A.matrixParentInv,z):z)}});o.render()}};r.color=function(v){if(v.progress<0){return}v.util.objectListToAnimate.forEach(function(w){if(w.override){w.override.setColor(v.util.color,true)}});o.render()};u.visibility=(function(){function w(y,x,z){y.setVisibility(x);y.setPickable(z?d.PICKABLE:d.NODRAWHL);y.getChildren().forEach(function(A){w(A,x,z)})}return function v(y){var x=y.progress/100;if(!y.util.visibility){x=1-x}y.util.objectListToAnimate.forEach(function(z){if(z.node||z.children){(z.node||z).children.forEach(function(A){if(A.setRatio){A.setRatio(x)}else{A.children.forEach(function(B){if(B.setRatio){B.setRatio(x)}})}})}});if(t||(y.progress===100&&y.util.visibility)||(y.progress===0&&!y.util.visibility)){y.util.objectListToAnimate.forEach(function(z){if(z.override){z.override.setPickability(y.util.pickability?"PICKABLE":null)}})}if(t||(y.progress===0&&y.util.visibility)||(y.progress===100&&!y.util.visibility)){y.util.objectListToAnimate.forEach(function(z){var A;if(z.override){z.override.setVisibilityFree(!y.util.visibility);z.override.setVisibility(y.util.visibility)}else{A=z.parents[0];if(A&&A.name==="AxisSystems"){A.setVisibilityFree(false)}z.setVisibilityFree(!y.util.visibility);w(z,y.util.visibility,y.util.pickability)}if(z.node||z.children){(z.node||z).children.forEach(function(B){if(B.setRatio){B.setRatio(1)}else{B.children.forEach(function(C){if(C.setRatio){C.setRatio(1)}})}})}})}o.render()}}());this.addAnimation=function(y){if(this.isRunning()){return{returnCode:-1}}if(!y||!y.objectListToAnimate||!y.animationType||(!r[y.animationType]&&y.animationType!=="mask"&&y.animationType!=="unmask"&&y.animationType!=="opacityOnOff")){return{returnCode:-1}}var w=y.objectListToAnimate,C=y.callBackFct;if(y.createOverrideSet===true){var z=new i(y.objectListToAnimate[0].path.externalPath[0]);s.pushSceneGraphOverrideSet(z);w=[];if(y.animationType==="mask"||y.animationType==="unmask"||y.animationType==="color"||y.animationType==="opacityOnOff"){var D=[];y.objectListToAnimate.forEach(function(E){if(!E.override&&E.path){D.push(E.path)}});if(D.length){w.push({override:z.createOverride({pathes:D})})}}else{y.objectListToAnimate.forEach(function(F){if(!F.override&&F.path){var E=m.extend({},F);E.override=z.createOverride({pathes:F.path});w.push(E)}})}C=function(){s.removeSceneGraphOverrideSet(z);if(y.callBackFct){y.callBackFct()}o.render()}}if(y.animationType==="mask"){return this.addAnimation({animationType:"opacityOn",duration:typeof y.duration==="number"?y.duration:e(y.animationType),opacityOnEnd:0,objectListToAnimate:w,offsetTime:y.offsetTime,callBackFct:function(){w.forEach(function(E){if(E.override){E.override.setVisibility(false);E.override.setVisibilityFree(true);E.override.setOpacity(null,null)}});if(C){C()}o.render()}})}else{if(y.animationType==="unmask"){w.forEach(function(E){if(E.override){E.override.setOpacity(0);E.override.setVisibility(true);E.override.setVisibilityFree(null)}});return this.addAnimation({animationType:"opacityOff",duration:typeof y.duration==="number"?y.duration:e(y.animationType),objectListToAnimate:w,offsetTime:y.offsetTime,callBackFct:function(){if(C){C()}w.forEach(function(E){if(E.override){E.override.setOpacity(null,null);E.override.setVisibility(null)}});o.render()}})}}var A={objectListToAnimate:w,callback:C};if(y.animationType==="opacityOn"){A.opacityOnEnd=typeof y.opacityOnEnd==="number"?y.opacityOnEnd:0.3}else{if(y.animationType==="color"){A.color=y.color}}var v=t?0:(typeof y.offsetTime==="number"?y.offsetTime:0);var x=t?0:(typeof y.duration==="number"?y.duration:e(y.animationType));if(w.length===0){x=0}var B={duration:function(){return x+v},valueAt:function(E){return{progress:E<v?-1:(x===0?100:((E-v)/x)*100),util:A}}};q.push(new h(r,y.animationType,B,function(E){if(E===f.State.STOPPED){if(C){C()}q.splice(q.indexOf(this),1)}else{if(E===f.State.RUNNING&&B.duration()===0){this.stop()}}}));return{returnCode:0}};this.startAnimation=function(){if(this.isRunning()){return{returnCode:-1}}q.slice().forEach(function(v){v.start()});return{returnCode:0}};this.isRunning=function(){return q.some(function(v){return v.state()===f.State.RUNNING})};this.forward=function(){q.forEach(function(v){v.setTime(v.duration())});this.stop()};this.stop=function(){q.slice().forEach(function(v){v.stop()})};this.axisSystemVisibility=function(w){var y={objectListToAnimate:w.objectListToAnimate,visibility:w.visibility,pickability:w.pickability},x=t?0:(typeof w.duration==="number"?w.duration:e(w.visibility?"showAxis":"hideAxis")),v={duration:function(){return x},valueAt:function(z){return{progress:x===0?100:(z/x)*100,util:y}}};new h(u,"visibility",v,function(z){if(z===f.State.STOPPED){if(w.callBackFct){w.callBackFct()}}else{if(z===f.State.RUNNING&&v.duration()===0){this.stop()}}}).start();return{returnCode:0}};this.getDefaultDuration=function(v){return e(v)}}});var c=[];var a=n.singleton({init:function(){},get3DComposeAnimationEngine:function(p){var q;if(p&&p.viewer){c.some(function(r){if(r.viewer===p.viewer){q=r.engine;return true}return false});if(!q){var o=new b({viewer:p.viewer});c.push({viewer:p.viewer,engine:o});q=o}}return q}});return a});define("DS/CAT3DComposeCommands/CAT3DComposeExamineSelection",["UWA/Core","DS/ApplicationFrame/Command","DS/CoreEvents/ModelEvents","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/VisuEvents/EventsManager","DS/Visualization/ThreeJS_DS","DS/CAT3DComposeUtils/CAT3DCompose3DAnimation","DS/PADUtils/PADContext","DS/ApplicationFrame/CommandsManager","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/PathElement","DS/CAT3DComposeMoveManager/CATC3DMoveReferent","DS/CAT3DComposeMoveManager/CAT3DComposeMoveManager","DS/LevelSelector/LevelSelector","DS/CAT3DComposeCommands/CATC3DCommandsUtils","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","css!DS/CAT3DComposeCommands/CAT3DComposeCommands.css"],function(o,q,j,g,t,s,u,f,k,a,l,p,c,n,e,i,h){var d=Math.PI/4;function w(z){var x,y,B,A=z&&z.externalPath.length>1;for(x=0;A&&x<z.externalPath.length-1;++x){y=z.externalPath[x];B=z.externalPath[x+1];if(y.children.indexOf(B)<0){A=false}}return A}var r=function(){var B,C,x,y,z,A;this.store=function(F,D){B=C=x=y=z=A=undefined;var E=D?new u.Matrix4().extractRotation(D):null;B=F.getEyePosition();if(D){B.applyMatrix4(D)}C=F.getUpDirection();if(E){C.applyMatrix4(E)}x=F.getSightDirection();if(E){x.applyMatrix4(E)}y=F.getTargetDistance();z=F.getProjectionType();A=F.getAngle()};this.restore=function(F,D){if(B){var E=D?new u.Matrix4().extractRotation(D):null;F.moveTo({eyePosition:D?B.applyMatrix4(D):B,upDirection:E?C.applyMatrix4(E):C,sightDirection:E?x.applyMatrix4(E):x,distanceToTarget:y});F.setProjectionType(z);F.setAngle(A)}}};r.prototype={constructor:r};Object.freeze(r);var b,v,m=q.extend({init:function(W){this._parent(W,{mode:"shared",isAsynchronous:true});this.setRepeatMode(false);var B=this,T=k.get(),al=T.getViewer(),M=al.getSceneGraphOverrideSetManager(),D,J=n.getMoveManager({context:T}),A,V,ap,ai,O,ad=[],C,L,ae,af,ah,Z,X,ag=[],aa=[],ao={},F,E,P,ab=c.getMoveReferentManager({context:T}),K,ac,H,G=T.getCommandContext?T.getCommandContext():null;if(require("DS/PADUtils/PADSettingsMgt").getSetting("appModelerType")==="VPM"){require(["DS/CfgAuthoringContextUX/scripts/CfgAuthoringContext"],function(aq){K=aq})}if(!b){require(["DS/CAT3DComposeDirectMove/CAT3DComposeDirectMove"],function(aq){b=aq;if(B.isRunning()){b.activate({context:T})}})}if(!v){require(["DS/CATC3DNavigation/CATC3DNavigationContoller"],function(aq){v=aq})}this.canBeEnabled=function(){var aq=t.get();if(!B||!aq||!Array.isArray(aq)){return false}return aq.length>50?true:aq.some(function(at){if(!at||!at.pathElement||at.pathElement.externalPath.length<2||!h.isAModelPath(at.pathElement)){return false}var au=at.pathElement,ar=M.getCurrentVisibilityFree(au);if(typeof ar!=="boolean"){return false}return(ar!==true||M.getCurrentVisibility(au))&&(!au.getBoundingBox(null,al,"visibleSpace").isNaN()||!au.getBoundingBox(null,al,"invisibleSpace").isNaN())})};function S(){if(B.canBeEnabled()){if(!B.isEnabled()){B.enable()}}else{if(B.isEnabled()&&!B.isRunning()){B.disable()}}}function x(){if(ag.some(function(aq){return typeof M.getCurrentVisibility(aq.path)!=="boolean"})){B.end()}}function aj(at){if(at&&at.from&&at.from.some(function(au){return au.view.id===al.canvas.id})){var ar=at.gesture?at.gesture.getEvents()[0]:at.from[0];if(ar&&ar.event&&ar.event.button===0&&ar.event.buttons===0){var aq=al.pick(al.getMousePosition(ar.getCurrentPosition(al.canvas)),"mesh",false);if(!aq||!aq.path||aq.path.length===0){D=null;B.end()}}}}var am=function(){var ar=T.getFrameWindow().getViewpoint(),at=new u.Matrix4();var aq=ar.getUpDirection(),au=ar.getSightDirection();if(this.className.search("right")>=0){at.makeRotationAxis(aq,d)}else{if(this.className.search("left")>=0){at.makeRotationAxis(aq,-d)}else{if(this.className.search("top")>=0){at.makeRotationAxis(au.cross(aq),-d)}else{at.makeRotationAxis(au.cross(aq),d)}}}ag.forEach(function(av){av.matrixRotation=at});ap.addAnimation({animationType:"rotate",objectListToAnimate:ag.filter(function(av){return av.rotate}),callBackFct:function(){ag.forEach(function(av){av.matrixSource=av.override.getPosition()})}});ap.startAnimation()};var y=function(at,au,aw,ar){var av=[];if(at){var aq=at.getKey();if(aw.indexOf(aq)===-1&&(ar.getCurrentVisibilityFree(at)!==true||ar.getCurrentVisibility(at))){if(au.some(function(ax){return at.isAParentOf(ax)})){at.getChildrenPathes().forEach(function(ax){av=av.concat(y(ax,au,aw,ar))})}else{av.push(at)}}}return av};var an=(function(){var aq=new u.Color();return function ar(){aq.set(al.backgroundColor);var at=aq.getHSL().l*255;return at>120?"black":"white"}})();function N(av){if(!av){return}var au=ab.getMoveReferent(av);var at=au.getLastElement(true),ar;if(i.isPLMInstanceNode(at)){if(at&&at.children.length){au.addElement(at.children[0])}var aq={display:{type:"docked",marginW:10,marginH:10},background:al,disableKeyboard:true,displayWhileViewpointIsManipulated:true,uiFrame:T.getFrameWindow().getUIFrame(),getLevels:function(ax){var aA=i.getLevelSelectorLevels({pathElement:av,pathElementCurrent:au,onInfoCompleted:ax,context:T});if(aA){aA.selectColor="#ff821e";aA.selectOverColor="#ffb477";for(var ay=aA.levels.length-1,aw=false;ay>=0;--ay){var az=aA.levels[ay];if(!i.isPLMReferenceNode(az.pathElement.getLastElement(true))){az.selection="notSelectable"}else{if(!aw){aw=true;az.selection="notSelectable"}}}}return aA},onHover:function(aw){if(O){O.setColor(an(),false);O.setOpacity(0.05,false);O.setVisibility(true);O.setVisibilityFree(null)}ar=ai.createOverride({pathes:[au]});ar.setColor(16744448,true);ar.setOpacity(1,true);al.render();g.empty();g.add(aw)},onLeave:function(){if(O){O.setColor(null,null);O.setOpacity(null,null);O.setVisibility(false);O.setVisibilityFree(true)}ai.deleteOverride(ar);ar=null;al.render();g.empty();g.add(t.get())},onSelect:function(aw){if(aw&&aw.pathElement&&ab){ab.addMoveReferent(aw.pathElement);ai.deleteOverride(ar);ar=null;au=ab.getMoveReferent(av);at=au.getLastElement(true);if(at&&at.children.length){au.addElement(at.children[0])}ar=ai.createOverride({pathes:[au]});ar.setColor(16744448,true);ar.setOpacity(1,true);al.render()}}};e.createView(aq)}}function U(){var aw=Math.sqrt(2)*60;var av=T.getViewer(),at=av.SCREEN_WIDTH,ar=av.SCREEN_HEIGHT,ax=at/2,aq=ar/2;ao.main.setStyles({top:aq+"px",left:ax+"px"});ao.right.setStyle("left",ax-aw-10+"px");ao.left.setStyle("left",-1*ax+aw+10+"px");ao.top.setStyle("top",-1*aq+aw+10+"px");var au=T.getFrameWindow().getActionBar().elements.container.getAttribute("data-open")==="true"?73:30;ao.bottom.setStyle("top",aq-aw-au+"px")}function Q(aq){ap.forward();var ar;if(aq.key==="ArrowLeft"||aq.keyCode===37){ar=ao.left}else{if(aq.key==="ArrowUp"||aq.keyCode===38){ar=ao.top}else{if(aq.key==="ArrowRight"||aq.keyCode===39){ar=ao.right}else{if(aq.key==="ArrowDown"||aq.keyCode===40){ar=ao.bottom}}}}if(ar){ar.addClassName("active");am.call(ar)}}function I(aq){var ar;if(aq.key==="ArrowLeft"||aq.keyCode===37){ar=ao.left}else{if(aq.key==="ArrowUp"||aq.keyCode===38){ar=ao.top}else{if(aq.key==="ArrowRight"||aq.keyCode===39){ar=ao.right}else{if(aq.key==="ArrowDown"||aq.keyCode===40){ar=ao.bottom}}}}if(ar){ar.removeClassName("active")}}ac=function(aq){if(aq.key===" "||aq.key==="Spacebar"||aq.keyCode===32){if(aq.ctrlKey===false&&aq.altKey===false&&aq.shiftKey===false&&aq.metaKey===false){document.removeEventListener("keypress",ac);document.addEventListener("keyup",H);if(ag.length===0){B.begin()}else{B.end()}}}};H=function(aq){if(aq.key===" "||aq.key==="Spacebar"||aq.keyCode===32){document.removeEventListener("keyup",H);document.addEventListener("keypress",ac)}};function z(){if(ag.length){if(!F){F=new p(ag[0].path.externalPath)}if(!w(F)){F=P=null}else{P=new r();P.store(T.getFrameWindow().getViewpoint(),new u.Matrix4().getInverse(F.getWorldMatrix()))}}}function ak(at){B.deactivate();if(b&&!at){b.deactivate({context:T})}T.setRobotVisibility(A);if(K&&window.widget&&window.widget.getValue("changeControlActivation")==="true"){K.show()}var ar=a.getCommandCheckHeader("PAD3DLineLayoutHdr",G);if(ar&&V){ar.enable()}s.removeEvent(al.canvas,"onPrimaryPointerClick",aj);if(L){J.unsubscribe(L);L=undefined}if(!at&&C){J.unsubscribe(C);C=undefined}aa.forEach(function(au){T.unsubscribe(au)});aa=[];e.destroyView();if(ao.main){ao.main.hide()}if(ah){T.getViewer().unsubscribe(ah)}var aq=T.getFrameWindow().getActionBar();if(Z){aq.removeCallback(Z)}if(X){aq.removeCallback(X)}ah=Z=X=undefined;document.removeEventListener("keydown",Q);document.removeEventListener("keyup",I)}function Y(){z();ag=[];D=null;ak(true);var aq=T.getViewer();aq.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(ai);ai=O=null;aq.render();E.restore(T.getFrameWindow().getViewpoint())}function R(){B.activate();if(b&&v&&!v.isNavigationActivated({context:T})){b.activate({context:T})}T.getFrameWindow().getContextualUIManager().hideContextualMenus();A=T.isRobotVisible();T.setRobotVisibility(false);if(K){K.hide()}var ar=a.getCommandCheckHeader("PAD3DLineLayoutHdr",G);if(ar&&ar.isEnabled()){ar.disable();V=true}s.addEvent(al.canvas,"onPrimaryPointerClick",aj);L=J.subscribe("Move",Y);C=J.subscribe("MoveEnd",B.end.bind(B));["onRootRemoved","onRootDetached","onAuthoringTransactionEnd","onEndDelete"].forEach(function(at){aa.push(T.subscribe({event:at},x))});N(ag.length===1?ag[0].path:null);ao.main.show();U();ah=al.onViewerResize(U);var aq=T.getFrameWindow().getActionBar();Z=aq.onActionBarOpen(U);X=aq.onActionBarClose(U);document.addEventListener("keydown",Q);document.addEventListener("keyup",I)}this.execute=function(){E=new r();E.store(T.getFrameWindow().getViewpoint());T.getFrameWindow().getActionBar().close();ap=f.get3DComposeAnimationEngine({viewer:al});ag=[];ai=new l(T.getRootBagPath().externalPath[0]);M.pushSceneGraphOverrideSet(ai);var ax=[],at=[],au=new u.Box3(),aw=al.getVisibleSpace();D=[];t.get().forEach(function(aB){D.push(aB);var aF=new p(aB.pathElement.externalPath);while(aF&&!i.isPLMNode(aF.getLastElement(true))){aF=aF.getParentPath()}if(aF&&aF.externalPath.length&&(M.getCurrentVisibilityFree(aF)===false||typeof M.getCurrentVisibility(aF)==="boolean")){var aE=aF.getParentPath().getWorldMatrix();var aC=new u.Matrix4().getInverse(aE);var aA=aF.getMatrix();var az={path:aF,override:ai.createOverride({pathes:[aF]}),matrixSource:aA,matrixParent:aE,matrixParentInv:aC,rotate:true};var aD=aw?aF.getBoundingBox(null,al,"visibleSpace"):aF.getBoundingBox(null,al,"invisibleSpace");if(aD&&!aD.isNaN()){aD.applyMatrix4(aF.getWorldMatrix());au.union(aD)}else{az.rotate=false}ag.push(az);ax.push(aF);at.push(aF.getKey())}});if(ax.length>0){var ar=au.center();ag.forEach(function(az){az.centerRotation=new u.Vector3().copy(ar).applyMatrix4(az.matrixParentInv)});var aq=false;if(F){if(!F.isEqual(new p(ax[0].externalPath))||!w(F)){P=F=null}}if(!P){aq=true}var ay=y(T.getRootBagPath(),ax,at,M);O=ai.createOverride({pathes:ay});ap.addAnimation({animationType:"mask",objectListToAnimate:[{override:O}],callBackFct:function(){if(aq){T.getFrameWindow().getViewpoint().reframe(null,0,au.getBoundingSphere())}else{if(P){P.restore(T.getFrameWindow().getViewpoint(),F.getWorldMatrix());P=null}}}});ap.startAnimation();var av=function(aA){var aB=new o.createElement("div",{"class":aA}).inject(ao.main);aB.addEvents({click:am});new o.createElement("div",{"class":"background"}).inject(aB);var az=new o.createElement("div",{"class":"arrow"}).inject(aB);new o.createElement("div",{"class":"borderBottom"}).inject(az);new o.createElement("div",{"class":"borderRight"}).inject(az);ao[aA]=aB};ao.main=o.createElement("div",{id:"C3D-viewpoint"}).inject(T.getFrameWindow().getUIFrame());["left","top","right","bottom"].forEach(av);R();g.empty();t.empty()}else{B.end()}};this.endExecute=function(){z();ag=[];ak();if(ao.main){ao.main.destroy()}ao={};if(ai){var ar=T.getViewer();ar.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(ai);ai=O=null;ar.render();T.getFrameWindow().getActionBar().open();E.restore(T.getFrameWindow().getViewpoint())}if(D&&D.length&&t.get().length===0){g.empty();t.empty();var aq=D.filter(function(at){return typeof M.getCurrentVisibility(at.pathElement)==="boolean"});if(aq.length){g.add(D);t.add(D)}}};this.pauseExecute=function(){ak(false)};this.resumeExecute=function(){R(false);g.empty();t.empty();var ar=new u.Box3(),at=al.getVisibleSpace();ag.forEach(function(aw){var av=aw.path,au=at?av.getBoundingBox(null,al,"visibleSpace"):av.getBoundingBox(null,al,"invisibleSpace");if(au&&!au.isNaN()){au.applyMatrix4(av.getWorldMatrix());ar.union(au);aw.rotate=true}else{aw.rotate=false}});var aq=ar.center();ag.forEach(function(au){au.centerRotation=new u.Vector3().copy(aq).applyMatrix4(au.matrixParentInv)})};this.activate=function(){if(!B){return}B.enable();document.addEventListener("keypress",ac);if(ad.length===0){ad.push(t.onPostAdd(S));ad.push(t.onPostRemove(S))}if(!ae){ae=T.subscribe({event:"onShow"},S)}if(!af){af=T.subscribe({event:"onHide"},S)}S()};this.deactivate=function(){if(!B){return}document.removeEventListener("keypress",ac);document.removeEventListener("keyup",H);ad.forEach(function(aq){t.unsubscribe(aq)});T.unsubscribe(ae);T.unsubscribe(af);ad.length=0;ae=af=null;if(!this.isRunning()){this.disable()}};this.disable();this.getRequestedCommandMode=function(aq){return(aq.cmd==="Measure"||aq.cmd==="Section")?"shared":undefined};this.allowManipulation=function(aq){return(aq.object==="Measure"||aq.object==="Section")?true:undefined};this._destroy=function(){if(!B){return}B.deactivate();if(b){b.unreference({context:T})}Object.getPrototypeOf(this)._destroy.apply(this,arguments);B=T=al=M=null}}});return m});define("DS/CAT3DComposeBoxes/CAT3DComposeBoxController",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Selection/CSOManager","DS/CAT3DComposeMoveManager/CAT3DComposeMoveManager","DS/CAT3DComposeMoveManager/CATC3DMoveReferent","DS/CoreEvents/Events","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(a,i,e,c,g,d,b){var j=a.extend({init:function(K){var l=K||{};this._parent(l);var s=50;var x=this;var F=[];var H;var u=[];var z=l.ctxViewer;var t=false,p=true;var A=null;var m=null;var I=null;var C,L;var E;var y=function(M){return b.isPLMNode(M)};var G=function(S){if(F.length===1){A=S.pathElement;var O=z.getFrameWindow().getContextualUIManager();O.hideContextualMenus();if(A){var R=[];if(y(A.getLastElement(true))&&y(A.getParentPath().getLastElement(true))){R.push({name:"CAT3DComposeBoxesLevelSelectorStr",line:1,hdr_list:["LevelSelectorHdr"]})}var N=false;var M=e.get();for(var P=0;P<M.length;P++){var Q=M[P].pathElement;Q=I.getMoveReferent(Q);var T=Q.getMatrix();if(T.elements[0]!==1||T.elements[5]!==1||T.elements[10]!==1||T.elements[15]!==1||T.elements[1]!==0||T.elements[2]!==0||T.elements[3]!==0||T.elements[4]!==0||T.elements[6]!==0||T.elements[7]!==0||T.elements[8]!==0||T.elements[9]!==0||T.elements[11]!==0||T.elements[12]!==0||T.elements[13]!==0||T.elements[14]!==0){N=true;break}}if(N){R.push({name:"CAT3DComposeBoxesIdentityPositionStr",line:1,hdr_list:["CAT3DComposeSetIdentityPositionHdr"]})}if(R.length>0){O.showContextualBar({hideWithDistance:true,fillingList:[{onContextualBarReady:function(){return{cmdList:R}},context:z.getCommandContext?z.getCommandContext():null,workbenchName:"CAT3DComposeWidgetWkb",module:"CAT3DComposeWidget",cmdPrefix:""}]})}}}};var o=function(){for(var M=0;M<F.length;M++){F[M].setVisibleFlag(false)}z.getViewer().render()};var r=function(){for(var M=0;M<F.length;M++){F[M].setVisibleFlag(true)}z.getViewer().render()};var B=function(N){if(!C){require(["DS/CAT3DComposeBoxes/CAT3DComposeBoxManipulator"],function(ac){C=ac;if(p&&t){var aa=e.get();for(var ab=0;ab<aa.length;ab++){L(aa[ab].pathElement)}}})}else{var U=z.getViewer(),P=U.getVisibleSpace(),R=N.getBoundingBox(null,U,P?"visibleSpace":"invisibleSpace");if(R&&!R.isNaN()){var S=N.getWorldMatrix(U);var X=new i.Vector3(R.min.x,R.min.y,R.min.z);var O=new i.Vector3(R.max.x,R.min.y,R.min.z);var Q=new i.Vector3(R.min.x,R.max.y,R.min.z);var Y=new i.Vector3(R.min.x,R.min.y,R.max.z);var V=new i.Vector3(O.x-X.x,O.y-X.y,O.z-X.z);var M=new i.Vector3(Q.x-X.x,Q.y-X.y,Q.z-X.z);var W=new i.Vector3(Y.x-X.x,Y.y-X.y,Y.z-X.z);var T=new C({pathElement:N,edgeMaterial:E,cornerPoint:X,fstAxis:V,sndAxis:M,thdAxis:W,matrix:S,rootBagPath:z.getRootBagPath().clone(),viewer:U});T.show();F.push(T);var Z={};Z.onClick=T.subscribe("onBoxClick",G);Z.onBeginManipulate=T.subscribe("onBoxBeginManipulate",o);Z.onEndManipulate=T.subscribe("onBoxEndManipulate",r);H.boxTokens.push(Z)}}};L=function(O){if(F.length<s){var N=O?I.getMoveReferent(O):null;var M=!N?true:F.some(function(P){return N.isEqual(P.getAssociatedPath())});if(!M){B(N)}}};var q=function(M){if(t){L(M.pathElement)}};var n=function(N,S){if(S&&t){x.refreshBoxes()}else{if(!S){u=[];if(F.length&&N&&Array.isArray(N)){var M=[];for(var P=0;P<N.length;P++){var R=N[P];R=I.getMoveReferent(R);for(var Q=0;Q<F.length;Q++){var O=F[Q].getAssociatedPath();if(R.isAParentOf(O)&&M.indexOf(Q)===-1){F[Q].setVisibleFlag(false);M.push(Q);u.push(O)}}}}}}};var v=function(N){var M=function(P,O){return P-O};N.sort(M)};var J=function(M){if(H&&H.boxTokens&&H.boxTokens[M]){F[M].unsubscribe(H.boxTokens[M].onClick);F[M].unsubscribe(H.boxTokens[M].onBeginManipulate);F[M].unsubscribe(H.boxTokens[M].onEndManipulate);H.boxTokens.splice(M,1)}F[M].hide();F.splice(M,1)};var w=function(T){if(t&&F&&F.length!==0){var M=[],P,S;if(!T){var N=e.get();for(P=0;P<F.length;P++){var R=true;for(var Q=0;Q<N.length;Q++){S=N[Q].pathElement;S=I.getMoveReferent(S);if(S&&S.isEqual(F[P].getAssociatedPath())){R=false;break}}if(R){M.push(P)}}}else{for(P=0;P<F.length;P++){S=I.getMoveReferent(T.pathElement);if(S&&S.isEqual(F[P].getAssociatedPath())){M.push(P);break}}}v(M);for(var O=M.length-1;O>=0;O--){J(M[O])}}};var D=function(){if(!H){H={boxTokens:[]};m=c.getMoveManager({context:z});I=g.getMoveReferentManager({context:z});H.onAdd=e.onAdd(q);H.onRemove=e.onRemove(w);H.onEmpty=e.onEmpty(w);H.Move=m.subscribe("Move",function(N){if(t){var O=[];N.objectsMoved.forEach(function(P){if(P.path){O.push(P.path)}});if(O.length){n(O,false)}}});H.MoveEnd=m.subscribe("MoveEnd",function(){if(t){for(var P=0;P<u.length;P++){var N=true;for(var Q=0;Q<F.length;Q++){if(u[P].isEqual(F[Q].getAssociatedPath())){N=false;if(!F[Q].getVisibleFlag()){var O=F[Q].getAssociatedPath().getWorldMatrix(z.getViewer());F[Q].setMatrix(O);F[Q].setVisibleFlag(true);z.getViewer().render()}}}if(N){B(u[P])}}u=[]}});H.onRootRemoved=z.subscribe({event:"onRootRemoved"},function(N){if(t){n([N.path],true)}});H.onRootDetached=z.subscribe({event:"onRootDetached"},function(N){if(t){n([N.path],true)}});H.onHide=z.subscribe({event:"onHide"},function(N){if(t){n(N.paths,true)}});H.onShow=z.subscribe({event:"onShow"},x.refreshBoxes);H.onEndMatriceUpdate=z.subscribe({event:"onEndMatriceUpdate"},x.refreshBoxes);H.swapVisibleSpace=z.getViewer()&&z.getViewer().onSwapVisibleSpace?z.getViewer().onSwapVisibleSpace(x.refreshBoxes):null;var M=false;H.VISU=d.subscribe({event:"/VISU/"},function(O){var N;if(t&&F.length){if(O.eventType==="@onViewpointBeginMove"){M=true}else{if(O.eventType==="@onViewpointChange"){if(M){for(N=0;N<F.length;N++){F[N].setVisibleFlag(false)}z.getViewer().render();M=false}}else{if(O.eventType==="@onViewpointEndMove"){for(N=0;N<F.length;N++){F[N].setVisibleFlag(true)}z.getViewer().render();M=false}}}}})}};var k=function(){if(H){if(H.VISU){d.unsubscribe(H.VISU)}if(H.onShow){z.unsubscribe(H.onShow)}if(H.onHide){z.unsubscribe(H.onHide)}if(H.onRootDetached){z.unsubscribe(H.onRootDetached)}if(H.onRootRemoved){z.unsubscribe(H.onRootRemoved)}if(H.onEndMatriceUpdate){z.unsubscribe(H.onEndMatriceUpdate)}if(H.MoveEnd){m.unsubscribe(H.MoveEnd)}if(H.Move){m.unsubscribe(H.Move)}if(H.onAdd){e.unsubscribe(H.onAdd)}if(H.onRemove){e.unsubscribe(H.onRemove)}if(H.onEmpty){e.unsubscribe(H.onEmpty)}if(H.swapVisibleSpace&&z.getViewer()){z.getViewer().unsubscribe(H.swapVisibleSpace)}for(var M=F.length-1;M>=0;M--){J(M)}u=[];H=null}};this.setActiveState=function(O){if(t===O){return}t=O;if(p){if(t){D();if(!E){E=new i.LineBasicMaterial({color:16744990,opacity:1})}var M=e.get();for(var N=0;N<M.length;N++){L(M[N].pathElement)}}else{k();E=null}}};this.displayBoxes=function(O){if(p===O){return}p=O;if(p&&t){D();var M=e.get();for(var N=0;N<M.length;N++){L(M[N].pathElement)}}else{k()}};this.getDisplayState=function(){return p};this.clearController=function(){this.setActiveState(false);this.displayBoxes(false);F=H=u=z=m=I=A=x=null};this.refreshBoxes=function(){var N;if(p&&t){for(N=F.length-1;N>=0;N--){J(N)}var M=e.get();for(N=0;N<M.length;N++){L(M[N].pathElement)}}}}});var f=[];var h=a.singleton({init:function(){},getBoxController:function(m){var n;if(m&&m.context){for(var k=0;k<f.length;k++){if(f[k].context===m.context){n=f[k].boxController;break}}if(!n){var l=new j({ctxViewer:m.context});f.push({context:m.context,boxController:l});n=l}}return n},unregisterBoxController:function(l){if(l&&l.context){for(var k=0;k<f.length;k++){if(f[k].context===l.context){f[k].boxController.clearController();f.splice(k,1);break}}}}});return h});define("DS/CAT3DComposeBoxes/CAT3DComposeBoxesCmd",["DS/ApplicationFrame/CommandCheckHeader","DS/CAT3DComposeBoxes/CAT3DComposeBoxController","DS/PADUtils/PADContext"],function(d,b,c){var a=d.extend({init:function(g){this._parent(g,{});var j=this;var h=null;var i=this.onStateChange(function(){if(!h){h=c.get()}b.getBoxController({context:h}).displayBoxes(j.getState());localStorage.setItem("CAT3DComposeBoxesCmd",j.getState()?"true":"false")});var f=this._destroy;this._destroy=function(){if(h){b.unregisterBoxController({context:h})}j._modelEvents.unsubscribe(i);f.call(j)};var e=localStorage.getItem("CAT3DComposeBoxesCmd");e=e!=="false";this.setState(e,true)},_destroy:function(){this._parent()}});return a});define("DS/CATC3DGeometry/CATC3DEquivalentGeometry",["UWA/Class","DS/CATC3DGeometry/CATC3DGeometryEnums","DS/DMUMeasurable/DMUGeometryEnums","DS/DMUMeasurable/DMUMeshRecognition","DS/Visualization/ThreeJS_DS","DS/Visualization/PathElement","DS/CAT3DComposeWidget/CAT3DComposeWidgetOptions","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(o,g,m,p,n,f,i,d){var e=i.getOption("authoring3d"),l=new n.Matrix4(),k={},j="AxisSystems",a="RefPlanes",c=g.GeometryType,b=o.extend({init:function(w){var u=w.pathElement,s=w.type,v=w.mode,x=w.direction,t=w.origin,r=w.geom;var q=(function(){var y;return function(z){if(!z&&y===undefined){y=new n.Matrix4()}return u.getWorldMatrix(null,z||y)}}());this.getPathElement=function(){return u.clone()};this.getType=function(){return s};this.getMode=function(){return v};if(s===g.GeometryType.AXISSYSTEM||s===g.GeometryType.AXISSYSTEMAXIS||s===g.GeometryType.AXISSYSTEMORIGIN){if(s===g.GeometryType.AXISSYSTEMAXIS){(function(B){var z=u.getParentPath(),y=new n.Matrix4(),A=new n.Matrix4();B.getOrigin=function(C){z.getWorldMatrix(null,y);return(C||new n.Vector3()).getPositionFromMatrix(y)};B.getDirection=function(C){A.extractRotation(q());return(C||new n.Vector3()).set(0,0,1).applyMatrix4(A).normalize()}})(this)}else{if(s===g.GeometryType.AXISSYSTEMORIGIN){this.getOrigin=function(y){return(y||new n.Vector3()).getPositionFromMatrix(q())}}else{this.getMatrix=function(y){return q(y)}}}return}if(s===g.GeometryType.REFPLANE){v=g.GeometryMode.REAL;this.getPlane=function(){var y=q();return{origin:new n.Vector3().getPositionFromMatrix(q()),normal:new n.Vector3().getColumnFromMatrix(2,y)}};this.getNormal=function(z){var y=q();return(z||new n.Vector3()).getColumnFromMatrix(2,y)};return}if(s===g.GeometryType.AXIS||s===g.GeometryType.AXISX||s===g.GeometryType.AXISY||s===g.GeometryType.AXISZ){this.getDirection=(function(){var y=new n.Matrix4();return function(z){y.extractRotation(q());return(z||new n.Vector3()).copy(x).applyMatrix4(y).normalize()}}());this.getOrigin=function(y){return(y||new n.Vector3()).copy(t).applyMatrix4(q())};this.getAxis=function(){var y=q();return{origin:t.clone().applyMatrix4(y),direction:x.clone().transformDirection(y)}};return}v=g.GeometryMode.REAL;switch(r.type){case m.GeometryType.POINT:s=g.GeometryType.POINT;break;case m.GeometryType.CURVE:s=g.GeometryType.CURVE;break;case m.GeometryType.LINE:s=g.GeometryType.LINE;break;case m.GeometryType.CIRCLE:s=g.GeometryType.CIRCLE;break;case m.GeometryType.SURFACE:s=g.GeometryType.SURFACE;break;case m.GeometryType.PLANE:s=g.GeometryType.PLANE;break;case m.GeometryType.CYLINDER:s=g.GeometryType.CYLINDER;break;case m.GeometryType.CONE:s=g.GeometryType.CONE;break;case m.GeometryType.SPHERE:s=g.GeometryType.SPHERE;break;default:window.console.log("Unknown DMU geometry type!!!")}if(s===g.GeometryType.POINT){this.getPoint=function(y){return(y||new n.Vector3()).copy(r.position).applyMatrix4(q())}}if(s===g.GeometryType.LINE||s===g.GeometryType.CURVE||s===g.GeometryType.CYLINDER||s===g.GeometryType.CONE){this.getEndPoints=function(){var y=q();return{startPoint:r.point1.clone().applyMatrix4(y),endPoint:r.point2.clone().applyMatrix4(y)}}}if(s===g.GeometryType.PLANE){this.getPlane=function(){var y=q();return{origin:r.origin.clone().applyMatrix4(y),normal:r.normal.clone().transformDirection(y)}};this.getNormal=function(z){var y=q();return(z||new n.Vector3()).copy(r.normal).transformDirection(y)}}if(s===g.GeometryType.CIRCLE||s===g.GeometryType.CYLINDER||s===m.GeometryType.SPHERE){this.getRadius=function(){return r.radius}}if(s===g.GeometryType.CIRCLE||s===g.GeometryType.SPHERE){this.getCenter=function(y){return(y||new n.Vector3()).copy(r.center).applyMatrix4(q())}}if(s===g.GeometryType.CIRCLE){this.getNormal=function(y){return(y||new n.Vector3()).copy(r.normal).transformDirection(q())}}}});function h(s){var q=new f(s.externalPath),r=q.getLastElement(true);if(r&&(d.isInstance(r)||d.isRepInstance(r))&&r.children.length===1){q.addElement(r.children[0])}else{while(q&&(r=q.getLastElement(true))&&(!d.isPLMNode(r)||(!d.is3DLeaf(r)&&!d.isReferencenode(r)))){q=q.getParentPath()}}return q}k.getEquivalentGeometry=function(u){if(!u||!u.pathElement||!u.pathElement.externalPath||u.pathElement.externalPath.length<2||u.pathElement.externalPath[0].name!=="RootBag"){return undefined}var A=u.pathElement,z,v,r=-1,s=-1,t,B,x;for(var y=A.externalPath.length-1;y>=0;--y){var q=A.externalPath[y];if(!q){continue}if(q.name===j){r=y;break}if(q.name===a){s=y;break}if(d.isPLMNode(q)){break}}if(r===-1&&s===-1&&A.internalPath.length){var w=A.getLastElement().sgNode;if(w){B=p.recognizeCanonicGeometry(w,l,true);x=B.type;if(B.returnCode===0&&(x===m.GeometryType.POINT||x===m.GeometryType.CURVE||x===m.GeometryType.LINE||x===m.GeometryType.CIRCLE||x===m.GeometryType.SURFACE||x===m.GeometryType.PLANE||x===m.GeometryType.CYLINDER||x===m.GeometryType.CONE||x===m.GeometryType.SPHERE)){v={pathElement:u.pathElement.clone(),geom:B};z=new b(v)}else{if(B.returnCode!==0&&u.nonCanonicGeometry===true){B=p.recognizeNonCanonicGeometry(w,l,true);x=B.type;if(B.returnCode===0&&(x===m.GeometryType.POINT||x===m.GeometryType.CURVE||x===m.GeometryType.LINE||x===m.GeometryType.CIRCLE||x===m.GeometryType.SURFACE||x===m.GeometryType.PLANE||x===m.GeometryType.CYLINDER||x===m.GeometryType.CONE||x===m.GeometryType.SPHERE)){v={pathElement:u.pathElement.clone(),geom:B};z=new b(v)}}}}}else{if(r>=0&&(r+1)<A.externalPath.length){v={pathElement:new f(A.externalPath.slice(0,r+2))};if(u.axisSystemOrigin===true){v.type=g.GeometryType.AXISSYSTEMORIGIN;v.mode=g.GeometryMode.TRANSIENT}else{v.mode=g.GeometryMode.REAL;if((r+2)<A.externalPath.length&&u.axisSystemSub===true){v.type=g.GeometryType.AXISSYSTEMAXIS;v.pathElement.addElement(A.externalPath[r+2])}else{v.type=g.GeometryType.AXISSYSTEM}}z=new b(v)}else{if(s>=0){v={pathElement:u.pathElement.clone(),type:g.GeometryType.REFPLANE};z=new b(v)}else{if(e){if(u.direction&&u.direction instanceof n.Vector3&&u.origin&&u.origin instanceof n.Vector3){t=h(A);if(t){v={pathElement:t};v.type=g.GeometryType.AXIS;v.mode=g.GeometryMode.TRANSIENT;v.origin=u.origin.clone();v.direction=u.direction.clone().normalize();z=new b(v)}}else{if(u.axis===c.AXISX||u.axis===c.AXISY||u.axis===c.AXISZ){t=h(A);if(t){v={pathElement:t,origin:new n.Vector3(),type:u.axis};v.mode=g.GeometryMode.TRANSIENT;v.direction=u.axis===c.AXISX?new n.Vector3(1,0,0):u.axis===c.AXISY?new n.Vector3(0,1,0):new n.Vector3(0,0,1);z=new b(v)}}}}}}}return z};Object.freeze(k);return k});define("DS/CAT3DComposeConstraints/CAT3DComposeConstraintsModel",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/CATCDSJS/CATCDS","DS/CATC3DGeometry/CATC3DGeometryEnums","DS/CATC3DGeometry/CATC3DEquivalentGeometry","DS/CAT3DComposeMoveManager/CAT3DComposeMoveManager"],function(e,d,f,a,c,h){var b=a.GeometryType,g=e.extend({init:function(v){var i=v.context;var k=[];var t=this;var q=null;var m=null;var u=null;var r=null;var o=false;var p=h.getMoveManager({context:i});this.createCst=function(w){var x={movable:w.movable,fixed:w.fixed,cstType:w.cstType};k.push(x);return x};this.getLastCst=function(){return k.length>0?k[k.length-1]:null};this.deleteLastCst=function(){k.splice(k.length-1,1)};this.deleteAllCst=function(){k=[]};this.count=function(){return k.length};var s=function(z,A){var C;switch(z.getType()){case b.POINT:var D=z.getPoint();C=f.CATICDSPoint.Create(A,D.x,D.y,D.z);break;case b.CIRCLE:case b.SPHERE:var w=z.getCenter();C=f.CATICDSPoint.Create(A,w.x,w.y,w.z);break;case b.LINE:case b.CYLINDER:case b.CONE:var E=z.getEndPoints();var x=E.endPoint.clone().sub(E.startPoint).normalize();C=f.CATICDSLine.Create(A,E.startPoint.x,E.startPoint.y,E.startPoint.z,x.x,x.y,x.z);break;case b.PLANE:case b.REFPLANE:var B=z.getPlane();C=f.CATICDSPlane.Create(A,B.origin.x,B.origin.y,B.origin.z,B.normal.x,B.normal.y,B.normal.z);break;case b.AXIS:case b.AXISX:case b.AXISY:case b.AXISZ:var y=z.getAxis();C=f.CATICDSLine.Create(A,y.origin.x,y.origin.y,y.origin.z,y.direction.x,y.direction.y,y.direction.z);break;default:window.console("Unknown type of geomtry")}return C};var l=function(){o=false;q=f.CATICDSAdvanced.Create();q.SetTolerances(0.001,0.000001);q.SetReplayMode(f.CATCDSReplayMode.rmREPLAY);m=q.GetFactory();r=f.CATICDSRigidSet.Create(m);r.FixToggle();u=f.CATICDSRigidSet.Create(m);for(var A=0;A<t.count();++A){var y=s(k[A].movable,m);u.AddGeometry(y);var w=s(k[A].fixed,m);r.AddGeometry(w);var z=k[A].movable.getType(),C=k[A].fixed.getType(),B=(z===b.AXISX||z===b.AXISY||z===b.AXISZ)&&(C===b.PLANE||C===b.REFPLANE)?"CATICDSParallelism":"CATICDSCoincidence",x=f[B].Create(m,y,w);if(k[A].cstType==="cstContact"||k[A].cstType==="cstAntiAlign"){x.SetAlignment(f.CATCAlignment.caANTIALIGN)}else{if(k[A].cstType==="cstCoincidence"||k[A].cstType==="cstAlign"){x.SetAlignment(f.CATCAlignment.caALIGN)}}if(x.IsRedundant().status===f.CATCDSRedundancyStatus.rsFULLYREDUNDANT){o=true}}};var j=function(){var w={};var z=q.Run();if(z===0){if(u.HasTransformation()){var y=u.GetTransformation();var x=new d.Matrix4(y.matrix[0][0],y.matrix[0][1],y.matrix[0][2],y.vector[0],y.matrix[1][0],y.matrix[1][1],y.matrix[1][2],y.vector[1],y.matrix[2][0],y.matrix[2][1],y.matrix[2][2],y.vector[2],0,0,0,1);w.matrix=x}}else{q.UndoRun()}f.CATICDSAdvanced.Remove(q);q=null;m=null;u=null;r=null;w.rc=z;w.redundancy=o;return w};this.simulateMoveWithCst=function(y){l();var x=[[1,0,0],[0,1,0],[0,0,1]];if(y.rotation){x=y.rotation}var z=new d.Vector3();if(y.translation){z=y.translation}if(y.movableReference){var w=f.CATICDSPoint.Create(m,y.movableReference.x,y.movableReference.y,y.movableReference.z);u.AddGeometry(w)}u.SetDynamicMove(x,[z.x,z.y,z.z]);return j()};this.simulateSolveCst=function(){l();return j()};this.moveWithCst=function(z){var x=z.alternative.alternativePosition;var w=z.objectsToMove;if(x){p.onMoveBegin({objectsMoved:w,from:t,moveMode:"Transient"});var y=new d.Matrix4().getInverse(w[0].initWorldMatrix).multiply(x);w.forEach(function(B){var C=new d.Matrix4().copy(B.initWorldMatrix).multiply(y);var A=new d.Matrix4().getInverse(B.path.getParentPath().getWorldMatrix());B.snappedPosition=new d.Matrix4().copy(A).multiply(C)});p.onMove({objectsMoved:w,transformation:y,from:t});if(z.callBackFct){z.callBackFct({objectsToMove:w,callBackAfterAnim:function(){p.onMoveEnd({from:t,status:"Moved"})}})}}};this.getConstraintForReverseDirection=function(x){var w=this.count()===1?this.getLastCst():null;if(!x||!w){return undefined}var y=w.movable.getType();if((y===b.AXISX||y===b.AXISY||y===b.AXISZ)&&x.isAParentOf(w.movable.getPathElement())){return w}return undefined};function n(w){var x;switch(w.getType()){case b.LINE:case b.CYLINDER:case b.CONE:var y=w.getEndPoints();x=y.endPoint.clone().sub(y.startPoint).normalize();break;case b.PLANE:case b.REFPLANE:x=w.getNormal();break;case b.AXIS:case b.AXISX:case b.AXISY:case b.AXISZ:x=w.getDirection();break;default:window.console.log("Unknown type of geomtry")}return x}this.simulateReverseDirection=function(y){var w=this.getConstraintForReverseDirection(y);if(w){if(w.cstType==="cstAntiAlign"||w.cstType==="cstAlign"){w.cstType=w.cstType==="cstAntiAlign"?"cstAlign":"cstAntiAlign";return this.simulateSolveCst()}else{var A=n(w.movable),x=n(w.fixed);if(A&&x){var z=A.angleTo(x);if(Math.abs(z)<0.000001||Math.abs(Math.PI-z)<0.000001){w.cstType=Math.abs(z)<0.000001?"cstAntiAlign":"cstAlign";return this.simulateSolveCst()}}}}return undefined};this.getAxisTypeIfCstOnProductAxis=function(x){var w=this.count()===1?this.getLastCst():null;if(!x||!w){return undefined}var y=w.movable.getType();if((y===b.AXISX||y===b.AXISY||y===b.AXISZ)&&x.isAParentOf(w.movable.getPathElement())){return y}return undefined};this.simulateSwitchAxis=function(z,w){var x=this.getAxisTypeIfCstOnProductAxis(z);if(x&&x!==w&&(w===b.AXISX||w===b.AXISY||w===b.AXISZ)){var y=this.getLastCst();this.deleteLastCst();this.createCst({movable:c.getEquivalentGeometry({pathElement:y.movable.getPathElement(),axis:w}),fixed:y.fixed});return this.simulateSolveCst()}return undefined}}});return g});define("DS/CAT3DComposeCommands/CATC3DAxisSystemDisplayAgent",["UWA/Class","DS/Visualization/PathElement","DS/Selection/PSOManager","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/CAT3DComposeUtils/CAT3DCompose3DAnimation","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/RenderStyle","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(k,e,j,c,d,b,h,g,a){var f="AxisSystems",i=k.extend({init:function(p){var u=p.context,v,m,x,q,A,l,n=u.getViewer().getSceneGraphOverrideSetManager(),t;function s(G,F){return G&&F&&G.isEqual(F)}function y(F){return q&&!q.get().some(function(G){return G.pathElement.getLastElement(true)===F.getLastElement(true)})}function B(H){var G=H?new e(H.externalPath):null,F;while(G&&!((F=G.getLastElement())&&a.is3DLeaf(F))){G=G.getParentPath()}return G}function z(G,F){var H=null;F.push(G);H=G.getChildrenPathes();if(H&&H.length>0){H.forEach(function(I){z(I,F)})}}function w(M){var F=B(M),K,G,N,L,I=null;if(F){N=[];K=F.getLastElement(true);G=K.getChildByName(f);if(G){L=G.getParents();while(L&&L[0]&&L[0]!==K){N.unshift(L[0]);L=L[0].getParents()}N.push(G);I=F;N.forEach(function(O){I.addElement(O)})}}if(I){var H=I.getChildrenPathes(),J=[];H.forEach(function(P){var O={paths:[]};z(P,O.paths);J.push(O)});return{axisBagPath:I,axisSystems:J}}return null}function E(F){if(!F||!F.pathElement){return null}if(u.getViewer().getAxisFilter()){if(t){n.removeSceneGraphOverrideSet(t);t=null;u.getViewer().render()}return null}if(t&&n.getSceneGraphOverrideSetIndex(t)===-1){n.pushSceneGraphOverrideSet(t)}var G=w(F.pathElement);if(G&&G.axisSystems&&G.axisSystems.length>0){var H=[];G.axisSystems.forEach(function(I){if(y(I.paths[0])){I.node=I.paths[0].getLastElement(true);H.push(I)}});if(H.length===G.axisSystems.length){H.push({paths:[G.axisBagPath]})}if(H.length>0){H.forEach(function(K){if(!t){t=new h(u.getRootBagPath().externalPath[0]);n.pushSceneGraphOverrideSet(t)}var J=t.getUniqueOverrideFromPathElement(K.paths[0]),I;if(!J){J=t.createOverride({pathes:K.paths});I=new g();I.setRenderMode("AxisSystem",true);J.setRenderStyle(I)}K.override=J})}b.get3DComposeAnimationEngine({viewer:u.getViewer()}).axisSystemVisibility({objectListToAnimate:H,visibility:F.visibility,pickability:F.pickability})}return F.pathElement}function D(F){var G=B(F.pathElement);if(!s(A,G)){E({pathElement:A,visibility:false,pickability:false});A=E({pathElement:G,visibility:true,pickability:true})}}function o(){var F=j.get();clearTimeout(l);l=null;if(F.length!==1){E({pathElement:A,visibility:false,pickability:false});return}D({pathElement:F[0].pathElement?F[0].pathElement:F[0].originalPathElement})}function C(F){var G=B(F.pathElement?F.pathElement:F.originalPathElement);if(G){l=setTimeout(function(){E({pathElement:G,visibility:false,pickability:false});A=null},1000)}}function r(F){var G=B(F.pathElement);if(!A||(A&&G&&!s(G,A))){E({pathElement:F.pathElement,visibility:false,pickability:false})}}u.getViewer().onAxisFilterChange(function(){if(t){n.removeSceneGraphOverrideSet(t);t=null;u.getViewer().render()}});this.activate=function(F){if(q){return}if(t){n.pushSceneGraphOverrideSet(t);u.getViewer().render()}v=j.onPostAdd(o);m=j.onRemove(C);q=(F&&F.type==="HSO")?c:d;x=q.onRemove(r)};this.analyze=D;this.deactivate=function(){if(!q){return}if(t){n.removeSceneGraphOverrideSet(t);u.getViewer().render()}j.unsubscribe(v);j.unsubscribe(m);q.unsubscribe(x);v=m=x=q=null}}});return i});define("DS/CAT3DComposeCommands/CATC3DDefaultSelectionFilter",["UWA/Class","DS/Visualization/PathElement","DS/Selection/PSOManager","DS/WebappsUtils/WebappsUtils","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/CAT3DComposeCommands/CATC3DAxisSystemDisplayAgent","DS/CATC3DGeometry/CATC3DEquivalentGeometry","DS/CATC3DGeometry/CATC3DGeometryEnums"],function(p,e,n,c,a,m,g,h){var f={};require(["i18n!DS/CAT3DComposeCommands/assets/nls/CAT3DComposeCommands"],function(q){f.point=q.point;f.center=q.center;f.axisSystem=q.axisSystem;f.line=q.line;f.plane=q.plane;f.cylinder=q.cylinder;f.product=q.product});var b=c.getWebappsAssetUrl("DMUBaseCommands","icons/32/");var k=c.getWebappsAssetUrl("CAT3DComposeCommands","icons/32/");var i,l,j=function(q){if(i){q()}else{if(!l){l=true;require(["DS/Web3DUXFilterBar/Web3DUXFilterBar"],function(r){l=false;i=r;q()})}}};var d=p.extend({init:function(v){var B=v.context,I=true,H={none:0,point:0,center:0,axisSystem:1,line:0,plane:1,cylinder:1,product:1},J,F,A,E,C,z,r,x=localStorage.getItem("C3DSelectionFilter"),s=new m({context:B}),G=function(){H={none:1,point:0,center:0,axisSystem:0,line:0,plane:0,cylinder:0,product:0};if(E.getActiveState("point")){H.none=0;H.point=1}if(E.getActiveState("center")){H.none=0;H.center=1}if(E.getActiveState("axisSystem")){H.none=0;H.axisSystem=1}if(E.getActiveState("line")){H.none=0;H.line=1}if(E.getActiveState("plane")){H.none=0;H.plane=1}if(E.getActiveState("cylinder")){H.none=0;H.cylinder=1}if(E.getActiveState("product")){H.none=0;H.product=1}var L="0-"+H.point+H.center+H.axisSystem+H.line+H.plane+H.cylinder+H.product+"-"+(I?1:0);localStorage.setItem("C3DSelectionFilter",L);if(H.axisSystem){s.activate()}else{s.deactivate()}},t=(function(){var M;function L(N){if(!N){M=false;if(E){E.setVisibleFlag(false)}return}M=true;if(I){if(!E){j(function(){E=new i({body:B.getFrameWindow().getUIFrame(),frmWindow:B.getFrameWindow(),Idpanel:"c3dSelectionFilter",classpanel:"c3dSelectionFilter",typeSeparator:"bubble",lJsonElement:[{type:"element",id:"point",nls:f.point,url:b+"I_Meas_Point.png",callback:G,bexclude:false,bstateActif:H.point},{type:"element",id:"center",nls:f.center,url:b+"I_Meas_PointCircle.png",callback:G,bexclude:false,bstateActif:H.center},{type:"element",id:"axisSystem",nls:f.axisSystem,url:k+"I_3DComposeAxisSystem.png",callback:G,bexclude:false,bstateActif:H.axisSystem},{type:"element",id:"line",nls:f.line,url:b+"I_Meas_Line.png",callback:G,bexclude:false,bstateActif:H.line},{type:"element",id:"plane",nls:f.plane,url:b+"I_Meas_Plane.png",callback:G,bexclude:false,bstateActif:H.plane},{type:"element",id:"cylinder",nls:f.cylinder,url:b+"I_Meas_Cylinder.png",callback:G,bexclude:false,bstateActif:H.cylinder},{type:"element",id:"product",nls:f.product,url:b+"I_Meas_Product.png",callback:G,bexclude:false,bstateActif:H.product}]});E.build();var O=document.querySelector(".c3dSelectionFilter");if(O){O.style.position="absolute"}E.setVisibleFlag(false);if(M&&I){E.setVisibleFlag(true)}})}else{E.setVisibleFlag(true)}}else{if(E){E.setVisibleFlag(false)}}}return function(){if(!C){L(false);return}L(B&&a.getRoots(B).length>0)}}());if(x&&x.length>8&&x.startsWith("0-")){H.point=x.charAt(2)==="1"?1:0;H.center=x.charAt(3)==="1"?1:0;H.axisSystem=x.charAt(4)==="1"?1:0;H.line=x.charAt(5)==="1"?1:0;H.plane=x.charAt(6)==="1"?1:0;H.cylinder=x.charAt(7)==="1"?1:0;H.product=x.charAt(8)==="1"?1:0;if(H.point===0&&H.center===0&&H.axisSystem===0&&H.line===0&&H.plane===0&&H.cylinder===0&&H.product===0){H.none=1}if(x.length>10&&x.charAt(9)==="-"){I=x.charAt(10)==="1"}}function K(L){var M=L.pathElement;L.pathElement=new e();M.externalPath.some(function(N){L.pathElement.addElement(N);return N&&a.is3DLeaf(N)});if(M.internalPath.length>0){L.originalPathElement=M}return L}function D(M){if(!M||!M.pathElement||!M.pathElement.externalPath.length||!a.isAModelPath(M.pathElement)){return M}if(H.none){return K(M)}if(H.axisSystem||H.point||H.center||H.line||H.plane||H.cylinder){var L=g.getEquivalentGeometry(M),N=L?L.getType():null;if(H.axisSystem&&N===h.GeometryType.AXISSYSTEM){M.originalPathElement=M.pathElement;M.pathElement=L.getPathElement();M.equivalentGeometry=L;return M}else{if((H.point&&N===h.GeometryType.POINT)||(H.center&&(N===h.GeometryType.CIRCLE||N===h.GeometryType.SPHERE))||(H.line&&N===h.GeometryType.LINE)||(H.plane&&(N===h.GeometryType.PLANE||N===h.GeometryType.REFPLANE))||(H.cylinder&&(N===h.GeometryType.CYLINDER||N===h.GeometryType.CONE))){M.equivalentGeometry=L;return M}}}if(H.product){return K(M)}M.originalPathElement=M.pathElement;M.pathElement=null;return M}function w(L){if(L instanceof Array){L.forEach(D)}else{D(L)}}function y(){if(C){return}var L=B.getViewer();F=L.picking.primitive;J=L.pPicking.primitive;A=L.picking.trapSelectionMesh;L.setPicking({primitive:1,trapSelectionMesh:true});L.setPrePicking({primitive:1});C=n.onPreAdd(w);z=B.subscribe({event:"onRootAdded"},t);r=B.subscribe({event:"onRootRemoved"},t);t();if(H.axisSystem){s.activate()}}function q(){if(!C){return}var L=B.getViewer();L.setPicking({primitive:F,trapSelectionMesh:A});L.setPrePicking({primitive:J});n.unsubscribe(C);B.unsubscribe(z);B.unsubscribe(r);C=z=r=null;t();s.deactivate()}function u(L){if(typeof L==="boolean"&&L!==I){I=L;t()}}this.filter={activate:y,deactivate:q,display:u,filterPath:D,getFiltersState:function(){return{point:H.point,center:H.center,line:H.line,axisSystem:H.axisSystem,plane:H.plane,cylinder:H.cylinder,product:H.product}}};Object.freeze(this.filter);this.unreference=function(){q();if(E){E.clear()}s=E=B=null}}});var o=[];return p.singleton({init:function(){},getDefaultSelectionFilter:function(q){var s;if(q&&q.context&&q.context.name==="ENOPAD3DViewer"){o.some(function(t){if(t.context===q.context){s=t.mng.filter;return true}return false});if(!s){var r=new d({context:q.context});o.push({context:q.context,mng:r});s=r.filter}}return s},unreferenceDefaultSelectionFilter:function(q){if(q&&q.context){o.some(function(s,r){if(s.context===q.context){s.mng.unreference();o.splice(r,1);return true}return false})}}})});define("DS/CAT3DComposeConstraints/CAT3DComposeConstraintsView",["UWA/Core","UWA/Class","DS/WebappsUtils/WebappsUtils","DS/CoreEvents/ModelEvents","DS/CATWebUXComponents/CATWebUXThumbnail","DS/CATWebUXComponents/CATWebUXPanel","DS/Visualization/ThreeJS_DS","DS/Visualization/Viewpoint","DS/CAT3DComposeBoxes/CAT3DComposeBoxController","DS/CAT3DComposeUtils/CAT3DCompose3DAnimation","DS/CAT3DComposeWidget/CAT3DComposeWidgetOptions","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/SceneGraphUtils","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(h,b,f,e,n,p,m,k,l,d,i,j,a,c){var g={};require(["i18n!DS/CAT3DComposeConstraints/assets/nls/CAT3DComposeConstraintsView"],function(q){g=q});var o=b.extend({init:function(w){if(!w){return}this._parent(w);var H=null;var s={div:null,thumbs:[]};var A=null;var x=null;var K=3394815,F=15355703;var I=w.context;var C=h.createElement("canvas");var B=null;var L=new e();var y=d.get3DComposeAnimationEngine({viewer:I.getViewer()});var u=f.getWebappsAssetUrl("CAT3DComposeConstraints","icons/32/");var t=function(P){var O=P.clone(),M=false,N;while(O&&!M){N=O.getLastElement(true);M=N&&c.is3DLeaf(N);if(!M){O=O.getParentPath()}}return O};var G=function(Q){var N=Q.getLastElement(true);var M=null;if(N){var P=t(Q);if(P){N=P.getLastElement(true);var O=N.getChildByName("AxisSystems");if(O){M={};M.axisBagNode=O}}}return M};var q=function(V,O,Z){var Q=2;var R={data:null,width:I.getViewer().SCREEN_WIDTH,height:I.getViewer().SCREEN_HEIGHT};I.getViewer().renderToTarget(R,V);var W=R.width/R.height;if(W>(O/Z)){C.height=Z;C.width=C.height*W}else{C.width=O;C.height=C.width/W}C.width*=Q;C.height*=Q;var N=C.getContext("2d");N.clearRect(0,0,C.width,C.height);var S=function(ad,ac,ab,ae,af){if(af){ac=ae-ac}return ab*Math.floor(ac)+Math.floor(ad)};var Y=N.getImageData(0,0,C.width,C.height);var X=(R.width-1)/(Y.width-1);var P=(R.height-1)/(Y.height-1);for(var T=0;T<Y.height;T++){for(var aa=0;aa<Y.width;aa++){var M=S(aa,T,Y.width,Y.height,false);var U=S(X*aa,P*T,R.width,R.height,true);Y.data[4*M]=R.data[4*U];Y.data[4*M+1]=R.data[4*U+1];Y.data[4*M+2]=R.data[4*U+2];Y.data[4*M+3]=R.data[4*U+3]}}N.putImageData(Y,0,0,0,0,C.width,C.height);return C.toDataURL("image/png")};var r=function(N){var O=new k({viewer:I.getViewer()});I.getViewer().addViewpoint(O);O.setEyePosition(I.getViewer().currentViewpoint.getEyePosition());O.setSightDirection(I.getViewer().currentViewpoint.getSightDirection());O.setUpDirection(I.getViewer().currentViewpoint.getUpDirection());O.setTargetDistance(I.getViewer().currentViewpoint.getTargetDistance());O.setProjectionType(I.getViewer().currentViewpoint.getProjectionType());var M=null;N.objectsToMove.forEach(function(P){if(!M){M=P.path.getBoundingSphere()}else{M.mergeWithSphere(P.path.getBoundingSphere(),M)}});M.mergeWithSphere(N.cstAssociated.fixed.getPathElement().getBoundingSphere(),M);O.reframe(null,0,M);return q(O,240,180)};var v=function(M){var T=new j(I.getRootBagPath().externalPath[0]);I.getViewer().getSceneGraphOverrideSetManager().pushSceneGraphOverrideSet(T);var U=I.getRootBagPath();var P=T.createOverride(U);var N=I.getViewer().getShadow();I.getViewer().setShadow(false);var O=I.getViewer().getGrid();I.getViewer().setGrid(false);var S=I.getViewer().getMirror();I.getViewer().setMirror(false);I.setRobotVisibility(false);var R=l.getBoxController({context:I});if(R){R.displayBoxes(false)}var Q=null;P.setOpacity(0,true);P.setPickability("IGNORED");var V=false;M.forEach(function(X){var Y=X.objectsToMove;var Z=new m.Matrix4().getInverse(Y[0].initWorldMatrix).multiply(X.alternativePosition);var W=new m.MeshBasicMaterial({side:m.DoubleSide,color:K,transparent:true,depthWrite:false,depthTest:false,opacity:0.7,overridable:false});a.applyMaterialToPath(X.cstAssociated.fixed.getPathElement(),W);X.objectsToMove.forEach(function(ab){var ad=T.createOverride(ab.path);if(!V){var af=T.createOverride(X.cstAssociated.fixed.getPathElement());af.setOpacity(1,true);af.setPickability("PICKABLE");ad.setOpacity(1,true);ad.setPickability("PICKABLE");var ae=G(X.cstAssociated.fixed.getPathElement());if(ae&&ae.axisBagNode){if(ae.axisBagNode.isVisible()){Q=ae.axisBagNode}}}var ac=new m.Matrix4().copy(ab.initWorldMatrix).multiply(Z);var aa=new m.Matrix4().getInverse(ab.path.getParentPath().getWorldMatrix());ad.setPosition(new m.Matrix4().copy(aa).multiply(ac))});X.preview=r(X);a.applyMaterialToPath(X.cstAssociated.fixed.getPathElement(),null);V=true});I.setRobotVisibility(true);if(Q){Q.setVisibility(true)}I.getViewer().setShadow(N);I.getViewer().setGrid(O);I.getViewer().setMirror(S);I.getViewer().getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(T);if(R){R.displayBoxes(true)}};var z=function(M){B.setDisplayFlag(false);M.thumbnail.setDisplayFlag(true);B=M.thumbnail};var J=function(O){if(O.color){var M=new m.MeshBasicMaterial({side:m.DoubleSide,color:O.color,transparent:true,depthWrite:false,depthTest:false,opacity:0.9,overridable:false});a.applyMaterialToPath(O.path,M);var N=800;if(F===O.color){N=1600}A=setTimeout(function(){clearTimeout(A);A=null;J(x)},N);x={path:O.path}}else{a.applyMaterialToPath(O.path,null);x={}}I.getViewer().render()};var D=function(N){var O;for(var M=0;M<s.thumbs.length;M++){if(s.thumbs[M].getThumbnailID()==="3DComposeConstraintsThumb_"+N.data.cstType){O=s.thumbs[M];break}}if(O&&B!==O&&!y.isRunning()){z({thumbnail:O});L.publish({event:"onAlternativeClick",data:N.data})}};var E=function(O){while(s.div.firstChild){s.div.firstChild.destroy();s.div.removeChild(s.div.firstChild)}for(var N=0;N<s.thumbs.length;N++){s.thumbs[N].clear()}s.thumbs.length=0;v(O.snapAlternatives);var M=i.getOption("cstDefaultType");O.snapAlternatives.forEach(function(P){var Q=new n({id:"3DComposeConstraintsThumb_"+P.cstType,data:{cstType:P.cstType},width:250,height:190,title:g[P.cstType],icon:u+"I_3DCompose"+P.cstType+".png",preview:P.preview,displayFlag:P.cstType===M,clickCB:D});s.thumbs.push(Q);s.div.appendChild(Q.getContent());if(P.cstType===M){B=Q}})};this.refreshView=function(N){if(!s.div){s.div=h.createElement("div")}if(!H){var M={id:"CAT3DComposeConstraintsViewPanel",className:"CAT3DComposeConstraintsViewPanel",title:g.sidePanel,showTitleFlag:false,icon:f.getWebappsAssetUrl("CAT3DComposeConstraints","icons/32/")+"I_3DComposecstContact.png",immersiveFrame:w.window.getImmersiveFrame(),content:s.div,minWidth:270,width:270,minHeight:410,height:410,resizableFlag:false,snappableFlag:false,position:{at:"top right"},allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea};H=new p(M)}E(N)};this.setUpMeshColor=function(M){if(A){clearTimeout(A);A=null;J(x)}if(M.result.rc===0&&!M.result.redundancy){J({path:M.path,color:K})}else{J({path:M.path,color:F})}};this.clear=function(){if(H){H.destroy();H=null}};this.subscribe=function(M,N){if(M==="onAlternativeClick"){return L.subscribe({event:M},N)}return undefined}}});return o});define("DS/CAT3DComposeConstraints/CAT3DComposeConstraintsController",["UWA/Core","UWA/Class","DS/CAT3DComposeUtils/CAT3DCompose3DAnimation","DS/CATC3DGeometry/CATC3DGeometryEnums","DS/Visualization/ThreeJS_DS","DS/CAT3DComposeWidget/CAT3DComposeWidgetOptions","DS/CAT3DComposeMoveManager/CATC3DMoveReferent","DS/CAT3DComposeMoveManager/CAT3DComposeMoveManager","DS/CAT3DComposeBoxes/CAT3DComposeBoxController","DS/CAT3DComposeConstraints/CAT3DComposeConstraintsView","DS/CATRelatedData3DGrid/CATRelatedData3DGridController"],function(l,m,c,e,k,h,g,d,j,n,a){var f=m.extend({init:function(p){var t=null,v=null,G=[],z=[],A=["cstContact","cstCoincidence"],E;h.setOption("cstDefaultType",A[0]);var y=p.context;if(!y){window.console.log("A context must be defined");return}var r=d.getMoveManager({context:y});var H=g.getMoveReferentManager({context:y});var D=y.getFrameWindow();if(!D){window.console.log("A window must be defined");return}var w=D.getViewer(),C;var u=function(){require(["DS/CAT3DComposeConstraints/CAT3DComposeConstraintsModel"],function(I){C=new I({context:y})})};var o=new n({window:D,viewer:w,context:y});var s=y.getRootBagPath().getChildrenPathes();if(s.length){u()}else{var F=y.subscribe({event:"onRootAdded"},function(){u();y.unsubscribe(F)})}var B=function(){var M=[];var L=h.getOption("cstDefaultType");var I=C.getLastCst();M.push({alternativePosition:z[0].initWorldMatrix,objectsToMove:z,cstType:L,cstAssociated:I});var K=I.movable.getType(),J=I.fixed.getType();if((K===e.GeometryType.PLANE||K===e.GeometryType.REFPLANE)&&(J===e.GeometryType.PLANE||J===e.GeometryType.REFPLANE)){A.forEach(function(P){if(P!==L){C.deleteLastCst();var R=C.createCst({movable:I.movable,fixed:I.fixed,cstType:P});var Q=C.simulateSolveCst().matrix;if(Q){var N=Q.multiply(new k.Matrix4().copy(z[0].initWorldMatrix));var O={alternativePosition:N,objectsToMove:z,cstType:P,cstAssociated:R};if(P==="cstCoincidence"){M.push(O)}else{M.unshift(O)}}}});C.deleteLastCst();C.createCst({movable:I.movable,fixed:I.fixed,cstType:I.cstType})}return M};r.subscribe("MoveBegin",function(I){if(I.objectsMoved.length>0){z=[];I.objectsMoved.forEach(function(J){z.push(J)})}});r.subscribe("MoveEnd",function(I){if(C&&C.count()>0&&z.length>0){z.forEach(function(J){var K=H.getMoveReferent(J.path);J.initWorldMatrix=K.getWorldMatrix();J.initMatrix=K.getLastElement(true).getMatrix()});if(I.status==="Moved"){if(I.from!==C){G=B()}if(G.length>1){if(I.from!==C){o.refreshView({snapAlternatives:G})}}else{o.clear()}}}});var q=c.get3DComposeAnimationEngine({viewer:w});var x=function(N){if(!C){return}var K=j.getBoxController({context:y}),M;if(K){M=K.getDisplayState();K.displayBoxes(false)}h.setOption("cstDefaultType",N.cstType);var I=C.getLastCst();C.deleteLastCst();C.createCst({movable:I.movable,fixed:I.fixed,cstType:N.cstType});var J=null;G.some(function(O){if(O.cstType===N.cstType){J=O;return true}return false});var L=a.give3DGridController({context:y});C.moveWithCst({alternative:J,objectsToMove:z,callBackFct:function(O){if(L){L.hide3DGrids()}q.addAnimation({animationType:"snap",createOverrideSet:true,objectListToAnimate:O.objectsToMove,callBackFct:function(){O.callBackAfterAnim();if(M&&K){K.displayBoxes(true)}if(L){L.display3DGrids()}}});q.startAnimation()}})};o.subscribe("onAlternativeClick",x);this.isLevelConstrained=function(I){if(!v||!I){return false}return v.isEqual(I)};this.createCst=function(N){if(!N||!N.movable||!N.fixed||!C){return undefined}var O=N.movable.equivalentGeometry;var L=N.fixed.equivalentGeometry;if(!O||!L){return undefined}var M=N.cstType,K=O.getType(),J=L.getType();if((K===e.GeometryType.PLANE||K===e.GeometryType.REFPLANE)&&(J===e.GeometryType.PLANE||J===e.GeometryType.REFPLANE)){M=h.getOption("cstDefaultType");if(!M){M="cstContact"}}var I=C.createCst({movable:O,fixed:L,cstType:M});v=H.getMoveReferent(I.movable.getPathElement());return I};this.deleteLastCst=function(){if(!C){return}t=C.getLastCst();C.deleteLastCst()};this.restoreLastDeletedCst=function(){if(!C){return}C.createCst({movable:t.movable,fixed:t.fixed,cstType:t.cstType})};this.deleteAllCst=function(){if(!C){return}C.deleteAllCst();if(o){o.clear()}t=null;v=null};this.count=function(){return C?C.count():undefined};this.simulateMoveWithCst=function(I){if(!I||(!I.translation&&!I.rotation)||!C){return undefined}var J=C.simulateMoveWithCst(I);return J};this.simulateSolveCst=function(){if(!C){return undefined}var N=C.simulateSolveCst();var M=N.rc;var I=C.getLastCst();if(M!==0&&I){var L=I.movable.getType(),K=I.fixed.getType();if((L===e.GeometryType.PLANE||L===e.GeometryType.REFPLANE)&&(K===e.GeometryType.PLANE||K===e.GeometryType.REFPLANE)){C.deleteLastCst();var J=null;A.some(function(O){if(O!==I.cstType){J=O;return true}return false})}C.createCst({movable:I.movable,fixed:I.fixed,cstType:J});N=C.simulateSolveCst()}o.setUpMeshColor({result:N,path:I.fixed.getPathElement()});return N};this.isThereACstSuppportingReverseDirection=function(I){return I&&C&&C.getConstraintForReverseDirection(I)};this.simulateReverseDirection=function(I){return C?C.simulateReverseDirection(I):null};this.getAxisTypeIfCstOnProductAxis=function(I){if(!I||!C){return undefined}return C.getAxisTypeIfCstOnProductAxis(I)};this.simulateSwitchAxis=function(J,I){return C?C.simulateSwitchAxis(J,I):null};this.getProductAxisForConstraint=function(){if(!E){var I=localStorage.getItem("PrdAxisForCst");E=I==="Y"?e.GeometryType.AXISY:I==="Z"?e.GeometryType.AXISZ:e.GeometryType.AXISX}return E};this.setProductAxisForConstraint=function(I){if(I===e.GeometryType.AXISX||I===e.GeometryType.AXISY||I===e.GeometryType.AXISZ){E=I;localStorage.setItem("PrdAxisForCst",I===e.GeometryType.AXISY?"Y":I===e.GeometryType.AXISZ?"Z":"X")}}}});var i=[],b=function(o){var p;if(o&&o.context){p=null;i.some(function(q){return(q.context===o.context)?(p=q):false})}return p};return m.singleton({init:function(){},giveConstraintsController:function(o){var p=b(o);return p?p.enveloppe:p},getConstraintsController:function(o){var q,p=b(o);if(p){p.count++;q=p.enveloppe}else{if(p===null){p={count:1,context:o.context,cstCtrl:new f(o),enveloppe:{unreference:function(){p.count--;if(p.count===0){p.cstCtrl=p.context=null;i.splice(i.indexOf(p),1)}}}};Object.keys(p.cstCtrl).forEach(function(r){var s=this;if(typeof s.cstCtrl[r]==="function"){s.enveloppe[r]=function(){var t;if(s.cstCtrl){t=s.cstCtrl[r].apply(s.cstCtrl,arguments)}else{window.console.log("Unexpected call")}return t}}},p);q=Object.freeze(p.enveloppe);i.push(p)}}return q}})});define("DS/CAT3DComposeCommands/CATC3DReverseDirectionCmd",["DS/ApplicationFrame/Command","DS/Selection/CSOManager","DS/Visualization/ThreeJS_DS","DS/PADUtils/PADContext","DS/CAT3DComposeMoveManager/CATC3DMoveReferent","DS/CAT3DComposeConstraints/CAT3DComposeConstraintsController","DS/CAT3DComposeMoveManager/CAT3DComposeMoveManager","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(a,e,i,h,g,f,c,b){var d=a.extend({init:function(j){this._parent(j,{mode:"shared",isAsynchronous:false});this.setRepeatMode(false);this.execute=function(){var o=e.get();if(!o.length){return}var n=h.get(),q=c.getMoveManager({context:n}),s=g.getMoveReferentManager({context:n}),m=f.giveConstraintsController({context:n}),t,l=o.some(function(x){t=s.getMoveReferent(x.pathElement);var w;if(m&&t&&(w=t.getLastElement(true))&&b.isInstance(w)&&w.children.length>0){t.addElement(w.children[0]);return m.isThereACstSuppportingReverseDirection(t)}return false});if(l&&t&&m){var p=m.simulateReverseDirection(t)||{};var r=p.matrix||new i.Matrix4(),u=new i.Matrix4(),k=p.rc,v=p.redundancy;if(k===0&&!v){q.onMoveBegin({objectsMoved:o,from:this,moveMode:"Persistent"});o.forEach(function(w){q.onMove({objectsMoved:[{path:w.pathElement}],from:this,worldMatrix:u.multiplyMatrices(r,w.pathElement.getWorldMatrix())})},this);q.onMoveEnd({from:this,status:"Moved"})}}}}});return d});
/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/CAT3DComposeDirectMove/CAT3DComposeDirectMove",["UWA/Core","UWA/Class","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/CATC3DGeometry/CATC3DEquivalentGeometry","DS/Manipulators/ScreenPlaneManipulator","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/Mesh/MeshUtils","DS/SceneGraphNodes/AxisSystemNode","DS/CAT3DComposeConstraints/CAT3DComposeConstraintsController","DS/CAT3DComposeCommands/CATC3DDefaultSelectionFilter","DS/CAT3DComposeUtils/CAT3DCompose3DAnimation","DS/CAT3DComposeWidget/CAT3DComposeWidgetOptions","DS/CAT3DComposeMoveManager/CATC3DMoveReferent","DS/CAT3DComposeMoveManager/CAT3DComposeMoveManager","DS/CATRelatedData3DGrid/CATRelatedData3DGridController","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/SceneGraphUtils","DS/CATC3DGeometry/CATC3DGeometryEnums","css!DS/CAT3DComposeCommands/CAT3DComposeCommands.css"],function(s,u,k,t,i,a,v,l,g,m,p,h,j,d,e,q,f,o,r,w){var c=10;var b=u.extend({init:function(){var y=false;var R;var L=null;var ac=null;var ax=null;var B=this;var P={};var ar=[];var aA="";var al=null;var ae=true;var x=null;var U=null;var am={};var Y=3394815;var az=false;var I={};var aq=[];var ak=null;var V=null;var Z=null;var ab=null;var O=null;var an=null;var A=null;var J=null;var F=null;var G=null;var av=null;var at=null;var aa=null;var ay=!d.getOption("animationOff");var E=false;var af={};var ai=false;var ag=null;var H=false;var X=null;var M=null;var au=function(){var aB=R.getRootBagPath();return aB?aB.getLastElement(true):null};var ap=function(aC){var aB=R.getRootBagPath();return aB.isAParentOf(aC)};var aj=new l("LocalAxisSystemNode");aj.exludeFromBounding(true);aj.setVisibilityInTree(false);aj.setPickable(g.NODRAWHL);aj.setVisibility(false);aj.setVisibilityFree(true);aj.updateDisplay=function(aB){if(aj.parents.length===0){ax.addNode(aj)}if(aB.visibility&&aB.pathElement&&aj.pathElement!==aB.pathElement){aj.pathElement=aB.pathElement;aj.setMatrix(aB.pathElement.getWorldMatrix());aj.setVisibility(true)}if(!aB.visibility){aj.pathElement=null;aj.setVisibility(false)}};var N=function(){var aB=au();if(!aB){return}if(A&&J){A.unlink(J);J=A.linkToNode(aB)}};var K=function(){ak=R.subscribe({event:"onRootAdded"},function(){N()});V=R.subscribe({event:"onRootRemoved"},function(){N()});Z=R.subscribe({event:"onRootAttached"},function(){N()});ab=R.subscribe({event:"onRootDetached"},function(){N()});O=R.subscribe({event:"onModelUpdated"},function(){N()})};var Q=function(){if(R){R.unsubscribe(ak);R.unsubscribe(V);R.unsubscribe(Z);R.unsubscribe(ab);R.unsubscribe(O);V=ak=Z=ab=O=null}};var D=function(aC){if(aC.color){var aB=new v.MeshBasicMaterial({side:2,forceSide:true,color:aC.color,transparent:true,depthWrite:false,depthTest:false,opacity:0.6,overridable:false});r.applyMaterialToPath(aC.path,aB)}else{r.applyMaterialToPath(aC.path,null)}};var S=function(aD){aD.objectToMove.override.setColor("#ffffff",false);var aB=function(aE){if(aD.objectToMove&&at&&!ai&&aE){aD.objectToMove.override.setColor("#E3004C",false);ax.render()}};var aC=L.isPathLocked({pathElement:aD.objectToMove.path,onCompleted:function(aE){if(!af.isRunning()){aB(aE.isLocked)}}});if(aC.returnCode===0&&aC.hasOwnProperty("isLocked")){aB(aC.isLocked);aB=function(){}}};var ao=function(){if(at){ax.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(at);at=null}if(az){aq.forEach(function(aB){if(aB.path){k.add({pathElement:aB.path})}});L.onMoveEnd({from:B,status:aA});if(x&&(x.simulateReverseDirection(P.pathElement)||x.getAxisTypeIfCstOnProductAxis(P.pathElement))){R.getFrameWindow().getContextualUIManager().showContextualBar({hideWithDistance:true})}}else{if(P.pathElement){if(!I.partIsInCSO){t.add({pathElement:P.pathElement,event:al});R.getFrameWindow().getContextualUIManager().showContextualBar({hideWithDistance:true})}}}if(aa){aa.display3DGrids()}an=null;y=false;P={};az=false;I={};U=null;am={};aA="";aq=[];ar=[];ai=false;if(ay){E=false;H=false}};var T={panInterval:undefined,viewpoint:undefined,panDuration:100,x:undefined,y:undefined},ad=function(){if(T.panInterval){clearInterval(T.panInterval)}T.panInterval=undefined;T.viewpoint=undefined;T.x=undefined;T.y=undefined;T.div=T.div?T.div.destroy():undefined;T.divL=T.divT=T.divR=T.divB=undefined},aw=function(aD){function aE(){if(!T.viewpoint){T.viewpoint=ax.currentViewpoint}if(T.viewpoint&&T.viewpoint.control&&T.x!==undefined&&T.y!==undefined){var aK=new v.Vector3(T.x,T.y,0),aJ,aH;aK.applyQuaternion(T.viewpoint.control.orientation);aK.setLength(0.05*T.viewpoint.control.distanceToTarget);aJ=T.viewpoint.target.clone().add(aK);aH=T.viewpoint.control.distanceToTarget;T.viewpoint.moveTo({eyePosition:aJ.add(T.viewpoint.getCamera().getLookAt().normalize().multiplyScalar(-aH)),duration:ay?T.panDuration:0});if(!T.div){var aG=R.getFrameWindow().getUIFrame();T.div=s.createElement("div",{id:"C3D-viewpoint",styles:{top:ax.SCREEN_HEIGHT/2+"px",left:ax.SCREEN_WIDTH/2+"px"}}).inject(aG);var aI=function(aM){var aN=s.createElement("div",{"class":aM.side}).inject(T.div);aN.setStyle(aM.posKey,aM.posValue+"px");var aL=s.createElement("div",{"class":"arrow"}).inject(aN);s.createElement("div",{"class":"borderBottom"}).inject(aL);s.createElement("div",{"class":"borderRight"}).inject(aL);return aN};var aF=Math.min(ax.SCREEN_WIDTH/10,ax.SCREEN_HEIGHT/10);T.divL=aI({side:"left",posKey:"left",posValue:-aF});T.divT=aI({side:"top",posKey:"top",posValue:-aF});T.divR=aI({side:"right",posKey:"left",posValue:aF});T.divB=aI({side:"bottom",posKey:"top",posValue:aF})}if(T.x<0){T.divL.addClassName("active")}else{T.divL.removeClassName("active")}if(T.x>0){T.divR.addClassName("active")}else{T.divR.removeClassName("active")}if(T.y<0){T.divB.addClassName("active")}else{T.divB.removeClassName("active")}if(T.y>0){T.divT.addClassName("active")}else{T.divT.removeClassName("active")}}}var aC=aD.event.gesture?aD.event.gesture.getEvents()[0]:aD.event.from[0];var aB=aC.getCurrentPosition(R.getViewer().canvas);T.x=(aB.x<=c-1)?-1:((aB.x>=ax.SCREEN_WIDTH-c-1)?1:0);T.y=(aB.y<=c-1)?1:((aB.y>=ax.SCREEN_HEIGHT-c-1)?-1:0);if(T.x===0&&T.y){T.x=(aB.x<ax.SCREEN_WIDTH/3)?-1:((aB.x>2*ax.SCREEN_WIDTH/3)?1:0)}else{if(T.y===0&&T.x){T.y=(aB.y<ax.SCREEN_HEIGHT/3)?1:((aB.y>2*ax.SCREEN_HEIGHT/3)?-1:0)}}if(T.x||T.y){clearInterval(T.panInterval);T.panInterval=setInterval(function(){aE()},T.panDuration);aE();return 1}else{ad()}return 0};var z;function ah(){if(!R||A){return}z=h.getDefaultSelectionFilter({context:R});z.activate();K();var aC=R.getFrameWindow();L=q.getMoveManager({context:R});ac=e.getMoveReferentManager({context:R});if(!x){x=p.getConstraintsController({context:R})}X=L.subscribe("onValidateMove",function(){if(x){x.deleteAllCst()}});M=L.subscribe("onCancelMove",function(aD){if(x&&aD.objectsCancelled.some(function(aE){return x.isLevelConstrained(aE.path)})){x.deleteAllCst()}});if(!aC){window.console.log("A frame window must be defined");return}if(!L){window.console.log("A move manager component must be defined");return}if(!ac){window.console.log("A move referent component must be defined");return}ax=aC.getViewer();af=j.get3DComposeAnimationEngine({viewer:ax});if(A&&J){A.unlink(J);J=A.linkToNode(au());return}else{A=new a();if(A.setPrePickingDuringManipulation){A.setPrePickingDuringManipulation(true)}if(A.setPreActivationDuringManipulation){A.setPreActivationDuringManipulation(true)}if(A.setPickingDuringManipulation){A.setPickingDuringManipulation(true)}A.setExclusive(true);J=A.linkToNode(au())}F=A.subscribe("BeginManipulate",function(aF){if(af.isRunning()){return}at=new o(R.getRootBagPath().externalPath[0]);ax.getSceneGraphOverrideSetManager().pushSceneGraphOverrideSet(at);ax.setCursor("pointer");y=aF.event.gesture.events[0].event.ctrlKey;if(z){var aE=ax.pick(ax.getMousePosition(aF.event.from[0].currentPosition),"primHybrid",false);P=z.filterPath({pathElement:aE.path[0]});P.pathReferent=ac.getMoveReferent(aE.path[0])}if(!P.pathElement||!P.pathReferent){return}al=aF.event;aq.push({path:P.pathElement});var aD=t.get();if(aD){aD.slice(0).forEach(function(aG){if(aG.pathElement){if(!aG.pathElement.isEqual(P.pathElement)){if(y){if(aG.pathElement.isAParentOf(P.pathElement)){I.fatherIsInCSO=true}aq.push({path:aG.pathElement})}else{t.remove({pathElement:aG.pathElement,event:aF.event});k.remove({pathElement:aG.pathElement})}}else{I.partIsInCSO=true}}})}aq.forEach(function(aG){if(aG.path){var aI=ar.slice(0).some(function(aJ){if(aJ.path){if((!aJ.path.isEqual(aG.path)&&aJ.path.isAParentOf(aG.path))||!ap(aG.path)){return true}}return false});if(!aI){var aH=ac.getMoveReferent(aG.path);ar.push({path:aH,override:at.createOverride(aH),initWorldMatrix:aH.getWorldMatrix(),initMatrix:aH.getLastElement(true).getMatrix(),selectionWorldMatrix:P.pathElement.getWorldMatrix(),isAxisSystem:P.pathElement.externalPath.some(function(aJ){return aJ.name==="AxisSystems"})})}}})});G=A.subscribe("Manipulate",function(aJ){if(af.isRunning()){return}ax.setCursor("pointer");if(aJ.event.from[0].currentPosition.equals(aJ.event.from[0].lastPosition)){return}if(!aa){aa=f.give3DGridController({context:R})}if(aa){aa.hide3DGrids()}if(ar.length>0){var aP=aJ.intersection.path[0];if(!az){if(!I.partIsInCSO){t.add({pathElement:P.pathElement})}aq.forEach(function(aQ){if(aQ.path){k.remove({pathElement:aQ.path})}});L.onMoveBegin({objectsMoved:ar,from:B,moveMode:"Transient"});ar.forEach(function(aQ){if(aQ.path){aQ.override.setPickability("IGNORED")}});ax.render();if(!P.equivalentGeometry){P.equivalentGeometry=i.getEquivalentGeometry({pathElement:P.pathReferent,axis:x.getProductAxisForConstraint()})}if(ay){af.addAnimation({animationType:"opacityOn",objectListToAnimate:ar,callBackFct:function(){if(P.equivalentGeometry&&P.equivalentGeometry.getMode()===w.GeometryMode.REAL){D({path:P.pathElement,color:Y})}ar.forEach(function(aQ){if(aQ.path){S({objectToMove:aQ})}})}});af.startAnimation()}else{if(P.equivalentGeometry&&P.equivalentGeometry.getMode()===w.GeometryMode.REAL){D({path:P.pathElement,color:Y})}ar.forEach(function(aQ){if(aQ.path){aQ.override.setOpacity(0.35,false);S({objectToMove:aQ})}})}if(x){if((x.count()>0&&!P.equivalentGeometry)||(x.count()>0&&!x.isLevelConstrained(P.pathReferent))){x.deleteAllCst()}}az=true}if(aw({event:aJ.event})){return}var aK=ax.pick(ax.getMousePosition(aJ.event.from[0].currentPosition),"primHybrid",false);var aG={pathElement:aK.path[0]};if(z){z.filterPath(aG)}var aH=false;if(aG.pathElement&&am.pathElement){aH=am.pathElement.isEqual(aG.pathElement)}am=aG;if(U&&!aH){x.deleteLastCst();U=null}var aF={},aE=null,aN=null;if(aG.pathElement!==undefined&&(aP&&!P.pathReferent.isAParentOf(aP))){aE=P.equivalentGeometry&&P.equivalentGeometry.getType()!==w.GeometryType.AXISSYSTEM;aN=aG.equivalentGeometry&&aG.equivalentGeometry.getType()!==w.GeometryType.AXISSYSTEM;if(aG.pathElement!==null&&!P.pathReferent.isAParentOf(aG.pathElement)&&aN&&aE){if(!aH){U=x.createCst({movable:P,fixed:aG});var aO=x.simulateSolveCst();if(aO){var aI=aO.matrix;aF.rc=aO.rc;aF.redundancy=aO.redundancy;if(aF.rc===0&&aI&&!aF.redundancy){aF.matrix=aI.multiply(P.pathReferent.getWorldMatrix())}else{if(aF.rc!==0||aF.redundancy){x.deleteLastCst();U=null}}am=aG}else{am={}}}}else{if(aG&&aG.pathElement){aF.matrix=aG.pathElement.getWorldMatrix();if(aG.pathElement.externalPath.some(function(aQ){return aQ.name==="AxisSystems"})){aF.isAxisSystem=true;aj.updateDisplay({visibility:false})}else{aj.updateDisplay({pathElement:aG.pathElement,visibility:true})}}}}if(aF.matrix){var aM;if(aF.isAxisSystem&&ar[0].isAxisSystem){var aL=new v.Matrix4().copy(aF.matrix);aL.multiply(new v.Matrix4().getInverse(ar[0].selectionWorldMatrix));aL.multiply(ar[0].initWorldMatrix);aM=new v.Matrix4().getInverse(ar[0].initWorldMatrix).multiply(aL)}else{aM=new v.Matrix4().getInverse(ar[0].initWorldMatrix).multiply(aF.matrix);aM.multiply(new v.Matrix4().getInverse(P.pathElement.getLastElement(true).getMatrix()))}ar.forEach(function(aW,aT){var aX=new v.Matrix4().copy(aW.initWorldMatrix).multiply(aM);if(aW.path){var aR=new v.Matrix4().getInverse(aW.path.getParentPath().getWorldMatrix());var aQ=new v.Matrix4().copy(aR).multiply(aX);var aZ=null;if(aW.snappedPosition){aZ=new v.Matrix4().copy(aW.snappedPosition)}var aU=aZ&&aZ.equals(aQ);aW.snappedPosition=new v.Matrix4().copy(aQ);if(ay){var aY=new v.Matrix4().copy(aW.initWorldMatrix);var aV=(new v.Vector3().getPositionFromMatrix(aW.initWorldMatrix)).add(aJ.translationVector);aY.setPosition(aV);var aS=new v.Matrix4().copy(aR).multiply(aY);if(!ai){aW.currentPosition=new v.Matrix4().copy(aS);if((x&&x.count()<=1&&aN&&aE)||(!aN&&!aE)||(aN&&!aE)){aW.override.setPosition(aS)}}else{if(!aU){aW.currentPosition=aQ}}if(aT===0){aW.snappedTarget=aG.pathElement;if(!aU&&aG.pathElement&&!aW.snappedTarget.isEqual(aG.pathElement)){clearTimeout(ag);ag=null}if(!ag&&(!aU||!ai)){ag=setTimeout(function(){af.addAnimation({animationType:"snap",objectListToAnimate:ar,callBackFct:function(){ai=true;ag=null;if(H){ao()}}});af.addAnimation({animationType:"opacityOff",offsetTime:af.getDefaultDuration("snap"),objectListToAnimate:ar,callBackFct:function(){ar.forEach(function(a0){a0.override.setColor(null,false)});if(P.equivalentGeometry){D({path:P.pathElement})}}});af.startAnimation()},500)}}}else{aW.override.setPosition(aQ);ai=true}}});ae=false;L.onMove({objectsMoved:ar,transformation:aM,from:B})}else{if(aj){aj.updateDisplay({visibility:false})}if(aG.pathElement===undefined||aG.pathElement===null||(aF.rc&&aF.rc!==0)||aF.redundancy){ae=true;L.onMove({objectsMoved:ar,vector:aJ.translationVector,from:B})}else{if(aN&&aE&&aF.rc===0){ae=false}}if(aG.pathElement!==undefined||aG.pathElement!==null){var aD=null;ar.forEach(function(aZ,aV){if(aZ.path){var aQ=null;if(x.count()===0||(x.count()===1&&U)){var a1=new v.Matrix4().copy(aZ.initWorldMatrix);var aY=(new v.Vector3().getPositionFromMatrix(aZ.initWorldMatrix)).add(aJ.translationVector);a1.setPosition(aY);var a2=aZ.path.getParentPath().getWorldMatrix();var aU=new v.Matrix4().getInverse(a2);aQ=aU.multiply(a1);if(!ai){aZ.override.setPosition(aQ)}aZ.currentPosition=new v.Matrix4().copy(aQ)}else{if(aV===0){aD=null;if(U){x.deleteLastCst()}var aT=new v.Vector3().addVectors(aJ.translationVector,A.initial3dIntersectionPoint);var aS=null;if(an){aS=new v.Vector3().subVectors(aJ.translationVector,an)}else{aS=aJ.translationVector}an=aJ.translationVector;var aW=x.simulateMoveWithCst({movableReference:aT,translation:aS});if(aW&&aW.rc===0&&aW.matrix){aD=aW.matrix.multiply(P.pathReferent.getWorldMatrix())}if(U){x.restoreLastDeletedCst()}}if(aD){var aX=new v.Matrix4().getInverse(ar[0].initWorldMatrix).multiply(aD);var a0=new v.Matrix4().copy(aZ.initWorldMatrix).multiply(aX);var aR=new v.Matrix4().getInverse(aZ.path.getParentPath().getWorldMatrix());aQ=new v.Matrix4().copy(aR).multiply(a0);if(!ai){aZ.override.setPosition(aQ)}}aZ.currentPosition=new v.Matrix4().copy(aZ.initMatrix)}}});if(ay){if(!aH){if(ag){clearTimeout(ag);ag=null}if(ai&&ae){af.addAnimation({animationType:"unsnap",objectListToAnimate:ar,callBackFct:function(){ai=false;ar.forEach(function(aQ){aQ.snappedPosition=null})}});af.addAnimation({animationType:"opacityOn",objectListToAnimate:ar,offsetTime:af.getDefaultDuration("unsnap"),callBackFct:function(){if(P.equivalentGeometry){D({path:P.pathElement,color:Y})}ar.forEach(function(aQ){if(aQ.path){S({objectToMove:aQ})}})}});af.startAnimation()}}}else{if(ai&&ae){ar.forEach(function(aQ){if(aQ.path&&aQ.currentPosition){aQ.override.setPosition(aQ.currentPosition)}});ai=false}}}}ax.render()}});av=A.subscribe("EndManipulate",function(aE){ad();if(!ae){ae=false;aA="Moved"}else{aA="Cancelled"}if(aj){aj.updateDisplay({visibility:false})}if(!az){aq.forEach(function(aF){if(aF.path){if(aF.path.isEqual(P.pathElement)){if(I.partIsInCSO){if(y){t.remove({pathElement:P.pathElement,event:aE.event});k.remove({pathElement:P.pathElement})}else{t.remove({pathElement:P.pathElement,event:aE.event});t.add({pathElement:P.pathElement,event:aE.event});R.getFrameWindow().getContextualUIManager().showContextualBar({hideWithDistance:true})}}else{k.add({pathElement:P.pathElement})}}else{if(aF.path.isAParentOf(P.pathElement)){if(y){if(I.partIsInCSO){t.remove({pathElement:P.pathElement,event:aE.event});k.remove({pathElement:P.pathElement})}}}}}});ao()}else{if(ay){if(ag){clearTimeout(ag);ag=null}af.forward();af.addAnimation({animationType:"opacityOff",objectListToAnimate:ar,callBackFct:function(){ar.forEach(function(aF){aF.override.setColor(null,false)});if(P.equivalentGeometry){D({path:P.pathElement})}}});if(aA==="Cancelled"){var aD=ax.getSceneGraphOverrideSetManager();ar.forEach(function(aF){aF.currentMatrix=aD.computeAppliedPosition(aF.path)});af.addAnimation({animationType:"cancel",objectListToAnimate:ar,callBackFct:function(){ao()}})}else{if(ai){ao()}else{if(E){H=true}else{H=true;af.addAnimation({animationType:"snap",objectListToAnimate:ar,callBackFct:function(){ai=true;ag=false;if(H){ao()}}})}}}af.startAnimation()}else{ao()}}ax.render()});if(aj.getChildren().length===0){var aB=new m({headLength:10,arrowLength:50,arrowWidth:2,head:m.types.ARROW});aj.addChild(aB)}aj.updateDisplay({visibility:false});ax.render({updateInfinitePlane:true})}this.activate=function(aB){R=aB.context;ah()};function W(){ad();Q();if(X){L.unsubscribe(X);X=null}if(M){L.unsubscribe(M);M=null}if(A){A.unsubscribe(F);A.unsubscribe(G);A.unsubscribe(av);A.unlink(J);A=F=G=av=J=null}if(aj){aj.removeChildren()}if(z){z.deactivate()}}this.deactivate=function(){W();R=null};function C(){W();if(x){x.deleteAllCst();x.unreference()}if(z){h.unreferenceDefaultSelectionFilter({context:R});z=null}if(aj){ax.removeNode(aj);aj=null}R=null}this.unreference=C}});var n;return u.singleton({init:function(){},activate:function(x){if(x&&x.context&&x.context.name==="ENOPAD3DViewer"){if(!n){n=new b()}n.activate({context:x.context})}},deactivate:function(x){if(x&&x.context&&x.context.name==="ENOPAD3DViewer"){if(n){n.deactivate()}}},unreference:function(x){if(x&&x.context&&x.context.name==="ENOPAD3DViewer"){if(n){n.unreference()}n=null}}})});define("DS/CAT3DComposeCommands/CATC3DSwitchAxisCmd",["DS/ApplicationFrame/CommandCheckHeader","DS/ApplicationFrame/CommandsManager","DS/Selection/CSOManager","DS/PADUtils/PADContext","DS/Visualization/ThreeJS_DS","DS/CAT3DComposeConstraints/CAT3DComposeConstraintsController","DS/CAT3DComposeMoveManager/CATC3DMoveReferent","DS/CAT3DComposeMoveManager/CAT3DComposeMoveManager","DS/CATC3DGeometry/CATC3DGeometryEnums","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(k,a,e,i,j,g,h,d,f,b){var c=f.GeometryType;return k.extend({init:function(l){this._parent(l);var n,m;switch(l.ID){case"CATC3DSwitchAxisXHdr":n=c.AXISX;m=["CATC3DSwitchAxisYHdr","CATC3DSwitchAxisZHdr"];break;case"CATC3DSwitchAxisYHdr":n=c.AXISY;m=["CATC3DSwitchAxisXHdr","CATC3DSwitchAxisZHdr"];break;default:n=c.AXISZ;m=["CATC3DSwitchAxisXHdr","CATC3DSwitchAxisYHdr"];break}var o=this.onStateChange(function(){if(this.getState()){var r=g.giveConstraintsController({context:i.get()}),t=d.getMoveManager({context:i.get()}),w=h.getMoveReferentManager({context:i.get()});var u=e.get(),z,x;u.some(function(B){x=w.getMoveReferent(B.pathElement);var C;if(r&&x&&(C=x.getLastElement(true))&&b.isInstance(C)&&C.children.length>0){x.addElement(C.children[0]);return(z=r.getAxisTypeIfCstOnProductAxis(x))}return false});if(r&&z&&z!==n&&x){var s=r.simulateSwitchAxis(x,n)||{};var v=s.matrix||new j.Matrix4(),y=new j.Matrix4(),p=s.rc,A=s.redundancy;if(p===0&&!A){t.onMoveBegin({objectsMoved:u,from:this,moveMode:"Persistent"});u.forEach(function(B){t.onMove({objectsMoved:[{path:B.pathElement}],from:this,worldMatrix:y.multiplyMatrices(v,B.pathElement.getWorldMatrix())})},this);t.onMoveEnd({from:this,status:"Moved"});r.setProductAxisForConstraint(n)}}var q=i.get();m.forEach(function(B){a.getCommandCheckHeader(B,q.getCommandContext?q.getCommandContext():null).setState(false)})}});this._destroy=function(){this._modelEvents.unsubscribe(o);Object.getPrototypeOf(this)._destroy.call(this);o=m=null}},toggleState:function(){if(!this.getState()){this.setState(true,true)}},_destroy:function(){this._parent()}})});
/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/CAT3DComposeRobot/CAT3DComposeRobot",["UWA/Class","DS/Visualization/ThreeJS_DS","DS/Robot/FreeRobot","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/Selection/PSOManager","DS/SceneGraphNodes/AxisSystemNode","DS/Mesh/MeshUtils","DS/CAT3DComposeConstraints/CAT3DComposeConstraintsController","DS/CoreEvents/Events","DS/Visualization/Node3D","DS/CAT3DComposeCommands/CATC3DDefaultSelectionFilter","DS/CATC3DGeometry/CATC3DGeometryEnums","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/CAT3DComposeMoveManager/CATC3DMoveReferent","DS/CAT3DComposeMoveManager/CAT3DComposeMoveManager","DS/CATRelatedData3DGrid/CATRelatedData3DGridController","DS/Visualization/PathElement"],function(C,D,r,l,A,v,q,g,s,t,p,i,E,m,e,w,f,y){var h=95;var a=150;var o=10,z=4,k=10;var u=function(H){if(!H||!H.externalPath){return false}for(var F=H.externalPath.length-1;F>=0;--F){var G=H.externalPath[F];if(m.isPLMNode(G)){break}if(G.name==="AxisSystems"){return true}}return false};var B=function(H,F,I){var G=z;H.setRatio(G/k);F=setInterval(function(){if(G===(k+1)){clearInterval(F);F=null;return}G++;H.setRatio(4*G/k);I.render()},o)};var b=function(F){var G=[];A.get().forEach(function(H){var I=F.getMoveReferent(H.pathElement);if(I){G.push({path:I})}});return G};var j=function(){A.get().forEach(function(F){if(!l.isIn(F)){l.add(F)}})};var x=function(){var F=A.get();F.forEach(function(G){l.remove(G)})};var c=function(F,H){F.scalingNodeX.setVisibility(false);F.scalingNodeY.setVisibility(false);F.scalingNodeZ.setVisibility(false);var G=(H&&H.hasOwnProperty("translate")&&(typeof H.translate==="boolean"))?H.translate:true;F.arrowX.setVisibility(G);F.arrowY.setVisibility(G);F.arrowZ.setVisibility(G);G=(H&&H.hasOwnProperty("rotate")&&(typeof H.rotate==="boolean"))?H.rotate:true;F.rotationArcXY.setVisibility(G);F.rotationArcXZ.setVisibility(G);F.rotationArcYZ.setVisibility(G);G=(H&&H.hasOwnProperty("translatePlane")&&(typeof H.translatePlane==="boolean"))?H.translatePlane:true;F.translationPlaneXY.setVisibility(G);F.translationPlaneXZ.setVisibility(G);F.translationPlaneYZ.setVisibility(G);G=(H&&H.hasOwnProperty("robotMove")&&(typeof H.robotMove==="boolean"))?H.robotMove:true;F.robotHandle.setVisibility(G)};var d=C.extend({init:function(ag){var ab=ag.context;var F=ab.getFrameWindow();var aL=F.getViewer();var U=w.getMoveManager({context:ab});var av=e.getMoveReferentManager({context:ab});var H=s.getConstraintsController({context:ab});var aQ=F.getContextualUIManager();var aC="";var aw=0;var J=new D.Vector3();var aT=function(aZ){var a0={};var aW=null;if(aZ.translationVector){aW=H.simulateMoveWithCst({translation:aZ.translationVector})}else{if(aZ.rotationMatrix){var aY=[[aZ.rotationMatrix.elements[0],aZ.rotationMatrix.elements[4],aZ.rotationMatrix.elements[8]],[aZ.rotationMatrix.elements[1],aZ.rotationMatrix.elements[5],aZ.rotationMatrix.elements[9]],[aZ.rotationMatrix.elements[2],aZ.rotationMatrix.elements[6],aZ.rotationMatrix.elements[10]]];aW=H.simulateMoveWithCst({rotation:aY})}}if(aW&&aW.matrix){var aX=new D.Matrix4().multiplyMatrices(aW.matrix,aZ.objectMoved.path.getWorldMatrix());a0.worldMatrix=aX}return a0};var aK=function(){var aW=A.get();if(aW.length>1||(H.count()>0&&aW.length===1&&!H.isLevelConstrained(av.getMoveReferent(aW[0].pathElement)))){H.deleteAllCst()}};var aG=true;var aj=i.getDefaultSelectionFilter({context:ab});if(!F){window.console.error("A frame window must be defined");return}if(!ab){window.console.error("A context must be defined");return}if(!U){window.console.error("A move manager component must be defined");return}if(!av){window.console.error("A move referent component must be defined");return}aL.setRobot(true,{snapOnFace:false,showOnlyManipulated:false});var ar=aL.getRobot();c(ar);ar.setAddToCSO(false);ar.setAddToHSO(false);ar.setDisplayScalingNodes(false);ar.setMoveMode("CALLBACK_ONLY");ar.setCheckTarget(false);ar.CallBackEventHandlerViewPoint();var Y=[],az=[],aH=[],W,L,P,ao,af,O={},R,am,aa=null,an=null,aN=[],X=[],ae={origin:new D.Vector3(),initOrigin:new D.Vector3(),direction:null,initValue:null,value:null},ak={origin:null,originVector:null,direction:null,initValue:null,value:null,path:null},aF=false,aU=null;var aS=function(){if(R){R.clear()}};var at=function(){if(am){am.clear()}};var ac=function(){if(az.length){return}az.push(U.subscribe("MoveBegin",function(){af=ar.getMatrix();ao=new D.Matrix4().getInverse(L.getWorldMatrix()).multiply(af)}));az.push(U.subscribe("Move",function(aX){if(ao&&af){if(aX.from===O){return}aS();at();if(this.isVisible()){this.setVisibility(false)}if(aX.moveMode==="Persistent"){var aW=L.getWorldMatrix().multiply(ao);ar.setMatrix(aW)}}}.bind(this)));az.push(U.subscribe("MoveEnd",function(aX){if(ao&&af){if(aX.status==="Cancelled"){ar.setRobotMatrix(af)}if(aX.from===O){return}this.setVisibility(true);if(aX.status==="Moved"){var aW=L.getWorldMatrix().multiply(ao);ar.setRobotMatrix(aW)}aU={};ao=af=undefined}}.bind(this)))}.bind(this);var N=function(){az.forEach(function(aW){U.unsubscribe(aW)});az.length=0};var Q=function(){ar.ScreenPlaneTranslationEndCB({intersection:{}})};var aB=function(aW){if(Array.isArray(aW)){if(L){aW.some(function(aY){var aX=U.getSubPathToMovable(aY.path);if(aX&&aX.isAParentOf(L)){Q();return true}return false})}return 0}return -1};var ai=function(aX){var aY=null;var aW=ab.getRootBagPath().getLastElement(true);aX.some(function(aZ){if(aZ.externalPath.some(function(a0){return aW===a0})){aY=aZ;return true}return false});return aY};var T=function(aY,a0){var a1={pathElement:null};var aX=ab.getRootBagPath().getLastElement(true);if(aX&&aY&&aY.externalPath&&aY.externalPath.some(function(a2){return aX===a2})){a1.pathElement=aY}if(a1.pathElement&&a0&&a0.event){var aZ=a0.event.gesture?a0.event.gesture.getEvents()[0]:a0.event.from[0];var aW=aL.pick(aL.getMousePosition(aZ.getCurrentPosition(aL.canvas)),"primHybrid",false);a1=aj.filterPath({pathElement:ai(aW.path)})}return a1};ar.setSnapFilterCallback(function(aX){var aW=T(aX);return aW.pathElement});ar.setSnapTranslationCallback(function(aX){if(R){var aW=R.getSnappedTranslationVector(aX);if(aW.returnCode!==0){return null}return aW.snappedTranslationVector}return aX.translationVector});ar.setSnapRotationCallback(function(aY){if(am){var aW=am.getSnappedRotationValue(aY);if(aW.returnCode!==0){return{value:undefined,axis:null}}return{value:aW.snappedRotationAngle,axis:aW.axis}}var aX=aY.angle*180/Math.PI;if(ak.direction.dot(aY.axis)<0){aX=360-aX}return{value:aX,axis:aY.axis}});var ad=function(){if(R){R.direction=null;R.origin=new D.Vector3();R.origin3DPos=null;R.setValue(0)}if(am){am.direction=null;am.origin=null;am.originVector=null;am.setValue(0)}aS();at()};var aA=new p("RobotLocalAxisSystem");var V=new q({headLength:10,arrowLength:50,arrowWidth:2,head:q.types.ARROW,colors:{colorX:new g.Color(1,0,0,0),colorY:new g.Color(0,1,0,0),colorZ:new g.Color(0,0,1,0)}});aA.exludeFromBounding(true);aA.setVisibilityFree(true);aA.setVisibilityInTree(false);aA.setPickable(g.NODRAWHL);aA.addChild(V);aA.updateDisplay=function(aW){if(aA.parents.length===0){aL.addNode(aA)}if(aW.visibility&&aW.pathElement&&aW.pathElement.internalPath.length===0){aA.setMatrix(aW.pathElement.getWorldMatrix());aA.setVisibility(true)}if(!aW.visibility){aA.setVisibility(false)}};aA.updateDisplay({visibility:false});var aD=null;var ap=new r("RobotLocalAxisSystem",aL,false,false);ap.exludeFromBounding(true);ap.setVisibilityFree(true);ap.setVisibilityInTree(false);ap.setPickable(g.NODRAWHL);ap.setVisibility(false);c(ap,{robotMove:false,translate:false});ap.updateDisplay=function(aW){if(ap.parents.length===0){aL.addNode(ap)}if(aW.visibility&&aW.pathElement){if(aD){clearInterval(aD);aD=null}ap.setMatrix(aW.pathElement.getWorldMatrix());B(ap.fixedSizeNode3D,aD,aL);ap.setVisibility(true);if(aG){ar.setVisibility(false)}}if(!aW.visibility){clearInterval(aD);aD=null;ap.setVisibility(false);if(aG){ar.setVisibility(true)}}};var aO=function(){require(["DS/LevelSelector/LevelSelector"],function(aW){aW.destroyView()});aQ.hideContextualMenus()};var I=function(){aO();if(L){var aW=[{name:"CAT3DComposeRobotLevelSelectorStr",line:1,hdr_list:["CAT3DComposeRobotLevelSelectorHdr"]}];var aX=b(av).some(function(aY){var aZ=aY.path.getMatrix();if(aZ.elements[0]!==1||aZ.elements[5]!==1||aZ.elements[10]!==1||aZ.elements[15]!==1||aZ.elements[1]!==0||aZ.elements[2]!==0||aZ.elements[3]!==0||aZ.elements[4]!==0||aZ.elements[6]!==0||aZ.elements[7]!==0||aZ.elements[8]!==0||aZ.elements[9]!==0||aZ.elements[11]!==0||aZ.elements[12]!==0||aZ.elements[13]!==0||aZ.elements[14]!==0){return true}return false});if(aX){aW.push({name:"CAT3DComposeSetIdentityPositionStr",line:1,hdr_list:["CAT3DComposeSetIdentityPositionHdr"]})}if(aW.length>0){aQ.showContextualBar({hideWithDistance:true,fillingList:[{onContextualBarReady:function(){return{cmdList:aW}},context:ab.getCommandContext?ab.getCommandContext():null,workbenchName:"CAT3DComposeWidgetWkb",module:"CAT3DComposeWidget",cmdPrefix:""}]})}}};var aP=function(aW){[ar.arrowX,ar.arrowY,ar.arrowZ,ar.translationPlaneYZ,ar.translationPlaneXY,ar.translationPlaneXZ,ar.rotationArcYZ,ar.rotationArcXZ,ar.rotationArcXY].forEach(function(aX){if(aX&&aX.manipulator&&aX.manipulator!==aW){aX.setToGhostState()}});ar.robotHandle.setToGhostState()};var aI=function(){ar.arrowX.mat.opacity=0.2;ar.arrowY.mat.opacity=0.2;ar.arrowZ.mat.opacity=0.2;ar.translationPlaneYZ.planeMat.opacity=0.2;ar.translationPlaneXY.planeMat.opacity=0.2;ar.translationPlaneXZ.planeMat.opacity=0.2;ar.rotationArcYZ.planeMat.opacity=0.2;ar.rotationArcXZ.planeMat.opacity=0.2;ar.rotationArcXY.privilegedPlaneMat.opacity=0.2};var aq=function(){ar.setToNonGhostState()};var K=function(){var aW=new y(L.externalPath);while(aW&&!m.isPLMNode(aW.getLastElement(true))){aW=aW.getParentPath()}if(!ak.path){ak.path=aW;return true}var aX=aW?aW.isEqual(ak.path):false;ak.path=aW;return aX};var aR,ay;var G=function(aX){var a2,a0,a3;if(aX.eventName==="RulerManipulateBegin"||aX.eventName==="AngularRulerManipulateBegin"){aO();x(L,U);aR=new D.Vector3();ay=0;var a4={objectsMoved:b(av),from:O,moveMode:"Persistent"};if(aX.eventName==="AngularRulerManipulateBegin"){aU={};a4.axis=new D.Vector3().copy(aX.direction);a4.center=new D.Vector3().getPositionFromMatrix(ar.getMatrix())}a3=f.give3DGridController({context:ab});if(a3){a3.hide3DGrids()}U.onMoveBegin(a4)}else{if(aX.eventName==="RulerManipulate"){aK();a2={objectsMoved:b(av),from:O};if(!aX.rulerDragged){j()}aR.add(aX.translationVector);ar.setMatrix(new D.Matrix4().copy(af).setPosition(new D.Vector3().getPositionFromMatrix(af).add(aR)));if(H.count()===0||a2.objectsMoved.length===0){a2.vector=aR}else{a0=aT({translationVector:aX.translationVector,objectMoved:a2.objectsMoved[0]});if(a0.worldMatrix){a2.worldMatrix=a0.worldMatrix}}U.onMove(a2);aL.render()}else{if(aX.eventName==="AngularRulerManipulate"){aK();a2={objectsMoved:b(av),from:O};if(!aX.rulerDragged){j()}var aZ=aX.diffAngle*Math.PI/180;ay+=aZ;var a1=new D.Matrix4().makeRotationAxis(aX.direction,ay).multiply(new D.Matrix4().extractRotation(af));ar.setMatrix(a1.setPosition(new D.Vector3().getPositionFromMatrix(af)));ak.value=am.value;var aY=new D.Matrix4().makeRotationAxis(aX.direction,aZ);if(H.count()===0||a2.objectsMoved.length===0){a2.angle=ay}else{a0=aT({rotationMatrix:aY,objectMoved:a2.objectsMoved[0]});if(a0.worldMatrix){a2.worldMatrix=a0.worldMatrix}}U.onMove(a2);aL.render()}else{if(aX.eventName==="RulerManipulateEnd"||aX.eventName==="AngularRulerManipulateEnd"){j();var aW={from:O,status:"Moved"};if(aX.status==="Cancelled"){aW.status="Cancelled"}else{ar.setRobotMatrix(ar.getMatrix())}a3=f.give3DGridController({context:ab});if(a3){a3.display3DGrids()}U.onMoveEnd(aW)}}}}};var al=function(a0){if(!L){return}aL.setCursor("pointer");aO();aS();at();aw=0;J=new D.Vector3();aC="";x(L,U);aP(a0.manipulator);var aZ=b(av),aY;var bb={objectsMoved:aZ,from:O,moveMode:"Persistent"};if(a0.eventChannel==="LineTranslationBegin"){var a7=0;for(;a7<a0.manipulator.manipulatedPaths[0].externalPath.length;a7++){if(a0.manipulator.manipulatedPaths[0].externalPath[a7].name.startsWith("arrow")){aC=a0.manipulator.manipulatedPaths[0].externalPath[a7].name;break}}aY=new D.Vector3().copy(a0.manipulator.axis);var a4=new D.Vector3().getPositionFromMatrix(ar.getMatrix());var a6=new D.Vector3().copy(aY).multiplyScalar(new D.Vector3().copy(ae.baseOrigin).sub(a4).dot(aY));ae.initOrigin=new D.Vector3().copy(a4).add(a6);var bc=new D.Vector3().copy(ae.initOrigin);var a3=null,aX;if(aU&&typeof aC==="string"){if(aC.match("arrowX")&&aU.X3Dpos){a3=new D.Vector3().copy(aU.X3Dpos)}else{if(aC.match("arrowY")&&aU.Y3Dpos){a3=new D.Vector3().copy(aU.Y3Dpos)}else{if(aC.match("arrowZ")&&aU.Z3Dpos){a3=new D.Vector3().copy(aU.Z3Dpos)}}}if(a3){aX=new D.Line3(ae.initOrigin,new D.Vector3().copy(ae.initOrigin).add(aY));bc=aX.closestPointToPoint(a3,false)}}ae.origin=bc;var aW=new D.Vector3().copy(ae.origin).sub(a4).dot(aY);ae.direction=aY;ae.value=bc.distanceTo(a4)*(aW>0?-1:1);ae.initValue=ae.value;if(R){R.origin=ae.origin;R.origin3DPos=a3;R.initOrigin=ae.initOrigin;R.setValue(ae.value);R.direction=ae.direction;R.initValue=ae.initValue;R.displayOrigin=!(R.origin.equals(R.initOrigin));R.display();R.beginManipulation()}}else{if(a0.eventChannel==="RotationBegin"){aU={};bb.center=new D.Vector3().getPositionFromMatrix(ar.getMatrix());aY=new D.Vector3().copy(a0.manipulator.axis);if(!ak.direction||Math.round(aY.dot(ak.direction)*100)===0||!K()){var ba=new D.Vector3(),a8=new D.Vector3(),a5=new D.Vector3();ar.getMatrix().extractBasis(ba,a8,a5);ba.normalize();a8.normalize();var a2=Math.round(ba.dot(aY)*100);var a1=Math.round(a8.dot(aY)*100);if(a2===0){ak.originVector=new D.Vector3().copy(ba)}else{if(a1===0){ak.originVector=new D.Vector3().copy(a8)}}ak.value=0;ak.direction=aY}bb.axis=new D.Vector3().copy(ak.direction);ak.origin=new D.Vector3().getPositionFromMatrix(ar.getMatrix());ak.initValue=ak.value;if(am){am.originVector=ak.originVector;am.setValue(ak.value);am.origin=ak.origin;am.direction=ak.direction;am.initValue=ak.initValue;am.display();am.beginManipulation()}}}var a9=f.give3DGridController({context:ab});if(a9){a9.hide3DGrids()}U.onMoveBegin(bb)};var aE=function(a1){if(!L){return}aL.setCursor("pointer");if(a1.eventChannel==="LineTranslationManipulation"){ae.value=ae.initValue+a1.translationVector.length()*(ae.direction.dot(a1.translationVector)>0?1:-1);if(R){R.setValue(ae.value)}}else{if(a1.eventChannel==="RotationManipulation"){aU={};var a0=new D.Vector3().copy(a1.axis);var aW=ak.direction.dot(a0);var a2=aW<0?2*Math.PI-a1.angle:a1.angle;ak.value=ak.initValue+a2*180/Math.PI;if(am){am.setValue(ak.value)}}}aK();var aY={objectsMoved:b(av),from:O},aX;if(a1.translationVector){if(H.count()===0||aY.objectsMoved.length===0){aY.vector=a1.translationVector}else{aX=aT({translationVector:new D.Vector3().subVectors(a1.translationVector,J),objectMoved:aY.objectsMoved[0]});if(aX.worldMatrix){aY.worldMatrix=aX.worldMatrix}}J=a1.translationVector}else{if(H.count()===0||aY.objectsMoved.length===0){aY.angle=a1.angle}else{var aZ=new D.Matrix4().makeRotationAxis(a1.axis,a1.angle-aw);aX=aT({rotationMatrix:aZ,objectMoved:aY.objectsMoved[0]});if(aX.worldMatrix){aY.worldMatrix=aX.worldMatrix}}aw=a1.angle}U.onMove(aY);aL.render()};var S=function(aX){if(!L){return}I();j();aq();if(aX.eventChannel==="LineTranslationEnd"){if(R){R.endManipulation();R.display()}}else{if(aX.eventChannel==="RotationEnd"){if(am){am.endManipulation();am.display()}}}var aW=f.give3DGridController({context:ab});if(aW){aW.display3DGrids()}U.onMoveEnd({from:O,status:"Moved"})};var aV,ax;var aJ=function(){if((!R||!am)&&!aF){aF=true;require(["DS/Ruler/Ruler","DS/Ruler/AngularRuler"],function(aW,aX){R=new aW(F,{displayOrigin:false,offset:h,mainGrad:100,nbSecondaryGrads:9,displayUnit:true,lockedOrigin:false});if(!aa){aa=R.subscribe("OriginManipulateBegin",function(){ax=null;if(!aV){aV=new D.Vector3().copy(R.origin)}});aN.push(aa)}if(!an){an=R.subscribe("OriginManipulateEnd",function(){if(!aU){aU={}}if(aC.match("arrowX")){aU.X3Dpos=ax?new D.Vector3().copy(ax):null}else{if(aC.match("arrowY")){aU.Y3Dpos=ax?new D.Vector3().copy(ax):null}else{if(aC.match("arrowZ")){aU.Z3Dpos=ax?new D.Vector3().copy(ax):null}}}ax=null;v.empty()});aN.push(an)}R.onOriginManipulator=function(a2){var a6,a1=null,a4=Math.pow(10,6),aY=aL.pick(aL.getMousePosition(a2.event.from[0].getCurrentPosition(aL.canvas)),"primHybrid",false);if(0===aY.path.length||!aY.path[0]){R.displayOrigin=false;ax=null;return aV}a6=aj.filterPath({pathElement:ai(aY.path)});v.empty();if(!a6||!a6.pathElement){if(m.isAModelPath(aY.path[0])){v.add({pathElement:aY.path[0]})}R.displayOrigin=false;return aV}if(typeof a6!=="undefined"&&a6&&a6.equivalentGeometry){var a3=a6.equivalentGeometry.getType(),a0=0;switch(a3){case E.GeometryType.POINT:a1=a6.equivalentGeometry.getPoint();break;case E.GeometryType.CYLINDER:case E.GeometryType.CONE:var a5=a6.equivalentGeometry.getEndPoints(),aZ=new D.Line3(a5.startPoint,a5.endPoint);a0=Math.round(aZ.delta().angleTo(a2.translationVector)*a4)/a4;if(a0===(Math.round((Math.PI*3/2)*a4)/a4)||a0===(Math.round((Math.PI/2)*a4)/a4)){a1=aZ.center()}break;case E.GeometryType.CIRCLE:a0=Math.round(a6.equivalentGeometry.getNormal().angleTo(a2.translationVector)*a4)/a4;if(a0===(Math.round((Math.PI*3/2)*a4)/a4)||a0===(Math.round((Math.PI/2)*a4)/a4)){a1=a6.equivalentGeometry.getCenter()}break;case E.GeometryType.PLANE:case E.GeometryType.REFPLANE:a0=Math.round(a6.equivalentGeometry.getNormal().angleTo(a2.translationVector)*a4)/a4;if(a0===0||a0===(Math.round(Math.PI*a4)/a4)){a1=aY.position}break;case E.GeometryType.SPHERE:a1=a6.equivalentGeometry.getCenter();break;case E.GeometryType.AXISSYSTEM:a1=new D.Vector3().getPositionFromMatrix(a6.equivalentGeometry.getMatrix());break;default:a1=null}}if(!a1){a6.pathElement.internalPath.length=0;if(aj.getFiltersState().product){a1=new D.Vector3().getPositionFromMatrix(a6.pathElement.getWorldMatrix())}}v.add(a6);if(a1){R.displayOrigin=true;ax=new D.Vector3().copy(a1);return a1}R.displayOrigin=false;ax=null;return aV};R.setVisibilityFree(true);aN.push(R.subscribe("RulerManipulateBegin",function(aY){G(aY)}));aN.push(R.subscribe("RulerManipulate",function(aY){G(aY)}));aN.push(R.subscribe("RulerManipulateEnd",function(aY){G(aY)}));am=new aX(F,{radius:a,mainGrad:10,nbSecondaryGrads:4,displayUnit:true});am.setVisibilityFree(true);X.push(am.subscribe("AngularRulerManipulateBegin",function(aY){G(aY)}));X.push(am.subscribe("AngularRulerManipulate",function(aY){G(aY)}));X.push(am.subscribe("AngularRulerManipulateEnd",function(aY){G(aY)}))})}aL.setCursor("pointer");N();aI();aO();x(L,U)};var aM=function(aW){aL.setCursor("pointer");aS();at();if(aW.intersection.path.length){var aX=T(aW.intersection.path[0],aW).pathElement;if(!L||!aX||!L.isEqual(aX)){L=aX?aX.clone():null;if(aX){if(u(aX)){aA.updateDisplay({visibility:false});ap.updateDisplay({pathElement:aX,visibility:true})}else{aA.updateDisplay({pathElement:aX,visibility:true});ap.updateDisplay({visibility:false})}}else{aA.updateDisplay({visibility:false});ap.updateDisplay({visibility:false})}}}else{aA.updateDisplay({visibility:false});ap.updateDisplay({visibility:false});L=null}};var M=function(aZ){var a3={};a3=T(aZ.target,aZ);L=a3.pathElement;P=L;ar.target=L;aU={};aq();aS();at();aA.updateDisplay({visibility:false});ap.updateDisplay({visibility:false});if(L){l.empty();A.empty();l.add(a3);A.add(a3);var aY=L.getWorldMatrix();if(a3.equivalentGeometry){var a5=new D.Vector3().copy(aZ.intersection.position),a1,a2=a3.equivalentGeometry.getType();if(a2===E.GeometryType.POINT){a5=a3.equivalentGeometry.getPoint()}else{if(a2===E.GeometryType.LINE||a2===E.GeometryType.CYLINDER||a2===E.GeometryType.CONE){var a6=a3.equivalentGeometry.getEndPoints();var a7=new D.Line3(a6.startPoint,a6.endPoint);a1=a7.delta();a5=a7.closestPointToPoint(a5)}else{if(a2===E.GeometryType.CIRCLE){a1=a3.equivalentGeometry.getNormal();a5=a3.equivalentGeometry.getCenter()}else{if(a2===E.GeometryType.PLANE||a2===E.GeometryType.REFPLANE){a1=a3.equivalentGeometry.getNormal()}else{if(a2===E.GeometryType.SPHERE){a5=a3.equivalentGeometry.getCenter()}else{if(a2===E.GeometryType.AXISSYSTEM){a5=null}}}}}}if(a1){var aX=new D.Vector3(),a0=new D.Vector3(),a4=new D.Vector3();aY.extractBasis(aX,a0,a4);aX.normalize();a0.normalize();a4.normalize();a1.normalize();var aW=new D.Vector3().crossVectors(aX,a1);if(aW.length()<1e-9){aX.copy(a0).projectOnPlane(a1);aX.normalize()}else{aX.projectOnPlane(a1);aX.normalize()}a0.crossVectors(a1,aX);a0.normalize();aY.makeBasis(aX,a0,a1)}if(a5){aY.setPosition(a5)}ar.setRobotMatrix(aY)}else{ar.setRobotMatrix(aY.setPosition(new D.Vector3().copy(aZ.intersection.position)))}ae.origin=new D.Vector3().getPositionFromMatrix(aY);ae.initOrigin=new D.Vector3().getPositionFromMatrix(aY);ae.baseOrigin=new D.Vector3().getPositionFromMatrix(aY);if(R){R.initOrigin=ae.initOrigin;R.origin=ae.origin;aU={}}}ad();if(L){ac();I()}else{N();j();if(aZ.target){Q()}}};var au=false;var ah=function(aW){if(aG){if(aW.eventType==="@onViewpointBeginMove"){au=true}else{if(aW.eventType==="@onViewpointChange"){if(au){ar.setVisibility(false);aL.render()}}else{if(aW.eventType==="@onViewpointEndMove"){ar.setVisibility(true);au=false;aL.render()}}}}};var Z=function(aY){L=T(aY).pathElement;ar.target=L;var aX=ar.getMatrix();var aW=L.getWorldMatrix();aW.setPosition(new D.Vector3().getPositionFromMatrix(aX));ae.origin=new D.Vector3().getPositionFromMatrix(aW);ae.initOrigin=new D.Vector3().getPositionFromMatrix(aW);ae.baseOrigin=new D.Vector3().getPositionFromMatrix(aW);if(R){R.initOrigin=ae.initOrigin;R.origin=ae.origin;aU={}}ar.setRobotMatrix(aW);ad()};require(["DS/ApplicationFrame/CommandsManager"],function(aW){aW.onCommandStart(function(aX){if(!Y.length){return}if(aX._id==="CAT3DComposeRobotLevelSelectorHdr"){aQ.hideContextualMenus();if(P&&P.externalPath){aX.setRobotParams({pathContext:P,pathCurrent:L,selectCB:function(aY){Z(aY.pathElement)}})}}else{if(aX._id==="CAT3DComposeSetIdentityPositionHdr"){aQ.hideContextualMenus();Q()}else{if(aX._id==="CAT3DComposeWidgetDefaultHdr"||aX._id==="CAT3DComposeMoveHdr"){if(!W){W=t.subscribe({event:"/VISU/"},ah)}if(aX._id==="CAT3DComposeWidgetDefaultHdr"){Q()}}else{if(aX._id==="LevelSelectorHdr"||aX._id==="HideShowHdr"||aX._id==="CAT3DComposeMoveCmd"){}else{if(aX._mode==="exclusive"){Q()}}}}}},ab.getCommandContext&&ab.getCommandContext()?ab.getCommandContext():undefined)});this.setVisibility=function(aW){if(typeof aW!=="boolean"){return undefined}if(aW){if(!W){W=t.subscribe({event:"/VISU/"},ah)}if(R){R.setVisibleFlag(true)}if(am){am.setVisibleFlag(true)}}else{if(W){if(R){R.setVisibleFlag(false)}if(am){am.setVisibleFlag(false)}t.unsubscribe(W);W=undefined}}aG=aW;var aX=ar.isVisible();if((aX&&aW)||(!aX&&!aW)){return 0}ar.setVisibility(aW);aL.render();return 0};this.isVisible=function(){return aG?ar.isVisible():false};this.activate=function(){if(!Y.length){Y.push(ar.subscribe("LineTranslationBegin",function(aY){al(aY)}));Y.push(ar.subscribe("RotationBegin",function(aY){al(aY)}));Y.push(ar.subscribe("ScalingBegin",function(aY){al(aY)}));Y.push(ar.subscribe("PlaneTranslationBegin",function(aY){al(aY)}));Y.push(ar.subscribe("LineTranslationManipulation",function(aY){aE(aY)}));Y.push(ar.subscribe("RotationManipulation",function(aY){aE(aY)}));Y.push(ar.subscribe("ScalingManipulation",function(aY){aE(aY)}));Y.push(ar.subscribe("PlaneTranslationManipulation",function(aY){aE(aY)}));Y.push(ar.subscribe("LineTranslationEnd",function(aY){S(aY)}));Y.push(ar.subscribe("RotationEnd",function(aY){S(aY)}));Y.push(ar.subscribe("ScalingEnd",function(aY){S(aY)}));Y.push(ar.subscribe("PlaneTranslationEnd",function(aY){S(aY)}));Y.push(ar.subscribe("ScreenPlaneTranslationBegin",function(aY){aJ(aY)}));Y.push(ar.subscribe("ScreenPlaneTranslationManipulation",function(aY){aM(aY)}));Y.push(ar.subscribe("ScreenPlaneTranslationEnd",function(aY){M(aY)}))}if(!aH.length){var aW,aX;aH.push(ab.subscribe({event:"onRootRemoved"},function(aY){aB([aY])}));aH.push(ab.subscribe({event:"onRootDetached"},function(aY){aB([aY])}));aH.push(ab.subscribe({event:"onHide"},function(aZ){var aY=[];aZ.paths.forEach(function(a0){aY.push({path:a0})});aB(aY)}));aH.push(ab.subscribe({event:"onBeginReparent"},function(aY){if(L&&((aY.reparentedInstance&&L.externalPath.some(function(aZ){return aZ===aY.reparentedInstance}))||(aY.pathToReparent&&aY.pathToReparent.isAParentOf(L)))){aW=ab.subscribe({event:"onReparentFailure"},function(){ab.unsubscribe(aW);ab.unsubscribe(aX)});aX=ab.subscribe({event:"onEndReparent"},function(){ab.unsubscribe(aW);ab.unsubscribe(aX);Q()})}}))}W=t.subscribe({event:"/VISU/"},ah)};this.deactivate=function(){Y.forEach(function(aW){ar.unsubscribe(aW)});Y.length=0;aH.forEach(function(aW){ab.unsubscribe(aW)});aH.length=0;N();t.unsubscribe(W);W=null};this.unreference=function(){this.deactivate();aL.setRobot(false);aL.removeNode(aA);aL.removeNode(ap);aS();at();aN.forEach(function(aW){R.unsubscribe(aW)});X.forEach(function(aW){am.unsubscribe(aW)});if(H){H.unreference()}ar=ab=F=aL=U=av=H=aU=null;aa=an=aQ=aj=R=am=aA=ap=null}}});var n=[];return C.singleton({init:function(){},giveComposeRobot:function(F){var G;if(F&&F.context){G=null;n.some(function(H){return(H.context===F.context)?(G=H.enveloppe):false})}return G},getComposeRobot:function(H){var K;if(H&&H.context){n.some(function(L){return(L.context===H.context)?(K=L.enveloppe):false});if(!K){var J=new d({context:H.context}),F=H.context.setRobotVisibility,I=H.context.isRobotVisible;J.activate();var G={unreference:function(){if(!J){return}J.unreference();J=null;n.some(function(M,L){if(M.enveloppe===G){n.splice(L,1);M.context.setRobotVisibility=F;F=null;M.context.isRobotVisible=I;I=null;G=null;return true}return false})},setVisibility:function(L){return J?J.setVisibility(L):null},isVisible:function(){return J?J.isVisible():null}};Object.freeze(G);H.context.setRobotVisibility=function(L){return G?G.setVisibility(L):null};H.context.isRobotVisible=function(){return G?G.isVisible():null};n.push({context:H.context,enveloppe:G});K=G}}return K}})});define("DS/CAT3DComposeCommands/CAT3DComposeCtxMenuAgent",["UWA/Class","DS/Selection/CSOManager","DS/Visualization/ThreeJS_DS","DS/ApplicationFrame/CommandsManager","DS/CATC3DGeometry/CATC3DGeometryEnums","DS/CAT3DComposeConstraints/CAT3DComposeConstraintsController","DS/CAT3DComposeMoveManager/CATC3DMoveReferent","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(j,c,i,a,d,e,f,b){var h=0;var g=j.extend({init:function(o){this._parent(o);var m=o.context,l=m.getCommandContext?m.getCommandContext():null,n,p,k=[];this.activate=function(){if(k.length===0){n=m.getViewer();p=f.getMoveReferentManager({context:m});k=["CAT3DComposeCtxMenuAgent_"+(h++),"CAT3DComposeCtxMenuAgent_"+(h++)];m.getFrameWindow().getContextualUIManager().register({onContextualBarReady:function(x,y){var r=c.get();if(r.length===0){return undefined}var z=b.getRoots(m),v=[],u=false,s=false,q=e.giveConstraintsController({context:m});r.some(function(C){var B=p.getMoveReferent(C.pathElement),A;if(B&&(A=B.getLastElement(true))&&b.isInstance(A)&&A.children.length>0){B.addElement(A.children[0]);if(q&&q.isThereACstSuppportingReverseDirection(B)){u=true}var D=q?q.getAxisTypeIfCstOnProductAxis(B):null;if(D){s=true;if(D===d.GeometryType.AXISX){a.getCommandCheckHeader("CATC3DSwitchAxisXHdr",l).setState(true)}else{if(D===d.GeometryType.AXISY){a.getCommandCheckHeader("CATC3DSwitchAxisYHdr",l).setState(true)}else{a.getCommandCheckHeader("CATC3DSwitchAxisZHdr",l).setState(true)}}}return u&&s}return false});if(s){v.push({name:"CATC3DSwitchAxisIcb",line:1,hdr_list:["CATC3DSwitchAxisXHdr","CATC3DSwitchAxisYHdr","CATC3DSwitchAxisZHdr"]})}if(u){v.push({name:"CATC3DReverseDirectionStr",line:1,hdr_list:["CATC3DReverseDirectionHdr"]})}var t=r.some(function(B){var A=B.pathElement.getLastElement(true);return z.some(function(C){var E=C!==A;var D=B.pathElement.externalPath.some(function(F){return C===F});return E&&D})});if(t&&y&&y.withContextMenu&&typeof y.XmousePosition==="number"&&typeof y.YmousePosition==="number"){var w=n.pick(n.getMousePosition(new i.Vector2(y.XmousePosition,y.YmousePosition)),"mesh",false);if(w.path.length===0){t=false}}if(t){if(a.getCommand("CAT3DComposeExamineSelectionHdr",l).canBeEnabled(r)){v.push({name:"CAT3DComposeExamineSelectionStr",line:1,hdr_list:["CAT3DComposeExamineSelectionHdr"]})}if(r.length===1){v.push({name:"LevelSelector",line:1,hdr_list:["LevelSelectorHdr"]})}}return v.length?{cmdList:v}:undefined},context:l,workbenchName:"CAT3DComposeWidgetWkb",module:"CAT3DComposeWidget",cmdPrefix:"",merge:true,subscriberId:k[0]});m.getFrameWindow().getContextualUIManager().register({onContextualBarReady:function(s,v){var u=[];var r=c.get();if(r.length===1){var t=r[0].pathElement.getLastElement(true);if(b.getRoots(m).some(function(w){return w===t})){u.push({name:"RemoveRoot",line:1,hdr_list:["RemoveRootHdr"]})}}if(v&&v.withContextMenu&&typeof v.XmousePosition==="number"&&typeof v.YmousePosition==="number"){var q=n.pick(n.getMousePosition(new i.Vector2(v.XmousePosition,v.YmousePosition)),"mesh",false);if(q.path.length===0){return undefined}}return u.length?{cmdList:u}:undefined},context:l,workbenchName:"ENOPAD3DViewerContextualBar",module:"ENOPAD3DViewer",cmdPrefix:"",merge:true,subscriberId:k[1]})}};this.deactivate=function(){n=p=null;k.forEach(function(q){m.getFrameWindow().getContextualUIManager().unregister(q)});k=[]}}});return g});define("DS/CAT3DComposeCommands/CAT3DComposeWidgetDefaultCmd",["DS/ApplicationFrame/Command","DS/ApplicationFrame/CommandsManager","DS/CAT3DComposeBoxes/CAT3DComposeBoxController","DS/CATRelatedDataLauncher/CATRelatedDataController","DS/CAT3DComposeCommands/CAT3DComposeCtxMenuAgent","DS/PADUtils/PADContext","DS/CAT3DComposeMoveManager/CAT3DComposeMoveManager"],function(a,b,h,e,f,g,c){var i,d=a.extend({init:function(u){this._parent(u,{mode:"exclusive",isAsynchronous:true});this.setRepeatMode(false);var p=this,l=false,j=g.get(),s=j.getCommandContext?j.getCommandContext():null,q=new f({context:j}),t=h.getBoxController({context:j}),n=e.giveDataLauncherController({context:j}),o=c.getMoveManager({context:j});if(!i){require(["DS/CAT3DComposeDirectMove/CAT3DComposeDirectMove"],function(v){i=v;if(p.isRunning()){i.activate({context:j})}})}var k=[];function m(){if(k.length>0){return}k.push(o.subscribe("MoveBegin",function(){b.getCommand("CAT3DComposeExamineSelectionHdr",s).deactivate()}));k.push(o.subscribe("Move",function(){if(n){n.setVisibility(false)}}));k.push(o.subscribe("MoveEnd",function(){if(n){n.setVisibility(true)}b.getCommand("CAT3DComposeExamineSelectionHdr",s).activate()}))}function r(){k.forEach(function(v){o.unsubscribe(v)});k=[]}this.execute=function(){if(!j||l){return}q.activate();t.setActiveState(true);n.setActiveState(true);if(i){i.activate({context:j})}b.getCommand("CAT3DComposeExamineSelectionHdr",s).activate();m()};this.endExecute=function(){if(!j){return}q.deactivate();t.setActiveState(false);n.setActiveState(false);if(i){i.deactivate({context:j})}var v=b.getCommand("CAT3DComposeExamineSelectionHdr",s);if(v){v.deactivate()}r()};this.pauseExecute=function(){q.deactivate();t.setActiveState(false);n.setActiveState(false);if(i){i.deactivate({context:j})}b.getCommand("CAT3DComposeExamineSelectionHdr",s).deactivate();r()};this.resumeExecute=function(){q.activate();t.setActiveState(true);n.setActiveState(true);if(i){i.activate({context:j})}b.getCommand("CAT3DComposeExamineSelectionHdr",s).activate();m()};this.getRequestedCommandMode=function(v){return(v.cmd==="Measure"||v.cmd==="Section")?"shared":undefined};this.allowManipulation=function(v){return(v.object==="Measure"||v.object==="Section")?true:undefined};this._destroy=function(){r();if(i){i.unreference({context:j})}l=true;Object.getPrototypeOf(this)._destroy.apply(this,arguments);p=j=q=t=n=o=null}}});return d});define("DS/CAT3DComposeCommands/CAT3DComposeMoveCmd",["UWA/Class","UWA/Core","DS/ApplicationFrame/Command","DS/CoreEvents/ModelEvents","DS/UIKIT/Spinner","DS/Visualization/SceneGraphUtils","DS/CAT3DComposeUtils/CAT3DCompose3DAnimation","DS/CAT3DComposeBoxes/CAT3DComposeBoxController","DS/ApplicationFrame/CommandsManager","DS/CAT3DComposeCommands/CAT3DComposeCtxMenuAgent","DS/PADUtils/PADContext","DS/CAT3DComposeMoveManager/CAT3DComposeMoveManager","DS/CAT3DComposeCommands/CATC3DCommandsUtils","DS/CATWebUXComponents/CATWebUXNotifBar"],function(z,s,v,k,c,u,d,t,a,o,n,r,h,p){var i,A,q,j,f,y,e,g,m,x;require(["i18n!DS/CAT3DComposeCommands/assets/nls/CAT3DComposeNotificationAgent"],function(B){i=B.PositionModifiedLbl;A=B.PositionModifiedOK;q=B.PositionModifiedCancel;j=B.PositionLockedLbl;f=B.PositionLockedLink;y=B.PositionModifiedSaveOK;e=B.PositionModifiedSaveKO;g=B.singleSplitInstance;m=B.multipleSplitInstance});require(["DS/Selection/CSOManager"],function(B){x=B});var l=z.extend({init:function(C){var F,B,E,D;this.show=function(){if(!F){F=new p({className:"c3dMoveCmdDlg"}).inject(C.uiFrame);this.hide();B=F.add({msgType:"primary",message:i,closable:false,buttons:[{className:"spinner"},{className:"primary",label:A,onClick:C.onSave},{className:"default",label:q,onClick:C.onCancel}]});this.hideSpinner();this.hideSave();E=F.add({msgType:"warning",message:j,closable:false,buttons:[{className:"link",label:f,onClick:C.onCancelLocked}]});E.hide()}F.show()};this.showSave=function(){this.hideSpinner();if(B){B.buttons[1].show();D=true}};this.showSpinner=function(){if(D===false){B.buttons[0].show()}};this.showLock=function(){if(E){E.show()}};this.hide=function(){if(F){F.hide()}};this.hideSave=function(){if(B){D=false;B.buttons[1].hide()}};this.hideSpinner=function(){if(B){B.buttons[0].hide()}};this.hideLock=function(){if(E){E.hide()}};this.destroy=function(){if(F){F.destroy()}F=B=E=null}}});var b,w=v.extend({init:function(F){this._parent(F,{mode:"exclusive",isAsynchronous:true});this.setRepeatMode(false);var T=this,Q=true,U=false,N=n.get(),K=N.getCommandContext?N.getCommandContext():null,G=r.getMoveManager({context:N}),R,S=new o({context:N}),H=function(){U=true;Q=false;G.terminateMove({save:false});T.end()},L=function(){U=true;Q=false;G.terminateMove({save:true});T.end()},C=function(){G.cancelLocked()},M=false,D=new v({ID:"CAT3DComposeFakeMoveHdr",mode:"shared",isAsynchronous:false,context:K}),E=G.subscribe("MoveBegin",function(){if(T.isRunning()){a.getCommand("CAT3DComposeExamineSelectionHdr",K).deactivate()}}),V=G.subscribe("Move",function(X){if(X.objectsMoved.length>0&&X.moveMode==="Persistent"){X.objectsMoved.forEach(function(Z){var Y=Z.path.getLastElement(true);if(h.isPLMInstanceNode(Y)){if(!T._isRunning){M=true;T.begin()}R.showSpinner();G.isPathLocked({pathElement:Z.path,onCompleted:function(aa){if(R){R.hideSpinner();if(aa.isLocked){R.showLock()}else{R.showSave()}}}})}})}}),I=G.subscribe("MoveEnd",function(){if(T.isRunning()){var X=t.getBoxController({context:N});if(X){X.setActiveState(true)}a.getCommand("CAT3DComposeExamineSelectionHdr",K).activate()}M=false}),O,P,B=function(aa){var Z=(aa.eventID==="success"&&aa.objectsMoved.length>0)?y:(aa.eventID==="error"&&aa.objectsCancelled.length>0)?e:null;if(Z){N.displayNotification({eventID:aa.eventID,msg:Z})}var ab=d.get3DComposeAnimationEngine({viewer:N.getViewer()});if(aa&&aa.splitInstances&&aa.splitInstances.length){N.displayNotification({eventID:"info",msg:aa.splitInstances.length>1?m:g});var ad=[],Y=N.getController(),ac=N.getRootBagPath().getLastElement(true);aa.splitInstances.forEach(function(ae){ad=ad.concat(u.buildPathesLeadingToNode(Y.getNode({id:ae.newId}),ac).map(function(af){return{path:af}}))});ab.addAnimation({animationType:"opacityOnOff",objectListToAnimate:ad,duration:1000,createOverrideSet:true});ab.addAnimation({animationType:"color",objectListToAnimate:ad,duration:1000,createOverrideSet:true,color:"#ff821e"});if(x){var X=x.get();if(X.length){x.empty()}if(ad.length){x.add(ad.map(function(ae){return{pathElement:ae.path}}))}if(X.length){x.empty()}x.add(X)}}if(aa.objectsCancelled&&aa.objectsCancelled.length>0){ab.addAnimation({animationType:"cancel",objectListToAnimate:aa.objectsCancelled,callBackFct:function(){setTimeout(function(){D.begin()},0)},createOverrideSet:true})}ab.startAnimation();if(U){G.unsubscribe(O);G.unsubscribe(P)}},J=function(X){if(R&&X.bEmptyMove===true){R.hideSave();R.hideLock()}else{if(R&&!X.someMovedObjectsAreLocked){R.hideLock()}}if(X.objectsCancelled&&X.objectsCancelled.length>0){var Z=d.get3DComposeAnimationEngine({viewer:N.getViewer()});var Y={animationType:"cancel",objectListToAnimate:X.objectsCancelled,callBackFct:function(){setTimeout(function(){D.begin()},0)},createOverrideSet:true};Z.addAnimation(Y);Z.startAnimation()}else{N.getViewer().render()}if(U){G.unsubscribe(O);G.unsubscribe(P)}},W=function(X){if(X.key==="Enter"||X.keyCode===13){if(X.ctrlKey===false&&X.altKey===false&&X.shiftKey===false&&X.metaKey===false){L();document.removeEventListener("keydown",W)}}};if(!b){require(["DS/CAT3DComposeDirectMove/CAT3DComposeDirectMove"],function(X){b=X;if(T.isRunning()){b.activate({context:N})}})}this.beginExecute=function(){Q=true;U=false;R=new l({uiFrame:N.getFrameWindow().getUIFrame(),onSave:L,onCancel:H,onCancelLocked:C});R.show();S.activate();if(!M){var Y=t.getBoxController({context:N});if(Y){Y.setActiveState(true)}var X=a.getCommand("CAT3DComposeExamineSelectionHdr",K);X.activate()}if(b){b.activate({context:N})}document.addEventListener("keydown",W);O=G.subscribe("onValidateMove",B);P=G.subscribe("onCancelMove",J)};this.endExecute=function(){document.removeEventListener("keydown",W);if(Q){U=true;G.terminateMove({save:false})}R.destroy();R=null;S.deactivate();var Y=t.getBoxController({context:N});if(Y){Y.setActiveState(false)}var X=a.getCommand("CAT3DComposeExamineSelectionHdr",K);if(X){X.deactivate()}N.getFrameWindow().getContextualUIManager().hideContextualMenus();if(b){b.deactivate({context:N})}};this.pauseExecute=function(){var X=t.getBoxController({context:N});if(X){X.setActiveState(false)}R.hide();S.deactivate();a.getCommand("CAT3DComposeExamineSelectionHdr",K).deactivate();if(b){b.deactivate({context:N})}document.removeEventListener("keydown",W)};this.resumeExecute=function(){var X=t.getBoxController({context:N});if(X){X.setActiveState(true)}R.show();S.activate();a.getCommand("CAT3DComposeExamineSelectionHdr",K).activate();if(b){b.activate({context:N})}document.addEventListener("keydown",W)};this.getRequestedCommandMode=function(X){return(X.cmd==="Measure"||X.cmd==="Section")?"shared":undefined};this.allowManipulation=function(X){return(X.object==="Measure"||X.object==="Section")?true:undefined};this._destroy=function(){Object.getPrototypeOf(this)._destroy.apply(this,arguments);G.unsubscribe(E);G.unsubscribe(V);G.unsubscribe(I);G.unsubscribe(O);G.unsubscribe(P);if(b){b.unreference({context:N})}N=G=S=R=O=P=E=V=I=T=null}}});return w});
/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CAT3DComposeCommands/CATC3DPathElementAgentWithFilter",["DS/StateCommandEngine/PathElementAgent","DS/DMUMeasurable/DMUMeshRecognition","DS/DMUMeasurable/DMUGeometryEnums","DS/CATC3DGeometry/CATC3DEquivalentGeometry","DS/CATC3DGeometry/CATC3DGeometryEnums","DS/Web3DUXFilterBar/Web3DUXFilterBar","DS/CAT3DComposeCommands/CATC3DAxisSystemDisplayAgent","DS/WebappsUtils/WebappsUtils","DS/Selection/CSOManager","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","i18n!DS/CAT3DComposeCommands/assets/nls/CAT3DComposeCommands"],function(h,l,j,e,f,a,i,d,c,b,k){var m,g=h.extend({_frameWindow:null,_filterUI:null,_activeFilters:null,_filtersEnum:null,_postFilter:null,_axisAgent:null,geometryTypesEnum:{POINT:f.GeometryType.POINT,LINE:f.GeometryType.LINE,CIRCLE:f.GeometryType.CIRCLE,PLANE:f.GeometryType.PLANE,CYLINDER:f.GeometryType.CYLINDER,CONE:f.GeometryType.CONE,SPHERE:f.GeometryType.SPHERE,REFERENCE:10,AXISSYSTEM:f.GeometryType.AXISSYSTEM,AXISSYSTEMAXIS:f.GeometryType.AXISSYSTEMAXIS,AXISSYSTEMORIGIN:f.GeometryType.AXISSYSTEMORIGIN},init:function(n){var o,p=d.getWebappsAssetUrl("DMUBaseCommands","icons/32/"),q=d.getWebappsAssetUrl("CAT3DComposeCommands","icons/32/");this._preselection=true;m=this;if(!n.context){return null}this._frameWindow=n.context.getFrameWindow();this._axisAgent=new i({context:n.context});this._activeFilters=n.activeFilters||{POINT:1,CENTER:1,CIRCLE:1,AXISSYSTEM:1,AXISSYSTEMAXIS:1,AXISSYSTEMORIGIN:1,LINE:1,PLANE:1,CYLINDER:1,REFERENCE:1};this._postFilter=n.postFilter;this._filtersEnum={POINT:{type:"element",id:"POINT",nls:k.point,url:p+"I_Meas_Point.png",callback:function(){m.updateFilters()},bexclude:false,bstateActif:m._activeFilters.POINT},CENTER:{type:"element",id:"CENTER",nls:k.center,url:p+"I_Meas_PointCircle.png",callback:function(){m.updateFilters()},bexclude:false,bstateActif:m._activeFilters.CENTER},CIRCLE:{type:"element",id:"CIRCLE",nls:k.circle,url:p+"I_WebMarkerCircle.png",callback:function(){m.updateFilters()},bexclude:false,bstateActif:m._activeFilters.CIRCLE},AXISSYSTEM:{type:"element",id:"AXISSYSTEM",nls:k.axisSystem,url:q+"I_3DComposeAxisSystem.png",callback:function(){m._lastClicked="AXISSYSTEM";m.updateFilters()},bexclude:false,bstateActif:m._activeFilters.AXISSYSTEM},AXISSYSTEMAXIS:{type:"element",id:"AXISSYSTEMAXIS",nls:k.axisSystemAxis,url:q+"I_C3DAxisAxis.png",callback:function(){m._lastClicked="AXISSYSTEMAXIS";m.updateFilters()},bexclude:false,bstateActif:m._activeFilters.AXISSYSTEMAXIS},AXISSYSTEMORIGIN:{type:"element",id:"AXISSYSTEMORIGIN",nls:k.axisSystemOrigin,url:q+"I_C3DAxisOrigin.png",callback:function(){m._lastClicked="AXISSYSTEMORIGIN";m.updateFilters()},bexclude:false,bstateActif:m._activeFilters.AXISSYSTEMORIGIN},LINE:{type:"element",id:"LINE",nls:k.line,url:p+"I_Meas_Line.png",callback:function(){m.updateFilters()},bexclude:false,bstateActif:m._activeFilters.LINE},PLANE:{type:"element",id:"PLANE",nls:k.plane,url:p+"I_Meas_Plane.png",callback:function(){m.updateFilters()},bexclude:false,bstateActif:m._activeFilters.PLANE},CYLINDER:{type:"element",id:"CYLINDER",nls:k.cylinder,url:p+"I_Meas_Cylinder.png",callback:function(){m.updateFilters()},bexclude:false,bstateActif:(m._activeFilters.CYLINDER)},REFERENCE:{type:"element",id:"REFERENCE",nls:k.reference,url:p+"I_Meas_Product.png",callback:function(){m.updateFilters()},bexclude:true,bstateActif:m._activeFilters.REFERENCE}};o={agentId:"CAT3DComposeAssemblyPatternSelect",frameWindow:this._frameWindow,withPrevaluation:false,engWithPSOHSO:false,withPSO:true,withHSO:false,valuedFromCSO:false,saveToCSO:false,multiAcquisition:false,multiAcquisitionCtrl:false,pickingMode:"primHybrid",prePickingMode:"primHybrid",withUndoStep:false};o.prePickingFilter=o.pickingFilter=function(u){var w,x,t=false,s=0,r=e.getEquivalentGeometry({pathElement:u,axisSystemSub:!(m._activeFilters.AXISSYSTEM),axisSystemOrigin:!(m._activeFilters.AXISSYSTEMORIGIN)}),v=r?r.getType():null;if(m._activeFilters.AXISSYSTEM||m._activeFilters.AXISSYSTEMAXIS||m._activeFilters.AXISSYSTEMORIGIN){m._axisAgent.analyze({pathElement:u})}if((m._activeFilters.AXISSYSTEM===1&&v===m.geometryTypesEnum.AXISSYSTEM)||(m._activeFilters.AXISSYSTEMAXIS===1&&v===m.geometryTypesEnum.AXISSYSTEMAXIS)||(m._activeFilters.AXISSYSTEMORIGIN===1&&v===m.geometryTypesEnum.AXISSYSTEMORIGIN)){if(r){x=r.getPathElement();if(x){u.internalPath=x.internalPath;u.externalPath=x.externalPath}}t=true}if((!t)&&((m._activeFilters.POINT===1&&v===m.geometryTypesEnum.POINT)||(m._activeFilters.CENTER===1&&(v===m.geometryTypesEnum.CIRCLE||v===m.geometryTypesEnum.SPHERE))||(m._activeFilters.CIRCLE===1&&v===m.geometryTypesEnum.CIRCLE)||(m._activeFilters.LINE===1&&v===m.geometryTypesEnum.LINE)||(m._activeFilters.PLANE===1&&(v===m.geometryTypesEnum.PLANE||f.GeometryType.REFPLANE))||(m._activeFilters.CYLINDER===1&&(v===m.geometryTypesEnum.CYLINDER||v===m.geometryTypesEnum.CONE)))){t=true}if(!t&&m._activeFilters.REFERENCE===1){s=u.externalPath.length-1;for(;s>=0;--s){w=u.externalPath[s];if(w&&b.isReference(w)){u.setFromArray(u.externalPath.slice(0,(s+1)));t=true;break}}}if(t&&typeof m._postFilter==="function"){t=m._postFilter(u)}return t};this._parent(o);this.updateFilters();return null},activate:function(){var n=c.get();this._parent();if(this._preselection&&n.length>0){this._preselection=false;this.object3D=[];if(this.options.pickingFilter(n[0].pathElement)){this.object3D.push(n[0]);this._modelEvents.publish({event:this._agentId,data:this.object3D})}}this.updateFilters()},deactivate:function(){if(this._filterUI){this._filterUI.clear();this._filterUI.destroy();this._filterUI=null}m._axisAgent.deactivate();this._parent()},getSelType:function(o){var n=e.getEquivalentGeometry({pathElement:o,axisSystemSub:!(m._activeFilters.AXISSYSTEM)}),p=n?n.getType():null;if(!o||!o.externalPath||!b.isAModelPath(o)){return null}if(!p&&o.internalPath.length===0&&o.externalPath.some(function(q){return q&&b.isReference(q)})){return this.geometryTypesEnum.REFERENCE}if(typeof p==="number"){return p}return null},getActiveFilters:function(){return this._activeFilters},updateFilters:function(t,q){var s,r,p,o=false,n=[];if(typeof q!=="boolean"){q=true}if(t&&typeof t==="object"){m._activeFilters={};for(s in t){if(t.hasOwnProperty(s)&&m._filtersEnum.hasOwnProperty(s)){m._activeFilters[s]=t[s];if(m._activeFilters[s]!==1){m._activeFilters[s]=0}}}o=true}if(m._filterUI&&q){for(r in m._activeFilters){if(m._activeFilters.hasOwnProperty(r)){m._activeFilters[r]=(m._filterUI.getActiveState(r))?1:0}}}if(m._lastClicked&&m._activeFilters[m._lastClicked]===1){if(m._activeFilters.AXISSYSTEM){m._activeFilters.AXISSYSTEM=0}if(m._activeFilters.AXISSYSTEMAXIS){m._activeFilters.AXISSYSTEMAXIS=0}if(m._activeFilters.AXISSYSTEMORIGIN){m._activeFilters.AXISSYSTEMORIGIN=0}m._activeFilters[m._lastClicked]=1;o=true}m._lastClicked=null;if(m._activeFilters.AXISSYSTEM||m._activeFilters.AXISSYSTEMAXIS||m._activeFilters.AXISSYSTEMORIGIN){m._axisAgent.activate({type:"HSO",noPSOcb:true})}else{m._axisAgent.deactivate()}if(o&&m._filterUI){m._filterUI.clear();m._filterUI.destroy();m._filterUI=null}if(!m._filterUI){for(r in m._activeFilters){if(m._activeFilters.hasOwnProperty(r)&&m._filtersEnum.hasOwnProperty(r)){p=m._filtersEnum[r];p.bstateActif=m._activeFilters[r];n.push(p)}}m._filterUI=new a({body:m._frameWindow.getUIFrame(),frmWindow:m._frameWindow,Idpanel:"c3dPatternSelectionFilter",typeSeparator:"bubble",lJsonElement:n});m._filterUI.build();m._viewer.render()}}});return g});
/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CAT3DComposeCommands/CAT3DComposeAssemblyPatternCmd",["UWA/Core","DS/StateCommandEngine/StateCommand","DS/CoreEvents/Events","DS/CATWebUXComponents/CATWebUXNotifBar","DS/FlagPanel/FlagPanel","DS/FlagPanel/FlagPanelEnums","DS/FlagPanel/FlagPanelManager","DS/PADUtils/PADContext","DS/StateCommandEngine/PathElementAgent","DS/CATC3DGeometry/CATC3DEquivalentGeometry","DS/CAT3DComposeCommands/CATC3DPathElementAgentWithFilter","DS/Selection/HSOManager","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/CAT3DComposeUtils/CATC3DUtils","DS/WebappsUtils/WebappsUtils","DS/SceneGraphNodes/AxisSystemNode","DS/CAT3DComposeUtils/CAT3DCompose3DAnimation","DS/Mesh/Mesh","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","i18n!DS/CAT3DComposeCommands/assets/nls/CAT3DComposeAssemblyPatternCmd","css!DS/UIKIT/UIKIT"],function(s,t,i,p,a,r,u,m,j,e,v,g,w,k,n,q,b,l,f,c,h,d){var o=t.extend({init:function(ab){var H=this,K=this.beginExecute,T=this.endExecute,al=0,C,V,aw,W=m.get(),aq=W.getFrameWindow(),az=W.getViewer(),y=false,E,D,an,z=false,ao={},x={},F,aC,aj="NOPATTERN",G=true,X="LINEAR",ag="LINEAR",P={count:2,spacing:50,angle:30,reverse:false},O={count:2,spacing:50,angle:30,reverse:false},ay={NOPATTERN:{REFERENCE:1,POINT:0,CENTER:0,LINE:0,CYLINDER:0,AXISSYSTEM:0,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:0},NOPATTERN_LINEAR:{POINT:1,CENTER:1,LINE:1,CYLINDER:1,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:1},NOPATTERN_RECTANGULAR:{POINT:1,CENTER:1,LINE:1,CYLINDER:1,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:1},NOPATTERN_CIRCULAR:{POINT:1,CENTER:1,LINE:1,CYLINDER:1,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:1},NOPATTERN_USERDEFINED:{POINT:1,CENTER:1,AXISSYSTEM:1},LINEAR:{POINT:1,CENTER:1,LINE:1,CYLINDER:1,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:1},RECTANGULAR:{POINT:1,CENTER:1,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:1},CIRCULAR:{POINT:1,CENTER:1,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:1},USERDEFINED:{POINT:1,CENTER:1,AXISSYSTEM:1}},ad={NOPATTERN:["POINT","CENTER","LINE","CYLINDER","AXISSYSTEM","AXISSYSTEMORIGIN","AXISSYSTEMAXIS","REFERENCE"],NOPATTERN_LINEAR:["POINT","CENTER","LINE","CYLINDER","AXISSYSTEMORIGIN","AXISSYSTEMAXIS"],NOPATTERN_RECTANGULAR:["POINT","CENTER","LINE","CYLINDER","AXISSYSTEMORIGIN","AXISSYSTEMAXIS"],NOPATTERN_CIRCULAR:["POINT","CENTER","LINE","CYLINDER","AXISSYSTEMORIGIN","AXISSYSTEMAXIS"],NOPATTERN_USERDEFINED:["POINT","CENTER","AXISSYSTEM"],LINEAR:["POINT","CENTER","LINE","CYLINDER","AXISSYSTEMORIGIN","AXISSYSTEMAXIS"],RECTANGULAR:["POINT","CENTER","AXISSYSTEMORIGIN","AXISSYSTEMAXIS"],CIRCULAR:["POINT","CENTER","AXISSYSTEMORIGIN","AXISSYSTEMAXIS"],USERDEFINED:["POINT","CENTER","AXISSYSTEM"]},am=new u(az),M=function(aE){return(aE===F.geometryTypesEnum.POINT||aE===F.geometryTypesEnum.CIRCLE||aE===F.geometryTypesEnum.AXISSYSTEM||aE===F.geometryTypesEnum.AXISSYSTEMORIGIN)},J=function(){var aE={version:3,reuse:G,radioPattern:ag,direction1:P,direction2:O,filters:ay};aE.reuse=true;localStorage.setItem("CAT3DComposeAssemblyPatternCmd",JSON.stringify(aE))},S=function(){var aE=JSON.parse(localStorage.getItem("CAT3DComposeAssemblyPatternCmd"));if(aE&&aE.version===3){G=(typeof aE.reuse==="object")?aE.reuse:G;ag=(typeof aE.radioPattern==="object")?aE.radioPattern:ag;P=(typeof aE.direction1==="object")?aE.direction1:P;O=(typeof aE.direction2==="object")?aE.direction2:O;ay=(typeof aE.filters==="object")?aE.filters:ay}},L=function(aH){var aE,aG,aF={bReference:Boolean(z),bOrigin:Boolean(y),typesCount:{}};for(aE in F.geometryTypesEnum){if(F.geometryTypesEnum.hasOwnProperty(aE)){aF.typesCount[F.geometryTypesEnum[aE]]=0}}for(aE in ao){if(ao.hasOwnProperty(aE)&&aE!==y&&aE!==z){aF.typesCount[ao[aE].type]++}}if(F.object3D[0]&&!ao[F.object3D[0].pathElement.getKey()]){aG=F.getSelType(F.object3D[0].pathElement);if(!z&&aG===F.geometryTypesEnum.REFERENCE){aF.bReference=true}else{if(!y&&M(aG)){aF.bOrigin=true}else{if(y||aH===aC.USERDEFINED.id||!M(aG)){aF.typesCount[aG]++}}}}return aF},N=function(aI,aF,aE,aH){var aG;aE=(typeof aE==="undefined")?true:aE;aH=(typeof aH==="undefined")?true:aH;am.removeFlag(V[aI]);V[aI].destroy();delete V[aI];if(aI!==z&&aH){delete ao[aI]}if(aI===E){E=null;if(D){P.count=O.count;P.spacing=O.spacing;O.reverse=O.reverse;V[D].destroy();delete V[D];E=D;D=null}}else{if(aI===D){D=null}else{if(aI===y){if(aF&&aF==="NOPATTERN"){aG="NOPATTERN";if(z){aG=aG+"_"+ag}ay[aG]=F.getActiveFilters();aj=null}az.removeNode(an);y=null}}}F.object3D[0]=null;if(aE){i.publish({event:"C3D_UNSELECT_EVT"})}},I=function(aE){var aL,aH,aG,aM,aI,aF,aJ=0,aK=L(aE.stateID);if(!aK||!aK.bReference){return false}aJ=0;aM=Object.keys(aK.typesCount);aI=aM.length;aG=aE.validTypes.length;for(aL=0;aL<aI;++aL){if(aK.typesCount[aM[aL]]>0){aF=false;for(aH=0;aH<aG;++aH){if(aM[aL]===aE.validTypes[aH].type.toString()&&!(aE.validTypes[aH].maxcount&&aK.typesCount[aM[aL]]>aE.validTypes[aH].maxcount)){aJ+=aK.typesCount[aM[aL]];aF=true;break}}if(!aF){return false}}}if(aE.stateID===aC.USERDEFINED.id&&aK.bOrigin){aJ++}if(aE.stateID===aC.CIRCULAR.id&&aK.bOrigin&&aJ===0){aJ++}if((aE.validSelCount>-1&&aJ===aE.validSelCount)||(aE.validSelCount===-1&&aJ>0)){return true}return false},ax=function(aG,aE,aF){var aH=new w.Vector3();if(aG.type===F.geometryTypesEnum.POINT){aH.subVectors(aG.canonicGeom.getPoint(),aE.position)}else{if(aG.type===F.geometryTypesEnum.LINE){aH.subVectors(aG.canonicGeom.getEndPoints().endPoint,aG.canonicGeom.getEndPoints().startPoint)}else{if(aG.type===F.geometryTypesEnum.CIRCLE){aH.subVectors(aG.canonicGeom.getCenter(),aE.position)}else{if(aG.type===F.geometryTypesEnum.CYLINDER){aH.subVectors(aG.canonicGeom.getEndPoints().endPoint,aG.canonicGeom.getEndPoints().startPoint)}else{if(aG.type===F.geometryTypesEnum.AXISSYSTEM||aG.type===F.geometryTypesEnum.AXISSYSTEMORIGIN){aH.subVectors(aG.position,aE.position)}else{if(aG.type===F.geometryTypesEnum.AXISSYSTEMAXIS){aH=aG.canonicGeom.getDirection()}}}}}}if(aF){return aH.normalize()}return aH},at=function(aG){var aH,aI,aF,aE;if(!aG.getParentPath){return null}aI=aG.getParentPath().clone();aE=aI.getLength();for(aF=(aE-1);aF>=0;--aF){aH=aI.externalPath[aF];if(aH&&h.isReference(aH)){aI.setFromArray(aI.externalPath.slice(0,(aF+1)));return aI}}return null},U=function(){var aF,aE=[];for(aF in aC){if((aC[aF].conditions&&I(aC[aF].conditions))||(z&&y&&Object.keys(ao).length===2&&["LINEAR","CIRCULAR","USERDEFINED"].indexOf(aF)!==-1)){aE.push(aF)}}if(aE.length===0){aE=["LINEAR","CIRCULAR","USERDEFINED"]}return aE},Z=function(aE){if(x.hasOwnProperty(aE)){x[aE].pRefParent.getLastElement().removeChild(x[aE].node);delete x[aE];al--}az.render()},ap=function(){var aE;if(x){for(aE in x){if(x.hasOwnProperty(aE)){Z(aE)}}}},ae=function(aF){var aE=f.get3DComposeAnimationEngine({viewer:az}),aG=new l({headLength:10,arrowLength:50,arrowWidth:2,colors:{colorX:new c.Color(0.25,0.63,0.85,1),colorY:new c.Color(0.25,0.63,0.85,1),colorZ:new c.Color(0.25,0.63,0.85,1)},head:l.types.ARROW});aG.exludeFromBounding(true);aG.setVisibilityInTree(false);aG.setPickable(c.NODRAWHL);aG.setMatrix(aF);az.addNode(aG);aE.axisSystemVisibility({objectListToAnimate:[aG],visibility:true,pickability:false});aE.startAnimation();return aG},af=function(aL,aK,aH){var aJ,aI,aG,aE,aF;aG=aK.clone();aF=aK.getWorldMatrix();aF.getInverse(aF);aJ=new w.Matrix4();aJ.multiplyMatrices(aF,aH);al++;aI=new k("PreviewNode"+al);aI.setMatrix(aJ);aI.addChild(aL.pathElement.getLastElement());aK.getLastElement().addChild(aI);aG.addElement(aI);aE=aG.getKey();x[aE]={node:aI,activated:true,pathElement:aG,pRefParent:aK};return aE},aD=function(aG,aF,aE){var aH={position:new w.Matrix4().setPosition(ao[aG].position),iconUrl:ao[aG].iconUrl?ao[aG].iconUrl:"",closeButton:true,closeCB:function(){N(aG,aE)}};V[aG]=new a(az,aH);if(aF){V[aG].setOffset(aF)}am.addFlag(V[aG])},B=function(aF,aI,aE,aG,aH){var aJ={position:ao[aI].clickPos?new w.Matrix4().setPosition(ao[aI].clickPos):new w.Matrix4(),label:aE,iconUrl:ao[aI].iconUrl?ao[aI].iconUrl:"",closeButton:true,closeCB:function(){N(aI,aF)},dialogs:[{type:r.fieldsTypeEnum.INTEGER,value:aG.count,suffix:d.SUFFIX_INSTANCES,fnCallback:function(aK){aG.count=parseInt(aK);i.publish({event:"C3D_PARAMETERS_CHG"})}},{type:r.fieldsTypeEnum.DOUBLE,prefix:d.PREFIX_SPACING,value:(aF==="CIRCULAR")?aG.angle:aG.spacing,suffix:(aF==="CIRCULAR")?"°":"mm",fnCallback:function(aK){if(aF==="CIRCULAR"){aG.angle=parseInt(aK)}else{aG.spacing=parseInt(aK)}i.publish({event:"C3D_PARAMETERS_CHG"})}},{type:r.fieldsTypeEnum.BOOLEAN,iconUrl:b.getWebappsAssetUrl("CAT3DComposeCommands","icons/32/")+"I_C3DReverseDirection.png",value:aG.reverse,fnCallback:function(aK){aG.reverse=aK;i.publish({event:"C3D_PARAMETERS_CHG"})}}]};V[aI]=new a(az,aJ);if(aH){V[aI].setOffset(aH)}am.addFlag(V[aI])},au=function(aL){var aI,aN,aK,aM,aG,aH,aF,aE,aO,aP=(aL==="NOPATTERN")?ag:aL,aJ={};for(aN in V){if(V.hasOwnProperty(aN)){aJ[aN]=V[aN].getOffset();am.removeFlag(V[aN]);V[aN].destroy();delete V[aN]}}if(an){az.removeNode(an)}if(z){aH=U();aI=[{value:aP,iconUrl:aC[aP].iconUrl,label:d["LABEL_"+aP],isdefault:true}];aG=aH.length||0;for(aM=0;aM<aG;++aM){if(aH[aM]!==aP){aI.push({value:aH[aM],iconUrl:aC[aH[aM]].iconUrl,label:d["LABEL_"+aH[aM]]})}}aF={position:ao[z].clickPos?new w.Matrix4().setPosition(ao[z].clickPos):new w.Matrix4().setPosition(ao[z].position),label:d.FLAG_REF_LABEL,iconUrl:ao[z].iconUrl?ao[z].iconUrl:"",closeButton:true,closeCB:function(){am.removeFlag(V[z+"ref"]);V[z+"ref"].destroy();delete V[z+"ref"];if(z!==y){delete ao[z]}if(aL==="NOPATTERN"){aE="NOPATTERN";if(z){aE=aE+"_"+ag}ay[aE]=F.getActiveFilters();aj=null}z=null;F.object3D[0]=null;i.publish({event:"C3D_UNSELECT_EVT"})},dialogs:[{type:r.fieldsTypeEnum.RADIO,radios:aI,fnCallback:function(aQ){X=ag;ag=aQ;au(ag);i.publish({event:"C3D_PATTERN_CHG"})}},{type:r.fieldsTypeEnum.BOOLEAN,iconUrl:b.getWebappsAssetUrl("CAT3DComposeCommands","icons/32/")+"I_C3DReuse.png",value:G}]};V[z+"ref"]=new a(az,aF);V[z+"ref"].setOffset(aJ[z+"ref"]);aO=V[z+"ref"].flagPanel.getElement().getElementsByClassName("WUXFlagPanelBtnDialog")[1];aO.style.width=0;aO.style.border=0;aO.style.padding=0;aO.style.margin=0;am.addFlag(V[z+"ref"])}if(z&&V[z+"ref"]&&z!==y){V[z+"ref"].flagPanel.getElement().getElementsByClassName("WUXFlagPanelBtnDialog")[1].removeClassName("hidden")}else{if(z&&V[z+"ref"]){V[z+"ref"].flagPanel.getElement().getElementsByClassName("WUXFlagPanelBtnDialog")[1].addClassName("hidden")}}if(y&&!(aL===aC.USERDEFINED.id||aP===aC.USERDEFINED.id)){an=ae(ao[y].worldMatrix.clone().setPosition(ao[y].position));if(aL===aC.CIRCULAR.id&&!E&&!D){B(aL,y,d.LABEL_AXIS,P,aJ[y])}else{aF={position:new w.Matrix4().setPosition(ao[y].position),label:d.FLAG_ORIGIN_LABEL,iconUrl:ao[y].iconUrl?ao[y].iconUrl:"",closeButton:true,closeCB:function(){N(y,aL)}};if(y===z){aF.offset=new w.Vector2(0,50)}V[y]=new a(az,aF);V[y].setOffset(aJ[y]);am.addFlag(V[y])}}if(aL===aC.USERDEFINED.id||aP===aC.USERDEFINED.id){for(aK in ao){if(ao.hasOwnProperty(aK)&&aK!==z){aD(aK,aJ[aK],aL)}}}else{if(E){B(aL,E,d.LABEL_DIR1,P,aJ[E])}if(D){B(aL,D,d.LABEL_DIR2,O,aJ[D])}}},Y=function(aS){var aX,aQ,aZ,aN,a0,aF,aG,aE,aR,aT,a1,aI,aJ,aP,aV,aO,aU,aW,aH,aY,aL,aK=[],aM=az.getSceneGraphOverrideSetManager();if(aw){aM.removeSceneGraphOverrideSet(aw);aw=null}aw=new n(W.getRootBagPath().externalPath[0]);for(aX in x){if(x.hasOwnProperty(aX)){Z(aX)}}if(z){aK.push(ao[z].pathElement);aZ=(y&&ao.hasOwnProperty(y))?ao[y]:null;if(aS!=="USERDEFINED"&&ag!=="USERDEFINED"){if(y){aG=y}if(E){aP=ax(ao[E],aZ,true);aG=E;aW=aP.clone().setLength(((P.reverse)?-1:1)*P.spacing);aV=new w.Matrix4().makeTranslation(aW.x,aW.y,aW.z)}if(D){aO=ax(ao[D],aZ,true);aW=aO.clone().setLength(((O.reverse)?-1:1)*O.spacing);aU=new w.Matrix4().makeTranslation(aW.x,aW.y,aW.z)}}aJ=ao[z];a1=at(aJ.pathElement);aI=a1.getWorldMatrix();aI.getInverse(aI);aH=(G)?aJ.worldMatrix.clone().setPosition(aJ.position):aJ.worldMatrix.clone().setPosition(aZ.position);switch(aS){case aC.LINEAR.id:if(E){for(aN=0;aN<P.count;++aN){if(aN===0&&!G){}else{if(aN>0){aH=aV.clone().multiply(aH);aY=af(aJ,a1,aH);aK.push(x[aY].pathElement)}}}}break;case aC.RECTANGULAR.id:if(E&&D){aT=aH.clone();for(aR=0;aR<O.count;++aR){if(aR>0){aT=aU.clone().multiply(aT)}aH=aT.clone();for(aN=0;aN<P.count;++aN){if(aN===0&&(aR>0||!G)){aY=af(aJ,a1,aH);aK.push(x[aY].pathElement)}else{if(aN>0){aH=aV.clone().multiply(aH);aY=af(aJ,a1,aH);aK.push(x[aY].pathElement)}}}}}break;case aC.CIRCULAR.id:if(aG){aF=(aP)?aP:ao[aG].canonicGeom.getNormal().clone();aQ=new w.Matrix4().makeRotationAxis(aF,((P.reverse)?-1:1)*P.angle*Math.PI/180);aE=new w.Matrix4().setPosition(ao[aG].position);for(aN=0;aN<P.count;++aN){if(aN===0&&!G){}else{if(aN>0){aH=aE.clone().multiply(aQ.clone().multiply(new w.Matrix4().getInverse(aE).multiply(aH)));aY=af(aJ,a1,aH);aK.push(x[aY].pathElement)}}}}break;case aC.USERDEFINED.id:for(a0 in ao){if(ao.hasOwnProperty(a0)&&a0!==z){if(ao[a0].type===F.geometryTypesEnum.AXISSYSTEM){aH=ao[a0].worldMatrix.clone()}else{aH=aJ.worldMatrix.clone().setPosition(ao[a0].position)}aY=af(aJ,a1,aH);aK.push(x[aY].pathElement)}}break;default:}}if(aw){aL=aw.createOverride({pathes:aK});if(aL){aL.setOpacity(0.5);aL.setPickability("IGNORED")}aM.pushSceneGraphOverrideSet(aw)}},R=function(){var aE;g.empty();for(aE in ao){if(ao.hasOwnProperty(aE)){g.add(ao[aE])}}for(aE in x){if(x.hasOwnProperty(aE)){g.add(x[aE])}}},aB=function(aF){var aE=null,aG=b.getWebappsAssetUrl("DMUBaseCommands","icons/32/"),aH=b.getWebappsAssetUrl("CAT3DComposeCommands","icons/32/");switch(aF){case F.geometryTypesEnum.POINT:aE=aG+"I_Meas_Point.png";break;case F.geometryTypesEnum.CENTER:aE=aG+"I_Meas_PointCircle.png";break;case F.geometryTypesEnum.CIRCLE:aE=aG+"I_Meas_PointCircle.png";break;case F.geometryTypesEnum.AXISSYSTEM:aE=aH+"I_3DComposeAxisSystem.png";break;case F.geometryTypesEnum.AXISSYSTEMORIGIN:aE=aH+"I_C3DAxisOrigin.png";break;case F.geometryTypesEnum.AXISSYSTEMAXIS:aE=aH+"I_C3DAxisAxis.png";break;case F.geometryTypesEnum.PLANE:aE=aG+"I_Meas_Plane.png";break;case F.geometryTypesEnum.CYLINDER:aE=aG+"I_Meas_Cylinder.png";break;case F.geometryTypesEnum.LINE:aE=aG+"I_Meas_Line.png";break;default:}return aE},aA=function(aE){var aF=h.getNodeID(ao[aE].pathElement.getLastElement(true));z=aE;ao[aE].iconUrl="";W.getController().getAttributes({ids:[aF],attributes:["type_icon_url"],callbacks:{onComplete:function(aG){ao[aE].iconUrl=aG[aF]?aG[aF].type_icon_url:"";if(V[aE+"ref"]){V[aE+"ref"].setIcon(ao[aE].iconUrl)}},onFailure:function(){}}})},aa=function(aE){y=aE},Q=function(aF){var aE=null,aG=aF.getType();if(typeof aG==="undefined"){return null}switch(aG){case F.geometryTypesEnum.POINT:aE=aF.getPoint();break;case F.geometryTypesEnum.LINE:case F.geometryTypesEnum.CYLINDER:aE=aF.getEndPoints().startPoint;break;case F.geometryTypesEnum.CIRCLE:case F.geometryTypesEnum.CENTER:aE=aF.getCenter();break;default:}return aE},A=function(aJ){var aG,aF,aE,aI=aJ,aH;if(aj){ay[aj]=F.getActiveFilters()}if(z&&aI===aC.NOPATTERN.id){aI=aI+"_"+ag}aH=ay[aI];if(z&&aH.REFERENCE){delete aH.REFERENCE}aF=0;aE=ad[aI].length;for(aF;aF<aE;++aF){if(!aH.hasOwnProperty(ad[aI][aF])){aH[ad[aI][aF]]=0}}for(aG in aH){if(aH.hasOwnProperty(aG)&&ad[aI].indexOf(aG)===-1){delete aH[aG]}}if(aJ===aC.CIRCULAR.id&&E){aH={}}F.updateFilters(aH,false)},ai=function(aG){var aH=Object.keys(ao),aF,aE=aH.length;if(!y){if(D&&M(ao[D].type)){N(D,aG,false,false)}if(E&&M(ao[E].type)){N(E,aG,false,false)}}for(aF=0;aF<aE;++aF){if(M(ao[aH[aF]].type)){if(!y&&aH[aF]!==E&&aH[aF]!==D){aa(aH[aF]);continue}if(!E&&aH[aF]!==y&&aH[aF]!==D){E=aH[aF];continue}if(!D&&aH[aF]!==E&&aH[aF]!==y){D=aH[aF];continue}}}au(aG)},av=function(aG,aI,aL){var aF=null,aM,aJ=new w.Vector3(),aH,aE,aK;if(F.object3D[0]&&F.object3D[0].pathElement){aF=F.object3D[0].pathElement}if(aF&&!ao[aF.getKey()]){aM=e.getEquivalentGeometry({pathElement:aF,axisSystemSub:true});aE=aM?aM.getType():F.geometryTypesEnum.REFERENCE;aK=aF.getWorldMatrix();aH=aF.getKey();if(aE===F.geometryTypesEnum.REFERENCE||aE===F.geometryTypesEnum.AXISSYSTEM||aE===F.geometryTypesEnum.AXISSYSTEMAXIS){aJ.getPositionFromMatrix(aK)}else{aJ=Q(aM)}ao[aH]={pathElement:aF,type:aE,worldMatrix:aK,position:aJ,clickPos:F.object3D[0].position,canonicGeom:aM,iconUrl:aB(aE)};if(aE===F.geometryTypesEnum.AXISSYSTEM){ao[aH].clickPos=aJ}if(!z&&aE===F.geometryTypesEnum.REFERENCE){aA(aH)}else{if(!y&&aG.id!==aC.USERDEFINED.id&&M(aE)){aa(aH)}else{if(aH!==y&&aH!==z){if(!E){E=aH;if(y&&(aE===F.geometryTypesEnum.POINT||aE===F.geometryTypesEnum.CIRCLE||aE===F.geometryTypesEnum.AXISSYSTEMORIGIN)){P.spacing=Math.round(ao[y].position.distanceTo(aJ)*1000)/1000}}else{if(!D){D=aH;if(y&&(aE===F.geometryTypesEnum.POINT||aE===F.geometryTypesEnum.CIRCLE||aE===F.geometryTypesEnum.AXISSYSTEM)){O.spacing=Math.round(ao[y].position.distanceTo(aJ)*1000)/1000}}}}}}F.object3D=[]}au(aG.id);A(aG.id,aj);J();Y(aG.id);if(aG.id!==aC.NOPATTERN.id){C.removeAll(function(){C.add({message:d["LABEL_"+aG.id],closable:false,buttons:[{label:d.SAVEBTN,className:"primary",onClick:function(){i.publish({event:"C3D_SAVE_CLICK"})},doClose:true},{label:d.CANCELBTN,className:"default",onClick:function(){i.publish({event:"C3D_CANCEL_CLICK"})},doClose:true}]})})}else{C.removeAll(function(){var aN=0;if(z){aN=1}C.add({message:d["LABEL_"+aG.id+"_"+aN],closable:false,buttons:[{label:d.CANCELBTN,className:"default",onClick:function(){i.publish({event:"C3D_CANCEL_CLICK"})},doClose:true}]})})}aL();R()},ar=function(aG,aE,aF){Y(aG.id);A(aG.id,aj);J();aF();R()},ak=function(){if(z){return true}else{C.add({message:d.NOREFERROR,msgType:"warning",autoHide:true,closable:true})}return false},ah=function(aE){var aJ,aI,aG,aH=az,aF={context:W,parentID:null,children:[],onCompleted:function(aK){var aL=aK.length||0;if(aL===0){aE();return}aK.forEach(function(aM){aL--;if(!aM.instID&&aM.message){C.add({message:aM.message,msgType:"error",autoHide:true,closable:true})}if(aL===0){aE()}})}};if(x&&ao){aI=ao[z];aG=h.getNodeID(aI.pathElement.getLastElement());aF.parentID=h.getNodeID(at(aI.pathElement).getLastElement());for(aJ in x){if(x.hasOwnProperty(aJ)&&x[aJ].activated){aF.children.push({id:aG,matrix:x[aJ].pathElement.getMatrix(aH)})}}q.insertExisting(aF)}},ac=function(aE){aE()};this.beginExecute=function(){y=null;z=null;E=null;D=null;ao={};C=new p().inject(aq.getUIFrame());V=[];if(g.isEmpty()){C.add({message:d.LABEL_NOPATTERN_0,closable:false,buttons:[{label:d.CANCELBTN,className:"default",onClick:function(){i.publish({event:"C3D_CANCEL_CLICK"})},doClose:true}]})}az.setDefaultPicking(false);K.call(H)};this.endExecute=function(){var aE;J();g.empty();y=null;z=null;E=null;D=null;if(x){ap()}if(aw){az.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(aw);aw=null}az.setDefaultPicking(true);if(F){F.deactivate()}ap();if(C){C.destroy();C=null}if(an){az.removeNode(an)}for(aE in V){if(V.hasOwnProperty(aE)){am.removeFlag(V[aE]);V[aE].destroy();delete V[aE]}}V.length=0;T.call(H)};this.buildGraph=function(){var aK=b.getWebappsAssetUrl("CAT3DComposeCommands","icons/32/"),aE=this.createInitialState("NoPatternState"),aF=this.createState("LinearState"),aH=this.createState("RectangularState"),aI=this.createState("CircularState"),aL=this.createState("UserDefineState"),aJ=this.getFinalState(),aG=ay.NOPATTERN;if(!z){aG={POINT:0,CENTER:0,LINE:0,CYLINDER:0,AXISSYSTEM:0,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:0,REFERENCE:1}}F=new v({context:W,activeFilters:aG,postFilter:function(aN){var aM=h.getRoots(W);if(!h.isAModelPath(aN)){return false}if(Array.isArray(aM)&&aM.indexOf(aN.getLastElement())!==-1){return false}return true}});aC={NOPATTERN:{id:"NOPATTERN",iconUrl:"",chkConditions:function(){return true},actions:function(aM){av(aC.NOPATTERN,"NoPattern State",aM)}},LINEAR:{id:"LINEAR",iconUrl:aK+"I_C3DRectangularPattern.png",chkConditions:function(){if(ag!=="LINEAR"&&ag!=="RECTANGULAR"){return false}return I(aC.LINEAR.conditions)},conditions:{stateID:"LINEAR",debugTxt:"Linear pattern condition",validSelCount:1,validTypes:[{type:F.geometryTypesEnum.POINT},{type:F.geometryTypesEnum.CIRCLE},{type:F.geometryTypesEnum.LINE},{type:F.geometryTypesEnum.AXISSYSTEM},{type:F.geometryTypesEnum.AXISSYSTEMAXIS},{type:F.geometryTypesEnum.CYLINDER}]},actions:function(aM){av(aC.LINEAR,"Linear State",aM)}},RECTANGULAR:{id:"RECTANGULAR",iconUrl:aK+"I_C3DRectangularPattern.png",chkConditions:function(){if((ag!=="LINEAR"&&ag!=="RECTANGULAR")||!E){return false}return I(aC.RECTANGULAR.conditions)},conditions:{stateID:"RECTANGULAR",debugTxt:"Rectangular pattern condition",validSelCount:2,validTypes:[{type:F.geometryTypesEnum.POINT},{type:F.geometryTypesEnum.CIRCLE},{type:F.geometryTypesEnum.LINE},{type:F.geometryTypesEnum.CYLINDER},{type:F.geometryTypesEnum.AXISSYSTEM},{type:F.geometryTypesEnum.AXISSYSTEMAXIS}]},actions:function(aM){av(aC.RECTANGULAR,"Rectangular State",aM);az.setDefaultPicking(false)}},CIRCULAR:{id:"CIRCULAR",iconUrl:aK+"I_C3DCircularPattern.png",chkConditions:function(){if(ag!=="CIRCULAR"){return false}return I(aC.CIRCULAR.conditions)},conditions:{stateID:"CIRCULAR",debugTxt:"Circular pattern condition",validSelCount:1,validTypes:[{type:F.geometryTypesEnum.POINT},{type:F.geometryTypesEnum.CIRCLE},{type:F.geometryTypesEnum.CYLINDER},{type:F.geometryTypesEnum.LINE},{type:F.geometryTypesEnum.AXISSYSTEM},{type:F.geometryTypesEnum.AXISSYSTEMAXIS}]},actions:function(aM){av(aC.CIRCULAR,"Circular State",aM)}},USERDEFINED:{id:"USERDEFINED",iconUrl:aK+"I_C3DUserPattern.png",chkConditions:function(){if(ag!=="USERDEFINED"){return false}return I(aC.USERDEFINED.conditions)},conditions:{stateID:"USERDEFINED",debugTxt:"User defined pattern condition",validSelCount:-1,validTypes:[{type:F.geometryTypesEnum.POINT},{type:F.geometryTypesEnum.CIRCLE},{type:F.geometryTypesEnum.AXISSYSTEM}]},actions:function(aM){av(aC.USERDEFINED,"User defined State",aM)}}};this.addTransition({iInitialState:aE,iFinalState:aF,iEvent:F,iCondition:function(){return aC.LINEAR.chkConditions()},iAction:function(aM){aj="NOPATTERN_LINEAR";aC.LINEAR.actions(aM)},iSender:H});this.addTransition({iInitialState:aE,iFinalState:aH,iEvent:F,iCondition:function(){return aC.RECTANGULAR.chkConditions()},iAction:function(aM){aj="NOPATTERN_LINEAR";aC.RECTANGULAR.actions(aM)},iSender:H});this.addTransition({iInitialState:aE,iFinalState:aI,iEvent:F,iCondition:function(){return aC.CIRCULAR.chkConditions()},iAction:function(aM){aj="NOPATTERN_CIRCULAR";aC.CIRCULAR.actions(aM)},iSender:H});this.addTransition({iInitialState:aE,iFinalState:aL,iEvent:F,iCondition:function(){return aC.USERDEFINED.chkConditions()},iAction:function(aM){aj="NOPATTERN_USERDEFINED";aC.USERDEFINED.actions(aM)},iSender:H});this.addTransition({iInitialState:aE,iFinalState:aJ,iEvent:"C3D_CANCEL_CLICK",iAction:function(aM){aj="NOPATTERN";if(z){aj=aj+"_"+ag}ac(aM)}});this.addTransition({iInitialState:aE,iFinalState:aE,iEvent:F,iCondition:function(){return aC.NOPATTERN.chkConditions()},iAction:function(aM){aj="NOPATTERN";if(z){aj=aj+"_"+ag}aC.NOPATTERN.actions(aM)},iSender:H});this.addTransition({iInitialState:aF,iFinalState:aF,iEvent:F,iCondition:function(){return aC.LINEAR.chkConditions()},iAction:function(aM){aj="LINEAR";aC.LINEAR.actions(aM)},iSender:H});this.addTransition({iInitialState:aF,iFinalState:aF,iEvent:"C3D_PARAMETERS_CHG",iAction:function(aM){aj="LINEAR";ar(aC.LINEAR,"linearState to linearState",aM)}});this.addTransition({iInitialState:aF,iFinalState:aH,iEvent:F,iCondition:function(){return aC.RECTANGULAR.chkConditions()},iAction:function(aM){aj="LINEAR";aC.RECTANGULAR.actions(aM)},iSender:H});this.addTransition({iInitialState:aF,iFinalState:aJ,iEvent:"C3D_CANCEL_CLICK",iAction:function(aM){aj="LINEAR";ac(aM)}});this.addTransition({iInitialState:aF,iFinalState:aJ,iEvent:"C3D_SAVE_CLICK",iCondition:function(){return ak()},iAction:function(aM){aj="LINEAR";ah(aM)}});this.addTransition({iInitialState:aH,iFinalState:aH,iEvent:"C3D_PARAMETERS_CHG",iAction:function(aM){aj="RECTANGULAR";ar(aC.RECTANGULAR,"rectangularState to rectangularState",aM)}});this.addTransition({iInitialState:aH,iFinalState:aJ,iEvent:"C3D_CANCEL_CLICK",iAction:function(aM){aj="RECTANGULAR";ac(aM)}});this.addTransition({iInitialState:aH,iFinalState:aJ,iEvent:"C3D_SAVE_CLICK",iCondition:function(){return ak()},iAction:function(aM){aj="RECTANGULAR";ah(aM)}});this.addTransition({iInitialState:aI,iFinalState:aI,iEvent:F,iCondition:function(){return aC.CIRCULAR.chkConditions()},iAction:function(aM){aj="CIRCULAR";aC.CIRCULAR.actions(aM)},iSender:H});this.addTransition({iInitialState:aI,iFinalState:aI,iEvent:"C3D_PARAMETERS_CHG",iAction:function(aM){aj="CIRCULAR";ar(aC.CIRCULAR,"circularState to circularState",aM)}});this.addTransition({iInitialState:aI,iFinalState:aJ,iEvent:"C3D_CANCEL_CLICK",iAction:function(aM){aj="CIRCULAR";ac(aM)}});this.addTransition({iInitialState:aI,iFinalState:aJ,iEvent:"C3D_SAVE_CLICK",iCondition:function(){return ak()},iAction:function(aM){aj="CIRCULAR";ah(aM)}});this.addTransition({iInitialState:aL,iFinalState:aL,iEvent:F,iCondition:function(){return aC.USERDEFINED.chkConditions()},iAction:function(aM){aj="USERDEFINED";aC.USERDEFINED.actions(aM)},iSender:H});this.addTransition({iInitialState:aL,iFinalState:aJ,iEvent:"C3D_CANCEL_CLICK",iAction:function(aM){aj="USERDEFINED";ac(aM)}});this.addTransition({iInitialState:aL,iFinalState:aJ,iEvent:"C3D_SAVE_CLICK",iCondition:function(){return ak()},iAction:function(aM){aj="USERDEFINED";ah(aM)}});this.addTransition({iInitialState:aF,iFinalState:aI,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return aC.CIRCULAR.chkConditions()},iAction:function(aM){aj="LINEAR";aC.CIRCULAR.actions(aM)}});this.addTransition({iInitialState:aF,iFinalState:aL,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return aC.USERDEFINED.chkConditions()},iAction:function(aM){aj="LINEAR";aC.USERDEFINED.actions(aM)}});this.addTransition({iInitialState:aI,iFinalState:aF,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return aC.LINEAR.chkConditions()},iAction:function(aM){aj="CIRCULAR";aC.LINEAR.actions(aM)}});this.addTransition({iInitialState:aI,iFinalState:aL,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return aC.USERDEFINED.chkConditions()},iAction:function(aM){aj="CIRCULAR";aC.USERDEFINED.actions(aM)}});this.addTransition({iInitialState:aL,iFinalState:aI,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return aC.CIRCULAR.chkConditions()},iAction:function(aM){ai(aC.CIRCULAR.id);aj="USERDEFINED";aC.CIRCULAR.actions(aM)}});this.addTransition({iInitialState:aH,iFinalState:aL,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return aC.USERDEFINED.chkConditions()},iAction:function(aM){aj="RECTANGULAR";aC.USERDEFINED.actions(aM)}});this.addTransition({iInitialState:aL,iFinalState:aH,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return aC.RECTANGULAR.chkConditions()},iAction:function(aM){ai(aC.RECTANGULAR.id);aj="USERDEFINED";aC.RECTANGULAR.actions(aM)}});this.addTransition({iInitialState:aL,iFinalState:aF,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return aC.LINEAR.chkConditions()},iAction:function(aM){ai(aC.LINEAR.id);aj="USERDEFINED";aC.LINEAR.actions(aM)}});this.addTransition({iInitialState:aF,iFinalState:aE,iEvent:"C3D_PATTERN_CHG",iAction:function(aM){aj="LINEAR";aC.NOPATTERN.actions(aM)}});this.addTransition({iInitialState:aH,iFinalState:aE,iEvent:"C3D_PATTERN_CHG",iAction:function(aM){aj="RECTANGULAR";aC.NOPATTERN.actions(aM)}});this.addTransition({iInitialState:aI,iFinalState:aE,iEvent:"C3D_PATTERN_CHG",iAction:function(aM){aj="CIRCULAR";aC.NOPATTERN.actions(aM)}});this.addTransition({iInitialState:aL,iFinalState:aE,iEvent:"C3D_PATTERN_CHG",iAction:function(aM){aj="USERDEFINED";aC.NOPATTERN.actions(aM)}});this.addTransition({iInitialState:aE,iFinalState:aF,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return aC.LINEAR.chkConditions()},iAction:function(aM){aj="NOPATTERN";aC.LINEAR.actions(aM)}});this.addTransition({iInitialState:aE,iFinalState:aH,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return aC.RECTANGULAR.chkConditions()},iAction:function(aM){aj="NOPATTERN";aC.RECTANGULAR.actions(aM)}});this.addTransition({iInitialState:aE,iFinalState:aI,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return aC.CIRCULAR.chkConditions()},iAction:function(aM){aj="NOPATTERN";aC.CIRCULAR.actions(aM)}});this.addTransition({iInitialState:aE,iFinalState:aL,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return aC.USERDEFINED.chkConditions()},iAction:function(aM){aj="NOPATTERN";aC.USERDEFINED.actions(aM)}});this.addTransition({iInitialState:aE,iFinalState:aE,iEvent:"C3D_PATTERN_CHG",iAction:function(aM){aj="NOPATTERN";if(z){aj=aj+"_"+X}aC.NOPATTERN.actions(aM)}});this.addTransition({iInitialState:aH,iFinalState:aF,iEvent:"C3D_UNSELECT_EVT",iCondition:function(){return aC.LINEAR.chkConditions()},iAction:function(aM){aj="RECTANGULAR";aC.LINEAR.actions(aM)}});this.addTransition({iInitialState:aL,iFinalState:aL,iEvent:"C3D_UNSELECT_EVT",iCondition:function(){return aC.USERDEFINED.chkConditions()},iAction:function(aM){aC.USERDEFINED.actions(aM)}});this.addTransition({iInitialState:aF,iFinalState:aE,iEvent:"C3D_UNSELECT_EVT",iAction:function(aM){aj="LINEAR";aC.NOPATTERN.actions(aM)}});this.addTransition({iInitialState:aI,iFinalState:aI,iEvent:"C3D_UNSELECT_EVT",iCondition:function(){return aC.CIRCULAR.chkConditions()},iAction:function(aM){aj="CIRCULAR";aC.CIRCULAR.actions(aM)}});this.addTransition({iInitialState:aI,iFinalState:aE,iEvent:"C3D_UNSELECT_EVT",iAction:function(aM){aj="CIRCULAR";aC.NOPATTERN.actions(aM)}});this.addTransition({iInitialState:aL,iFinalState:aE,iEvent:"C3D_UNSELECT_EVT",iAction:function(aM){aj="USERDEFINED";aC.NOPATTERN.actions(aM)}});this.addTransition({iInitialState:aH,iFinalState:aE,iEvent:"C3D_UNSELECT_EVT",iAction:function(aM){aj="RECTANGULAR";aC.NOPATTERN.actions(aM)}});this.addTransition({iInitialState:aE,iFinalState:aE,iEvent:"C3D_UNSELECT_EVT",iAction:function(aM){aC.NOPATTERN.actions(aM)}})};S();this._parent(ab,{mode:"exclusive",isAsynchronous:true,doServerCall:false});this.odtUtilsSetDefaultNbInstances=function(aE){P.count=aE;O.count=aE}}});return o});define("DS/CAT3DComposeUtils/CATC3DDropManager",["UWA/Class","DS/PADUtils/PADTypesMgt","DS/Visualization/ThreeJS_DS","DS/CAT3DComposeWidget/CAT3DComposeWidgetOptions","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/Selection/PSOManager","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/CATC3DGeometry/CATC3DGeometryEnums","DS/PADUtils/PADUtilsServices","DS/CoreEvents/ModelEvents","DS/CAT3DComposeMoveManager/CATC3DMoveReferent","DS/CAT3DComposeMoveManager/CAT3DComposeMoveManager","DS/ApplicationFrame/Command","DS/CAT3DComposeUtils/CATC3DUtils","i18n!DS/PADUtils/assets/nls/PADUtils.json","i18n!DS/CAT3DComposeUtils/assets/nls/CATC3DDropManager.json"],function(s,f,t,b,i,n,h,r,u,g,m,c,p,q,o,e,v){var k=b.getOption("authoring3d"),d=["CATProduct","CATPart","VPMReference","3DShape"],a=["CATProduct","VPMReference"];var l=s.extend({init:function(y){var F=y.context,D=F.getViewer(),E,C,I,H=this,N,J=new q({ID:"CATC3DDropMngFakeCmdHdr",context:F.getCommandContext?F.getCommandContext():null});function M(ab,R,V,Y){function W(ae){var ad=new t.Matrix4();ae.externalPath.forEach(function(af){ad.multiply(af.getMatrix())});return ad}if(V){if(V.length===1){Y();return}var U=W(R),Q=V.filter(function(ae,ad){return ad%2});F.getController().getAttributes({ids:Q,attributes:["matrixtxt"],callbacks:{onComplete:function(af){var ae=new t.Matrix4(),ad=new t.Matrix4();Q.forEach(function(ah){if(af[ah]&&af[ah].matrixtxt){var ag=af[ah].matrixtxt.replace(/^\[?|\]?$/g,"").split(",").map(parseFloat);ad.set(ag[0],ag[3],ag[6],ag[9],ag[1],ag[4],ag[7],ag[10],ag[2],ag[5],ag[8],ag[11],0,0,0,1);ae.multiply(ad)}});Y(ad.getInverse(U).multiply(ae))},onFailure:function(){Y()}}})}else{var Z,T=W(R),P=T.clone(),X=ab.equivalentGeometry?ab.equivalentGeometry.getType():null;switch(X){case u.GeometryType.POINT:Z=ab.equivalentGeometry.getPoint();break;case u.GeometryType.LINE:case u.GeometryType.CYLINDER:case u.GeometryType.CONE:var aa=ab.equivalentGeometry.getEndPoints();var ac=new t.Line3(aa.startPoint,aa.endPoint);Z=ab.position?ab.position.clone():null;if(Z){var S=ac.closestPointToPointParameter(Z,true);Z=ac.at(S>=0.5?1:0)}break;case u.GeometryType.CIRCLE:case u.GeometryType.SPHERE:Z=ab.equivalentGeometry.getCenter();break;case u.GeometryType.AXISSYSTEM:T=W(ab.pathElement);break;default:Z=ab.position?ab.position.clone():null}if(Z){T.setPosition(Z)}Y(new t.Matrix4().getInverse(P).multiply(T))}}function K(R){if(E){return{pathElement:E.clone()}}var P=D.pick(D.getMousePosition(new t.Vector2(R.offsetX,R.offsetY)),"primHybrid",true);if(!P||!P.path||P.path.length===0){return undefined}var Q=P.path[0];if(!Q||!Q.externalPath||Q.externalPath.length<2||!i.isAModelPath(Q)){return undefined}if(i.is3DLeaf(Q.externalPath[1])&&Q.externalPath.length>2){Q.externalPath.splice(2);Q.internalPath=[]}return{pathElement:Q,position:P.position}}function A(R,Q){try{f.retrieveAuthorizedObjects({displayNotif:false,dnd_event:R,version:"2.0",callback:function(T){var S={unauthorized:[],add:[],insert:[]};if(T.unauthorized_objects&&T.unauthorized_objects.length){S.unauthorized=T.unauthorized_objects}Object.keys(T.authorizedWithKind).forEach(function(U){if(U==="Product"){T.authorizedWithKind.Product.forEach(function(V){if(d.indexOf(V.objectType)===-1){S.add.push(V)}else{S.insert.push(V)}})}else{T.authorizedWithKind[U].forEach(function(V){S.add.push(V)})}});Q(S)}})}catch(P){window.console.log("")}}function w(Q){var P=n.get(),R=P.length?P[0].pathElement:null,S=!(R&&P[0].equivalentGeometry);return Q?!S:S}function G(){var P=i.getRoots(F);if(!P.length){return true}if(!P.some(function(R){return R&&!i.is3DLeaf(R)})){return true}var Q=E?E.getLastElement(true):null;if(Q&&Q.name==="RootBag"){return true}if(Q&&(!i.isPLMNode(Q)||a.indexOf(i.getNodeType(Q))===-1)){return true}return false}function x(T){if(G()){return}if(C){var R=C.getPosition();var S=C.getSize();if(R.x===0&&R.y===0){R.x=D.SCREEN_WIDTH/2-S.width/2;R.y=D.SCREEN_HEIGHT/2-S.height/2}if(R.x<=T.offsetX&&T.offsetX<=(R.x+S.width)&&R.y<=T.offsetY&&T.offsetY<=(R.y+S.height)){C.setOpacity(0)}else{var Q=Math.max(Math.min(T.offsetX,R.x+S.width),R.x);var V=Math.max(Math.min(T.offsetY,R.y+S.height),R.y);var U=Math.sqrt((T.offsetX-Q)*(T.offsetX-Q)+(T.offsetY-V)*(T.offsetY-V));if(U<200){C.setOpacity(U/200)}else{C.setOpacity(1)}}}var P=K(T);if(!P){n.empty();if(!E){return}}else{n.unique(P);n.get()[0].position=P.position}T.preventDefault();T.stopPropagation();F.elements.container.addClassName("bordered");document.querySelector(".paddnd_invite_display.insert .paddnd_invite_txt").setText(w(T.shiftKey)?"Insert object in position":"Insert");F._dropZoneContainer.show("insert")}function B(P){n.empty();h.empty();r.empty();C=document.querySelector(".paddnd_invite_container");return x(P)}function z(){if(C){C.setOpacity(1)}}function L(P){n.empty();return z(P)}function O(S){if(G()){return}if(C){C.setOpacity(1)}F._dropZoneContainer.hide();F.elements.container.removeClassName("bordered");var Q=n.get().slice();var P=E?E.clone():(Q.length?Q[0].pathElement:null);while(P){var R=P.getLastElement(true);if(R&&i.isReference(R)&&!i.is3DLeaf(R)){break}P=P.getParentPath()}if(!P){return}S.preventDefault();S.stopPropagation();A(S,function(X){if(X.unauthorized.length){X.unauthorized.forEach(function(aa){F.displayNotification({msg:e.replace(e.get("unsupported_type"),{type:aa.objectType,name:aa.displayName}),eventID:"warning"})})}if(X.insert.length){var T,U=false,Y=g.getPlatformId();for(T=0;T<X.insert.length;T++){if(Y!==X.insert[T].envId){X.insert.splice(T,1);U=true;T--}if(U){F.displayNotification({msg:v.Tenant_InsertInfo,eventID:"warning"})}}if(X.insert.length){var Z=i.getNodeID(P.getLastElement(true)),V=w(S.shiftKey),W=[];if(I){I.publish({event:"onBeginInsertDrop3D",data:{type:V?"inPosition":""}})}h.empty();r.empty();X.insert.forEach(function(ac){var aa=V?(ac.path?ac.path.map(function(ad){return ad.resourceid}):[ac.objectId]):null,ab=ac.objectId;M(Q[0],P,aa,function(ad){W.push({id:ab,matrix:ad});if(W.length===X.insert.length){J.begin();o.insertExisting({parentID:Z,children:W,context:F,onCompleted:function(ak){var ah=0,ae=r.get();ak.forEach(function(al){if(!al.instID){if(al.message){F.displayNotification({msg:al.message,eventID:"error"})}else{ah++}}});if(ah){F.displayNotification({msg:"Insertion failed",eventID:"error"})}var aj=p.getMoveManager({context:F});var af=c.getMoveReferentManager({context:F});ae.forEach(function(al){af.addMoveReferent(al.pathElement)});var ag=Q.length?Q[0].equivalentGeometry:null,ai=ag?ag.getType():null;if(ae.length&&(ai===u.GeometryType.LINE||ai===u.GeometryType.CYLINDER||ai===u.GeometryType.CONE||ai===u.GeometryType.PLANE||ai===u.GeometryType.REFPLANE)){require(["DS/CAT3DComposeConstraints/CAT3DComposeConstraintsController","DS/CATC3DGeometry/CATC3DEquivalentGeometry"],function(at,aq){if(!N){N=at.getConstraintsController({context:F})}N.deleteAllCst();var ao=aq.getEquivalentGeometry({pathElement:ae[0].pathElement,axis:N.getProductAxisForConstraint()});N.createCst({movable:{equivalentGeometry:ao},fixed:{equivalentGeometry:ag}});var ap=N.simulateSolveCst()||{};var am=ap.matrix||new t.Matrix4(),an=new t.Matrix4(),ar=ap.rc,al=ap.redundancy;if(ar===0&&!al){aj.onMoveBegin({objectsMoved:ae,from:H,moveMode:"Persistent"});ae.forEach(function(au){aj.onMove({objectsMoved:[{path:au.pathElement}],from:H,worldMatrix:an.multiplyMatrices(am,au.pathElement.getWorldMatrix())})});aj.onMoveEnd({from:H,status:"Moved"});F.getFrameWindow().getContextualUIManager().showContextualBar({x:S.offsetX+45,y:S.offsetY-45,hideWithDistance:true})}if(ae.length){require(["DS/CAT3DComposeBoxes/CAT3DComposeBoxController"],function(au){au.getBoxController({context:F}).refreshBoxes()})}if(I){I.publish({event:"onEndInsertDrop3D",data:{type:ae.length?(V?"inPosition":""):"cancelled"}})}})}else{if(ae.length){require(["DS/CAT3DComposeBoxes/CAT3DComposeBoxController"],function(al){al.getBoxController({context:F}).refreshBoxes()})}if(I){I.publish({event:"onEndInsertDrop3D",data:{type:ae.length?(V?"inPosition":""):"cancelled"}})}}}})}})})}}else{if(X.add.length){F.addRootNodesFromContent({json3DXContent:{data:{items:X.add}},dispatch:true,inContext:!S.shiftKey})}}})}this.connect=function(){if(!k){return}D.canvas.addEventListener("dragenter",B);D.canvas.addEventListener("dragover",x);D.canvas.addEventListener("dragleave",L);D.canvas.addEventListener("dragend",z);D.canvas.addEventListener("drop",O);E=null};this.disconnect=function(){if(!k){return}if(N){N.unreference()}D.canvas.removeEventListener("dragenter",B);D.canvas.removeEventListener("dragover",x);D.canvas.removeEventListener("dragleave",L);D.canvas.removeEventListener("dragend",z);D.canvas.removeEventListener("drop",O);E=null};this.setCurrentPath=function(P){E=P?P.clone():null};this.subscribe=function(P,Q){if(!I){I=new m()}return I.subscribe(P,Q)};this.unsubscribe=function(P){return I?I.unsubscribe(P):this}}});var j=[];return s.singleton({init:function(){},getDropManager:function(w){var x;if(w&&w.context&&w.context.name==="ENOPAD3DViewer"){j.some(function(y){if(y.context===w.context){x=y.dropMng;return true}return false});if(!x){x=new l({context:w.context});j.push({context:w.context,dropMng:x})}}return x},unreferenceDropManager:function(w){if(w&&w.context&&w.context.name==="ENOPAD3DViewer"){j.some(function(y,x){if(y.context===w.context){j.splice(x,1);return true}return false})}}})});