define("DS/SMAProcWebAuthoringUI/SMAProcWebProcessComposer",["DS/SMAProcWebDiagram/graph","DS/ApplicationFrame/ContextualBar","DS/ApplicationFrame/ContextualUIManager","DS/ApplicationFrame/FrameWindowsManager","DS/Selection/CSOManager","DS/ApplicationFrame/Command","DS/ApplicationFrame/CommandsManager","DS/JSCMM/SMAJSCMMProcess","DS/JSCMM/SMAJSCMMActivity","DS/JSCMM/SMAJSCMMStep","DS/ApplicationFrame/ContextualMenu","DS/SMAProcWebAuthoringUtils/SMAProcWebAuthoringServices","DS/SMAProcWebAsyncUtils/SMAProcWebTransactionManager","DS/SMAProcWebAsyncUtils/Activity/Create","DS/SMAProcWebAsyncUtils/Step/Create","DS/SMAProcWebAsyncUtils/Gateway/Create","DS/SMAProcWebAsyncUtils/SequenceFlow/Create","DS/SMAProcWebAsyncUtils/Activity/Connect","DS/SMAProcWebAsyncUtils/Activity/Disconnect","DS/SMAProcWebCmds/SMAInstantiateAdapterCmd","DS/SMAProcWebCMMUtils/SMAJSCMMAuthoringUtils","DS/SMAProcWebAuthoringUI/SMAProcWebProcessComposer_v2","DS/Logger/Logger","module"],function(z,r,v,l,E,u,a,y,n,c,x,d,k,H,m,e,p,g,D,j,h,G,F,b){var w=null;var f=null;var q=null;var A=null;var C=false;var B=null;var o=15;var t={FailedToCreateNewActivity:"Failed to create a new activity, please reload the process.\n",FailedToCreateNewStep:"Failed to create a new Step, please reload the process.\n",FailedToCreateNewGateway:"Failed to create a new Gateway, please reload the process.\n"};var I=F.getLogger(b);var s={setMappingMode:function(J){C=J},getMappingMode:function(){return C},isProcessOrActivitySelected:function(){if(A||w){return true}return false},validate:function(J,K){h.getExtensionDescriptor(J.getExtensionName(),{onSuccess:function(L){var M=L.getHandler();if(M){require([M],function(N){N.validate(J.getExtensionConfig(),K.getDataContainer()).then(function(){z.processDiagram.showStepStatus(J,"")},function(O){z.processDiagram.showStepStatus(J,O)})})}},onFailure:function(L){console.error(L);z.processDiagram.showStepStatus(J,"could not load extension descriptor")}})},uiCallback:{activityMoved:function(L,J,K){I.log("activity:",L,"\nedge:",J,"\nevent:",K);if((J.parent)&&(J.parent.getPhysicalId)&&(L.getPhysicalId()===J.parent.getPhysicalId())){I.log("Circular reference - can not connect the activity under the same activity.")}else{if(L&&J.parent&&J.parent!==null&&J.connected===true){k.add(new g(L,J.parent,J.from,J.to),{updateUI:function(){z.updateGraph(L.getProcess(),true)},failed:function(){d.displayClosableMessages("error",["SequenceFlowConnect.error"],true)},rollbackComplete:function(){z.updateGraph(L.getProcess(),true)}})}}},validLink:function(P,O,K){var L=true;if(P.isActivity()&&K&&P.getOutgoingFlowItems().length>0){L=false}var N=P.getParent();if(L&&O.isGateway()&&N&&!N.isProcess()){var J=P.getIncomingFlowItems();J.forEach(function(Q){if((Q.isGateway()&&Q===O)||!this.validLink(Q,O)){L=false}}.bind(this));if(L){var M=K?K:N;L=this.validLink(M,O)}}return L},addEdge:function(N,M,K){var L=K.getChild(N.getId());var J=K.getChild(M.getId());if(L===undefined||L===null){K.addChild(N);N.setParent(K)}if(J===undefined||J===null){K.addChild(M);M.setParent(K)}k.add(new p(K,N,M),{updateUI:function(O){z.updateGraph((O.isProcess())?O:O.getProcess(),true)},failed:function(){d.displayClosableMessages("error",["SequenceFlowConnect.error"],true)}})},createEdge:function(N,M,J){if(N&&M&&J){if(this.validLink(N,M,J)){var L=M.getParent();var K=N.getProcess();if(M.isActivity()&&L&&L!==K&&L!==J){k.add(new D(M),{updateUI:function(O){this.addEdge(N,M,O)}.bind(this),failed:function(){d.displayClosableMessages("error",["SequenceFlowConnect.error"],true)}})}else{this.addEdge(N,M,J)}}}},onProcessClicked:function(K,J){if(K){s.showContextualBar(J.pageX,J.pageY,K);s.updateHighlight(J,"process")}},onProcessRightClicked:function(K,J){if(K){s.showContextualBar(J.pageX,J.pageY,K);s.showContextualMenu(J.pageX,J.pageY,K);s.updateHighlight(J,"process")}},onActivityClicked:function(L,Q){I.log("Activity clicked "+L&&L.getId());if(L){var O=u.__activeCommand,K=null;var W=a.getCommand(O);var M=null;if(W&&W.getArguments()!==null){var R=W.getArguments();if(R.length>0&&R[0].ID==="type"){M=R[0].Value}}if(M!==null){I.log("creating step of type"+M);var S=M.substring(M.lastIndexOf(".")+1);d.displayClosableMessages("info",["StepCreate.info",S]);if(d.canCreateStep(L,M)===false){d.displayClosableMessages("error",["StepCreate.multipleProcessSteps.error"],true);a.getCommand(O).end();return false}var N=s.calculatePosition(Q);var V=N.x,U=N.y;var T=L.getSteps();if(T.length>0){K=z.getLocationInformation(V-o,U-o,V+o,U+o,L,false,true)}else{K={parent:L,from:null,to:null,connected:true}}if(T.length>0&&K.connected===false){K.from=L._steps[L._steps.length-1];L.setShowSteps(true);var J=L.getProcess();z.updateGraph(J,true)}I.log(K);a.getCommand(O).end();var J=z.getCurrentProcess();if(J===null||K===null){d.displayClosableMessages("error",["StepCreate.error"],true);return}var X=M.substring(M.lastIndexOf(".")+1);var P=d.getNextStepName(L,X+".Title");k.add(new m(L,K.from,K.to,P,M),{updateUI:function(){z.updateGraph(J,true)},success:function(){d.displayClosableMessages("success",["StepNameCreate.success",P])},failed:function(Y){d.displayNotification(t.FailedToCreateNewStep+"Step title: "+P+"\n"+Y,{messageType:"error"})},rollbackComplete:function(Y){if(Y){z.removeNode(Y.getId())}z.updateGraph(J,true)},rollbackFailed:function(){},after:function(){}})}else{if(O==="SMAWflAutDataFlowCmdHdr"){C=true;W.dataFlowTable&&W.dataFlowTable.toggleActivitySelection(L,"GRAPH")}else{C=false;s.showContextualBar(Q.pageX,Q.pageY,L);s.updateHighlight(Q,"activity")}}}},onActivityRightClicked:function(L,Q){I.log("Activity right clicked "+L.getId());var N=u.__activeCommand;if(N==="SMAWflAutDataFlowCmdHdr"){C=true}if(L&&!C){var K=null;var V=a.getCommand(N);var M=null;if(V!==undefined&&V!==null&&V.getArguments()!==null){var R=V.getArguments();if(R.length>0&&R[0].ID==="type"){M=R[0].Value}}if(M!==null){I.log("creating step of type"+M);if(d.canCreateStep(L,M)===false){d.displayClosableMessages("error",["StepCreate.multipleProcessSteps.error"],true);a.getCommand(N).end();return false}var O=s.calculatePosition(Q);var U=O.x,T=O.y;var S=L.getSteps();if(S.length>0){K=z.getLocationInformation(U-o,T-o,U+o,T+o,L)}else{K={parent:L,from:null,to:null,connected:true}}I.log(K);a.getCommand(N).end();var J=z.getCurrentProcess();if(J===null||K===null){d.displayClosableMessages("error",["StepCreate.error"],true);return}if(S.length>0&&K.connected===false){d.displayClosableMessages("error",["StepCreate.error"],true);return}var W=M.substring(M.lastIndexOf(".")+1);var P=d.getNextStepName(K.parent,W+".Title");k.add(new m(K.parent,K.from,K.to,P,M),{updateUI:function(){z.updateGraph(J,true)},success:function(){d.displayClosableMessages("success",["StepNameCreate.success",P])},failed:function(X){d.displayNotification(t.FailedToCreateNewStep+"Step title: "+P+"\n"+X,{messageType:"error"})},rollbackComplete:function(X){if(X){z.removeNode(X.getId())}z.updateGraph(J,true)},rollbackFailed:function(){},after:function(){}})}else{s.showContextualBar(Q.pageX,Q.pageY,L);s.showContextualMenu(Q.pageX,Q.pageY,L);s.updateHighlight(Q,"activity")}}else{}},onActivityHover:function(M,L){if(M){var J=a.getCurrentCmdId();if(J!=="NoRunningCmd"&&J!=="SMAProcWebActionBarEmptyActivityCmdHdr"&&J!=="SMAProcWebActionBarGatewayCmdHdr"&&J!=="SMAWflActionBarCreateActFromTempCmdHdr"){if(!M.getPosition().showSteps){M.setShowSteps(true);var K=M.getProcess();z.updateGraph(K,true)}}}},onStepRightClicked:function(J,K){I.log("Step right clicked "+J.getId());if(!s.isProcessOrActivitySelected()){C=false}if(!C){s.showContextualBar(K.pageX,K.pageY,J);s.showContextualMenu(K.pageX,K.pageY,J);s.updateHighlight(K,"step")}},onStepClicked:function(J,K){I.log("Step clicked "+J.getId());if(!s.isProcessOrActivitySelected()){C=false}if(!C){s.showContextualBar(K.pageX,K.pageY,J);s.updateHighlight(K,"step")}},onGatewayClicked:function(K,J){I.log("Gateway clicked "+K.getId());if(K){if(localStorage.getItem("SIMPRCW_AP_ENABLE_EXPERIMENTS")==="true"){s.showContextualBar(J.pageX,J.pageY,K)}s.updateHighlight(J,"gateway")}},onGatewayRightClicked:function(K,J){I.log("Gateway right clicked "+K.getId());if(K){if(localStorage.getItem("SIMPRCW_AP_ENABLE_EXPERIMENTS")==="true"){s.showContextualBar(J.pageX,J.pageY,K)}s.showContextualMenu(J.pageX,J.pageY,K);s.updateHighlight(J,"gateway")}},onEdgeRightClicked:function(J,K){I.log("Edge right clicked "+J);if(J){J.type="EDGE";s.showContextualMenu(K.clientX,K.clientY,J);s.unhighlight()}}},calculatePosition:function(L){var K=0,J=0;if(!L.pageX&&!L.pageY&&L.detail&&L.detail.x&&L.detail.y){L.pageX=L.detail.x;L.pageY=L.detail.y}if(L.pageX||L.pageY){K=L.pageX;J=L.pageY}else{if(L.clientX||L.clientY){K=L.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;J=L.clientY+document.body.scrollTop+document.documentElement.scrollTop}}return{x:K,y:J}},onComposerClicked:function(J){r.hide();x.hide();z.unhighlight();var K=u.__activeCommand;if(!K){C=false;s.unhighlight();E.empty()}if(J){J.preventDefault();J.stopPropagation()}s.executeCommand(J)},executeCommand:function(R){var N=a.getCurrentCmdId();var V=a.getCommand(N);var M=null;var O;var J,P;var U,T;if(N==="SMAProcWebActionBarEmptyActivityCmdHdr"){d.displayClosableMessages("info",["ActivityCreate.info"]);I.log("creating an activity");O=s.calculatePosition(R);U=O.x;T=O.y;M=z.getLocationInformation(U-o,T-o,U+o,T+o);V.end();J=z.getCurrentProcess();if(J===null||M===null){d.displayClosableMessages("error",["ActivityCreate.error"],true);return}P=d.getNextActivityName(J,"Activity.Title");k.add(new H(M.parent,P,M.from,M.to,M.connected),{before:function(){},updateUI:function(X){if(M.connected===false){var Z=z.getGraphCoordinates(U,T);var Y=X.getPosition();Y.x=Z[0]-(Y.width/2);Y.y=Z[1]-(Y.height/2);Y.connected=false;X.setPosition(Y)}z.updateGraph(J,true)},success:function(){d.displayClosableMessages("success",["ActivityCreate.success"])},failed:function(X){d.displayNotification(t.FailedToCreateNewActivity+X,{messageType:"error"})},rollbackComplete:function(Y){if(Y){for(var X=0;X<Y.length;X++){z.removeNode(Y[X].getId())}}z.updateGraph(J,true)},after:function(){}})}else{if(N==="SMAProcWebActionBarGatewayCmdHdr"){I.log("creating a Gateway");d.displayClosableMessages("info",["GatewayCreate.info"]);O=s.calculatePosition(R);U=O.x;T=O.y;M=z.getLocationInformation(U-o,T-o,U+o,T+o);V.end();J=z.getCurrentProcess();if(J===null||M===null){d.displayClosableMessages("error",["GatewayCreate.error"],true);return}if(M.connected!==true){d.displayClosableMessages("error",["GatewayCreate.unconnected.error"],true);return}P=d.getNextActivityName(J,"Gateway.Title");k.add(new e(M.parent,P,M.from,M.to,M.connected),{updateUI:function(X){if(M.connected===false){var Z=z.getGraphCoordinates(U,T);var Y=X.getPosition();Y.x=Z[0]-(Y.width/2);Y.y=Z[1]-(Y.height/2);Y.connected=false;X.setPosition(Y)}z.updateGraph(J,true)},success:function(){d.displayClosableMessages("success",["GatewayCreate.success"])},failed:function(X){d.displayNotification(t.FailedToCreateNewGateway+X,{messageType:"error"})},after:function(){}})}else{if(V&&V.getArguments&&V.getArguments()!==null){var S=V.getArguments();if(S.length>0&&S[0].ID==="type"){var L=S[0].Value;I.log("creating step of type"+L);O=s.calculatePosition(R);U=O.x;T=O.y;M=z.getLocationInformation(U-o,T-o,U+o,T+o);V.end();J=z.getCurrentProcess();if(J===null||M===null||M.parent===null){d.displayClosableMessages("error",["ActivityCreate.error"],true);return}if(L==="com.dassault_systemes.sma.adapter.Instantiate"){j.execute(M.parent,M.connected,M.from&&M.from.getId(),M.to&&M.to.getId());return}if(M.parent instanceof n){if((M.from!==null&&M.from instanceof c)||(M.to!==null&&M.to instanceof c)){var W=L.substring(L.lastIndexOf(".")+1);var Q=d.getNextStepName(M.parent,W+".Title");k.add(new m(M.parent,M.from,M.to,Q,L),{updateUI:function(){z.updateGraph(J,true)},success:function(){d.displayClosableMessages("success",["StepCreate.success"])},failed:function(X){d.displayNotification(t.FailedToCreateNewStep+X,{messageType:"error"})},rollbackComplete:function(X){if(X){z.removeNode(X.getId())}z.updateGraph(J,true)},rollbackFailed:function(){},after:function(){}});return}}var K=L.substring(L.lastIndexOf(".")+1);d.displayClosableMessages("info",["StepActivityCreate.info",K]);var W=L.substring(L.lastIndexOf(".")+1);P=d.getNextActivityName(J,W+".Title");k.add(new H(M.parent,P,M.from,M.to,M.connected),{before:function(){},updateUI:function(X){if(M.connected===false){var aa=z.getGraphCoordinates(U,T);var Z=X.getPosition();Z.x=aa[0]-(Z.width/2);Z.y=aa[1]-(Z.height/2);Z.connected=false;X.setPosition(Z)}var Y=d.getNextStepName(X,W+".Title");k.add(new m(X,null,null,Y,L),{updateUI:function(){z.updateGraph(J,true)},success:function(){d.displayClosableMessages("success",["StepNameCreate.success",Y])},failed:function(ab){d.displayNotification(t.FailedToCreateNewStep+"Step title: "+Y+"\n"+ab,{messageType:"error"})},rollbackComplete:function(ab){if(ab){z.removeNode(ab.getId())}z.updateGraph(J,true)},rollbackFailed:function(){},after:function(){}})},success:function(){},failed:function(X){d.displayNotification(t.FailedToCreateNewActivity+X,{messageType:"error"})},rollbackComplete:function(Y){if(Y){for(var X=0;X<Y.length;X++){z.removeNode(Y[X].getId())}}z.updateGraph(J,true)},after:function(){}})}}}}},unhighlight:function(){if(!C){if(w&&w.unhighlight){w.unhighlight()}if(q&&q.unhighlight){q.unhighlight()}if(f&&f.unhighlight){f.unhighlight()}if(A&&A.unhighlight){A.unhighlight()}}},updateHighlight:function(K,J,L){s.unhighlight();L=L||window.Polymer.dom(K).localTarget;if(L&&L.highlight){L.highlight()}switch(J){case"activity":w=L;break;case"step":q=L;break;case"gateway":f=L;break;case"process":A=L;break;default:}},resetSelectedActivity:function(){w=null;A=null},showContextualBar:function(J,M,K){E.empty();E.add(K);var L=l.getFrameWindow();L.getContextualUIManager().showContextualBar({y:M-25,x:J+25,hideWithDistance:true})},showContextualMenu:function(J,M,K){E.empty();E.add(K);var L=l.getFrameWindow();L.getContextualUIManager().showContextualBar({y:M-5,x:J,barDisplayedCB:function(){L.getContextualUIManager().showContextualMenuUnderBar({y:M,x:J})}})},registerContextualBar:function(){if(B){return}var J=localStorage.getItem("SIMPRCW_AP_ENABLE_EXPERIMENTS")==="true";var K={workbenchName:"SMAWebAuthoringWorkbench",module:"SMAProcWebApp",cmdPrefix:"",fileName:"SMAWebAuthoringWorkbench.xml",onContextualBarReady:function(P){if(P instanceof n){var L=P.getMainStep();var M=[];if(L&&!L.isRunSubFlowStep()){M.push({name:"Edit",line:1,hdr_list:["SMAProcWebActionBarEditCmdHdr"]})}M=M.concat([{name:"Parameters",line:1,hdr_list:["SMAProcWebActionBarAutParametersCmdHdr"]},{name:"Content",line:1,hdr_list:["SMAProcWebActionBarAutPLMContentsCmdHdr"]},{name:"ExecOptions",line:1,hdr_list:["SMAProcWebActivityOptionsCmdHdr"]},{name:"Run",line:1,hdr_list:["SMAProcRunCmdHdr"]}]);if(J===true){var N=2;if(L&&!L.isRunSubFlowStep()){N=N+1}M.splice(N,0,{name:"Dataflow",line:1,hdr_list:["SMAWflAutDataFlowCmdHdr"]})}return{cmdList:M}}else{if(P instanceof c){var Q=[];if(!P.isRunSubFlowStep()){Q=Q.concat([{name:"Edit",line:1,hdr_list:["SMAProcWebActionBarEditCmdHdr"]},{name:"ExecOptions",line:1,hdr_list:["SMAProcWebStepExecutionOptionCmdHdr"]}])}return{cmdList:Q}}else{if(P&&P.isGateway&&P.isGateway()){return{cmdList:[{name:"Edit",line:1,hdr_list:["SMAProcAutGatewayEditorCmdHdr"]}]}}else{if(P instanceof y){var O=[];O=O.concat([{name:"Parameters",line:1,hdr_list:["SMAProcWebActionBarAutParametersCmdHdr"]},{name:"Content",line:1,hdr_list:["SMAProcWebActionBarAutPLMContentsCmdHdr"]},{name:"Execution Options",line:1,hdr_list:["SMAProcWebExecutionOptionCmdHdr"]},{name:"Run Process",line:1,hdr_list:["SMAProcRunCmdHdr"]}]);if(J===true){O.splice(2,0,{name:"Dataflow",line:1,hdr_list:["SMAWflAutDataFlowCmdHdr"]});O.push({name:"Produce",line:1,hdr_list:["SMAWflActionBarExperienceCmdHdr"]})}return{cmdList:O}}}}}},onContextualMenuReady:function(N){if(N instanceof n){var L=[];L=L.concat([{name:"Delete",line:1,hdr_list:["SMAWflDeleteCmdHdr"]},{name:"Rename",line:1,hdr_list:["SMAWflRenameCmdHdr"]},{name:"Detach From Flow",line:1,hdr_list:["SMAProcDisconnectCmdHdr"]},{name:"Properties",line:1,hdr_list:["SMAProcWebActionBarPropertiesCmdHdr"]},{name:"Lifecycle",line:1,hdr_list:["SMAProcWebActionBarLifecycleCmdHdr"]},{name:"Related objects",line:1,hdr_list:["SMAProcWebActionBarRelExplorerCmdHdr"]},{name:"Attribute groups",line:1,hdr_list:["SMAWflAutAttributeGrpsCmdHdr"]},{name:"Impact graph",line:1,hdr_list:["SMAWflAutImpactGraphCmdHdr"]},{name:"Images",line:1,hdr_list:["SMAProcWebEditImageCmdHdr"]}]);return{cmdList:L}}else{if(N instanceof c){var O=[];O=O.concat([{name:"Delete",line:1,hdr_list:["SMAWflDeleteCmdHdr"]},{name:"Rename",line:1,hdr_list:["SMAWflRenameCmdHdr"]}]);if(N.getParent().getMainStep()&&(N.getParent().getMainStep().getId()===N.getId())){O=O.concat([{name:"ClearMainStep",line:1,hdr_list:["SMAWflClearMainStepCmdHdr"]}])}else{O=O.concat([{name:"SetAsMainStep",line:1,hdr_list:["SMAWflSetMainStepCmdHdr"]}])}return{cmdList:O}}else{if(N&&N.isGateway&&N.isGateway()){return{cmdList:[{name:"Delete",line:1,hdr_list:["SMAWflDeleteCmdHdr"]}]}}else{if(N instanceof y){var M=[];M=M.concat([{name:"Rename",line:1,hdr_list:["SMAWflRenameCmdHdr"]},{name:"Properties",line:1,hdr_list:["SMAProcWebActionBarPropertiesCmdHdr"]},{name:"Lifecycle",line:1,hdr_list:["SMAProcWebActionBarLifecycleCmdHdr"]},{name:"Related objects",line:1,hdr_list:["SMAProcWebActionBarRelExplorerCmdHdr"]},{name:"Attribute groups",line:1,hdr_list:["SMAWflAutAttributeGrpsCmdHdr"]},{name:"Impact graph",line:1,hdr_list:["SMAWflAutImpactGraphCmdHdr"]},{name:"Images",line:1,hdr_list:["SMAProcWebEditImageCmdHdr"]}]);return{cmdList:M}}}}}}};l.getFrameWindow().getContextualUIManager().register(K)}};var i=G(s);Object.assign(s.uiCallback,i.uiCallback);Object.assign(s,i.main);return s});