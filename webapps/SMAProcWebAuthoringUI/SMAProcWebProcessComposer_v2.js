define("DS/SMAProcWebAuthoringUI/SMAProcWebProcessComposer_v2",["DS/SMAProcWebDiagram/graph","DS/ApplicationFrame/ContextualBar","DS/Selection/CSOManager","DS/ApplicationFrame/CommandsManager","DS/ApplicationFrame/ContextualMenu","DS/SMAProcWebAuthoringUtils/SMAProcWebAuthoringServices","DS/SMAProcWebAsyncUtils/SMAProcWebTransactionManager","DS/JSCMM/SMAJSCMMExtensionManager","DS/SMAProcWebAsyncUtils/Activity/Create","DS/SMAProcWebAsyncUtils/Step/Create","DS/SMAProcWebAsyncUtils/Gateway/Create","DS/SMAProcWebAsyncUtils/Gateway/Delete","DS/SMAProcWebAsyncUtils/SequenceFlow/Create","DS/SMAProcWebAsyncUtils/Activity/Connect","DS/SMAProcWebCmds/SMAInstantiateAdapterCmd","DS/Logger/Logger","module"],function(p,l,q,b,o,d,h,m,s,j,e,n,k,g,i,r,c){var t=r.getLogger(c);var f={before:function(){d.showLoader()},after:function(){d.hideLoader()}};var a=function(y){var x={FailedToCreateNewActivity:"Failed to create a new activity, please reload the process.\n",FailedToCreateNewStep:"Failed to create a new Step, please reload the process.\n",FailedToCreateNewGateway:"Failed to create a new Gateway, please reload the process.\n"};var v={deleteGateway:function(z){return new Promise(function(B,A){h.add(new n(z),Object.assign({},f,{updateUI:function(){p.updateGraph()},failed:function(){this.after();p.updateGraphAll();d.displayClosableMessages("error",["SequenceFlowConnect.error"],true);A(new Error("failed to delete Gateway"))},success:function(){B()}.bind(this)}))})},createGateway:function(A,z,D,C,B){return new Promise(function(F,E){h.add(e(A,z,D,C,B),Object.assign({},f,{updateUI:function(){p.updateGraph()},failed:function(){this.after();p.updateGraphAll();d.displayClosableMessages("error",["SequenceFlowConnect.error"],true);E(new Error("failed to create Gateway"))},success:function(G){F(G)}.bind(this)}))})}};var u={addEdgeBetweenGateways:function(z,B,A){if(A.getParent()!==B.getParent()){v.deleteGateway(A).then(v.createGateway.bind(this,B.getParent(),A.getName(),B,undefined,true)).then(function(C){u.createSequence(z,B,C)}.bind(this))}else{u.createSequence(z,B,A)}},createSequence:function(B,D,C){var A=B.getChild(D.getId());var z=B.getChild(C.getId());if(A===undefined||A===null){B.addChild(D);D.setParent(B)}if(z===undefined||z===null){B.addChild(C);C.setParent(B)}return new Promise(function(F,E){h.add(new k(B,D,C),Object.assign({},f,{updateUI:function(){p.updateGraph()},failed:function(){this.after();p.updateGraphAll();d.displayClosableMessages("error",["SequenceFlowConnect.error"],true);E(new Error("failed to update sequence flow"))},success:function(){p.updateGraphAll();F()}}))})}};var w={main:{onComposerClicked:function(z){l.hide();o.hide();p.unhighlight();var A=b.getCurrentCmdId();if(!A||A==="NoRunningCmd"){y.setMappingMode(false);y.unhighlight();q.empty()}if(z){z.preventDefault();z.stopPropagation()}}},uiCallback:{onError:function(z,A){d.displayNotification(A,{messageType:z||"error",autoHide:false})},onAddFlowItem:function(B,A,E,D){var C,z;if(B==="activity"){C=d.getNextActivityName(this.process,"Activity.Title");z=new s(A,C,E,D,true)}else{if(B==="gateway"){C=d.getNextActivityName(this.process,"Gateway.Title");z=new e(A,C,E,D,true)}else{throw Error("cannot determine type")}}h.add(z,Object.assign({},f,{updateUI:function(F){var G=F.getPosition();G.connected=true;F.setPosition(G);p.updateGraph()},success:function(){d.displayClosableMessages("success",["ActivityCreate.success"]);p.updateGraphAll()},failed:function(F){this.after();p.updateGraphAll();d.displayNotification(x.FailedToCreateNewActivity+F,{messageType:"error"})}}))},onAddIsolatedFlowItem:function(C,z,D){var A,B;if(C==="activity"){A=d.getNextActivityName(this.process,"Activity.Title");B=new s(this.process,A,null,null,false)}else{if(C==="gateway"){d.displayClosableMessages("error",["GatewayCreate.unconnected.error"],true);return}else{throw Error("cannot determine type")}}h.add(B,Object.assign({},f,{updateUI:function(E){var F=E.getPosition();F.connected=false;E.setPosition(F);p.addPositionedFlowItem("activity",E,z,D)},success:function(){d.displayClosableMessages("success",["ActivityCreate.success"])},failed:function(E){this.after();p.updateGraphAll();d.displayNotification(x.FailedToCreateNewActivity+E,{messageType:"error"})}}))},onAddStep:function(D,A,E,C){if(D==="com.dassault_systemes.sma.adapter.Instantiate"){i.execute(A,true,(E&&E.getId())||null,(C&&C.getId())||null);return}var G=m.getDisplayName(D);var H=D.substring(D.lastIndexOf(".")+1);var z=G?G:H+".Title";var F=d.getNextStepName(A,z);if(d.canCreateStep(A,D)===false){d.displayClosableMessages("error",["StepCreate.multipleProcessSteps.error"],true);return}var B=new j(A,E,C,F,D);h.add(B,Object.assign({},f,{updateUI:function(){p.updateGraph()},success:function(){d.displayClosableMessages("success",["StepCreate.success"]);p.updateGraphAll()},failed:function(I){this.after();p.updateGraphAll();d.displayNotification(x.FailedToCreateNewStep+I,{messageType:"error"})}}))},onAddActivityStep:function(E,C,G,F){if(E==="com.dassault_systemes.sma.adapter.Instantiate"){i.execute(C,true,(G&&G.getId())||null,(F&&F.getId())||null);return}var z=m.getDisplayName(E);var B=E.substring(E.lastIndexOf(".")+1);var A=z?z:B+".Title";A=d.getNextActivityName(this.process,A);var D=new s(C,A,G,F,true);h.add(D,Object.assign({},f,{updateUI:function(H){var I=H.getPosition();I.connected=true;H.setPosition(I);w.uiCallback.onAddStep(E,H,null,null)},success:function(){},failed:function(H){this.after();p.updateGraphAll();d.displayNotification(x.FailedToCreateNewActivity+H,{messageType:"error"})}}))},onAddIsolatedActivityStep:function(D,z,E){if(D==="com.dassault_systemes.sma.adapter.Instantiate"){i.execute(this.process,false,null,null);return}var B=D.substring(D.lastIndexOf(".")+1);var A=d.getNextActivityName(this.process,B+".Title");var C=new s(this.process,A,null,null,false);h.add(C,Object.assign({},f,{updateUI:function(G){var I=G.getPosition();I.connected=false;G.setPosition(I);var F=D.substring(D.lastIndexOf(".")+1);var H=d.getNextStepName(G,F+".Title");h.add(new j(G,null,null,H,D),Object.assign({},f,{updateUI:function(){p.addPositionedFlowItem("activity",G,z,E)},success:function(){d.displayClosableMessages("success",["StepCreate.success"])},failed:function(J){this.after();p.updateGraphAll();d.displayNotification(x.FailedToCreateNewStep+J,{messageType:"error"})}}))},success:function(){},failed:function(F){this.after();d.displayNotification(x.FailedToCreateNewActivity+F,{messageType:"error"})}}))},onMoveFlowItem:function(A,z,B,D,C){if(B.isActivity()){h.add(new g(B,z,D,C),Object.assign({},f,{updateUI:function(){var E=B.getPosition();E.connected=true;B.setPosition(E);p.queueRenderTask({action:"select",id:B.getId(),type:A});p.updateGraph()},failed:function(){this.after();p.updateGraphAll();d.displayClosableMessages("error",["SequenceFlowConnect.error"],true)},success:function(){p.updateGraphAll()}}))}else{if(B.isGateway()){v.deleteGateway(B).then(v.createGateway.bind(this,z,B.getName(),D,C,true)).then(function(){p.updateGraphAll()})}}},validLink:function(F,E,A){var B=true;if(F.isActivity()&&A&&F.getOutgoingFlowItems().length>0){B=false}var D=F.getParent();if(B&&E.isGateway()&&D&&!D.isProcess()){var z=F.getIncomingFlowItems();z.forEach(function(G){if((G.isGateway()&&G===E)||!this.validLink(G,E)){B=false}}.bind(this));if(B){var C=A?A:D;B=this.validLink(C,E)}}return B},addEdge:function(z,B,A){if(B.isGateway()&&A.isGateway()){u.addEdgeBetweenGateways(z,B,A)}else{u.createSequence(z,B,A)}},handleSelectionForMapping:function(B,C,A){y.setMappingMode(true);var z=b.getCommand(C);z.dataFlowTable&&z.dataFlowTable.toggleActivitySelection(A,"GRAPH")},onProcessClicked:function(A,z){if(A){var B=b.getCurrentCmdId();if(B==="SMAWflAutDataFlowCmdHdr"){this.handleSelectionForMapping(z,B,A)}else{y.showContextualBar(z.pageX,z.pageY,A,[]);y.updateHighlight(z,"process")}}},onProcessRightClicked:function(A,z){var B=b.getCurrentCmdId();if(B==="SMAWflAutDataFlowCmdHdr"){y.setMappingMode(true)}if(A&&!y.getMappingMode()){y.showContextualMenu(z.pageX,z.pageY,A);y.updateHighlight(z,"process")}},onActivityClicked:function(A,z){t.log("Activity clicked "+A.getId());if(A){var B=b.getCurrentCmdId();if(B==="SMAWflAutDataFlowCmdHdr"){this.handleSelectionForMapping(z,B,A)}else{y.setMappingMode(false);y.showContextualBar(z.pageX,z.pageY,A);y.updateHighlight(z,"activity")}}},onActivityRightClicked:function(A,z){t.log("Activity right clicked "+A.getId());var B=b.getCurrentCmdId();if(B==="SMAWflAutDataFlowCmdHdr"){y.setMappingMode(true)}if(A&&!y.getMappingMode()){y.showContextualMenu(z.pageX,z.pageY,A);y.updateHighlight(z,"activity")}}}};return w};return a});