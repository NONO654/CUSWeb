define("DS/VisuLoaders/CGRReader",["DS/Visualization/ThreeJS_DS","WebappsUtils/WebappsUtils","UWA/Utils","DS/Visualization/Utils","DS/Visualization/ProxyAbstraction","DS/Visualization/Node3D","DS/Visualization/Mesh3D","DS/Visualization/MaterialManager","DS/SceneGraphNodes/AxisSystemNode","DS/Mesh/Mesh","DS/SceneGraphNodes/BillBoardNode3D","DS/Visualization/LoaderUtils","DS/ZipJS/LoaderInflate"],function(r,f,b,i,n,l,d,c,m,g,j,t,s){var e=!b.matchUrl(f.getWebappsBaseUrl(),window.location)?"Passport":null;var q={provider:"FILE",filename:"AmdLoader.js",serverurl:f.getWebappsBaseUrl()+"AmdLoader/",requiredAuth:e};var o={provider:"FILE",filename:"ThreeJS_Base.js",serverurl:f.getWebappsBaseUrl()+"Mesh/",requiredAuth:e};var h={provider:"FILE",filename:"Mesh.js",serverurl:f.getWebappsBaseUrl()+"Mesh/",requiredAuth:e};var k={provider:"FILE",filename:"CGRFile.js",serverurl:f.getWebappsBaseUrl()+"Formats/",requiredAuth:e};var a={provider:"FILE",filename:"CGRWorkerNewInfra.js",serverurl:f.getWebappsBaseUrl()+"Workers/",requiredAuth:e};var p=function(x,z,C){if(!C){C={}}this.gl=x;var B=undefined;if(r.supportedExtensions){B=r.supportedExtensions.elementIndexUint?true:undefined}this.renderCallbackFunc=(z!==undefined)?z:null;this.isWorkerLoading=false;this.workers=null;this.workerJobs=null;this.urlToRevoke="";this.keepLoader=C.keepLoader?C.keepLoader:false;this.type="";this.dataArray=[];this.materials=[];var D=[];this.modelsToLoad={};this.modelsToLoadCount=0;this.loadIndex=0;this.nbWorkers=4;this.workersLoaded=[];this.workerActivate=false;this.currentDownload=0;this.maxParrallelDownload=40;var y=-1;p.prototype.cleanLoader=function(){this.materials=[];D=[]};var A=0;var v=function(E){var G=[];if(!E){return G}for(var F in E){G.push(F)}return G};var w=function(K){var F,H,E,J,I,G;F="";E=K.length;H=0;while(H<E){J=K[H++];switch(J>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:F+=String.fromCharCode(J);break;case 12:case 13:I=K[H++];F+=String.fromCharCode(((J&31)<<6)|(I&63));break;case 14:I=K[H++];G=K[H++];F+=String.fromCharCode(((J&15)<<12)|((I&63)<<6)|((G&63)<<0));break}}return F};var u=function(I,K,F){if(K&&I){for(var Q in K){var G=K[Q].doneCallback;var N=K[Q].errorCallback;if(I[Q]){var L=I[Q];if(!L){N({node:F});continue}var J=L.buffer.subarray(L.options.offset,L.options.compressed+L.options.offset);if(J.length<=2){N({node:F});continue}if(J[0]!==120){N({node:F});continue}if(J[1]!==218){N({node:F});continue}var E=2;var H=J.subarray(E,L.options.compressed);var O=new s();var P=O.Inflate(H);var M=w(P);G({xml:M,node:F})}else{G({node:F})}}}};this.internalLoad=function(G){var K=this;var J=this.modelsToLoad[G];var E=J.url;J.launched=true;var H=v(J.applicativeContainers);if(J.isBuffer){var F=this.workersLoaded[G%this.workersLoaded.length];this.workers[F].postMessage({loadIndex:G,inputFile:E,readDecoration:J.readDecoration,primitiveWithBS:J.primitiveWithBS,withSAG:J.withSAG,withSceneGraph:J.withSceneGraph,smartStaticBatching:J.smartStaticBatching,edgeTransparency:J.edgeTransparency,node:"CGR",uint32Index:B,applicativesContainers:H,processText:J.processText})}else{this.currentDownload++;var L=new n();i.setProxyFromSpec(E,L);var M=E.serverurl?E.serverurl:"";M+=E.filename?E.filename:"";var I=function(N){K.currentDownload--;J.errorCallback(N)};L.executeGetHttpRequest(M,"arraybuffer",null,function(Q){K.currentDownload--;var O=false;if(O){var U=new DataView(Q);var N=new Blob([U],{type:"application/octet-binary"});var S=URL.createObjectURL(N);console.log("url : "+S)}var T=0;for(var R=0;R<K.workersLoaded.length;++R){var W=0;for(var P=0;P<K.workerJobs[K.workersLoaded[R]].length;++P){W+=K.workerJobs[K.workersLoaded[R]][P]}if(W>T){T=W}}var X=T;var V=K.workersLoaded[0];for(var R=0;R<K.workersLoaded.length;++R){var W=0;for(var P=0;P<K.workerJobs[K.workersLoaded[R]].length;++P){W+=K.workerJobs[K.workersLoaded[R]][P]}if(W<X){X=W;V=K.workersLoaded[R]}}K.workerJobs[V].push(Q.byteLength);K.workers[V].postMessage({inputFile:Q,loadIndex:G,node:E.filename,readDecoration:J.readDecoration,primitiveWithBS:J.primitiveWithBS,smartStaticBatching:J.smartStaticBatching,withSAG:J.withSAG,edgeTransparency:J.edgeTransparency,withSceneGraph:J.withSceneGraph,uint32Index:B,applicativesContainers:H,processText:J.processText},[Q])},I)}};this.setKeepLoaderMode=function(E){this.keepLoader=E;if(!this.keepLoader&&this.modelsToLoadCount==0){this.abort()}};this.load=function(E,G,M){var K=this;this.cleanLoader();var L=M.isBuffer!==undefined?M.isBuffer:false;function I(N,O){return function(S){console.log("index :  "+N);if(O){O(S)}var P=K.modelsToLoad[N];if(P.applicativeContainers){for(var R in P.applicativeContainers){if(P.applicativeContainers[R].errorCallback){P.applicativeContainers[R].errorCallback(S)}}}delete K.modelsToLoad[N];K.modelsToLoadCount--;var Q=true;for(var R in K.modelsToLoad){Q=false}if(Q){if(K.renderCallbackFunc!==null){K.renderCallbackFunc({hack:true,updateInfinitePlane:true,reframe:true})}if(P.doneCallback){P.doneCallback()}}D=[];for(var R in K.modelsToLoad){if(K.currentDownload<K.maxParrallelDownload&&K.modelsToLoad[R].launched===false){K.internalLoad(R)}}}}var J=I(this.loadIndex,G.errorCallback);var F={url:E,readyCallback:G.readyCallback,progressCallback:G.progressCallback,doneCallback:G.doneCallback,errorCallback:J,isBuffer:M.isBuffer,destinationNode:M.destination,readDecoration:M.readDeco,primitiveWithBS:M.primWithBS,smartStaticBatching:M.smartStaticBatching,withSAG:M.withSAG,withSceneGraph:M.withSceneGraph,edgeTransparency:M.edgeTransparency,sharedBuffers:M.sharedBuffers,noMeshInRAM:M.noMeshInRAM,unlinkToSG:M.unlinkToSG,applicativeContainers:M.applicativeContainers?M.applicativeContainers:null,launched:false,processText:M.processText};this.modelsToLoad[this.loadIndex++]=F;this.modelsToLoadCount++;if(this.workers){if((this.currentDownload<this.maxParrallelDownload)&&this.workerActivate){this.internalLoad(this.loadIndex-1)}}else{if(!this.isWorkerLoading){this.type="cgr";this.isWorkerLoading=true;var H;H=[q,o,h,k,a];i.getWorkerBlobFromSpecs(H,function(P){K.workers=[];K.workerJobs=[];K.urlToRevoke=P;for(var N=0;N<K.nbWorkers;++N){K.workers[N]=new Worker(P);K.workerJobs[N]=[];K.workers[N].onerror=function(Q){console.log("error worker"+Q)};var O=0;(function(Q){K.workers[Q].onmessage=function(W){var V=W.data;if(V.error&&V.loadIndex){var S=K.modelsToLoad[V.loadIndex];if(S.errorCallback){S.errorCallback(V)}return}if(V.loaded){K.workersLoaded.push(Q);if(!K.workerActivate){K.workerActivate=true;for(var U in K.modelsToLoad){if(K.currentDownload<K.maxParrallelDownload){if(K.modelsToLoad[U].launched===false){K.internalLoad(U)}}else{break}}}}else{K.workerJobs[Q].shift();var S=K.modelsToLoad[W.data.loadIndex];var R={processText:S.processText,edgeTransparency:S.edgeTransparency,sharedBuffers:S.sharedBuffers,noMeshInRAM:S.noMeshInRAM,fromCGR:true,primitiveWithBS:S.primitiveWithBS,unlinkToSG:S.unlinkToSG,withSAG:S.withSAG};var T=function(X){if(K.renderCallbackFunc!==null){var aa=performance.now();var Z=(y<0||(aa-y>=200000));if(Z){K.renderCallbackFunc({hack:true,updateInfinitePlane:true});y=aa}}if(S.readyCallback){S.readyCallback({nodes:X})}if(V.applicativesContainers){u(V.applicativesContainers,S.applicativeContainers,S.destinationNode)}delete K.modelsToLoad[W.data.loadIndex];K.modelsToLoadCount--;D=[];if(K.modelsToLoadCount==0){if(K.renderCallbackFunc!==null){K.renderCallbackFunc({hack:true,updateInfinitePlane:true,reframe:true})}if(S.doneCallback){S.doneCallback({isLast:true})}}D=[];if(!K.keepLoader&&Object.getOwnPropertyNames(K.modelsToLoad).length==0){K.abort()}else{for(var Y in K.modelsToLoad){if(K.currentDownload<K.maxParrallelDownload){if(K.modelsToLoad[Y].launched===false){K.internalLoad(Y)}}else{break}}}S=null};t.processData([S.destinationNode],V,undefined,S.withSceneGraph,R,T)}}})(N)}})}}};this.loadUVR=function(F,I,G,E,H){this.load(F,I,G,E,H);return};p.prototype.abort=function(){if(this.workers){for(var E=0;E<this.workers.length;++E){this.workers[E].terminate();this.workers[E]=null}window.URL.revokeObjectURL(this.urlToRevoke)}this.workers=null;this.urlToRevoke="";this.isWorkerLoading=false;this.modelsToLoad={};this.modelsToLoadCount=0;this.workersLoaded=[];this.workerActivate=false;this.cleanLoader()}};return p});