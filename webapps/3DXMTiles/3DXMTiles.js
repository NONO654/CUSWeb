define("DS/3DXMTiles/OOCQuickOverrideSet",[],function(){function a(e,d){this.referenceId=e;this.overrideCB=d}var b=0;var c=function(d){this.oocManager=d;this._overrides=new Map();this._active=false;this._id="_quick_"+b;b++};c.prototype.setOverrideCB=function(f,d){d=d||null;var e=this._overrides.get(f);if(d){if(!e){e=new a(f,d);this._overrides.set(f,e)}}else{if(e){this._overrides["delete"](f)}}if(this._active){this.oocManager.setOverrideCB(f,d,this._id)}};c.prototype.removeOverrideCB=function(d){this.setOverrideCB(d,null)};c.prototype.hasOverrideCB=function(e){var d=this._overrides.get(e);if(d){return d.overrideCB!==null}return false};c.prototype.setActive=function(f){var d=this.oocManager;var e=this._id;f=f?true:false;if(f!==this._active){this._active=f;if(f){d.registerOverrideSet(e);this._overrides.forEach(function(g,h){d.setOverrideCB(g.referenceId,g.overrideCB,e)})}else{d.removeOverrideSet(e)}}};return c});define("DS/3DXMTiles/OOCPath",[],function(){var a=function(c,b){this.ids=[].concat(c);this._ldhReference=b};a.prototype.isLeaf=function(b){var c=this.getLastId();return b.isLeaf(c)};a.prototype.isRoot=function(){return this.ids.length<=1};a.prototype.getLastId=function(){return this.ids[this.ids.length-1]};a.prototype.expandReference=function(b){var c=b.getInstRefJSON(this.getLastId());if(c.representation){this.ids.push(c.instanceId);this.ids.push(c.representation)}};a.prototype.getLastInstanceId=function(){if(this.ids.length>=3){return this.ids[this.ids.length-2]}return null};a.prototype.getParentReferenceId=function(){if(this.ids.length>=3){return this.ids[this.ids.length-3]}return null};a.prototype.isCGR=function(){if(this.ids[this.ids.length-1].indexOf(".cgr")!==-1){return true}return false};a.prototype.buildSubPath=function(b,d){var c=new a(this.ids,null);c.ids.push(b);c.ids.push(d);return c};a.buildFromReference=function(b,f){var g=null;var e=-1;var c=b.manager;var d;for(d=0;d<b._occurrences.length;d++){var h=b._occurrences[d];if(h.viewpointTag!==c.viewpointTag&&(h._screenRadius>e||g===null)){e=h._screenRadius;g=h}}if(!g){console.log("Could not find an occurrence for reference '"+b.referenceId+"'");return null}var j=g.getIdPath();if(f){g.viewpointTag=c.viewpointTag}var k=new a(j,b);if(b.children.length>0){k.approximate=true}return k};return a});define("DS/3DXMTiles/PriorityQueue",[],function(){var a=function(){this.reset()};a.prototype.reset=function(){this.tileNode=null;this.parent=null;this.less=null;this.more=null};a.prototype.check=function(){var f=[];function e(g){if(f.indexOf(g)>-1){console.log("argl")}else{f.push(g);if(g.less){e(g.less)}if(g.more){e(g.more)}}}e(this)};a.prototype.checkMinMax=function(f,e){var g=true;if(this.tileNode&&(this.tileNode.getScore()<f||this.tileNode.getScore()>e)){console.log("ERRRRRRRRRRREUUUUUUR");g=false}if(this.less&&!this.less.checkMinMax(f,e)){g=false}if(this.more&&!this.more.checkMinMax(f,e)){g=false}return g};a.prototype.removeMin=function(f){var e=this.less;if(e!==null){if(e.less===null){this.less=e.more;if(this.less!==null){this.less.parent=this}f.releaseHeapNode(e)}else{e.removeMin(f)}}};a.prototype.removeMax=function(f){var e=this.more;if(e!==null){if(e.more===null){this.more=e.less;if(this.more!==null){this.more.parent=this}f.releaseHeapNode(e)}else{e.removeMax(f)}}};a.prototype.insert=function(e){if(e.tileNode.getScore()<this.tileNode.getScore()){if(this.less!==null){this.less.insert(e)}else{this.less=e;e.parent=this}}else{if(this.more!==null){this.more.insert(e)}else{this.more=e;e.parent=this}}};a.prototype.getMin=function(){if(this.less===null){return this}else{return this.less.getMin()}};a.prototype.getMax=function(){if(this.more===null){return this}else{return this.more.getMax()}};a.prototype.getTileNodes=function(e){if(this.tileNode!==null){e.push(this.tileNode)}this.more&&this.more.getTileNodes(e);this.less&&this.less.getTileNodes(e)};var d=function(e){this.size=0;this.sizeLimit=e;this.root=null;this.firstFreeHeapNode=null;this.minHeapValue=-Infinity;this.maxHeapValue=+Infinity};d.prototype.getTileNodes=function(){var e=[];if(this.root!==null){this.root.getTileNodes(e)}return e};d.prototype.tryToInsertTileNodeMax=function(i,h,g){if(this.size<this.sizeLimit){if(!g||this.minHeapValue<i.getScore()){this.insert(i);h.min=null;var f=this.root.getMin();this.minHeapValue=f.tileNode.getScore();return true}else{return false}}else{if(this.minHeapValue<i.getScore()){var f=this.root.getMin();h.min=f.tileNode;this.insert(i);if(f.parent!==null){f.parent.removeMin(this)}else{this.setRoot(f.more)}this.size--;var e=this.root.getMin();this.minHeapValue=e.tileNode.getScore();return true}}return false};d.prototype.tryToInsertTileNodeMin=function(h,f,e){if(this.size<this.sizeLimit){if(!e||this.maxHeapValue>h.getScore()){this.insert(h);f.max=null;var i=this.root.getMax();this.maxHeapValue=i.tileNode.getScore();return true}else{return false}}else{if(this.maxHeapValue>h.getScore()){var i=this.root.getMax();f.max=i.tileNode;this.insert(h);if(i.parent!==null){i.parent.removeMax(this)}else{this.setRoot(i.less)}this.size--;var g=this.root.getMax();this.maxHeapValue=g.tileNode.getScore();return true}}return false};d.prototype.setRoot=function(e){if(this.root!==null){this.releaseHeapNode(this.root)}this.root=e;if(e!==null){e.parent=null}};d.prototype.getAndRemoveMaxTileNode=function(){var f=this.root.getMax();var e=f.tileNode;this.removeMaxHeapNode(f);return e};d.prototype.removeMaxHeapNode=function(e){if(e.parent!==null){e.parent.removeMax(this)}else{this.setRoot(e.less)}this.size--};d.prototype.removeMinHeapNode=function(e){if(e.parent!==null){e.parent.removeMin(this)}else{this.setRoot(e.more)}this.size--};d.prototype.getAndRemoveMinTileNode=function(){var e=this.root.getMin();var f=e.tileNode;this.removeMinHeapNode(e);return f};d.prototype.getMinHeapNode=function(){if(this.root!==null){return this.root.getMin()}return null};d.prototype.getMaxHeapNode=function(){if(this.root!==null){return this.root.getMax()}return null};d.prototype.insert=function(f){var e=this.getHeapNode(f);if(this.root===null){this.setRoot(e)}else{this.root.insert(e)}this.size++};d.prototype.getHeapNode=function(f){var e;if(!this.firstFreeHeapNode){e=new a()}else{e=this.firstFreeHeapNode;this.firstFreeHeapNode=e.more;e.reset()}e.tileNode=f;return e};d.prototype.releaseHeapNode=function(e,f){e.less=null;if(f){f(e.tileNode)}e.tileNode=null;e.more=this.firstFreeHeapNode;this.firstFreeHeapNode=e};d.prototype.releaseHeapNodeTree=function(e,g,f){if(e.less!==null){this.releaseHeapNodeTree(e.less,g+1,f);e.less=null}if(e.more!==null){this.releaseHeapNodeTree(e.more,g+1,f);e.more=null}this.releaseHeapNode(e,f)};d.prototype.reset=function(e){if(this.root!==null){this.releaseHeapNodeTree(this.root,0,e);this.root=null;this.minHeapValue=-Infinity}this.size=0};var c=0;var b=function(e){this.id=c++;this.nodeList=[];this.nbProcessedNodes=0;this.nodeListLength=0;this.listWasUpdated=false;this.maxHeapNode=null;this.minHeapNode=null;this.heap=new d(e||100)};b.prototype.fillHeapMax=function(j){var n={min:null};var l=this.nodeListLength,f,m;var g=this.heap;var k,h=0;var e=j?0:this.nbProcessedNodes;for(k=e;k<l;k++){f=this.nodeList[k];if(f===null||!f.isAlive()){h++}else{if(g.tryToInsertTileNodeMax(f,n,e!==0)){m=n.min;this.nodeList[k]=m;if(m===null){h++}}}}this.nbProcessedNodes=k;if(h>=this.nodeListLength){this.nodeListLength=0;this.nbProcessedNodes=0}else{if(h>200){this.cleanNulls(true)}}};b.prototype.fillHeapMin=function(j){var n={max:null};var l=this.nodeListLength,f,m;var g=this.heap;var k,h=0;var e=j?0:this.nbProcessedNodes;for(k=e;k<l;k++){f=this.nodeList[k];if(f===null||!f.isAlive()){h++}else{if(g.tryToInsertTileNodeMin(f,n,e!==0)){m=n.max;this.nodeList[k]=m;if(m===null){h++}}}}this.nbProcessedNodes=k;if(h>=this.nodeListLength){this.nodeListLength=0;this.nbProcessedNodes=0}else{if(h>200){this.cleanNulls(true)}}};b.prototype.getMaxNodeWithNoHeap=function(){if(this.heap.root!==null){throw new Error("Heap not empty")}var f,h=this.nodeListLength,k=-1,e=-Infinity,g=null,j=0;for(f=0;f<h;f++){g=this.nodeList[f];if(g!==null&&g.isAlive()){if(g.getScore()>e){k=f;e=g.getScore()}}else{j++}}if(k>-1){g=this.nodeList[k];this.nodeList[k]=null}else{g=null}if(j>=this.nodeListLength){this.nodeListLength=0}else{if(j>200){this.cleanNulls(false)}}return g};b.prototype.peekMaxNode=function(){if(!this.maxHeapNode){if(this.heap.size===0||this.listWasUpdated){this.fillHeapMax(this.heap.size===0);this.listWasUpdated=false}var e=null;if(this.heap.size>0){e=this.heap.root.getMax()}this.maxHeapNode=e}return this.maxHeapNode?this.maxHeapNode.tileNode:null};b.prototype.peekMinNode=function(){if(!this.minHeapNode){if(this.heap.size===0||this.listWasUpdated){this.fillHeapMin(this.heap.size===0);this.listWasUpdated=false}var e=null;if(this.heap.size>0){e=this.heap.root.getMin()}this.minHeapNode=e}return this.minHeapNode?this.minHeapNode.tileNode:null};b.prototype.removeMaxHeapNode=function(e){this.heap.removeMaxHeapNode(e)};b.prototype.getMaxNode=function(f){if(this.heap.size===0||this.listWasUpdated){this.fillHeapMax(this.heap.size===0);this.listWasUpdated=false}var e=null;if(this.heap.size>0){if(f){e=this.heap.getAndRemoveMaxTileNode()}else{e=this.heap.getMaxNode()}}return e};b.prototype.getMinNode=function(e){if(this.heap.size===0||this.listWasUpdated){this.fillHeapMin(this.heap.size===0);this.listWasUpdated=false}var f=null;if(this.heap.size>0){if(e){f=this.heap.getAndRemoveMinTileNode()}else{f=this.heap.getMinNode()}}return f};b.prototype.checkIntegrity=function(f){var h=-Infinity,e=+Infinity;if(this.heap.size>0){h=this.heap.root.getMin().tileNode.getScore();e=this.heap.root.getMax().tileNode.getScore();if(!this.heap.root.checkMinMax(h,e)){console.log("checkMinMax has failed!!!")}var g;for(g=0;g<(f!==undefined?f:this.nodeListLength);g++){if(this.nodeList[g]&&this.nodeList[g].getScore()>h){console.log("found probleme!!!")}}}};b.prototype.getMinNodeWithNoHeap=function(){if(this.heap.root!==null){throw new Error("Heap not empty")}var f,h=this.nodeListLength,k=-1,e=Infinity,g=null,j=0;for(f=0;f<h;f++){g=this.nodeList[f];if(g!==null&&g.isAlive()){if(g.getScore()<e){k=f;e=g.getScore()}}else{j++}}if(k>-1){g=this.nodeList[k];this.nodeList[k]=null}else{g=null}if(j>=this.nodeListLength){this.nodeListLength=0}else{if(j>200){this.cleanNulls(false)}}return g};b.prototype.cleanNulls=function(f){var e,j=this.nodeListLength,h=null,g=0;for(e=0;e<j;e++){h=this.nodeList[e];if(h!==null&&h.isAlive()){this.nodeList[g]=h;g++}else{if(f&&e<this.nbProcessedNodes){this.nbProcessedNodes--}}}this.nodeListLength=g;this.nodeList.length=this.nodeListLength};b.prototype.isEmpty=function(){return this.heap.size===0&&this.nodeListLength===0};b.prototype.clear=function(g){this.heap.reset(g);if(g){var e,f;for(e=0;e<this.nodeListLength;e++){f=this.nodeList[e];if(f){g(this.nodeList[e])}}}this.nodeListLength=0;this.nbProcessedNodes=0;this.maxHeapNode=null;this.minHeapNode=null};b.prototype.resetOrder=function(e){var j=this.heap.getTileNodes();this.heap.reset();var f;for(f=0;f<j.length;f++){this.addNode(j[f])}if(e){var h=0,g;for(f=0;f<this.nodeListLength;f++){g=this.nodeList[f];if(g&&e(g)){this.nodeList[h]=g;h++}}this.nodeListLength=h}};b.prototype.addNode=function(e){if(this.nodeListLength>=this.nodeList.length){this.nodeList.push(e);this.nodeListLength=this.nodeList.length}else{this.nodeList[this.nodeListLength++]=e}this.listWasUpdated=true};b.prototype.peekMinHeapNode=function(){if(this.heap.size===0||this.listWasUpdated){this.fillHeapMin(this.heap.size===0);this.listWasUpdated=false}return this.heap.getMinHeapNode()};b.prototype.peekMaxHeapNode=function(){if(this.heap.size===0||this.listWasUpdated){this.fillHeapMax(this.heap.size===0);this.listWasUpdated=false}return this.heap.getMaxHeapNode()};b.prototype.traverseMin=function(g){var e,f;do{f=true;e=this.peekMinHeapNode();if(e!==null&&g(e.tileNode)){this.heap.removeMinHeapNode(e);f=false}}while(!f)};b.prototype.traverseMinPlus=function(m){var e,j,h,l=[];function k(){h=true}function f(){j=true}do{j=false;h=false;e=this.peekMinHeapNode();if(e!==null){m(e.tileNode,f,k);if(j&&h){}else{if(h){l.push(e.tileNode)}this.heap.removeMinHeapNode(e)}}else{j=true}}while(!j);var g;for(g=0;g<l.length;g++){this.addNode(l[g])}};b.prototype.traverseMax=function(g){var e,f;do{f=true;e=this.peekMaxHeapNode();if(e!==null&&g(e.tileNode)){this.heap.removeMaxHeapNode(e);f=false}}while(!f)};b.prototype.traverseMaxPlus=function(m){var e,j,h,l=[];function k(){h=true}function f(){j=true}do{j=false;h=false;e=this.peekMaxHeapNode();if(e!==null){m(e.tileNode,f,k);if(j&&h){}else{if(h){l.push(e.tileNode)}this.heap.removeMaxHeapNode(e)}}else{j=true}}while(!j);var g;for(g=0;g<l.length;g++){this.addNode(l[g])}};b.prototype.removeNode=function(f){this.resetOrder();var e;for(e=0;e<this.nodeListLength;e++){if(this.nodeList[e]===f){this.nodeList[e]=null}}};b.prototype.getAllNodes=function(){var e=[],g,f;for(f=0;f<this.nodeListLength;f++){g=this.nodeList[f];if(g){e.push(g)}}var h=this.heap.getTileNodes();return e.concat(h)};b.prototype.getSize=function(){this.cleanNulls();var e=this.nodeListLength+this.heap.size;return e};return b});define("DS/3DXMTiles/PriorityComputerFactory",[],function(){function a(e){}a.prototype.computePriority=function(g,f,e){return f};function b(e){}b.prototype.computePriority=function(g,f,e){if(e<=0){return f}else{return f*Math.pow(0.9,e/100)}};function c(e){}c.prototype.computePriority=function(g,f,e){if(e<=0){return +Infinity}else{return e}};function d(e){e=e||{};this.exponent=e.exponent||1;this.focal=e.focal||1000;this.factor=e.factor||1}d.prototype.computePriority=function(i,h,g){if(g<=0){return +Infinity}else{var e=i.bsRadius;var f=1+this.factor*Math.pow(1/(this.focal*g/(2*e)),this.exponent);return f*h}};return{createPriorityComputer:function(e,f){switch(e){case"none":return new a(f);case"proto":return new b(f);case"adaptative":return new d(f);case"distance":return new c(f);default:throw new Error("Illegal priority computer type")}}}});define("DS/3DXMTiles/ModelLoaderPoolParams",[],function(){var a=function(b){this.urlArray=[];this.targetArray=[];this.lod=b;this.loading=false;this.error=false};a.prototype.addFromNode=function(b,c){this.urlArray.push(b.url?this.buildURL(b.url,c):null);this.targetArray.push(b)};a.prototype.isEmpty=function(){return this.urlArray.length===0};a.prototype.buildURL=function(b,c){if(b.indexOf("://")>0||b.startsWith("//")){return b}else{if(b.indexOf("/")===0){b=b.substring(1)}return c+b}};return a});define("DS/3DXMTiles/OOCInstanceIterator",[],function(){var a=function(b,c){this._referenceIterator=b;this._childData=c};a.prototype.getReferenceIterator=function(){return this._referenceIterator};a.prototype.getInstanceId=function(){return this._childData.instanceId};a.prototype.getMatrix=function(){var b=this._childData.matrix;return b&&b.clone()};a.prototype.getNode=function(){return this._childData.node};return a});define("DS/3DXMTiles/Debug3DXMTiles",[],function(){var a=-1;window.OOCGetProbes=function(){var c=-1;var b=[];measures=window.top.performance.getEntriesByType("measure");measures=measures.concat(window.top.performance.getEntriesByType("mark"));measures.forEach(function(d){if(c===-1){c=d.startTime}if(d.entryType==="measure"){b.push({name:d.name,duration:d.duration,startTime:d.startTime-c,entryType:d.entryType})}else{b.push({name:d.name,startTime:d.startTime-c,entryType:d.entryType})}});return b};return{setSceneGraphMode:function(b){if(b==="flat"){this.sceneGraphMode=0}else{if(b==="dual"){this.sceneGraphMode=1}else{throw new Error("Unknown mode")}}},sceneGraphMode:1,configs:{1:{modelDir:"../airbus/assets/airbusnew4/",instrefDir:"../airbus/assets/instref2/",assetsDir:"../airbus/assets/",toReplace:[],root:"XWB-A350-900-RR.instref"},2:{modelDir:"../airbus2/assets/3DXM/",instrefDir:"../airbus2/assets/InstRef/",assetsDir:"../airbus2/assets/",toReplace:["../airbus2/assets/NewCGRs/"],root:"XWB-A350-900-RR.instref"},3:{modelDir:"../airbus3/3dxm/",instrefDir:"../airbus3/instref216/",assetsDir:"../airbus3/",toReplace:["../airbus3/CGR/A350DEVP/","../airbus3/CGR/COMEQLIB/","../airbus3/CGR/A350DEFN/","../airbus3/CGR/COMSTLIB/"],root:"A350.instref"},4:{modelDir:"../airbus3/CGR/",instrefDir:"../airbus3/instref216/",assetsDir:"../airbus3/",toReplace:["../airbus3/CGR/"],root:"A350.instref",cgr:true}},probePrefix:"WebVisuOOC_",probeMap:new Map(),probeIndex:0,startProbe:function(c){if(window.OOCProbes===-1){a=window.OOCProbes?1:0}if(a===1){var b=this.probePrefix+c+"_"+this.probeIndex;this.probeIndex++;this.probeMap.set(c,b);window.top.performance.mark(b+"_begin")}},endProbe:function(e){if(a===1){var d=this.probeMap.get(e);this.probeMap["delete"](e);var c=d+"_end";window.top.performance.mark(c);var b=d+"_begin";window.top.performance.measure(this.probePrefix+e,b,c)}}}});define("DS/3DXMTiles/LDHReferenceUnloadStatus",[],function(){return{frozen:"frozen",unloadable:"unloadable",unloaded:"unloaded"}});define("DS/3DXMTiles/LDHOcclusionStatus",[],function(){return{unknown:"unknown",visible:"visible"}});define("DS/3DXMTiles/UnloadManager",[],function(){var a=-2;var c={v0:{memoryLimitMb:512,memoryLimitGPUMb:512},full:{memoryLimitMb:256,memoryLimitGPUMb:1024},medium:{memoryLimitMb:64,memoryLimitGPUMb:64},medium_plus:{memoryLimitMb:64,memoryLimitGPUMb:128},restricted:{memoryLimitMb:48,memoryLimitGPUMb:32}};var b=function(e){var f;if(!(typeof(e)==="string")){f=e}else{f=c[e]}var d=f.memoryLimitMb;var g=f.memoryLimitGPUMb;this.isRestricted=(e==="restricted");if(a===-2){if(window.OOCUnloadMemoryLimit!==undefined){a=window.OOCUnloadMemoryLimit}}this.config=e;this.unloadAlwaysTab=[false,false];this.hasUnloadAlways=false;if(window.OOCUnloadAlways){this.setUnloadAlwaysTab([true,true])}if(a>=0){d=a;g=a}this.memoryUsage=0;this.memoryUsageGPU=0;this.memoryLimit=d*1024*1024;this.memoryLimitGPU=g*1024*1024;this.usage=0;this.usageGPU=0;this.memoryPeak=0;this.memoryPeakGPU=0;this.flashMode=false;this.flashUnload=false;this.unloadThreshold=0.95;this.emergencyUnloadThreshold=1.1;window.debugUnloadManager=this};b.prototype.setFlashMode=function(d){this.flashMode=d};b.prototype.onReferenceMemoryChange=function(e,d){this.memoryUsage+=e;this.memoryUsageGPU+=d;this.updateUsage()};b.prototype.beforeLoadedNodesQueueTraversal=function(){this.flashUnload=false;if(this.isUnloadNeeded()){this.flashUnload=true}};b.prototype.afterLoadedNodesQueueTraversal=function(){this.flashUnload=false};b.prototype.isLoadingAllowed=function(d){if(d!==0&&d!==1){throw new Error()}if(d===0){return this.memoryUsageGPU<this.memoryLimitGPU}else{return this.memoryUsage<this.memoryLimit}};b.prototype.isUnloadSmalNodesRequired=function(){var d=this.memoryUsage>0.9*this.memoryLimit||this.memoryUsageGPU>0.9*this.memoryLimitGPU;return d};b.prototype.isEmergencyUnloadRequired=function(f,e){var d;f=f||0;if(e===0){d=this.memoryUsageGPU+f>=this.emergencyUnloadThreshold*this.memoryLimitGPU}else{d=this.memoryUsage+f>=this.emergencyUnloadThreshold*this.memoryLimit}return d};b.prototype.isEmergencyUnloadRequiredCPU=function(d){d=d||0;return this.memoryUsage+d>=this.emergencyUnloadThreshold*this.memoryLimit};b.prototype.isEmergencyUnloadRequiredGPU=function(d){d=d||0;return(!this.oldVersion&&this.memoryUsageGPU+d>=this.emergencyUnloadThreshold*this.memoryLimitGPU)};b.prototype.isUnloadNeeded=function(d){if(this.flashUnload){return true}if(d===undefined){return this.isUnloadNeeded(0)||this.isUnloadNeeded(1)}if(this.unloadAlwaysTab[d]){return true}if(d===0){return this.memoryUsageGPU>0.8*this.memoryLimitGPU}else{return this.memoryUsage>0.8*this.memoryLimit}return false};b.prototype.updateUsage=function(){this.usage=100*this.memoryUsage/this.memoryLimit;this.usageGPU=100*this.memoryUsageGPU/this.memoryLimitGPU;this.memoryPeak=this.memoryUsage>this.memoryPeak?this.memoryUsage:this.memoryPeak;this.memoryPeakGPU=this.memoryUsageGPU>this.memoryPeakGPU?this.memoryUsageGPU:this.memoryPeakGPU};b.prototype.setUnloadAlwaysTab=function(d){this.unloadAlwaysTab=d;this.hasUnloadAlways=d[0]||d[1]};b.prototype.wouldDownloadCauseEmergencyUnload=function(f,d){if(d.type!==0||!this.isRestricted){return false}else{var e=d.getMemorizedReferenceSize(f);if(e>=0){return this.isEmergencyUnloadRequired(e,0)}else{return false}}};return b});define("DS/3DXMTiles/InstancingFactory",["DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory"],function(d,c){var b=function(){};b.prototype.buildInstancingBox=function(f){var i=f.matrices.length,l=f.matrices,j=f.boxes,e=f.colors,h=f.attributes||{};var m=this.buildBoxMesh(h);var k=this.buildMaterial(f);m.setMaterial(k);var g=new d.Box3();this.setUpMeshInstancingParameters(m,i,l,j,e,g);m.forceBoundingElements(true,{box:g});return m};b.prototype.buildBoxMesh=function(f){if(f.dimension===1){var h=[new d.Vector3(0,0,0),new d.Vector3(1,0,0),new d.Vector3(0,0,0),new d.Vector3(0,1,0),new d.Vector3(0,0,0),new d.Vector3(0,0,1),new d.Vector3(1,0,0),new d.Vector3(1,1,0),new d.Vector3(1,0,0),new d.Vector3(1,0,1),new d.Vector3(0,1,0),new d.Vector3(0,1,1),new d.Vector3(0,1,0),new d.Vector3(1,1,0),new d.Vector3(0,0,1),new d.Vector3(0,1,1),new d.Vector3(0,0,1),new d.Vector3(1,0,1),new d.Vector3(1,1,1),new d.Vector3(0,1,1),new d.Vector3(1,1,1),new d.Vector3(1,0,1),new d.Vector3(1,1,1),new d.Vector3(1,1,0)];var g,e=[];for(g=0;g<h.length;g++){e.push(g)}return c.createLineNode({points:h,drawMode:Mesh.ConnectivityTypeEnum.LINES,idx:e})}else{return c.createCuboidNode({cornerPoint:new d.Vector3(0,0,0),firstAxis:new d.Vector3(1,0,0),secondAxis:new d.Vector3(0,1,0),thirdAxis:new d.Vector3(0,0,1)})}};b.prototype.buildMaterial=function(f){var h=f.material,g=f.attributes;if(!h){h=g.dimension===1?new d.LineBasicMaterial({force:true,opacity:g.opacity}):new d.MeshBasicMaterial({force:true,opacity:g.opacity})}h.activatePDSFX();var i={vColor:{type:"v3"}};if(f.useDBuffer){i.cP={type:"v4"}}h.setPDSFXVaryings(i);var m={ComputeObjectPosition:["vec3 ComputeObjectPosition() {","vec4 localPosition = vec4(vGetAttribPosition(), 1.0);","vec4 newPosition = instanceMatrix*localPosition;","return newPosition.xyz;","}"].join("\n"),ComputeVaryingValues:["void ComputeVaryingValues() {","vColor = instanceColor;","}"].join("\n")};var k={ComputeAlbedo:["vec3 ComputeAlbedo() {","return vColor;","}"].join("\n"),ComputeSpecularReflectance:["vec3 ComputeSpecularReflectance() {","return vec3(1.0,1.0,1.0);","}"].join("\n")};var e=["float getDepth(in vec2 coord) {","vec4 rgba_depth = texture2D( depthBuffer, coord );","const vec4 bit_shift = vec4( 1.0 / ( 256.0 * 256.0 * 256.0 ), 1.0 / ( 256.0 * 256.0 ), 1.0 / 256.0, 1.0 );","float depth = dot( rgba_depth, bit_shift );","return depth > 1e-6 ? depth + 2.0* DEPTH_PRECISION : 1.0;","}","float depthSampleTest(in vec2 coord, in float delta, in float depth) {","float fDepth = getDepth(coord);","if ( fDepth < depth ) return delta;","return 0.0;","}","bool correctZFighting() {","vec2 coord = 0.5 + 0.5*cP.xy/cP.w;","float depth = 0.5 + 0.5 * cP.z / cP.w;","float delta = 1.0/9.0;","float test = 0.0;","test += depthSampleTest(coord,delta, depth);","if (test > 0.0) {","return true;","}","return false;","}"].join("\n");var n=[].join("\n");if(f.useDBuffer){m.ProcessClipSpacePosition=["void ProcessClipSpacePosition(inout vec4 ioPosition) {","cP = ioPosition;","}"].join("\n");k.ComputeDiscard="bool ComputeDiscard() { return correctZFighting(); }";var j=f.viewer.getRenderer();var l={depthBuffer:{type:"t2",value:f.depthBuffer}};h.setPDSFXUniforms(l);h.setPDSFXGlobalShaderCode(n,e);h.side=d.DoubleSide}h.setPDSFXOverridableFunctions(m,k);return h};b.prototype.setUpMeshInstancingParameters=function(g,t,h,n,p,o){var k=new Float32Array(t*16);var x=new Float32Array(t*3);var w=new d.Matrix4();var r=new d.Matrix4();var e=new d.Vector3();var v=new d.Matrix4();var l=new d.Matrix4();var C,A,z,q,D=v,m,s,f,y;for(C=0;C<t;C++){z=h[C];f=n[C].clone();w.copy(z);e.set(f.max.x-f.min.x,f.max.y-f.min.y,f.max.z-f.min.z);r.identity();l.identity();r.translate(f.min);l.scale(e);w.multiplyMatrices(r,l);v.multiplyMatrices(z,w);f.applyMatrix4(z);o.expandByPoint(f.min);o.expandByPoint(f.max);m=C*16;s=D.elements;for(A=0;A<16;A++){k[m+A]=s[A]}m=C*3;y=p[C];x[m]=y.r;x[m+1]=y.g;x[m+2]=y.b}var u={data:k,type:"m4",attribName:"instanceMatrix",isFlattened:true};var B={data:x,type:"v3",attribName:"instanceColor",isFlattened:true};g.setInstancingParameters(t,[u,B])};var a=new b();return a});define("DS/3DXMTiles/3DXMTilesUtils",["DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory"],function(f,e){function j(l,k,m){this.center=l;this.radius=k;this.scale=m}function b(l,k,n,m){this.center=l;this.radius=k;this.scale=n;this.matrixPosition=new f.Vector3();this.matrixPosition.getPositionFromMatrix(m)}b.prototype.positionHasChanged=function(k){var l=k.elements;if(l[12]!==this.matrixPosition.x||l[13]!==this.matrixPosition.y||l[14]!==this.matrixPosition.z){return true}else{return false}};var c=new f.Matrix4();var i=new f.Vector3();var h=new f.Vector3();var g=new f.Matrix4();var a=new f.MeshPhongMaterial({color:"red",transparent:true,opacity:0.2,force:true});var d={computeScreenRadius:function(r,p,t,n){var u=r.center;var m=r.radius;var v=t.performFrustumCullingNoNearFar(m,u);if(!v){return -1}var s;if(p.isOrtho){s=m/n}else{var o=p.matrixWorldInverse.elements;var q=Math.abs(o[2]*u.x+o[6]*u.y+o[10]*u.z+o[14]);var l=n*q;s=m/l}return s},computeScreenRadiusCache:function(l,t,r,p,o){var n=l.getMaxScaleOnAxis();var q=r.radius*n;var s=new f.Vector3();s.copy(r.center);s.applyMatrix4(l);t&&s.applyMatrix4(t);if(p){var k=new f.Matrix4();k.setPosition(s);var m=e.createSphereNode({matrix:k,radius:q});m.setMaterial(a);debugWebGLV6Viewer.getRootNode().addChild(m)}if(!o){return new j(s,q,n)}else{return new b(s,q,n,l)}},computeScreenRadiusCacheWithTemporaryParent:function(r,q,o,n){if(q){g.copy(q)}else{g.copy(c)}var p=n;while(n){if(n._matrix){g.multiplyMatrices(n._matrix,g)}n=n.parents[0]}var m=r.matrix;g.multiplyMatrices(m,g);var l=o.radius*g.getMaxScaleOnAxis();var k=new f.Vector3();k.copy(o.center);k.applyMatrix4(g);return new j(k,l)},computeScreenRadiusCstComponent:function(l,m){if(l.isOrtho){return l.getCameraConstant(1,m.SCREEN_HEIGHT)}else{var k=0.5*m.SCREEN_HEIGHT;k/=Math.tan(0.5*l.fov*Math.PI/180);if(l.fullWidth){k*=(l.fullWidth/l.width)}k=1/k;return k}},computeDistanceToViewpoint:function(s,m,r,l){var k=s.matrix;if(!l){g.copy(k)}else{g.multiplyMatrices(k,l)}var n=r.radius*g.getMaxScaleOnAxis();var p=m.camera;i.copy(r.center);i.applyMatrix4(g);var o=p.matrixWorldInverse.elements;var q=Math.abs(o[2]*i.x+o[6]*i.y+o[10]*i.z+o[14]);q-=n;return -q},computeSubScreenRadius:function(q,u,s,w,o){var x=u.center;var l=s.position;if(l.distanceToSquared(x)<u.radius*u.radius){return this.infinity(q)}h.subVectors(s.position,x);h.normalize();var n=q*u.scale;var p=u.radius-n;i.x=x.x+p*h.x;i.y=x.y+p*h.y;i.z=x.z+p*h.z;var r=s.matrixWorldInverse.elements;var t=Math.abs(r[2]*i.x+r[6]*i.y+r[10]*i.z+r[14]);var m=o*t;var v=n/m;return v},computeScreenRadiusMajorate:function(l,v,s,p){var w=l.center;var m=s.position;if(m.distanceToSquared(w)<l.radius*l.radius){return this.infinity(v)}h.subVectors(s.position,l.center);h.normalize();var o=v;var q=l.radius-o;i.x=w.x+q*h.x;i.y=w.y+q*h.y;i.z=w.z+q*h.z;var r=s.matrixWorldInverse.elements;var t=Math.abs(r[2]*i.x+r[6]*i.y+r[10]*i.z+r[14]);var n=p*t;var u=o/n;return u},infinity:function(k){return 1000000000+k}};return d});define("DS/3DXMTiles/LDHReferenceStatus",[],function(){return{incomplete:"incomplete",complete:"complete",dead:"dead",locked:"locked",error:"error"}});define("DS/3DXMTiles/LDHHandler",[],function(a){var a=function(b){this.type=b};a.prototype.handleReferences=function(c,b){};a.prototype.getBatchSize=function(){return 1};a.prototype.setRestricted=function(){};a.Model3DHandler=0;a.InstRefHander=1;return a});define("DS/3DXMTiles/LODSelector",["DS/Visualization/ThreeJS_DS","UWA/Class"],function(b,a){var c=a.extend({init:function(){this.type=null;this.disableDowngrade=false},setDisableDowngrade:function(d){this.disableDowngrade=d?true:false},getMaxLOD:function(){return 1},createJSON:function(d){d=d||{};d.type=this.type;if(this.disableDowngrade){d.disableDowngrade=true}return d}});return c});define("DS/3DXMTiles/LDHInstRefHandler",["DS/3DXMTiles/LDHHandler"],function(b){var a=function(){b.call(this,b.InstRefHander)};a.prototype=Object.create(b.prototype);return a});define("DS/3DXMTiles/LDHOccurrence",["DS/Visualization/Node3D","DS/Visualization/ThreeJS_DS","DS/Visualization/Mesh3D","DS/3DXMTiles/Debug3DXMTiles","DS/3DXMTiles/LDHReferenceStatus","DS/Visualization/PathElement"],function(f,d,a,c,g,e){var h=new d.Matrix4();var b=function(p,n){var j=p.reference;this.reference=j||null;if(j._occurrences.length>0){j.manager.forceUpdateNode(j)}j._occurrences.push(this);this.node=p.node||null;this.matrix=p.matrix||h;this.parent=p.parent||null;this.instanceId=p.instanceId||null;this.counter=0;for(var l=0;l<j.children.length;++l){var q=j.children[l];var k=b.getOccurrenceMatrix(this.matrix,q.matrix);var m=new b({reference:q.reference,matrix:k,boundingSphere:q.reference.boundingSphere,node:(c.sceneGraphMode===0?this.node:null),manager:p.manager,parent:this,instanceId:q.instanceId},n)}if(c.sceneGraphMode===0){if(j._status>=g.loading){if(j.node){var o=new f();o.setMatrix(this.matrix);o.addChild(j.node);this.node.addChild(o)}}}else{this.reference.requestBuildSceneGraphHierarchy()}this.viewpointTag=-1;this.reference.updateMemorySize();if(this.reference._optional&&this.reference._optional.hasOverride()&&n){n.add(this.reference)}};b.getOccurrenceMatrix=function(i,j){if(j===null){return i}else{return new d.Matrix4().multiplyMatrices(i,j)}};b.prototype.getChildren=function(){var k=[],o,p,n=[];var m,l;for(m=0;m<this.reference.children.length;m++){o=this.reference.children[m].reference;if(n.indexOf(o)===-1){for(l=0;l<o._occurrences.length;l++){p=o._occurrences[l];if(p!==null&&p.parent===this){k.push(p)}}n.push(o)}}return k};b.prototype.getIdPath=function(){if(this.parent){var i=this.parent.getIdPath();i.push(this.instanceId);i.push(this.reference.referenceId);return i}else{return[this.reference.referenceId]}};b.prototype.removeFromSceneGraph=function(){if(!this.node){return}if(this.reference.node){this.reference.node.removeChild(this.node)}var k=this.getChildren();var j,l;for(j=0;j<k.length;j++){}};b.prototype.detach=function(){var k=this.getChildren();this.reference._removeOccurrenceFromList(this);var j;for(j=0;j<k.length;j++){k[j].detach()}};b.prototype.buildPathElement=function(){if(this.reference.node){var k=[];var l,m,n=this,j;while(n){k.unshift(n.reference.node);j=null;if(n.parent){j=n.parent.reference.getChildInstanceNode(n.instanceId);if(!j){return null}k.unshift(j)}n=n.parent}return new e(k)}return null};b.prototype.getBoundingSphere=function(){var i=this.reference.getBoundingSphere().clone();i.applyMatrix4(this.matrix);return i};return b});define("DS/3DXMTiles/BSScreenSizeLODSelector",["DS/3DXMTiles/LODSelector","DS/Visualization/ThreeJS_DS"],function(d,c){var e=new c.Vector3();var b=new c.Matrix4();var a=d.extend({init:function(f){this._parent();this.type="BSScreenSize";this.screenSize=f},computeLOD:function(f,g){f.computeScreenRadius(g);if(f._screenRadius>=this.screenSize){return 1}else{return 0}},getLOD:function(f){if(f>=this.screenSize){return 1}else{return 0}},createJSON:function(f){f=f||{};f.screenSize=this.screenSize;return this._parent(f)}});a.createFromJSON=function(f){var g=f.screenSize;return new a(parseFloat(g))};return a});define("DS/3DXMTiles/LDHReference",["DS/3DXMTiles/BSScreenSizeLODSelector","DS/3DXMTiles/3DXMTilesUtils","DS/Visualization/Mesh3D","DS/3DXMTiles/LDHOccurrence","DS/Visualization/ThreeJS_R57","DS/Visualization/Node3D","DS/3DXMTiles/Debug3DXMTiles","DS/3DXMTiles/LDHReferenceStatus","DS/3DXMTiles/LDHHandler","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Selection/CSOManager","DS/3DXMTiles/LDHReferenceUnloadStatus","DS/3DXMTiles/LDHOcclusionStatus"],function(h,E,c,o,B,n,s,C,i,k,r,z,A,t){var p=1;var d={inList:1,inToBeLoaded:2,inLoaded:4,inForced:8,inUnknown:16,inHighPriority:24};var f={regular:0,hasWrapChild:1,wrap:2};var u={requested:"requested",none:"none",slave:"slave"};var m=new h(10);var q=function(F,G,H){this.reference=F;this.node=null;this.matrix=G;this.instanceId=H;this.userData=null};var g=-1;var l=function(F){if(g===-1){g=window.OOCForceBoundingSphere?1:0}this.id=p++;this._occurrences=[];this.url=F.urlOrId;this._boundingSphere=F.boundingSphere;this._boundingBox=F.boundingBox;this.updateBoundingSphere();this.handler=F.handler;this.manager=F.manager;this._lodSelector=m;this._screenRadiusCache=[];this._screenRadius=0;this._loadingPriority=0;this.node=F.leaf?F.node:null;this.children=[];this._status=C.incomplete;this._unloadStatus=A.unloaded;this._optional=null;this.parents=[];this.memorySize=0;this.memorySizeGPU=-1;this.referenceId=F.referenceId;this.userData=null;this.unloadLockCounter=0;this.loading=false;this.toUnload=false;this.wrapStatus=f.regular;this.inListStatus=0;this.isRoot=false;this.transactionStatus=0;this.expectedNbChildren=-1;this.unloadViewpointTag=-1;this.sgFlag=F.leaf?u.slave:u.none};l.prototype.setNode=function(G){if(s.sceneGraphMode===1){this.node=G}if(s.sceneGraphMode===0){var F;for(F=0;F<this._occurrences.length;F++){this._occurrences[F].node=G}}};l.prototype.addedToTransaction=function(){var F,G;this.transactionStatus=3;for(F=0;F<this.parents.length;F++){G=this.parents[F];G.addedToTransaction_parents();if(G.transactionStatus<3){G.transactionStatus=2}}};l.prototype.addedToTransaction_parents=function(){var F,G;if(this.transactionStatus===0){this.transactionStatus=1;for(F=0;F<this.parents.length;F++){this.parents[F].addedToTransaction_parents(this.parents[F])}}};l.prototype.recursiveUpdateStatus=function(I){var G=this.transactionStatus,F;var J;if(G>0){var H;this.transactionStatus=0;for(H=0;H<this.children.length;H++){this.children[H].reference.recursiveUpdateStatus(I)}if(G===3){J=this.isFrozen();this.updateUnloadStatus();this.updateMemorySize();this._onLoaded();if(this.isFrozen()&&!J&&this.isInList()){F=I.queues[this.handler.type];F.onNodeToRemoveFromList()}if(this.isUnloadable()){I.addLoadedNode(this)}}else{if(G===2){this.updateStatusFromChildren();this.updateUnloadStatus()}}}};l.prototype.setIsRoot=function(F){if(F!==this.isRoot){this.isRoot=F;if(F){if(this.node){this.manager.targetNode.addChild(this.node)}}else{if(this.node){this.manager.targetNode.removeChild(this.node)}}}};l.prototype.getOccurrences=function(){if(this.isSlave()){return this.node?this.node._occurrences:null}else{return this._occurrences}};l.prototype.isLocked=function(){return this._status===C.locked};l.prototype.isLoaded=function(){return this._status===C.complete};l.prototype.forceLoad=function(F,G){var H=this.isForced();if(!this._optional){this._optional=new b()}if(F){if(!this._optional._force){this._optional._force=new x()}if(this.isLoaded()){setTimeout(G,0);this._optional._force=new x()}else{this._optional._force.onForce(G)}}else{this._optional._force=null}var I=this.isForced();if(H!==I){if(I){this.lockUnload(undefined,undefined,true)}else{this.unlockUnload(undefined,undefined,undefined,true)}this.manager.registerTilesNode(this)}};l.prototype.setOverrideCB=function(G,F){if(F&&!this._optional){this._optional=new b()}if(this._optional){this._optional.setOverride(G,F);this.updateOverride()}};l.prototype.hasOverrideCB=function(F){if(this._optional){return this._optional.hasOverride(F)}return false};l.prototype.removeParent=function(G){var F,I=0;for(F=0;F<this.parents.length;F++){if(this.parents[F]!==G){this.parents[I]=this.parents[F];I++}else{}}this.parents.length=I;var H;I=0;for(F=0;F<this._occurrences.length;F++){H=this._occurrences[F];if(H.parent&&H.parent.reference!==G){this._occurrences[I]=H;I++}else{H.parent=null}}this._occurrences.length=I;if(this.unloadLockCounter>0){this.unlockUnload(this.unloadLockCounter,G)}};l.prototype.addToOcclusionChecker=function(I){var H,J,G=[];for(H=0;H<this._occurrences.length;H++){J=this._occurrences[H];G.push(J.matrix)}var F=this.getBoundingBox();I.addBox(F,G)};l.prototype.setStatus=function(G){if(this._status===C.dead){return}var F=this._status!==G;this._status=G;if(F){this.manager.registerTilesNode(this)}};l.prototype.setUnloadStatus=function(I){var F=this._unloadStatus!==I;this._unloadStatus=I;if(F){this.manager.registerTilesNode(this)}var G,H;for(G=0;G<this.parents.length;G++){H=this.parents[G];if(!H.isFrozen()){H.setUnloadStatus(A.frozen)}}};l.prototype.updateUnloadStatus=function(){var G,F,I=false;for(G=0;G<this.children.length&&!I;G++){F=this.children[G].reference;if(!F.isUnloaded()||F.isLocked()||F.loading){I=true}}if(I||this.loading){this.setUnloadStatus(A.frozen)}else{this.setUnloadStatus(A.unloadable);var H;for(G=0;G<this.parents.length;G++){H=this.parents[G]}}};l.prototype.lockChildren=function(){if(this.isAlive()&&!this.isError()){this.setStatus(C.locked);var F;for(F=0;F<this.parents.length;F++){this.parents[F].updateUnloadStatus()}}};l.prototype.unlockChildren=function(){if(this.isLocked()){this.updateStatusFromChildren(true);var F;for(F=0;F<this.parents.length;F++){this.parents[F].updateUnloadStatus()}}};l.prototype.buildFlatList=function(){var H=[];this.traverse(function G(I){if(I.id>0){I.id*=-1;H.push(I);return false}else{return true}});var F=0;for(F=0;F<H.length;F++){H[F].id*=-1}return H};l.prototype.addReferenceChild=function(F,G,K,J){var H,M,I,L;for(H=0;H<this._occurrences.length;H++){M=this._occurrences[H];I=o.getOccurrenceMatrix(M.matrix,G);L=new o({reference:F,matrix:I,node:(s.sceneGraphMode===0?M.node:null),parent:M,instanceId:K},J)}this.children.push(new q(F,G,K));if(F.unloadLockCounter>0){F.lockUnload(F.unloadLockCounter)}if(F.parents.indexOf(this)===-1){F.parents.push(this)}if(F.node!==null){this.requestBuildSceneGraphHierarchy(true)}this.updateMemorySize()};l.prototype.addOnLoadedCB=function(F){if(!this._optional){this._optional=new b()}this._optional.addOnLoadedCB(F)};l.prototype._onLoaded=function(){if(this._optional&&this._optional._force){this._optional._force.onLoaded()}if(this._optional){this._optional.onLoaded()}};l.prototype.computeLODValue=function(I){var G=I.viewpoint;var F=I.cst;var H=this._lodSelector.computeLOD(this,I);if(this._boundingSphere===null){H=1}return H};l.prototype.getLODValue=function(){return this._lodSelector.getLOD(this._screenRadius)};l.prototype.computeScreenRadius=function(L){var M=L.cst;var O=L.viewpoint;var W=this.isSlave();if(this._topLoadPriority){this._screenRadius=Infinity;return this._screenRadius}else{if(this._boundingSphere){var P=-Infinity,Y,X,U=-Infinity,H,S;var V=this,aa,H;var J=0;var N=this._screenRadiusCache,R;if(!W){aa=this._occurrences}else{aa=this.node._occurrences;if(N){var K=false;if(N.length!==aa.length){K=true}for(Y=0;!K&&Y<aa.length;Y++){R=N[Y];if(R.positionHasChanged(aa[Y].matrix)){K=true}}}if(K){N=[];this._screenRadiusCache=N}}for(Y=0;Y<aa.length;Y++){var G=aa[Y];if(J>=N.length){R=E.computeScreenRadiusCache(G.matrix,null,this._boundingSphere,undefined,W);N.push(R)}else{R=N[J]}J++;H=E.computeScreenRadius(R,O.camera,O._frustum,M);if(P<H){P=H}var Z=O.camera,I=R.center,T=R.radius;var F=L.bsRadius;var Q=L.priorityComputer;var ab=Z.position.distanceTo(I)-T;S=Q.computePriority(L,H,ab);if(U<S){U=S}}this._screenRadius=P;this._loadingPriority=U;return P}}this._screenRadius=1;return 1};l.prototype.updateNodeLOD=function(G){var F;if(this.isForced()){F=1;this._screenRadius=Infinity}else{F=this.computeLODValue(G)}return F};l.prototype.dumpAnyPath=function(){console.log(this.url);this.father[0]&&this.father[0].dumpAnyPath()};function D(G,J){var H=0;if(!G.noMeshInRAM||J){var I=[G.vertexIndexArray,G.vertexNormalArray,G.vertexPositionArray],F;for(F=0;F<I.length;F++){if(I[F]){H+=I[F].byteLength}}}return H}function a(G){var H=0;var I=[G.vertexIndexArray,G.vertexPositionArray,G.vertexNormalArray,G.vertexUvArray,G.vertexUv2Array,G.vertexTangentArray,G.vertexBinormalArray,G.vertexColorArray,G.vertexPreviousPositionArray,G.vertexNextPositionArray,G.vertexSideExtrusionArray,G.vertexLineDistancesArray,G.vertexSkinIndexArray,G.vertexSkinWeightArray],F;for(F=0;F<I.length;F++){if(I[F]){H+=I[F].byteLength}}return H}l.prototype.getMemorySizeGPU=function(){return this.memorySizeGPU>=0?this.memorySizeGPU:0};l.prototype.computeMemorySizeGPU=function(){var F=-1;if(this.node){if(this.node.children.length>0){if(this.memorySizeGPU===-1){if(this.handler.type===i.Model3DHandler){this.node.traverse(function(H){var G;if(H instanceof c){var I=H.mesh3js.geometry;for(G=0;G<I.length;G++){F+=a(I[G])}}})}}else{F=this.memorySizeGPU}}else{F=0}}return F};l.prototype.computeMemorySize=function(F){if(this.handler.type===i.Model3DHandler){return 0}var G=0;if(this.node){if(this.handler.type===i.Model3DHandler){this.node.traverse(function(I){var H;if(I instanceof c){var J=I.mesh3js.geometry;for(H=0;H<J.length;H++){G+=D(J[H],F)}}})}G+=824+(this.node._occurrences.length-1)*280}G+=232+this._occurrences.length*(128+208);G+=this.children.length*(128+208);return G};l.prototype.getMemorySize=function(){this.memorySize=this.getMemorySize();return this.memorySize};l.prototype.updateMemorySize=function(){var F=this.manager.unloadManager.oldVersion;var K=F?0:this.computeMemorySizeGPU();var J=this.computeMemorySize(F);var I=K<J?J:K;if(this.handler.type===0){var H=this.getLDHNodeManagerQueue();H.memorizeReferenceSize(this.referenceId,I)}var G=false;if(J!==this.memorySize){G=true}if(K!==this.memorySizeGPU){G=true}if(G){this.manager.unloadManager.onReferenceMemoryChange(J-this.memorySize,K-this.memorySizeGPU);this.memorySize=J;if(F){this.memorySizeGPU=K}else{this.memorySizeGPU=K>0?K:-1}}};l.prototype.requestBuildSceneGraphHierarchy=function(H){if(this.sgFlag===u.none){var F,I=H||false,J;for(F=0;F<this.children.length&&!I;F++){J=this.children[F];if(J.reference.sgFlag!==u.none){I=true}}if(I){this.setSGFlag(u.requested);var G;for(F=0;F<this.parents.length;F++){G=this.parents[F];G.requestBuildSceneGraphHierarchy(true)}}}};l.prototype.setSGFlag=function(F){this.sgFlag=F};l.prototype.tryBuildSceneGraphHierarchy=function(I){var H,J,F;if(this.sgFlag===u.requested){var G=this.node?true:false;if(!this.node){this.node=new n();if(this.userData){this.node.setUserData(this.userData)}this.node.setModelIdentification(this.referenceId);this.node.setNodeUsage(this.handler.type===i.Model3DHandler?n.REPRESENTATION_NODE:n.REFERENCE_NODE);if(this._boundingSphere&&g){this.node.forceBoundingElements(true,{sphere:this._boundingSphere},null)}if(this.isRoot){this.manager.targetNode.addChild(this.node)}if(this._optional&&this._optional.hasOverride()){I.push(this)}}for(H=0;H<this.children.length;H++){J=this.children[H];F=J.reference;F.tryBuildSceneGraphHierarchy(I);if(!J.node&&F.node){J.node=new n();if(J.userData){J.node.setUserData(J.userData)}J.node.setModelIdentification(J.instanceId);J.node.setNodeUsage(n.INSTANCE_NODE);J.node.setMatrix(J.matrix);J.node.addChild(F.node);this.node.addChild(J.node)}}this.setSGFlag(u.none);if(this.node&&!G&&this._optional&&this._optional.onAddedToSceneGraphCB){this._optional.onAddedToSceneGraphCB.call(undefined,this.referenceId)}this.updateMemorySize()}};l.prototype.updateOverride=function(){var F=this._optional;if(F&&F.overrideData){F.overrideData.updateOverride(this.manager,this.node,this.referenceId);if(F.overrideData.isEmpty()){F.overrideData=null}}};l.prototype.removeFromSceneGraph=function(I){if(this.isSlave()){this.manager.unloadLeafReferenceCB(this.referenceId)}else{if(this.parents.length===0){return}if(this.node!==null){if(this.isUnloadLocked()){if(I){this.node.removeChildren()}}else{var G,F=this.node.parents.concat([]),J,H;for(G=0;G<F.length;G++){J=F[G];H=J.parents[0];J.removeChild(this.node);H.removeChild(J)}for(G=0;G<this.parents.length;G++){this.parents[G].removeChildNode(this);if(this.parents[G].node&&this.parents[G].node.children.length===0){this.parents[G].removeFromSceneGraph()}}this.node=null;if(this._optional&&this._optional.onRemovedFromSceneGraphCB){this._optional.onRemovedFromSceneGraphCB.call(undefined,this.referenceId)}}}}this.updateMemorySize();this.updateOverride()};l.prototype.removeChildNode=function(F){var G,H;for(G=0;G<this.children.length;G++){H=this.children[G];if(H.reference===F){H.node=null}}this.updateMemorySize()};l.prototype.getChildInstanceNode=function(G){var F,H;for(F=0;F<this.children.length;F++){H=this.children[F];if(H.instanceId===G){return H.node}}return null};l.prototype.traverse=function(H){var G=H(this);if(!G){var F;for(F=0;F<this.children.length;F++){this.children[F].reference.traverse(H)}}};l.prototype.traverseParents=function(H,F){if(!F.has(this)){var G=new Set();G.add(this);this.traverseParents_internal(H,F,G)}};l.prototype.traverseParents_internal=function(J,F,I){J(this);var G,H;for(G=0;G<this.parents.length;G++){H=this.parents[G];if(!I.has(H)&&(!F||!F.has(H))){I.add(H);H.traverseParents_internal(J,F,I)}}};l.prototype.createJSON=function(){var I={references:[]};this.traverse(function(L){L.visited=false});var G=0;this.traverse(function(L){if(!L.visited){L.visited=true;L.jsonIndex=G++;var M=L.createJSON_internal();I.references.push(M)}});var H,F,J,K;for(H=0;H<I.references.length;H++){J=I.references[H];for(F=0;F<J.c.length;F++){K=J.c[F];K.r=K.r.jsonIndex}}return I};l.prototype.createJSON_internal=function(){var H={url:this.url,bs:this._boundingSphere?this._boundingSphere.createJSON():null,i:this.node?true:false,c:[]};var G,I,F;for(G=0;G<this.children.length;G++){I=this.children[G];F={};F.m=I.matrix.createJSON();F.r=I.reference;F.i=I.node?true:false;H.c.push(F)}return H};l.prototype._removeOccurrenceFromList=function(G){var F=this._occurrences.indexOf(G);if(F<0){console.log("Internal inconsistency")}else{this._occurrences[F]=null}};l.prototype._removeNullsFromOccurrenceList=function(){var F,G=0;for(F=0;F<this._occurrences.length;F++){var H=this._occurrences[F];if(H){this._occurrences[G]=H;G++}}this._occurrences.length=G};l.prototype._isDetachPossible=function(){return this._occurrences.length===0};l.prototype._detach=function(){if(this.node){var G=this.node.parents;var H;for(H=0;H<G.length;H++){var F=G[H];F.removeChild(this.node)}this.node.removeChildren();this.node=null}this.children=[];this.parents=[];this.setStatus(C.removeRequested)};l.prototype.isUnknown=function(){return this._boundingSphere?false:!this.isLoaded()};l.prototype.isForced=function(){return(this._optional&&this._optional._force)?true:false};l.prototype.setOnRemovedFromSceneGraphCB=function(F){if(!this._optional){this._optional=new b()}this._optional.onRemovedFromSceneGraphCB=F;if(!this.node&&F){F.call(undefined,this.referenceId)}};l.prototype.setOnAddedToSceneGraphCB=function(F){if(!this._optional){this._optional=new b()}this._optional.onAddedToSceneGraphCB=F;if(this.node&&F){F.call(undefined,this.referenceId)}};l.prototype.isInList=function(){return(this.inListStatus&d.inList)?true:false};l.prototype.setInList=function(F){if(F){this.inListStatus=this.inListStatus|d.inList}else{this.inListStatus=this.inListStatus&30}};l.prototype.isInToBeLoaded=function(){return(this.inListStatus&d.inToBeLoaded)?true:false};l.prototype.setInToBeLoaded=function(F){if(F){this.inListStatus=this.inListStatus|d.inToBeLoaded}else{this.inListStatus=this.inListStatus&29}};l.prototype.isInLoaded=function(){return(this.inListStatus&d.inLoaded)?true:false};l.prototype.setInLoaded=function(F){if(F){this.inListStatus=this.inListStatus|d.inLoaded}else{this.inListStatus=this.inListStatus&27}};l.prototype.isInForced=function(){return(this.inListStatus&d.inForced)?true:false};l.prototype.setInForced=function(F){if(F){this.inListStatus=this.inListStatus|d.inForced}else{this.inListStatus=this.inListStatus&23}};l.prototype.isInUnknown=function(){return(this.inListStatus&d.inUnknown)?true:false};l.prototype.isInHighPriority=function(){return(this.inListStatus&d.inHighPriority)?true:false};l.prototype.setInUnknown=function(F){if(F){this.inListStatus=this.inListStatus|d.inUnknown}else{this.inListStatus=this.inListStatus&15}};l.setScreenSize=function(F){m.screenSize=F};l.getScreenSize=function(){return m.screenSize};l.prototype.isAlive=function(){return this._status!==C.dead};l.prototype.isError=function(){return this._status===C.error};l.prototype.lockUnload=function(J,I,G){J=J||1;this.unloadLockCounter+=J;if(!I||G){var F,H;for(F=0;F<this._occurrences.length;F++){H=this._occurrences[F].parent;if(H){H.reference.lockUnload(J,true,G)}}}};l.prototype.unlockUnload=function(K,H,J,G){K=K||1;this.unloadLockCounter-=K;if(!J||G){var F,I;for(F=0;F<this._occurrences.length;F++){I=this._occurrences[F].parent;if(I&&(!H||H.reference===H)){I.reference.unlockUnload(K,undefined,true,G)}}}};l.prototype.isUnloadLocked=function(){return this.isForced()||this.unloadLockCounter>0};l.prototype.hasGrandChildren=function(){var F=0;for(F=0;F<this.children.length;F++){if(this.children[F].reference.children.length>0){return true}}return false};l.prototype.updateParentsStatus=function(){var F,G;for(F=0;F<this.parents.length;F++){G=this.parents[F];G.updateStatusFromChildren();G.updateUnloadStatus()}};l.prototype.updateStatusFromChildren=function(F){if(F||!this.isLocked()){if(this.expectedNbChildren<0){this.setStatus(C.incomplete)}else{if(this.expectedNbChildren>0&&this.children.length<this.expectedNbChildren){this.setStatus(C.incomplete)}else{this.setStatus(C.complete)}}}};l.prototype.checkConsistency=function(I){var J=this;var H,M,F,L;function N(){for(H=0;H<J.parents.length;H++){M=J.parents[H];if(!M.isFrozen()){throw new Error("inconsistency")}}}function K(O){for(H=0;H<J.children.length;H++){F=J.children[H];if(F.reference._status!==O){throw new Error("inconsistency")}}}if(this.isFrozen()){N();L=false;for(H=0;H<this.children.length;H++){F=this.children[H];if(F.reference.children.length>0){L=true}}if(!L){throw new Error("inconsistency")}}if(this._unloadStatus===A.unloadable){for(H=0;H<this.children.length;H++){F=this.children[H];if(F.reference.children.length>0){throw new Error("inconsistency")}}}if(this.children.length>0){N()}if(I){var G;for(G=0;G<this.parents.length;G++){this.parents[G].checkConsistency(false)}for(G=0;G<this.children.length;G++){this.children[G].reference.checkConsistency(false)}}};l.prototype.getChild=function(G){var F;for(F=0;F<this.children.length;F++){if(this.children[F].instanceId===G){return this.children[F]}}return null};l.prototype.isSlave=function(){return this.sgFlag===u.slave};function e(F,K){if(!F.isEmpty()){var L=F.get();var H,G;for(H=0;H<L.length;H++){var I=L[H].pathElement;var J=I&&I.externalPath;if(I){for(G=J.length-1;G>=0;G--){if(J[G]===K){return true}}}}}return false}l.prototype.isUnloadable=function(G){if(this._unloadStatus!==A.unloadable){return false}if(G){var F=this.node;if(F&&(e(k,F)||e(r,F)||e(z,F))){return false}}return true};l.prototype.isUnloaded=function(){return this._unloadStatus===A.unloaded};l.prototype.shouldBeExpanded=function(){return this._status!==C.complete||(this.handler.type===1&&this.wrapStatus===f.hasWrapChild)};l.prototype.isComplete=function(){return this._status===C.complete};l.prototype.isIncomplete=function(){return this._status===C.complete};l.prototype.isFrozen=function(){return this._unloadStatus===A.frozen};l.prototype.setExpectedNbChildren=function(G){var F=false;if(G!==this.expectedNbChildren&&(this.expectedNbChildren!==-1||(this.handler.type===1&&G===0))){F=true}this.expectedNbChildren=G;if(F){this.clearViewpointTags();this.manager.forceUpdateNode(this);this.updateStatusFromChildren()}};l.prototype.clearViewpointTags=function(){var F;for(F=0;F<this._occurrences.length;F++){this._occurrences[F].viewpointTag=-1}};l.prototype.getLDHNodeManagerQueue=function(){return this.manager.queues[this.handler.type]};l.prototype.updateBoundingSphereFromNode=function(){if(this.node){var F=this.node.getBoundingSphere();if(F){this._boundingSphere=F.clone()}}};l.prototype.hasDifferentViewpointTag=function(G){if(this._occurrences.length>0){var F,H;for(F=0;F<this._occurrences.length;F++){H=this._occurrences[F];if(H.viewpointTag!==G){return true}}return false}else{return true}};l.prototype.buildDebugJSON=function(J){var F=this,G;var K={screenRadius:F._screenRadius,status:F._status,unloadStatus:F._unloadStatus,handlerType:this.handler.type,parents:[]};if(!J){K.referenceId=F.referenceId}var I;for(I=0;I<this.parents.length;I++){K.parents.push(this.parents[I].referenceId)}if(F.expectedNbChildren!==0||F.children.length>0){K.expectedNbChildren=F.expectedNbChildren;K.nbChildren=F.children.length;if(F.children.length>0){var H=[],L;for(G=0;G<F.children.length;G++){L=F.children[G];H.push({ref:L.reference.referenceId,inst:L.instanceId})}K.children=H}}if(F.toUnload){K.toUnload=true}if(F.loading){K.loading=true}if(F.unloadLockCounter>0){K.unloadLockCounter=F.unloadLockCounter}if(F.node){K.inSceneGraph=true}return K};l.prototype.setLoadModelOptions=function(F){if(!this._optional){this._optional=new b()}this._optional.setLoadModelOptions(F)};l.prototype.getLoadModelOptions=function(){if(this._optional){return this._optional.loadModelOptions}return null};l.prototype.userLockUnload=function(){if(!this._optional){this._optional=new b()}this.lockUnload();this._optional.addUserLockUnload()};l.prototype.userUnlockUnload=function(){if(this._optional&&this._optional.userLockUnload>0){this.unlockUnload();this._optional.removeUserLockUnload()}};l.prototype.needScreenRadiusSizeComputation=function(){if((this._status===C.incomplete||this._status===C.complete)&&!this.loading){return true}else{return false}};l.prototype.setUnloadViewpointTag=function(F){this.unloadViewpointTag=F};l.prototype.getUnloadViewpointTag=function(){return this.unloadViewpointTag};l.prototype.updateBoundingSphere=function(){if(!this._boundingSphere&&this._boundingBox){this._boundinSphere=this._boundingBox.getBoundingSphere()}};l.prototype.getBoundingBox=function(){if(!this._boundingBox){var F=this._boundingSphere;if(!F){return null}var G=new B.Box3();G.min.x=F.center.x-F.radius;G.min.y=F.center.y-F.radius;G.min.z=F.center.z-F.radius;G.max.x=F.center.x+F.radius;G.max.y=F.center.y+F.radius;G.max.z=F.center.z+F.radius;this._boundingBox=G}return this._boundingBox};var y=new B.Sphere();l.prototype.getBoundingSphere=function(F){if(this._boundingSphere){return this._boundingSphere}else{if(this._boundingBox){this._boundingBox.getBoundingSphere(y);return y}}if(F){return new B.Sphere()}else{return null}};l.prototype.setWrapStatus=function(F){this.wrapStatus=F};l.prototype.updateWrapStatusFromChildren=function(J){if(!this.comesFromWrap()){var G;var F=this.children,I,H=false;for(G=0;G<F.length&&(!J||!H);G++){I=F[G].reference;if(I.comesFromWrap()){H=true;if(!J){I.setParentDoesNotComeFromWrap()}}}if(H){this.setWrapStatus(f.hasWrapChild)}}};l.prototype.setParentDoesNotComeFromWrap=function(){if(this.comesFromWrap()){this.setComesFromWrap(false);this.updateWrapStatusFromChildren(true)}};l.prototype.setComesFromWrap=function(F){this.setWrapStatus(F?f.wrap:f.regular)};l.prototype.comesFromWrap=function(){return this.wrapStatus===f.wrap};var j=-1;l.prototype.getScore=function(){if(j===-1){j=window.OOCNewPriorityPrototype?1:0}return j===1?this._loadingPriority:this._screenRadius};l.lodSelector=m;var b=function(){this._force=null;this.onAddedToSceneGraphCB=null;this.onRemovedFromSceneGraphCB=null;this.onLoadedCallbacks=null;this.loadModelOptions=null;this.userLockUnload=0;this.overrideData=null};b.prototype.setOverride=function(G,F){if(!this.overrideData){this.overrideData=new v()}this.overrideData.setOverride(G,F);if(this.overrideData.isEmpty()){this.overrideData=null}};b.prototype.hasOverride=function(F){if(F===undefined){return this.overrideData!==null}else{return this.overrideData&&this.overrideData.hasOverride(F)}};b.prototype.addUserLockUnload=function(){this.userLockUnload++};b.prototype.removeUserLockUnload=function(){this.userLockUnload--};b.prototype.addOnLoadedCB=function(F){if(!this.onLoadedCallbacks){this.onLoadedCallbacks=[]}this.onLoadedCallbacks.push(F)};b.prototype.onLoaded=function(){if(this.onLoadedCallbacks){var F;for(F=0;F<this.onLoadedCallbacks.length;F++){this.onLoadedCallbacks[F]()}this.onLoadedCallbacks=null}};b.prototype.setLoadModelOptions=function(F){this.loadModelOptions=F};var x=function(){this.callbacks=[]};x.prototype.onForce=function(F){if(F){this.callbacks.push(F)}};x.prototype.onLoaded=function(){var F;for(F=0;F<this.callbacks.length;F++){this.callbacks[F]()}this.callbacks.length=0};x.prototype.clear=function(){this.callbacks.length=0};var w=function(){this.override=null;this.overrideCB=null};var v=function(){this.count=0;this.overrideMap={}};v.prototype.setOverride=function(H,F){var G=this.overrideMap[H];if(G){G.overrideCB=F}else{if(F){G=new w();G.overrideCB=F;this.overrideMap[H]=G;this.count++}}};v.prototype.hasOverride=function(G){var F=this.overrideMap[G];return(F&&F.overrideCB)?true:false};v.prototype.isEmpty=function(){return this.count===0};v.prototype.updateOverride=function(J,H,G){var M,N,F,O,K,I=null;for(M in this.overrideMap){N=J.getOverrideSet(M);K=this.overrideMap[M];F=K.override;O=K.overrideCB;if(H&&O){if(!F){F=N._createNodeOverride(H);K.override=F}else{F._forceOverrideUpdate()}O(G,F)}else{if(F){N.deleteOverride(F);K.override=null;if(!O){I=I||[];I.push(M)}}}}var L;for(L=0;I&&L<I.length;L++){delete (this.overrideMap[I[L]]);this.count--}};return l});define("DS/3DXMTiles/ModelLoaderPool",["DS/Visualization/ModelLoader","DS/Visualization/LoaderUtils","DS/Visualization/Node3D","DS/3DXMTiles/Debug3DXMTiles"],function(d,b,f,e){var c={nbLoadedModels:0,startTime:0,onLoadedCB:null,steps:[{value:250,name:"250",delta:-1},{value:500,name:"500",delta:-1},{value:1000,name:"1k",delta:-1},{value:2000,name:"2k",delta:-1},{value:5000,name:"5k",delta:-1},{value:10000,name:"10k",delta:-1},{value:Infinity,name:"impossible",delta:-1}],nextStep:0,init:function(){if(this.startTime===0){this.startTime=Date.now()}},onLoadedModel:function(){this.nbLoadedModels++;if(this.onLoadedCB){this.onLoadedCB(this.nbLoadedModels)}if(this.nbLoadedModels>this.steps[this.nextStep].value){this.steps[this.nextStep].delta=Date.now()-this.startTime;this.nextStep++}},setOnLoadedCallback:function(g){this.onLoadedCB=g},clearOnLoadedCallback:function(){this.onLoadedCB=null},};window.modelLoaderPoolStats=c;var a={modelLoader:new d(),nbTickets:20,_index:1,beforeLoadParams:function(i){var g=i.urlArray.concat([]);var h=g.length;a.nbTickets-=h},loadParams:function(v,w,t,g,h,u){var q=0,l=v.urlArray.concat([]),j,x=v.targetArray.concat([]);var m=l.length;var p=[];var s=false;var k=this._index++;function i(){if(s){t&&t()}else{w&&w(v,p)}x=[];v=[];w=null;t=null}function o(y){m--;y=y||[];p=p.concat(y);if(m===0){i()}else{r()}}function n(){m--;s=true;if(m===0){i()}else{r()}}function r(){var y,z;while(l.length>0){y=l.pop();z=x.pop();if(y){a._loadModel(y,z,o,n,g,h,u)}else{setTimeout(n,0)}}}r()},debug:false,setDebug:function(g){this.debug=g},_loadModel:function(m,A,z,t,h,i,x){function u(){e.endProbe("load_"+A.referenceId);if(g){c.onLoadedModel()}a.nbTickets++;A=null;w.setTargetNode(null);t()}if(this.debug){m=this.removeTag(m)}var g=false;b.__storeCGRNames=0;var w=this.modelLoader;w.setKeepLoaderMode(true);var n=A.manager;if(!m.endsWith(".instref")){g=true;if(e.sceneGraphMode===0){A.node=new f();for(var v=0;v<A._occurrences.length;++v){var l=A._occurrences[v];var q=new f();q.setMatrix(l.matrix);q.addChild(A.node);l.node.addChild(q)}}else{A.requestBuildSceneGraphHierarchy(true);n.tryBuildSceneGraphHierarchy()}if(!A.node){setTimeout(u,1);return}w.setSceneGraph(A.node)}else{w.setSceneGraph(A)}if(h){w.activateSmartLoading(h.getRenderer());w.setRenderCallback(h.render,1000)}w.setFileType(i||"xmlv43");var p=m.endsWith(".cgr")||i==="cgr"?w.setOnLoadedProductStructureCallback:w.setOnLoadedCallback;p.call(w,function(j){e.endProbe("load_"+A.referenceId);if(g){c.onLoadedModel()}a.nbTickets++;if(A.isSlave()&&n.onLeafReferenceLoadedCB){n.onLeafReferenceLoadedCB(A.referenceId,j)}w.setTargetNode(null);A=null;z(j)});w.setOnErrorCallback(u);if(g){c.init()}var y={filename:m,format:i||undefined,loaderSettings:{gasSharing:true}};if(x){var B;for(B in x){y[B]=x[B]}}var s=A.getLoadModelOptions();var o=false;var r=false,k=null;if(r){k={debugCapture:true,captureName:A.referenceId+"."+i}}if(s){var B;k=k||{};for(B in s){if(B==="noMeshInRAM"){o=s[B]?true:false}else{if(B==="applicativeContainers"){k[B]=s[B]}else{y[B]=s[B]}}}}w.setNoMeshInRAM(o);e.startProbe("load_"+A.referenceId);w.loadModel(y,undefined,undefined,k)},removeTag:function(g){var j=g.indexOf("#");if(j>=0){var h=g.lastIndexOf(".");var i=g.substring(0,j)+g.substring(h);return i}return g}};a.modelLoader.sharedBuffers=false;return a});define("DS/3DXMTiles/LODData",["DS/3DXMTiles/ModelLoaderPoolParams"],function(a){var b=function(c,d){this.nodes=c.concat([]);this.lod=d};b.prototype.buildParams=function(e,c){var d,f=new a(this.lod);for(d=0;d<this.nodes.length;d++){this.nodes[d].traverse(function(g){if(g.hasOwnProperty("url")&&!g._loaded){f.addFromNode(g,e);g.setTemporaryParents(c)}})}return f};b.empty=new b([]);return b});define("DS/3DXMTiles/OOCManagerEntry",["DS/3DXMTiles/LDHReference"],function(a){var b=function(d,c){this.id=d;this.reference=new a({handler:c.handler,manager:c.manager._ldhNodeManager,boundingSphere:c.boundingSphere&&c.boundingSphere.clone(),boundingBox:c.boundingBox&&c.boundingBox.clone(),urlOrId:c.url,referenceId:d,leaf:c.leaf?true:false,node:c.node||null});if(c.loadModelOptions){this.reference.setLoadModelOptions(c.loadModelOptions)}};return b});define("DS/3DXMTiles/OOCManagerRootEntry",["DS/3DXMTiles/LDHReference"],function(b){var a=function(d,c){this.occurrence=d;this.boundingBox=c&&c.clone()};a.prototype.computeSceneMin=function(){var c=this.boundingBox.clone();c.applyMatrix4(this.occurrence.matrix);return c.min.z};return a});define("DS/3DXMTiles/LDHReferenceBank",["DS/3DXMTiles/LDHReference"],function(b){var a=function(d){this.reference=d;this.useCount=0};var c=function(){this.tos={}};c.prototype.getLDHReference=function(e,h,f,g){var d,i=this.tos[e];if(i){d=i.reference;i.useCount++}else{d=new b({urlOrId:e,boundingSphere:h,manager:f,referenceId:e,handler:g});i=new a(d);i.useCount++;this.tos[e]=i}return d};return c});define("DS/3DXMTiles/LDHReferenceBankSingleton",["DS/3DXMTiles/LDHReferenceBank"],function(a){return new a()});define("DS/3DXMTiles/OOCReferenceIterator",["DS/3DXMTiles/OOCInstanceIterator"],function(a){var b=function(c){this._reference=c};b.prototype.getReferenceId=function(){return this._reference.referenceId};b.prototype.getParents=function(){var c=[];var d;for(d=0;d<this._reference.parents.length;d++){c.push(new b(this._reference.parents[d]))}return c};b.prototype.getChildren=function(){var c=[],e;var d;for(d=0;d<this._reference.children.length;d++){e=this._reference.children[d];c.push(new a(new b(e.reference),e))}return c};b.prototype.getNode=function(){return this._reference.node};b.prototype.equals=function(c){if(!c){return false}return this._reference===c._reference};return b});define("DS/3DXMTiles/MassiveOcclusionChecker",["DS/Visualization/ThreeJS_DS","DS/Plugins/ClearPass","DS/Plugins/RenderPass","DS/Plugins/ComposerContext","DS/3DXMTiles/InstancingFactory","DS/Plugins/EffectComposer","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory"],function(l,e,c,j,m,f,g,i){var b=function(o,n){this.box=o;this.matrices=n};var k=-1;b.prototype.fillInstancingParams=function(s,r,p){var q,n=new l.Color(p?0:s+1);var o=this.matrices;for(q=0;q<o.length;q++){r.matrices.push(o[q]);r.boxes.push(this.box);r.colors.push(n)}};var d=new l.Box3();b.prototype.isContainingPoint=function(n){var o;for(o=0;o<this.matrices.length;o++){d.copy(this.box);d.applyMatrix4(this.matrices[o]);if(d.containsPoint(n)){return true}}return false};b.prototype.addDebugBoxes=function(q){var n=this.matrices,p,o;for(o=0;o<n.length;o++){p=i.createCuboidNodeFromBox3(this.box,new l.MeshPhongMaterial({color:"red",force:true}));p.setMatrix(this.matrices[o]);q.addChild(p)}};var a=-1;var h=function(p){if(k===-1){k=window.OOCDebugOcclusionChecker?true:false}this.viewer=p.viewer;this.debugId=-1;this.renderer=this.viewer.renderer.renderer;this.renderTargetPool=this.viewer.renderer.renderTargetPool;this.ratio=p.ratio||1;this.only=-1;this.renderList=p.renderList||"main";var o=["-->(main)","clearPass","occlusionPass"];this.composer=new f(this.renderer,undefined,this.renderTargetPool,o);this.clearPass=new e("clearPass");this.clearPass.clearColor=new l.Color("black");this.clearPass.clearAlpha=1;this.occlusionPass=new c(null,null,null,null,null,null,"occlusionPass");this.occlusionPass.disableToneMapping=true;this.width=Math.ceil(this.ratio*this.viewer.renderer.viewportWidth);this.height=Math.ceil(this.ratio*this.viewer.renderer.viewportHeight);var n=new l.WebGLRenderTargetProperties(this.width,this.height,"uintNearest");this.occlusionComposerContext=new j(n,this.composer,"occlusionComposerContext");this.occlusionComposerContext.keepResult=true;this.composer.addPass(this.clearPass);this.composer.addPass(this.occlusionPass);this.boxes=[];this.visibilitySet=new Set();this.depthBuffer=null;this.debugInput=false};h.prototype.clear=function(){this.boxes=[]};h.prototype.addBox=function(o,n){if(!(n instanceof Array)){throw new Error("invalid argument")}this.boxes.push(new b(o,n))};l.WebGLRenderTarget.prototype.readPixels=function(o){o.setRenderTarget(this);var n=new Uint8Array(4*this.width*this.height);var p=o.getContext();p.readPixels(0,0,this.width,this.height,p.RGBA,p.UNSIGNED_BYTE,n);return n};h.prototype.getVisibility=function(n){return this.visibilitySet.has(n)};h.prototype.buildNode=function(q,n){var p=this.boxes[q];var o=p.buildNode(n);return o};h.prototype.computeDepthBuffer=function(){var r=this.viewer.renderer;var q=null;var t=r.renderer.getContext(),s=this.viewer.internalSceneGraph.scene,n="main",p=this.viewer.internalSceneGraph;var o=s.defaultRenderList;s.defaultRenderList="ooc";q=r.renderOcclusionRealDepth("main",s,t,{main:this.viewer.currentViewpoint.camera},n,false,p);s.defaultRenderList=o;return q};h.prototype.computeVisibility=function(){if(!this.depthBuffer){this.depthBuffer=this.computeDepthBuffer()}var M=new l.Scene();var t=this.boxes;var y=new l.MeshBasicMaterial({color:"red",force:true,side:l.DoubleSide});var q=window.performance.now(),N=this.viewer.getSceneBoundingSphere(undefined,true)===null?false:true;var L,s=[],u=[],K={matrices:[],boxes:[],colors:[],material:y,useDBuffer:N,viewer:this.viewer,depthBuffer:this.depthBuffer};var v;for(L=0;L<t.length;L++){v=t[L];if(!v.isContainingPoint(this.viewer.currentViewpoint.camera.position)){t[L].fillInstancingParams(L,K,this.only>=0&&L!==this.only)}else{this.visibilitySet.add(L)}}if(this.debugInput){var x=new g();this.viewer.addNode(x);for(L=0;L<t.length;L++){v=t[L];if(this.only<0||L===this.only){v.addDebugBoxes(x)}}}var G=m.buildInstancingBox(K);var E=G._occurrences[0].renderable;M.add(E);var P={main:this.viewer.currentViewpoint.camera};this.composer.updateScene(M);this.renderer.materialToUse=l.MaterialToUse.originalMaterial;this.composer.setComposerContext(this.occlusionComposerContext);var o=window.performance.now();this.composer.render(undefined,undefined,P,"main");var O=window.performance.now();var p=this.viewer;var n=this.composer.getRenderResult("main");var J=n.readPixels(p.renderer.renderer);var I=window.performance.now();var D=this.width;var B=this.height;var F,w=false,A=0,C=0;for(var H=0;H<B;H++){for(var L=0;L<D;L++){var r=L+H*D;var z=L+(B-H-1)*D;F=((J[4*z]<<16)+(J[4*z+1]<<8)+J[4*z+2])-1;if(F>=0){C++;if(!this.visibilitySet.has(F)){this.visibilitySet.add(F);w=true;A++}}}}if(a===-1){a=Date.now()}if(false&&w&&this.debugId>=0){window.allOcclusion=window.allOcclusion||[[],[]];window.allOcclusion[this.debugId].push({time:Date.now()-a,png:this.buildPNG(),inputCount:this.boxes.length,visibleCount:A,pixelCount:C})}if(!k){this.occlusionComposerContext.keepResult=false;this.occlusionComposerContext.releaseRenderTargets(this.renderTargetPool,"main");this.occlusionComposerContext.keepResult=true;this.boxes=[]}};h.prototype.buildPNG=function(){var t=this.viewer;var u=this.composer.getRenderResult("main");var y=u.readPixels(t.renderer.renderer);var o=this.width;var z=this.height;var p=null;var A=document.createElement("canvas");A.width=o;A.height=z;var q=A.getContext("2d");var x=q.createImageData(o,z);var w=x.data;for(var r=0;r<x.height;r++){for(var s=0;s<x.width;s++){var n=s+r*o;var v=s+(z-r-1)*o;w[4*n]=y[4*v]?(256-y[4*v]):0;w[4*n+1]=y[4*v+1]?(256-y[4*v+1]):0;w[4*n+2]=y[4*v+2]?(256-y[4*v+2]):0;w[4*n+3]=y[4*v+3]}}q.putImageData(x,0,0);p=A.toDataURL();window.myDataURL=p;return p};return h});define("DS/3DXMTiles/BBDistanceToVptLODSelector",["DS/3DXMTiles/LODSelector","DS/Visualization/ThreeJS_DS"],function(c,b){var d=new b.Vector3();var a=new b.Matrix4();var e=c.extend({init:function(f){this._parent();this.type="BBDistanceToVpt";this.distance=f},computeLOD:function(h,m){var j=m.viewpoint;if(this.disableDowngrade&&h._lod===1){return 1}var k;var f=h._occurrences;var l,p=0;for(l=0;p<1&&l<f.length;l++){var g=f[l].matrix;if(h._boundingBox){k=h._boundingBox;a.copy(g)}else{var h=h._representationNodes[0];k=h.getBoundingBox();if(h._matrix){a.multiplyMatrices(g,h._matrix)}else{a.copy(occurenceMatrix)}}var n=j.camera;k.center(d);d.applyMatrix4(a);var o=n.position.distanceTo(d);if(o<this.distance){p=1}}return p},createJSON:function(f){f=f||{};f.distance=this.distance;return this._parent(f)}});e.createFromJSON=function(f){var g=f.distance;return new e(parseFloat(g))};return e});define("DS/3DXMTiles/JSONToLODSelector",["DS/3DXMTiles/BSScreenSizeLODSelector","DS/3DXMTiles/BBDistanceToVptLODSelector"],function(a,d){var b={BSScreenSize:a,BBDistanceToVpt:d,};var c={createFromJSON:function(f){var g=f.type;var h=b[g];if(h){var e=h.createFromJSON(f);if(f.disableDowngrade){e.setDisableDowngrade(true)}return e}else{console.log("Unknown LODSelector: '"+g+"'");return null}}};return c});define("DS/3DXMTiles/LDHModel3DHandler",["DS/3DXMTiles/LDHHandler","DS/3DXMTiles/ModelLoaderPool","DS/3DXMTiles/ModelLoaderPoolParams","DS/3DXMTiles/LDHReferenceStatus"],function(b,a,c,e){var d=function(){b.call(this,b.Model3DHandler);this.fileType=null;this.redirectUrlCB=null;this.loadModelOptions=null};d.prototype=Object.create(b.prototype);d.prototype.setFileType=function(f){this.fileType=f};d.prototype.isReady=function(){return a.nbTickets>=20};d.prototype.setLoadModelOptions=function(f){this.loadModelOptions=f};d.prototype.handleReferences=function(h,g){var k=new c();var f;for(f=0;f<h.length;f++){k.addFromNode(h[f],"")}if(this.redirectUrlCB){var j=this;a.beforeLoadParams(k);this.redirectUrlCB(k.urlArray,function(i){k.urlArray=i.concat([]);j.loadParams(h,k,g)})}else{a.beforeLoadParams(k);this.loadParams(h,k,g)}};d.prototype.loadParams=function(g,h,f){a.loadParams(h,this.onLoadedModel.bind(this,g,f),this.onErrorModel.bind(this,g,f),null,this.fileType,this.loadModelOptions)};d.prototype.onLoadedModel=function(j,h){h.manager.startInstRefGraphTransaction();var g,f;for(g=0;g<j.length;g++){f=j[g];h.manager._onRepLoaded(f.referenceId)}h.manager.endInstRefGraphTransaction();h.doneCB(j)};d.prototype.onErrorModel=function(g,f){f.doneCB(null,g)};d.prototype.getModelLoader=function(){return a.modelLoader};d.prototype.getBatchSize=function(){return a.nbTickets};d.prototype.setRedirectUrlCB=function(f){this.redirectUrlCB=f};return d});define("DS/3DXMTiles/LDHNodeManagerQueue",["DS/3DXMTiles/PriorityQueue","DS/3DXMTiles/LDHHandler","DS/3DXMTiles/LDHReferenceStatus","DS/3DXMTiles/LDHOcclusionStatus","DS/3DXMTiles/Debug3DXMTiles"],function(b,a,g,f,e){var d=function(i,h){this.type=i;this.handler=null;this.manager=h;this.newNodes=[];this.nodes=[];this.pendingNodes=[];this.nbNodesToRemoveFromList=0;this.viewpointData=null;this.enableOcclusionTest=true;this.occlusionList=[];this.nodesToLoadQueue=new b();this.nodesToUpdate=[];this.loadedNodesQueue=new b();this.forcedReferences=[];this.unknownReferences=[];this.referenceSizeMap=new Map();this.nbLoading=0;this.nbLoaded=0;this.occlusionNbLoaded=0;this.renderingOccured=false};d.prototype.registerNode=function(i){if(this.handler==null){this.handler=i.handler;if(this.manager.unloadManager.isRestricted){this.handler.setRestricted()}}else{if(this.handler!==i.handler){throw new Error("different handler found")}}if(i.isUnloadable()&&!i.isInLoaded()){this.addToLoadedNodesQueue(i)}var h=false;if(i.isForced()&&!i.isLoaded()){if(!i.isInForced()){h=true;i.setInForced(true);this.forcedReferences.push(i)}}else{if(i.isInForced()){this.removeForcedNode(i);i.setInForced(false)}}if(i.isUnknown()){if(!i.isInUnknown()&&!h){h=true;i.setInUnknown(true);this.unknownReferences.push(i)}}else{if(i.isInUnknown()){this.removeUnknownNode(i);i.setInUnknown(false)}}if(!i.isInList()){i.setInList(true);this.newNodes.push(i)}else{this.forceUpdateNode(i)}};d.prototype.unregisterNode=function(h){if(h.isInUnknown()){this.removeUnknownNode(h);h.setInUnknown(false)}if(h.isInForced()){this.removeForcedNode(h);h.setInForced(false)}};d.prototype.onReferenceUnloaded=function(){this.nodesToLoadQueue.cleanNulls()};d.prototype.removeUnknownNode=function(i){var h=this.unknownReferences.indexOf(i);if(h>=0){this.unknownReferences.splice(h,1)}};d.prototype.removeForcedNode=function(i){var h=this.forcedReferences.indexOf(i);if(h>=0){this.forcedReferences.splice(h,1)}};d.prototype.forceUpdateNode=function(h){if(this.nodesToUpdate.indexOf(h)===-1){this.nodesToUpdate.push(h)}};d.prototype.updateNodes=function(k,l){if(this.handler===null){return}if(l){this.viewpointData=l}else{l=this.viewpointData}var h=k;var j=this.handler.isReady();if(!h){this.updateNodesToLoad(this.newNodes,l);this.updateNodesToLoad(this.nodesToUpdate,l)}var i=this.newNodes.length>0;c(this.nodes,this.newNodes);this.newNodes.length=0;this.nodesToUpdate.length=0;this.removeUselessNodesFromList(this.nodes,k);if(h){this.resetNodesToLoad()}if(h){this.updateNodesToLoad(this.nodes,l)}};d.prototype.updateNodesToLoad=function(j,p){var k,m,o,n,h;var l=this.manager.enableUnload;for(k=0;k<j.length;k++){m=j[k];if(m.needScreenRadiusSizeComputation()){o=m.updateNodeLOD(p);if(o===1){if(m.getUnloadViewpointTag()!==this.manager.viewpointTag){if(m.shouldBeExpanded()&&!m.isInToBeLoaded(true)&&!m.isInHighPriority()){m.setInToBeLoaded(true);if(!this.enableOcclusionTest){this.nodesToLoadQueue.addNode(m)}else{this.occlusionList.push(m)}}m.toUnload=false}}else{if(l){m.toUnload=true}}}}};d.prototype.requiresOcclusion=function(h){if(this.handler&&this.handler.isReady()&&this.enableOcclusionTest&&this.occlusionList.length>0&&(h||this.nodesToLoadQueue.isEmpty())){return true}else{return false}};d.prototype.hasOcclusionList=function(){return this.occlusionList.length>0};d.prototype.computeOcclusion=function(r){e.startProbe("occlusion"+this.handler.type);this.renderingOccured=false;if(!this.nodesToLoadQueue.isEmpty()){var n=this.nodesToLoadQueue.getAllNodes();this.occlusionList=n.concat(this.occlusionList)}this.nodesToLoadQueue.clear();var o,l;var j=false,p=[],m=0;for(o=0;o<this.occlusionList.length;o++){l=this.occlusionList[o];if(l){if(l.isSlave()){this.nodesToLoadQueue.addNode(l);this.occlusionList[o]=null;p.push(-1)}else{l.addToOcclusionChecker(r);j=true;p.push(m);m++}}else{p.push(-1)}}if(j){r.computeVisibility();var h,q=0;for(o=0;o<this.occlusionList.length;o++){l=this.occlusionList[o];h=p[o];if(h>=0&&l){if(r.getVisibility(h)){this.nodesToLoadQueue.addNode(l);this.occlusionList[o]=null;q++}}}this.occlusionNbLoaded=this.nbLoaded+Math.floor(q/2)}e.endProbe("occlusion"+this.handler.type)};d.prototype.resetNodesToLoad=function(){this.nodesToLoadQueue.clear(function(i){i.setInToBeLoaded(false)});var h,j;for(h=0;h<this.occlusionList.length;h++){j=this.occlusionList[h];if(j){j.setInToBeLoaded(false)}}this.occlusionList=[]};d.prototype.loadHighPriorityNodes=function(o){var n=[];var k=this.manager.unloadManager;var s=this.handler,r=[this.forcedReferences,this.unknownReferences],m,h,p,i;var l,j=this.manager;if(s&&s.isReady()&&(r[0].length>0||r[1].length>0)){var q=s.type;for(m=0;m<r.length;m++){p=r[m];for(h=0;h<p.length&&s.isReady();h++){i=p[h];if(!i.loading){l=k.isLoadingAllowed(s.type);if(!l){j.forceUnloadSmallNodes(Infinity,o,s.type);l=k.isLoadingAllowed(s.type)}if(l){n.push(i);if(n.length>=s.getBatchSize()){this.loadBatch(n);n=[]}}}}}}return n};d.prototype.loadNodes=function(i,o){var m=this.loadHighPriorityNodes(o);var j=this.manager;var r=j.enableUnload;var l=!r||j.unloadManager.isLoadingAllowed(this.type);var k=j.unloadManager;var s=this.handler;var n=this;if(s){var q=s.type;var p=s.type===a.InstRefHander?j.maxNbExpectedChildrenPerRequest:0;var h=0;this.nodesToLoadQueue.traverseMaxPlus(function(v,u,t){if(!v.isAlive()){return}if(v.comesFromWrap()){t();return}if(k.wouldDownloadCauseEmergencyUnload(v.referenceId,n)){j.emergencyUnloadAvoided=true;t();u();return}if(s.isReady()){if(!l&&j.unloadSmallNodesEnabled){n.manager.forceUnloadSmallNodes(v.getScore(),o,s.type);l=k.isLoadingAllowed(s.type)}if(l){if(v.hasDifferentViewpointTag(j.viewpointTag)&&(v._occurrences.length>0||v.isSlave())&&!v.isInHighPriority()){m.push(v);if(v.expectedNbChildren>=0){h+=v.expectedNbChildren}if(m.length>=s.getBatchSize()||(p>0&&h>=p)){n.loadBatch(m);m=[];h=0}}v.setInToBeLoaded(false);return}}u();t();return})}if(m.length>0){this.loadBatch(m)}};d.prototype.addNextNodeToBatch=function(h){var i=this.removeMaxNodeFromQueue();if(i){h.push(i);return true}return false};d.prototype.loadBatch=function(j){if(j.length>0){var m=j.concat([]);var n=j[j.length-1];var l={viewpointTag:this.manager.viewpointTag,manager:this.manager.oocManager,doneCB:this.onHandlerDone.bind(this),screenRadius:n._screenRadius};var k,h;for(k=0;k<m.length;k++){h=m[k];if(!h.loading){h.loading=true;h.updateUnloadStatus();h.updateParentsStatus()}}if(this.handler.type===0){this.nbLoading+=j.length}else{this.nbLoading++}this.handler.handleReferences(m,l)}};d.prototype.onHandlerDone=function(p,l){l=l||[];p=p||[];var q=l.length+p.length;this.nbLoaded+=q;if(this.handler.type===0){this.nbLoading-=q}else{this.nbLoading--}var o=this.manager.enableUnload;var j=p.concat(l);var n,k,m=this.manager.unloadManager,h;for(n=0;n<j.length;n++){k=j[n];if(k.loading){k.loading=false;k.updateUnloadStatus();k.updateParentsStatus()}if(!k._boundingSphere&&!k._boundingBox&&this.handler.type===a.Model3DHandler){k.updateBoundingSphereFromNode();h=true}if(k.isForced()||h){this.manager.registerTilesNode(k)}}for(n=0;n<l.length;n++){if(this.handler.type===a.Model3DHandler){l[n].setStatus(g.error);this.onNodeToRemoveFromList()}else{this.forceUpdateNode(l[n])}}this.manager._updateNodes();if(this.handler.type===a.Model3DHandler){if(this.manager.isForceSceneMinEnabled()){this.manager.viewer.render({budgeted:true})}else{this.manager.viewer.render({budgeted:true,updateInfinitePlane:true})}}};d.prototype.onNodeToRemoveFromList=function(){this.nbNodesToRemoveFromList++};d.prototype.removeMaxNodeFromQueue=function(){var h=this.nodesToLoadQueue.getMaxNode(true);h.setInToBeLoaded(false);return h};d.prototype.removeUselessNodesFromList=function(h,m){if(this.nbNodesToRemoveFromList>200||m){var j,l;for(j=0;j<h.length;j++){l=h[j];if(!l.isAlive()){h[j]=null}else{if(l.isFrozen()&&!l.shouldBeExpanded()){l.setInList(false);h[j]=null}}}var k=0;for(j=0;j<h.length;j++){l=h[j];if(l!==null){h[k]=l;k++}}h.length=k;this.nbNodesToRemoveFromList=0}};d.prototype.isLoading=function(){return this.nbLoading>0};d.prototype.hasMoreToLoad=function(){return !this.nodesToLoadQueue.isEmpty()};d.prototype.forceClean=function(){this.removeUselessNodesFromList(this.nodes,true);this.nodesToLoadQueue.traverseMaxPlus(function(j,i,h){if(j.isAlive()){h()}});this.nodesToLoadQueue.cleanNulls(true);this.loadedNodesQueue.traverseMinPlus(function(j,i,h){if(j.isAlive()){h()}});this.loadedNodesQueue.cleanNulls(true)};d.prototype.fillDebugArray=function(n){this.removeUselessNodesFromList(this.nodes,true);var m,h,p,l;for(m=0;m<this.nodes.length;m++){h=this.nodes[m];p={id:h.referenceId,screenRadius:h._screenRadius,status:h._status,unloadStatus:h._unloadStatus};if(h.expectedNbChildren!==0||h.children.length>0){p.expectedNbChildren=h.expectedNbChildren;p.nbChildren=h.children.length;if(h.children.length>0){var k=[];var o=[];for(l=0;l<h.children.length;l++){k.push(h.children[l].reference.referenceId);o.push(h.children[l].instanceId)}p.children=k;p.instances=o}}if(h.toUnload){p.toUnload=true}if(h.loading){p.loading=true}if(h.unloadLockCounter>0){p.unloadLockCounter=h.unloadLockCounter}n.push(p)}};d.prototype.memorizeReferenceSize=function(i,h){if(!this.referenceSizeMap.has(i)||this.referenceSizeMap.get(i)<h){this.referenceSizeMap.set(i,h)}};d.prototype.getMemorizedReferenceSize=function(h){if(this.referenceSizeMap.has(h)){return this.referenceSizeMap.get(h)}return -1};d.prototype.addToLoadedNodesQueue=function(h){if(!h.isInLoaded()){h.setInLoaded(true);this.loadedNodesQueue.addNode(h)}};d.prototype.unloadSmallNodes=function(h,o,k){var j=this.manager.unloadManager,m=false;var i=this.loadedNodesQueue;var l=this.manager,n=this.handler.type;i.traverseMinPlus(function(s,r,q){var p=false;if((!j.isLoadingAllowed(n)&&s.getScore()<h)){if(!s.isUnloadLocked()){if(!l.unloadNode(s,o)){p=true}else{l.hasUnloadedSmallNodes=true}}else{p=true}}else{r();p=true}if(p){q()}else{s.setInLoaded(false)}})};d.prototype.updateLoadedNodes=function(l,m){var i=this.manager.unloadManager;if(this.handler&&i.isUnloadNeeded(this.handler.type)){if(l){this.loadedNodesQueue.resetOrder(function(o){var n=o.isAlive()&&o.isUnloadable();if(!n){o.setInLoaded(false)}return n})}var k=false;var j=this.manager;this.loadedNodesQueue.traverseMinPlus(function h(r,p,o){var n=false,q=r.handler;if(l||(r.isAlive()&&r.isUnloadable())){if(r.isLocked()){n=true}else{if(r.isAlive()&&!r.isUnloaded()){if(i.isUnloadNeeded(q.type)&&r.toUnload){if(!r.isUnloadLocked()){k=true;if(!j.unloadNode(r,m)){n=true}}else{n=true}}else{if(!r.toUnload){p()}n=true}}}}if(n){o()}else{r.setInLoaded(false)}});if(k){this.onReferenceUnloaded()}}if(l){this.loadedNodesQueue.cleanNulls()}};d.prototype.doEmergencyUnload=function(l){var i=this.manager,k=false,j=this.type;this.loadedNodesQueue.traverseMinPlus(function h(q,o,n){if(i.unloadManager.isEmergencyUnloadRequired(undefined,j)){var m=false,p=q.handler;if(q.isLocked()){m=true}else{if(q.isAlive()&&!q.isUnloaded()){if(!q.isUnloadLocked()){k=true;if(!i.unloadNode(q,l)){m=true}}else{m=true}}}if(m){n()}else{q.setInLoaded(false)}}else{n();o()}});if(k){this.onReferenceUnloaded()}};function c(k,j){var h;for(h=0;h<j.length;h++){k.push(j[h])}}return d});define("DS/3DXMTiles/LDHHandlerOOCAdapter",["DS/3DXMTiles/LDHHandler","DS/3DXMTiles/OOCPath"],function(b,a){var c=function(d){b.call(this,d.type);this.oocHandler=d};c.prototype=Object.create(b.prototype);c.prototype.handleReferences=function(h,g){var f,k,d,e=[];for(f=0;f<h.length;f++){var d=h[f];k=a.buildFromReference(d,true);if(k){e.push(k)}}var j={viewpointTag:g.viewpointTag,doneCB:this.adapterDoneCB.bind(this,g),screenRadius:g.screenRadius};this.oocHandler.handlePathes(e,j)};c.prototype.isReady=function(){return this.oocHandler.isReady()};c.prototype.getBatchSize=function(){return this.oocHandler.getBatchSize()};c.prototype.adapterDoneCB=function(g,e,k){var d=[],j=[];var f,h;for(f=0;f<e.length;f++){if(typeof(e[f])==="string"){h=this.oocHandler.manager._getLDHReference(e[f],true)}else{h=e[f]._ldhReference}if(h){d.push(h)}}for(f=0;f<k.length;f++){if(typeof(k[f])==="string"){h=this.oocHandler.manager._getLDHReference(k[f])}else{h=k[f]._ldhReference}j.push(h)}g.doneCB(d,j)};return c});define("DS/3DXMTiles/LDHModel3DHandler2",["DS/3DXMTiles/LDHHandler","DS/3DXMTiles/ModelLoaderPool","DS/3DXMTiles/ModelLoaderPoolParams","DS/3DXMTiles/LDHReferenceStatus"],function(b,a,c,e){var f=function(i,h){this.references=i;this.nbRedirected=0;this.context=h;this.okReferences=[];this.koReferences=[]};f.prototype.addOkReference=function(i){var h=i.getReference();this.okReferences.push(h)};f.prototype.addKoReference=function(i){var h=i.getReference();this.koReferences.push(h)};f.prototype.isComplete=function(){return this.okReferences.length+this.koReferences.length>=this.references.length};var g=function(i,h,j){this.batch=i;this.index=h;this.newURL=j};g.prototype.getUrl=function(){return this.batch.references[this.index].url};g.prototype.getReference=function(){return this.batch.references[this.index]};var d=function(h){b.call(this,b.Model3DHandler);this.fileType=null;this.redirectUrlCB=null;this.loadModelOptions=null;this.batches=[];this.toLoad=[];this.debug=h.debug?true:false;this.minBatchSize=40;this.maxTickets=h.batchSize||100;this.maxRedirectTickets=h.redirectBatchSize||40;this.tickets=this.maxTickets;this.redirectTickets=this.maxRedirectTickets};d.prototype=Object.create(b.prototype);d.prototype.setFileType=function(h){this.fileType=h};d.prototype.setRestricted=function(){this.minBatchSize=2;this.maxTickets=2;this.maxRedirectTickets=2;this.tickets=this.maxTickets;this.redirectTickets=this.maxRedirectTickets};d.prototype.isReady=function(){return this.tickets>=this.minBatchSize};d.prototype.setLoadModelOptions=function(h){this.loadModelOptions=h};d.prototype.handleReferences=function(m,l){var j=new f(m,l),k,h;this.batches.push(j);this.incTickets(-m.length);if(!this.redirectUrlCB){for(k=0;k<j.references.length;k++){h=j.references[k];this.toLoad.push(new g(j,k,h.url))}this.loadModels()}else{this.redirectUrls()}};d.prototype.redirectUrls=function(){if(this.redirectTickets>0){var m,l,o,p=[],h=[],k;for(m=0;m<this.batches.length;m++){l=this.batches[m];for(k=l.nbRedirected;this.redirectTickets>0&&k<l.references.length;k++){l.nbRedirected++;o=new g(l,k,null);if(o.getUrl()){p.push(o);h.push(o.getUrl());this.incRedirectTickets(-1)}else{this.toLoad.push(o)}}}if(p.length>0){var n=this;this.incRedirectTickets(-this.redirectTickets);this.redirectUrlCB(h,function(j){n.incRedirectTickets(-n.redirectTickets+n.maxRedirectTickets);var q;for(q=0;q<j.length;q++){p[q].newURL=j[q];n.toLoad.push(p[q])}n.redirectUrls();n.loadModels()})}}};d.prototype.loadModels=function(){var h;if(this.debug){a.setDebug(true)}while(a.nbTickets>0&&this.toLoad.length>0){h=this.toLoad.shift();if(h.newURL){a.nbTickets--;a._loadModel(h.newURL,h.getReference(),this.onModelLoaded.bind(this,h),this.onModelError.bind(this,h),null,this.fileType,this.loadModelOptions)}else{setTimeout(this.onModelError.bind(this,h),1)}}};d.prototype.onModelLoaded=function(m){this.incTickets(+1);var j=m.batch;var l=j.context;var k,h;h=m.getReference();l.manager.startInstRefGraphTransaction();l.manager._onRepLoaded(h.referenceId);l.manager.endInstRefGraphTransaction();l.doneCB([h],[]);if(j.isComplete()){this.onBatchComplete(j)}this.loadModels()};d.prototype.onModelError=function(m){this.incTickets(+1);var j=m.batch;var l=j.context;var k,h;h=m.getReference();l.manager.startInstRefGraphTransaction();l.manager._onRepLoaded(h.referenceId);l.manager.endInstRefGraphTransaction();l.doneCB([],[h]);if(j.isComplete()){this.onBatchComplete(j)}this.loadModels()};d.prototype.onBatchComplete=function(k){var j=this.batches.indexOf(k);this.batches.splice(j,1);var n=k.context;var m,h,l=k.okReferences;k.references=[];k.okReferences=[];k.koReferences=[]};d.prototype.loadParams=function(i,j,h){a.loadParams(j,this.onLoadedModel.bind(this,i,h),this.onErrorModel.bind(this,i,h),null,this.fileType,this.loadModelOptions)};d.prototype.onLoadedModel=function(l,k){k.manager.startInstRefGraphTransaction();var j,h;for(j=0;j<l.length;j++){h=l[j];k.manager._onRepLoaded(h.referenceId)}k.manager.endInstRefGraphTransaction();k.doneCB(l)};d.prototype.onErrorModel=function(i,h){h.doneCB(null,i)};d.prototype.getModelLoader=function(){return a.modelLoader};d.prototype.getBatchSize=function(){return this.tickets};d.prototype.setRedirectUrlCB=function(h){this.redirectUrlCB=h};d.prototype.incTickets=function(h){this.tickets+=h};d.prototype.incRedirectTickets=function(h){this.redirectTickets+=h};return d});define("DS/3DXMTiles/OOCHandler",["DS/3DXMTiles/LDHHandlerOOCAdapter"],function(a){var c=0;var b=function(e,d){this.type=e;this.id=c++;this.ldhHandler=d||new a(this)};b.prototype.handlePathes=function(e,d){};b.prototype.getBatchSize=function(){return 1};b.Model3DHandler=0;b.InstRefHander=1;return b});define("DS/3DXMTiles/OOCModel3DHandler",["DS/3DXMTiles/OOCHandler","DS/3DXMTiles/LDHModel3DHandler","DS/3DXMTiles/LDHModel3DHandler2"],function(d,c,b){var a=function(e){e=e||{};d.call(this,d.Model3DHandler,e.v1?new c():new b(e))};a.prototype=Object.create(d.prototype);a.prototype.setFileType=function(e){this.ldhHandler.setFileType(e)};a.prototype.setLoadModelOptions=function(e){this.ldhHandler.setLoadModelOptions(e)};a.prototype.getModelLoader=function(){return this.ldhHandler.getModelLoader()};a.prototype.setRedirectUrlCB=function(e){this.ldhHandler.setRedirectUrlCB(e)};return a});define("DS/3DXMTiles/LDHUserQueue",["DS/3DXMTiles/PriorityQueue"],function(a){var b=function(d,c){this.queue=new a();this.handler=d;this.manager=c};b.prototype.addNode=function(c){this.queue.addNode(c)};b.prototype.computeOrder=function(e){this.queue.resetOrder();var c,d;for(c=0;c<this.queue.nodeListLength;c++){d=this.queue.nodeList[c];if(d&&d.isAlive()&&(!d.isInList()||!d.needScreenRadiusSizeComputation())){d.updateNodeLOD(e)}}};b.prototype.handleViewpointChange=function(c){this.computeOrder(c)};b.prototype.traverseQueue=function(){var e=this.handler;var c=[];var d={doneCB:this.onHandlerDone.bind(this)};this.queue.traverseMax(function(f){if(!f.isAlive()){return true}if(f._screenRadius>=0&&e.isReady()){c.push(f.referenceId);if(c.length>=e.getBatchSize()){e.handleReferences(c,d);c=[]}return true}return false});if(c.length>0){e.handleReferences(c,d,this.queue.isEmpty());c=[]}if(this.queue.isEmpty()){this.manager.removeUserQueue(this.handler)}};b.prototype.onHandlerDone=function(){this.manager.requestUpdate(false,false)};return b});define("DS/3DXMTiles/LDHCandidateListRenderer",["DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Selection/CSOManager","DS/Visualization/PathElement","DS/Mesh/MeshUtils","DS/3DXMTiles/LDHOccurrence","DS/3DXMTiles/PriorityQueue"],function(s,d,i,o,q,p,e,l,u){var r=function(v){this.references=[];this.node=null;this.root=v;this.occurrences=[];this.preserveReferences=null;this.material=null;this.previousDimension=-1;this.lastClusters=null;this.priorityQueue=null};r.prototype.createMesh=function(w){if(w.dimension===2){return d.createCuboidNode({cornerPoint:new s.Vector3(0,0,0),firstAxis:new s.Vector3(1,0,0),secondAxis:new s.Vector3(0,1,0),thirdAxis:new s.Vector3(0,0,1)})}if(w.dimension===1){var y=[new s.Vector3(0,0,0),new s.Vector3(1,0,0),new s.Vector3(0,0,0),new s.Vector3(0,1,0),new s.Vector3(0,0,0),new s.Vector3(0,0,1),new s.Vector3(1,0,0),new s.Vector3(1,1,0),new s.Vector3(1,0,0),new s.Vector3(1,0,1),new s.Vector3(0,1,0),new s.Vector3(0,1,1),new s.Vector3(0,1,0),new s.Vector3(1,1,0),new s.Vector3(0,0,1),new s.Vector3(0,1,1),new s.Vector3(0,0,1),new s.Vector3(1,0,1),new s.Vector3(1,1,1),new s.Vector3(0,1,1),new s.Vector3(1,1,1),new s.Vector3(1,0,1),new s.Vector3(1,1,1),new s.Vector3(1,1,0)];var x,v=[];for(x=0;x<y.length;x++){v.push(x)}return d.createLineNode({points:y,drawMode:e.ConnectivityTypeEnum.LINES,idx:v})}};r.prototype.clearRepresentation=function(){if(this.node){this.root.removeChild(this.node);this.node=null}};r.prototype.dispose=function(){this.clearRepresentation();this.material&&this.material.dispose()};var t=true;r.prototype.updateRepresentation=function(w,y){if(this.previousDimension!==w.dimension){if(this.material){this.material.dispose();this.material=null}}if(!this.material){this.material=this.buildMaterial(w)}this.clearRepresentation();var v=this.createMesh(w);this.occurrences=[];v.setMaterial(this.material);var x=null;if(w.clusters===-1){x=this.createInstancingData(w)}else{x=this.createInstancingData_cluster(w,y)}this.setUpMeshInstancingParameters(v,x.nbInstances,x.matrices,x.colors);v.forceBoundingElements(true,{box:x.boundingBox});this.node=v;this.root.addChild(v)};r.prototype.createInstancingData=function(B){B=B||{};var z=new s.Box3();var D=this.computeNbInstances();var F=new Float32Array(D*16),v=new Float32Array(D*3);var C,A,x,y=0,w;var G=this.references;var E=B.count;if(E){if(!this.priorityQueue){this.priorityQueue=new u()}this.priorityQueue.clear();for(C=0;C<this.references.length;C++){this.priorityQueue.addNode(this.references[C])}G=[];this.priorityQueue.traverseMax(function(J,I,H){G.push(J);if(G.length>=E){return false}else{return true}})}for(C=0;C<G.length;C++){x=G[C];if(x.isAlive()){w=x.getOccurrences();for(A=0;w!==null&&A<w.length;A++){if(this.fillInstancingData(x,w[A],y,F,v,z,B)){this.occurrences.push(w[A]);y++}}}}return{boundingBox:z,nbInstances:D,matrices:F,colors:v}};r.prototype.computeNbInstances=function(){var x,v;var w=0,y;for(x=0;x<this.references.length;x++){v=this.references[x];y=v.getOccurrences();if(v.isAlive()&&y!==null){w+=y.length}}return w};r.prototype.buildMaterial=function(v){var z=v.dimension===1?new s.LineBasicMaterial({force:true,opacity:v.opacity,depthWrite:false}):new s.MeshBasicMaterial({force:true,opacity:v.opacity,depthWrite:false});z.activatePDSFX();var x={vColor:{type:"v3"}};z.setPDSFXVaryings(x);var w={ComputeObjectPosition:["vec3 ComputeObjectPosition() {","vec4 localPosition = vec4(vGetAttribPosition(), 1.0);","vec4 newPosition = instanceMatrix*localPosition;","return newPosition.xyz;","}"].join("\n"),ComputeVaryingValues:["void ComputeVaryingValues() {","vColor = instanceColor;","}"].join("\n")};var y={ComputeAlbedo:["vec3 ComputeAlbedo() {","return vColor;","}"].join("\n"),ComputeSpecularReflectance:["vec3 ComputeSpecularReflectance() {","return vec3(1.0,1.0,1.0);","}"].join("\n")};z.setPDSFXOverridableFunctions(w,y);return z};r.prototype.getOccurrencesInXSO=function(w){var z=w.get();var x,y,A=null,B;for(x=0;x<z.length;x++){y=z[x].pathElement;if(y.instanceId!==undefined&&y.getLastElement()===this.node){if(!A){A=[]}var B=this.getOccurrenceFromInstanceId(y.instanceId);if(B){var v=B.reference;A.push(B);if(!this.preserveReferences){this.preserveReferences=[]}if(this.preserveReferences.indexOf(v)===-1){this.preserveReferences.push(v)}}}}return A};r.prototype.getOccurrenceFromInstanceId=function(w){var v=w/5-1;return this.occurrences[v]};r.prototype.getInstanceId=function(w){var v=this.occurrences.indexOf(w);return 5*(v+1)};r.prototype.createSelectionRestoringData=function(){this.preserveReferences=null;return[{xso:i,occurrences:this.getOccurrencesInXSO(i)},{xso:o,occurrences:this.getOccurrencesInXSO(o)},{xso:q,occurrences:this.getOccurrencesInXSO(q)}]};r.prototype.restoreSelection=function(x){var w;for(w=0;w<x.length;w++){var v=x[w].xso;var y=x[w].occurrences;if(y){this.addOccurrencesToXSO(v,y)}}};r.prototype.addOccurrencesToXSO=function(v,z){var w,A,y,x;for(w=0;w<z.length;w++){x=null;A=z[w];y=this.getInstanceId(A);if(y>0){x=new p([this.root,this.node]);x.instanceId=y}else{if(A instanceof l){if(A.reference.node){x=A.buildPathElement()}}else{x=new p();x.setFromOccurrence(A)}}if(x){v.add({pathElement:x})}}};var n=new s.Matrix4();var m=new s.Matrix4();var j=new s.Matrix4();var c=new s.Matrix4();var a=new s.Vector3();r.prototype.fillInstancingData=function(y,J,E,I,x,A,B){var K=y.getBoundingBox();if(K){K=K.clone()}else{return false}var H=J.matrix;n.copy(H);a.set(K.max.x-K.min.x,K.max.y-K.min.y,K.max.z-K.min.z);j.identity();c.identity();j.translate(K.min);c.scale(a);n.multiplyMatrices(j,c);m.multiplyMatrices(H,n);var F=m;var z=E*16,w=F.elements;var C;for(C=0;C<16;C++){I[z+C]=w[C]}var v=B.color.r,D=B.color.g,G=B.color.b;z=E*3;x[z]=v;x[z+1]=D;x[z+2]=G;K.applyMatrix4(H);A.expandByPoint(K.min);A.expandByPoint(K.max);return true};r.prototype.getReferenceFromOccurrence=function(A){var y,x,v,w=0,z;for(y=0;y<this.references.length;y++){v=this.references[y];if(v.isAlive()){z=v.getOccurrences();for(x=0;z!==null&&x<z.length;x++){if(this.occurrences[w]===A){return v.referenceId}w++}}}};r.prototype.setUpMeshInstancingParameters=function(A,w,x,v){var z={data:x,type:"m4",attribName:"instanceMatrix",isFlattened:true};var y={data:v,type:"v3",attribName:"instanceColor",isFlattened:true};A.setInstancingParameters(w,[z,y])};function k(w,v){this.center=w.center();this.bbox=w;this.bbox.applyMatrix4(v);this.matrix=v;this.center.applyMatrix4(v);this.clusterIndex=-1}k.prototype.selectCluster=function(z){var w=Infinity,y,x=-1,v,A;for(y=0;y<z.length;y++){v=z[y];A=v.center.distanceTo(this.center);if(A<w){x=y;w=A}}return x};function f(){this.center=new s.Vector3();this.nodes=[]}window.myRnd=[];var b=undefined,h=0;function g(){if(b===undefined){if(window.WUXLDH_RndTable){b=window.WUXLDH_RndTable}else{b=null}}var v;if(b){v=b[h];h=(h+1)%b.length;return v}else{v=Math.random();window.myRnd.push(v);return v}}f.prototype.randomize=function(v){this.center.set(v.min.x+g()*(v.max.x-v.min.x),v.min.y+g()*(v.max.y-v.min.y),v.min.z+g()*(v.max.z-v.min.z))};f.prototype.resetNodes=function(){this.nodes=[]};f.prototype.updateCenter=function(){var x,w=this.nodes;var v=this.center;if(w.length>0){v.set(0,0,0);for(x=0;x<w.length;x++){v.addVectors(v,w[x].center)}v.multiplyScalar(1/w.length)}};f.prototype.buildBoundingBox=function(){var v=new s.Box3();var x,w,y;for(x=0;x<this.nodes.length;x++){w=this.nodes[x];v.union(w.bbox)}return v};r.prototype.createClusterData=function(v,A,z){var y=v.getBoundingBox();var x=A.matrix;var w=new k(y.clone(),x);if(w&&!w.bbox.containsPoint(z)){return w}return null};r.prototype.fillInstancingData_cluster=function(H,K,D,G,x,A,J,y){m.identity();var I=H.buildBoundingBox();if(I.containsPoint(y)){return 0}J.union(I);I.size(K);m.scale(K);m.setPosition(I.min);var E=m;var z=D*16,w=E.elements;var B;for(B=0;B<16;B++){G[z+B]=w[B]}var v=A.color.r,C=A.color.g,F=A.color.b;z=D*3;x[z]=v;x[z+1]=C;x[z+2]=F;return 1};r.prototype.createInstancingData_cluster=function(y,w){var B=this.createClusters(y,w);var E=new s.Box3();var A=B.length,x=0;var D=new Float32Array(A*16),v=new Float32Array(A*3);var z,C;var F=new s.Vector3(E.max.x-E.min.x,E.max.y-E.min.y,E.max.z-E.min.z);F.multiplyScalar(1/50);F.set(100,100,100);for(z=0;z<B.length;z++){C=B[z];x+=this.fillInstancingData_cluster(C,F,x,D,v,y,E,w)}A=x;return{boundingBox:E,nbInstances:A,matrices:D,colors:v}};r.prototype.createClusters=function(E,B){var w=[];var F,D,C,z,A;for(F=0;F<this.references.length;F++){C=this.references[F];if(C.isAlive()){z=C.isSlave()?C.node._occurrences:C._occurrences;for(D=0;D<z.length;D++){A=this.createClusterData(C,z[D],B);if(A){w.push(A)}}}}var v=new s.Box3();for(F=0;F<w.length;F++){v.expandByPoint(w[F].center)}var y=E.clusters;var I=this.lastClusters;var J;if(!I||(I.length===0&&w.length>0)){I=[];for(F=0;F<y;F++){J=new f();J.randomize(v);I.push(J)}}else{for(F=0;F<I.length;F++){J=I[F];J.resetNodes()}}var G,A;for(F=0;F<w.length;F++){A=w[F];G=A.selectCluster(I);I[G].nodes.push(A);A.clusterIndex=G}var H=this.lastClusters?true:false;while(!H){H=true;for(F=0;F<I.length;F++){J=I[F];J.updateCenter();J.nodes.length=0}for(F=0;F<w.length;F++){A=w[F];G=A.selectCluster(I);I[G].nodes.push(A);if(A.clusterIndex!==G){H=false;A.clusterIndex=G}}}var x=[];for(F=0;F<I.length;F++){if(I[F].nodes.length>0){x.push(I[F])}}this.lastClusters=x;return x};r.prototype.clearClusters=function(){this.lastClusters=null};return r});define("DS/3DXMTiles/LDHCandidateQueueRenderer",["DS/Visualization/ThreeJS_DS","DS/Visualization/SceneGraphFactory","DS/Visualization/Node3D","DS/Visualization/PathElement","DS/3DXMTiles/LDHCandidateListRenderer","DS/3DXMTiles/LDHOccurrence","DS/Mesh/MeshUtils"],function(f,e,d,b,a,i,c){var g=function(k,j){this.manager=k;this.viewer=k.viewer;this.root=j||new d("CandidateQueueRenderer");this.root.setRenderPasses(["main"]);this.viewer.addNode(this.root);this.displayIntermediateReferences=false;this.preserveReferences=null;this.preserveSelection=false;this.pickable=c.PICKABLE;this.attributes=[new h({dimension:2,color:new f.Color("red"),opacity:0.1}),new h({dimension:1,color:new f.Color("black"),opacity:1})];this.candidateListRenderers=[new a(this.root),new a(this.root)]};g.prototype.setPickable=function(j){this.root.setPickable(j)};g.prototype.setParams=function(j){j=j||{};this.displayIntermediateReferences=j.displayIntermediateReferences?true:false;if(j.repRefAttributes){this.attributes[0].setParams(j.repRefAttributes)}if(j.refAttributes){this.attributes[1].setParams(j.refAttributes)}};g.prototype.dispose=function(){var j;for(j=0;j<this.candidateListRenderers.length;j++){this.candidateListRenderers[j].dispose()}this.root=null};g.prototype.addNodeList=function(k,m){var l,j;for(l=0;l<k.length;l++){j=k[l];if(this.shouldDisplayReference(j)){m.references.push(j)}}};g.prototype.shouldDisplayReference=function(j){if((!j.node||(j.isSlave()&&j.node.children.length===0))&&j.getLODValue()>0){return true}if(this.preserveReferences&&this.preserveReferences.indexOf(j)>=0){return true}return false};g.prototype.getNodesFromQueue=function(j,l){var k=[];var m,n;for(m=0;m<j.nodes.length;m++){n=j.nodes[m];if(l){if(n.children.length===0&&n.expectedNbChildren>0){k.push(n)}}else{if(!n.isLoaded()){k.push(n)}}}return k};g.prototype.updateRepresentation=function(q){var n=this.manager;var m;var p=[],o,l;for(m=0;m<this.candidateListRenderers.length;m++){l=this.attributes[m];if(l.clusters===-1){o=this.candidateListRenderers[m];if(this.preserveSelection){p.push(o.createSelectionRestoringData())}else{p.push(null)}o.references=[]}}for(m=0;m<n.queues.length;m++){l=this.attributes[m];o=this.candidateListRenderers[m];if(this.displayIntermediateReferences||m===0){var j=n.queues[m];var k=this.getNodesFromQueue(j,m===1);this.addNodeList(k,o);o.updateRepresentation(l,q)}if(l.clusters===-1&&p[m]){o.restoreSelection(p[m])}}};g.prototype.getPathFromPathElement=function(m){var k,l;for(k=0;k<this.candidateListRenderers.length;k++){l=this.candidateListRenderers[k];if(m.externalPath.indexOf(l.node)>=0){var o=l.getOccurrenceFromInstanceId(m.instanceId);var n=null,j;if(o){if(o instanceof i){n=[];while(o){n.unshift(o.reference.referenceId);if(o.parent){n.unshift(o.instanceId)}o=o.parent}}}return n}}return null};g.prototype.getReferenceFromPathElement=function(m){var k,l;for(k=0;k<this.candidateListRenderers.length;k++){l=this.candidateListRenderers[k];if(m.externalPath.indexOf(l.node)>=0){var o=l.getOccurrenceFromInstanceId(m.instanceId);var n=null,j;if(o){if(o instanceof i){return o.reference.referenceId}else{return l.getReferenceFromOccurrence(o)}}}}return null};g.prototype.clearClusters=function(){var j,k;for(j=0;j<this.candidateListRenderers.length;j++){k=this.candidateListRenderers[j];k.clearClusters()}};var h=function(j){this.color=j.color.clone();this.opacity=j.opacity;this.dimension=j.dimension;this.clusters=j.clusters||-1;this.count=j.count||0};h.prototype.setParams=function(j){if(j.color){this.color=j.color.clone()}if(j.opacity!==undefined){this.opacity=j.opacity}if(j.dimension!==undefined){this.dimension=j.dimension}if(j.clusters!==undefined){this.clusters=j.clusters||-1}if(j.count!==undefined){this.count=j.count||0}};return g});define("DS/3DXMTiles/LDHNodeManager",["DS/3DXMTiles/LDHNodeManagerQueue","DS/3DXMTiles/LDHHandler","DS/3DXMTiles/3DXMTilesUtils","DS/3DXMTiles/LDHReferenceStatus","DS/3DXMTiles/UnloadManager","DS/3DXMTiles/PriorityQueue","DS/3DXMTiles/LDHReferenceUnloadStatus","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/3DXMTiles/LDHUserQueue","DS/3DXMTiles/LDHCandidateQueueRenderer","DS/3DXMTiles/Debug3DXMTiles","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/3DXMTiles/MassiveOcclusionChecker"],function(c,f,p,k,h,d,q,i,g,n,a,m,j,l){var o=function(s){this.enableUnload=(window.OOCEnableUnload!==undefined)?window.OOCEnableUnload:true;this.viewer=s.viewer;this.bsNode=new j("ooc_bsNode");this.viewer.addNode(this.bsNode);var r=this;this.viewer.currentViewpoint.onMove(function(){r.requestUpdate(true,false);r.startLoadTime=(new Date()).getTime()});this.queues=[new c(f.Model3DHandler,this),new c(f.InstRefHander,this)];this.requestUpdateToken=null;this.updateOptions={viewpointChanged:false,modelLoaded:false};this.viewpointHasChanged=true;this.targetNode=null;this.requestUpdate(true,true);this.unloadManager=new h(s.config);this.previousIsLoading=false;this.onStartLoadingCB=null;this.onEndLoadingCB=null;this.suspendedReferenceActions=[];this.debugThrottle=0;this.pauseLoading=false;this.oocManager=s.oocManager;this.viewpointTag=0;this.debugMissingExpectedNbChildren=window.debugMissingExpectedNbChildren?true:false;this.unloadSmallNodesEnabled=true;this.unloadLeafReferenceCB=null;this.onLeafReferenceLoadedCB=null;this.pauseLoadingDuringViewpointMove=true;this._dbg_freezeViewpointTag=false;this.overrideSetManager=null;this.overrideSetMap={};this.lastQueueRendererUpdateTime=0;this.queueRenderer=null;this.maxNbExpectedChildrenPerRequest=0;this.userQueues=[];this.rootAdded=false;this.lastDeltaTime=-1;this.startLoadTime=null;this.wrapStatusToUpdate=null;this.hasUnloadedSmallNodes=false;this.emergencyUnloadOccured=false;this.emergencyUnloadAvoided=false;this.boundingSphere=new m.Sphere();this.priorityComputer=null;this.viewer.onPreRender(this.onPreRender.bind(this));this.lastOcclusionTime=0;this.occlusionTestEnabled=s.enableOcclusionTest!==undefined?s.enableOcclusionTest:true;if(!this.occlusionTestEnabled){this.queues[0].enableOcclusionTest=false;this.queues[1].enableOcclusionTest=false}window.oocLDHNodeManager=this};var b=function(r,s){this.references=r;this.callback=s};o.prototype.setUnloadSmallNodesEnabled=function(r){this.unloadSmallNodesEnabled=r};o.prototype.setMaxNbExpectedChildrenPerRequest=function(r){this.maxNbExpectedChildrenPerRequest=r};o.prototype.onPreRender=function(){this.queues[0].renderingOccured=true;this.queues[1].renderingOccured=true};o.prototype.addWrapStatusToUpdate=function(r){if(this.wrapStatusToUpdate===null){this.wrapStatusToUpdate=new Set()}this.wrapStatusToUpdate.add(r)};o.prototype.updateAllWrapStatuses=function(){if(this.wrapStatusToUpdate!==null){this.wrapStatusToUpdate.forEach(function(r){r.updateWrapStatusFromChildren(false)});this.wrapStatusToUpdate=null}};o.prototype.tryBuildSceneGraphHierarchy=function(){var t=this.oocManager.getRootOccurrences();var s=[];t.forEach(function(w,v,x){var y=w.occurrence;var u=y.reference;u.tryBuildSceneGraphHierarchy(s)});var r;for(r=0;r<s.length;r++){s[r].updateOverride()}};o.prototype.setPauseLoadingDuringViewpointMove=function(r){this.pauseLoadingDuringViewpointMove=r};o.prototype.tryToPerformReferenceAction=function(s,v){var r,t=true;for(r=0;r<s.length;r++){if(s[r].loading){t=false}}if(t){var u=this;v.call(undefined,s,function(){u.requestUpdate(true,true)});return true}else{return false}};o.prototype.executeReferenceAction=function(r,s){if(!this.tryToPerformReferenceAction(r,s)){this.suspendedReferenceActions.push(new b(r,s))}};o.prototype.setTargetNode=function(r){this.targetNode=r};o.prototype.registerTilesNode=function(t){if(t._status!==k.complete&&t._status!==k.incomplete){return}var s=t.handler;var r=this.queues[s.type];r.registerNode(t);this.requestUpdate(false,false)};o.prototype.unregisterNode=function(t){if(!t.isAlive()){var s=t.handler;var r=this.queues[s.type];r.unregisterNode(t)}};o.prototype.forceUpdateNode=function(t){var s=t.handler;var r=this.queues[s.type];r.forceUpdateNode(t);this.requestUpdate(false,false)};o.prototype.requestUpdate=function(r,s){this.updateOptions.viewpointChanged=this.updateOptions.viewpointChanged||r;this.updateOptions.modelLoaded=this.updateOptions.modelLoaded||s;if(this.requestUpdateToken===null){this.requestUpdateToken=setTimeout(this._updateNodes.bind(this),0)}};o.prototype._updateNodes=function(){a.startProbe("updateNodes");var v=this.createViewpointData(this.viewer.currentViewpoint);var s,r;var t;if(this.suspendedReferenceActions.length>0){for(s=0;s<this.suspendedReferenceActions.length;s++){t=this.suspendedReferenceActions[s];if(this.tryToPerformReferenceAction(t.references,t.callback)){this.suspendedReferenceActions[s]=null}}this.suspendedReferenceActions=this.suspendedReferenceActions.filter(function(w){return w!==null})}this.updateAllWrapStatuses();if(this.requestUpdateToken!==null){clearTimeout(this.requestUpdateToken);this.requestUpdateToken=null}var u=this.viewer.currentViewpoint.isMoving();if(this.pauseLoadingDuringViewpointMove&&u){this.emergencyUnloadNodes(v);this.requestUpdate(false,false);a.endProbe("updateNodes");return}this.viewpointHasChanged=this.viewpointHasChanged||this.updateOptions.viewpointChanged;if(this.viewpointHasChanged){this.hasUnloadedSmallNodes=false;this.emergencyUnloadOccured=false;this.emergencyUnloadAvoided=false}if(this.pauseLoading||this.debugThrottle===2){this.updateUserQueues(this.viewpointHasChanged,v);this.emergencyUnloadNodes(v);this.updateLoadingStatus();a.endProbe("updateNodes");return}if(this.viewpointHasChanged&&!this._dbg_freezeViewpointTag){this.viewpointTag++}if(this.viewpointHasChanged&&this.queueRenderer){this.queueRenderer.clearClusters()}for(s=0;s<this.queues.length;s++){r=this.queues[s];r.updateNodes(this.viewpointHasChanged,v)}this.updateUserQueues(this.viewpointHasChanged,v);this.computeOcclusion();if(this.enableUnload){this.updateLoadedNodes(this.viewpointHasChanged,v);this.emergencyUnloadNodes(v)}if(this.debugThrottle<1){this.loadNodes(this.viewpointHasChanged,v)}this.viewpointHasChanged=false;this.updateOptions.viewpointChanged=false;this.updateOptions.modelLoaded=false;this.updateLoadingStatus();this.updateCandidateQueueRenderer();a.endProbe("updateNodes")};o.prototype.computeOcclusion=function(){var u=(new Date()).getTime();var v=(u-this.lastOcclusionTime)>=50;var t=this.queues[0].requiresOcclusion(v)||this.queues[1].requiresOcclusion(v);if(t){var s=new l({viewer:this.viewer,ratio:0.25,renderList:"ooc"});var r;for(r=0;r<this.queues.length;r++){s.debugId=r;if(this.queues[r].requiresOcclusion(v)){this.queues[r].computeOcclusion(s);if(v){this.lastOcclusionTime=u}}}}};o.prototype.updateUserQueues=function(t,u){var s;for(s=0;s<this.userQueues.length;s++){var r=this.userQueues[s];if(!this.pauseLoading||!r.pauseSensitive){if(t){r.handleViewpointChange(u)}r.traverseQueue()}}};o.prototype.loadNodes=function(r,s){if(this.debugThrottle<0.5){this.queues[0].loadNodes(r,s)}this.queues[1].loadNodes(r,s)};o.prototype.setPriorityComputer=function(r){this.priorityComputer=r};function e(u,s,t,r){this.viewpoint=u;this.cst=s;this.bsRadius=t.radius;this.priorityComputer=r}o.prototype.createViewpointData=function(r){var s=new e(r,p.computeScreenRadiusCstComponent(r.camera,this.viewer),this.boundingSphere,this.priorityComputer);return s};o.prototype.removeRemovedNodes=function(){var r;for(r=0;r<this.queues.length;r++){this.queues[r].removeUselessNodesFromList(this.queues[r].nodes)}};o.prototype.updateLoadingStatus=function(){var s=false,w=this.hasUnloadedSmallNodes,t;var u;s=s||this.rootAdded;this.rootAdded=false;for(u=0;u<this.queues.length;u++){s=s||this.queues[u].isLoading();w=w||this.queues[u].hasMoreToLoad()}var v=!this.unloadManager.isLoadingAllowed(0)||!this.unloadManager.isLoadingAllowed(1);if(s!==this.previousIsLoading){var r={isLoading:s,memoryFull:v||this.emergencyUnloadOccured||this.emergencyUnloadAvoided,moreToLoad:w||this.emergencyUnloadOccured||this.emergencyUnloadAvoided,emergencyUnload:this.emergencyUnloadOccured,emergencyUnloadAvoided:this.emergencyUnloadAvoided};if(s){a.startProbe("viewpoint");this.startLoadTime=(new Date()).getTime();if(this.onStartLoadingCB){this.onStartLoadingCB.call(undefined,r)}}else{t=(new Date()).getTime();a.endProbe("viewpoint");this.lastDeltaTime=t-this.startLoadTime;this.updateCandidateQueueRenderer(true);this.viewer.render();if(this.onEndLoadingCB){this.onEndLoadingCB.call(undefined,r)}}this.previousIsLoading=s}};o.prototype.addLoadedNode=function(r){if(!r.isUnloadable()){console.log("inconsistency")}r.getLDHNodeManagerQueue().addToLoadedNodesQueue(r)};o.prototype.updateLoadedNodes=function(r,s){this.unloadManager.beforeLoadedNodesQueueTraversal();this.queues[0].updateLoadedNodes(r,s);this.queues[1].updateLoadedNodes(r,s);this.unloadManager.afterLoadedNodesQueueTraversal()};o.prototype.onReferenceUnloaded=function(){this.queues[0].onReferenceUnloaded();this.queues[1].onReferenceUnloaded()};o.prototype.unloadNode=function(s,t){if(!s.isUnloadable(true)){return false}s.removeFromSceneGraph();if(s.isInList()){var r=s.getLDHNodeManagerQueue();r.onNodeToRemoveFromList()}s.setStatus(k.incomplete);this.unexpandNode(s);s.toUnload=false;s.setUnloadViewpointTag(this.viewpointTag);this.handleUnloadedNodeParents(s,t);return true};o.prototype.handleUnloadedNodeParents=function(s,t){var r;for(r=0;r<s.parents.length;r++){this.unloadNodeParentIfPossible(s.parents[r],t)}};o.prototype.unloadNodeParentIfPossible=function(r,t){if(!r.isUnloadLocked()&&r._status===k.complete){var s=1;if(!r.isForced()){s=r.computeLODValue(t)}if(s===0){this.unloadNode(r,t)}}};o.prototype.unexpandNode=function(u){var s,v,t,r;for(s=0;s<u.children.length;s++){r=u.children[s];v=r.reference;t=r.instanceId;v.removeParent(u);this.oocManager._unregisterInstance(t);if(v.parents.length===0&&v.isAlive()){this.oocManager._unregisterReference(v.referenceId)}}u.setStatus(k.incomplete);u.setUnloadStatus(q.unloaded);u.children=[];u.updateParentsStatus();u.updateMemorySize()};o.prototype.setOnStartLoadingCB=function(r){this.onStartLoadingCB=r};o.prototype.setOnEndLoadingCB=function(r){this.onEndLoadingCB=r};o.prototype.forceClean=function(){var r;for(r=0;r<this.queues.length;r++){this.queues[r].forceClean()}};o.prototype.onInstRefGraphTransactionEnd=function(u){var t,r,s,v;for(t=0;t<u.length;t++){r=u[t];r.addedToTransaction();if(r.expectedNbChildren!==-1){if(r.children.length===r.expectedNbChildren){r.setStatus(k.complete)}else{if(r.children.length>r.expectedNbChildren){console.log("Nb expected children inconsistency")}}}if(r.isSlave()){r.recursiveUpdateStatus(this)}}this.updateTransactionNodesStatus();this.tryBuildSceneGraphHierarchy()};o.prototype.updateTransactionNodesStatus=function(){var t=this.oocManager.getRootOccurrences();var s=[];var r=this;t.forEach(function(w,v,x){var y=w.occurrence;var u=y.reference;u.recursiveUpdateStatus(r)})};o.prototype.fillDebugJSON=function(r){r.references={Model3DHandler:[],InstRefHandler:[]};this.queues[0].fillDebugArray(r.references.Model3DHandler);this.queues[1].fillDebugArray(r.references.InstRefHandler);return r};o.prototype.setPauseLoading=function(r){this.pauseLoading=r};o.prototype.registerOverrideSet=function(r){if(!this.overrideSetManager){this.overrideSetManager=this.viewer.getSceneGraphOverrideSetManager()}if(!this.overrideSetMap[r]){this.overrideSetMap[r]=new i(this.targetNode);this.overrideSetManager.pushSceneGraphOverrideSet(this.overrideSetMap[r])}};o.prototype.removeOverrideSet=function(s){var r=this.overrideSetMap[s];if(r){this.overrideSetManager.removeSceneGraphOverrideSet(r);delete this.overrideSetMap[s]}};o.prototype.getOverrideSet=function(r){return this.overrideSetMap[r]};o.prototype.getOverrideSetManager=function(){return this.overrideSetManager};o.prototype.addUserQueue=function(v){var u;for(u=0;u<this.userQueues.length;u++){if(this.userQueues[u].handler===v){throw new Error("duplicate handler")}}var s=v.getParams?v.getParams():{};var B=s.addLeaves===undefined?true:s.addLeaves;var z=s.addIntermediateNodes===undefined?false:s.addIntermediateNodes;var r=new g(v,this);var y=new Set();var w=this.queues[0];var t,A;for(u=0;u<w.nodes.length;u++){t=w.nodes[u];if(t){if(z){if(!y.has(t)){t.traverseParents(function(C){y.add(C);r.addNode(C)},y)}}else{r.addNode(t)}}}var x=this.createViewpointData(this.viewer.currentViewpoint);r.computeOrder(x);this.requestUpdate(false,false);this.userQueues.push(r)};o.prototype.removeUserQueue=function(r){var s;for(s=this.userQueues.length-1;s>=0;s--){if(this.userQueues[s].handler===r){this.userQueues.splice(s,1)}}};o.prototype.setCandidateQueueRendererParams=function(r,t){if(!r){if(this.queueRenderer){this.queueRenderer.dispose();this.queueRenderer=null;this.viewer.render({budgeted:true})}}else{var s=this.queueRenderer;if(!s){s=new n(this,t.rootNode);this.queueRenderer=s;this.queueRenderer.setPickable(this.oocManager._loadingBoxesPickable)}if(t.preserveSelection!==undefined){this.queueRenderer.preserveSelection=t.preserveSelection}s.setParams(t)}this.requestUpdate(false,false)};o.prototype.updateCandidateQueueRenderer=function(s){var r=this.queueRenderer;var u=this.viewer.currentViewpoint.camera.position;if(r){var t=Date.now();if(t-this.lastQueueRendererUpdateTime>500||s){this.lastQueueRendererUpdateTime=t;r.updateRepresentation(u);this.viewer.render({budgeted:true})}}};o.prototype.isForceSceneMinEnabled=function(){return this.viewer._forceSceneMinValue!==null};o.prototype.emergencyUnloadNodes=function(t){var r=this.unloadManager.isEmergencyUnloadRequiredCPU(),s=this.unloadManager.isEmergencyUnloadRequiredGPU();if(r||s){this.emergencyUnloadOccured=true;if(s){this.queues[0].doEmergencyUnload(t)}if(this.unloadManager.isEmergencyUnloadRequiredCPU()){this.queues[1].doEmergencyUnload(t,1)}}};o.prototype.forceUnloadSmallNodes=function(r,t,s){this.queues[s].unloadSmallNodes(r,t,s)};o.prototype.setBoundingSphere=function(r){this.boundingSphere=r;this.bsNode.forceBoundingElements(true,{sphere:r.clone()});this.viewer.render()};o.prototype.onAddRoot=function(){this.rootAdded=true;this.requestUpdate(false,false);this.updateLoadingStatus()};return o});define("DS/3DXMTiles/OOCManager",["DS/3DXMTiles/LDHNodeManager","DS/3DXMTiles/OOCManagerEntry","DS/3DXMTiles/LDHOccurrence","DS/3DXMTiles/LDHReferenceStatus","DS/3DXMTiles/UnloadManager","DS/3DXMTiles/OOCReferenceIterator","DS/3DXMTiles/OOCManagerRootEntry","DS/Selection/HSOManager","DS/Selection/PSOManager","DS/Selection/CSOManager","DS/Visualization/ThreeJS_DS","DS/VisuTools/FPSCounter","DS/Mesh/MeshUtils","DS/3DXMTiles/PriorityComputerFactory"],function(j,a,l,s,o,f,b,h,m,p,r,k,e,c){var n=1;var q=function(u,t){t=t||{};d();this._config=t.config||"v0";this._ldhNodeManager=new j({viewer:u,oocManager:this,config:this._config,enableOcclusionTest:t.enableOcclusionTest});this._ldhNodeManager.unloadManager.setFlashMode(true);if(t.unloadSmallNodes!==undefined){this._ldhNodeManager.setUnloadSmallNodesEnabled(t.unloadSmallNodes?true:false)}this._referenceTos=new Map();this._instanceTos=new Map();this._rootOccurrenceTos=new Map();this._instRefGraphTransaction=null;this._forceSceneMin=t.forceSceneMin?true:false;this._loadingBoxesPickable=e.PICKABLE;this._overrideSetMap=new Map();if(window.OOCNewPriorityPrototype){this.setPriorityComputer("proto")}else{this.setPriorityComputer("none")}};q.prototype.setTargetNode=function(t){t.setRenderPasses(["main","ooc"]);this._ldhNodeManager.setTargetNode(t)};q.prototype.registerReference=function(v,u){var t=this._getOOCEntry(v,true);if(!t){t=new a(v,{manager:this,handler:u.handler.ldhHandler,boundingSphere:u.boundingSphere||null,boundingBox:u.boundingBox||null,url:u.url,loadModelOptions:u.loadModelOptions});this._ldhNodeManager.registerTilesNode(t.reference);this._referenceTos.set(v,t)}else{}};q.prototype.setOverrideCB=function(x,u,w){if(w===undefined){console.warn("Calling setOverrideCB(...) without 3rd argument is deprecated");w="#undefined#";this.registerOverrideSet(w)}var v=this._overrideSetMap.get(w);if(v){var t=this._getLDHReference(x);t.setOverrideCB(w,u);v.add(x)}};q.prototype.hasOverrideCB=function(w,v){var u=this._overrideSetMap.get(v);if(u){var t=this._getLDHReference(w);return(t.hasOverrideCB(v)?true:false)}return false};q.prototype.registerOverrideSet=function(t){if(t!=="#undefined#"){this._ldhNodeManager.registerOverrideSet(t);if(!this._overrideSetMap.has(t)){this._overrideSetMap.set(t,new Set())}}};q.prototype.clearOverrideSet=function(v){if(v!=="#undefined#"){var u=this._overrideSetMap.get(v);var t=this;if(u){u.forEach(function(x){var w=t._getLDHReference(x,true);if(w){w.setOverrideCB(v,null)}})}}};q.prototype.removeOverrideSet=function(t){if(t!=="#undefined#"){this.clearOverrideSet(t);this._ldhNodeManager.removeOverrideSet(t);this._overrideSetMap["delete"](t)}};q.prototype.registerLeafReference=function(v,u){var t=this._getOOCEntry(v,true);if(!t){var w=u.node.getModelIdentification();if(w&&this.isRegistered(w)){throw new Error("illegal node: used for another OOC reference")}t=new a(v,{manager:this,handler:u.handler.ldhHandler,boundingSphere:u.boundingSphere||null,boundingBox:u.boundingBox||null,node:u.node,url:u.url,leaf:true});t.reference.setExpectedNbChildren(0);this._ldhNodeManager.registerTilesNode(t.reference);this._referenceTos.set(v,t)}};q.prototype.unregisterLeafReference=function(w){var v=this._getOOCEntry(w);var t=v.reference;if(t.isSlave()){var u=t.getLDHNodeManagerQueue();u.onNodeToRemoveFromList();this._ldhNodeManager.unloadLeafReferenceCB&&this._ldhNodeManager.unloadLeafReferenceCB(w);t.node=null;this._unregisterReference(w)}};q.prototype.setUnloadLeafReferenceCB=function(t){this._ldhNodeManager.unloadLeafReferenceCB=t};q.prototype.setOnLeafReferenceLoadedCB=function(t){this._ldhNodeManager.onLeafReferenceLoadedCB=t};q.prototype.isRegistered=function(w,v){var u=this._getOOCEntry(w,true)===null?false:true;var t=t=(this._instanceTos.get(w)?true:false);return u||(!v&&t)};q.prototype.addRoot=function(w,x){this._rootOccurrenceTos.forEach(function(B,A,C){if(B.occurrence.reference.referenceId===w){throw new Error("Multiple occurrences for root are unsupported")}});var t=this._getLDHReference(w);var v=new Set();var z=new l({reference:t,manager:t.manager,instanceId:x.instanceId},v);v.forEach(function(A){A.updateOverride()});var y=n;var u=new b(z,x.boundingBox);this._rootOccurrenceTos.set(y,u);n++;if(this._forceSceneMin){this._updateSceneMin()}t.setIsRoot(true);this._updateBoundingSphere();this._ldhNodeManager.onAddRoot();return y};q.prototype.getReframeBoundingSphere=function(){var u=this.getRootOccurrences();var t=new r.Sphere();u.forEach(function(z,y,A){var B=z.occurrence;var v=B.reference;var x=v.getBoundingSphere(true).clone();x.applyMatrix4(B.matrix);var w=t.clone();x.mergeWithSphere(t,w);t=w});return t};q.prototype.removeRoot=function(A){var z=this._rootOccurrenceTos.get(A);var t=z&&z.occurrence;var C=t.reference;C.setIsRoot(false);var B=C.buildFlatList();t.detach();var y,x,u;for(y=0;y<B.length;y++){var v=B[y];v._removeNullsFromOccurrenceList();if(v._isDetachPossible()){for(x=0;x<v.children.length;x++){u=v.children[x];this._instanceTos["delete"](u.instanceId)}v._detach();this._unregisterReference(v.referenceId)}}this._ldhNodeManager.removeRemovedNodes();this._ldhNodeManager.requestUpdate(true,true);this._rootOccurrenceTos["delete"](A);if(this._forceSceneMin){this._updateSceneMin()}var w=this;this._overrideSetMap.forEach(function(E,G,H){var F=[];E.forEach(function(J){var I=w._getLDHReference(J,true);if(!I){F.push(J)}});var D;for(D=0;D<F.length;D++){E["delete"](F[D])}});this._updateBoundingSphere()};q.prototype.createReferenceIterator=function(v){var t=this._getLDHReference(v,true);var u=t&&new f(t);return u};q.prototype.isCPUMemoryFull=function(){var t=!this._ldhNodeManager.unloadManager.isLoadingAllowed(1);return t};q.prototype._unregisterReference=function(u){var t=this._getLDHReference(u,true);if(t){if(t.children.length>0){console.log("_unregisterReference internal error")}if(t){t.setStatus(s.dead);this._ldhNodeManager.unregisterNode(t);t.updateMemorySize();this._ldhNodeManager.unloadManager.onReferenceMemoryChange(-t.memorySize,-t.memorySizeGPU)}this._referenceTos["delete"](u)}};q.prototype._unregisterInstance=function(t){this._instanceTos["delete"](t)};q.prototype.addChild=function(x,z,y){var t=this._getLDHReference(x,true);if(t){var w=this._getLDHReference(z);var v=y.instanceId;var u=new Set();if(!this._instanceTos.get(v)){t.addReferenceChild(w,y.matrix||null,v,u);if(v){this._instanceTos.set(v,t)}}if(this._instRefGraphTransaction!==null){this._instRefGraphTransaction.onAddChild(x)}this._ldhNodeManager.tryBuildSceneGraphHierarchy();u.forEach(function(A){A.updateOverride()});if(w.comesFromWrap()){this._ldhNodeManager.addWrapStatusToUpdate(w)}}};q.prototype._onRepLoaded=function(t){if(this._instRefGraphTransaction!==null){this._instRefGraphTransaction.onAddChild(t)}};q.prototype.getReferenceUrl=function(u){var t=this._getLDHReference(u);return t.url};q.prototype.getReferenceBoundingSphere=function(u){var t=this._getLDHReference(u);return t._boundingSphere&&t._boundingSphere.clone()};q.prototype._getOOCEntry=function(v,t){var u=this._referenceTos.get(v);if(!t&&!u){throw new Error("Unknown OOC referenceId: '"+v+"'")}return u||null};q.prototype._getLDHReference=function(v,t){var u=this._getOOCEntry(v,t);return u?u.reference:null};q.prototype.getSceneGraphNode=function(w){var t=this._getLDHReference(w,true);if(t){return t.node}else{t=this._instanceTos.get(w);if(t){var u;for(u=0;u<t.children.length;u++){var v=t.children[u];if(v.instanceId===w){return v.node}}}}return null};q.prototype.forceReferenceLoad=function(w,v){var u=this;var t=u._getLDHReference(w,true);if(t){u._ldhNodeManager.requestUpdate(true,true);t.forceLoad(true,v)}};q.prototype.setForceReferenceLoad=function(x,u,w){var v=this;var t=v._getLDHReference(x,true);if(t){t.forceLoad(x,u?true:false,w);v._ldhNodeManager.forceUpdateNode(t)}};q.prototype.setUserData=function(y,u){var w=false;var t=this._getLDHReference(y,true);if(t){t.userData=u;w=true;if(t.node){t.node.setUserData(u)}}else{t=this._instanceTos.get(y);if(t){var v;for(v=0;v<t.children.length;v++){var x=t.children[v];if(x.instanceId===y){x.userData=u;w=true;if(x.node){x.node.setUserData(u)}}}}}if(!w){throw new Error("unknown id")}};q.prototype.getUserData=function(w){var t=this._getLDHReference(w,true);if(t){return t.userData}else{t=this._instanceTos.get(w);if(t){var u;for(u=0;u<t.children.length;u++){var v=t.children[u];if(v.instanceId===w){return v.userData}}}}throw new Error("unknown id")};q.prototype.setOnStartLoadingCB=function(t){this._ldhNodeManager.setOnStartLoadingCB(t)};q.prototype.setOnEndLoadingCB=function(t){this._ldhNodeManager.setOnEndLoadingCB(t)};q.prototype.setOnAddedToSceneGraphCB=function(v,u){var t=this._getLDHReference(v);t.setOnAddedToSceneGraphCB(u)};q.prototype.setOnRemovedFromSceneGraphCB=function(v,u){var t=this._getLDHReference(v);t.setOnRemovedFromSceneGraphCB(u)};q.prototype.getAllReferences=function(){var t=[];this._referenceTos.forEach(function(v,u,w){t.push(u)});return t};q.prototype.switchLOD=function(x,u,v){var t=this._getLDHReference(x);var w=this._ldhNodeManager;this._ldhNodeManager.executeReferenceAction([t],function(A,C){var B,z,y=0;function D(){for(z=0;z<A.length;z++){var E=A[z];E.userUnlockUnload()}y--;if(y===0&&v){v();v=null}}for(z=0;z<A.length;z++){var B=A[z];B.userLockUnload();if(!B.toUnload&&!B.shouldBeExpanded()){y++;B.addOnLoadedCB(D)}B.url=u;B.removeFromSceneGraph(true);B.updateMemorySize();B.setStatus(s.incomplete);w.registerTilesNode(B)}if(y===0){setTimeout(v,1)}C()})};q.prototype.setExpectedNbChildren=function(u,v){var t=this._getLDHReference(u,true);if(t){t.setExpectedNbChildren(v)}};q.prototype.getExpectedNbChildren=function(u){var t=this._getLDHReference(u,true);if(t){return t.expectedNbChildren}else{return -1}};q.prototype.getNbChildren=function(u){var t=this._getLDHReference(u);return t.children.length};q.prototype.isReferenceComplete=function(u){var t=this._getLDHReference(u,true);return t!==null&&t.isComplete()};q.prototype.dumpAllMemorySize=function(t){this._referenceTos.forEach(function(v,x,w){var u=v.reference;if(t){u.updateMemorySize()}console.log(x+" "+u.memorySize)});console.log("TOTAL "+this._ldhNodeManager.unloadManager.memoryUsage)};q.prototype.lockChildren=function(u){var t=this._getLDHReference(u);t.lockChildren()};q.prototype.unlockChildren=function(u){var t=this._getLDHReference(u);t.unlockChildren();this._ldhNodeManager.requestUpdate(true,true)};q.prototype.startInstRefGraphTransaction=function(){if(this._instRefGraphTransaction){console.log("ERROR - A transaction already exists")}this._instRefGraphTransaction=new i()};q.prototype.endInstRefGraphTransaction=function(){this._instRefGraphTransaction.endTransaction(this);this._instRefGraphTransaction=null};q.prototype.addSceneGraphLock=function(u){var t=this._getLDHReference(u,true);t.requestBuildSceneGraphHierarchy(true);t.userLockUnload();this._ldhNodeManager.tryBuildSceneGraphHierarchy()};q.prototype.removeSceneGraphLock=function(u){var t=this._getLDHReference(u,true);t.userUnlockUnload()};q.prototype.isSceneGraphLocked=function(u){var t=this.getSceneGraphLockCounter(u);return t>0};q.prototype.getSceneGraphLockCounter=function(u){var t=this._getLDHReference(u,false);if(t._optional){return t._optional.userLockUnload}else{return 0}};q.prototype.getRootOccurrences=function(){return this._rootOccurrenceTos};q.prototype._checkConsistency=function(){var t=this.getRootOccurrences();t.forEach(function(w,v,x){var u=w.occurrence.reference;u.checkConsistency(true)})};q.prototype._getDebugJSON=function(){var t={references:{},roots:[]};this._referenceTos.forEach(function(v,u,w){t.references[u]=v.reference.buildDebugJSON(true)});this._rootOccurrenceTos.forEach(function(v,u,w){var x=v.occurrence;t.roots.push(x.reference.referenceId)});return t};q.prototype._getReferenceDebugJSON=function(u){var t=this._getLDHReference(u,true);if(t){return t.buildDebugJSON()}return null};q.prototype._getAllInstancesDebugJSON=function(){var u={};var t=this;this._instanceTos.forEach(function(v,x,y){var w,z;for(w=0;w<v.children.length;w++){z=v.children[w];if(z.instanceId===x){u[x]={parent:v.referenceId,child:z.reference.referenceId}}}});return u};q.prototype._getSingleInstanceDebugJSON=function(w){var v={};var t=this._instanceTos.get(w);if(t){var u,x;for(u=0;u<t.children.length;u++){x=t.children[u];if(x.instanceId===w){return{instanceId:w,parent:t.referenceId,child:x.reference.referenceId}}}}return null};q.prototype.setPauseLoading=function(t){this._ldhNodeManager.setPauseLoading(t);if(!t){this._ldhNodeManager.requestUpdate(true,true)}};q.prototype.setReferenceLoadModelOptions=function(v,u){var t=this._getLDHReference(v);t.setLoadModelOptions(u)};q.prototype.getReferenceLoadModelOptions=function(u){var t=this._getLDHReference(u);return t._optional&&t._optional.loadModelOptions};q.prototype.setPerformancesOptions=function(t){if(t.fullAlwaysUnload){this._ldhNodeManager.unloadManager.setUnloadAlwaysTab([true,true])}if(t.repAlwaysUnload){this._ldhNodeManager.unloadManager.setUnloadAlwaysTab([true,false])}if(t.noAlwaysUnload){this._ldhNodeManager.unloadManager.setUnloadAlwaysTab([false,false])}if(t.pauseLoadingDuringViewpointMove!==undefined){this._ldhNodeManager.setPauseLoadingDuringViewpointMove(t.pauseLoadingDuringViewpointMove?true:false)}};q.prototype.getWorldMatrix=function(B,E){var C=this._rootOccurrenceTos.get(B).occurrence,x=C.reference;var z,u;var z,x,A,y,w,t,v;for(z=1;z<E.length;z+=2){v=C.getChildren();var y,D=false;for(y=0;y<v.length;y++){if(v[y].instanceId===E[z]){C=v[y];D=true}}if(!D){throw new Error("inconsistent path")}}return C.matrix.clone()};q.prototype.addUserQueue=function(t){this._ldhNodeManager.addUserQueue(t)};q.prototype.removeUserQueue=function(t){this._ldhNodeManager.removeUserQueue(t)};q.prototype.setCandidateQueueRendererParams=function(t,u){this._ldhNodeManager.setCandidateQueueRendererParams(t,u)};q.prototype.setExpandAllowed=function(u,t){this.setComesFromWrap(u,!t)};q.prototype.setComesFromWrap=function(w,u){var t=this._getLDHReference(w);t.setComesFromWrap(u);if(!u){this._ldhNodeManager.addWrapStatusToUpdate(t)}var v;for(v=0;v<t.parents.length;v++){this._ldhNodeManager.addWrapStatusToUpdate(t.parents[v])}if(!u){this._ldhNodeManager.requestUpdate(false,false)}};q.prototype._updateSceneMin=function(){var v=0;var t=false;this._rootOccurrenceTos.forEach(function(x,w,z){if(x.boundingBox){var y=x.computeSceneMin();if(!t||y<v){v=y;t=true}}});if(t){var u=this._ldhNodeManager.viewer;u._forceSceneMin(v);u.render({updateInfinitePlane:true})}};q.prototype.getSelectedPath=function(x){x=x||"hso";var B={hso:h,pso:m,cso:p};var y=B[x];var t=y.get();var D=[],z,u,w,C,v=[],A;for(z=0;z<t.length;z++){u=t[z].pathElement;if(u.instanceId!==undefined&&this._ldhNodeManager.queueRenderer){D=this._ldhNodeManager.queueRenderer.getPathFromPathElement(u)}else{D=g(u)}v.push(D)}if(v&&v.length===1){return v[0]}else{return v}};q.prototype.getSelectedReference=function(x){x=x||"hso";var B={hso:h,pso:m,cso:p};var y=B[x];var t=y.get();var z,u,w,C,v=[],A,D,E;for(z=0;z<t.length;z++){u=t[z].pathElement;if(u.instanceId!==undefined&&this._ldhNodeManager.queueRenderer){E=this._ldhNodeManager.queueRenderer.getReferenceFromPathElement(u)}else{D=g(u);E=D[D.length-1];if(!this.isRegistered(E,true)){E=null}}v.push(E)}if(v&&v.length===1){return v[0]}else{return v}};q.prototype.setMaxNbExpectedChildrenPerRequest=function(t){this._ldhNodeManager.setMaxNbExpectedChildrenPerRequest(t)};q.prototype.setLoadingBoxesPickable=function(t){this._loadingBoxesPickable=t;if(this._ldhNodeManager.queueRenderer){this._ldhNodeManager.queueRenderer.setPickable(t)}};q.prototype.showPerfos=function(){k.setAutoRefresh(false);var t=this._ldhNodeManager.viewer;t.showPerfo(true,false)};q.prototype._updateBoundingSphere=function(){var t=new r.Sphere();this._rootOccurrenceTos.forEach(function(w,v,x){var y=w.occurrence;var u=y.getBoundingSphere();t.clone().mergeWithSphere(u,t)});this._ldhNodeManager.setBoundingSphere(t)};q.prototype.setPriorityComputer=function(u,v){var t=c.createPriorityComputer(u,v);this._ldhNodeManager.setPriorityComputer(t)};function g(v){var u,t=[],w,x;for(u=0;u<v.externalPath.length;u++){w=v.externalPath[u];x=w.getModelIdentification();if(x){t.push(x)}}return t}var i=function(){this.updatedRefencesMap=new Map()};i.prototype.onAddChild=function(t){this.updatedRefencesMap.set(t,true)};i.prototype.endTransaction=function(u){var t=[];this.updatedRefencesMap.forEach(function(x,w,y){var v=u._getLDHReference(w,true);if(v){t.push(v)}});u._ldhNodeManager.onInstRefGraphTransactionEnd(t)};function d(){var t=window.localStorage.getItem("OOCDebug");if(t){var v=JSON.parse(t);var u;for(u in v){window[u]=v[u]}}}require(["DS/Visualization/SceneGraphFactory","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D"],function(t,v,w){var u=null;window.OOCShowReferenceBoundingSphere=function(x,B,E,C){var G=B._getLDHReference(x);var F=G.getBoundingBox();var z=G.node;var A={cornerPoint:F.min,firstAxis:new v.Vector3(F.max.x-F.min.x,0,0),secondAxis:new v.Vector3(0,F.max.y-F.min.y,0),thirdAxis:new v.Vector3(0,0,F.max.z-F.min.z),material:new v.MeshBasicMaterial({color:"red",force:true,opacity:0.2,transparent:true})};if(u===null){u=new w();E.addNode(u)}var y=G.isSlave()?z._occurrences:G._occurrences;var D,H,z;for(D=0;D<y.length;D++){H=y[D].matrix;z=t.createCuboidNode(A);z.setMatrix(H);if(C){z.setNoZ(true)}u.addChild(z)}debugWebGLV6Viewer.render()};window.OOCBuildTileModelPreloadData=function(A,B){var z=A.getRootOccurrences()[0];var x=z&&z.reference.referenceId;var y={viewpoint:{pos:B.currentViewpoint.getEyePosition().createJSON(),sight:B.currentViewpoint.getSightDirection().createJSON(),up:B.currentViewpoint.getUpDirection()},rootId:x};return JSON.stringify(y)}});return q});