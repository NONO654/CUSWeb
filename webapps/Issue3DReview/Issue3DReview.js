define("DS/Issue3DReview/commands/Print",["UWA/Class","DS/ApplicationFrame/CommandCheckHeader"],function(b,d){var a={TIMEOUT_PRINT:100};var c=b.extend(d,{init:function(e){var f=this;f._parent(e,{});require(["UWA/Class/Promise","UWA/Core","DS/UIKIT/Mask","DS/VENWebCanvg/CanvgTools","DS/2DAnnotation/components/ImageEditor","DS/IssueServices/Contexts"],function(j,n,m,h,l,g){var i=g.get("widget");var k=f.onStateChange(function(u){if(u===false){return}m.mask(i.body);var p=i.body.getElement("#divCss2DElement");p.setStyle("z-index","9999");window.Promise=j;var o=g.get("pad3DViewer");o.getFrameWindow().getActionBar().close();var s=new h();var B=o.getFrameWindow().elements.viewerFrame;var y=[];var A=[];var t=B.getElementsByTagName("svg");try{for(var v=t.length-1;v>=0;v--){var r=t[v];var x=r.parentNode;var w=r.outerHTML;var q=n.createElement("canvas");s.svgToCanvas(w,q);y.push({parent:x,child:r});x.removeChild(r);A.push({parent:x,child:q});x.appendChild(q)}}catch(z){}l.utils.capture(B,{imageTimeout:a.TIMEOUT_PRINT,allowTaint:true,onRendered:function(D){var C=D.getContext("2d");C.webkitImageSmoothingEnabled=false;C.mozImageSmoothingEnabled=false;C.imageSmoothingEnabled=false}}).then(function(E){y.forEach(function(F){F.parent.appendChild(F.child)});A.forEach(function(F){F.parent.removeChild(F.child)});o.getFrameWindow().getActionBar().open();var C=n.createElement("img",{src:E.dataURL});var D=window.open("","printForm","width="+E.canvas.width+", height="+E.canvas.height);D.document.body.innerHTML=C.outerHTML;setTimeout(function(){D.print();setTimeout(function(){D.close();p.setStyle("z-index","auto");f.setState(false,false);m.unmask(i.body)},a.TIMEOUT_PRINT)},a.TIMEOUT_PRINT)})});f._destroy=function(){f._modelEvents.unsubscribe(k)}})}});return c});define("DS/Issue3DReview/commands/CommandsManager",["DS/ApplicationFrame/CommandsManager","DS/Logger/Logger"],function(d,b){var c="DS/Issue3DReview/commands/CommandsManager";var f=b.getLogger(c);var a={disabled:false,commands:{toEnable:[],toDisable:[]},commandCheckHeaders:{toEnable:[],toDisable:[]}};var e={select:function(j){var i=this;var g=[];var h=[];if(j&&j.length>0){if(j.length>=1){g.push("Open","Inspect","Share")}if(j.length===1){g.push("AttachmentManager","Mockup")}else{h.push("AttachmentManager","Mockup")}}else{h.push("Open","AttachmentManager","Mockup","Inspect","Share")}i._switchCommands(g,true);i._switchCommands(h,false)},getCommand:function(g){return d.getCommand(g)},getCommandCheckHeader:function(g){return d.getCommandCheckHeader(g)},disableAll:function(){if(a.disabled===true){return}var g=d.getCommands(),n=Object.keys(g);var l=d.getCommandCheckHeaders(),m=Object.keys(l);a={disabled:true,commands:{toEnable:[],toDisable:[]},commandCheckHeaders:{toEnable:[],toDisable:[]}};for(var k=0;k<n.length;k++){if(g[n[k]].isEnabled()){a.commands.toEnable.push(n[k])}else{a.commands.toDisable.push(n[k])}}for(var h=0;h<m.length;h++){if(l[m[h]].isEnabled()){a.commandCheckHeaders.toEnable.push(m[h])}else{a.commandCheckHeaders.toDisable.push(m[h])}}d.disableAll()},enableAll:function(){if(a.disabled===false){return}d.enableAll();var h=d.getCommands();if(a&&a.commands){for(var l=0;l<a.commands.toEnable.length;l++){h[a.commands.toEnable[l]].enable()}for(var k=0;k<a.commands.toDisable.length;k++){h[a.commands.toDisable[k]].disable()}}var m=d.getCommandCheckHeaders();if(a&&a.commandCheckHeaders){for(var g=0;g<a.commandCheckHeaders.toEnable.length;g++){m[a.commandCheckHeaders.toEnable[g]].enable()}for(var n=0;n<a.commandCheckHeaders.toDisable.length;n++){m[a.commandCheckHeaders.toDisable[n]].disable()}}a={disabled:false,commands:{toEnable:[],toDisable:[]},commandCheckHeaders:{toEnable:[],toDisable:[]}}},_switchCommands:function(m,l){var h=this;for(var g=0;g<m.length;g++){var k=h.getCommand(m[g]);if(k===undefined){k=h.getCommandCheckHeader(m[g])}try{l===true?k.enable():k.disable()}catch(j){f.error("Error "+(l?"enabling":"disabling"),m[g],j)}}},inspectingIssue:function(){var h=this;var g=[];g.push("Reset","CreateFromBlank","CreateFromTemplate","Display","Focus","Refresh","Templates","CreateFrom3D");h._switchCommands(g,false)},releasingIssue:function(){var i=this;var g=[];var h=[];g.push("Reset","CreateFromBlank","CreateFromTemplate","Display","Focus","Refresh","Templates","CreateFrom3D");h.push("Inspect");i._switchCommands(g,true);i._switchCommands(h,false)}};return e});define("DS/Issue3DReview/components/ContextualMenu",["UWA/Class/Promise","UWA/Core","DS/ApplicationFrame/CommandsManager","DS/Menu/ContextualMenu","DS/WebappsUtils/WebappsUtils","DS/IssueServices/Contexts","DS/IssueServices/utils/Performance","DS/IssueServices/utils/Views","i18n!DS/Issue3DReview/assets/nls/Issue3DReview"],function(k,g,a,c,f,e,d,h,l){var j={ISSUE_TYPE:"Issue",LABEL:{REPORTED_AGAINST:"reportedAgainst",RESOLVED_BY:"resolvedBy",CONTEXTS:"contexts",OPEN_WITH:"Open with",OPEN:"Open"},ICON:{REPORTED_AGAINST:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-location",RESOLVED_BY:"wux-ui-3ds wux-ui-3ds-1x fonticon-docs",CONTEXTS:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-3d-object",OPEN_WITH:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-export"}};var b="DS/Issue3DReview/components/ContextualMenu";var i={getWUXContextualMenu:function(){return c},getContextualMenu:function(){var o=this;var n=e.get("component").getIssues(),m=e.get("component").getSelectedIssues();if(m.length===0){return k.resolve([])}var p=m.reduce(function(u,s){var q=[];var r=[];var t=[];n.map[s.id].model.get(j.LABEL.REPORTED_AGAINST).forEach(function(v){q.push({physicalId:v.physicalId,type:v.type,name:v.name,title:v.title?v.title:v.name})});n.map[s.id].model.get(j.LABEL.RESOLVED_BY).forEach(function(v){r.push({physicalId:v.physicalId,type:v.type,name:v.name,title:v.title?v.title:v.name})});n.map[s.id].model.get(j.LABEL.CONTEXTS).forEach(function(v){t.push({physicalId:v.physicalId,type:v.type,name:v.name,title:v.title?v.title:v.name})});u.push({physicalId:s.id,type:s.type,name:s.name,title:s.title,reportedAgainst:q,resolvedBy:r,contexts:t});return u},[]);return o._getMenu({objects:p})},_getMenu:function(n){var o=this;var m=[],p=Array.isArray(n.objects)?n.objects:[];if(p.length===0){return k.resolve([])}d.start(o.name+" getFullMenu");return o._getOpenWithMenu(n).then(function(q){m=m.concat(q)}).then(function(){return o._getBasicMenu(n)}).then(function(q){m=m.concat(q);d.end(o.name+" getFullMenu");return m})},_getBasicMenu:function(n){var o=this;d.start(o.name+" getMenu");var m=[],p=Array.isArray(n.objects)?n.objects:[];if(p.length===0){return m}if(p.length===1){m.push({name:"Attachments",title:l.commands.attachments,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-attach"},data:null,action:{callback:function(){a.getCommand("AttachmentManager").begin()}}});m.push({type:"SeparatorItem"})}m.push({name:"Duplicate",title:l.commands.duplicate,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-duplicate"},data:null,action:{callback:function(){a.getCommand("Duplicate").begin()}}});m.push({name:"Close",title:l.commands.close,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-close"},data:null,action:{callback:function(){a.getCommand("Close").begin()}}});m.push({name:"Delete",title:l.commands["delete"],type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-trash"},data:null,action:{callback:function(){a.getCommand("Delete").begin()}}});m.push({type:"SeparatorItem"});m.push({name:"More",title:l.commands.more,type:"PushItem",data:null,submenu:[{name:"Share",title:l.commands.share,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-share-alt"},data:null,action:{callback:function(){a.getCommand("Share").begin()}}},{title:l.commands.inspect,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-location"},action:{callback:function(){a.getCommand("Inspect").begin()}}}]});d.end(o.name+" getMenu");return m},_getOpenWithMenu:function(n){var p=this;var m=[],q=Array.isArray(n.objects)?n.objects:[];if(q.length===0){return k.resolve([])}n.allObjectsAreIssues=q.every(function(u){return u.type===j.ISSUE_TYPE});n.allObjectsAreNotIssues=q.every(function(u){return u.type!==j.ISSUE_TYPE});if(n.allObjectsAreIssues===true){var r=[],s=[],t=[];n.objects.forEach(function(u){r=r.concat(u.contexts);s=s.concat(u.reportedAgainst);t=t.concat(u.resolvedBy)});var o=[];return k.all([p._getOpenWithSubMenu({name:j.LABEL.CONTEXTS,label:l.commands.open.contexts,objects:r,icon:j.ICON.CONTEXTS}),p._getOpenWithSubMenu({name:j.LABEL.REPORTED_AGAINST,label:l.commands.open.reportedAgainst,objects:s,icon:j.ICON.REPORTED_AGAINST}),p._getOpenWithSubMenu({name:j.LABEL.RESOLVED_BY,label:l.commands.open.resolvedBy,objects:t,icon:j.ICON.RESOLVED_BY})]).then(function(u){o=u.reduce(function(w,v){return w.concat(v)},[]);if(o.length>0){m.push({name:j.LABEL.OPEN,title:l.commands.open.multiple,type:"PushItem",data:null,fonticon:{content:j.ICON.OPEN_WITH},submenu:o})}return m})}else{if(n.allObjectsAreNotIssues===true){return p._getOpenWithSubMenu({name:j.LABEL.OPEN_WITH,label:l.commands.open.single,objects:n.objects,icon:j.ICON.OPEN_WITH})}else{return k.resolve([])}}},_getOpenWithSubMenu:function(o){if(!o||!Array.isArray(o.objects)||o.objects.length===0){return k.resolve([])}var n=[],m=[],p=o.objects;d.start(b+" _getOpenWithSubMenu");return new k(function(t){d.start(b+" _getOpenWithSubMenu getOpenWithMenu");for(var q=0;q<p.length;q++){var u=p[q];m.push({serviceId:"3DSpace",objectId:u.physicalId,objectType:u.type,displayName:u.title?u.title:u.name})}if(m.length===0){d.end(b+" getOpenWithMenu");t(n);return}var s=e.get("widget");var r=h.getOpenWith().set3DXContent({protocol:"3DXContent",version:"1.1",source:s.name,widgetId:s.id,data:{items:m}},true);r.retrieveCompatibleApps(function(w){if(w&&w.length>0){var v=[];w.forEach(function(y){v.push({name:y.text.replace(/ /g,""),type:"PushItem",title:y.text,fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-"+y.fonticon},action:{callback:function(A){var z=p.reduce(function(C,B){C.push(B.physicalId);return C},[]);e.get("component").utils.setTypesCallbackForOFW(z);y.handler.call(A)}}})});if(v.length>0){var x={name:o.name,type:"PushItem",fonticon:{content:o.icon},title:o.label,submenu:v};n.push(x)}}t(n)});d.end(b+" _getOpenWithSubMenu")})}};return i});define("DS/Issue3DReview/models/Marker",["UWA/Core","UWA/Class/Model","DS/Logger/Logger","DS/Visualization/ThreeJS_DS","DS/IssueServices/Contexts","DS/IssueServices/services/IssueServices","DS/IssueServices/utils/Performance"],function(f,d,b,h,c,e,a){var g={SEPARATOR_ID:"(╯°□°）╯︵ ┻━┻",COORDINATES_VALIDATION:2,COORDINATES_X:"x",COORDINATES_Y:"y",COORDINATES_Z:"z",AXIS_SYSTEM_POSITION:0};var i=d.extend({name:"DS/Issue3DReview/models/Marker",defaults:{id:"",physicalId:"",issue:"",type:"",name:"",revision:"",title:"",node:null,position:null,original:null,inverse:null,path:[],conflict:0,color:"","default":null,temporary:false},_logger:null,setup:function(){var n=this;n._logger=b.getLogger("DS/Issue3DReview/Model");n._logger.debug("Marker for issue %s (%s) has been initialized",n.get("title"),n.get("name"));a.start(n.name+" setup");var q=n.get("id"),p=q.indexOf(g.SEPARATOR_ID);n.set("physicalId",q.substring(0,p!==-1?p:q.length));n.set("default",n.utils.getCenterBoundingSphere(n.get("path")));n.set("axis",n.utils.getAxisSystem(n.get("path")));var l=c.get("component").get3DContext().controller;var m=new h.Matrix4();m.extractRotation(l.buildPathFromArray(n.get("path")).getWorldMatrix());n.set("inverse",new h.Matrix4().getInverse(m));var j=n.get("position");if(n.utils.isValidPosition(j)===true){var k=new h.Vector3(j[g.COORDINATES_X],j[g.COORDINATES_Y],j[g.COORDINATES_Z]);n.set("original",k);k.applyMatrix4(m);var o=n.utils.getRelativePosition(n.get("axis"),k);n.set("position",o)}else{n.set("position",null)}a.end(n.name+" setup")},save:function(o,l){var n=this;n._logger.debug("Saving marker %s from issue %s (%s)",n.get("id"),n.get("title"),n.get("name"));a.start(n.name+" save");var k=n.get("issue").get("id");var j=n.utils.convert(n,f.clone(o));j.physicalId=n.get("physicalId");var m=new h.Vector3(j.position[g.COORDINATES_X],j.position[g.COORDINATES_Y],j.position[g.COORDINATES_Z]);e.issues.update({data:{objects:[{physicalId:k,reportedAgainst:[j]}]},onComplete:function(p){n.set("position",o.position);n.set("original",m);if(l&&typeof l.onComplete==="function"){l.onComplete(p)}a.end(n.name+" save")},onFailure:function(p){if(l&&typeof l.onFailure==="function"){l.onFailure(p)}a.end(n.name+" save")}})},destroy:function(){var j=this;j._logger.debug("Destroying marker %s from issue %s (%s)",j.get("id"),j.get("title"),j.get("name"));j.clear({silent:true}).set(j.defaults)},utils:{isValidPosition:function(j){return j&&j.hasOwnProperty(g.COORDINATES_X)&&j.hasOwnProperty(g.COORDINATES_Y)&&j.hasOwnProperty(g.COORDINATES_Z)},getPosition:function(m,j){var o=this;var l=c.get("component").get3DContext().controller;var n=new h.Matrix4();n.extractRotation(l.buildPathFromArray(m.get("path")).getWorldMatrix());var k=j;k.applyMatrix4(n);return o.getRelativePosition(m.get("axis"),k)},getCenterBoundingSphere:function(k){var j=c.get("component").get3DContext();return j.controller.buildPathFromArray(k).getBoundingSphere().center},getAxisSystem:function(k){var j=c.get("component").get3DContext();return j.controller.buildPathFromArray(k).getWorldMatrix().decompose()[g.AXIS_SYSTEM_POSITION]},getRelativePosition:function(k,j){var p=k.x,n=k.y,l=k.z;var q=parseFloat(j.x),o=parseFloat(j.y),m=parseFloat(j.z);return new h.Vector3(p+q,n+o,l+m)},convert:function(l,m){var k={};if("position" in m){var j=new h.Vector3();j.subVectors(m.position,l.get("axis"));j.applyMatrix4(l.get("inverse"));k.position={x:j.x,y:j.y,z:j.z}}return k}}});return i});define("DS/Issue3DReview/commands/Release",["UWA/Class","DS/ApplicationFrame/Command"],function(a,b){var c=a.extend(b,{execute:function(){require(["DS/IssueServices/Contexts"],function(d){d.get("component").release()})}});return c});define("DS/Issue3DReview/commands/Refresh",["UWA/Class","DS/ApplicationFrame/Command"],function(a,c){var b=a.extend(c,{execute:function(){require(["DS/PADUtils/views/PADAlert","DS/IssueServices/Contexts","i18n!DS/Issue3DReview/assets/nls/Issue3DReview"],function(e,d,h){var g=d.get("component");if(g.isProcessing()){e.displayNotification({msg:h.notifications.commandAlreadyProcessing,eventID:"info"});return}var f=d.get("application");f.refresh()})}});return b});define("DS/Issue3DReview/commands/Create",["UWA/Class","DS/ApplicationFrame/Command","DS/IssueCommon/utils/Utils","DS/IssueServices/Contexts","DS/IssueServices/utils/Parser"],function(c,e,d,a,f){var b=c.extend(e,{component:null,init:function(g){var h=this;h._parent(g,{isAsynchronous:true})},execute:function(){var g=this;if(g.utils.isAlreadyRunning()===true){return}g.IF3D()},beginExecute:function(){var g=this;if(g.utils.isAlreadyRunning()===true){return}var h=a.get("widget");d.Mask.mask(h.body)},endExecute:function(){var g=a.get("widget");d.Mask.unmask(g.body)},IF3D:function(){var g=this;require(["UWA/Class/Promise","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/Selection/CSOManager","DS/IssueComponents/create/Create","DS/IssueServices/services/IssueServices"],function(o,j,k,r,l){var n=a.get("widget");var q=k.get();var p=[],h=[];for(var m=0;m<q.length;m++){p.push(q[m].pathElement)}p.forEach(function(s){while(!j.isReference(s.getLastElement())){s=s.getParentPath()}var i=s.getLastElement();h.push(j.getNodeID(i))});new o(function(s){var i=[];l.fetch({data:{objects:h.map(function(t){return{physicalId:t}})},onComplete:function(t){var u=t.body;if("results" in u){u.results.forEach(function(w){var v={};var x=f.parseFetchResponse(w);v.fullName=x.display.responsible;v.user=x.display.owner;v.organization=x.display.organization;i.push(v)})}s(i)},onFailure:function(){s(i)}})}).then(function(t){var s=new r(n.body);s.render();var u=t.map(function(v){return{user:v.user}});var i=t.reduce(function(w,v){w[v.user]={user:v.user,fullName:v.fullName,organization:v.organization};return w},{});s.isLoaded.then(function(){var x="";for(var w in i){if(i.hasOwnProperty(w)){x=i[w].organization}}var v=new Date();var y={id:"template-"+Date.now(),info:{name:"",description:"",lastUsed:null},data:{title:"",description:"",resolutionRecommendation:"",priority:"Low",resolutionDate:(v.getMonth()+1)+"/"+v.getDate()+"/"+v.getFullYear(),estimatedStartDate:(v.getMonth()+1)+"/"+v.getDate()+"/"+v.getFullYear(),estimatedEndDate:(v.getMonth()+1)+"/"+v.getDate()+"/"+v.getFullYear(),reportedAgainst:h.map(function(z){return{physicalId:z}}),positions:[],contexts:[],assignees:u,responsibleOrganization:x,reportingOrganization:x,attachments:[],primaryAttachment:null,automationTasks:[]},ui:{assignees:i,responsibleOrganization:x}};return s.applyTemplate(y)})["catch"](function(v){s._logger.error(v)})["finally"](function(){g.end()})})})},utils:{isAlreadyRunning:function(){var g=a.get("widget");return g.body.getElement(".create-template-chooser-dialog")!==null||g.body.getElement(".create-view-dialog")!==null}}});return b});define("DS/Issue3DReview/utils/ModelParser",["UWA/Core","DS/Logger/Logger","DS/IssueCommon/utils/Utils","DS/IssueServices/utils/Performance"],function(h,c,g,e){var b={NODE:{id:"",type:"",name:"",title:"",actionTaken:"",actualEndDate:"",actualStartDate:"",assignees:[],contexts:[],created:"",description:"",estimatedEndDate:"",estimatedStartDate:"",modified:"",owner:{},priority:"",reportedAgainst:[],reportingOrganization:"",resolutionDate:"",resolutionRecommendation:"",resolutionStatement:"",resolvedBy:[],responsibleOrganization:"",revision:"",state:"",custom:{}}};var f=function(i){var l=h.clone(b.NODE);l.icons=[];for(var j in b.NODE){if(b.NODE.hasOwnProperty(j)){l[j]=i[j]?i[j]:b.NODE[j]}}l.id=i.physicalId?i.physicalId:l.id;l.physicalId=l.id;l.resourceid=l.id;var k=g.getIconByState(l.state);l.icons.push(k);return l};var a=function(k){var n=h.clone(b.NODE);n.icons=[];var j=k.attributes;for(var l=0;l<j.length;l++){var m=j[l];switch(m.name){case"resourceid":n.id=m.value;break;case"ds6w:identifier":n.name=m.value;break;case"ds6w:label":n.title=m.value;break;case"ds6w:status":n.state=m.value;break;case"ds6w:type":n.type=m.value;break;case"ds6w:responsible":n.owner=m.value;break;case"type_icon_url":n.icons.push(m.value);break;case"ds6w:modified":n.modified=m.value;break;case"ds6w:created":n.created=m.value;break;case"ds6wg:revision":n.revision=m.value;break;default:break}}return n};var d={name:"DS/Issue3DReview/utils/ModelParser",parse:function(p,m){var o=this,k=[];e.start(o.name+" parse");m=m?m:{};if(Array.isArray(p)){if(m.useIndex===true){for(var n=0;n<p.length;n++){k.push(a(p[n]))}}else{for(var l=0;l<p.length;l++){k.push(f(p[l]))}}}else{if(m.useIndex===true){k=a(p)}else{k=f(p)}}e.end(o.name+" parse");return k}};return d});define("DS/Issue3DReview/commands/Mockup",["UWA/Class","DS/ApplicationFrame/Command","DS/IssueCommon/utils/Utils","DS/IssueServices/Contexts","i18n!DS/IssueAttachmentManager/assets/nls/IssueAttachmentManager"],function(c,e,d,a,g){var b={TIMEOUT_UNSELECT:50,ILLEGAL_CHARACTERS:/[/\\?%*:|"<>]/g};var f=c.extend(e,{_processing:false,annotation:null,init:function(h){var i=this;i._parent(h,{isAsynchronous:true})},execute:function(){var h=this;require(["UWA/Core","DS/Selection/HSOManager","DS/2DAnnotation/2DAnnotation","DS/PADUtils/views/PADAlert","DS/UIKIT/Mask","DS/IssueAttachmentManager/services/AttachmentServices","DS/IssueServices/Contexts","DS/IssueServices/services/IssueServices","DS/PlatformAPI/PlatformAPI"],function(q,m,l,j,o,s,n,p,w){if(h._processing===true){return}var r=n.get("widget"),u=n.get("component");var t=u.get3DContext().root;var y=u.getSelectedIssues();if(y.length!==1){return}h.annotation=null;var i=u.getIssues().map;var v=i[y[y.length-1].id];var k=v.model.get("id");v.utils.unhighlight(v);h._processing=true;m.empty();var x=function(){var z=this;v.utils.highlight(v);h._processing=false;h.annotation=null;z.destroy()};setTimeout(function(){var z=q.Element.getElement.call(t.getFrameWindow().elements.viewerFrame,"canvas");h.annotation=new l({className:"create-attachments-annotation",saveCallback:function(D){o.mask(r.body);o.mask(h.annotation.immersiveFrame.elements.container);var A=new Date().toLocaleString();A=A.replace(b.ILLEGAL_CHARACTERS,"-");var E=g.replace(g.annotate.defaultName,{date:A});var B=new File([D.blob],E,{type:"image/png",lastModified:Date.now()});s.uploadFile(B,k).then(function(F){j.displayNotification({msg:g.replace(g.notifications.Annotation.uploadSuccess,{fileName:E}),eventID:"info"});if(F&&F.data&&F.data.length>0&&F.data[0].id){var H=F.data[0];return s.setAsPrimary(H.id,k).then(function(K){var M=[[k]],J={};J[k]={id:k};var I=Math.floor(Date.now());w.publish("DS/Object/update",{metadata:{appId:r.id,appName:r.name,timestamp:I,options:{force:true}},data:{paths:M,attributes:J},version:"1.0"});var L=JSON.parse(K);if(H.id===L.documentId){j.displayNotification({msg:g.notifications.SetAsPrimary.success,eventID:"info"})}},function G(I){j.displayNotification({msg:g.notifications.SetAsPrimary.failure,eventID:"error"});h.annotation._logger.error(I)})}else{return Promise.reject(new Error("Unexpected empty response for upload."))}},function C(F){j.displayNotification({msg:g.notifications.Annotation.uploadFailure,eventID:"error"});h.annotation._logger.error(F)})["finally"](function(){o.unmask(r.body);o.unmask(h.annotation.immersiveFrame.elements.container);x.apply(h.annotation)})},exitCallback:function(){x.apply(h.annotation)},captureTarget:z});h.annotation.render();h.annotation.isLoaded.then(function(){h.annotation.container.inject(r.body)})["catch"](function(){x.apply(h.annotation)})["finally"](function(){h.end()})},b.TIMEOUT_UNSELECT)})},beginExecute:function(){var h=a.get("widget");d.Mask.mask(h.body)},endExecute:function(){var h=a.get("widget");d.Mask.unmask(h.body)}});return f});define("DS/Issue3DReview/PAD3DViewer",["DS/ENOPAD3DViewer/PAD3DViewer"],function(b){var a=b.extend({});return a});define("DS/Issue3DReview/views/Balloon",["UWA/Class","UWA/Class/Promise","UWA/Class/View","UWA/Core","DS/UIKIT/Input/Button","DS/UIKIT/Popover","DS/Core/Events","DS/Core/PointerEvents","DS/ENO6WPlugins/jQuery","DS/ExternalComponents/jQueryUI","DS/IssueServices/utils/Performance","DS/Logger/Logger","DS/Manipulators/Manipulator","DS/PADUtils/views/PADAlert","DS/SceneGraphNodes/CSS2DNode","DS/Visualization/Node3D","DS/Visualization/ThreeJS_DS","i18n!DS/Issue3DReview/assets/nls/Issue3DReview","css!DS/Issue3DReview/Issue3DReview.css"],function(p,d,o,f,i,q,l,g,h,n,c,t,s,r,b,k,a,e){var j={TIMEOUT_CLICK:200,TIMEOUT_DND:100,CONFLICT_COLOR:"#F9F9F9",BALLOON_SIZE:{height:45,width:25},DEFAULT_OPACITY:"1",DEFAULT_BORDER:"#3D3D3D",DEFAULT_INNER:"#3D3D3D",PATH_TO_PARSE:0};var u={balloon:function(w,y,x,v){return'<svg class="balloon-svg" width="25" height="45" viewBox="0 0 25 45" preserveAspectRatio="xMaxYMax" xmlns="http://www.w3.org/2000/svg"><g><g class="balloon-container" opacity="'+y+'"><path class="balloon-path" stroke-width="1" stroke="'+x+'" fill="'+w+'" d="m12.50023,0.61752c-6.51488,0 -11.79788,5.59224 -11.79788,12.48846c0,2.80815 0.87686,5.40025 2.35194,7.48519c0.005,0.00289 0.00727,0.00818 0.00727,0.01059c0.28047,0.43643 9.31685,14.46321 9.43822,23.78072c0.12182,-9.31751 9.15775,-23.34429 9.43867,-23.78072c0.005,-0.0077 0.00727,-0.01059 0.00727,-0.01059c1.47599,-2.08494 2.35194,-4.67704 2.35194,-7.48519c0,-6.89575 -5.28209,-12.48846 -11.79743,-12.48846zm0,6.57288c2.94833,0 5.34028,2.53195 5.34028,5.65287c0,3.12091 -2.39194,5.65287 -5.34028,5.65287s-5.33982,-2.53195 -5.33982,-5.65287c0,-3.12091 2.39149,-5.65287 5.33982,-5.65287z" /></g><ellipse class="balloon-inner" opacity="'+y+'" stroke="'+v+'" ry="4.16736" rx="3.95816" id="svg_6" cy="12.83264" cx="12.5" stroke-width="2" fill="'+v+'" /></g></svg><div class="pulse"></div>'},confirmation:function(){return f.createElement("div",{"class":"issue-reposition-confirmation",html:'<div class="issue-reposition-confirmation-label">'+e.inspect.relocate+"</div>"})},validDnD:function(){return'<span class="dnd-status dnd-status-ok"><span class="fonticon fonticon-check"></span></span>'},invalidDnD:function(){return'<span class="dnd-status dnd-status-ko"><span class="fonticon fonticon-cancel"></span></span>'}};var m=o.extend({name:"DS/Issue3DReview/views/Balloon",tagName:"div",className:"issue-balloon",_logger:null,defaultOptions:{parent:null,viewer:null,window:null,controller:null,isInspected:false},manipulator:null,isSelected:false,isVisible:false,node:null,balloon:null,_preventEvents:false,setup:function(v){var x=this;x._logger=t.getLogger("DS/Issue3DReview/View");x._logger.debug("Setup for balloon %s %s %s for issue %s (%s)",x.model.get("type"),x.model.get("name"),x.model.get("revision"),x.model.get("issue").get("title"),x.model.get("issue").get("name"));c.start(x.name+" setup");x.options=f.merge(v||{},x.defaultOptions);var w=new k();w.name="issue-balloon-3D";w.setVisibilityInTree(false);w.exludeFromBounding(true);w._excludeFromCSO=true;x.options.viewer.addNode(w,false);x.manipulator=null;x.isSelected=false;x.isVisible=false;x.node=w;x.balloon=null;x._preventEvents=false;x._subscribers();c.end(x.name+" setup")},destroy:function(){var v=this;v.stopListening(v.model,"onChange");return v.hide().then(function(){if(v.balloon!==null){v.balloon.html.destroy();v.balloon.node.remove()}if(v.node!==null){v.node.remove()}if(v.manipulator!==null){v.manipulator.destroy()}v.manipulator=null;v.isSelected=false;v.isVisible=false;v.node=null;v.balloon=null;v._preventEvents=false;v.options={}})},render:function(x){var y=this;y._logger.debug("Rendering balloon %s %s %s for issue %s (%s)",y.model.get("type"),y.model.get("name"),y.model.get("revision"),y.model.get("issue").get("title"),y.model.get("issue").get("name"));c.start(y.name+" render");var w=y.model.get("color"),v=y.model.get("default"),z=y.model.get("conflict");if(z>0&&!y.options.isInspected){w=j.CONFLICT_COLOR}if(y.options.isInspected===true){z=0}if(y.options.isInspected===true){if(y.model.get("position")!==null){v=y.model.get("position")}}else{if(z===0&&y.model.get("position")!==null){v=y.model.get("position")}}y.balloon=y.create(y.node,w,v,z);y.manipulator=y.utils.manipulator(y.options.viewer);y.manipulator.attachToBalloon(y);if(z===0&&!y.model.get("temporary")){y.draggable()}y.promiseWhileRendering=y.show().then(function(){var A=function(){};x&&typeof x.callback==="function"?x.callback():A()});c.end(y.name+" render");return y},create:function(B,w,v,C){var A=this;c.start(A.name+" create");var y=u.balloon(w,j.DEFAULT_OPACITY,j.DEFAULT_BORDER,j.DEFAULT_INNER);A.container.setContent(y+'<div class="issue-balloon-information"></div>');var x=new b({html:A.container,name:"issue-balloon-2D"});x.setVisibilityInTree(false);x.exludeFromBounding(true);x.setOffset(new a.Vector2(-j.BALLOON_SIZE.width/2,-j.BALLOON_SIZE.height));x._excludeFromCSO=true;A.container.setOpacity(1);var z=A.container.getElement(".issue-balloon-information");if(C>0){z.setContent(f.createElement("span",{"class":"issue-counter",html:C.toString()}))}B.setMatrix(new a.Matrix4().setPosition(v));x.setNoZ(true);B.addChild(x);c.end(A.name+" create");return{node:x,html:A.container,information:z}},show:function(){var v=this;if(v.isVisible===true){return d.resolve()}return new d(function(x){var w=function(){v.isVisible=true;if(v.balloon===null){x();return}v.balloon.html.removeEventListener("animationend",w);x()};v.balloon.html.addEventListener("animationend",w);v.balloon.html.removeClassName("issue-balloon-animation-hide").addClassName("issue-balloon-animation-show");v.balloon.node.setVisibility(true);v.balloon.html.hidden=false;v.options.viewer.render()})},hide:function(){var v=this;if(v.isVisible===false){return d.resolve()}return new d(function(x){var w=function(){v.isVisible=false;if(v.balloon===null){x();return}v.balloon.html.removeEventListener("animationend",w);v.balloon.node.setVisibility(false);v.balloon.html.hidden=true;v.options.viewer.render();x()};if(v.isBalloonInViewport()===true){v.balloon.html.addEventListener("animationend",w)}else{setTimeout(function(){w()},0)}v.balloon.html.removeClassName("issue-balloon-animation-show").addClassName("issue-balloon-animation-hide")})},over:function(){var v=this;if(v.isSelected===true){return}v.balloon.node.getElement().addClassName("hover")},out:function(){var v=this;if(v.isSelected===true){return}v.balloon.node.getElement().removeClassName("hover")},select:function(){var v=this;v.isSelected=true;v.balloon.node.getElement().addClassName("selection")},unselect:function(){var v=this;v.isSelected=false;v.balloon.node.getElement().removeClassName("selection").removeClassName("hover")},draggable:function(){var y=this;c.start(y.name+" draggable");y.balloon.node.css2DNode.element.ondragstart=null;var x=null;var w=u.validDnD(),v=u.invalidDnD();var A=function(B){var D=y.options.viewer.getMousePosition(new a.Vector2(B.clientX,B.clientY)),F=y.options.viewer.pick(D,"primHybrid",true);if(F.position&&F.path.length){var C=y.options.controller.buildArrayFromPath(F.path[j.PATH_TO_PARSE]).join(","),E=y.model.get("path").join(",");return C.indexOf(E)!==-1?F:null}else{return null}};var z=null;h(y.balloon.html).draggable({delay:j.TIMEOUT_DND,revert:function(){return A({clientX:z.clientX,clientY:z.clientY})===null},revertDuration:j.TIMEOUT_DND*2,cursorAt:{left:j.BALLOON_SIZE.width/2,top:j.BALLOON_SIZE.height},opacity:0.6,drag:function(B){z=B;var C=A({clientX:B.clientX,clientY:B.clientY});if(C!==null){y.balloon.information.setContent(w)}else{y.balloon.information.setContent(v)}},start:function(B,C){x=C.helper.position();y.options.parent.dispatchEvent("onMouseOut",{id:y.model.get("physicalId"),object:y,balloon:y.balloon.html,conflict:y.options.isInspected?0:y.model.get("conflict"),event:B});y._preventEvents=true;y.balloon.information.setContent(w)},stop:function(D){z=D;var F=A({clientX:D.clientX,clientY:D.clientY});if(F===null){y.balloon.information.setContent("");y._preventEvents=false;return}h(y.balloon.html).draggable("disable");y.balloon.node.getElement().addClassName("waiting");var B=u.confirmation(),C=new q({target:y.container,trigger:"manual",position:"right",delay:{show:j.TIMEOUT_DND,hide:j.TIMEOUT_DND},body:B});C.shouldListenForScroll=false;var E=l.subscribe({event:"/VISU/"},function(G){if(G.eventType==="@onViewpointChange"){C.updatePosition()}});new i({value:e.inspect.yes,className:"primary",events:{onClick:function(){y.balloon.node.getElement().removeClassName("waiting");C.destroy();l.unsubscribe(E);y.balloon.information.setContent("");h(y.balloon.html).draggable("enable");y.model.save({position:F.position},{onComplete:function(){y.options.parent.dispatchEvent("onChange:position",{id:y.model.get("id"),physicalId:y.model.get("physicalId"),model:y.model})},onFailure:function(){r.displayNotification({msg:e.notifications.cannotRelocateBalloon,eventID:"error"});h(y.balloon.html).animate({top:x.top,left:x.left},j.TIMEOUT_CLICK)}});y._preventEvents=false}}}).inject(B);new i({value:e.inspect.no,className:"default",events:{onClick:function(){y.balloon.node.getElement().removeClassName("waiting");C.destroy();l.unsubscribe(E);h(y.balloon.html).animate({top:x.top,left:x.left},j.TIMEOUT_CLICK);y.balloon.information.setContent("");h(y.balloon.html).draggable("enable");y._preventEvents=false}}}).inject(B);C.show();C.updatePosition()}});c.end(y.name+" draggable")},isConflicted:function(){var v=this;return v.model.get("conflict")>0},isBalloonInViewport:function(){var w=this;if(!w.balloon||!w.balloon.html){return false}var v=w.balloon.html.getBoundingClientRect();if(v.top===0&&v.left===0&&v.bottom===0&&v.right===0){return false}return(v.top>=0&&v.left>=0&&v.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&v.right<=(window.innerWidth||document.documentElement.clientWidth))},_onChangePosition:function(){var w=this;w._logger.debug("Changing the position for balloon %s %s %s for issue %s (%s)",w.model.get("type"),w.model.get("name"),w.model.get("revision"),w.model.get("issue").get("title"),w.model.get("issue").get("name"));c.start(w.name+" _onChangePosition");var v=w.isVisible;w.hide().then(function(){var x=w.model.get("position")!==null?w.model.get("position"):w.model.get("default");w.node.setMatrix(new a.Matrix4().setPosition(x));w.balloon.html.setStyle("left","initial");w.balloon.html.setStyle("top","initial");w.options.viewer.render();c.end(w.name+" _onChangePosition");return v===true?w.show():d.resolve()})},_onChangeColor:function(){var w=this;w._logger.debug("Changing the color for balloon %s %s %s for issue %s (%s)",w.model.get("type"),w.model.get("name"),w.model.get("revision"),w.model.get("issue").get("title"),w.model.get("issue").get("name"));c.start(w.name+" _onChangeColor");var v=w.isVisible;w.hide().then(function(){var z=w.balloon.html,x=w.model.get("color"),y=w.options.isInspected?0:w.model.get("conflict");x=(y>0)?j.CONFLICT_COLOR:x;z.getElement(".balloon-path").setAttribute("fill",x);c.end(w.name+" _onChangeColor");return v===true?w.show():d.resolve()})},_onChangeConflict:function(){var w=this;w._logger.debug("Changing the conflict for balloon %s %s %s for issue %s (%s)",w.model.get("type"),w.model.get("name"),w.model.get("revision"),w.model.get("issue").get("title"),w.model.get("issue").get("name"));c.start(w.name+" _onChangeConflict");var x=w.balloon.html,v=w.isVisible;w.hide().then(function(){var A="",z="",y=null,B=w.options.isInspected?0:w.model.get("conflict");if(B>0){A=j.CONFLICT_COLOR;z=f.createElement("span",{"class":"issue-counter",html:B.toString()});y=w.model.get("default")}else{A=w.model.get("color");z="";if(w.model.get("position")!==null){y=w.model.get("position")}}x.getElement(".balloon-path").setAttribute("fill",A);w.balloon.information.setContent(z);w.node.setMatrix(new a.Matrix4().setPosition(y));w.options.viewer.render();c.end(w.name+" _onChangeConflict");return v===true?w.show():d.resolve()})},_subscribers:function(){var v=this;v.listenTo(v.model,"onChange:position",v._onChangePosition);v.listenTo(v.model,"onChange:color",v._onChangeColor);v.listenTo(v.model,"onChange:conflict",v._onChangeConflict)},utils:{isMultipleSelection:function(v){var x=false;try{x=v.event.gesture.events[0].event.ctrlKey}catch(w){}if(v.ctrlKey!==undefined){x=v.ctrlKey}return x},manipulator:function(w){var v=s.extend({init:function(x){this._parent(x||{});this.setExclusive(true);this._token=-1;this._subscriberTokens=[]},PrimaryPointerClick:function(y,x,B){this._parent(y,x,B);if(this._token===-1){var A=this;this._token=setTimeout(function(){var C={element:y,event:x,intersection:B,eventChannel:"Click"};A.publish("Click",C);A._token=-1},j.TIMEOUT_CLICK)}else{clearTimeout(this._token);this._token=-1;var z={element:y,event:x,intersection:B,eventChannel:"DblClick"};this.publish("DblClick",z)}},BeginPreactivate:function(y,x,A){this._parent(y,x,A);var z={element:y,event:x,intersection:A,eventChannel:"BeginPreactivate"};this.publish("BeginPreactivate",z)},EndPreactivate:function(y,x,A){this._parent(y,x,A);var z={element:y,event:x,intersection:A,eventChannel:"EndPreactivate"};this.publish("EndPreactivate",z)},attachToBalloon:function(x){this.linkToNode(x.balloon.node);this._subscriberTokens.push(this.subscribe("BeginPreactivate",function(B){if(x._preventEvents===true){return}x.options.parent.dispatchEvent("onMouseOver",{id:x.model.get("physicalId"),object:x,balloon:x.balloon.html,conflict:x.options.isInspected?0:x.model.get("conflict"),event:B})}));this._subscriberTokens.push(this.subscribe("EndPreactivate",function(B){if(x._preventEvents===true){return}x.options.parent.dispatchEvent("onMouseOut",{id:x.model.get("physicalId"),object:x,balloon:x.balloon.html,conflict:x.options.isInspected?0:x.model.get("conflict"),event:B})}));this._subscriberTokens.push(this.subscribe("Click",function(B){if(x._preventEvents===true){return}x.options.parent.dispatchEvent("onClick",{id:x.model.get("physicalId"),object:x,balloon:x.balloon.html,conflict:x.options.isInspected?0:x.model.get("conflict"),isMultipleSelection:x.utils.isMultipleSelection(B),event:B})}));this._subscriberTokens.push(this.subscribe("DblClick",function(B){if(x._preventEvents===true){return}x.options.parent.dispatchEvent("onDoubleClick",{id:x.model.get("physicalId"),object:x,balloon:x.balloon.html,conflict:x.options.isInspected?0:x.model.get("conflict"),isMultipleSelection:x.utils.isMultipleSelection(B),event:B})}));x.balloon.html.addEventListener("contextmenu",function(B){if(x._preventEvents===true){return false}B.preventDefault();B.stopPropagation();x.options.parent.dispatchEvent("onContextMenu",{id:x.model.get("physicalId"),object:x,balloon:x.balloon.html,conflict:x.options.isInspected?0:x.model.get("conflict"),isMultipleSelection:x.utils.isMultipleSelection(B),event:B});return false});x.balloon.html.addEventListener(g.LONGHOLD,function(B){if(x._preventEvents===true){return false}if(g.isTouchEvent(B)){B.preventDefault();B.stopPropagation();x.options.parent.dispatchEvent("onContextMenu",{id:x.model.get("physicalId"),object:x,balloon:x.balloon.html,conflict:x.options.isInspected?0:x.model.get("conflict"),isMultipleSelection:x.utils.isMultipleSelection(B),event:B})}return false});var A=0;var z=0;var y=0;x.balloon.html.addEventListener("touchstart",function(E){if(E.touches&&E.touches.length===1){var F=new Date().getTime();var D=F-A;var C=Math.abs(z-E.touches[0].clientX);var B=Math.abs(y-E.touches[0].clientY);if(C<10&&B<10&&D<500){E.preventDefault()}z=E.touches[0].clientX;y=E.touches[0].clientY;A=F}})},destroy:function(){var x=this;x._subscriberTokens.forEach(function(y){x.unsubscribe(y)})}});return new v({viewer:w})}}});return m});define("DS/Issue3DReview/commands/Reset",["UWA/Class","DS/ApplicationFrame/Command"],function(b,c){var a=b.extend(c,{execute:function(){require(["DS/PADUtils/views/PADAlert","DS/Issue3DReview/commands/CommandsManager","DS/IssueServices/Contexts","i18n!DS/Issue3DReview/assets/nls/Issue3DReview"],function(e,h,d,i){var g=d.get("component");if(g.isProcessing()){e.displayNotification({msg:i.notifications.commandAlreadyProcessing,eventID:"info"});return}var f=d.get("application");f.clear().then(function(){var j=h.getCommand("RemoveAllHdr");j.begin()})})}});return a});define("DS/Issue3DReview/components/header/Filter",["UWA/Class/Promise","UWA/Class/View","UWA/Core","DS/UIKIT/DropdownMenu","DS/UIKIT/Iconbar","DS/UIKIT/Input/Toggle","DS/PADUtils/views/PADAlert","DS/IssueServices/Contexts","DS/IssueServices/utils/Performance","i18n!DS/Issue3DReview/assets/nls/Issue3DReview"],function(j,b,h,a,g,k,c,f,e,l){var i={TIMEOUT_SYNCHRONIZE:1000};var d=b.extend({name:"DS/Issue3DReview/components/header/Filter",tagName:"div",className:"filter-container",_logger:null,elements:{bar:null,menu:null},filter:{},setup:function(m){var n=this;e.start(n.name+" setup");n._parent(m);n.elements={bar:null,menu:null};e.end(n.name+" setup")},render:function(){var o=this;e.start(o.name+" render");var p=f.get("widget");o.elements.bar=new g({renderTo:o.container,items:[{name:"Filter",fonticon:"search-filter",text:l.filter.title,handler:function(){}}]});var n=JSON.parse(p.getValue("filter"));o.elements.menu=new a({target:o.elements.bar.getItem("Filter").elements.icon,multiSelect:true,closeOnClick:false,items:[{text:l.filter.synchronize.header,className:"header"},{name:"synchronize",text:l.filter.synchronize.title,selectable:true,selected:n.synchronize===true,disabled:false},{className:"divider"},{name:"owned",text:l.filter.owned,selectable:true,selected:n.owned===true,disabled:n.synchronize===true},{name:"assigned",text:l.filter.assigned,selectable:true,selected:n.assigned===true,disabled:n.synchronize===true},{className:"divider"},{name:"others",text:l.filter.others.title,fonticon:"menu",items:[{name:"reported",text:l.filter.others.reported,selectable:true,selected:n.reported===true,disabled:n.synchronize===true},{name:"responsible",text:l.filter.others.responsible,selectable:true,selected:n.responsible===true,disabled:n.synchronize===true},{name:"participated",text:l.filter.others.participated,selectable:true,selected:n.participated===true,disabled:n.synchronize===true},{className:"divider"},{name:"closed",text:l.filter.others.closed,selectable:true,selected:n.closed===true,disabled:n.synchronize===true}]}],events:{onClick:function(r,q){var s=new j(function(x){if(q.name==="synchronize"){o.elements.menu.items.forEach(function(y){if(y.name!=="synchronize"&&y.name!=="others"){q.selected===true?o.elements.menu.disableItem(y.name):o.elements.menu.enableItem(y.name)}});if(q.selected===true){var u=f.get("component");var t=false;u.taskManager.addPreferencesTask(function(z){var y=JSON.parse(z.preferences);y.forEach(function(A){if(A.name==="filter"){if(p.getValue("filter")!==A.value){var B=JSON.parse(A.value);B.synchronize=true;t=true;x(JSON.stringify(B))}}})});setTimeout(function(){if(t===false){c.displayNotification({msg:l.filter.synchronize.timeout,eventID:"info"});x("")}},i.TIMEOUT_SYNCHRONIZE)}else{var w=JSON.parse(p.getValue("filter"));w.synchronize=false;x(JSON.stringify(w))}}else{var v={};o.elements.menu.getSelectedItems().forEach(function(y){v[y.name]=true});x(JSON.stringify(v))}});s.then(function(t){o.elements.menu.hide();if(t!==""){p.setValue("filter",t);setTimeout(function(){f.get("application").refresh()},0)}})}}});var m=p.getValue("roots");if(Array.isArray(m)&&m.length>0){o.elements.menu.addItem({className:"divider"});o.elements.menu.addItem({name:"session",text:l.replace(l.filter.session,{number:m.length}),selectable:true,selected:n.session===true})}e.end(o.name+" render");return o},refresh:function(){var m=this;m.destroy();m.render()},destroy:function(){var m=this;m.elements.menu.hide();m.elements={bar:null,menu:null};m.container.empty()}});return d});define("DS/Issue3DReview/commands/Clear",["UWA/Class","DS/ApplicationFrame/Command"],function(a,c){var b=a.extend(c,{execute:function(){require(["DS/IssueServices/Contexts"],function(d){var e=d.get("application");e.clear()})}});return b});define("DS/Issue3DReview/commands/Display",["UWA/Class","DS/ApplicationFrame/CommandCheckHeader"],function(a,c){var b=a.extend(c,{init:function(d){var e=this;e._parent(d,{});require(["UWA/Core","DS/Controls/Loader","DS/PADUtils/views/PADAlert","DS/IssueServices/Contexts","i18n!DS/Issue3DReview/assets/nls/Issue3DReview"],function(j,h,g,i,n){var k=function(o){var p=i.get("application");if(o===true){p.display()}else{p.clear()}};var l=false;var m=e.onStateChange(function(){if(l===true){l=false;return}var p=i.get("component");var o=false;if(p.isProcessing()){g.displayNotification({msg:n.notifications.commandAlreadyProcessing,eventID:"info"});l=true;o=localStorage.getItem("Issue3DReviewDisplay")==="true";e.setState(o,true);return}o=localStorage.getItem("Issue3DReviewDisplay")==="true";if(o===e.getState()){return}localStorage.setItem("Issue3DReviewDisplay",e.getState()?"true":"false");o=localStorage.getItem("Issue3DReviewDisplay")==="true";k(o)});e._destroy=function(){e._modelEvents.unsubscribe(m)};var f=localStorage.getItem("Issue3DReviewDisplay")==="true";l=true;e.setState(f,true)})}});return b});define("DS/Issue3DReview/commands/Inspect",["UWA/Class","DS/ApplicationFrame/Command"],function(a,b){var c=a.extend(b,{execute:function(){require(["DS/IssueServices/Contexts"],function(d){var f=d.get("component");var e=f.getSelectedIssues(),h=[];for(var g=0;g<e.length;g++){h.push(e[g].id)}f.inspect(h)})}});return c});define("DS/Issue3DReview/Issue3DReview",["UWA/Class","UWA/Class/Promise","UWA/Core","DS/IssueComponents/utils/Utils","DS/IssueServices/Contexts","DS/IssueServices/services/IssueServices","DS/IssueServices/services/PlatformServices","DS/IssueServices/utils/Migration","DS/IssueServices/utils/Performance","DS/IssueServices/utils/Support","i18n!DS/Issue3DReview/assets/nls/Issue3DReview","css!DS/Issue3DReview/Issue3DReview.css"],function(d,m,j,l,g,i,c,b,f,h,n){var k={TIMEOUT_LOADER:1000,CONTENT_ID_SEARCH:"X3DContentId",ON_PREMISE_TENANT:"OnPremise",CLOUD_TENANT:"Cloud"};var a={placeholder:function(){return j.createElement("div",{"class":"issue-3d-placeholder fade-in-element",html:['<div class="pin"><span class="fonticon fonticon-5x fonticon-location"></span></div>','<div class="pulse"></div>']})},error:function(){return j.createElement("div",{"class":"loading-error-container",html:j.createElement("div",{"class":"loading-error",html:[j.createElement("div",{"class":"loading-error-label",html:n.error.label}),j.createElement("div",{"class":"loading-error-sub-label",html:n.error.sub})]})})}};var e=d.extend({name:"DS/Issue3DReview/Issue3DReview",pad3DViewer:null,component:null,filter:null,elements:{header:null},isLoaded:null,_deferred:{resolve:null,reject:null},_placeholder:null,init:function(){var o=this;g.add("widget",window.widget);g.get("widget").name="ENX3DIR_AP";g.add("application",o);o.component=null;o.filter=null;o.isLoaded=new m(function(q,p){o._deferred.resolve=q;o._deferred.reject=p});o._placeholder=a.placeholder();o._subscribers()},onLoad:function(){var p=this;f.start(p.name+" onLoad");g.get("widget").body.setContent(p._placeholder);try{h.checkBrowserSupport()}catch(o){}if(!b.isUpToDate()){b.upgrade();return}g.get("widget").body.addEventListener("drop",function(q){q.preventDefault();q.stopPropagation()});c.initPlatformServices().then(function(){try{h.checkSwymSupport()}catch(q){}var r=c.getSecurityContexts(),s=c.getTenants();return p._setPreferences({securityContexts:r,tenants:s})}).then(function(){return p._initializePAD3DViewer()}).then(function(){p._computeFilter()}).then(function(){return p._initializeComponent({})}).then(function(){f.end(p.name+" onLoad");p._deferred.resolve()},function(q){f.end(p.name+" onLoad");p._deferred.reject(q);g.get("widget").body.appendChild(a.error())})},onRefresh:function(){var o=this;o.component.clear().then(function(){var p=g.get("widget").getValue("enopad3dviewer_CGRorTHB");var q=j.is(p,"boolean")?p:p==="true";o.pad3DViewer.setDefaultStreamToLoad(q);o.pad3DViewer.refresh()})},onResize:function(){},onDestroy:function(){var o=this;if(o.filter!==null){o.filter.destroy()}o.filter=null;g.remove("filter");if(o.component!==null){o.component.destroy()}o.component=null;g.remove("component");if(o.pad3DViewer!==null){o.pad3DViewer.destroy()}o.pad3DViewer=null;g.remove("pad3DViewer");o.hud.destroy();g.remove("application");g.remove("widget")},onTitleChange:function(){var p=this;var q=g.get("widget"),r=p.getTitle();if(p.component.isDisplayed()===false){r+=" - "+n.titles.issuesNotDisplayed}else{var o=Object.keys(p.component.getIssues().map);if(o.length===0){r+=" - "+n.titles.noIssuesToShow}else{r+=" ("+o.length+")"}}if(q.getTitle()!==r){q.setTitle(r)}},display:function(){var o=this;if(o.component.isDisplayed()){o.hud.on(n.notifications.lookingIssues);return o.component.clear().then(function(){o.hud.update(n.notifications.lookingIssues,"50");return o.component.display(o.pad3DViewer.getController().getRoots())}).then(function(){o.hud.update(o.hud.getHUDLabel(),"100");o.onTitleChange();if(o.component.isFocused()){o.component.focus()}o.hud.off()})}else{o.hud.on(o.hud.getHUDLabel(),"100");o.onTitleChange();o.hud.off();return m.resolve()}},clear:function(){var o=this;var p=g.get("widget");p.setTitle(o.getTitle()+" - "+n.notifications.clearIssues);o.hud.on(n.notifications.clearIssues,"50");return o.component.clear().then(function(){o.hud.update(n.notifications.clearIssues,"100");o.onTitleChange();o.hud.off()})},refresh:function(){var p=this;var q=g.get("widget");q.setTitle(p.getTitle()+" - "+n.notifications.refreshIssues);p.hud.on(n.notifications.refreshIssues,"50");var o=p.pad3DViewer.getController().getRoots();return p.component.refresh(o).then(function(){p.hud.update(p.hud.getHUDLabel(),"100");p.onTitleChange();p.hud.off()})},getTitle:function(){var q=g.get("widget");var o=q.getValue("title"),p=q.getPreference("title");if(q&&p){o=o&&o.trim();o=o||p.defaultValue;return o}return n.preferences.name["default"]},_initializePAD3DViewer:function(){var q=this;var r=g.get("widget");var o=null,p=null;return new m(function(s){require(["DS/Issue3DReview/PAD3DViewer","text!DS/Issue3DReview/assets/Issue3DReview.3D.json"],function(u,t){o=u;p=t;s()})}).then(function(){return new m(function(v){var s=r.getValue("enopad3dviewer_CGRorTHB");var t=j.is(s,"boolean")?s:s==="true";q.pad3DViewer=new o({widget:r,windowOptions:JSON.parse(p),actionbar_corrected:true,interwidgetComAvailability:true,enableFiltering:true,loadCGRAsDefaultStream:t,loadingDelegations:{_Issue:function(w){require(["DS/PADUtils/views/PADAlert"],function(x){if(j.is(w.objectId,"string")&&w.objectId!==""){i.issues.retrieve({data:{objects:[{physicalId:w.objectId}]},onComplete:function(A){var z=A[0].body;var y=z.reportedAgainst.map(function(B){return{path:[B.physicalId]}});q.pad3DViewer.addRoots({objects:y})},onFailure:function(){x.displayNotification({msg:n.notifications.serverError,eventID:"error"})}})}else{x.displayNotification({msg:n.notifications.serverError,eventID:"error"})}})}}});g.add("pad3DViewer",q.pad3DViewer);var u=false;q.pad3DViewer.subscribe({event:"onReady"},function(w){if(u===true){return}u=true;r.setBody(w.render());q._placeholder.destroy();v(w)})})}).then(function(t){var u=r.getValue("Issue3DReviewViewerPathsInSession");u=u?JSON.parse(u):[];var s=r.getValue("Issue3DReviewViewerRootsDetached");s=s?JSON.parse(s):[];return new m(function(w){if(u&&u.length>0){setTimeout(function(){t.getController().addRoots({paths:u,pids_hidden:s},false,false)},0);var v=t.subscribe({event:"onLoadingComplete"},function(){t.unsubscribe(v);w(t)})}else{w(t)}})}).then(function(t){var s=function(u){r.setValue("Issue3DReviewViewerPathsInSession",JSON.stringify(u.rootLog))};t.subscribe({event:"onLoadingComplete"},function(){if(q.component===null){return}if(q.component.isDisplayed()&&!q.component.isInspected()){q.display()}});t.subscribe({event:"onRootAdded"},function(u){if(q.component===null){s(u);return}if(!q.component.isInspected()){s(u)}});t.subscribe({event:"onRootRemoved"},function(u){if(q.component===null){s(u);return}if(!q.component.isInspected()){s(u)}});t.subscribe({event:"onRootAttached"},function(v){var u=r.getValue("Issue3DReviewViewerRootsDetached");u=u?JSON.parse(u):[];u.some(function(x,w){if(x===v.id){u.splice(w,1);r.setValue("Issue3DReviewViewerRootsDetached",JSON.stringify(u));return true}return false})});t.subscribe({event:"onRootDetached"},function(v){var u=r.getValue("Issue3DReviewViewerRootsDetached");u=u?JSON.parse(u):null;if(u===null){u=[]}if(!u.some(function(w){return w===v.id})){u.push(v.id);r.setValue("Issue3DReviewViewerRootsDetached",JSON.stringify(u))}})})},_initializeComponent:function(){var s=this;var p=null,t=null,r=null,q=null,o=null;return new m(function(u){require(["DS/PADUtils/views/PADAlert","DS/PADUtils/views/PADStatusInfos","DS/Issue3DReview/commands/CommandsManager","DS/Issue3DReview/Component","DS/Issue3DReview/components/header/Filter"],function(x,w,v,z,y){p=x;t=w;r=v;q=z;o=y;u()})}).then(function(){s.elements.header=j.createElement("div",{"class":"im-3d-header"});s.elements.header.inject(g.get("pad3DViewer").getContent());s.filter=new o().render();g.add("filter",s.filter);return s.hud.init().then(function(u){s.filter.inject(s.elements.header);u.container.inject(s.elements.header)})}).then(function(){s.component=new q({events:{onIssuesAdded:function(){s.onTitleChange()},onIssuesRemoved:function(){s.onTitleChange()}}});g.add("component",s.component);r.select(null);s.pad3DViewer.elements.padstatus.destroy();s.pad3DViewer.elements.status=new t({renderTo:s.pad3DViewer.getContent(),events:{onShow:function(){f.start(s.name+" render status");var x=s.component.getIssues().map,y=s.component.getSelectedIssues();var w=j.createElement("div",{"class":"im-status-msg"});j.createElement("div",{"class":"im-status-msg-issues",text:n.replace(n.titles.issues,{number:Object.keys(x).length})}).inject(w);j.createElement("div",{"class":"im-status-msg-selection",text:n.replace(n.tooltips.selectedIssues,{number:Object.keys(y).length})}).inject(w);s.pad3DViewer.elements.status.setStatus(w);f.end(s.name+" render status")}}});var v=s.pad3DViewer.addRootNodesFromContent;var u=function(w){if(s.component.isInspected()){p.displayNotification({msg:n.notifications.dropPreventedForInspection,eventID:"info"})}else{s.pad3DViewer.addRootNodesFromContent=v;s.pad3DViewer.addRootNodesFromContent(w);s.pad3DViewer.addRootNodesFromContent=u}};s.pad3DViewer.addRootNodesFromContent=u;s.display()})},_setPreferences:function(o){var p=this,q=g.get("widget");if(j.is(o.securityContexts,"object")){q.addPreference({name:"securityContext",type:"list",label:n.preferences.securityContext,options:o.securityContexts.cspaces,defaultValue:o.securityContexts.securityContext});p._setENOPADSecurityContext()}if(c.isCloudEnvironment()===true&&j.is(o.tenants,"object")){q.addPreference({name:"x3dPlatformId",type:"list",label:n.preferences.tenant,options:o.tenants.platforms,defaultValue:o.tenants.tenant})}q.addPreference({name:"title",type:"text",label:n.preferences.name.title,onchange:"onTitleChange",defaultValue:n.preferences.name["default"]});q.addPreference({name:"validation",type:"boolean",label:n.preferences.validation,defaultValue:"false"});q.addPreference({name:"activateBIFilter",type:"boolean",label:n.preferences.tagger,defaultValue:"true"});if(c.isCloudEnvironment()!==true){q.addPreference({name:"enopad3dviewer_CGRorTHB",type:"boolean",label:n.preferences.stream,defaultValue:"false"})}q.addPreference({name:"filter",type:"hidden",defaultValue:JSON.stringify({owned:true,assigned:true,reported:false,responsible:false,participated:false,closed:false,synchronize:false})});q.addPreference({name:"Issue3DReviewViewerPathsInSession",type:"hidden"});q.addPreference({name:"Issue3DReviewViewerRootsDetached",type:"hidden"});return q.getPreferences()},_computeFilter:function(){var p=this;try{var q=g.get("widget");var r=(q.getValue(k.CONTENT_ID_SEARCH))?JSON.parse(q.getValue(k.CONTENT_ID_SEARCH)):null;q.deleteValue(k.CONTENT_ID_SEARCH);if(r!==null){p.pad3DViewer.addRootNodesFromContent({json3DXContent:r,dispatch:false})}c.getCompassPubSub().publish("resetX3DContent")}catch(o){}},_subscribers:function(){var o=this;var p=g.get("widget");p.addEvent("onLoad",o.onLoad.bind(o));p.addEvent("onRefresh",o.onRefresh.bind(o));p.addEvent("onResize",o.onResize.bind(o));p.addEvent("onDestroy",o.onDestroy.bind(o));p.addEvent("onTitleChange",o.onTitleChange.bind(o));p.body.addEventListener("contextmenu",function(q){q.preventDefault()},o);p.addEvent("endEdit",function(){o._setENOPADSecurityContext()})},_setENOPADSecurityContext:function(){var p=g.get("widget");try{if(p.getPreference("securityContext")){var q=p.getPreference("securityContext").value;require(["DS/PADUtils/PADSettingsMgt"],function(r){r.setSetting("pad_security_ctx",q)});sessionStorage.setItem("PADSecurityCtx",q);p.setValue("pad_security_ctx",q)}}catch(o){}},hud:{_loader:null,_container:null,init:function(){var p=this;if(j.is(p._loader,"object")){return m.resolve({loader:p._loader,container:p._container})}var o=null;return new m(function(q){require(["DS/Controls/Loader"],function(r){o=r;q()})}).then(function(){p._container=j.createElement("div",{"class":"issue-3d-review-display-loader fade-in-element"});p._loader=new o({text:"",fadeDuration:k.TIMEOUT_LOADER,showButtonFlag:false});p._loader.inject(p._container);return{loader:p._loader,container:p._container}})},on:function(q,p){var s=this;var o="",r="0";o=j.is(q,"string")?q:"";r=j.is(p,"string")?p:"0";s._loader.on();s._loader.elements.label.innerHTML=o;s._loader.update(r)},off:function(){var o=this;setTimeout(function(){var p=new j.Fx(o._loader.elements.container,{duration:k.TIMEOUT_LOADER,transition:"linear",events:{onStart:function(){},onComplete:function(){if(j.is(o._loader,"object")){o._loader.off()}}}});p.start({opacity:[1,0]})},0)},update:function(p,o){var q=this;q._loader.elements.label.innerHTML=p;q._loader.update(o)},destroy:function(){var o=this;if(j.is(o._loader,"object")){o._loader.destroy();o._container.destroy()}o._loader=null;o._container=null},getHUDLabel:function(){var p=g.get("component");if(p.isDisplayed()===false){return n.titles.issuesNotDisplayed}var o=Object.keys(p.getIssues().map).length,q="";if(o===0){q=n.titles.noIssuesToShow}else{q=n.replace(n.titles.issues,{number:o})}return q}}});return e});define("DS/Issue3DReview/commands/Focus",["UWA/Class","DS/ApplicationFrame/CommandCheckHeader"],function(a,c){var b=a.extend(c,{init:function(d){var e=this;e._parent(d,{});require(["DS/PADUtils/views/PADAlert","DS/Issue3DReview/utils/ViewerManipulator","DS/IssueServices/Contexts","i18n!DS/Issue3DReview/assets/nls/Issue3DReview"],function(j,h,f,l){var i=function(n){var o=f.get("component");h.focus({application:o.context.root,toggle:n,neutrals:o.getManager().getNeutralNodes(),reported:o.getManager().getReportedNodes()})};var m=false;var k=e.onStateChange(function(){if(m===true){m=false;return}var n=false;var o=f.get("component"),p=o!==null?o.getManager():null;if(o===null||p===null){j.displayNotification({msg:l.notifications.noIssuesInSession,eventID:"info"});m=true;n=localStorage.getItem("Issue3DReviewDisplay")==="true";e.setState(n,true);return}if(o.isProcessing()){j.displayNotification({msg:l.notifications.commandAlreadyProcessing,eventID:"info"});m=true;n=localStorage.getItem("Issue3DReviewDisplay")==="true";e.setState(n,true);return}n=localStorage.getItem("Issue3DReviewFocus")==="true";if(n===e.getState()){return}localStorage.setItem("Issue3DReviewFocus",e.getState()?"true":"false");n=localStorage.getItem("Issue3DReviewFocus")==="true";i(n)});e._destroy=function(){e._modelEvents.unsubscribe(k)};var g=localStorage.getItem("Issue3DReviewFocus")==="true";m=true;e.setState(g,true)})}});return b});define("DS/Issue3DReview/utils/ViewerManipulator",["UWA/Class/Promise","UWA/Core","DS/UIKIT/Input/Button","DS/ENOFloatingPanel/ENOFloatingPanel","DS/Logger/Logger","DS/PADUtils/views/PADAlert","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/ThreeJS_DS","DS/Issue3DReview/commands/CommandsManager","DS/IssueServices/Contexts","DS/IssueServices/utils/Performance","i18n!DS/Issue3DReview/assets/nls/Issue3DReview"],function(d,f,k,l,p,o,n,a,b,h,c,e){var t="DS/Issue3DReview/utils/ViewerManipulator";var m={ROOT_INDEX:0,FIRST_ELEMENT_IN_PATH:0,ESCAPE_KEY:27};var g=false;var j=null,q=null;var s={bar:function(){return f.createElement("ul",{"class":"task-manager-cancel is-ground-level"})},exit:function(){return f.createElement("li",{id:"task-manager-cancel-exit","class":"task-manager-cancel home-section",html:'<span class="home-section wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-move-to-start"></span>'})},info:function(){return f.createElement("li",{id:"task-manager-cancel-info","class":"task-manager-cancel first-crumb crumbs-with-home",html:"<p>"+e.tasks.cancel+"</p><span></span>"})}};var i=p.getLogger(t);var r={focus:function(I){var F=I.application,A=I.toggle,v=I.neutrals,D=I.reported;var z=h.get("component").get3DContext().controller;if(g===true){return false}c.start(t+" focus");g=true;var B=F.getViewer().getSceneGraphOverrideSetManager();var G=new n(F.getRootBagPath().externalPath[m.ROOT_INDEX]);B.pushSceneGraphOverrideSet(G);var u=[];var x=Object.keys(v);for(var y=0;y<x.length;y++){u.push(v[x[y]].path)}if(A===false){if(j!==null){j.setOpacity(1,true);G.deleteOverride(j);j=null}}else{if(j===null){j=G.createOverride({pathes:u})}j.setOpacity(0.15,false)}var C=[];var E=Object.keys(D);for(var w=0;w<E.length;w++){var H=z.buildPathFromArray(E[w].split(","));C.push(H)}if(q!==null){G.deleteOverride(q);q=null}q=G.createOverride({pathes:C});q.setOpacity(1,true);F.getViewer().render();g=false;c.end(t+" focus");return true},selectIn3D:function(I,v){var C=this;var x=h.get("widget"),F=h.get("component");var G=F.get3DContext();var E=null,D=null,P=null,y=null,H=null,A=null,w=null,B=null,z=null;var L=f.createElement("div",{"class":"task-manager-cancel-container"});var M=s.bar(),J=s.exit(),N=s.info();M.appendChild(J);M.appendChild(N);J.addEventListener("click",function(){H()});L.appendChild(M);x.body.insertBefore(L,x.body.firstChild);var u=f.createElement("div",{id:"vertical-line-select-reported"}),O=f.createElement("div",{id:"horizontal-line-select-reported"});x.body.appendChild(u);x.body.appendChild(O);var K=null;E=function(){if(z!==null){return}u.setStyle("display","initial");O.setStyle("display","initial")};D=function(R){if(z!==null){return}var U=R.clientX||R.pageX;var S=R.clientY||R.pageY;u.setStyle("left",U);O.setStyle("top",S);var Q=G.viewer.getMousePosition(new a.Vector2(U,S)),T=G.viewer.pick(Q,"primHybrid",true);if(T.position&&T.path.length){u.setStyle("background-color","#57B847");O.setStyle("background-color","#57B847");K=T}else{u.setStyle("background-color","#E87B00");O.setStyle("background-color","#E87B00");K=null}};P=function(){if(z!==null){return}u.setStyle("display","none");O.setStyle("display","none");K=null};H=function(){K=null;A(true)};w=function(Q){if(Q.keyCode===m.ESCAPE_KEY&&document.activeElement===Q.target){K=null;A(true)}};y=function(R){if(z!==null){return}D(R);if(!K||!K.position||!K.path.length){return}var Q=function(){try{var aa=null,U=null,ad=[];ad=G.controller.buildArrayFromPath(K.path[m.FIRST_ELEMENT_IN_PATH]);var W=[];W=f.clone(ad);for(var X=ad.length-1;X>=0;X--){var V=G.controller.buildPathFromArray(W);if(aa===null){if(V&&V.externalPath.length>0&&V.getLastElement().isPLMReference()===true){aa=ad[X]}else{W.pop()}}}if(W.length>1){U=W[m.FIRST_ELEMENT_IN_PATH]}var Z={x:K.position.x,y:K.position.y,z:K.position.z};var ac=h.get("component");var T=ac.getManager().getNodesById(aa);var S=T.paths.find(function(ae){return f.Array.equals(W,ae)});if(!Array.isArray(S)){i.warn("The path of the selected object is undefined, the position might be incorrect")}var Y={};C.convertAbsoluteToRelativePosition(S,Z).then(function(ae){Y[aa]={x:ae.position.x,y:ae.position.y,z:ae.position.z,balloons:[]};A(false);I(aa,Y,T,U)})}catch(ab){o.displayNotification({msg:e.notifications.notValidReportedAgainst,eventID:"info"})}};if(R.type==="touchstart"){R.preventDefault();z=new l({animate:true,autocenter:true,closable:true,limitParent:true,overlay:true,resizable:true,visible:true,className:"confirm-select-in-3d-dialog",title:e.selectIn3D.confirmTitle,header:null,body:e.selectIn3D.confirmBody,footer:[new k({value:e.selectIn3D.confirmOK,className:"primary",events:{onClick:function(){Q();setTimeout(function(){z.destroy();z=null},100)}}}),new k({value:e.selectIn3D.confirmCancel,className:"default",events:{onClick:function(){setTimeout(function(){z.destroy();z=null},100)}}})],events:{onClose:function(){setTimeout(function(){z.destroy();z=null},100)}}}).inject(x.body)}else{Q()}};B=function(Q){Q.preventDefault();Q.stopPropagation()};A=function(Q){u.destroy();O.destroy();x.body.removeEventListener("mouseenter",E);x.body.removeEventListener("mousemove",D);x.body.removeEventListener("mouseleave",P);x.body.removeEventListener("click",y);x.body.removeEventListener("touchstart",y);x.body.removeEventListener("touchend",B);x.body.removeEventListener("touchmove",B);x.body.removeEventListener("contextmenu",H);document.removeEventListener("keydown",w);if(z!==null){z.destroy();z=null}b.enableAll();L.destroy();if(Q&&v){v()}};x.body.addEventListener("mouseenter",E);x.body.addEventListener("mousemove",D);x.body.addEventListener("mouseleave",P);x.body.addEventListener("click",y);x.body.addEventListener("touchstart",y);x.body.removeEventListener("touchend",B);x.body.removeEventListener("touchmove",B);x.body.addEventListener("contextmenu",H);document.addEventListener("keydown",w);b.disableAll();return A},convertAbsoluteToRelativePosition:function(v,u){return new d(function(w){require(["DS/Issue3DReview/models/Marker"],function(x){var y=new x({id:Date.now().toString(),name:"",title:"",state:"",description:"",path:v});var z=y.utils.convert(y,{position:u});w(z)})})}};return r});define("DS/Issue3DReview/views/Conflict",["UWA/Class","UWA/Class/Promise","UWA/Class/View","UWA/Core","DS/Issue3DReview/views/Balloon","i18n!DS/Issue3DReview/assets/nls/Issue3DReview","css!DS/Issue3DReview/Issue3DReview.css"],function(a,c,f,g,b,e){var d=f.extend({name:"DS/Issue3DReview/views/Conflict",tagName:"div",className:"issue-balloon"});return d});define("DS/Issue3DReview/views/Inspector",["UWA/Class","UWA/Class/Promise","UWA/Class/View","UWA/Core","DS/UIKIT/Input/Toggle","DS/UIKIT/Mask","DS/UIKIT/Tooltip","DS/Logger/Logger","DS/PADUtils/views/PADAlert","DS/Issue3DReview/commands/CommandsManager","DS/IssueServices/Contexts","DS/IssueServices/utils/Performance","i18n!DS/Issue3DReview/assets/nls/Issue3DReview","css!DS/Issue3DReview/Issue3DReview.css"],function(e,m,d,j,o,i,n,h,c,b,g,f,p){var k={TIMEOUT_UNCHECK:300};var a={bar:function(){return j.createElement("ul",{"class":"navigation-inspect-mode is-ground-level"})},exit:function(){return j.createElement("li",{id:"navigation-inspect-exit","class":"navigation-inspect-mode home-section",html:'<span class="home-section wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-move-to-start"></span>'})},back:function(){return j.createElement("li",{id:"navigation-inspect-back","class":"navigation-inspect-mode home-section",html:'<span class="home-section wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-back "></span>'})},info:function(q){return j.createElement("li",{id:"navigation-inspect-info","class":"navigation-inspect-mode first-crumb crumbs-with-home",html:"<p>"+p.replace(p.inspect.title,{number:q.number})+"</p><span></span>"})}};var l=d.extend({name:"DS/Issue3DReview/views/Inspector",tag:"div",className:"inspect-options-container",_logger:null,manager:null,elements:{bar:null,info:null,context:null,related:null,tooltips:[]},isProcessing:false,isInspectioneering:false,isInContext:false,isRelatedSwitch:false,_toBeRemovedAtRelease:{contexts:[],resolvedBy:[]},_inspectedIssues:{},_currentLevel:-1,_restoreFocus:false,_levels:{},_session:{nodes:{inspected:[],added:[],showed:[]},issues:[]},defaultOptions:{manager:null},setup:function(q){var r=this;r._logger=h.getLogger("DS/Issue3DReview/View");r._parent(q);r.manager=r.getOption("manager");r.elements={bar:null,info:null,context:null,related:null,tooltips:[]};r.reset();return r},render:function(){var u=this;var t=a.bar(),s=a.exit(),r=a.back(),v=a.info({number:Object.keys(u._inspectedIssues).length});u.elements.bar=t;u.elements.info=v;t.appendChild(s);t.appendChild(r);t.appendChild(v);s.addEventListener("click",function(){b.getCommand("Release").begin()});s.addEventListener("touchstart",function(w){w.preventDefault();b.getCommand("Release").begin()});r.addEventListener("click",function(){u._goToLevel(u._currentLevel-1)});r.addEventListener("touchstart",function(w){w.preventDefault();u._goToLevel(u._currentLevel-1)});v.addEventListener("click",function(){});u.container.appendChild(t);u.elements.context=new o({type:"switch",value:"with-context",label:p.inspect.withContext,disabled:true,events:{onChange:function(){if(this.isChecked()===true&&u.isInContext===false){u.showContext()["catch"](function(){setTimeout(function(){u.elements.context.uncheck()},k.TIMEOUT_UNCHECK)})}else{u.hideContext()}}}}).inject(u.container);u.elements.tooltips.push(new n({position:"top",target:u.elements.context.elements.container,body:p.inspect.withContextTooltip}));u.elements.related=new o({type:"switch",disabled:true,label:p.inspect.switchRelated,events:{onChange:function(){u.switchRelatedObjects()["catch"](function(){setTimeout(function(){u.elements.related.uncheck()},k.TIMEOUT_UNCHECK)})}}}).inject(u.container);u.elements.tooltips.push(new n({position:"top",target:u.elements.related.elements.container,body:p.inspect.switchRelatedTooltip}));var q=u.manager.options.context.root.getFrameWindow().elements.container;q.insertBefore(u.container,q.firstChild);return u},destroy:function(){var q=this;q.reset();q.manager=null;q.elements.tooltips.forEach(function(r){r.destroy()});q.elements={bar:null,info:null,context:null,related:null,tooltips:[]}},reset:function(){var q=this;q.isProcessing=false;q.isInspectioneering=false;q.isInContext=false;q.isRelatedSwitch=false;q._toBeRemovedAtRelease={contexts:[],resolvedBy:[]};q._inspectedIssues={};q._currentLevel=-1;q._restoreFocus=false;q._levels={0:{inspectedIssues:{},session:{nodes:{inspected:[],contexts:{added:[],showed:[]},resolvedBy:{added:[],showed:[]}}}}}},inspect:function(q){var s=this;f.start(s.name+" inspect");var r=q.ids;return s.isInspectable(r).then(function(){if(s._currentLevel===-1){return s._startInspect(r)}else{return s._goDeeper(r)}}).then(function(){f.end(s.name+" inspect")})},_startInspect:function(r){var s=this;var q=false;return new m(function(u){s.loading();s.reset();var t=b.getCommandCheckHeader("Focus");if(t.getState()){s._restoreFocus=true;t.toggleState()}if(!s.manager.options.context.window.getViewer().visibleSpace){q=true;b.getCommand("VisuVisibleSpace").onEnd(u);b.getCommand("VisuVisibleSpace").begin()}else{u()}}).then(function(){s._currentLevel++;b.inspectingIssue();s.isInspectioneering=true;s.isProcessing=true;return s.manager.hide()}).then(function(){var B=s.manager.getIssues().map,D=[];var A=s.manager.options.context.root.getController();var w=[];for(var y=0;y<r.length;y++){var C=B[r[y]];if(C===undefined){continue}s._inspectedIssues[r[y]]=C;C.model.get("markers").forEach(function(E){D=D.concat(A.buildPathFromArray(E.get("path")))});C.inspect().select();w=w.concat(C.balloons.map(function(E){return E.promiseWhileRendering}))}s._levels[s._currentLevel].inspectedIssues=s._inspectedIssues;s._levels[s._currentLevel].session.nodes.inspected=D;for(var z in s.manager.nodes){if(s.manager.nodes.hasOwnProperty(z)){var v=s.manager.nodes[z].path;var u=A._refineOverrideSet.createOverride(v);if(u!==null){var x=D.some(function(E){return E.isAParentOf(v)||v.isAParentOf(E)});if(x){u.setVisibility(true);u.setVisibilityFree(false)}else{u.setVisibility(false);u.setVisibilityFree(true)}}}}var t=A._viewer.getSceneGraphOverrideSetManager();if(t){t.insertSceneGraphOverrideSetAt(A._refineOverrideSet,0)}A._viewer.render({updateInfinitePlane:true});s.manager.options.context.window.getViewpoint().reframe(null);return m.all(w)}).then(function(){if(q===true){return new m(function(t){b.getCommand("VisuVisibleSpace").onEnd(t);b.getCommand("VisuVisibleSpace").begin()})}else{return m.resolve()}}).then(function(){s.render();s._refreshNavigationBar();s.isProcessing=false;s.unloading()})},_goDeeper:function(r){var s=this;var q=false;return new m(function(t){s.loading();s.isProcessing=true;s._currentLevel++;if(!s.manager.options.context.window.getViewer().visibleSpace){q=true;b.getCommand("VisuVisibleSpace").onEnd(t);b.getCommand("VisuVisibleSpace").begin()}else{t()}}).then(function(){s._levels[s._currentLevel]={inspectedIssues:{},session:{nodes:{inspected:[],contexts:{added:[],showed:[]},resolvedBy:{added:[],showed:[]}}}};var x=s.manager.getIssues().map;var z=[];for(var y=0;y<r.length;y++){var u=x[r[y]];if(u===undefined){continue}s._levels[s._currentLevel].inspectedIssues[r[y]]=u;var t=s.manager.options.context.root.getController();u.model.get("markers").forEach(function(B){z=z.concat(t.buildPathFromArray(B.get("path")))})}s._levels[s._currentLevel].session.nodes.inspected=z;var w=[];var A=Object.keys(s._levels[s._currentLevel-1].inspectedIssues);for(var v=0;v<A.length;v++){if(r.indexOf(A[v])===-1){w.push(s._levels[s._currentLevel-1].inspectedIssues[A[v]].hide())}}return m.all(w)}).then(function(){return s._refreshVisualization(true)}).then(function(){if(q){return new m(function(t){b.getCommand("VisuVisibleSpace").onEnd(t);b.getCommand("VisuVisibleSpace").begin()})}else{return m.resolve()}}).then(function(){s._refreshNavigationBar();s.manager.component.dispatchEvent("onInspect");s.isProcessing=false;s.unloading()})},_goToLevel:function(t){var r=this;if(r._levels[t]===null||r._levels[t]===undefined){return m.reject(new Error("The level does not exist"))}var s=m.resolve();var q=false;if(!r.manager.options.context.window.getViewer().visibleSpace){q=true;s.then(function(){return new m(function(u){b.getCommand("VisuVisibleSpace").onEnd(u);b.getCommand("VisuVisibleSpace").begin()})})}if(r.isInContext===true){s=s.then(function(){return r.hideContext().then(function(){r.elements.context.uncheck()})})}if(r.isRelatedSwitch===true){s=s.then(function(){return r.switchRelatedObjects().then(function(){r.elements.related.uncheck()})})}return s.then(function(){r.loading();r.isProcessing=true;r._currentLevel=t;return r._refreshVisualization(true)}).then(function(){var w=[];var v=Object.keys(r._levels[r._currentLevel].inspectedIssues);for(var u=0;u<v.length;u++){w.push(r._levels[r._currentLevel].inspectedIssues[v[u]].show())}return m.all(w)}).then(function(){if(q){return new m(function(u){b.getCommand("VisuVisibleSpace").onEnd(u);b.getCommand("VisuVisibleSpace").begin()})}else{return m.resolve()}}).then(function(){r._refreshNavigationBar();r.manager.component.dispatchEvent("onInspect");r.isProcessing=false;r.unloading()})},_refreshNavigationBar:function(){var q=this;var r=Object.keys(q._levels[q._currentLevel].inspectedIssues).length;if(q._currentLevel===0){q.elements.bar.addClassName("is-ground-level")}else{q.elements.bar.removeClassName("is-ground-level")}q.elements.info.innerHTML="<p>"+p.replace(p.inspect.title,{number:r})+"</p><span></span>";if(r===1){q.elements.context.enable();q.elements.related.enable()}else{q.elements.context.disable();q.elements.related.disable()}},release:function(){var s=this;if(s.isProcessing===true){return m.reject(new Error("We are already processing an inspection"))}if(s.isInspectioneering===false){return m.resolve()}f.start(s.name+" release");s.isProcessing=true;s.loading();var r=[];var q=false;if(!s.manager.options.context.window.getViewer().visibleSpace){q=true;r.push(new m(function(t){b.getCommand("VisuVisibleSpace").onEnd(t);b.getCommand("VisuVisibleSpace").begin()}))}Object.keys(s._inspectedIssues).forEach(function(t){r.push(s._inspectedIssues[t].release())});return m.all(r).then(function(){b.releasingIssue();s.container.destroy();var t=m.resolve();if(s.isInContext===true){t=t.then(function(){return s.hideContext()})}if(s.isRelatedSwitch===true){t=t.then(function(){return s.switchRelatedObjects()})}return t}).then(function(){s.manager.unselectAll({publish:true});var u=s.manager.options.context.root.getController();if(s._toBeRemovedAtRelease.contexts.length>0){var t=[];s._toBeRemovedAtRelease.contexts.forEach(function(z){t.push(u.buildArrayFromPath(z).pop())});u.removeRoots({pids:t},true)}if(s._toBeRemovedAtRelease.resolvedBy.length>0){var x=[];s._toBeRemovedAtRelease.resolvedBy.forEach(function(z){x.push(u.buildArrayFromPath(z).pop())});u.removeRoots({pids:x},true)}for(var v in s.manager.nodes){if(s.manager.nodes.hasOwnProperty(v)){var w=u._refineOverrideSet.createOverride(s.manager.nodes[v].path);if(w!==null){w.setVisibility(true);w.setVisibilityFree(false)}}}var y=u._viewer.getSceneGraphOverrideSetManager();if(y){y.insertSceneGraphOverrideSetAt(u._refineOverrideSet,0)}u._viewer.render({updateInfinitePlane:true});s.manager.options.context.window.getViewpoint().reframe(null)}).then(function(){return s.manager.show()}).then(function(){if(q){return new m(function(t){b.getCommand("VisuVisibleSpace").onEnd(t);b.getCommand("VisuVisibleSpace").begin()})}else{return m.resolve()}}).then(function(){var t=b.getCommandCheckHeader("Focus");if(s._restoreFocus===true){t.toggleState()}s.isProcessing=false;s.reset();s.unloading();f.end(s.name+" release")})},refresh:function(){var r=this;var q=m.resolve();if(r.isInContext===true){q=q.then(function(){return r.hideContext()}).then(function(){return r.showContext()})}if(r.isRelatedSwitch){q=q.then(function(){return r.switchRelatedObjects()}).then(function(){return r.switchRelatedObjects()})}return q},showContext:function(){var q=this;if(q.isInspectioneering===false||q.isInContext===true){return m.reject(new Error("You need to be in inspect mode to display the context"))}if(Object.keys(q._levels[q._currentLevel].inspectedIssues).length>1){c.displayNotification({msg:p.inspect.inspectNotAvailable,eventID:"info"});return m.reject(new Error("You need to inspect only ONE issue to display the context"))}f.start(q.name+" showContext");return new m(function(s,r){q.loading();q.isInContext=true;var t=[];Object.keys(q._levels[q._currentLevel].inspectedIssues).forEach(function(v){var u=q._levels[q._currentLevel].inspectedIssues[v].model.get("contexts");if(Array.isArray(u)){t=u.map(function(w){return w.physicalId})}});if(t.length>0){s(q.getNodesInSession(t))}else{q.isInContext=false;c.displayNotification({msg:p.inspect.noContext,eventID:"info"});r(new Error("No context for this issue"))}}).then(function(r){if(Object.keys(r.inSession).length>0){var s=Object.keys(r.inSession).map(function(t){return r.inSession[t]});q._levels[q._currentLevel].session.nodes.contexts.showed=s.map(function(t){return t.path})}return new m(function(x,w){if(r.notInSession.length>0){var u=0;var v=q.manager.options.context.root.subscribe({event:"onRootAdded"},function(z){u+=1;q._levels[q._currentLevel].session.nodes.contexts.added.push(z.path);q._toBeRemovedAtRelease.contexts.push(z.path);if(u===r.notInSession.length){q.manager.options.context.root.unsubscribe(v);x()}});var t=q.manager.options.context.root.subscribe({event:"onLoadingFailure"},function(){q.manager.options.context.root.unsubscribe(t);c.displayNotification({msg:p.inspect.objectLoadError,eventID:"error"});q.isInContext=false;w(new Error("Object(s) failed to load"))});var y=[];r.notInSession.forEach(function(z){y.push([z])});q.manager.options.context.root.getController().addRoots({paths:y},false,true,false)}else{x()}})}).then(function(){return q._refreshVisualization(true)})["finally"](function(){q.unloading();if(q.isInContext){b.inspectingIssue()}f.end(q.name+" showContext")})},hideContext:function(){var q=this;f.start(q.name+" hideContext");q.loading();q.isInContext=false;q._levels[q._currentLevel].session.nodes.contexts.showed=[];q._levels[q._currentLevel].session.nodes.contexts.added=[];return q._refreshVisualization(true).then(function(){q.unloading();f.end(q.name+" hideContext")})},switchRelatedObjects:function(){var q=this;if(q.isInspectioneering===false){return m.reject(new Error("You need to be in inspect mode to switch the related objects"))}if(Object.keys(q._levels[q._currentLevel].inspectedIssues).length>1){c.displayNotification({msg:p.inspect.inspectNotAvailable,eventID:"info"});return m.reject(new Error("You need to inspect only ONE issue to switch the related objects"))}f.start(q.name+" switchRelatedObjects");q.isRelatedSwitch=!q.isRelatedSwitch;q.loading();var r=null;if(q.isRelatedSwitch===true){r=new m(function(u,t){var s=[];Object.keys(q._levels[q._currentLevel].inspectedIssues).forEach(function(x){var w=q._levels[q._currentLevel].inspectedIssues[x].model.get("resolvedBy");if(w&&Array.isArray(w)){var v=w.reduce(function(z,y){z.push(y.physicalId);return z},[]);s=s.concat(v)}});if(s.length>0){u(q.getNodesInSession(s))}else{q.isRelatedSwitch=false;c.displayNotification({msg:p.inspect.noResolvedByForSwitch,eventID:"info"});t(new Error("No resolved by objects found"))}}).then(function(s){if(Object.keys(s.inSession).length>0){var t=Object.keys(s.inSession).map(function(u){return s.inSession[u]});q._levels[q._currentLevel].session.nodes.resolvedBy.showed=t.map(function(u){return u.path})}return new m(function(y,x){if(s.notInSession.length>0){var v=0;var w=q.manager.options.context.root.subscribe({event:"onRootAdded"},function(A){v+=1;q._levels[q._currentLevel].session.nodes.resolvedBy.added.push(A.path);q._toBeRemovedAtRelease.resolvedBy.push(A.path);if(v===s.notInSession.length){q.manager.options.context.root.unsubscribe(w);y()}});var u=q.manager.options.context.root.subscribe({event:"onLoadingFailure"},function(){q.manager.options.context.root.unsubscribe(u);c.displayNotification({msg:p.inspect.objectLoadError,eventID:"error"});q.isRelatedSwitch=false;x(new Error("Object(s) failed to load"))});var z=[];s.notInSession.forEach(function(A){z.push([A])});q.manager.options.context.root.getController().addRoots({paths:z},false,true,false)}else{y()}})})}else{r=new m(function(s){q._levels[q._currentLevel].session.nodes.resolvedBy.showed=[];q._levels[q._currentLevel].session.nodes.resolvedBy.added=[];s()})}return r.then(function(){return q._refreshVisualization(false)})["finally"](function(){q.unloading();if(q.isRelatedSwitch){b.inspectingIssue()}f.end(q.name+" switchRelatedObjects")})},_refreshVisualization:function(q){var r=this;return new m(function(B){var t=r._levels[r._currentLevel].session;var A=[];if(r.isInContext){A=A.concat(t.nodes.contexts.showed).concat(t.nodes.contexts.added)}if(r.isRelatedSwitch){A=A.concat(t.nodes.resolvedBy.showed).concat(t.nodes.resolvedBy.added)}else{A=A.concat(t.nodes.inspected)}var z=r.manager.options.context.root.getController();var w=Object.keys(r.manager.nodes).map(function(C){return r.manager.nodes[C].path});w=w.concat(r._toBeRemovedAtRelease.contexts);w=w.concat(r._toBeRemovedAtRelease.resolvedBy);for(var y=0;y<w.length;y++){var v=w[y];var u=z._refineOverrideSet.createOverride(v);if(u!==null){var x=A.some(function(C){return C.isAParentOf(v)||v.isAParentOf(C)});if(x){u.setVisibility(true);u.setVisibilityFree(false)}else{u.setVisibility(false);u.setVisibilityFree(true)}}}var s=z._viewer.getSceneGraphOverrideSetManager();if(s){s.insertSceneGraphOverrideSetAt(z._refineOverrideSet,0)}z._viewer.render({updateInfinitePlane:true});if(q===true){r.manager.options.context.window.getViewpoint().reframe(null)}B()})},isInspected:function(){var q=this;return q.isInspectioneering},isInspectable:function(r){var s=this;if(s.isProcessing===true){return m.reject(new Error("We are already processing an inspection"))}if(s._currentLevel>=0){var q=Object.keys(s._levels[s._currentLevel].inspectedIssues);if(q.length===r.length){var t=r.filter(function(u){return q.includes(u)});if(t.length===r.length){return m.reject(new Error("You are trying to inspect the same issue(s)"))}}}return m.resolve()},getInspectedIssues:function(){var u=this;var t=[];var r=u._levels[u._currentLevel].inspectedIssues;for(var v in r){if(r.hasOwnProperty(v)){var s=r[v].model,q={id:s.get("id"),type:s.get("type"),name:s.get("name"),title:s.get("title")};t.push(q)}}return t},getNodesInSession:function(q){var w=this;var u={inSession:[],notInSession:[]};var x=g.get("pad3DViewer").getController().getRoots(),s=w.manager.utils.parseChildren(x);for(var v=0;v<q.length;v++){var r=[],y=s.paths[q[v]];if(y&&y.length>0){for(var t=0;t<y.length;t++){r.push(s.nodes[y[t].join(",")])}}if(r.length>0){u.inSession=u.inSession.concat(r)}else{u.notInSession.push(q[v])}}return u},loading:function(){var q=this;i.mask(q.manager.options.context.window.getViewerFrame())},unloading:function(){var q=this;i.unmask(q.manager.options.context.window.getViewerFrame())}});return l});define("DS/Issue3DReview/collections/Markers",["UWA/Class/Collection","DS/Logger/Logger","DS/Issue3DReview/models/Marker"],function(c,b,a){var d=c.extend({name:"DS/Issue3DReview/collections/Markers",model:a,comparator:"state",_logger:null,setup:function(){var e=this;e._logger=b.getLogger("DS/Issue3DReview/Model");e._logger.debug("Initializing the marker collection");e.addEvents({onRemove:e._onRemove,onAdd:e._onAdd,onReset:e._onReset},e);return e},fetch:function(e){e.onComplete()},_onRemove:function(){},_onAdd:function(){},_onReset:function(){}});return d});define("DS/Issue3DReview/models/Issue",["UWA/Class/Model","UWA/Core","DS/Logger/Logger","DS/Issue3DReview/collections/Markers","DS/Issue3DReview/utils/ModelParser","DS/IssueServices/services/IssueServices","DS/IssueServices/utils/Performance"],function(d,g,c,a,e,f,b){var h={SEPARATOR_ID:"(╯°□°）╯︵ ┻━┻",FIRST_ELEMENT_IN_RESPONSE:0};var i=d.extend({name:"DS/Issue3DReview/models/Issue",defaults:{id:"",type:"",name:"",title:"",state:"",description:"",owner:"",reportingOrganization:"",created:"",modified:"",resolutionDate:"",estimatedStartDate:"",estimatedEndDate:"",actualStartDate:"",actualEndDate:"",contexts:{},reportedAgainst:[],resolvedBy:[],assignees:[],markers:null,primaryImage:null},_logger:null,setup:function(){var j=this;j._logger=c.getLogger("DS/Issue3DReview/Model");j._logger.debug("%s (%s) has been initialized with %s reported against",j.get("title"),j.get("name"),j.get("reportedAgainst").length)},fetch:function(j){var k=this;b.start(k.name+" fetch");f.issues.retrieve({timestamp:j.timestamp?j.timestamp:null,data:{objects:[{physicalId:k.get("id")}]},onComplete:function(l){var m=e.parse(l[h.FIRST_ELEMENT_IN_RESPONSE].body,j);m=k.parse(m,j);k.merge(m,j);k.set(m);if(j&&typeof j.onComplete==="function"){j.onComplete(m)}b.end(k.name+" fetch")},onFailure:function(l){if(j&&typeof j.onFailure==="function"){j.onFailure(l)}b.end(k.name+" fetch")}})},merge:function(m,k){var l=this;b.start(l.name+" merge");var o=m.reportedAgainst.reduce(function(r,q){r[q.physicalId]=q;return r},{});var n=l.get("markers")||m.markers,p=[];n.forEach(function(q){p.push(q.get("physicalId"))});p.forEach(function(s){if(!g.is(o[s],"object")){var r=n.where({physicalId:s});for(var q=0;q<r.length;q++){n.remove(r[q]);l.unset(s,{silent:k.silent})}}else{}});var j=false;if(!g.is(m.markers,"object")){m.markers=l.get("markers");j=true}l._addMarkers(m,k);if(j===true){delete m.markers}b.end(l.name+" merge")},fetchPrimaryImage:function(j){var k=this;k._logger.debug("Fetching primary image for issue %s (%s)",k.get("title"),k.get("name"));b.start(k.name+" primaryImage");f.images.retrieve({data:{objects:[{physicalId:k.get("id")}]},onComplete:function(l){var m=l[h.FIRST_ELEMENT_IN_RESPONSE].body;k._logger.debug("Primary image for the issue %s have been fetched",k.get("title")+"("+k.get("name")+")");var n=null;if(g.is(m,"object")&&g.is(m.fileName,"string")&&m.fileName!==""&&g.is(m.url,"string")&&m.url!==""){n=m;k.set("primaryImage",m,{silent:true})}j.onComplete(n);b.end(k.name+" primaryImage")},onFailure:function(l){k._logger.debug("Fetch primary image failed for issue %s (%s)",k.get("title"),k.get("name"));j.onFailure(l);b.end(k.name+" primaryImage")}})},parse:function(l,j){var k=this;b.start(k.name+" parse");if(j.add===true){l.markers=new a([],{});k._addMarkers(l,j)}b.end(k.name+" parse");return l},save:function(m,j){var l=this;l._logger.debug("Saving issue %s (%)",l.get("title"),l.get("name"));b.start(l.name+" save");var k=g.clone(m);k.physicalId=l.get("id");f.issues.update({id:l.get("id"),data:{objects:[k]},onComplete:function(n){if(j&&typeof j.onComplete==="function"){j.onComplete(n)}b.end(l.name+" save")},onFailure:function(n){if(j&&typeof j.onFailure==="function"){j.onFailure(n)}b.end(l.name+" save")}})},destroy:function(){var j=this;j._logger.debug("Destroying issue %s (%s)",j.get("title"),j.get("name"));j.clear({silent:true}).set(j.defaults)},_addMarkers:function(l,j){var k=this;var m=l.markers.groupBy("physicalId");l.reportedAgainst.forEach(function(n){var p=n.physicalId;var r=j.collection.getNodesById(p),o=r.nodes,s=r.paths;if(o.length>0&&!m[p]){for(var q=0;q<o.length;q++){l.markers.add({id:p+h.SEPARATOR_ID+q,issue:k,type:n.type,name:n.name,revision:n.revision,title:n.title,position:n.position,node:o[q],path:s[q]},{silent:j.silent});k.set(p,p,{silent:j.silent});j.collection.setNodeAsReported(p)}}})}});return i});define("DS/Issue3DReview/views/Preview",["UWA/Class/Promise","UWA/Class/View","UWA/Core","DS/UIKIT/Popover","DS/UIKIT/Scroller","DS/Core/Events","DS/ENO6WPlugins/jQuery","DS/ENO6WPlugins/jQueryUI","DS/Logger/Logger","DS/SocialToolbar/SocialToolbar","DS/Issue3DReview/commands/CommandsManager","DS/Issue3DReview/utils/ModelParser","DS/IssueCommon/utils/Utils","DS/IssueServices/services/IssueServices","DS/IssueServices/services/PlatformServices","DS/IssueServices/utils/Performance","i18n!DS/Issue3DReview/assets/nls/Issue3DReview","css!DS/Issue3DReview/Issue3DReview.css"],function(d,p,h,q,r,m,k,o,s,j,a,n,b,f,i,c,g){var l={TIMEOUT_PREVIEW:100};var t={card:function(u){return h.createElement("div",{"class":"card",html:h.createElement("div",{"class":"card-block",html:[u.header,u.image,u.content]})})},header:function(u){return h.createElement("div",{"class":"card-header",html:[h.createElement("h4",{"class":"card-title",html:[h.createElement("img",{"class":"card-icon",src:u.icon}),h.createElement("span",{"class":"card-label",html:b.getTextFromHTML(u.title)})],title:b.getTextFromHTML(u.title)}),h.createElement("div",{"class":"card-owner",html:[h.createElement("div",{"class":"fonticon fonticon-user"}),u.owner]}),h.createElement("h5",{"class":"card-subtitle",html:b.getTextFromHTML(u.subtitle)})]})},image:function(u){var v="";if(!h.is(u.image,"object")||!h.is(u.image.url,"string")||u.image.url===""){v=h.createElement("div",{"class":"issue-latest-image-placeholder",html:'<span class="fonticon fonticon-5x fonticon-camera"></span>'})}else{v=h.createElement("img",{"class":"issue-latest-image",src:u.image.url})}return h.createElement("div",{"class":"card-img",html:v})},content:function(u){return h.createElement("div",{"class":"second-card-block",html:[h.createElement("p",{"class":"card-content",html:[u.reported,h.createElement("div",{"class":"card-description",html:b.getTextFromHTML(u.description)})]}),h.createElement("div",{"class":"card-extra-content",html:u.extra})]})}};var e=p.extend({name:"DS/Issue3DReview/views/Preview",tagName:"div",className:"issue-preview-container",_logger:null,domEvents:{"click .card-img":"_onClickImage","click .issue-preview-assignee":"_onClickUserIcon","click .issue-preview-owner-image":"_onClickUserIcon"},issue:null,balloon:null,comments:null,_popover:null,_firstRendering:true,_isHovered:false,_isFixed:false,_visualizationEventToken:null,setup:function(u){var v=this;c.start(v.name+" setup");v._logger=s.getLogger("DS/Issue3DReview/View");v._parent(u);v.issue=u.issue;v._popover=new q({className:"issue-preview",target:v.issue.container,trigger:"manual",position:"right",body:"",events:{onHide:function(){v._onHide()}}});v._firstRendering=true;v._popover.shouldListenForScroll=false;v.comments=new j({subjectURI:"pid:"+v.issue.model.get("id"),enableShare:false,enableComment:true,enableLike:false,tenantId:i.getTenant(),serviceURL:i.get3DSpaceUrl()+"/resources/issues/","3DSwymUrl":i.get3DSwymUrl(),commentsNumberAtInit:1,enableUpload:false});v._subscribers();c.end(v.name+" setup")},render:function(){var A=this;A.container.empty();var u=A.issue.model.get("primaryImage");var E=null,z=null;var D=null;var v=h.createElement("img",{"class":"issue-preview-owner-image",src:i.getUserImage(A.issue.model.get("owner").user),title:A.issue.model.get("owner").fullName+" ("+A.issue.model.get("owner").user+")"});v.setData("user",A.issue.model.get("owner").user);var x=t.header({icon:b.getIconByState(A.issue.model.get("state")),title:A.issue.model.get("title")+" ("+A.issue.model.get("name")+")",owner:v,subtitle:g.replace(g.preview.modified,{date:b.timeSince(new Date(A.issue.model.get("modified")))})}),w=t.image({image:u!==null?u:""}),C=t.content({reported:h.createElement("div",{"class":"issue-preview-reported-container",html:[h.createElement("span",{"class":"fonticon fonticon-location"}),E=h.createElement("span",{"class":"issue-preview-reported",html:h.createElement("div",{"class":"issue-preview-reported-placeholder"})})]}),description:A.issue.model.get("description"),extra:[h.createElement("div",{"class":"issue-preview-assignees",html:[h.createElement("div",{"class":"fonticon fonticon-users"}),(A.issue.model.get("assignees").length===0?g.preview.noAssignees:A.issue.model.get("assignees").reduce(function(H,G){var F=h.createElement("img",{src:i.getUserImage(G.user),title:b.getTextFromHTML(G.fullName)+" ("+b.getTextFromHTML(G.user)+")"});F.setData("user",G.user);H.push(h.createElement("div",{"class":"issue-preview-assignee",html:F}));return H},[]))]}),h.createElement("div",{"class":"fonticon fonticon-comment primary"}),z=h.createElement("span",{"class":"issue-preview-nb-comments"}),D=h.createElement("div",{"class":"issue-preview-comments enhanced-only",html:""})]});var B=h.createElement("div",{html:"",styles:{height:"100%",width:"100%"}});D.setContent(B);var y=new r({element:B}).inject(D);A.comments.inject(y.getInnerElement());A.container.setContent(t.card({header:x,image:w,content:C}));f.fetch({data:{objects:[{physicalId:A.balloon.model.get("physicalId")}]},onComplete:function(F){F.body.results.forEach(function(G){var H=n.parse(G,{useIndex:true});E.setContent([h.createElement("img",{src:H.icons.length>0?H.icons[H.icons.length-1]:"",title:H.title+" ("+H.name+") "+H.revision}),h.createElement("span",{html:b.getTextFromHTML(H.title)+" ("+b.getTextFromHTML(H.name)+") "+b.getTextFromHTML(H.revision),title:b.getTextFromHTML(H.title)+" ("+b.getTextFromHTML(H.name)+") "+b.getTextFromHTML(H.revision)})])})},onFailure:function(F){A._logger.error("Could not fetch data for %s because %s",A.balloon.model.get("physicalId"),F);E.setContent(h.createElement("div",{"class":"issue-preview-reported-error",html:g.preview.errorFetch}))}});z.setContent("...");A._popover.removeEvent("onShow");A._popover.addEvent("onShow",function(){f.comments.retrieve({data:{physicalId:A.issue.model.get("id")}}).then(function(G){var F=0;try{F=G.body.result.nbComments}catch(H){F=0}if(!A.utils.isInteger(F)){F=0}z.setContent(g.replace(g.preview.comments,{number:F}))})});if(A._firstRendering===true){A._firstRendering=false;A._getPrimaryImage().then(function(F){if(h.is(F)&&h.is(F.url,"string")&&F.url!==""){A.container.getElement("div.card-img").setContent(h.createElement("img",{"class":"issue-latest-image",src:F.url}))}})["catch"](function(F){A._logger.error(F)})}return A},destroy:function(){var u=this;if(u._visualizationEventToken!==null){m.unsubscribe(u._visualizationEventToken)}u.issue=null;u.balloon=null;u.comments.destroy();u.comments=null;u._popover.destroy();u._popover=null;u._firstRendering=true;u._isHovered=false;u._isFixed=false;u._visualizationEventToken=null;u.container.empty()},refresh:function(){var u=this;u.render()},show:function(v){var u=this;if(u.isFixed()===true){u._logger.debug("Preview for issue %s (%s) is fixed, no need to show again",u.issue.model.get("title"),u.issue.model.get("name"));return u}u._logger.debug("Showing preview for issue %s (%s)",u.issue.model.get("title"),u.issue.model.get("name"));u.balloon=v;u._logger.debug("Balloon is reported on %s (%s)",u.balloon.model.get("title"),u.balloon.model.get("name"));u._popover.setOption("target",u.balloon.container);u._popover.getContent().getElement(".popover-arrow").setStyle("display","initial");u._popover.show();u._popover.updatePosition();u._popover.setBody(u.render());u.container.removeClassName("enhanced");if(u.issue.isSelected===true){u.enhance()}return u},hide:function(){var v=this;if(v.isFixed()===true){return v}if(v.isEnhanced()===true){var u=setInterval(function(){if(v.shouldHide()===true){clearInterval(u);if(v.shouldKaboom()===true){v.kaboom()}}},l.TIMEOUT_PREVIEW)}else{v.kaboom()}return v},brake:function(){var u=this;if(u.isFixed()===false){u.kaboom()}else{u.hide()}},kaboom:function(){var u=this;u._popover.hide()},enhance:function(){var u=this;if(u.isEnhanced()===true){return}if(u._visualizationEventToken===null){u._visualizationEventToken=m.subscribe({event:"/VISU/"},function(v){if(v.eventType==="@onViewpointChange"){u._popover.updatePosition()}})}u.container.addClassName("enhanced");u._popover.updatePosition();u._popover.getContent().addEventListener("mouseover",function(){u._isHovered=true});u._popover.getContent().addEventListener("mouseout",function(v){var w=v.toElement||v.relatedTarget;while(w&&w.parentNode&&w.parentNode!==window){if(w.parentNode===this||w===this){if(w.preventDefault){w.preventDefault()}return}w=w.parentNode}u._isHovered=false});u.draggable()},draggable:function(){var v=this;var u=v._popover.getContent();k(u).draggable({handle:u.getElement(".card-title"),start:function(){if(v._isFixed===true){return}v._isFixed=true;if(v._visualizationEventToken!==null){m.unsubscribe(v._visualizationEventToken)}u.getElement(".popover-arrow").setStyle("display","none");var w=h.createElement("span",{"class":"issue-preview-closable",html:'<span class="fonticon fonticon-cancel"></span>'});w.inject(u);w.addEventListener("click",function(){v._isFixed=false;w.destroy();v.kaboom()})}})},isEnhanced:function(){var u=this;return u.container.hasClassName("enhanced")},isFixed:function(){var u=this;return u._isFixed},isFocused:function(){var w=this;var v=document.activeElement;function u(x,z){var y=z.parentNode;while(y!==null){if(y===x){return true}y=y.parentNode}return false}return u(w._popover.getContent(),v)},shouldHide:function(){var u=this;return !u._isHovered},shouldKaboom:function(){var u=this;if(u._popover===null){return false}return !u.isFixed()&&!u.isFocused()},_onHide:function(){var v=this;try{k(v._popover.getContent()).draggable("destroy")}catch(u){}v.container.removeClassName("enhanced")},_onClickImage:function(){var u=this;u.kaboom();a.getCommand("AttachmentManager").begin()},_onClickUserIcon:function(v){var u=v.target.getData("user");if(h.is(u,"string")){i.getUserProfile(u)}},_getPrimaryImage:function(){var u=this;return new d(function(v){u.issue.model.fetchPrimaryImage({onComplete:v,onFailure:function(){}})})},_subscribers:function(){var u=this;u.listenTo(u.issue.model,"onChange",function(){u.kaboom()})},utils:{isInteger:function(u){return Number.isInteger?Number.isInteger(u):typeof u==="number"&&isFinite(u)&&Math.floor(u)===u}}});return e});define("DS/Issue3DReview/collections/Issues",["UWA/Class/Collection","DS/Logger/Logger","DS/Issue3DReview/models/Issue","DS/Issue3DReview/utils/ModelParser","DS/IssueComponents/utils/Utils","DS/IssueServices/Contexts","DS/IssueServices/services/IssueServices","DS/IssueServices/utils/Performance"],function(f,b,g,d,h,c,e,a){var i=f.extend({name:"DS/Issue3DReview/collections/Issues",model:g,comparator:"name",_logger:null,_nodes:{},_paths:{},_neutralNodes:{},_reportedNodes:{},setup:function(m,j){var l=this;l._logger=b.getLogger("DS/Issue3DReview/Model");l._logger.debug("Initializing the issue collection");a.start(l.name+" setup");l.addEvents({onRemove:l._onRemove,onAdd:l._onAdd,onReset:l._onReset},l);l._nodes=j.nodes;l._paths=j.paths;l._neutralNodes={};for(var k in j.nodes){if(j.nodes.hasOwnProperty(k)){l._neutralNodes[k]=j.nodes[k]}}l._reportedNodes={};a.end(l.name+" setup");return l},fetch:function(j){var l=this;l._logger.info("Fetching all issues...");a.start(l.name+" fetch");var m=c.get("widget");var k=m.getValue("filter");if(h.isJson(k)===true){k=JSON.parse(k)}else{k={}}e.issues.filter({version:"1.0",data:{filter:k},onComplete:function(o){var r=o.body,q=[];l._logger.debug("Issues fetched");for(var s=0;s<r.length;s++){for(var p=0;p<r[s].reportedAgainst.length;p++){var n=l.getNodesById(r[s].reportedAgainst[p].physicalId).nodes;if(n.length>0){q.push(r[s])}}}l.reset(q,{parse:true});if(j&&typeof j.onComplete==="function"){j.onComplete(q)}a.end(l.name+" fetch")},onFailure:function(n){l._logger.error("Fetch issues failed");if(j&&typeof j.onFailure==="function"){j.onFailure(n)}a.end(l.name+" fetch")}})},parse:function(l,j){var k=this;k._logger.debug("Parsing issues...");a.start(k.name+" parse");l=d.parse(l,j);a.end(k.name+" parse");return l},getNodes:function(){var j=this;return j._nodes},getNodesById:function(n){var l=this;var j=[],m=l._paths[n];if(m&&m.length>0){for(var k=0;k<m.length;k++){j.push(l._nodes[m[k].join(",")])}}return{nodes:j,paths:m}},getNeutralNodes:function(){var j=this;return j._neutralNodes},getReportedNodes:function(){var j=this;return j._reportedNodes},setNodeAsReported:function(n){var k=this;var m=k._paths[n];if(m&&m.length>0){for(var j=0;j<m.length;j++){var l=m[j].join(",");delete k._neutralNodes[l];k._reportedNodes[l]=k._nodes[l]}}},setNodeAsNeutral:function(n){var k=this;var m=k._paths[n];if(m&&m.length>0){for(var j=0;j<m.length;j++){var l=m[j].join(",");delete k._reportedNodes[l];k._neutralNodes[l]=k._neutralNodes[l]}}},_onRemove:function(){},_onAdd:function(){},_onReset:function(){}});return i});define("DS/Issue3DReview/views/Issue",["UWA/Class","UWA/Class/Promise","UWA/Class/View","UWA/Core","DS/Core/Events","DS/Logger/Logger","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Issue3DReview/components/ContextualMenu","DS/Issue3DReview/views/Balloon","DS/Issue3DReview/views/Preview","DS/IssueCommon/utils/Utils","DS/IssueServices/utils/Performance","i18n!DS/Issue3DReview/assets/nls/Issue3DReview","css!DS/Issue3DReview/Issue3DReview.css"],function(b,o,a,i,h,e,f,d,k,n,g,m,c){var j={CREATE_STATE:"Create",ASSIGN_STATE:"Assign",ACTIVE_STATE:"Active",REVIEW_STATE:"Review",CLOSED_STATE:"Closed",CREATE_COLOR:"#9B2C98",ASSIGN_COLOR:"#FF8A2E",ACTIVE_COLOR:"#009DDB",REVIEW_COLOR:"#6FBC4B",CLOSED_COLOR:"#ADADAD",CONFLICT_NUMBER:2};var l=a.extend({name:"DS/Issue3DReview/views/Issue",_logger:null,defaultOptions:{manager:null,viewer:null,window:null,controller:null},balloons:[],clones:[],linked:[],preview:null,color:"",isSelected:false,isHovered:false,isInspected:false,_preventPreview:false,setup:function(q){var r=this;c.start(r.name+" setup");r._logger=e.getLogger("DS/Issue3DReview/View");r.options=i.merge(q||{},r.defaultOptions);var p={};p[j.CREATE_STATE]=j.CREATE_COLOR;p[j.ASSIGN_STATE]=j.ASSIGN_COLOR;p[j.ACTIVE_STATE]=j.ACTIVE_COLOR;p[j.REVIEW_STATE]=j.REVIEW_COLOR;p[j.CLOSED_STATE]=j.CLOSED_COLOR;r.options.colors=p;r.balloons=[];r.clones=[];r.linked=[];r.preview=null;r.isSelected=false;r.isHovered=false;r.isInspected=false;r.preview=new g({issue:r});r._subscribers();c.end(r.name+" setup")},render:function(p){var r=this;c.start(r.name+" render");r._logger.debug("Rendering issue %s (%s)",r.model.get("title"),r.model.get("name"));p=p?p:{};r.color=r.options.colors[r.model.get("state")];if(p.isInspected===true){r.clones=r.balloons.slice();r.balloons=[]}var s=r.model.get("markers");for(var q=0;q<s.length;q++){r.add(s.at(q),p)}c.end(r.name+" render");return r},destroy:function(){var r=this;r.stopListening(r,"onMouseOver");r.stopListening(r,"onMouseOut");r.stopListening(r,"onClick");r.stopListening(r,"onDoubleClick");r.stopListening(r,"onContextMenu");r.stopListening(r.model,"onChange");var q=[];for(var p=0;p<r.balloons.length;p++){q.push(r.balloons[p].destroy())}return o.all(q).then(function(){r.preview.destroy();r.preview=null;r.balloons=[];r.clones=[];r.isSelected=false;r.isInspected=false;r.options.manager.getCollection().remove(r.model,{internal:true});r.model=null;r.options={}})},add:function(r,x){var t=this;c.start(t.name+" add");t._logger.debug("Adding balloon %s %s %s from issue %s (%s)",r.get("type"),r.get("name"),r.get("revision"),t.model.get("title"),t.model.get("name"));var p=t.options.manager,v=r.get("physicalId");var u=p.getDisplayedBalloon(v);if(u!==undefined&&u.model.get("issue").get("id")!==t.model.get("id")&&x.isInspected!==true){t._logger.debug("The balloon %s %s %s is already displayed, the issue %s (%s) will be linked to it",r.get("type"),r.get("name"),r.get("revision"),t.model.get("title"),t.model.get("name"));t.balloons.push(u);t.linked.push(u);p.linkBalloonToIssue(v,t);return false}var s=p.groupBy(v),q=s!==undefined&&s.length>1?s.length:0;r.set("color",t.color,{silent:true});r.set("conflict",q,{silent:true});var w=new n({model:r,parent:t,viewer:t.options.viewer,window:t.options.window,controller:t.options.controller,isInspected:x.isInspected}).render();k.getWUXContextualMenu().addEventListener(w.container,{callback:function(){return k.getContextualMenu()}});t.balloons.push(w);p.registerBalloon(v,w);c.end(t.name+" add");return true},remove:function(p){var s=this;var r=s.options.manager;for(var q=0;q<s.balloons.length;q++){if(s.balloons[q].model.get("physicalId")===p.get("physicalId")){s._logger.debug("Removing balloon %s from issue %s (%s)",s.balloons[q].model.get("id"),s.model.get("title"),s.model.get("name"));var t=s.balloons[q].model.get("conflict");if(t===0){s.balloons[q].destroy();s.balloons.splice(q,1);r.deregisterBalloon(p.get("physicalId"))}else{require(["DS/Issue3DReview/commands/CommandsManager"],function(u){u.getCommand("Refresh").begin()})}}}if(s.balloons.length===0){s.destroy();return null}return s},select:function(){var q=this;q._logger.debug("Selecting issue %s",q.model.get("title"));q.isSelected=true;for(var p=0;p<q.balloons.length;p++){q.balloons[p].select()}q.utils.highlight(q);q.preview.enhance();return q},unselect:function(){var q=this;q._logger.debug("Unselecting issue %s",q.model.get("title"));q.isSelected=false;for(var p=0;p<q.balloons.length;p++){q.balloons[p].unselect()}q.utils.unhighlight(q);q.preview.brake();return q},show:function(){var r=this;var q=[];for(var p=0;p<r.balloons.length;p++){q.push(r.balloons[p].show())}return o.all(q)},hide:function(){var r=this;var q=[];for(var p=0;p<r.balloons.length;p++){q.push(r.balloons[p].hide())}return o.all(q)},inspect:function(){var p=this;p.isInspected=true;p.unselect();p.render({isInspected:true});return p},release:function(){var r=this;r.isInspected=false;var q=[];r.unselect();for(var p=0;p<r.balloons.length;p++){q.push(r.balloons[p].destroy())}return o.all(q).then(function(){r.balloons=[];var t=r.options.manager;for(var s=0;s<r.clones.length;s++){r.balloons.push(r.clones[s]);t.registerBalloon(r.clones[s].model.get("physicalId"),r.clones[s])}r.clones=[]})},_subscribers:function(){var p=this;p.listenTo(p,"onMouseOver",p._onMouseOver);p.listenTo(p,"onMouseOut",p._onMouseOut);p.listenTo(p,"onClick",p._onClick);p.listenTo(p,"onDoubleClick",p._onDoubleClick);p.listenTo(p,"onContextMenu",p._onContextMenu);p.listenTo(p.model,"onChange",p._onChange);p.listenTo(p.model.get("markers"),"onRemove",p._onRemoveMarker);p.listenTo(p.model.get("markers"),"onAdd",p._onAddMarker);p.listenTo(p,"onChange:position",p._onChangePosition)},_onMouseOver:function(s){var q=this;q._logger.debug("Issue %s mouseover with %s balloons",q.model.get("title"),q.balloons.length);q.isHovered=true;if(s.conflict>0){q._logger.debug("This balloon has a conflict, displaying the general preview");s.object.over();q.options.manager.preview.show(s);return false}for(var p=0;p<q.balloons.length;p++){q.balloons[p].over()}var r=s.object;s.object.container=s.balloon;if(q._preventPreview!==true){q.preview.show(r)}return true},_onMouseOut:function(r){var q=this;q._logger.debug("Issue %s mouseout with %s balloons",q.model.get("title"),q.balloons.length);q.isHovered=false;if(r.conflict>0){q._logger.debug("This balloon has a conflict, hiding the general preview");r.object.out();q.options.manager.preview.hide(r);return false}for(var p=0;p<q.balloons.length;p++){q.balloons[p].out()}q.preview.hide();return true},_onChangePosition:function(q){var p=this;var r=p.model.get("markers");if(r!==null){r.forEach(function(s){if(s.get("physicalId")===q.physicalId&&s.get("id")!==q.id){s.set("position",s.utils.getPosition(s,q.model.get("original")));s.set("original",q.model.get("original"))}})}},_onClick:function(q){var p=this;p._logger.debug("Issue %s clicked with multiple selection to %s",p.model.get("title"),q.isMultipleSelection);if(q.conflict===0){p._onMouseOver(q);p.preview.enhance()}if(p.isSelected===true){if(q.isMultipleSelection===true){p.unselect();p.options.manager.dispatchEvent("onUnselect",{id:q.id,issue:p,all:!p.isInspected,publish:true});return false}}p.options.manager.dispatchEvent("onSelect",{id:q.id,issue:p,isMultipleSelection:q.isMultipleSelection});p.select();return true},_onDoubleClick:function(q){var p=this;p._preventPreview=true;p.preview.brake();p._onClick(q);p.options.manager.dispatchEvent("onInspect",{id:q.id});p._preventPreview=false;return true},_onContextMenu:function(q){var p=this;if(q.conflict>0){p.options.manager.preview.hide(q)}else{p.preview.brake()}p._logger.debug("Issue %s context menu with multiple selection to %s",p.model.get("title"),q.isMultipleSelection);if(p.isSelected===false){p.select();p.options.manager.dispatchEvent("onSelect",{id:q.id,issue:p,isMultipleSelection:q.isMultipleSelection})}},_onChange:function(){var p=this;p._logger.debug("The model of the issue %s (%s) changed",p.model.get("title"),p.model.get("name"));p.color=p.options.colors[p.model.get("state")];var q=p.model.get("markers");if(q!==null){q.forEach(function(r){r.set({color:p.color})})}p.model.fetchPrimaryImage({onComplete:function(){}})},_onRemoveMarker:function(q,p){var r=this;r._logger.debug("The balloon %s %s %s from issue %s (%s) has been removed",q.get("type"),q.get("name"),q.get("revision"),r.model.get("title"),r.model.get("name"));r.remove(q,p)},_onAddMarker:function(q,p){var r=this;r._logger.debug("The balloon %s %s %s for issue %s (%s) has been added",q.get("type"),q.get("name"),q.get("revision"),r.model.get("title"),r.model.get("name"));if(r.add(q,p)===false){var t=r.linked[r.linked.length-1];var s=t.model.get("conflict");t.model.set("conflict",s===0?j.CONFLICT_NUMBER:s+1)}},utils:{highlight:function(q){if(q.hasOwnProperty("model")&&q.model!==null){var p=[];q.model.get("markers").forEach(function(s){var t=s.get("path");p.push(t)});var r=[];p.forEach(function(t){if(t.length){var s=q.options.controller.buildPathFromArray(t);if(s){r.push({pathElement:s})}}});f.add(r);d.add(r)}},unhighlight:function(q){if(q.hasOwnProperty("model")&&q.model!==null){var p=[];q.model.get("markers").forEach(function(s){var t=s.get("path");p.push(t)});var r=[];p.forEach(function(t){if(t.length){var s=q.options.controller.buildPathFromArray(t);if(s){r.push({pathElement:s})}}});f.remove(r);d.remove(r)}}}});return l});define("DS/Issue3DReview/views/Manager",["UWA/Class","UWA/Class/Promise","UWA/Class/View","UWA/Core","DS/UIKIT/Mask","DS/UIKIT/Popover","DS/Logger/Logger","DS/PADUtils/views/PADAlert","DS/PlatformAPI/PlatformAPI","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/Issue3DReview/collections/Issues","DS/Issue3DReview/commands/CommandsManager","DS/Issue3DReview/models/Issue","DS/Issue3DReview/views/Inspector","DS/Issue3DReview/views/Issue","DS/IssueServices/services/IssueServices","DS/IssueServices/utils/Performance","i18n!DS/Issue3DReview/assets/nls/Issue3DReview","i18n!DS/IssueCommon/assets/nls/IssueCommon"],function(q,e,p,i,y,r,v,s,d,u,l,m,a,t,x,k,g,c,h,o){var n={CREATE_STATE:"Create",ASSIGN_STATE:"Assign",ACTIVE_STATE:"Active",REVIEW_STATE:"Review",CLOSED_STATE:"Closed",CONFLICT_NUMBER:2,BROADCAST_SELECT_DEBOUNCE_TIMEOUT:100};var f=function(A,C,z){var B;return function(){var G=this,F=arguments;var E=function(){B=null;if(!z){A.apply(G,F)}};var D=z&&!B;clearTimeout(B);B=setTimeout(E,C);if(D){A.apply(G,F)}}};var w=this;var b=p.extend({name:"DS/Issue3DReview/views/Manager",_logger:null,defaultOptions:{component:null,context:null,roots:[],callback:null},component:null,nodes:{},paths:{},collection:null,inspector:null,_issues:[],_mapper:{},_balloons:{},_linker:{},_selectedIssues:{},_subscriberTokens:[],setup:function(z){var A=this;c.start(A.name+" setup");w=A;A._parent(z);A._logger=v.getLogger("DS/Issue3DReview/View");A._logger.debug("Initializing the manager...");A.component=z.component;var B=A.utils.parseChildren(z.roots);A.nodes=B.nodes;A.paths=B.paths;A.collection=new m([],{nodes:A.nodes,paths:A.paths});A.inspector=new x({manager:A.getManager()});A._issues=[];A._mapper={};A._balloons={};A._linker={};A._selectedIssues={};A.collection.fetch({onComplete:function(C){A.render();if(A.getOption("callback")!==null){A.getOption("callback")(C)}}});A._subscriberTokens=[];A._subscribers();c.end(A.name+" setup")},render:function(){var z=this;z._logger.debug("%s issue(s) to be displayed",z.collection.length);z.collection.forEach(function(B){var A=new k({manager:z,model:B,viewer:z.getOption("context").viewer,controller:z.getOption("context").controller,window:z.getOption("context").window}).render();z._issues.push(A);z._mapper[B.get("id")]=A});return z},destroy:function(){var B=this;B._logger.info("Destroying the manager...");B.stopListening(B,"onSelect");B.stopListening(B,"onUnselect");B.stopListening(B,"onInspect");B.stopListening(B.collection,"onReset");B.stopListening(B.collection,"onRemove");B.stopListening(B.collection,"onAdd");B._subscriberTokens.forEach(function(C){u.unsubscribe(C)});B._subscriberTokens=[];B.unselectAll({publish:false});B.inspector.destroy();B.inspector=null;var A=[];for(var z=0;z<B._issues.length;z++){A.push(B._issues[z].destroy())}B.component=null;B.nodes={};B.paths={};B.preview.destroy();return e.all(A).then(function(){B.collection=null;B._issues=[];B._mapper={};B._balloons={};B._linker={};B._selectedIssues={};B._subscriberTokens=[]})},refreshIssuesById:function(z){var C=this;c.start(C.name+" refreshIssuesById");var B=z.ids,A=[];B.forEach(function(D){A.push(new e(function(G){var E=C.collection.get(D);if(E&&i.is(E,"object")){E.fetch({timestamp:z.timestamp,onComplete:function(H){G(H)},collection:C.collection});E.fetchPrimaryImage({onComplete:function(){},onFailure:function(H){C._logger.error(H)}})}else{var F=new t({id:D});F.fetch({timestamp:z.timestamp,add:true,onComplete:function(H){if(F.get("markers")&&F.get("markers").length>0){C.collection.add(F,{});G(H)}else{F=null}},collection:C.collection,parse:true})}}))});return e.all(A)},removeIssuesById:function(z){var B=this;var A=z.ids;A.forEach(function(C){B.collection.remove(C)});return e.resolve()},show:function(){var B=this;var A=[];for(var z=0;z<B._issues.length;z++){A.push(B._issues[z].show())}return e.all(A)},hide:function(){var B=this;var A=[];for(var z=0;z<B._issues.length;z++){A.push(B._issues[z].hide())}return e.all(A)},select:function(B){var F=this;var E=B.ids,A=B.unselectAll===true,D=B.publish===true;if(A===true){F.unselectAll({publish:false})}for(var C=0;C<E.length;C++){var z=F._mapper[E[C]];if(z===undefined){continue}F._selectedIssues[E[C]]=z;z.select();z.utils.highlight(z)}a.select(Object.keys(F._selectedIssues));F.component.dispatchEvent("onSelect");if(D===true){F.pushBroadcastSelect()}},unselect:function(z){var D=this;var C=z.ids,B=z.publish===true;for(var A=0;A<C.length;A++){D._selectedIssues[C[A]].unselect();delete D._selectedIssues[C[A]]}a.select(Object.keys(D._selectedIssues));D.component.dispatchEvent("onUnselect");if(B===true){D.pushBroadcastSelect()}},unselectAll:function(z){var B=this;var A=z.publish===true;B.unselect({ids:Object.keys(B._selectedIssues),publish:A});B._selectedIssues={}},buildBroadcastSelect:function(){var A=this;c.start(A.name+" buildBroadcastSelect");var B=[],z={};A.getSelectedIssues().forEach(function(C){B.push([C.id]);z[C.id]={id:C.id,type:C.type,name:C.name,title:C.title}});c.end(A.name+" buildBroadcastSelect");return{paths:B,attributes:z}},pushBroadcastSelect:f(function j(){var z=this;c.start(z.name+" pushBroadcastSelect");var A=z.buildBroadcastSelect();z.component.publishSelect(A);z.component.publishCompass();c.end(z.name+" pushBroadcastSelect")},n.BROADCAST_SELECT_DEBOUNCE_TIMEOUT),inspect:function(z){var A=this;return A.inspector.inspect({ids:z})},release:function(){var z=this;return z.inspector.release()},groupBy:function(A){var z=this;return z.collection.groupBy(A)[A]},getManager:function(){var z=this;return z},getCollection:function(){var z=this;return z.collection},getIssues:function(){var z=this;return{map:z._mapper,array:z._issues}},getNodes:function(){var z=this;return z.nodes},getNodesById:function(A){var z=this;return z.collection.getNodesById(A)},getNeutralNodes:function(){var z=this;return z.collection.getNeutralNodes()},getReportedNodes:function(){var z=this;return z.collection.getReportedNodes()},getDisplayedBalloon:function(A){var z=this;return z._balloons[A]},getSelectedIssues:function(){var C=this;var B=[];for(var D in C._selectedIssues){if(C._selectedIssues.hasOwnProperty(D)){var A=C._selectedIssues[D].model,z={id:A.get("id"),type:A.get("type"),title:A.get("title"),name:A.get("name")};B.push(z)}}return B},getInspectedIssues:function(){var z=this;return z.inspector.getInspectedIssues()},getReportedAgainstFromSelectedIssues:function(){var D=this;var B=D.getSelectedIssues(),A=D.getIssues().map;var z=[];for(var C=0;C<B.length;C++){if(i.is(A[B[C].id],"object")){z=z.concat(A[B[C].id].model.get("reportedAgainst"))}}return z.reduce(function(F,E){F.push(E.physicalId);return F},[])},registerBalloon:function(B,A){var z=this;z._balloons[B]=A},deregisterBalloon:function(A){var z=this;delete z._balloons[A]},linkBalloonToIssue:function(B,z){var A=this;if(A._linker[B]===undefined){A._linker[B]={}}A._linker[B][z.model.get("id")]=z},unlinkBalloonToIssue:function(B,z){var A=this;if(A._linker[B]!==undefined){delete A._linker[B][z]}},_onSelect:function(B){var A=this;if(B.isMultipleSelection===false){A.unselectAll({publish:false});l.empty()}if(A.inspector.isInspected()!==true){var z=A.groupBy(B.id);if(z.length>1){z.forEach(function(C){var D=C.get("id");A._mapper[D].utils.highlight(A._mapper[D]);A._selectedIssues[D]=A._mapper[D]})}}A.select({ids:[B.issue.model.get("id")],publish:true,unselectAll:false})},_onUnselect:function(D){var C=this;if(D.all===true){var z=C.groupBy(D.id);z.forEach(function(E){var F=E.get("id");delete C._selectedIssues[F]})}C.unselect({ids:[D.issue.model.get("id")]});var B=Object.keys(C._selectedIssues);for(var A=0;A<B.length;A++){C._selectedIssues[B[A]].utils.highlight(C._selectedIssues[B[A]])}if(D.publish===true){C.pushBroadcastSelect()}},_onInspect:function(){a.getCommand("Inspect").begin()},_subscribers:function(){var z=this;z.listenTo(z,"onSelect",z._onSelect);z.listenTo(z,"onUnselect",z._onUnselect);z.listenTo(z,"onInspect",z._onInspect);z._subscriberTokens.push(u.onEmpty(function(){z.unselectAll({publish:true})}));z.listenTo(z.collection,"onReset",z._onReset);z.listenTo(z.collection,"onRemove",z._onRemove);z.listenTo(z.collection,"onAdd",z._onAdd)},_onReset:function(){},_onRemove:function(B,E,A){var D=this;if(A&&A.internal===true){var z=[],F=B.get("id");for(var C=0;C<D._issues.length;C++){if(D._issues[C].model.get("id")!==F){z.push(D._issues[C])}}D._issues=z;delete D._mapper[B.get("id")]}else{require(["DS/Issue3DReview/commands/CommandsManager"],function(G){G.getCommand("Refresh").begin()})}},_onAdd:function(A){var B=this;B._logger.debug("The issue %s (%s) has been added to the collection, now creating the view",A.get("title"),A.get("name"));var z=new k({manager:B,model:A,viewer:B.getOption("context").viewer,controller:B.getOption("context").controller,window:B.getOption("context").window}).render();B._issues.push(z);B._mapper[A.get("id")]=z;z.linked.forEach(function(D){var C=D.model.get("conflict");D.model.set("conflict",C===0?n.CONFLICT_NUMBER:C+1)})},preview:{_templates:{conflict:function(z){return'<div class="issue-preview-conflict"><div class="issue-preview-conflict-body">'+z+'</div><div class="issue-preview-conflict-enhanced"></div></div>'}},_preview:null,show:function(F){var E=this;w._logger.debug("Loading the preview for conflicted issues");var C=w.groupBy(F.id),H={};H[n.CREATE_STATE]=0;H[n.ASSIGN_STATE]=0;H[n.ACTIVE_STATE]=0;H[n.REVIEW_STATE]=0;H[n.CLOSED_STATE]=0;for(var D=0;D<C.length;D++){var z=C[D].get("state");H[z]+=1}var G=Object.keys(H),A="";for(var B=0;B<G.length;B++){if(H[G[B]]!==0){A+='<span class="issue-label-'+G[B].toLowerCase()+'"></span>'+H[G[B]].toString()+" "+o.maturity[G[B].toLowerCase()]+"</br>"}}E._preview=new r({target:F.balloon,trigger:"manual",position:"right",body:E._templates.conflict(A)});E._preview.toggle()},enhance:function(){},hide:function(){var z=this;if(z._preview!==null){z._preview.destroy();z._preview=null}},destroy:function(){var z=this;if(z._preview!==null){z._preview.destroy();z._preview=null}}},utils:{parseChildren:function(z){var A={},C={};function B(D,G){for(var E=0;E<D.length;E++){var F=D[E];if(F&&F.getID){var I=F.getID();var H=G.slice();H.push(I);if(F.isPLMReference()||F.isPLMRepReference()){A[H.join(",")]=F;C[I]?C[I].push(H):C[I]=[H]}B(D[E].children,H)}}}B(z,[]);return{nodes:A,paths:C}}}});return b});define("DS/Issue3DReview/Component",["UWA/Class/Promise","UWA/Class/View","UWA/Core","DS/UIKIT/Tooltip","DS/Logger/Logger","DS/PlatformAPI/PlatformAPI","DS/IssueCommon/utils/TaskManager","DS/IssueComponents/helper/Helper","DS/IssueComponents/open/Open","DS/Issue3DReview/commands/CommandsManager","DS/Issue3DReview/views/Manager","DS/IssueServices/Contexts","DS/IssueServices/utils/Performance","DS/IssueServices/utils/Views","i18n!DS/Issue3DReview/assets/nls/Issue3DReview","css!DS/Issue3DReview/Issue3DReview.css","css!DS/UIKIT/UIKIT.css"],function(l,c,g,m,f,n,k,j,o,b,a,e,d,h,q){var i={ISSUE_MANAGEMENT:"ENXISSU_AP",ISSUE_3D_REVIEW:"ENX3DIR_AP",FIRST_ELEMENT_IN_PATH:0,METADATA:{ISU_TASK_MANAGER:"ISU_TASK_MANAGER"},TASKS:{SELECT_IN_3D:"SELECT_IN_3D",TAKE_SCREENSHOT:"TAKE_SCREENSHOT"}};var p=c.extend({name:"DS/Issue3DReview/Component",_logger:null,manager:null,context:{},taskManager:null,_issues:{},_nodes:{},_temporary:[],_isProcessing:false,_subscriberTokens:[],_tasks:{subscriberTokens:[],current:null},_timestampUpdate:0,setup:function(s){var t=this;d.start(t.name+" setup");t._parent(s);t._logger=f.getLogger(t.name);t._logger.log("Initializing the main component...");t.manager=null;var r=e.get("pad3DViewer");t.context={root:r,viewer:r.getViewer(),window:r.getFrameWindow(),controller:r.getController()};t.taskManager=k;t._issues={};t._nodes={};t._temporary=[];t._isProcessing=false;t.utils.displayHelper();t._subscriberTokens=[];t._tasks={subscriberTokens:[],current:null};t._timestampUpdate=0;t.utils._setTypesCallbackSubscribe=false;t._subscribers();t._subscribersTaskManager();return t},render:function(){var r=this;return r},display:function(r){var s=this;if(s.isProcessing()===true){return l.reject(new Error("A command is already processing, please wait"))}s._isProcessing=true;s._logger.info("Displaying all the issues, parsing roots and instantiating manager");return new l(function(t){if(s.manager!==null){s.manager.destroy().then(function(){s.manager=null;t()})}else{t()}}).then(function(){return new l(function(u){s.manager=new a({component:s,roots:r,context:s.context,callback:function(){s._isProcessing=false;s.dispatchEvent("onDisplay");u()}});var t=s.getOption("events");s.listenTo(s.manager.getCollection(),"onAdd",function(){if(t&&g.is(t.onIssuesAdded,"function")){t.onIssuesAdded()}});s.listenTo(s.manager.getCollection(),"onRemove",function(){if(t&&g.is(t.onIssuesRemoved,"function")){t.onIssuesRemoved()}})})})},destroy:function(){var r=this;r._subscriberTokens.forEach(function(s){n.unsubscribe(s)});r._tasks.subscriberTokens.forEach(function(s){n.unsubscribe(s)});if(r.manager!==null){r.manager.getCollection().stopListening("onAdd");r.manager.getCollection().stopListening("onRemove");r.manager.destroy();r.manager=null}r._timestampUpdate=0;r._subscriberTokens=[];r.utils._setTypesCallbackSubscribe=false;r._tasks={subscriberTokens:[],current:null};r.taskManager.destroy();r.taskManager=null},clear:function(){var r=this;if(r.isProcessing()===true){return l.reject(new Error("A command is already processing, please wait"))}if(r.manager===null){return l.resolve()}if(r.isFocused()===true){var s=b.getCommandCheckHeader("Focus");s.toggleState()}r._isProcessing=true;return r.release().then(function(){return r.manager.destroy()}).then(function(){r.manager=null;r._isProcessing=false;r.dispatchEvent("onClear")})},refresh:function(r){var s=this;if(s.isProcessing()===true){return l.reject(new Error("A command is already processing, please wait"))}e.get("filter").refresh();if(s.manager===null){return l.resolve()}return s.clear().then(function(){return s.display(r)})},focus:function(){var r=b.getCommandCheckHeader("Focus");r.toggleState()},inspect:function(r){var s=this;if(s.manager===null){return l.resolve()}return s.manager.inspect(r).then(function(){s.dispatchEvent("onInspect")})},release:function(){var r=this;if(r.manager===null){return l.resolve()}return r.manager.release().then(function(){r.dispatchEvent("onRelease")})},publishSelect:function(s){var r=e.get("widget");n.publish("DS/Object/select",{metadata:{appId:r.id,appName:r.name,timestamp:Math.floor(Date.now())},data:{paths:s.paths,attributes:s.attributes},version:"1.0"})},publishCompass:function(){var s=this;if(s.manager===null){return}var r=s.manager.getReportedAgainstFromSelectedIssues();s.utils.setTypesCallbackForOFW(r)},isDisplayed:function(){return b.getCommandCheckHeader("Display").getState()},isFocused:function(){return b.getCommandCheckHeader("Focus").getState()},isInspected:function(){var s=this;var r=s.getManager();if(r!==null&&r.inspector!==null){return r.inspector.isInspected()}return false},isProcessing:function(){var r=this;return r._isProcessing},getManager:function(){var r=this;return r.manager},getIssues:function(){var r=this;if(r.manager===null){return[]}return r.manager.getIssues()},getSelectedIssues:function(){var r=this;if(r.manager===null){return[]}return r.manager.getSelectedIssues()},getInspectedIssues:function(){var r=this;if(r.manager===null){return[]}return r.manager.getInspectedIssues()},get3DContext:function(){var r=this;return r.context},_subscribers:function(){var r=this;var s=e.get("widget");r._subscriberTokens.push(n.subscribe("DS/Object/create",function(u){d.start(r.name+" DS/Object/create");if(r.manager===null){return}var t=u.data.attributes;r.manager.refreshIssuesById({timestamp:u.metadata.timestamp,ids:Object.keys(t)}).then(function(){d.end(r.name+" DS/Object/create")})}));r._subscriberTokens.push(n.subscribe("DS/Object/update",function(u){if(r.manager===null){return}if(r._timestampUpdate!==u.metadata.timestamp){d.start(r.name+" DS/Object/update");r._timestampUpdate=u.metadata.timestamp;var t=u.data.attributes;r.manager.refreshIssuesById({timestamp:u.metadata.timestamp,ids:Object.keys(t)}).then(function(){if(r.isInspected()){var v=r.getManager().inspector;return v.refresh()}else{return l.resolve()}}).then(function(){r.dispatchEvent("onUpdate");d.end(r.name+" DS/Object/update")})}}));r._subscriberTokens.push(n.subscribe("DS/Object/delete",function(u){d.start(r.name+" DS/Object/delete");if(r.manager===null){return}var t=[];u.data.paths.forEach(function(v){t.push(v.pop())});r.manager.removeIssuesById({timestamp:u.metadata.timestamp,ids:t}).then(function(){r.dispatchEvent("onDelete");d.end(r.name+" DS/Object/delete")})}));r._subscriberTokens.push(n.subscribe("DS/Object/select",function(u){if(r.manager===null){return}if(u.metadata.appId===s.id){return}if(r._tasks.current!==null){if(r._tasks.current.taskType===i.TASKS.SELECT_IN_3D){r.taskManager.cancel(r._tasks.current.taskId)}}var t=Object.keys(u.data.attributes);r.manager.select({ids:t,publish:false,unselectAll:true});r.dispatchEvent("onSelect")}));r._subscriberTokens.push(n.subscribe("DS/Widget/preferences",function(v){if(v.metadata.appId===s.id||v.metadata.appName!==i.ISSUE_MANAGEMENT){return}try{var t=JSON.parse(v.data.preferences);t.forEach(function(w){if(w.name==="filter"){var y=JSON.parse(w.value);if(s.getValue("filter")!==w.value){var x=JSON.parse(s.getValue("filter"));if(x.synchronize===true){y.synchronize=true;s.setValue("filter",JSON.stringify(y));setTimeout(function(){e.get("application").refresh()},0)}}}})}catch(u){r._logger.error(u)}}))},_subscribersTaskManager:function(){var u=this;var w=e.get("widget");var v=function(){var x=w.body.getDimensions().height,y=window.getComputedStyle(w.body);if(x===0||y.display==="none"){return false}else{if(u.isInspected()===true){return false}}return true};u._tasks.subscriberTokens.push(n.subscribe("DS/IssueManagementTask/add",function r(z){d.start(u.name+" DS/IssueManagementTask/add");if(g.is(z.metadata,"object")&&g.is(z.metadata.options,"object")&&g.equals(z.metadata.options[i.METADATA.ISU_TASK_MANAGER],i.METADATA.ISU_TASK_MANAGER)&&Array.isArray(z.data.paths)&&z.data.paths.length>0){var B=z.data.paths[i.FIRST_ELEMENT_IN_PATH][i.FIRST_ELEMENT_IN_PATH],y=z.data.attributes[B];if(!g.is(u._tasks.current)){if(v()){if(Object.keys(i.TASKS).indexOf(y.taskType)!==-1){var A=[],x={};A.push([B]);x[B]={taskType:y.taskType,widgetIdIM:y.widgetIdIM,widgetId3D:w.id};n.publish("DS/IssueManagementTask/ready",{metadata:{appId:w.id,appName:w.name,timestamp:Math.floor(Date.now()),options:{}},data:{paths:A,attributes:x},version:"1.0"})}else{}}else{}}else{}}else{}d.end(u.name+" DS/IssueManagementTask/add")}));u._tasks.subscriberTokens.push(n.subscribe("DS/IssueManagementTask/exec",function t(y){d.start(u.name+" DS/IssueManagementTask/exec");if(g.is(y.metadata,"object")&&g.is(y.metadata.options,"object")&&g.equals(y.metadata.options[i.METADATA.ISU_TASK_MANAGER],i.METADATA.ISU_TASK_MANAGER)&&Array.isArray(y.data.paths)&&y.data.paths.length>0){var z=y.data.paths[i.FIRST_ELEMENT_IN_PATH][i.FIRST_ELEMENT_IN_PATH],x=y.data.attributes[z];if(w.name===i.ISSUE_3D_REVIEW&&x.widgetId3D===w.id){new l(function(A){if(u.isDisplayed()!==true){require(["DS/UIKIT/Mask","DS/ApplicationFrame/CommandsManager"],function(C,B){C.mask(w.body);u.listenTo(u,"onDisplay",function(){u.stopListening(u,"onDisplay");C.unmask(w.body);A()});B.getCommandCheckHeader("Display").toggleState()})}else{A()}}).then(function(){u._tasks.current={taskId:z,taskType:x.taskType,widgetIdIM:x.widgetIdIM,widgetId3D:w.id}}).then(function(){if(g.is(u._taskHandlers[x.taskType],"function")){return u._taskHandlers[x.taskType].call(u,x.args)}else{return l.resolve()}}).then(function(A){if(g.is(A,"object")){u._tasks.current.cancel=A}})["catch"](function(A){u._tasks.current=null;u._logger.error(A)})}else{}}else{}d.end(u.name+" DS/IssueManagementTask/exec")}));u._tasks.subscriberTokens.push(n.subscribe("DS/IssueManagementTask/cancel",function s(A){d.start(u.name+" DS/IssueManagementTask/cancel");if(g.is(A.metadata,"object")&&g.is(A.metadata.options,"object")&&g.equals(A.metadata.options[i.METADATA.ISU_TASK_MANAGER],i.METADATA.ISU_TASK_MANAGER)&&Array.isArray(A.data.paths)&&A.data.paths.length>0){var C=A.data.paths[i.FIRST_ELEMENT_IN_PATH][i.FIRST_ELEMENT_IN_PATH],x=A.data.attributes[C];if(x.taskId===u._tasks.current.taskId&&x.widgetId3D===w.id&&x.widgetIdIM===u._tasks.current.widgetIdIM){if(g.is(u._tasks.current.cancel,"object")){if(g.is(u._tasks.current.cancel.method,"function")){var B=u._tasks.current.cancel.method;var z=u._tasks.current.cancel.context||null;var y=u._tasks.current.cancel.args||[];B.apply(z,y)}}u._tasks.current=null}else{}}else{}d.end(u.name+" DS/IssueManagementTask/cancel")}))},_taskHandlers:{SELECT_IN_3D:function(){var r=this;var s=e.get("widget");return r.utils.selectIn3D(function(y,t,v,w){var z=[],u={};var x={};x.nodes=[];v.nodes.forEach(function(){x.nodes.push("node")});x.paths=v.paths;z.push([r._tasks.current.taskId]);u[r._tasks.current.taskId]={taskType:r._tasks.current.taskType,widgetIdIM:r._tasks.current.widgetIdIM,widgetId3D:r._tasks.current.widgetId3D,response:{target:y,positions:t,nodes:x,context:w}};n.publish("DS/IssueManagementTask/done",{metadata:{appId:s.id,appName:s.name,timestamp:Math.floor(Date.now()),options:{}},data:{paths:z,attributes:u},version:"1.0"});r._tasks.current=null},function(){var u=[],t={};u.push([r._tasks.current.taskId]);t[r._tasks.current.taskId]={taskType:r._tasks.current.taskType,widgetIdIM:r._tasks.current.widgetIdIM,widgetId3D:r._tasks.current.widgetId3D};n.publish("DS/IssueManagementTask/done",{metadata:{appId:s.id,appName:s.name,timestamp:Math.floor(Date.now()),options:{canceled:true}},data:{paths:u,attributes:t},version:"1.0"});r._tasks.current=null})},TAKE_SCREENSHOT:function(){var s=this;var t=e.get("widget");return s.utils.takeAnnotation(function u(y){var x={data:y.dataURL,fileName:"screenshot-"+Math.floor(Date.now())+".png",fileType:"image/png",lastModified:new Date()};var z=[],w={};z.push([s._tasks.current.taskId]);w[s._tasks.current.taskId]={taskType:s._tasks.current.taskType,widgetIdIM:s._tasks.current.widgetIdIM,widgetId3D:s._tasks.current.widgetId3D,response:x};n.publish("DS/IssueManagementTask/done",{metadata:{appId:t.id,appName:t.name,timestamp:Math.floor(Date.now()),options:{}},data:{paths:z,attributes:w},version:"1.0"});s._tasks.current=null},function v(){var x=[],w={};x.push([s._tasks.current.taskId]);w[s._tasks.current.taskId]={taskType:s._tasks.current.taskType,widgetIdIM:s._tasks.current.widgetIdIM,widgetId3D:s._tasks.current.widgetId3D};n.publish("DS/IssueManagementTask/done",{metadata:{appId:t.id,appName:t.name,timestamp:Math.floor(Date.now()),options:{canceled:true}},data:{paths:x,attributes:w},version:"1.0"});s._tasks.current=null},function r(w){s._logger.error(w)})}},utils:{_setTypesCallbackSubscribe:false,setTypesCallbackForOFW:function(s){var r=this;o.setTypesCallbackForOFW(s,{setTypesCallbackSubscribe:r._setTypesCallbackSubscribe});r._setTypesCallbackSubscribe=true},displayHelper:function(){var v=e.get("widget");var s=e.get("pad3DViewer");var r=s.getContent();var t=g.createElement("span",{"class":"issue-status-left fonticon fonticon-help-circled"});r.appendChild(t);var u=new m({className:"helper-tooltip",position:"top",target:t,body:q.tooltips.helper,trigger:"touch",});t.addEventListener("click",function(){u.hide();j.show(v.body)});return u},createBalloon:function(r){return new l(function(s){require(["DS/Issue3DReview/views/Balloon","DS/Issue3DReview/models/Issue","DS/Issue3DReview/models/Marker"],function(w,y,t){var v=e.get("component").get3DContext();var u=new t({id:r.id,issue:new y({}),name:"",title:"",state:"",description:"",position:r.position,path:r.path,temporary:r.temporary||false});u.set("color",r.color);u.set("conflict",0);var x=new w({parent:r.parent,model:u,isInspected:false,viewer:v.viewer,window:v.window,controller:v.controller});x.render({callback:function(){s(x)}})})})},selectIn3D:function(r,s){return new l(function(t){require(["DS/Issue3DReview/utils/ViewerManipulator"],function(u){var v={method:u.selectIn3D(r,s),context:null,args:[true]};t(v)})})},takeAnnotation:function(r,t,s){return new l(function(v,u){require(["DS/2DAnnotation/2DAnnotation","DS/UIKIT/Mask"],function(z,B){var y=e.get("widget");B.mask(y.body);var x=e.get("component").get3DContext();var A=g.Element.getElement.call(x.root.getFrameWindow().elements.viewerFrame,"canvas");var w=new z({className:"create-attachments-annotation",saveCallback:function(C){r(C);w.destroy()},exitCallback:function(){t();w.destroy()},captureTarget:A});w.render();w.isLoaded.then(function(){B.unmask(y.body);w.container.inject(y.body);v({method:w.callbacks.exitCallback,context:null,args:[true]})})["catch"](function(C){B.unmask(y.body);s(C);u(C)})})})}}});return p});