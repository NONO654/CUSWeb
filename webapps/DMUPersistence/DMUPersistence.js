define("DS/DMUPersistence/DMUSaveCmd",["DS/DMUBaseCommands/EXPCommand","DS/DMUControls/EXPNotify","DS/DMUReadPersistence/DMUReviewPersistenceServices","DS/DMUReadPersistence/DMUPersistenceServices","DS/DMUBaseExperience/EXPUtils","DS/ApplicationFrame/CommandsManager","DS/DMUBaseExperience/EXPToolsVisualization","DS/DMUBaseExperience/DMUContextManager","DS/DMUReadPersistence/DMUReviewPersistenceServicesSetting","DS/Mesh/MeshUtils","DS/DMUMeasurable/DMUToolsSceneGraph","i18n!DS/DMUPersistence/assets/nls/DMUPersistence"],function(m,i,g,j,h,a,d,k,f,b,l,c){var e=m.extend({init:function(x){var s=this;this._parent(x);var q,u;var w=new g();this._cleanCommand=function(){if(q){q.destroy()}q=null};this._performCallback=function(){var y=k.getReviewContext({viewer:s._viewer});if(y&&y._nNode){s.emptyCSO();y._nNode.setPickable(b.NODRAWHL);s._viewer.render();if(h.isPersistenceAllowed()){if(y.getUIManager()){y.getUIManager().disableAllCmds()}w.getDMUServerCode(function(){if(y.getCurrentReview()&&y.getCurrentReview()._isDirty===1){y.getCurrentReview().addOrModifyEnvironment()}new j({viewer:s._viewer}).doExport(r,t)},function(){t("TryAgain")})}else{if(q){q.destroy();q=null}q=new i({body:s._frmWindow.getUIFrame(),type:"info",messages:c.saveError3})}}else{t("NoSaveNeeded")}};function r(z){var D;if(u){u.on(c.SavingStep,null)}var C=k.getReviewContext({viewer:s._viewer});if(C&&C._reviewPhysId){D=function(F){C.getCurrentReview().setImage(F);var E={thumbnail:F,json:z,reviewPhysicalId:C._reviewPhysId.reviewId,reviewThumbId:C._reviewPhysId.reviewThumbId,markupName:C._reviewPhysId.reviewName};w.updateReviewAndJSONFile(E,v,t)}}else{if(C){var B=null;var A=k.getContextViewer({reviewContext:C});if(A){var y=l.getRoots(A);if(y&&y.length){B=l.getNodeID(y[0])}}D=function(F){C.getCurrentReview().setImage(F);var E={thumbnail:F,json:z,rootPhysicalId:B,reviewPhysicalId:C._reviewPhysId?C._reviewPhysId.reviewId:null};w.createReviewAndJSONFile(E,s._frmWindow,function(G){v(G);if(A&&A.getWidget()){A.getWidget().dispatchEvent("onReviewLoaded",G.reviewId)}},t)}}}d.computeImage(s._viewer,100,75,{onSuccess:D})}function n(){if(u&&u._counter>0){u.off()}}function v(z){n();o();var A=k.getReviewContext({viewer:s._viewer});var y=A.getPersistenceManager();if(y){y.resetDirtifcation()}A._reviewPhysId=z;if(q){q.destroy();q=null}q=new i({body:s._frmWindow.getUIFrame(),type:"info",messages:c.saveOK})}function t(z){n();o();if(z!=="Cancel"){var y=c.saveError1;if(z==="NoSaveNeeded"){y=c.saveError2}else{if(z==="TryAgain"){y=c.saveError4}else{if(z&&z.error.indexOf("file id must be specified")!==-1){y=z.reviewName+c.saveError5;k.removeReviewContext({viewer:s._viewer});window.widget.setValue("reviewIdInSession","")}}}if(q){q.destroy();q=null}q=new i({body:s._frmWindow.getUIFrame(),type:"info",messages:y})}else{o()}}function o(){var y=k.getReviewContext({viewer:s._viewer});if(y){if(y.getUIManager()){y.getUIManager().restoreCmds()}if(y._nNode){y._nNode.setPickable(b.PICKABLE)}}s._viewer.render()}f.doInitialize();var p="DS/PADUtils/views/PADProgressBar";require([p],function(y){u=y;w.setProgressBar(u)})},endExecute:function(){if(this._cleanCommand){this._cleanCommand()}this._parent()}});return e});define("DS/DMUPersistence/DMULoadMarkupServices",["UWA/Class","DS/DMUControls/EXPNotify","DS/DMUBaseUI/DMUInitialization","DS/DMUReadPersistence/DMUReviewPersistenceServices","DS/DMUReadPersistence/DMUPersistenceServices","DS/ApplicationFrame/CommandsManager","DS/Mesh/MeshUtils","DS/CoreEvents/ModelEvents","DS/DMUPlaySlide/controllers/DMUSlidesController","DS/DMUMeasurable/DMUToolsSceneGraph","DS/DMUBaseExperience/DMUContextManager","i18n!DS/DMUPersistence/assets/nls/DMUPersistence"],function(c,j,l,i,k,a,d,e,g,n,m,h){var f=c.extend({init:function(y){var A=this,w,G,z=true,F=new e(),B=y.ctxViewer,H=[],q=[];var x=new i();var v="DS/PADUtils/views/PADProgressBar";require([v],function(K){w=K;x.setProgressBar(w)});function D(){if(w&&w._counter>0){w.off()}}function J(){var L=g.giveDMUSlidesController({context:B});if(L){L.setPlayMode(true)}I(false);var N=m.getReviewContext({context:B});if(N&&N.getCurrentReview()){N.getCurrentReview().setReadOnly(true)}var M=a.getCommand("loadCmdHdr",B.getCommandContext());if(M){M.enable()}var K=a.getCommand("RemoveAllHdr",B.getCommandContext());if(K){K.enable()}}function C(K){I(true);D();m.removeReviewContext({context:B});l.createReviewContext({context:B});new k({viewer:B.getViewer()}).importModel({dataJson:K.jsonObj,appType:K.ID},function(){var L=m.getReviewContext({context:B});L._reviewPhysId={reviewId:K.reviewPid,reviewThumbId:K.reviewThumbId,reviewName:K.reviewName};if(!K.modifiable){J()}s("info",K.modifiable?h.loadOK:h.ReviewReserved);p("onReviewLoaded",{id:K.ID})})}function t(K){D();var L=m.getReviewContext({context:B});u(K!=="Cancel"?(K==="NoMarkup"?h.loadNoMarkup:h.loadError):undefined);if(L&&L.getCurrentReview()&&L.getCurrentReview().isReadOnly()){J()}}function s(K,L){if(G){G.destroy();G=null}G=new j({body:B.getFrameWindow().getUIFrame(),type:K,messages:L})}function u(K){D();I(true);if(K){s("error",K)}p("onReviewLoadFailed")}function I(K){if(K===z){return}z=K;var L=m.getReviewContext({context:B});if(z){if(!L){E()}else{L.getUIManager().restoreCmds()}if(L&&L._nNode){L._nNode.setPickable(d.PICKABLE)}}else{if(!L){r()}else{L.getUIManager().disableAllCmds()}if(L&&L._nNode){L._nNode.setPickable(d.NODRAWHL)}}B.getViewer().render()}function r(){var N=a.getCommands(B.getCommandContext());for(var M in N){if(N.hasOwnProperty(M)){var L=N[M];H.push({_id:L._id,_isEnabled:L._isEnabled})}}var K=a.getCommandCheckHeaders(B.getCommandContext());for(var M in K){if(K.hasOwnProperty(M)){var L=K[M];q.push({_id:L._id,_isEnabled:L._isEnabled})}}a.disableAll(B.getCommandContext())}function E(){if(H){H.forEach(function(K){var L=a.getCommand(K._id,B.getCommandContext());if(L){if(K._isEnabled){L.enable()}else{L.disable()}}});H=[]}if(q){q.forEach(function(L){var K=a.getCommandCheckHeader(L._id,B.getCommandContext());if(L){if(L._isEnabled){K.enable()}else{K.disable()}}});q=[]}}function p(L,K){if(F){F.publish({event:L,data:K,context:A})}}this.subscribe=function(L,K){if(L&&K){return F.subscribe({event:L},K)}};this.unsubscribe=function(K){if(F&&K){F.unsubscribe(K)}};this.load=function(P){if(P){if(w){w.on(h.LoadingPanel,null)}var M=function(S){var R=S.data[0].dataelements.parentId;var V=false;var U=false;var Q=n.getRootReferences(B.getViewer());if(Q.length===0){V=true;U=true}else{for(var T=0;T<Q.length;T++){if(n.getNodeID(Q[T])===R){U=true;break}}}if(V){B.addRoots({objects:[{path:[R]}]})}if(U){x.getDnDReviewAndJSONFile({markupId:P},C,t)}else{if(!V){u(h.DragAndDropError)}}};x.getProductByMarkerId({physicalid:P},M,function(){u(h.loadError)})}else{I(false);var L=n.getRoots(B),N=n.getNodeID(L[0]);var O=function(){if(w){w.on(h.LoadingPanel,null)}x.getReviewAndJSONFile(N,B.getFrameWindow(),C,t)};var K=L.length;if(K>1){x.createForm(B.getFrameWindow(),"ChoosePanel",O,function(Q){if(Q==="Cancel"){I(true)}})}else{if(K>0){O()}else{u(h.SelectReviewError)}}}};this.clearController=function(){if(G){G.destroy()}B=G=F=null}}});var b=[];var o=c.singleton({init:function(){},giveLoadMarkupServices:function(q){if(q&&q.context){for(var p=0;p<b.length;p++){if(b[p].context===q.context){return b[p].controller}}}},getLoadMarkupServices:function(q){if(q&&q.context){var r=this.giveLoadMarkupServices(q);if(r){return r}var p=new f({ctxViewer:q.context});r=Object.freeze({load:function(s){if(p){return p.load(s)}},subscribe:function(s,t){if(p){return p.subscribe(s,t)}},unsubscribe:function(s){if(p){return p.unsubscribe(s)}},clearController:function(){if(p){p.clearController();p=null}}});b.push({context:q.context,controller:r});return r}},unreferenceLoadMarkupServices:function(q){if(q&&q.context){for(var p=0;p<b.length;p++){if(b[p].context===q.context){b[p].controller.clearController();b.splice(p,1);break}}}}});return o});define("DS/DMUPersistence/DMUPersistence",[],function(){});define("DS/DMUPersistence/DMULoadCmd",["DS/DMUBaseCommands/EXPCommand","DS/DMUBaseExperience/DMUContextManager","DS/DMUPersistence/DMULoadMarkupServices"],function(b,c,a){var d=b.extend({_performCallback:function(){var e=a.giveLoadMarkupServices({context:c.getContextViewer({viewer:this.getFrameWindow().getViewer()})});if(e){e.load()}}});return d});