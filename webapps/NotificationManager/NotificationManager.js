define("DS/NotificationManager/view/notificationManagerView",["UWA/Core","UWA/Class/View","UWA/Controls/Abstract","DS/NotifAlert/NotifAlert","css!DS/NotificationManager/NotificationManager.css"],function(e,c,d,b){var a=c.extend({defaultOptions:{itemView:b,language:"en"},setup:function(f){this.maxItems=3;this.isInject=false;this.isClosed=false;this.itemView=(f&&f.itemView)?f.itemView:this.options.itemView;this.language=(f&&f.language)?f.language:this.options.language;this.listenTo(this.collection,"onAdd",this.add);this.listenTo(this.collection,"onRemove",this.deleteModel);this.collection.addEvents({"onChange:readState":function(g){e.log("AlertBox model changed")}});this.setContainer({tag:"div","class":"RTnotification"})},add:function(f){var g;if(this.isInject){if(this.collection.length<=this.maxItems){e.log("AlertBox - Add");g=new this.itemView({model:f});var i=e.createElement("div",{"class":"RTnotif-alert",html:g}).inject(this.container,"top");if(!f.get("isInNotifCenter")){this._createAlertShowFx(f,i);g.show();f.showAlertFx.start({top:["0px","0px"],right:["-400px","15px"],opacity:[0,1]})}}else{if(this._timeToRemove){clearTimeout(this._timeToRemove);this._timeToRemove=undefined}var h=this;this._timeToRemove=setTimeout(function(){h.closeAllAlerts()},1000)}}},deleteModel:function(f){if(f){var g=this;e.log("AlertBox model deleted");if(f.showAlertFx){f.showAlertFx.fade("out").onComplete=function(){if(this.element){this.element.destroy()}}}}},inject:function(g){this.isInject=true;this.container.inject(g);for(var f=0;f<this.collection.size();f++){this.add(this.collection.at(f))}},checkExistingAlert:function(){if(document.querySelector(".RTnotif-alert")){return true}else{return false}},_createAlertShowFx:function(f,g){f.showAlertFx=new e.Fx(g,{duration:500,transition:"linear",events:{onComplete:function(){}}})},closeAllAlerts:function(){while(!this.collection.isEmpty()){this.collection.pop()}}});return a});define("DS/NotificationManager/notificationDriver",["UWA/Core","UWA/Class","DS/PlatformAPI/PlatformAPI","UWA/Class/Events","DS/DSNodeSocketioClient/DSNodeSocketioClient","DS/WAFData/WAFData"],function(g,d,c,b,f,a){var e=d.extend(b,{defaultOptions:{notifServer:"",currentLanguage:"en"},init:function(h){var i=this;this._listenedEvents=h.listenedEvents;this._socket=undefined;this._server=undefined;this._token=undefined;c.subscribe("3dNotifCenterInit",function(){if(i._socket){c.publish("3dNotifManagerInit",true)}else{c.publish("3dNotifManagerInit",false)}})},activeConnection:function(h){g.log("3DNOTIF - NotificationManager activeConnection");var k=this;var l={"force new connection":false,reconnection:true,reconnectionAttempts:"Infinity",timeout:10000,transports:["websocket"]};if(!this._server){this._server=h.notifServer}if(this._server){this._socket=f.connect(this._server,l)}if(this._socket){for(var j=0;j<k._listenedEvents.length;j++){(function(i){k._socket.on(i,function(m){k.dispatchListenedEvents(m,i)})})(k._listenedEvents[j])}this._socket.on("connect",function(){var i={onComplete:function(p){var n;if(typeof p!="object"){try{n=JSON.parse(p)}catch(q){g.log("3DNotification : error parsing cas validate ticket response :"+q)}}else{n=p}if(n&&n.access_token){k._token=n.access_token;k._socket.emit("new_user",{pseudo:h.login.toLowerCase(),pass:k._token,language:h.currentLanguage});delete k._token;k._token=undefined;var m,o;c.publish("intf-ws-topic",{event:"ready",code:200})}else{g.log("3DNotification : json null or no acess token");for(var m=0;m<k._listenedEvents.length;m++){(function(r){k._socket.off(r)})(k._listenedEvents[m])}k._socket.off("connect");k._socket.off("error");k._socket.close();delete k._socket}},onFailure:function(m){g.log(m)},onTimeout:function(m){g.log(m)},type:"json"};a.authenticatedRequest(h.iamUrl,i)});this._socket.on("error",function(i){g.log("3DNotification Socket Connection Error\n"+i)})}},dispatchListenedEvents:function(h,i){this.dispatchEvent(i,h)},emit:function(h,i){if(this._socket){this._socket.emit(h,i)}},});return e});define("DS/NotificationManager/view/notificationMessageView",["UWA/Class","UWA/Class/Events","DS/UIKIT/Tooltip"],function(b,a,d){var c=b.extend(a,{init:function(e){this.views=[];this.expand=true;this.elementDisplay=false;this.globalDisplay=true;this.buddyMinimize=false;this.displayCss=undefined;this.dontDisplayIcon=e.dontDisplayIcon;this.notifQtyIcon=e.notifQtyIcon;this.notificationStyle=e.notificationStyle;var f=this;if((navigator.platform.indexOf("iPhone")!=-1)||(navigator.platform.indexOf("iPod")!=-1)||(navigator.platform.indexOf("iPad")!=-1)){this.globalView=UWA.createElement("div",{"class":"NTFMsgMiniNotification",id:"NTFMsgMiniNotification",styles:{position:"absolute"}})}else{this.globalView=UWA.createElement("div",{"class":"NTFMsgMiniNotification",id:"NTFMsgMiniNotification"})}this.iconView=UWA.createElement("div",{styles:{padding:"2px"}}).inject(this.globalView);this.buddyIconView=UWA.createElement("div",{styles:{padding:"2px",marginRight:"-60px",overflow:"hidden",display:"none"}}).inject(this.globalView);this.buddyIcon=UWA.createElement("div",{styles:{margin:"2px",width:"50px",height:"50px",borderRadius:"50px",border:"1px solid gray",background:"white"},events:{mouseover:function(){f.buddyIcon.style.cursor="pointer"},mouseout:function(){f.buddyIcon.style.cursor="default"},click:function(){if(f.expand){f.collapseAll()}else{f.expandAll()}}}}).inject(this.buddyIconView);UWA.createElement("span",{"class":"fonticon handler fonticon-users",styles:{fontSize:"1.6em",color:"rgb(0, 86, 134)",margin:"9px 12px"}}).inject(this.buddyIcon);this.arrowDownView=UWA.createElement("div",{styles:{margin:"2px",width:"50px",height:"14px",display:"none"},events:{mouseover:function(){f.spanDown.style.color="#3D3D3D";f.spanDown.style.cursor="pointer"},mouseout:function(){f.spanDown.style.color="gray";f.spanDown.style.cursor="default"},click:function(){var g=f.iconsListView.scrollTop;f.iconsListView.scrollTop+=100}}}).inject(this.globalView);this.spanDown=UWA.createElement("span",{"class":"fonticon handler fonticon-down-open",styles:{fontSize:"2em",color:"gray",position:"relative",bottom:"13px",margin:"0px 11px"}}).inject(this.arrowDownView);this.iconsListView=UWA.createElement("div",{styles:{margin:"2px",maxHeight:"580px",overflow:"hidden",minWidth:"50px",padding:"2px"},events:{mousewheel:function(g){f.iconsListView.scrollTop+=g.deltaY}}}).inject(this.globalView);this.arrowUpView=UWA.createElement("div",{styles:{margin:"2px",width:"50px",height:"14",display:"none"},events:{mouseover:function(){f.spanUp.style.color="#3D3D3D";f.spanUp.style.cursor="pointer"},mouseout:function(){f.spanUp.style.color="gray";f.spanUp.style.cursor="default"},click:function(){var g=f.iconsListView.scrollTop;f.iconsListView.scrollTop-=100}}}).inject(this.globalView);this.spanUp=UWA.createElement("span",{"class":"fonticon handler fonticon-up-open",styles:{fontSize:"2em",color:"gray",position:"relative",bottom:"13px",margin:"0px 11px"}}).inject(this.arrowUpView)},getView:function(){return this.globalView},removeAllElements:function(){for(var e=0;e<this.views.length;e++){this.removeElement(this.views[e].idElement)}},removeElement:function(g){var k=this;var f=-1;for(var h=0;h<this.views.length;h++){if(this.views[h].idElement===g){f=h;break}}if(f!==-1){var j=new UWA.Fx(this.views[f].view,{duration:200,transition:"linear",events:{onComplete:function(i){if(k.views[f]&&k.views[f].view){k.views[f].view.destroy()}k.views.splice(f,1);if(!k.views.length){k.activeBuddyIcon(false)}}}});j.start({height:0})}if(this.views.length===10){var e=new UWA.Fx(this.arrowDownView,{duration:200,transition:"linear",events:{onComplete:function(i){k.arrowDownView.style.display="none"}}});e.start({height:0});var l=new UWA.Fx(this.arrowUpView,{duration:200,transition:"linear",events:{onComplete:function(i){k.arrowUpView.style.display="none"}}});l.start({height:0})}},addContact:function(f){var e=-1;for(var g=0;g<this.views.length;g++){if(this.views[g].idElement===f.id){e=g;break}}if(e===-1){var h=this;var j=UWA.createElement("div",{styles:{width:"50px",height:"50px",marginTop:"6px",background:"white",borderRadius:"50px",border:"1px solid gray"},events:{mouseover:function(){j.style.cursor="pointer"},mouseout:function(){j.style.cursor="default"},click:function(){f.events.click();j.tooltip.destroy();h.removeElement(f.id)}}});j.tooltip=new d({target:j,body:f.userName,position:"left"});j.tooltip.getContent().style.zIndex="30000";UWA.createElement("img",{styles:{width:"42px",borderRadius:"42px",margin:"3px"},src:f.pathPicture}).inject(j);this.addElement({idElement:f.id,view:j,contactView:j,position:"bottom",show:true})}},addNotification:function(l){var m=-1;for(var g=0;g<this.views.length;g++){if(this.views[g].idElement===l.id){m=g;break}}if(m===-1){var h=this;if(this.notificationStyle){var f="";var s={right:"15px","border-radius":"4px",width:"300px",height:"74px",marginTop:"6px",boxShadow:"0px 1px 2px 0px #77797c",overflow:"hidden"}}else{var f="";var s={width:"300px",height:"74px",marginTop:"6px",boxShadow:"0px 1px 2px 0px #77797c",overflow:"hidden"}}var o=UWA.createElement("div",{id:"RTNotifView","class":f,styles:s,events:{mouseover:function(){o.style.cursor="pointer";h.expendNotif(this,this.children[0])},mouseout:function(){o.style.cursor="default"},mouseleave:function(){h.replaceNotif(this,this.children[0])},click:function(){h.removeElement(l.id);if(l&&l.events&&l.events.click){l.events.click()}}}});var r=UWA.createElement("div",{styles:{width:"50px",height:"50px",margin:"13px 12px",background:"white",borderRadius:"100%",border:"1px solid gray","float":"left"},events:{mouseover:function(){r.style.cursor="pointer"},mouseout:function(){r.style.cursor="default"},click:function(){}}}).inject(o);UWA.createElement("img",{styles:{width:"42px",borderRadius:"42px",margin:"3px"},src:l.pathPicture,}).inject(r);var n=UWA.createElement("div",{styles:{width:"300px",height:"38px",background:this.notificationStyle?"white":"#005686",textAlign:"left"}}).inject(o);var q=UWA.createElement("div",{styles:{height:"38px",display:"flex",flexDirection:"row"}}).inject(n);UWA.createElement("div",{text:l.userName,styles:{width:"150px",color:this.notificationStyle?"#77797c":"white",fontFamily:"arial",fontWeight:"bold",margin:"auto",whiteSpace:"nowrap",overflow:"hidden","float":"left",textOverflow:"ellipsis","margin-bottom":this.notificationStyle?0:"auto"}}).inject(q);UWA.createElement("span",{"class":"fonticon handler fonticon-popup",styles:{fontSize:"1.4em",color:"white",width:"38px","float":"left",margin:"auto"}}).inject(q);UWA.createElement("span",{"class":"fonticon handler fonticon-cancel",styles:{fontSize:"1.2em",color:"white",width:"38px","float":"left",margin:"auto"},events:{click:function(i){UWA.Event.stopPropagation(i);h.removeElement(l.id)}}}).inject(q);var p=UWA.createElement("div",{styles:{width:"300px",height:"36px",background:"white",textAlign:"left"}}).inject(o);var e=UWA.createElement("div",{styles:{margin:"auto",borderRadius:"4px",width:"294px",height:"33px",background:this.notificationStyle?"white":"#F1F1F1",paddingTop:this.notificationStyle?"0":"8px"}}).inject(p);UWA.createElement("div",{html:l.infoTxt,styles:{color:"#3D3D3D",fontFamily:"arial",width:"210px",whiteSpace:"nowrap",textOverflow:"ellipsis",overflow:"hidden"}}).inject(e);this.addElement({idElement:l.id,view:o,contactView:r,position:"bottom",show:true});var j=new UWA.Fx(o,{duration:300,transition:"linear"});var k=new UWA.Fx(r,{duration:300,transition:"linear",events:{onComplete:function(i){n.style.display="none";p.style.display="none";o.style.boxShadow="rgb(119, 121, 124) 0px 0px 0px 0px";j.start({width:50,height:50,marginRight:0,borderRadius:"50px"});r.style.border="1px solid orange";r.style.borderRadius="50px"}}});setTimeout(function(){j.start({marginRight:-250});k.start({margin:0})},4000)}else{this.receivedMessage(l.id)}},expendNotif:function(e,h){var g=new UWA.Fx(e,{duration:300,transition:"linear",events:{onComplete:function(i){}}});var f=new UWA.Fx(h,{duration:300,transition:"linear",events:{onComplete:function(i){h.style.border="1px solid gray";h.style.margin="13px 12px"}}});e.style.display="block";e.style.marginTop="6px";e.style.boxShadow="0px 1px 2px 0px #77797c";e.style.overflow="hidden";e.style.borderRadius="0px";e.children[1].style.display="";e.children[2].style.display="";g.start({width:300,height:74,borderRadius:0});f.start({marginTop:13,marginRight:12})},replaceNotif:function(f,h){var g=new UWA.Fx(f,{duration:300,transition:"linear"});var e=new UWA.Fx(h,{duration:300,transition:"linear"});g.start({width:50,height:50,marginRight:0,borderRadius:"50px",});e.start({margin:0})},addElement:function(i){console.log(i.position);var l=this;this.elementDisplay=i.show;if(i.position==="top"){console.log("top");this.views.push({idElement:i.idElement,view:i.view,contactView:i.contactView,show:this.expand||i.show})}else{console.log("not top");this.views.unshift({idElement:i.idElement,view:i.view,contactView:i.contactView,show:this.expand||i.show})}console.log(this.iconsListView);i.view.inject(this.iconsListView,i.position);console.log(this.iconsListView);if(this.expand||i.show){var f=i.view.offsetWidth;var j=i.view.offsetHeight;i.view.style.marginRight=-f+"px";var k=false;var g=new UWA.Fx(i.view,{duration:200,transition:"linear",events:{onAnimate:function(h,o,n){if(!k){l.iconsListView.scrollTop+=5}},onComplete:function(h){if(!(i.position==="top")&&k){k=false;g.start({marginRight:[-f,0]})}}}});if(i.position==="top"){g.start({marginRight:[-f,0]})}else{k=true;g.start({height:[0,j]})}if(!this.buddyMinimize&&!this.dontDisplayIcon){this.activeBuddyIcon(true)}}if(this.views.length===11){this.arrowDownView.style.display="block";this.arrowUpView.style.display="block";var e=new UWA.Fx(this.arrowDownView,{duration:200,transition:"linear"});e.start({height:[0,13],marginRight:2});var m=new UWA.Fx(this.arrowUpView,{duration:200,transition:"linear"});m.start({height:[0,13],marginRight:2})}},expandAll:function(){var f=this;this.expand=true;this.buddyIcon.style.display="block";if(f.views.length){this.animeElement(0);if(this.views.length>10){this.arrowDownView.style.display="block";var e=new UWA.Fx(this.arrowDownView,{duration:200,transition:"linear"});e.start({height:[0,13],marginRight:2})}}},collapseAll:function(){var f=this;this.expand=false;this.elementDisplay=false;this.views.forEach(function(g){g.show=false;var h=new UWA.Fx(g.view,{duration:200,transition:"linear",events:{onComplete:function(i){g.view.style.display="none"}}});h.start({marginRight:-60})});var e=new UWA.Fx(this.arrowDownView,{duration:200,transition:"linear",events:{onComplete:function(g){f.arrowDownView.style.display="none"}}});e.start({marginRight:-60});var e=new UWA.Fx(this.arrowUpView,{duration:200,transition:"linear",events:{onComplete:function(g){f.arrowUpView.style.display="none"}}});e.start({marginRight:-60})},animeElement:function(e){var g=true;var i=this;if(!this.views[e].show){this.views[e].show=true;var f=this.views[e].view;f.style.display="block";var h=new UWA.Fx(f,{duration:200,transition:"linear",events:{onAnimate:function(k,n,m){var j=h.currentTime;if(j>30&&g){g=false;if(++e<i.views.length){i.animeElement(e)}else{if(i.views.length>10){i.arrowUpView.style.display="block";var l=new UWA.Fx(i.arrowUpView,{duration:200,transition:"linear"});l.start({height:[0,13],marginRight:2})}}}}}});h.start({marginRight:[-60,0]})}else{if(++e<i.views.length){i.animeElement(e)}}},updateIcon:function(e){this.statusIconMiniIcon.className=e.name;this.statusIconMiniIcon.style["font-size"]=e.fontSize;this.statusIconMiniIcon.style.top=e.top;this.statusIconMiniIcon.style.left=e.left},receivedMessage:function(g){var k=this;var f=-1;for(var j=0;j<this.views.length;j++){if(this.views[j].idElement===g){f=j;break}}if(f!==-1){var l=0;var h=false;this.views[f].contactView.style.border="1px solid gray";var e=setInterval(function(){if(k.views&&k.views[f]&&k.views[f].contactView){k.views[f].contactView.style.border=h?"1px solid gray":"1px solid orange";h=!h;l++;if(l===5){k.views[f].contactView.style.border="1px solid orange";clearInterval(e)}}else{clearInterval(e)}},300)}},activeMiniZone:function(g){if(this.globalDisplay!==g){var f=this;if(g){this.globalDisplay=g;f.globalView.className="NTFMsgMiniNotification";var e=new UWA.Fx(this.globalView,{duration:200,transition:"linear"});e.start({marginRight:0})}else{this.globalDisplay=g;var e=new UWA.Fx(this.globalView,{duration:200,transition:"linear",events:{onComplete:function(h){f.globalView.className="NTFMsgMiniNotificationNone"}}});e.start({marginRight:-60})}}},setNotifQty:function(e){this.notifqtyIconMini.innerText=e},incrementNotifQty:function(e){this.notifqty=Math.min((this.notifqty||0)+(e||1),99);this.setNotifQty(this.notifqty)},razNotifQty:function(e){this.notifqty=0;this.setNotifQty(this.notifqty)},hideNotifQty:function(e){this.notifqtyIconMini.hide()},showNotifQty:function(e){this.notifqtyIconMini.show()},activeBuddyIcon:function(g){var f=this;if(g){this.buddyMinimize=true;if(this.views.length){this.buddyIconView.style.display="block";var e=new UWA.Fx(this.buddyIcon,{duration:200,transition:"linear",events:{onComplete:function(h){var i=new UWA.Fx(f.buddyIconView,{duration:200,transition:"linear"});i.start({marginRight:0})}}});e.start({height:50})}}else{this.buddyMinimize=false;var e=new UWA.Fx(this.buddyIconView,{duration:200,transition:"linear",events:{onComplete:function(h){var i=new UWA.Fx(f.buddyIcon,{duration:200,transition:"linear",events:{onComplete:function(j){f.buddyIconView.style.display="none"}}});i.start({height:0})}}});e.start({marginRight:-60})}},destroy:function(){this.globalView.destroy()},});return c});define("DS/NotificationManager/notificationManager",["UWA/Core","UWA/Class","UWA/Data","UWA/Controls/Abstract","UWA/Class/Model","DS/WAFData/WAFData","DS/PlatformAPI/PlatformAPI","DS/UWPClientCode/PublicAPI","DS/UWPClientCode/I18n","DS/NotificationManager/view/notificationManagerView","DS/i3DXCompass/i3DXCompass","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/TopBar/TopBar","DS/NotificationManager/notificationDriver","DS/NotifAlert/NotifAlert","DS/NotificationManager/view/notificationMessageView"],function(g,q,d,p,l,b,c,m,o,r,h,j,k,e,f,a){var i;var n=q.extend({init:function(s){i=this;this.login=s.login;this.ODT=s.ODT;this.isMobileApp=s.isMobileApp;if(!this.ODT){this.frame=require("DS/TopFrame/TopFrame")}this.topBar=k.MainMenuBar;this.swymServer=s.swymServer;this.badge=0;this.isFiltered=false;this.listOfAppw={};this.listOfService=undefined;this._notifManagerView=undefined;this.blockAlert=false;this._listenedEvents=undefined;this._emmitedEvents=undefined;this.initListenedEvents();this.initEmmitedEvents();this.getServices();this._notificationDriver=new e({listenedEvents:Object.keys(i._listenedEvents)});this._notificationDriver.addEvent("newINTFTokenConnection",function(){var u=i.getParams();if(u&&u.login){i.requestProxyTicket(u)}});this.initConnection(s.login,s.passportServer,s.tenant);this.InitPushTo3dNotif("pushto3dnotification");this.initListeners();if(!this.notifCollection&&!this._notifManagerView){this.notifCollection=new g.Class.Collection();this._notifManagerView=new r({collection:this.notifCollection});if(!this.isMobileApp){try{this._notifConvView=new a({});this._notifConvView.getView().inject(document.body)}catch(t){console.log("3DNotification - ERROR - instantiate bubble")}}this._notifManagerView.inject(document.body);if(!this.ODT){this.initFrameEvents()}}this.addListener("3dnotifinterne",i.getActions);this.addListener("INTFSubscriptionTopic",function(u){i._notificationDriver.emit("subscription",u)})},initEmmitedEvents:function(){this._emmitedEvents={notifCenterOpened:"notifCenterOpened",resetNotifications:"resetNotifications",notificationRead:"notificationRead",decrementBadge:"decrementBadge",getHistory:"getHistory",getUnreadTotal:"getUnreadTotal",getSettings:"getSettings",updateSettings:"updateSettings",notificationDelete:"notificationDelete",deleteAllNotification:"deleteAllNotification",unsubscribe:"unsubscribe",filter:"filter",rollback:"rollback",rollbackPopupconfirmation:"rollbackPopupconfirmation",pushToken:"pushToken"}},initListenedEvents:function(){this._listenedEvents={notify:this.notify,notifyCenter:this.notifyCenter,notifySystem:this.notifySystem.bind(this),setHistory:this.setHistory,setUnreadTotal:this.setUnreadTotal,setFilteredTotal:this.setFilteredTotal,setSettings:this.setSettings,setSetting:this.setSetting,updateBadge:this.updateBadge,readNotification:this.readNotification,deleteNotification:this.deleteNotification,setTenants:this.setTenants,setDates:this.setDates,setWhoSettings:this.setWhoSettings,setNotifications:this.setNotifications,setSubscribedState:this.setSubscribedState,refreshForRollback:this.refreshForRollback,authenticated:this.authenticated,authenticate_error:this.authenticate_error,token_registered:this.token_registered,token_registered_error:this.token_registered_error}},initListeners:function(){for(var s in this._listenedEvents){if(this._listenedEvents.hasOwnProperty(s)){this._notificationDriver.addEvent(s,this._listenedEvents[s])}}},initConnection:function(s,t,v){var u=this;if(window.location.href.search(/https:\/\/([A-z0-9]+)-[A-z0-9]+-[A-z0-9]+-[A-z0-9]+/)===0){if(!v){v=window.location.href.split(/https:\/\//)[1].split("-")[0];v=v.toUpperCase()}u.getPlatformServicesUrl(s,t,v)}else{v=u.findCurrentTenant();u.getPlatformServicesUrl(s,t,v)}},getPlatformServicesUrl:function(t,u,w){var s=false,v=this;j.getServiceUrl({serviceName:"3dnotifications",platformId:w,onComplete:function(y){if(!y){v.getPlatformServicesUrl(t,u)}else{if(!v.passportUrl){v.passportUrl=u;if(!v.passportUrl){v.passportUrl=c.getApplicationConfiguration("app.urls.passport")}}var z=v.getParams(t);if(typeof y==="object"){for(var x=0;x<y.length;x++){if(y[x].url){v.notifServer=v.extractDomain(y[x].url);s=true}if(s){if(z&&z.login){v.requestProxyTicket(z)}break}}}else{if(typeof y==="string"){v.notifServer=v.extractDomain(y);if(z&&z.login){v.requestProxyTicket(z)}}}if(!v.notifServer){g.log("3DNotification error : no intf url found need visual information")}}}})},findCurrentTenant:function(){selectedTenant=m.getApplicationConfiguration("app.mp.tenant");g.log("findCurrentTenant selected the PublicAPI.app.mp.tenant "+selectedTenant);if(!selectedTenant){try{var t,s=JSON.parse(m.user.properties.dashboards)}catch(u){g.log("3DNotification error: unable to parse user dahboards")}for(t in s){if(s[t].platformId){selectedTenant=s[t].platformId;g.log("findCurrentTenant selected the first PublicAPI.user.properties.dashboards tenant "+selectedTenant);break}}}g.log("findCurrentTenant ends with "+selectedTenant);return selectedTenant},initFrameEvents:function(){var s=this;if(s.frame&&s._notifManagerView&&s._notificationDriver){s.frame.addEvent("onRightPanelOpened",function(t){s._notifManagerView.closeAllAlerts();if(s.frame._visibleXApp==="notification"){s.topBar.setBadge("notification",0);s.badge=0;s.blockAlert=true;s._notificationDriver.emit("notifCenterOpened",s.blockAlert)}});s.frame.addEvent("onRightPanelClosed",function(t){if(s.frame._visibleXApp==="notification"){s.blockAlert=false;s._notificationDriver.emit("resetNotifications",s.blockAlert)}})}},getParams:function(s){var t={};t.currentLanguage=o.getCurrentLanguage();if(!t.currentLanguage){t.currentLanguage=window.navigator.language}if(c.getUser()){t.login=c.getUser().login}if(!t.login){t.login=s}i.language=t.currentLanguage;return t},getServices:function(){if(this.listOfService===undefined){j.getPlatformServices({onComplete:function(u){for(var t=0;t<u.length;t++){for(var s in u[t]){if(u[t].hasOwnProperty(s)){u[t][s.toLowerCase()]=u[t][s];delete u[t][s]}}}i.listOfService=u;c.publish("3dnotifinterne",{action:"setServices",services:i.listOfService})}})}else{c.publish("3dnotifinterne",{action:"setServices",services:i.listOfService})}},getServiceUrl:function(s){for(var t=0;t<this.listOfService.length;t++){if(s.platformId){if(this.listOfService[t].platformid.toLowerCase()===s.platformId.toLowerCase()){return this.listOfService[t][s.name.toLowerCase()]}}else{return this.listOfService[t][s.name.toLowerCase()]}}if(this.listOfService.length>0){return this.listOfService[0][s.name.toLowerCase()]}return undefined},getAppInfos:function(s){var t=this;if(!this.listOfAppw[s.appID]){h.getAppInfo({appId:s.appID,onComplete:function(u){g.log(u);if(u){t.listOfAppw[u.id]=u.icon;if(s.notif){s.notif.dispatchEvent("updatePicture",[{src:u.icon}])}else{c.publish("3dnotifinterne",{action:"setAppInfos",src:u.icon,notifID:s.notifID})}}}})}else{if(s.notif){s.notif.dispatchEvent("updatePicture",[{src:this.listOfAppw[s.appID]}])}else{c.publish("3dnotifinterne",{action:"setAppInfos",src:this.listOfAppw[s.appID],notifID:s.notifID})}}},addListener:function(s,t){c.subscribe(s,t)},addItem:function(s){var t=this;s.addEvent("publish",function(u){c.publish(u.topic,u.data)});s.addEvent("read",function(u){t._notificationDriver.emit("notificationRead",u);t._notificationDriver.emit("decrementBadge",t.badge);c.publish("3dnotifinterne",{action:"read",params:{id:u.id,read:true}})});s.addEvent("actioned",function(u){c.publish("3dnotifinterne",{action:"actioned",params:{id:u.id,actioned:true}})});s.addEvent("alertBoxClosed",function(){t.badge-=1;t._notificationDriver.emit("decrementBadge",t.badge)});s.addEvent("updateLabel",function(u){if(u&&u.id){var v={action:"updateLabel",updateLabel:"updateLabel",params:{id:u.id,label:u.label,flag:u.flag}};c.publish("3dnotifinterne",v)}t._notificationDriver.emit("notificationRead",v)});t.notifCollection.add(s)},addNotification:function(s){c.publish("3dnotifinterne",{action:"addNotification",notification:JSON.stringify(s)})},getActions:function(u){switch(u.action){case"rollback":c.publish("3dnotifinterne",{action:"rollbackPopup",params:{file:u.file,id:u.id,isInNotifCenter:u.isInNotifCenter}});break;case"rollbackPopupconfirmation":i._notificationDriver.emit("rollback",{filename:u.file,user:c.getUser().login,confirmPopupResult:u.confirmPopupResult,id:u.id});break;case"getHistory":i._notificationDriver.emit("getHistory",{type:u.type,oldID:u.oldID,groupIDs:u.groupIDs});break;case"getUnreadTotal":i._notificationDriver.emit("getUnreadTotal");break;case"getAppInfos":i.getAppInfos({appID:u.appID,notifID:u.notifID});break;case"getSettings":i._notificationDriver.emit("getSettings");break;case"getTenants":i._notificationDriver.emit("getTenants");break;case"getDates":i._notificationDriver.emit("getDates");break;case"getWhoSettings":i._notificationDriver.emit("getWhoSettings");break;case"getParams":c.publish("3dnotifinterne",{action:"setParams",params:{passportUrl:i.options.passportUrl,swymUrl:i.options.swymServer}});break;case"getServices":i.getServices();break;case"notificationRead":i._notificationDriver.emit("notificationRead",u);break;case"actioned":i._notificationDriver.emit("notificationRead",u);break;case"updateSettings":i._notificationDriver.emit("updateSettings",u);break;case"notificationDelete":i._notificationDriver.emit("notificationDelete",u);break;case"deleteAllNotification":i._notificationDriver.emit("deleteAllNotification",u);break;case"unsubscribe":i._notificationDriver.emit("unsubscribe",u);break;case"NotifCenterOpened":i._notificationDriver.emit("NotifCenterOpened",u.blockAlert);break;case"resetNotifications":i._notificationDriver.emit("resetNotifications",i.blockAlert);break;case"filter":var x=[];for(var s=0;s<u.values.what.length;s++){x.push(u.values.what[s])}if(x.length===0){x[0]=" "}i.filterValues={msg:x,first_date:i.getFormattedDate(new Date(u.values.first_date)),last_date:i.getFormattedDate(new Date(u.values.last_date)),tenants:u.values.tenants,whoSettings:u.values.whoSettings};i.isFiltered=true;i._notificationDriver.emit("filter",i.filterValues);break;case"notifyBrowser":var v=u.titleNotif||"3DSwym Conversations";var t=u.textNotif;var w=i.swymServer||i.getServiceUrl({name:"3dswym",platformId:u.tenant});var y=(w&&u.login)?""+w+"/api/user/getpicture/login/"+u.login+"/format":"./resources/en/1/webapps/NotifAlertBox/assets/icons/notifIcon.png";i.notifyWeb(v,{ICON:y},t,"en",false,function(){g.log("browser notif has been clicked");window.focus();this.close()});break;default:g.log("Unknown action published on 3dnotifinterne : "+u.action)}},InitPushTo3dNotif:function(s){var t;c.subscribe(s,function(u){switch(u.method){case"pushplatformid":if(u.data){if(u.data.provider.toLowerCase()==="3dswym"){i._notificationDriver.emit("getTokens",u.data.data)}}break;case"registerTenantApp":if(u.data){t=u.data.provider.toLowerCase()}if(t){if(!i.listOfTenantApp[t]){i.listOfTenantApp[t]=[]}}i.listOfTenantApp[t].push(u.data.data);break;case"unregisterTenantApp":if(u.data){t=u.data.provider.toLowerCase()}if(t){if(i.listOfTenantApp[t]){i.listOfTenantApp[t].splice(i.listOfTenantApp[t].indexOf(u.data.data),1)}}break;default:}})},requestProxyTicket:function(t){var s=this.passportUrl+"/login?service=INTF";i._notificationDriver.activeConnection({login:t.login,currentLanguage:t.currentLanguage,iamUrl:s,notifServer:i.notifServer})},computeAlertBox:function(A,w,u){var y=this;if(w.ICON){if(w.ICON.type==="appID"){u=true}else{w.ICON=y.getIconInfo(w)}}else{u=false}if(A.actions){for(var x=0;x<A.actions.length;x++){var v=A.actions[x];if(v.options&&v.options.event&&v.options.event.type==="url"){var s=v.options.event;if(s.options&&s.options.service&&s.options.uri){var t=this.getServiceUrl({name:s.options.service,platformId:w.PLATFORMID});s.options.url=t+s.options.uri;if(w.APPID==="USASWYM_AP"){s.options.csrf=t+"/api/index/tk/"}}}}}var z=new l({id:w.ID,img:w.ICON,text:A.nls.msg,options:A.actions,appIconBorder:u,listOfService:y.listOfService,readState:false,isInNotifCenter:false,actioned:false,provider:w.APPID,refresh:w.REFRESH,platformId:w.PLATFORMID?w.PLATFORMID:""});if(u){y.getAppInfos({notif:z,appID:w.ICON.data})}return z},getIconInfo:function(v){if(v.ICON){if(v.ICON.type==="url"){if(!v.ICON.data.service){return v.ICON.data}else{if(v.PLATFORMID){for(var u=0;u<i.listOfService.length;u++){if(i.listOfService[u].platformid===v.PLATFORMID){return i.listOfService[u][v.ICON.data.service.toLowerCase()]+v.ICON.data.uri}}}else{for(var s in i.listOfService[0]){if(v.ICON.data.service.toLowerCase()===s.toLowerCase()){return i.listOfService[0][s]+v.ICON.data.uri}}}}}else{if(v.ICON.type==="login"){var t="/api/user/getpicture/login/";if(v.PLATFORMID){for(var w=0;w<i.listOfService.length;w++){if(i.listOfService[w].platformid===v.PLATFORMID){i.swymServer=i.listOfService[w]["3dswym"];break}}}return i.swymServer+t+v.ICON.data+"/format"}}}else{v.ICON="./resources/en/1/webapps/NotifAlertBox/assets/icons/notifIcon.png"}},authenticated:function(){g.log("3DNotification : socket connected !")},authenticate_error:function(s){g.log("3DNotification : socket error :"+JSON.stringify(s))},token_registered:function(){g.log("3DNotification : token registred !")},token_registered_error:function(s){g.log("3DNotification : token registred error"+JSON.stringify(s))},updateBadge:function(s){if(!i.blockAlert){if(s.badge!==undefined){i.topBar.setBadge("notification",s.badge);i.badge=s.badge}}},setSetting:function(s){c.publish("3dnotifinterne",{action:"setSetting",setting:s.setting})},setSettings:function(u){var s=[];for(var t=0;t<u.settings.length;t++){if(s.indexOf(u.settings[t].APPID)===-1){s.push(u.settings[t].APPID)}}h.getAppsInfo({data:s,onComplete:function(x){g.log(x);if(x){var w=[];for(var v=0;v<u.settings.length;v++){for(var y=0;y<x.length;y++){if(u.settings[v].APPID===x[y].id){w.push({id:u.settings[v].ID,name:u.settings[v].NAME,serviceName:x[y].title,service:x[y].id,icon:x[y].icon,subscribe:u.settings[v].SUBSCRIBE,notif_by_ui:u.settings[v].NOTIF_BY_UI,notif_by_email:u.settings[v].NOTIF_BY_EMAIL,notif_by_browser:u.settings[v].NOTIF_BY_BROWSER})}i.listOfAppw[x[y].id]=x[y].icon}}w.sort(function(A,z){var C=A.serviceName.toLowerCase(),B=z.serviceName.toLowerCase();if(C<B){return -1}if(C>B){return 1}return 0});c.publish("3dnotifinterne",{action:"setSettings",settings:w})}}})},checkRegisteredApp:function(u,t,s){if(this.listOfTenantApp[u]&&this.listOfTenantApp[u][t]){c.publish("3dnotifexterneapi",{action:"getCurrentConversation"});return false}else{return true}},refreshForRollback:function(){c.publish("3dnotifinterne",{action:"refreshForRollback"})},setUnreadTotal:function(t){var s=JSON.parse(t.unread);if(s){c.publish("3dnotifinterne",{action:"setUnreadTotal",unread:s[0].UNREAD})}},setFilteredTotal:function(s){if(s.count!==undefined){c.publish("3dnotifinterne",{action:"setFilteredTotal",count:s.count})}},setHistory:function(s){c.publish("3dnotifinterne",{action:"setHistory",notifications:s.notifications,language:i.language})},setNotifications:function(s){c.publish("3dnotifinterne",{action:"setNotifications",notifications:s.notifications})},setDates:function(s){c.publish("3dnotifinterne",{action:"setDates",Dates:s})},setWhoSettings:function(s){c.publish("3dnotifinterne",{action:"setWhoSettings",settings:s})},setTenants:function(s){var t=JSON.parse(s.tenants);j.getPlatformServices({onComplete:function(v){for(var w=0;w<t.length;w++){for(var u=0;u<v.length;u++){if(t[w].PLATFORMID===v[u].platformId){t[w].displayName=v[u].displayName}}}c.publish("3dnotifinterne",{action:"setTenants",tenants:JSON.stringify(t)})}})},setSubscribedState:function(s){c.publish("INTFSubscriptionTopic",{action:"setSubscribedState",state:s.state})},notifySystem:function(x){var y=this;var v=decodeURIComponent(escape(atob(x.message))),I=JSON.parse(v);if(I){c.publish(I.actions[0].options.event.options.topic,I.actions[0].options.event.options.data)}try{if(this._notifConvView){var F=I.actions[0].options.event.options.data.external_app_id;if(F==="3DSWYM"){if(I.actions[0].options.event.options.data.message_type==="INSTANT_MESSAGE"){var D=I.actions[0].options.event.options.data.author.login;if(D!==y.login){var u=I.actions[0].options.event.options.data.message_uri;var H=I.actions[0].options.event.options.topic;var B=I.actions[0].options.event.options.data.subject_uri;var s=I.actions[0].options.event.options.data.community_id;var G=I.actions[0].options.event.options.data.community_type;var w=I.actions[0].options.event.options.data.message_details.content;var E=I.actions[0].options.event.options.data.author.firstName+" "+I.actions[0].options.event.options.data.author.lastName;var A=I.actions[0].options.event.options.data.community_id;H=H.substring(H.indexOf("_")+1,H.length);H=H.substring(0,H.indexOf("_"));var t=y.getServiceUrl({name:"3dswym",platformId:H});if(t&&G==="dm"&&D!==c.getUser().login){var C={id:s+D,pathPicture:t+"/api/user/getpicture/login/"+D+"/format",userName:E,infoTxt:w,events:{click:function(J){var K=window.open(t+"/#dm:"+s,"3DSwym Conversations");K.focus()}}};this._notifConvView.addNotification(C);if(Notification.permission!=="granted"){Notification.requestPermission(function(J){if(J==="granted"){y.notifyWeb("3DSwym Conversations",{ICON:t+"/api/user/getpicture/login/"+D+"/format"},w,"en",false,function(){var K=window.open(t+"/#dm:"+s,"3DSwym Conversations");K.focus()})}})}else{y.notifyWeb("3DSwym Conversations",{ICON:t+"/api/user/getpicture/login/"+D+"/format"},w,"en",false,function(){var J=window.open(t+"/#dm:"+s,"3DSwym Conversations");J.focus()})}}}}}}}catch(z){console.log("3DNotification - Error : "+JSON.stringify(z))}},notifyCenter:function(s){i.addNotification(s)},readNotification:function(s){c.publish("3dnotifinterne",{action:"read",params:{id:s.id,read:s.read,scope:s.scope||null}})},deleteNotification:function(s){c.publish("3dnotifinterne",{action:"delete",params:{id:s.id,read:s.read}})},notify:function(y){if(!i.isMobileApp){var s=decodeURIComponent(escape(window.atob(y.MESSAGE))),A=JSON.parse(s),t=false,v=true,u=true;if(i.isFiltered){if(y.CREATION_DATE>=i.filterValues.first_date&&y.CREATION_DATE<=i.filterValues.last_date){for(var z=0;z<i.filterValues.tenants.length;z++){if(y.PLATFORMID===i.filterValues.tenants[z]){for(var x=0;x<i.filterValues.msg.length;x++){if(JSON.stringify(A).search(i.filterValues.msg[x])!==-1){v=true;break}else{v=false}}}else{v=false}}}else{v=false}}if(v){if(!i.blockAlert){var w=i.computeAlertBox(A,y,t);i.addItem(w);u=false}if(y.NOTIFBROWSER){i.notifyWeb("3DEXPERIENCE Platform Notification",y,A.nls.msg,i.language,u)}i.addNotification(y)}}},extractDomain:function(s){var t;if(s.indexOf("://")>-1){t=s.split("/")[2]}else{t=s.split("/")[0]}if(t.indexOf(":")>-1){return t}else{return t+":443"}},getFormattedDate:function(t){var u=t.getFullYear();var v=(1+t.getMonth()).toString();v=v.length>1?v:"0"+v;var s=t.getDate().toString();s=s.length>1?s:"0"+s;return u+"-"+v+"-"+s},notifyWeb:function(A,w,x,t,y,v){var z;if(y){z=i.getIconInfo(w)}else{z=w.ICON}if(Notification.permission==="granted"&&document.hidden){g.log("3DNotification Browser notification");x=x.replace(/<(?!\strong)[^>]*>/gi,"");var u=new Notification(A,{lang:t,body:x,icon:z});u.onclick=function(C){C.preventDefault();if(v){v()}else{u.close();var B=window.open("","notification");B.focus();B.close()}};var s=setTimeout(function(){u.close()},5000)}}});return n});