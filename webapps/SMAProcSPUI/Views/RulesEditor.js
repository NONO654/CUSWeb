define("DS/SMAProcSPUI/Views/RulesEditor",["UWA/Core","UWA/Utils","UWA/Controls/Abstract","DS/UIKIT/Input/Text","DS/UIKIT/Input/Button","DS/SMAProcSPUI/Views/Select","DS/UIKIT/Input/Toggle","DS/UIKIT/Modal","DS/WAFData/WAFData","css!DS/SMAProcSPUI/Views/RulesEditor.css"],function(c,h,f,b,g,a,k,i,j){var e=function(m){var n=(window.outerWidth*3)/4,l=(window.outerHeight*3)/4,p=n/7,o=l/7,q=window.open(m,"xyz","height="+l+", width="+n+", top="+o+", left="+p);if(window.focus){q.focus()}};var d={defaultOptions:{spreadsheet:null,searchDelay:2500},isActive:true,loadIndicatorActive:false,searchHiddenColumns:false,currentSelection:{},searchTimeout:null,filterTimer:null,spreadsheetPreferences:null,init:function(l){this._parent(l);this.controls={};this.buildSkeleton()},buildSkeleton:function(){var q=this,n=this.options,r=this.elements,l,o;this.searchHiddenColumns=n.searchHiddenColumns?n.searchHiddenColumns:false;this.container=r.container=n.container;l=this.getFields();l.forEach(function(t){o=q.fieldBuilders[t.type](t,q);q.controls[o.getName()]=o;var s=t.isSearchable?"inline":"form-group";var u="";if(t.name==="CompDisplayPath"){s="additonalWidth"}if(t.placeholder.indexOf("Filter ")>-1){u=t.placeholder}else{u="Filter "+t.placeholder}c.createElement("div",{"class":s,title:u,html:o}).inject(r.container)});var m={attributes:{autocomplete:"off",autocorrect:"off",autocapitalize:"off",events:{keyup:function(u){var t=u.target.value;var s=q.controls[this.name].getValue();if(!this.oldValue){s="";this.oldValue=u.target.value}else{t=u.target.value;s=this.oldValue;this.oldValue=t}if(t!==s){q.showLoadIndicator();window.clearTimeout(q.searchTimeout);q.searchTimeout=window.setTimeout(function(){q.dispatchEvent("onSearch")},q.options.searchDelay)}}}},id:"input-"+h.getUUID().substring(0,6),className:"text form-group",type:"text",name:"Filter",placeholder:"Filter"};q.controls[m.name]=new b(m).inject(r.container);c.createElement("div",{"class":"spreadsheet-header-button fonticon fonticon-clear ",title:"Clear Filters",events:{click:function(){h.toArray(q.controls).forEach(function(s){if(s.options.type==="select"){s.clear(false)}else{if(s.options.type==="text"){s.setValue("")}}});q.reset=true}}}).inject(r.container);if(n.show.download||n.show.tablePreferences||n.show.subscription){var p=c.createElement("div",{"class":"header-button"}).inject(r.container);r.container.buttons=p}if(n.show.download){r.downloadButton=c.createElement("div",{"class":"spreadsheet-header-button fonticon fonticon-download",events:{click:function(s){q.dispatchEvent("downloadJobLog");s.stopImmediatePropagation()}}}).inject(r.container.buttons);r.downloadButton.setAttributes({title:"Export to CSV"})}if(n.show.tablePreferences){r.tablePreferencesButton=c.createElement("div",{"class":"spreadsheet-header-button fonticon fonticon-cog",events:{click:function(){q.dispatchEvent("onShowPreferences")}}}).inject(r.container.buttons);r.tablePreferencesButton.setAttributes({title:"Set table preferences"});this.spreadsheetPreferences=new i({renderTo:document.body,className:"preferences",visible:false,closable:true,header:"<h4>Table Preferences</h4>"})}if(n.show.subscription){r.subscriptionOptionsButton=c.createElement("div",{"class":"spreadsheet-header-button fonticon fonticon-mail",events:{click:function(){q.dispatchEvent("onShowSubscriptionPreferences")}}}).inject(r.container.buttons);r.subscriptionOptionsButton.setAttributes({title:"Set subscription options"});this.subscriptionPreferences=new i({renderTo:document.body,className:"preferences",visible:false,closable:true,header:"<h4>Edit Subscriptions</h4>"})}},_getDistinctValuesFromColumn:function(o){var n=this.options.spreadsheet.getManager(),p=n.options.model,s=p.length,m=[],r={},u,q=0,t,l;if(c.is(o,"string")){o=n.getColumnIDFromDataIndex(o)}for(q=0;q<s;q+=1){u=p[q];t=u[o];l=t.getCellContent();if(typeof u[o]!=="undefined"){if(r[l]===undefined){r[l]=true;m.push(l)}}}return m},getFields:function(){var o=this,n=this.options.spreadsheet,l=[],m;m=n.getManager().options.columns;m=m.filter(function(p){return p.isFilterable===true||p.isSearchable===true});m.forEach(function(p){var r={},q=[];if(p.isFilterable===true){r.type="select";r.name=p.dataIndex;r.placeholder=p.text;r.multiple=true;q=o._getDistinctValuesFromColumn(p.dataIndex);r.options=Array.prototype.map.call(q,function(s){return{label:s,value:s}})}else{if(p.isSearchable===true){r.type="text";r.name=p.dataIndex;r.placeholder="Filter "+p.text+"'s";r.isSearchable=true}}l.push(r)});return l},fieldBuilders:{text:function(n,o){var m,l={attributes:{autocomplete:"off",autocorrect:"off",autocapitalize:"off",events:{keyup:function(){o.showLoadIndicator();window.clearTimeout(o.searchTimeout);o.searchTimeout=window.setTimeout(function(){o.dispatchEvent("onSearch")},o.options.searchDelay)}}},id:"input-"+h.getUUID().substring(0,6),className:"text"};m=new b(c.extend(n,l,true));return m},select:function(n,o){var m,l={id:"input-"+h.getUUID().substring(0,6),events:{onChange:function(){o.showLoadIndicator();window.clearTimeout(o.searchTimeout);o.searchTimeout=window.setTimeout(function(){o.dispatchEvent("onSearch")},o.options.searchDelay)}}};m=new a(c.merge(n,l));return m}},onSearch:function(){this._buildRules();this._applyRules(0)},showLoadIndicator:function(){if(!this.loadIndicatorActive){this.loadIndicatorActive=true;var l=this.options.spreadsheet,m=l.getManager();m.showLoadIndicator()}},hideLoadIndicator:function(){if(this.loadIndicatorActive){this.loadIndicatorActive=false;var l=this.options.spreadsheet,m=l.getManager();m.hideLoadIndicator()}},onShowPreferences:function(){var n=this,m=this.options.spreadsheet.getManager(),l=c.createElement("div",{"class":"form form-horizontal"});this.options.columns.forEach(function(r){var q,p,o;q=c.createElement("label",{"class":"col-sm-3 control-label",text:r.text});p=new k({name:r.dataIndex,type:"checkbox",className:"primary",value:r.dataIndex,label:"",checked:!m.isColumnHidden(r.dataIndex),events:{onChange:function(){n.dispatchEvent("onPreferencesChange",[this.getValue(),this.isChecked()])}}});o=c.createElement("div",{"class":"form-group",html:[q,{tag:"div","class":"col-sm-9",html:p}]});l.addContent(o)});this.spreadsheetPreferences.setBody(l);this.spreadsheetPreferences.show()},onPreferencesChange:function(m,o){var l=this.options.spreadsheet.getManager(),n;n=l.getColumnIDFromDataIndex(m);if(o){l.showColumn(n);sessionStorage.setItem(m,"true")}else{l.hideColumn(n);sessionStorage.setItem(m,"false")}},onShowSubscriptionPreferences:function(){var o=this,m=c.createElement("div",{"class":"form form-horizontal"});var l=o.options.mcsBaseURL+"/resources/v1/application/E6WFoundation/CSRF";var p=function(q){var t=JSON.parse(q).csrf;var s={csrf:t,data:[{type:"Simulation Job",cestamp:"businessobject",relId:o.options.jobObjectId,id:o.options.jobObjectId,dataelements:{},tenant:"OnPremise"}]};var r={};var u=o.options.mcsBaseURL+"/resources/v1/modeler/subscriptions/getSubscriptionsbyPost";r.method="POST";r.headers={"Content-Type":"application/ds-json"};r.data=JSON.stringify(s);r.onComplete=function(z){var w;o.subscriptionPreferences.editSubscribeResponse=JSON.parse(z);o.subscriptionPreferences.eventsSubscribed=JSON.parse(z).data[0].dataelements.eventsSubscribed;if(o.subscriptionPreferences.eventsSubscribed.length===0){w=false}else{w=true}var x=new k({name:"",type:"checkbox",className:"primary",value:w,label:"Job Modified",checked:w});var y=new g({value:"Ok",className:"primary"});y.addEvent("onClick",function(){o.subscriptionPreferences.hide();var B=o.container.offsetParent.getElement("sp-notification");var C=o.subscriptionPreferences.eventsSubscribed.length!==0;var D=o.subscriptionPreferences.elements.body.getElementsByTagName("input")[0].checked;if(C!==D){var E={};var A={csrf:o.subscriptionPreferences.editSubscribeResponse.csrf,data:o.subscriptionPreferences.editSubscribeResponse.data};if(D===true){A.data[0].dataelements.eventsSubscribed=["SimulationJobStatusModify"]}else{A.data[0].dataelements.eventsSubscribed=[]}E.method="PUT";E.data=JSON.stringify(A);E.onComplete=function(G){var F;if(JSON.parse(G).data[0].dataelements.eventsSubscribed.length===0){F="Unsubscription for Job successful"}else{F="Subscription for Job successful"}B.logMessage({type:"success",text:F})};E.onFailure=function(){B.logMessage({type:"error",text:"Failed to save changes to the server"})};j.authenticatedRequest(o.options.mcsBaseURL+"/resources/v1/modeler/subscriptions",E)}});var v=c.createElement("div",{"class":"form-group",html:[{tag:"div","class":"col-xs-12",html:x},{tag:"div","class":"col-xs-offset-9 col-xs-3",html:y}]});m.addContent(v);o.subscriptionPreferences.setBody(m);o.subscriptionPreferences.show()};j.authenticatedRequest(u,r)};var n=function(q){console.log("unable to fetch CSRF",q)};j.authenticatedRequest(l,{type:"text/plain",onComplete:p,onError:n})},_buildRules:function(){var l=this;this.rules=[];h.toArray(l.controls).forEach(function(p){if(!p.isDisabled()){var n=p.getName(),m=p.getValue(),o=p.options.type;l.buildRule(n,m,o,false)}})},buildRule:function(m,l,n,o){var p;if(o){this.rules=[]}if(l.length>0){p={name:m,values:h.splat(l),active:true}}else{p={name:m,values:[],active:false}}if(n==="select"){p.operator="is"}else{if(n==="text"){p.operator="contains"}}if(this.rules){this.rules.push(p)}else{this.rules=[p]}},_applyRules:function(q){var r=this,m=r.options.spreadsheet,p=m.getManager(),t=this.rules||[],o=p.getColumns(),s=[];o.forEach(function(u){if(!u.isHidden){s.push(u.dataIndex)}});var n=function(){p.pushUpdateView();r.hideLoadIndicator();var u=false;if(r.reset){u=true;r.reset=false}r.dispatchEvent("onSearchEnd",{reset:u})};var l=function(x,w){var v=t.every(function(A){if(A.active){var y=p.getNthRoot(w);var z=A.values.some(function(I){switch(A.operator){case"is":var C=y.options.grid[A.name];return I===C;case"contains":var D=false;var B=y.options.grid;var H=true;for(var F in B){if(B.hasOwnProperty(F)&&(r.searchHiddenColumns||s.indexOf(F)>-1)){var L=String(B[F]);if(L&&L.toLowerCase().contains(I.toLowerCase())){D=true;H=false;break}}}if(H){try{var K=new RegExp(I.toLowerCase());for(var J in B){if(B.hasOwnProperty(J)&&(r.searchHiddenColumns||s.indexOf(J)>-1)){var E=String(B[J]);if(E&&K.test(E.toLowerCase())){D=true;break}}}}catch(G){}}return D;default:return !A.active||(Boolean(I)&&C===I)}});return z}else{return true}});var u=p.getNthRoot(w);if(u){if(v){u.isHidden()&&u.show()}else{!u.isHidden()&&u.hide()}}};p.prepareUpdateView();this._timedProcessRows(l,n,{minRowID:q})},onToggle:function(){var l=!this.isActive;this.elements.container.toggleClassName("active",l);this.isActive=l},_timedProcessRows:function(s,m,u,l){var n=this.options.spreadsheet.getManager(),o={minRowID:0,maxRowID:n.getRoots().length},r=80,p=20,q,t;u=u||{};u=c.extend(o,u);q=u.minRowID;this.filterTimer=setTimeout(function(){var v=new Date();while(q<u.maxRowID){t=n.options.model[q];s.call(l?l:t,t,q);q++;if(new Date()-v>r){break}}if(q<u.maxRowID){this.filterTimer=setTimeout(arguments.callee,p)}else{if(m){m.call(l)}}}.bind(this),p)},onAddRows:function(o,p){var n=this,m=this.options.spreadsheet,l;l=m.getManager().options.columns;l=l.filter(function(q){return q.isFilterable===true});l.forEach(function(q){o.forEach(function(v){var r=q.dataIndex,u=n.controls[r],s,t;s={label:v[r],value:v[r]};t=Boolean(u.getOption(s));if(!t){u.addOption(s)}})});this._applyRules(p)},destroy:function(){var o=this;this.filterTimer&&clearTimeout(this.filterTimer);if(this.spreadsheetPreferences){this.spreadsheetPreferences.destroy()}try{h.toArray(o.controls).forEach(function(p){p.removeEvents();p.destroy()})}catch(l){console.log(l)}var n=this.elements.container&&this.elements.container.children;if(n&&n.length>0){for(var m=n.length-1;m>=0;m-=1){this.elements.container.removeChild(n[m])}}o.controls={}}};return f.extend(d)});