/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
require(["UWA/Core"],function(j){var p="No logs are available ",r={DEBUG:"Debug",INFORMATION:"Information",WARNING:"Warning",ERROR:"Error"},i={Debug:r.DEBUG,Information:r.INFORMATION,Always:r.INFORMATION,Message:r.INFORMATION,Warning:r.WARNING,Error:r.ERROR,SysError:r.ERROR,"System Error":r.ERROR},D={NONE:"",IS_GETTING:"is-getting"},n={RUNNING:"Running",PAUSED:"Paused",NOT_STARTED:"NotStarted",INITIALIZING:"Initializing",WAITING:"Waiting",QUEUED:"Queued",STARTED:"Started"},k={severity:"Severity",Msg:"Message",compId:"Component Id",CompPath:"Component Path",CompDisplayPath:"Execution Path",actId:"Activity Id",Time:"Time",source:"Source",isStep:"Is a step",timeMillis:"Time in Millis",CompIterRunId:"Run ID",CompIterDisplayPath:"Display Path"},B=[],E="",l,m=function(H){var I;try{I=JSON.parse(H.data)}catch(J){I={}}if(I.operation==="downloadJobLog"){H.stopPropagation();var K=new Date(),F=E+"_jobLog_"+K.getTime();var G=[];Object.keys(B[0]).forEach(function(L){G.push({originalKey:L,keyToDisplay:k[L]})});require(["DS/SMAProcSPUI/Utilities/ExportToExcel"],function(M){var L={data:B,filename:F,CsvExpFrame:l,keys:G};M.exportToExcel(L)})}},C=window.addEventListener("message",m.bind(this),true),d=function(){this.$.sim_options_ws.uri=this.$.mcsBaseURL.getValue()+"/resources/e6w/service/SMA_SimExeOption?objectId="+this.simId;this.$.sim_options_ws.getData()},f=function(G){var F=["Debug","Information","Message","Warning","Error","SysError"];F.forEach(function(H){if(G.contains(H)){G=H}});return G},h=function(){var H=this.$.sim_options_ws.data,G="Information";var F=H.datarecords.datagroups[0].dataelements;if(F&&F.logLevel&&F.logLevel.value[0]&&F.logLevel.value[0].value){G=F.logLevel.value[0].value}G=f(G);this.checkLogLevel={logLevel:G,simulationId:this.simId,jobObjId:this.jobObjectId};if(this.checkLogLevel.logLevel&&this.checkLogLevel.simulationId){if(this.checkLogLevel.logLevel==="SysError"){this.checkLogLevel.logLevel="System Error"}this._showCustomMessage(p+"\n note:- Log level is set to '"+this.checkLogLevel.logLevel+"'")}else{this._showCustomMessage(p)}},z=function(){this._hideCustomMessage();if(this.isFrameLoaded){var K=40,H=30,J=2,L=this.DOM(this).find("#datagridFrame").root[0];if(L&&L.contentWindow){this.loadGrid=false;var I=L.scrollHeight-K;var G=[n.RUNNING,n.PAUSED,n.WAITING,n.QUEUED,n.NOT_STARTED,n.INITIALIZING,n.STARTED];if(G.indexOf(this.jobExecutionStatus)===-1){var F=(this.logs.data.length+J)*H;if(F<I){I=F}}this.logs.height=I;this.logs.autoScroll=this.autoScroll;this.logs.jobObjectId=this.jobObjectId;this.logs.jobExecutionStatus=this.jobExecutionStatus;this.logs.mcsBaseURL=this.$.dashboard.getMcsUri();L.contentWindow.postMessage({type:"add",data:this.logs},"*")}}else{this.loadGrid=true}},y=function(){var F=this.DOM(this).find("#datagridFrame").root[0];if(F&&F.contentWindow){F.contentWindow.postMessage({type:"clear"},"*")}},b=function(){this.set("runningTask.Step","");this.set("runningTask.Activity","");this.linesParsed=0;B=[];this.jobLogEntry=[];this.logLength=0;if(this.logs){this.logs.data=[];this.logs.hasRunIDCloumn=false}this.eedJobLog={};this.set("jobProperties.duration","");this.set("jobProperties.startTime","");this.set("jobProperties.station","");this.startDate=0;this.exeDirList={}},g=function(G,F){if(this.isFrameLoaded){var H=this.DOM(this).find("#datagridFrame").root[0];if(H&&H.contentWindow){H.contentWindow.postMessage({type:"settablepreference",data:{column:G,show:F}},"*")}}else{if(!this._savedTablePrefSets){this._savedTablePrefSets=[]}this._savedTablePrefSets.push({column:G,show:F})}},c=function(M,J){M=(this.jobExecutionTime&&this.jobExecutionTime.startTimeMillis)||M;J=(this.jobExecutionTime&&this.jobExecutionTime.endTimeMillis)||J;var G=parseInt(M,10),H=new Date(G),N=H.getDate()+" "+H.toLocaleString("en-us",{month:"short"})+" "+H.getFullYear()+" "+H.toLocaleTimeString();this.set("jobProperties.startTime",N);var L,K,F;if(J){L=parseInt(J,10)}else{L=(new Date()).getTime()}K=new Date(L);F=K.getDate()+" "+K.toLocaleString("en-us",{month:"short"})+" "+K.getFullYear()+" "+K.toLocaleTimeString();this.set("jobProperties.endTime",F);var I=this.getDHMS(L-G);this.set("jobProperties.duration",I)},A=function(M){var K=24*60*60*1000,H=60*60*1000,L=Math.floor(M/K),F=Math.floor((M-L*K)/H),G=Math.floor((M-L*K-F*H)/60000),J=Math.floor((M-L*K-F*H-G*60000)/1000),I=function(N){return N<10?"0"+N:N};if(G===60){F++;G=0}if(F===24){L++;F=0}if(J===60){G++;J=0}return[L,I(F),I(G),I(J)].join(":")},q=function(){this.logState=D.NONE},o=function(){this.jobLogFlag=true;this.$.jobLogTimer.start()},e=function(){this.$.jobLogTimer.stop();this.jobLogFlag=false},u=function(){var F=this,H=this.eedJobLog.LogEntries.LogEntry,G=this.eedJobLog.LogEntries["@jobId"],K="",J=[];var I=["Completed","Aborted","Failed","Done"];if(H&&H.Time&&H.Time["@millis"]===this.startDate){H=null}if(!H&&I.indexOf(this.jobExecutionStatus)!==-1){setTimeout(function(){this.resetInterval()}.bind(this),30000)}if(this.eedjobId===G&&H){this._hideCustomMessage();if(!H.forEach){H=[H]}H.forEach(function(U){var L="@millis",V="@source",M="@compId",P="@actId",R="@severity";var O=new Date(parseInt(U.Time[L],10));var T={timeMillis:U.Time[L],Time:O.getDate()+" "+O.toLocaleString("en-us",{month:"short"})+" "+O.getFullYear()+","+O.toLocaleTimeString(),severity:i[U[R]]||U[R],Msg:U.Msg||"",source:U[V]||"",compId:U[M]||"",actId:U[P]||"",CompPath:U.CompPath||"",CompDisplayPath:U.CompDisplayPath||U.CompPath||"",CompIterRunId:U.CompIterRunId||"",CompIterDisplayPath:U.CompIterDisplayPath||""};T.Time=T.Time.replace(/&lrm;|\u200E/gi,"");if(U.CompDisplayPath){K=U.CompDisplayPath}var N=false;for(var S=0;S<B.length;S++){var Q=B[S];if(j.equals(Q,T)){N=true}}if(!N){B.push(T)}if(T.source.indexOf("Server ")===-1){F.set("jobProperties.station",T.source)}});if(B.length>0){this.logs.data=B;this.logLength=this.logs.data.length;this.logs.linesParsed=this.linesParsed;z.call(this);this.startDate=B[B.length-1].timeMillis;this.linesParsed=B.length;J=K.split(".");if(J.length>1){this.set("runningTask.Step",J[1]);if(this.runningTask.Activity!==J[0]){this.set("runningTask.Activity",J[0])}}else{this.set("runningTask.Step","");this.set("runningTask.Activity",J[0])}}c.call(this,B[0].timeMillis)}else{if(!(B.length>0)){if(this.simId){if(!(this.checkLogLevel.logLevel&&this.checkLogLevel.simulationId===this.simId&&this.checkLogLevel.jobObjId===this.jobObjectId)){d.call(this)}else{if(this.checkLogLevel.logLevel&&this.checkLogLevel.simulationId){this.checkLogLevel.logLevel=f(this.checkLogLevel.logLevel);if(this.checkLogLevel.logLevel==="SysError"){this.checkLogLevel.logLevel="System Error"}this._showCustomMessage(p+"\n note:- Log Level is set to '"+this.checkLogLevel.logLevel+"'")}else{this._showCustomMessage(p)}}}else{this._showCustomMessage(p)}}}},t=function(){var F=this;var G=410;this.$.jobLogFromCOS.sendRequest({uri:this._computeCosJobLogUri(this.eedjobId),onComplete:function(H){F.clearLogState();F.eedJobLog=JSON.parse(H.response);u.call(F)},onError:function(H){F.clearLogState();e.call(F);if(H.status===G){F.$.jobLogFromMCS.getData()}else{if(F.logs.data.length===0){if(F.simId){if(!(F.checkLogLevel.logLevel&&F.checkLogLevel.simulationId===F.simId&&F.checkLogLevel.jobObjId===F.jobObjectId)){d.call(F)}else{if(F.checkLogLevel.logLevel){if(F.checkLogLevel.logLevel==="SysError"){F.checkLogLevel.logLevel="System Error"}F._showCustomMessage(p+"\n note:- Log level is set to '"+F.checkLogLevel.logLevel+"'")}else{F._showCustomMessage(p)}}}else{F._showCustomMessage(p)}}}}})},x=function(){this.debounce("getJobLog",function(){var G="",H=false;this.jobExecutionStatusChanged();e.call(this);if(!this.jobObjectId){G="No jobs have been run for this process.";H=true}else{if(this.jobExecutionStatus===n.INITIALIZING&&this.jobObjectId===n.INITIALIZING){G="Job now Initializing";H=true}else{if(this.jobExecutionStatus===n.NOT_STARTED){G="Job is yet to be initialized, logs will be fetched once the job is initialized";H=true}}}this._showCustomMessage(G);if(this.jobObjectId){var F=[n.RUNNING,n.PAUSED,n.WAITING,n.QUEUED,n.NOT_STARTED,n.INITIALIZING,n.STARTED];if(F.indexOf(this.jobExecutionStatus)===-1){this.$.jobLogFromMCS.getData();this.logState=D.IS_GETTING}else{if(this.jobExecutionStatus===n.NOT_STARTED||this.jobExecutionStatus===n.INITIALIZING){return}if(this.startDate===0){H=true}this.logState=D.IS_GETTING;this.startInterval()}}if(H){b.call(this);y.call(this)}},100)},a=function(){var F=this;this.logState=D.NONE;y.call(this);if(this.jobLogEntry.length>0){B=this.jobLogEntry;B.forEach(function(G){var H=new Date(parseInt(G.timeMillis,10));G.Time=H.getDate()+" "+H.toLocaleString("en-us",{month:"short"})+" "+H.getFullYear()+","+H.toLocaleTimeString();G.Time=G.Time.replace(/&lrm;|\u200E/gi,"");G.severity=i[G.severity]||G.severity;G.CompDisplayPath=G.CompDisplayPath||G.CompPath||"";if(G.CompIterRunId&&G.CompIterRunId.length>0){F.logs.hasRunIDCloumn=true}});this.logs.data=B;this.logLength=this.logs.data.length;z.call(this);c.call(this,B[0].timeMillis,B[B.length-1].timeMillis)}else{if(this.logs.data.length===0){if(this.simId){if(!(this.checkLogLevel.logLevel&&this.checkLogLevel.simulationId===this.simId&&this.checkLogLevel.jobObjId===this.jobObjectId)){d.call(this)}else{if(this.checkLogLevel.logLevel){this.checkLogLevel.logLevel=f(this.checkLogLevel.logLevel);if(this.checkLogLevel.logLevel==="SysError"){this.checkLogLevel.logLevel="System Error"}this._showCustomMessage(p+"\n note:- Log level is set to '"+this.checkLogLevel.logLevel+"'")}else{this._showCustomMessage(p)}}}else{this._showCustomMessage(p)}}}},w=function(){this.autoScroll=!this.autoScroll},s=function(){this.checkLogLevel={};this.logs={data:[]};this.startDate=0;this.runningTask={};this.jobLogEntry=[];this.eedJobLog={};B=[];this.linesParsed=0;this.logState=D.NONE;this.isRunningJob=false;this.exeDirList={};l=this.$.CsvExpFrame},v=function(){var F=[n.RUNNING,n.PAUSED,n.WAITING,n.QUEUED];if(F.indexOf(this.jobExecutionStatus)!==-1){this.isRunningJob=true}else{this.isRunningJob=false}};window.DS.SMAProcSPUI=window.DS.SMAProcSPUI||{};window.DS.SMAProcSPUI.SPJobLog=Polymer({is:"sp-job-log",behaviors:[window.DS.SMAProcSP.SPBase],properties:{autoScroll:{type:Object,value:true,notify:true},height:{type:Number,value:500,notify:true},cosServerId:{type:String,notify:true},eedjobId:{type:String,notify:true},jobExecutionStatus:{type:String,notify:true,observer:"jobExecutionStatusChanged"},jobObjectId:{type:String,value:null,notify:true,observer:"jobObjectIdChanged"},jobTitle:{type:String,value:"",notify:true,observer:"jobTitleChanged"},runningTask:{type:Object,value:function(){return{}},notify:true},jobProperties:{type:Object,value:function(){return{duration:"",startTime:"",station:"",endTime:""}},notify:true},isFrameLoaded:{type:Boolean,value:false,notify:true},isRunningJob:{type:Boolean,notify:true},logLength:{type:Number,notify:true},simId:{type:String,value:null,notify:true},jobExecutionTime:{type:Object,value:{},notify:true}},clearLogState:q,setTablePreference:g,ready:s,toggleAutoScroll:w,parseJobLogFromMCS:a,getJobLog:x,useSimOptionsLogLevel:h,resetInterval:e,startInterval:o,getDHMS:A,clearDataGrid:y,jobExecutionStatusChanged:v,jobObjectIdChanged:function(G,F){if(G!==F){y.call(this);b.call(this)}},jobTitleChanged:function(){E=this.jobTitle},refreshJobLog:function(){return t.apply(this,arguments)},_computeCosJobLogUri:function(F){return"job/"+F+"/log?StartDate="+this.startDate},_computeMcsJobLogUri:function(){var F="jobs/"+this.jobObjectId+"/log";return F},_computeIf:function(F,H,G){var I=false;if(G>0&&F&&H&&H!==n.NOT_STARTED&&H!==n.INITIALIZING){I=true}return I},_showCustomMessage:function(F){this.DOM(this).find("#custommessage").root[0].textContent=F;this.DOM(this).find("#custommessage").root[0].style.display="block"},_hideCustomMessage:function(){this.DOM(this).find("#custommessage").root[0].style.display="none"},_onIframeLoad:function(){this.isFrameLoaded=true;if(this.loadGrid){this.loadGrid=false;z.call(this)}if(this._savedTablePrefSets){var F=this.DOM(this).find("#datagridFrame").root[0];if(F&&F.contentWindow){this._savedTablePrefSets.forEach(function(G){F.contentWindow.postMessage({type:"settablepreference",data:{column:G.column,show:G.show}},"*")})}this._savedTablePrefSets=null}}})});