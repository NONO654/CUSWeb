define("DS/SMAProcADUI/AdAppWidget",["UWA/Core","WebappsUtils/WebappsUtils","DS/WAFData/WAFData","DS/UIKIT/Spinner","UWA/Utils/InterCom","DS/PlatformAPI/PlatformAPI","DS/Controls/Loader"],function(j,c,g,d,e,k){var h=widget.getUrl();if(h.indexOf("/webapps")>-1){h=h.substring(0,h.indexOf("/webapps"))}else{h=k.getApplicationConfiguration("app.urls.myapps")}var b=function(){document.getElementById("adAppMain").stopFileMonitorJobs()};var i=function(n){if(document.createEvent&&f.addCmp.dispatchEvent){var m=document.createEvent("HTMLEvents");m.initEvent("onObjectInstantiate",true,true);m.detail={processId:n.processId,processName:n.processName};f.addCmp.dispatchEvent(m)}else{if(f.addCmp.fireEvent){var o=new CustomEvent("onObjectInstantiate",{detail:{processID:n.processId,processName:n.processName}});f.addCmp.fireEvent(o)}}};var a=function(m){if(m!==null&&f.reload){if(f.dashboardWidget&&f.dashboardWidget.removeDropNotes&&typeof(f.dashboardWidget.removeDropNotes)==="function"){i.call(this,m)}else{setTimeout(a.bind(this,m),100)}}};var l=function(p){f.dashboardWidget=UWA.createElement("sp-drop");f.dashboardWidget.setAttributes({"drop-note-text":"Simulation Companion Process","show-add":true,"error-message":"You can drop only a single "});f.addCmp=j.createElement("ad-add-process",{templatetype:"type_Simulation",usage:"Adhoc",dialogtitle:"Simulation Companion Process"});f.addCmp.inject(widget.body);f.dashboardWidget.inject(widget.body);f.createSpinner();if(p){var m=UWA.createElement("ad-app-main");m.set({scl:"true",psl:"true",securityContext:f.getSecurityContext(),procId:p,"class":"mainAdApp",id:"adAppMain"});f.dashboardWidget.injectContent(m)}else{if(f.dashboardWidget!==null){f.dashboardWidget.addEventListener("onObjectDrop",function(q){q.preventDefault();q.stopPropagation();f.reload=true;if(f.invalidProcNotif){f.invalidProcNotif.remove()}if(f.loadingSpinner){f.loadingSpinner.show()}var r=f.dashboardWidget.objectData;g.authenticatedRequest(h+"/resources/slmservices/simulations/"+r.objectId,{type:"json",headers:{Accept:"application/json"},onComplete:function(u){f.loadingSpinner.hide();if(u.attributes["Simulation Kind"]==="adhoc"){f.adApp=f.createADApp(r.objectId);f.updateWidgetTitle(r.displayName);widget.setValue("SCProcessInfo",{processId:r.objectId,processName:r.displayName});var s=UWA.createElement("span");f.adApp.inject(s);f.dashboardWidget.injectContent(s);f.createCloseButton()}else{var t={text:'Simulation Companion only accepts processes of type "adhoc". Please verify and try again.',type:"error"};f.invalidProcNotif=f.createNotification();f.invalidProcNotif.inject(widget.body);f.invalidProcNotif.logMessage(t);if(!f.adApp){f.dashboardWidget.revertToDrop();f.updateWidgetTitle("")}}},onFailure:function(){f.loadingSpinner.hide();console.error("Failed to get process information.");var s={text:"Failed to get process information. Please try again.",type:"error"};f.invalidProcNotif=f.createNotification();f.invalidProcNotif.inject(widget.body);f.invalidProcNotif.logMessage(s);if(!f.adApp){f.dashboardWidget.revertToDrop();f.updateWidgetTitle("")}}})});f.dashboardWidget.addEventListener("objectcreate",function(q){q.preventDefault();q.stopPropagation();f.addCmp.showDialog()});f.addCmp.addEventListener("onObjectInstantiate",function(q){q.preventDefault();q.stopPropagation();f.reload=true;g.authenticatedRequest(h+"/resources/e6w/service/SMA_MetaData?objectId="+q.detail.processId,{type:"json",headers:{Accept:"application/json"},onComplete:function(s){if(s.datarecords.datagroups[0].objectId!==""){f.dashboardWidget.removeDropNotes();widget.setValue("processId",q.detail.processId);widget.setTitle(q.detail.processName);widget.setValue("SCProcessInfo",{processId:q.detail.processId,processName:q.detail.processName});f.adApp=f.createADApp(q.detail.processId);var r=UWA.createElement("span");f.adApp.inject(r);f.dashboardWidget.injectContent(r);f.createCloseButton()}else{f.dashboardWidget.revertToDrop();f.updateWidgetTitle("")}},onError:function(){console.log("Unable to find process information");f.dashboardWidget.revertToDrop();f.updateWidgetTitle("")}})});f.addCmp.addEventListener("toggleSpinner",function(q){q.preventDefault();q.stopPropagation();f.loadingSpinner.toggle()})}else{var n=new UWA.Element("div",{id:"mainDiv",src:""}).inject(widget.body);n.innerHTML="Unable to load dashboard widget"}}var o=widget.getValue("SCProcessInfo");if(typeof(o)!=="undefined"){a.call(this,o)}window.onbeforeunload=function(){b.call(this)}.bind(this);window.onunload=function(){b.call(this)}.bind(this)};var f={adApp:null,invalidProcNotif:null,reload:true,onLoad:function(m){this._baseURI=h;f._baseURI=h;widget.body.empty();f.spDashboard=UWA.createElement("sp-dashboard");f.spDashboard.addSecurityContextPreference().then(function(){g.authenticatedRequest(f._baseURI+"/resources/slmservices/license?appNames=Simulation_Companion&SecurityContext="+f.getSecurityContext(),{type:"json",headers:{Accept:"application/json"},onComplete:function(n){if(n.Simulation_Companion==="true"){l.call(this,m)}else{widget.body.empty();var o={text:"You do not have the license required to access the selected application. Please contact your administrator.",type:"error",autoRemove:false,clickToRemove:false};var p=setInterval(function(){f.licenseErrorNotif=f.createNotification("licenseErrorNotif");f.licenseErrorNotif.position="TC";if(widget.body.getElement("#licenseErrorNotif")){widget.body.getElement("#licenseErrorNotif").destroy()}f.licenseErrorNotif.inject(widget.body);f.licenseErrorNotif.logMessage(o,"licenseErrorNotif");clearInterval(p)},100)}},onFailure:function(){widget.body.empty();var o={text:"The call to the license server failed. Please try again or contact your administrator.",type:"error",autoRemove:false,clickToRemove:false};var n=setInterval(function(){f.licenseErrorNotif=f.createNotification("licenseErrorNotif");f.licenseErrorNotif.position="TC";if(widget.body.getElement("#licenseErrorNotif")){widget.body.getElement("#licenseErrorNotif").destroy()}f.licenseErrorNotif.inject(widget.body);f.licenseErrorNotif.logMessage(o,"licenseErrorNotif");clearInterval(n)},100)}})})},onRefresh:function(){var o=setTimeout(function(){});for(var n=0;n<o;n++){clearTimeout(n)}b.call(this);var m=widget.getValue("SCProcessInfo");if(typeof(m)!=="undefined"&&f.reload){i.call(this,m)}},getSecurityContext:function(){var m=null;if(typeof widget.getPreference("collabspaces")!=="undefined"&&widget.getPreference("collabspaces")!==null){if(typeof widget.getPreference("collabspaces").value!=="undefined"&&widget.getPreference("collabspaces").value!==null){m=widget.getValue("collabspaces")}}return m},createADApp:function(m){if(f.adApp){f.adApp.remove()}var n=UWA.createElement("ad-app-main");n.set({scl:"true",psl:"true",securityContext:f.getSecurityContext(),procId:m,"class":"mainAdApp",id:"adAppMain"});return n},createNotification:function(){var m=UWA.createElement("sp-notification");m.set({id:"spNotification",position:"TC",width:"400"});return m},createSpinner:function(){f.loadingSpinner=new d({className:"large",spin:true});f.loadingSpinner.elements.container.style.position="absolute";f.loadingSpinner.elements.container.style.top="30%";f.loadingSpinner.elements.container.style.left="50%";f.loadingSpinner.inject(widget.body)},createCloseButton:function(){var m=UWA.createElement("button");m.set({type:"button","class":"btn btn-default closeButton",value:"Close",title:"Close this process"});m.textContent="Close";m.addEventListener("click",function(o){f.reload=false;var p=setTimeout(function(){});for(var n=0;n<p;n++){clearTimeout(n)}b.call(this);o.stopPropagation();if(f.adApp){f.adApp=null}widget.setTitle("");f.onLoad()});m.inject(widget.body)},updateWidgetTitle:function(m){var n="Simulation Companion";widget.setTitle("");if(m!==""){n=m}widget.setTitle(n)},};widget.addEvent("onLoad",f.onLoad);widget.addEvent("onRefresh",f.onRefresh);return f});