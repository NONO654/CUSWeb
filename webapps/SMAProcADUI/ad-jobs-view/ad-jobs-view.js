/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
(function(o){var j=o.Polymer,n=o.DS;var k=null,q=null,f=null,C=null,d=null,g=null,h=null,r=null,m=null,a=null,b=null,p=null,l=null,u=null,t=null,s=null,B=null,A=null,y=null,i=null,z=null,w=null,v=null,E=null,e=30,c=null,D={appMessage:"appmessage"},x={variable:"sp-variable"};k=function(){};q=function(){if(this.session){this.session.addEventListener(n.SMAProcADUI.ADSession.EVENTS.jobsLoaded,C.bind(this));this.session.addEventListener(n.SMAProcADUI.ADSession.EVENTS.error,f.bind(this));this.session.loadJobs(true)}};f=function(F){if(n.SMAProcADUI.ADSession.ERRORS.jobDeleteWSError===F.detail.error){this.session.loadJobs(true);var G="Couldn't delete job(s)";if(typeof F.detail.message!=="undefined"&&F.detail.message&&F.detail.message.length>0){G+=": "+F.detail.message}else{G+=": Unspecified Web Service error"}this.fire(D.appMessage,{level:"error",message:G})}};C=function(){var H=false;if(c){o.clearTimeout(c);c=null}var N,F=this.$.jobList,I=this.$.jobLogSidepanel;var M={},G={},L={},J=this.$.jobList.jobInstanceListViews,K;for(K=0;K<J.length;K+=1){M[J[K].jobInstance.jobMcsId]=J[K].detailsVisible;G[J[K].jobInstance.jobMcsId]=J[K].logVisible;L[J[K].jobInstance.jobMcsId]=J[K].selected}F.clearJobs();if(this.session.jobs&&this.session.jobs.length>0){this.session.jobs.forEach(function(O){if(O.jobTitle&&O.jobTitle.indexOf("upload_Job")>=0){return}O.jobLabel=O.jobTitle;N=new n.SMAProcADUI.ADJobInstanceListView();if(this.filterByJobTitle.status){N.jobTypeAS="Job"}N.jobInstance=O;N.jobLogSidepanel=I;if(O.jobMcsId in M){if(M[O.jobMcsId]===true){N.onJobDetailsButton()}}if(O.jobMcsId in G){if(G[O.jobMcsId]===true){N.onJobLogButton()}}if(this.filterByJobTitle&&this.filterByJobTitle.status){if(O.jobTitle===this.filterByJobTitle.title){F.addJob(N)}}else{F.addJob(N)}if(O.jobMcsId in L){if(L[O.jobMcsId]===true){F.selectJob(N)}}if(O.jobState==="Running"||O.jobState==="Paused"||O.jobState==="NotStarted"||O.jobState==="Initializing"||O.jobState==="Waiting"){H=true}}.bind(this))}F.setNoJobsMessage();z.call(this);if(H){c=o.setTimeout(b.bind(this),e*1000)}};d=function(){var I=this.$.jobList.selectedJobInstanceListViews,H,G=[],F;while(I.length>0){H=I.pop();this.$.jobList.removeJob(H);G.push(H.jobInstance)}this.session.removeJobs(G);F={detail:{selectedJobInstanceListViews:this.$.jobList.selectedJobInstanceListViews}};m.call(this,F)};g=function(F){var H=null,I=null,G=null;if(F.jobEedId){H=this.$.abortJobsWS.uri.replace("<jobId>",F.jobEedId);I={Accept:"text/plain"};G={uri:H,verb:"PUT",headers:I,objectId:F.jobMcsPhysicalId,onComplete:l.bind(this),onError:u.bind(this,F)};if(F.jobEedServer){G.serverId=F.jobEedServer}this.$.abortJobsWS.sendRequest(G)}};m=function(J){if(J.detail.selectedJobInstanceListViews){var H,L=J.detail.selectedJobInstanceListViews;var K=true;var G=false;var F=true;var I=false;for(H=0;H<L.length;H++){if(L[H].jobInstance.jobState==="Running"){G=true;F=false}else{if(L[H].jobInstance.jobState==="Paused"){K=false;I=true}else{if(L[H].jobInstance.jobState==="Complete"){F=false;K=false}else{F=false;K=false}}}}this.DOM(this.$.stopJobsMenuButton).addClass("disabled");this.DOM(this.$.deleteJobsMenuButton).addClass("disabled");this.DOM(this.$.ViewJobsLogMenuButton).addClass("disabled");if(L.length===1){this.DOM(this.$.ViewJobsLogMenuButton).removeClass("disabled")}if(L.length>0){if(G||I){this.DOM(this.$.deleteJobsMenuButton).addClass("disabled")}else{this.DOM(this.$.deleteJobsMenuButton).removeClass("disabled")}if(F){this.DOM(this.$.stopJobsMenuButton).removeClass("disabled")}if(K&&L.length===1){this.DOM(this.$.stopJobsMenuButton).removeClass("disabled")}}}};a=function(){t.call(this)};b=function(){this.session.loadJobs(true);return true};p=function(){if(confirm("Are you sure that you want abort the selected Job?")){var F=this.$.jobList.selectedJobInstanceListViews[0].jobInstance;g.call(this,F,false)}return true};l=function(){this.session.loadJobs(true);return true};u=function(){alert("An error occurred and the selected Job was not aborted.");return true};t=function(){var F=this.$.jobList.selectedJobInstanceListViews;if(F.length===1){if(this.$.spDash.isInDashboard()){this.$.adJobLog.jobObjectId=F[0].jobInstance.jobMcsId;this.$.adJobLog.jobExecutionStatus=F[0].jobInstance.jobState;this.$.adJobLog.eedjobId=F[0].jobInstance.jobEedId;this.$.adJobLog.cosServerId=F[0].jobInstance.jobEedServer;this.$.adJobLog.height=o.innerHeight-145;j.dom(this.$.jobLogTitle).textContent=F[0].jobInstance.jobType+" : "+F[0].jobInstance.jobLabel+"  ("+F[0].jobInstance.jobStartTime+" - "+F[0].jobInstance.jobStopTime+")";this.$.jobLogPanel.style.display="block";this.$.jobLogPanel.open();this.$.jobLogPanel.classList.add("minHeight");this.$.adJobLog.getJobLog()}else{F[0].onViewLogJobsMenuButton()}}return true};s=function(){var F=[],H=null,G;if(!localStorage["SMAProcAdhoc.preferences.hideRemoveJobsConfirm"]){localStorage["SMAProcAdhoc.preferences.hideRemoveJobsConfirm"]="false"}H=localStorage["SMAProcAdhoc.preferences.hideRemoveJobsConfirm"].toLowerCase()==="true";if(!H){for(G=0;G<this.$.jobList.selectedJobInstanceListViews.length;G++){F.push(this.$.jobList.selectedJobInstanceListViews[G].jobInstance)}if(!this._jobRemoveDlg){this._jobRemoveDlg=new n.SMAProcADUI.ADJobRemoveDialog();this._jobRemoveDlg.addEventListener("accept",B.bind(this),false);j.dom(document.body).appendChild(this._jobRemoveDlg)}this._jobRemoveDlg.hideConfirm=H;this._jobRemoveDlg.selectedJobs=F;this._jobRemoveDlg.show()}else{d.call(this)}};B=function(){if(this._jobRemoveDlg){localStorage["SMAProcAdhoc.preferences.hideRemoveJobsConfirm"]=this._jobRemoveDlg.hideConfirm?"true":"false"}d.call(this)};A=function(F){this.$.jobLogSidepanel.close();this.$.adJobLog.resetInterval();F.stopPropagation();F.cancelBubble=true;return true};y=function(F){F.stopPropagation();F.cancelBubble=true;return true};i=function(){this.$.jobTypeSelector.visible=true};z=function(){var M=this.$.tools.checked;var L=this.$.uploads.checked;var G=this.$.downloads.checked;var N=this.$.running.checked;var H=this.$.completed.checked;var Q=this.$.failed.checked;var I=this.$.aborted.checked;if(!M||!L||!G||!N||!H||!Q||!I){var S=this.$.jobList.jobInstanceListViews.length;var J=[];if(M&&L&&G){J.push(n.SMAProcADUI.ADJobListView.TYPE_CRITERIA.all)}else{if(M){J.push(n.SMAProcADUI.ADJobListView.TYPE_CRITERIA.tools)}if(L){J.push(n.SMAProcADUI.ADJobListView.TYPE_CRITERIA.uploads)}if(G){J.push(n.SMAProcADUI.ADJobListView.TYPE_CRITERIA.downloads)}}var K=[];if(N&&H&&Q&&I){K.push(n.SMAProcADUI.ADJobListView.STATUS_CRITERIA.all)}else{if(N){K.push(n.SMAProcADUI.ADJobListView.STATUS_CRITERIA.running)}if(H){K.push(n.SMAProcADUI.ADJobListView.STATUS_CRITERIA.completed)}if(Q){K.push(n.SMAProcADUI.ADJobListView.STATUS_CRITERIA.failed)}if(I){K.push(n.SMAProcADUI.ADJobListView.STATUS_CRITERIA.aborted)}}var P={type:J,status:K};var O=this.$.jobList.filterListJobs(P);j.dom(this.$.filterJobsTypeMenuButton).classList.add("filtered");j.dom(this.$.filterInfo).innerHTML='<span style="vertical-align: middle;">('+O+"/"+S+")</span>"}else{var J=[];var K=[];J.push(n.SMAProcADUI.ADJobListView.TYPE_CRITERIA.all);K.push(n.SMAProcADUI.ADJobListView.STATUS_CRITERIA.all);var P={type:J,status:K};this.$.jobList.filterListJobs(P);j.dom(this.$.filterJobsTypeMenuButton).classList.remove("filtered");j.dom(this.$.filterInfo).innerHTML=""}};w=function(){this.DOM(this.$.jobLogTitle).toggleClass("is-readonly");this.$.adJobLog.getJobLog()};v=function(){this.$.adJobLog.getJobLog()};E=function(){if(!j.dom(this.$.jobLogTitle).classList.contains("is-readonly")){this.DOM(this.$.jobLogTitle).addClass("is-readonly")}this.$.jobLogPanel.style.display="none";this.$.jobLogPanel.classList.remove("minHeight")};h=function(){this._jobRemoveDlg=null};r=function(){this.DOM(this).find(x.variable).forEach(function(F){this.set("globals."+F.name,F.getValue())}.bind(this));this.$.jobList.jobLogSidepanel=this.$.jobLogSidepanel;this.$.jobList.addEventListener(n.SMAProcADUI.ADJobListView.EVENTS.selectionsChanged,m.bind(this));this.$.jobList.addEventListener(n.SMAProcADUI.ADJobListView.EVENTS.jobEdited,a.bind(this));if(this.$.spDash.isInDashboard()){this.$.jobLogSidepanel.style.display="none";this.$.jobLogPanel.style.display="block"}else{this.$.jobLogPanel.style.display="none";this.$.jobLogSidepanel.style.display="block"}console.log("Ad-hoc Jobs View ready")};n.SMAProcADUI=n.SMAProcADUI||{};n.SMAProcADUI.ADJobsView=j({is:"ad-jobs-view",properties:{access:{type:String,value:"",reflectToAttribute:true},globals:{type:Object,value:function(){return{}}},session:{value:null,observer:"sessionChanged"},filterByJobTitle:{type:Object,value:function(){return{}}}},created:function(){return h.apply(this,arguments)},ready:function(){return r.apply(this,arguments)},onJobsListSelectionChanged:function(){return m.apply(this,arguments)},onJobEdit:function(){return a.apply(this,arguments)},onFilterJobsTypeMenuButton:function(){return i.apply(this,arguments)},onFilterJobsTypeMenuSelect:function(){return z.apply(this,arguments)},onRefreshJobsMenuButton:function(){return b.apply(this,arguments)},onStopJobsMenuButton:function(){return p.apply(this,arguments)},onStopJobsResponse:function(){return l.apply(this,arguments)},onStopJobsError:function(){return u.apply(this,arguments)},onDeleteJobsMenuButton:function(){return s.apply(this,arguments)},onViewJobsLogMenuButton:function(){return t.apply(this,arguments)},onStretch:function(){return w.apply(this,arguments)},onPopUp:function(){return v.apply(this,arguments)},onJobsPanelClose:function(){return E.apply(this,arguments)},onJobLogSidepanelCancel:function(){return A.apply(this,arguments)},onJobLogSidepanelRefresh:function(){return y.apply(this,arguments)},sessionChanged:function(){q.call(this)},behaviors:[n.SMAProcSP.SPBase],})}(this));