/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
window.require(["DS/SMAProcADUI/ad-station/ADStation"],function(y){var O=window.Polymer,S=window.DS;var r=null,K=null,E=null,T=null,V=null,X=null,N=null,j=null,d=null,l=null,p="DownloadedFiles.xml",F="lsf",z=403,u=404,L=60000,A={variable:"sp-variable"},m={update:"update",appMessage:"appMessage"},k={unspecified:1,userCanceled:2,directoryAccess:3,directoryAccessHost:4,itemNotFound:5,notAuthorized:6,possibleMixedContent:7,userStationMismatch:8,transientMonitorFinished:9},R={folder:"folder",file:"file"},v={},h={},x=false,g=false,U=null,C=null,t=null,i=null,G=null,a=null,w=null,M=null,s=null,b=null,f=null,o=null,B=null,c=null,P=null,n=null,e=null,q=null,I=null,Q=null,W=null,H=null,J=null,D=null;r=function(Z){var Y=null,ab=[],aa;if(Z.response){Y=(typeof Z.response==="string")?JSON.parse(Z.response):Z.response}if(Y&&(typeof Y.StationList!=="undefined"&&Y.StationList)&&(typeof Y.StationList.Station!=="undefined"&&Y.StationList.Station)){if(Array.isArray(Y.StationList.Station)){Y.StationList.Station.forEach(function(ac){if(ac.GeneralInfo&&ac.GeneralInfo["@drmMode"]&&ac.GeneralInfo["@drmMode"].toLowerCase()!==F){aa=new y.ADStation();aa.load(ac);aa.queryName=aa.name;ab.push(aa)}})}else{if(Y.StationList.Station.GeneralInfo&&Y.StationList.Station.GeneralInfo["@drmMode"]&&Y.StationList.Station.GeneralInfo["@drmMode"].toLowerCase()!==F){aa=new y.ADStation();aa.load(Y.StationList.Station);aa.queryName=aa.name;ab.push(aa)}}}return ab};K=function(){var Y,Z;if(h){Object.keys(h).forEach(function(aa){if(h[aa]){for(Y=0;Y<h[aa].length;Y++){Z=h[aa][Y];if(Z.name===y.ADStation.LOCALSTATIONNAME){h[aa].splice(Y,1);break}}}})}};E=function(Z,aa){var ab=null,Y;if(Z&&aa){for(Y=0;Y<aa.length;Y++){if((aa[Y].name===Z.name)||(aa[Y].queryName===Z.queryName)){ab=aa[Y];break}}if(ab){ab.status=Z.status}else{aa.push(Z)}}};T=function(Y){var ab,aa=function(ac){var ae,ad;ae=r(ac);if((typeof h[Y.serverId]==="undefined")||!h[Y.serverId]){h[Y.serverId]=[]}for(ad=0;ad<ae.length;ad++){ae[ad].server=Y.serverId;E.call(this,ae[ad],h[Y.serverId])}this.fire(m.update,{});if(Y.onComplete){Y.onComplete()}}.bind(this),Z=function(ac){this.fire(m.update,{});if(Y.onFailure){Y.onFailure(ac.status)}}.bind(this);if(Y&&Y.serverId&&Y.refresh){ab={serverId:Y.serverId,onComplete:aa,onError:Z};this.$.stationWS.sendRequest(ab)}else{if(Y.onComplete){Y.onComplete()}}};V=function(Y){var ac,aa=function(ae){var af=r(ae);if(af.length>0){af[0].name=y.ADStation.LOCALSTATIONNAME;af[0].server=Y.serverId;E.call(this,af[0],h[Y.serverId])}this.fire(m.update,{});if(Y.onComplete){Y.onComplete()}}.bind(this),ab=function(ae){this.fire(m.update,{});if(Y.onFailure){Y.onFailure(ae.status)}}.bind(this),Z=function(ae){if(!this.$.cos.utils.isCosVersionSameOrNewer(ae,418,3)&&Y.refresh){ac={serverId:Y.serverId,onComplete:aa,onError:ab};this.$.localStationWS.sendRequest(ac)}else{if(Y.onComplete){Y.onComplete()}}}.bind(this),ad=function(ae){if(Y.onFailure){Y.onFailure(ae)}}.bind(this);if(Y&&Y.serverId){this.$.cos.requestCosVersionForServer(Y.serverId,{onComplete:Z,onFailure:ad})}};X=function(ag){var ad=null,ab,Z=[],af=0,ae=function(ah){if(ah){for(ab=0;ab<ah.length;ab++){ad=new y.ADStation();ad.name=y.ADStation.LOCALSTATIONNAME;if(ah[ab].info.os.toLowerCase()==="unix"){ad.os=y.ADStation.OSTYPES.linux}else{ad.os=y.ADStation.OSTYPES.windows}ad.status=ah[ab].info.status;ad.runAsEnabled=false;ad.allowedUsers=[ah[ab].info.user];ad.domains=[];ad.queryName=ad.name;ad.uri=ah[ab].uri;ad.server=ah[ab].info.cosid;if((typeof h[ah[ab].info.cosid]==="undefined")||!h[ah[ab].info.cosid]){h[ah[ab].info.cosid]=[]}E.call(this,ad,h[ah[ab].info.cosid])}this.fire(m.update,{})}if(ag.onComplete){ag.onComplete()}}.bind(this),ac=function(ah){this.fire(m.update,{});if(ag.onFailure){ag.onFailure(ah)}}.bind(this),Y=function(ah){this.status=ah.status;if((++af===Z.length)&&ag.onComplete){ag.onComplete()}}.bind(this),aa=function(){this.status=y.ADStation.STATUS.unknown;if((++af===Z.length)&&ag.onComplete){ag.onComplete()}}.bind(this);if(ag&&ag.refreshPrivateStations){K.call(this);this.$.cos.getPrivateStationInfo({onComplete:ae,onFailure:ac})}else{Object.keys(h).forEach(function(ah){if(h[ah]){for(ab=0;ab<h[ah].length;ab++){ad=h[ah][ab];if(ad.uri&&(ad.uri.length>0)){Z.push(ad)}}}});if(Z.length>0){af=0;for(ab=0;ab<Z.length;ab++){this.$.localStationInfoWS.sendRequest({uri:Z[ab].uri+"/station/info",onComplete:Y.bind(Z[ab]),onError:aa.bind(Z[ab])})}}else{if(ag.onComplete){ag.onComplete()}}}};N=function(Z,ab,aa){var ac=null,Y=null;ab.lastModified=aa.lastModified;if(typeof aa.fileList!=="undefined"){ac=aa.fileList}if(typeof aa.directoryList!=="undefined"){Y=aa.directoryList}j.call(this,Z,ab,ac,Y)};j=function(ad,Y,ag,Z){var ae="",af,ac,aa=null,ab=null;Y.folders=[];Y.files=[];if(typeof Y.relativePath!=="undefined"&&Y.relativePath){ae=Y.relativePath+"/"}if(ag&&ad){ag.forEach(function(ah){if(ah.name&&ah.name.toLowerCase()!==p.toLowerCase()){ac={};ac.parent=Y;ac.accessDisabled=false;ac.type=R.file;ac.id=ah.name;ac.modelID=ah.name;ac.name=ah.name;ac.lastModified=ah.modified;ac.station=ad.station;ac.path=Y.path;ac.relativePath=ae+ac.name;ac.size=ah.fileSize?ah.fileSize:"";Y.files.push(ac)}})}if(Z&&ad){Z.forEach(function(ah){af={};af.parent=Y;af.accessDisabled=false;af.type=R.folder;af.id=ah.name;af.modelID=ah.name;af.name=ah.name;af.lastModified=ah.lastModified;af.station=ad.station;af.path=Y.path;af.relativePath=ae+af.name;if(this.session.addActivityFolderForPS){af=this.session.addActivityFolderForPS(af);if(!af.exists){Y.folders.push(af)}}else{Y.folders.push(af)}ab=aa=null;if(typeof ah.directoryList!=="undefined"){ab=ah.directoryList}if(typeof ah.fileList!=="undefined"){aa=ah.fileList}j.call(this,ad,af,aa,ab)}.bind(this))}Y.loaded=true};d=function(){this.DOM(this).find(A.variable).forEach(function(Y){this.set("globals."+Y.name,Y.getValue())}.bind(this))};U=function(Y){var aa=function(ad){var ab=[],ac;if(ad){ad.forEach(function(ae){ac=v[ae.id];if(ac){ae.runAsEnabled=ac.runAsEnabled}v[ae.id]=ae;ab.push(ae)}.bind(this))}if(Y&&Y.onComplete){Y.onComplete(ab)}}.bind(this),Z=function(ab){if(Y&&Y.onFailure){Y.onFailure(ab)}}.bind(this);this.$.cos.getCosConfiguration({onComplete:aa,onFailure:Z,refresh:(Y.refresh)?Y.refresh:false})};C=function(aa){var ab=function(){if(aa.onComplete){aa.onComplete(h[aa.serverId])}}.bind(this),ac=function(af){console.error("Error getting remote stations: "+af);if(aa.onComplete){aa.onComplete(h[aa.serverId])}}.bind(this),ad=function(){T.call(this,{serverId:aa.serverId,refresh:true,onComplete:ab,onFailure:ac})}.bind(this),Z=function(af){console.error("Error getting local stations: "+af);T.call(this,{serverId:aa.serverId,refresh:true,onComplete:ab,onFailure:ac})}.bind(this),ae=function(){V.call(this,{serverId:aa.serverId,refresh:true,onComplete:ad,onFailure:Z})}.bind(this),Y=function(af){console.error("Error getting private stations: "+af);V.call(this,{serverId:aa.serverId,refresh:true,onComplete:ad,onFailure:Z})}.bind(this);if(aa&&aa.serverId&&aa.refresh){h[aa.serverId]=[];X.call(this,{refreshPrivateStations:aa.refresh,onComplete:ae,onFailure:Y})}else{if(aa.onComplete){aa.onComplete((typeof h[aa.serverId]!=="undefined")?h[aa.serverId]:[])}}};t=function(Y){var ab=null,Z,aa=[];if(this.session){ab=this.session.executionDirectories;if(ab){for(Z=0;Z<ab.length;Z++){if(!Y||Q(Y,ab[Z])){aa.push(ab[Z])}}}}return aa};i=function(Y){return(typeof v[Y]!=="undefined")?v[Y]:null};G=function(Y){var Z,ac=[],ab=null,aa=null;if(h){Object.keys(h).forEach(function(ad){if(h[ad]){for(Z=0;Z<h[ad].length;Z++){ab=h[ad][Z];if((ab.name===Y)||(ab.queryName===Y)){ac.push(i(ad));break}}}})}if(ac.length>1){aa=ac}else{if(ac.length===1){aa=ac[0]}}return aa};a=function(Y){var ab,aa=null,Z;ab=this.getServersForStation(Y);if(Array.isArray(ab)&&(ab.length>0)){ab.sort(function(ad,ac){return ad.id.toLowerCase().localeCompare(ac.id.toLowerCase())});aa=ab[0];for(Z=0;Z<ab.length;Z++){if(ab[Z].isDefault){aa=ab[Z];break}}}else{if(ab){aa=ab}}return aa};w=function(){var aa=null,Z=Object.keys(v),Y;for(Y=0;Y<Z.length;Y++){if(Y===0){aa=v[Z[Y]]}else{if(v[Z[Y]].isDefault){aa=v[Z[Y]]}}}return aa};M=function(){var aa=null,Z=Object.keys(v),Y;for(Y=0;Y<Z.length;Y++){if(v[Z[Y]].isDefault){aa=v[Z[Y]]}}return aa};s=function(Y,Z){var ab=null,ae,ad=null,ac=function(){Object.keys(v).forEach(function(af){v[af].isDefault=(af===Y)});if(Z.onComplete){Z.onComplete()}},aa=function(af){if(Z.onFailure){Z.onFailure(af.status)}};ab=this.$.dashboard.getMcsUri()+this.$.defaultServerWS.uri.replace("<serverID>",Y);ae={Accept:"text/plain"};ad={uri:ab,verb:"PUT",headers:ae,onComplete:ac,onError:aa};this.$.defaultServerWS.sendRequest(ad)};b=function(Y,ad){var Z=[],ag=null,ab,aa,af,ae=null,ac=false;if(Y&&(Y.length>0)){if(ad){Z=[ad]}else{Z=Object.keys(h)}for(ab=0;ab<Z.length;ab++){if(v[Z[ab]].isDefault){ae=Z[ab];break}}for(ab=0;ab<Z.length;ab++){af=Z[ab];if(h[af]){for(aa=0;aa<h[af].length;aa++){if((h[af][aa].name===Y)||(h[af][aa].queryName===Y)){ag=h[af][aa];if(ae&&(af===ae)){ac=true;break}}}}if(ac){break}}}return ag};f=function(Z){var Y=this.getStation(Z);if(Y===null){return false}if(Y.os===y.ADStation.OSTYPES.linux){return true}else{return false}};o=function(){var Y=[],aa=null,Z;Y=Object.keys(h);Y.forEach(function(ab){if(h[ab]){for(Z=0;Z<h[ab].length;Z++){if((h[ab][Z].name===y.ADStation.LOCALSTATIONNAME)||(h[ab][Z].queryName===y.ADStation.LOCALSTATIONNAME)){aa=h[ab][Z];break}}}});return aa};B=function(Z){var ab,aa,Y=null;if(Z){ab=t.call(this,null);for(aa=0;aa<ab.length;aa++){if(ab[aa].name&&ab[aa].name.toLowerCase()===Z.toLowerCase()){Y=ab[aa];break}}}return Y};c=function(ab){var aa,Z,Y=null;if(ab){aa=t.call(this,null);for(Z=0;Z<aa.length;Z++){if(aa[Z].path&&aa[Z].path.toLowerCase()===ab.toLowerCase()){Y=aa[Z];break}}}return Y};P=function(Y){var ab,aa=function(ac){v[Y.serverId].runAsEnabled=(ac.response)?ac.response.toLowerCase().startsWith("true"):false;this.fire(m.update,{});if(Y.onComplete){Y.onComplete(ac.response)}}.bind(this),Z=function(ac){v[Y.serverId].runAsEnabled=false;this.fire(m.update,{});if(Y.onFailure){Y.onFailure(ac.status)}}.bind(this);if(Y&&Y.serverId&&Y.refresh&&this.session){ab={headers:{Accept:"text/plain",},objectId:this.session.processID,serverId:Y.serverId,onComplete:aa,onError:Z};this.$.runAsEnabledWS.sendRequest(ab)}else{if(Y.onComplete){Y.onComplete(v[Y.serverId].runAsEnabled)}}};n=function(Y){if(this.session&&Y&&!B.call(this,Y.name)){this.session.addExecutionDirectory(Y)}this.fire(m.update,{})};e=function(ac,Z,ad){var aa=function(ah){if(Z){Z({execDir:ah})}},Y=function(ah){if(S.SMAProcSP.SPCOSFileMonitor.ERRORS.credentialsNotSupplied===ah.error){ae=k.userCanceled}else{if(S.SMAProcSP.SPCOSFileMonitor.ERRORS.filemonURLNotFound===ah.error){ae=k.directoryAccessHost}else{if(S.SMAProcSP.SPCOSFileMonitor.ERRORS.filemonJobUserStationMismatch===ah.error){ae=k.userStationMismatch}else{ae=k.directoryAccess}}}if(ad){ad({execDir:ac,errorCode:ae})}}.bind(this),ae=k.unspecified,ag={execDir:ac,onComplete:aa,onFailure:Y},af=function(){this.$.fileMonitor.getFileMonitor(ag)},ab;if(!ac.serverID){ab=this.getServerForStation(ac.station);ac.serverID=ab?ab.id:null}ag.physicalID=(ac.station)?this.session.processID:ac.mcsJobID;if(Object.keys(v).length===0){this.refresh({onComplete:af,onFailure:af,refreshServers:true})}else{this.$.fileMonitor.getFileMonitor(ag)}};q=function(ab,af,Y,Z){var ae=function(ah){var ag=ah;if(typeof ag==="string"){ag=JSON.parse(ag)}N.call(this,ab,af,ag);Y(ab,af)}.bind(this),ac=function(ag){var ah=k.unspecified;if(S.SMAProcSP.SPCOSFileMonitor.ERRORS.credentialsNotSupplied===ag.error){ah=k.userCanceled}else{if(S.SMAProcSP.SPCOSFileMonitor.ERRORS.filemonURLNotFound===ag.error){ah=k.directoryAccessHost}else{if(S.SMAProcSP.SPCOSFileMonitor.ERRORS.filemonJobUserStationMismatch===ag.error){ah=k.userStationMismatch}else{if(S.SMAProcSP.SPCOSFileMonitor.ERRORS.execDirContentNotFound===ag.error){ah=k.itemNotFound}else{if(S.SMAProcSP.SPCOSFileMonitor.ERRORS.transientMonitorFinished===ag.error){ah=k.transientMonitorFinished}else{if(ag.cause===u){ah=k.itemNotFound}else{if(ag.cause===z){ah=k.notAuthorized}else{ah=k.possibleMixedContent}}}}}}}Z({execDir:ab,errorCode:ah})}.bind(this),aa={execDir:ab,onComplete:ae,onFailure:ac},ad;if(!ab.serverID){ad=this.getServerForStation(ab.station);ab.serverID=ad?ad.id:null}if(af&&typeof af.relativePath!=="undefined"&&af.relativePath){aa.subdirPath=af.relativePath}aa.physicalID=(ab.station)?this.session.processID:ab.mcsJobID;this.$.fileMonitor.ls(aa)};I=function(af,ae,Z,Y,ab,ag){var ac=function(aj){var ai=aj;if(typeof ai==="string"){ai=JSON.parse(ai)}ab(ai)}.bind(this),aa=function(ai){var aj=k.unspecified;if(S.SMAProcSP.SPCOSFileMonitor.ERRORS.credentialsNotSupplied===ai.error){aj=k.userCanceled}else{if(S.SMAProcSP.SPCOSFileMonitor.ERRORS.filemonURLNotFound===ai.error){aj=k.directoryAccessHost}else{if(S.SMAProcSP.SPCOSFileMonitor.ERRORS.filemonJobUserStationMismatch===ai.error){aj=k.userStationMismatch}else{if(S.SMAProcSP.SPCOSFileMonitor.ERRORS.execDirContentNotFound===ai.error){aj=k.itemNotFound}else{if(S.SMAProcSP.SPCOSFileMonitor.ERRORS.transientMonitorFinished===ai.error){aj=k.transientMonitorFinished}else{if(ai.cause===u){aj=k.itemNotFound}else{if(ai.cause===z){aj=k.notAuthorized}else{aj=k.possibleMixedContent}}}}}}}ag({execDir:af,errorCode:aj})}.bind(this),ah={execDir:af,filePath:ae,start:Z,numLines:Y,onComplete:ac,onFailure:aa},ad;if(!af.serverID){ad=this.getServerForStation(af.station);af.serverID=ad?ad.id:null}ah.physicalID=(af.station)?this.session.processID:af.mcsJobID;this.$.fileMonitor.tail(ah)};Q=function(Z,Y){return((Y.station.toLowerCase()===Z.name.toLowerCase())||(Y.station.toLowerCase()===Z.queryName.toLowerCase()))};W=function(Z){var ap=0,Y=0,ac=0,at=false,ag=[],ah=0,am=(Z.refreshServers!==null)?Z.refreshServers:true,an=((typeof Z.specificServer!=="undefined")&&Z.specificServer)?Z.specificServer:null,ai=(am||Z.refreshStations)?true:false,ao=(am||Z.refreshPrivateStations)?true:false,af=(am||Z.refreshRunAs)?true:false,au=function(av){if(at&&(ac===ap)&&(Y===ap)){window.clearTimeout(av);if((ag.length===0)&&Z&&Z.onComplete){Z.onComplete()}else{if(Z&&Z.onFailure){Z.onFailure(ag)}}g=true;x=false}},ae=function(av){at=true;au.call(this,av)},aq=function(aw,av){at=true;ag.push(av);au.call(this,aw)},al=function(av){ac++;au.call(this,av)},ad=function(aw,av){ac++;ag.push(av);au.call(this,aw)},ar=function(av){Y++;au.call(this,av)},aj=function(aw,av){Y++;ag.push(av);au.call(this,aw)},ak=function(av,aw){ap=aw.length;X.call(this,{refreshPrivateStations:ao,onComplete:ae.bind(this,av),onFailure:aq.bind(this,av)});aw.forEach(function(ax){this.getStations({serverId:ax.id,refresh:ai,refreshPrivateStations:ao,onComplete:al.bind(this,av),onFailure:ad.bind(this,av)});this.getRunAsEnabled({serverId:ax.id,refresh:af,onComplete:ar.bind(this,av),onFailure:aj.bind(this,av)})}.bind(this))},aa=function(aw,av){window.clearTimeout(aw);if(Z&&Z.onFailure){Z.onFailure(av)}},ab=function(av){if(!x){if(av&&av.onComplete){av.onComplete()}}else{window.setTimeout(ab.bind(this,av),200)}};if(!x){x=true;ah=window.setTimeout(function(){x=false;if((ag.length===0)&&Z&&Z.onComplete){Z.onComplete()}else{if(Z&&Z.onFailure){Z.onFailure(ag)}}}.bind(this),L);if(!an){this.getServers({onComplete:ak.bind(this,ah),onFailure:aa.bind(this,ah),refresh:am})}else{ak.call(this,ah,[an])}}else{window.setTimeout(ab.bind(this,Z),200)}};H=function(){return g};J=function(Y){g=Y};D=function(Y){this.$.fileMonitor.credentialsFunction=Y};l=function(Y){this.set("globals."+Y.detail.name,Y.detail.value)};S.SMAProcADUI=S.SMAProcADUI||{};S.SMAProcADUI.ADStationManager=O({is:"ad-station-manager",properties:{globals:{type:Object,value:function(){return{}}},session:{type:Object,value:null,observer:"sessionChanged"}},ready:function(){return d.apply(this,arguments)},onVariableValueChange:function(){return l.apply(this,arguments)},getServers:function(){return U.apply(this,arguments)},getStations:function(){return C.apply(this,arguments)},getExecDirs:function(){return t.apply(this,arguments)},getServer:function(){return i.apply(this,arguments)},getServersForStation:function(){return G.apply(this,arguments)},getServerForStation:function(){return a.apply(this,arguments)},getInitialServer:function(){return w.apply(this,arguments)},getDefaultServer:function(){return M.apply(this,arguments)},setDefaultServer:function(){return s.apply(this,arguments)},getStation:function(){return b.apply(this,arguments)},isALinuxStation:function(){return f.apply(this,arguments)},getLocalStation:function(){return o.apply(this,arguments)},getExecDirByName:function(){return B.apply(this,arguments)},getExecDirByPath:function(){return c.apply(this,arguments)},getRunAsEnabled:function(){return P.apply(this,arguments)},addExecDir:function(){return n.apply(this,arguments)},requestExecDirAccess:function(){return e.apply(this,arguments)},requestExecDirContents:function(){return q.apply(this,arguments)},tailExecDirFile:function(){return I.apply(this,arguments)},stationSupportsExecDir:function(){return Q.apply(this,arguments)},refresh:function(){return W.apply(this,arguments)},hasRefreshed:function(){return H.apply(this,arguments)},setHasRefreshed:function(){return J.apply(this,arguments)},setCredentialsFunction:function(){return D.apply(this,arguments)},sessionChanged:function(){if(this.session&&!this.hasRefreshed()){this.refresh({refreshServers:true})}},behaviors:[S.SMAProcSP.SPBase],});S.SMAProcADUI.ADStationManager.ERRORS=S.SMAProcADUI.ADStationManager.ERRORS||k;S.SMAProcADUI.ADStationManager.EVENTS=S.SMAProcADUI.ADStationManager.EVENTS||m});