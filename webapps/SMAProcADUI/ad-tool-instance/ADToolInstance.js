/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
window.define(["DS/SMAProcADUI/ad-util/ADObservable","DS/SMAProcADUI/ad-station/ADStation"],function(j,p){var B={};var a="__AdHoc__rule__";var q={noFiles:"noFiles",defaultFiles:"defaultFiles"},d={fiper:"fiper",cloud:"Cloud"},A={appMessage:"appmessage"},g={credits:"CREDIT",tokens:"DSLS"},z={credits:"credits",tokens:"tokens",traditionalTokens:"tradTokens"};var u=function(){this._activity={};this._updateObject=null;this.session=null;this.server=null;this.stationManager=null;this.toolManager=null;this.icon="";this.toolType="";this.toolDefID="";this.editorID="";this.configuration=null;this.credentials={enabled:false,windowsUser:null,windowsPass:null,domainName:null,linuxUser:null,linuxPass:null};this.waitingForWorkDir=null;this.isRunnable=true;this._name="";Object.defineProperty(this,"name",{get:function(){return this._name},set:function(C){if(this._name!==C){this._name=C;this._activity.attributes.title=C;t.call(this);if(this._updateObject){this._updateObject.update()}this.notifyObservers("name")}}});this._description="";Object.defineProperty(this,"description",{get:function(){return this._description},set:function(C){if(this._description!==C){this._description=C;this._activity.attributes.description=C;t.call(this);if(this._updateObject){this._updateObject.update()}this.notifyObservers("description")}}});this._station=null;Object.defineProperty(this,"station",{get:function(){return this._station},set:function(C){if(this._station!==C){this._station=C;if(this.station){this.credentials.enabled=this.station.runAsEnabled}i.call(this);if(this._updateObject){this._updateObject.update()}this.notifyObservers("station")}}});this._workDir=null;Object.defineProperty(this,"workDir",{get:function(){return this._workDir},set:function(C){if((!this._workDir&&C)||(this._workDir&&!C)||(this._workDir&&C&&((this._workDir.path!==C.path)||(this._workDir.station!==C.station)))){this._workDir=C;if(this._workDir&&this._workDir.credentials){this.credentials.enabled=true;this.credentials.windowsUser=this._workDir.credentials.windowsUser;this.credentials.windowsPass=this._workDir.credentials.windowsPass;this.credentials.domainName=this._workDir.credentials.domainName;this.credentials.linuxUser=this._workDir.credentials.linuxUser;this.credentials.linuxPass=this._workDir.credentials.linuxPass}else{this.credentials.enabled=false;this.credentials.windowsUser=null;this.credentials.windowsPass=null;this.credentials.domainName=null;this.credentials.linuxUser=null;this.credentials.linuxPass=null}i.call(this);if(this._updateObject){this._updateObject.update()}this.notifyObservers("workDir")}this.waitingForWorkDir=null}});this._removeWorkDir=false;Object.defineProperty(this,"removeWorkDir",{get:function(){return this._removeWorkDir},set:function(C){if(this._removeWorkDir!==C){this._removeWorkDir=C;i.call(this);if(this._updateObject){this._updateObject.update()}this.notifyObservers("removeWorkDir")}}});this._inputObjects=null;Object.defineProperty(this,"inputObjects",{get:function(){return this._inputObjects}});this._outputOption=q.defaultFiles;Object.defineProperty(this,"outputOption",{get:function(){return this._outputOption},set:function(C){if(this._outputOption!==C){this._outputOption=C;n.call(this);if(this._updateObject){this._updateObject.update()}this.notifyObservers("outputOption")}}});this._outputFileSpecs=null;Object.defineProperty(this,"outputFileSpecs",{get:function(){return this._outputFileSpecs},set:function(C){this._outputFileSpecs=C;k.call(this);if(this._updateObject){this._updateObject.update()}this.notifyObservers("outputFileSpecs")}});Object.defineProperty(this,"configurationProperties",{get:function(){return(this.configuration)?this.configuration.getConfigurationProperties():null},set:function(C){if(this.configuration){this.configuration.configurationProperties=C;t.call(this)}if(this._updateObject){this._updateObject.update()}}});this._hasPredefinedRules=false;Object.defineProperty(this,"hasPredefinedRules",{get:function(){return this._hasPredefinedRules}});this._supportsDownload=false;Object.defineProperty(this,"supportsDownload",{get:function(){return this._supportsDownload}});this._supportsUpload=false;Object.defineProperty(this,"supportsUpload",{get:function(){return this._supportsUpload}});Object.defineProperty(this,"modelID",{get:function(){return(this._activity)?this._activity.id:""}});j.makeObservable(this)};B.ADToolInstance=u;u.OUTPUTOPTIONS=q;u.DRMMODE=d;u.prototype.load=function(E,C){var D;this._activity=E;this._updateObject=C;v.call(this);if(this.session&&this.session.onCloud){o.call(this)}D=r.call(this);if(D&&D.properties&&!D.properties.drmMode){i.call(this)}};u.prototype.addInputObject=function(E){var C,D=false;if(E){for(C=0;C<this.inputObjects.length;C++){if(this._inputObjects[C].id===E.id&&this._inputObjects[C].name===E.name){D=true;break}}if(!D){y.call(this,E);this._inputObjects.push(E);if(this._updateObject){this._updateObject.update()}this.notifyObservers("inputObjects")}}};u.prototype.removeInputObject=function(E){var D,C=-1;if(E){for(D=0;D<this._inputObjects.length;D++){if(E.type!=="fileversion"){if(this._inputObjects[D].id===E.id&&this._inputObjects[D].name===E.name){C=D;break}}else{if(this._inputObjects[D].id===E.id&&this._inputObjects[D].name===E.name&&this._inputObjects[D].details.version===E.details.version){C=D;break}}}if(C>=0){this._inputObjects.splice(C,1);s.call(this,E);if(this._updateObject){this._updateObject.update()}this.notifyObservers("inputObjects")}}};u.prototype.removeAllInputObjects=function(){var C;if(this._inputObjects.length>0){for(C=0;C<this._inputObjects.length;C++){s.call(this,this._inputObjects[C])}if(this._updateObject){this._updateObject.update()}this.notifyObservers("inputObjects")}};u.prototype.setOnPremiseExecConfig=function(){if(this.station===p.ADStation.CLOUDSTATIONNAME){this.station=null}i.call(this)};u.prototype.setCloudExecutionConfig=function(D,C){var F,E;F={drmMode:d.cloud,CloudConfig:{os:D,numprocs:C.toString()},keepdirtype:"0",monitorFiles:true};if(this.station===null||this.station===p.ADStation.LOCALSTATIONNAME||this.station===p.ADStation.CLOUDSTATIONNAME){F.affinities={Host:p.ADStation.CLOUDSTATIONNAME};this.station=p.ADStation.CLOUDSTATIONNAME}x.call(this,null);E=r.call(this);if(E){E.properties=F}if(this.session.onCloud){this.configuration.setCommandLineforCloud(F)}t.call(this);if(this._updateObject){this._updateObject.update()}};u.prototype.setCommandLineforCloud=function(){var C;C=r.call(this);if(C){this.configuration.setCommandLineforCloud(C.properties)}};u.prototype.getEnvSettingsProperty=function(){return this.configuration.getEnvSettingsProperty()};u.prototype.setEnvSettingsProperty=function(C,I,E,G,F){var D;if(C===z.tokens){D=g.tokens}else{D=g.credits}var H=[{"0":"SMA_ABQSTUDY=1"},{"1":"ABQLMIMPL="+D},{"2":"ABQCUSTID="+I},{"3":"SMA_MAXCPUS="+((E>=4)?E:4)},{"4":"ABQ_USERUVM_PVM="+G},{"5":"ABQDSLSSERVER="+F}];if(C===z.traditionalTokens||C===null){this.configuration.setEnvSettingsProperty(null)}else{this.configuration.setEnvSettingsProperty(H)}};u.prototype.getExecutionConfig=function(){var C=r.call(this);return C};u.prototype.isOnCloud=function(){return this.getExecutionConfig().properties.drmMode===d.cloud};u.prototype.getActivityConfig=function(){return e.call(this)};u.prototype.setActivityConfig=function(C){this.configuration.setActivityConfig(C)};var v=function(){var E,D;this.toolDefID="";this.editorID="";this._name="";this._description="";this._station=null;this._workDir=null;this._removeWorkDir=false;this._inputObjects=[];this._outputOption=q.defaultFiles;if(this._activity){this._name=this._activity.attributes.title;this._description=this._activity.attributes.description?this._activity.attributes.description:"";E=r.call(this);if(E){if(typeof E.properties!=="undefined"&&E.properties){this._removeWorkDir=E.properties.keepdirtype==="2"?false:true;if(typeof E.properties.affinities!=="undefined"&&E.properties.affinities){if(typeof E.properties.affinities.Host!=="undefined"){this._station=E.properties.affinities.Host}if(typeof E.properties.workingdir!=="undefined"&&E.properties.workingdir&&this.stationManager){this._workDir=this.stationManager.getExecDirByPath(E.properties.workingdir);if(this.workDir&&this.workDir.credentials){this.credentials.enabled=true;this.credentials.windowsUser=this.workDir.credentials.windowsUser;this.credentials.windowsPass=this.workDir.credentials.windowsPass;this.credentials.domainName=this.workDir.credentials.domainName;this.credentials.linuxUser=this.workDir.credentials.linuxUser;this.credentials.linuxPass=this.workDir.credentials.linuxPass}else{this.credentials.enabled=false;this.credentials.windowsUser=null;this.credentials.windowsPass=null;this.credentials.domainName=null;this.credentials.linuxUser=null;this.credentials.linuxPass=null}}}}}if(this.configuration){this.configuration.load(this._activity,this._updateObject)}D=f.call(this);if(D){this._supportsDownload=true;this._inputObjects=b.call(this,D)}D=m.call(this);if(D){this._supportsUpload=true;if(typeof D.FlowItem.ExecutionConfig!=="undefined"&&D.FlowItem.ExecutionConfig.isExecutable==="false"){this._outputOption=q.noFiles}this._outputFileSpecs=c(D);var C=w(D.FlowItem.stepConfig.properties.rules);if(C.length>0){l.call(this,true)}}}};var h=function(){var C=[];if(this._activity){if(typeof this._activity.attributes!=="undefined"&&typeof this._activity.attributes.definition!=="undefined"&&typeof this._activity.attributes.definition.flowItem!=="undefined"&&typeof this._activity.attributes.definition.flowItem.implementations!=="undefined"&&this._activity.attributes.definition.flowItem.implementations.length>0&&typeof this._activity.attributes.definition.flowItem.implementations[0].children!=="undefined"){C=this._activity.attributes.definition.flowItem.implementations[0].children}}return C};var f=function(){var C=h.call(this),E=null,D;for(D=0;D<C.length;D++){if(C[D].FlowItem.stepConfig.extensionName===this.toolManager.EXTENSIONTYPES.download){E=C[D];break}}return E};var m=function(){var C=h.call(this),E=null,D;for(D=C.length-1;D>=0;D--){if(C[D].FlowItem.stepConfig.extensionName===this.toolManager.EXTENSIONTYPES.upload){E=C[D];break}}return E};var r=function(){var C=null;if(this._activity){if(typeof this._activity.attributes!=="undefined"&&typeof this._activity.attributes.definition!=="undefined"&&typeof this._activity.attributes.definition.flowItem!=="undefined"){C=this._activity.attributes.definition.flowItem.ExecutionConfig}}return C};var o=function(){var C,F,E,D,H,G;if(window.widget){C=window.widget.getValue("tenantId");F=window.widget.getValue("myAppsUrl")}if(C&&F){E={datarecords:{datagroups:[],name:""},name:""};E.name="SMA_Parameter";E.datarecords.name="SMA_Parameter";E.datarecords.datagroups=[{updateAction:"CREATE",objectId:this.modelID,dataelements:{type:{value:[{value:"string"}]},name:{value:[{value:"MX_ONLINE_INSTANCE"}]},mode:{value:[{value:"input"}]},valuetype:{value:[{value:"single"}]},Value:{value:[{value:C}]}}},{updateAction:"CREATE",objectId:this.modelID,dataelements:{type:{value:[{value:"string"}]},name:{value:[{value:"MyAppsUrl"}]},mode:{value:[{value:"input"}]},valuetype:{value:[{value:"single"}]},Value:{value:[{value:F}]}}}];H=function(){};G=function(){this.fire(A.appMessage,{level:"error",category:"parameterSetFailMsg",message:"Unable to set required parameters for creating lightweight visualization data."})};D={onComplete:H,onFailure:G};this.session.set3DXParameters(this.modelID,E,H,G)}};var e=function(){var C=null;if(this._activity){if(typeof this._activity.attributes!=="undefined"&&typeof this._activity.attributes.definition!=="undefined"&&typeof this._activity.attributes.definition.flowItem!=="undefined"){C=this._activity.attributes.definition.flowItem.ActivityConfig}}return C};var b=function(D){var C=[],F,G,E,H;if(D&&(typeof D.FlowItem.stepConfig!=="undefined"&&D.FlowItem.stepConfig)&&(typeof D.FlowItem.stepConfig.properties!=="undefined"&&D.FlowItem.stepConfig.properties)&&(typeof D.FlowItem.stepConfig.properties.rules!=="undefined"&&D.FlowItem.stepConfig.properties.rules)){for(F=0;F<D.FlowItem.stepConfig.properties.rules.length;F++){G=D.FlowItem.stepConfig.properties.rules[F];if(G.name&&(typeof G.referenceId!=="undefined"&&G.referenceId)){E=G.name.indexOf(a)<0;if(G.type==="file"&&G.hasOwnProperty("sourceFileVersion")&&G.sourceFileVersion){H={id:G.referenceId,name:G.sourceFileName,description:"",size:null,type:"fileversion",lastModified:"",isActivityContent:E,details:{version:G.sourceFileVersion}}}else{if(G.type==="file"){H={id:G.referenceId,name:G.sourceFileName,description:"",size:null,type:"file",lastModified:"",isActivityContent:E,details:{}}}else{if(G.type==="Simulation Folder"){H={id:G.referenceId,name:G.title,description:"",type:"folder",lastModified:"",isActivityContent:E}}else{H={id:G.referenceId,name:G.title,description:"",type:"document",lastModified:"",isActivityContent:E,details:{versioned:true}};if(("Simulation Document - Versioned"!==G.type)&&("Document"!==G.type)){H.details.versioned=false}}}}C.push(H)}}}return C};var c=function(E){var C=[],D,F;if(E&&(typeof E.FlowItem.stepConfig!=="undefined"&&E.FlowItem.stepConfig)&&(typeof E.FlowItem.stepConfig.properties!=="undefined"&&E.FlowItem.stepConfig.properties)&&(typeof E.FlowItem.stepConfig.properties.rules!=="undefined"&&E.FlowItem.stepConfig.properties.rules)){for(D=0;D<E.FlowItem.stepConfig.properties.rules.length;D++){F=E.FlowItem.stepConfig.properties.rules[D];if(typeof F.sourceFileName!=="undefined"&&F.sourceFileName&&(F.sourceFileName.length>0)&&typeof F.enabled!=="undefined"&&F.enabled&&(F.enabled.toLowerCase()==="true")){if(F.name.indexOf("__AdHoc__rule")>-1){C.push(F.sourceFileName)}}}}return C};var x=function(F){var C=h.call(this),D,E;for(D=0;D<C.length;D++){E=C[D];if(typeof E.FlowItem==="undefined"){E.FlowItem={ExecutionConfig:{workingdir:F?F.path:null}}}else{if(typeof E.FlowItem.ExecutionConfig==="undefined"){E.FlowItem.ExecutionConfig={workingdir:F?F.path:null}}else{E.FlowItem.ExecutionConfig.workingdir=F?F.path:null}}}t.call(this)};var y=function(G){var C,D=[],E,F;if(G){C=f.call(this);if(C){if(typeof C.FlowItem.stepConfig.properties==="undefined"||!C.FlowItem.stepConfig.properties){C.FlowItem.stepConfig.properties={rules:[]}}if(typeof C.FlowItem.stepConfig.properties.rules==="undefined"||!C.FlowItem.stepConfig.properties.rules){C.FlowItem.stepConfig.properties.rules=[]}for(E=0;E<C.FlowItem.stepConfig.properties.rules.length;E++){D.push(C.FlowItem.stepConfig.properties.rules[E])}F={id:"",values:[],name:a,referenceId:(G.id)&&(G.id!=="")?G.id:G.modelID,type:G.mdType};F.title=G.name;if(G.type==="file"){F.sourceFileName=G.name}else{if(G.type==="fileversion"){F.sourceFileName=G.name;F.sourceFileVersion=G.details.version;F.type="file"}else{if((G.type==="document")||(G.type==="folder")){F.sourceFileName="*"}}}D.push(F);for(E=1;E<=D.length;E++){D[E-1].id=""+E;if(D[E-1].name.indexOf(a)===0){D[E-1].name=a+E}}C.FlowItem.stepConfig.properties.rules=D}}t.call(this)};var s=function(H){var D,F=[],G,E,C=false;if(H){D=f.call(this);if(D){if(typeof D.FlowItem.stepConfig.properties==="undefined"||!D.FlowItem.stepConfig.properties){D.FlowItem.stepConfig.properties={rules:[]}}for(G=0;G<D.FlowItem.stepConfig.properties.rules.length;G++){E=D.FlowItem.stepConfig.properties.rules[G];C=false;if(H.type==="file"&&E.title===H.name&&E.sourceFileName===H.name){C=true}else{if(H.type==="document"&&E.title===H.name&&E.sourceFileName==="*"){C=true}else{if(H.type==="folder"&&E.title===H.name&&E.sourceFileName==="*"){C=true}else{if(H.type==="fileversion"&&E.title===H.name&&E.sourceFileName===H.name){C=true}}}}if(!C){F.push(E)}}D.FlowItem.stepConfig.properties.rules=F}}t.call(this)};var i=function(){var D,C;D={drmMode:d.fiper,affinities:{Host:this.station},workingdir:this.workDir?this.workDir.path:null,keepdirtype:this.removeWorkDir?"0":"2",monitorFiles:false};C=r.call(this);if(C){C.properties=D}x.call(this,this.workDir);t.call(this)};var n=function(){var D=m.call(this),C="true";if(this.outputOption===q.noFiles){C="false"}if(D){if(typeof D.FlowItem.ExecutionConfig==="undefined"){D.FlowItem.ExecutionConfig={isExecutable:C}}else{D.FlowItem.ExecutionConfig.isExecutable=C}}t.call(this)};var k=function(){var F=m.call(this),D=[],E,G,C=null;if(F){if(typeof F.FlowItem.stepConfig.properties==="undefined"||!F.FlowItem.stepConfig.properties){F.FlowItem.stepConfig.properties={rules:[]}}C=w(F.FlowItem.stepConfig.properties.rules);if(this.outputFileSpecs.length>0){for(E=0;E<this.outputFileSpecs.length;E++){G={id:"",name:"",referenceId:null,sourceFileName:this.outputFileSpecs[E],title:null,type:"Simulation Document - Versioned"};D.push(G)}for(E=1;E<=D.length;E++){var H=C.length+E;D[E-1].id=""+H;D[E-1].name=a+H}}F.FlowItem.stepConfig.properties.rules=C.concat(D);if(C.length>0||D.length>0){F.FlowItem.ExecutionConfig.isExecutable="true"}}t.call(this)};var t=function(){var C=h.call(this),D,E;for(D=0;D<C.length;D++){E=C[D];if(typeof E.FlowItem.ExecutionConfig==="undefined"||!E.FlowItem.ExecutionConfig){E.FlowItem.ExecutionConfig={isExecutable:"true"}}else{if(typeof E.FlowItem.ExecutionConfig.isExecutable==="undefined"){E.FlowItem.ExecutionConfig.isExecutable="true"}}}};var w=function(E){var C=[];for(var D=0;D<E.length;D++){if(E[D].name.indexOf("__AdHoc__rule")===-1){C.push(E[D])}}return C};var l=function(C){if(C){this.hasPredefinedRules=true}};return B});