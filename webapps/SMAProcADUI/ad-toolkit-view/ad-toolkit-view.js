/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
window.require(["DS/SMAProcADUI/ad-execdir/ADExecDir"],function(G){var N=window.Polymer,O=window.DS;var T=null,v=null,B=null,f=null,J=null,t=null,y=null,u=null,F=null,r=null,l=null,K=null,a=null,d=null,o=null,p=null,V=null,i=null,I=null,m=null,x=null,D=null,b=null,L=null,k=null,h=null,C=null,Q=null,q=null,z=null,U=null,A=null,e=null,c=null,M=null,S=null,s=null,E="3DXABQ",H="Toolkit",P="jobStart",g="execDirInit",w="toolkitDataFlush",n={appMessage:"appmessage",jobStarting:"jobstarting",jobStarted:"jobstarted"},j={disabled:"disabled"},R=null;T=function(){if(this.session){this.session.toolManager=this.$.toolManager;this.session.addEventListener(O.SMAProcADUI.ADSession.EVENTS.toolsLoaded,B.bind(this));this.session.addEventListener(O.SMAProcADUI.ADSession.EVENTS.error,v.bind(this));this.session.initTools(true)}};v=function(W){if(O.SMAProcADUI.ADSession.ERRORS.toolDeleteError===W.detail.error){B.call(this);var X="Couldn't remove tool(s)";if(typeof W.detail.message!=="undefined"&&W.detail.message&&W.detail.message.length>0){X+=": "+W.detail.message}else{X+=": Unspecified Web Service error"}this.fire(n.appMessage,{level:"error",message:X})}};B=function(){this.$.toolPanel.removeAllItems();var W=false;if(this.session.tools&&this.session.tools.length>0){this.session.tools.forEach(function(Y){if(!Y.description||(Y.description.length===0)){if(this._pendingDescriptions&&this._pendingDescriptions[Y.name]){Y.description=this._pendingDescriptions[Y.name]}}var Z=this.$.toolPanel.createItem("ad-multiview-tool-instance");Z.viewState=O.SMAProcADUI.ADMultiviewItem.VIEWSTATE.ready;Z.model=Y;Z.modelSource=H;if(this.selectedToolIds&&this.selectedToolIds.length===1){for(var X=0;X<this.selectedToolIds.length;X++){if(this.selectedToolIds[X]===Z.model.modelID){Z.selected=true;W=true}else{W=false}}}this.$.toolPanel.addItem(Z,"",W);y.call(this,Y)}.bind(this))}this.isLoading=false;J.call(this)};f=function(){if(this.$.uiMode.getValue()===E){this.DOM(this.$.addToolsWrapper).addClass("hidden")}else{this.DOM(this.$.addToolsWrapper).removeClass("hidden")}var W=this.$.toolPanel.selections.length;if(W===0){this.DOM(this.$.removeTool).addClass(j.disabled);this.DOM(this.$.runTool).addClass(j.disabled);this.DOM(this.$.configureTool).addClass(j.disabled)}else{if(W===1){this.DOM(this.$.removeTool).removeClass(j.disabled);this.DOM(this.$.runTool).removeClass(j.disabled);this.DOM(this.$.configureTool).removeClass(j.disabled)}else{this.DOM(this.$.removeTool).removeClass(j.disabled);this.DOM(this.$.runTool).addClass(j.disabled);this.DOM(this.$.configureTool).removeClass(j.disabled)}}if(this.viewMode===O.SMAProcADUI.ADMultiviewPanel.VIEWMODE.icon){this.DOM(this.$.viewIcons).addClass(j.disabled);this.DOM(this.$.viewList).removeClass(j.disabled)}else{if(this.viewMode===O.SMAProcADUI.ADMultiviewPanel.VIEWMODE.list){this.DOM(this.$.viewIcons).removeClass(j.disabled);this.DOM(this.$.viewList).addClass(j.disabled)}}};J=function(){var W=this.$.toolPanel.getItems();if(this.isLoading){if(!this.loadingSpinner){require(["DS/UIKIT/Spinner"],function(X){this.loadingSpinner=new X({renderTo:this.$.loadingRow,visible:true});this.loadingSpinner.spin();this.loadingSpinner.show();this.DOM(this.$.loadingRow).removeClass("hidden");this.DOM(this.$.contentRow).addClass("hidden");this.DOM(this.$.placeholderRow).addClass("hidden")}.bind(this))}else{this.loadingSpinner.spin();this.loadingSpinner.show();this.DOM(this.$.loadingRow).removeClass("hidden");this.DOM(this.$.contentRow).addClass("hidden");this.DOM(this.$.placeholderRow).addClass("hidden")}}else{if(this.loadingSpinner){this.loadingSpinner.hide();this.loadingSpinner.stop();this.DOM(this.$.loadingRow).addClass("hidden")}if(!W||W.length===0){this.DOM(this.$.contentRow).addClass("hidden");this.DOM(this.$.placeholderRow).removeClass("hidden")}else{this.DOM(this.$.contentRow).removeClass("hidden");this.DOM(this.$.placeholderRow).addClass("hidden")}}};t=function(W){var Z=W,aa="";var Y=this._toolNameMap[Z];if(!Y){Y=[];this._toolNameMap[Z]=Y;Y.push(true)}else{var X;for(X=0;X<Y.length;X++){if(!Y[X]){if(X>0){aa=" ("+X+")"}Y[X]=true;break}}if(X===Y.length){Y.push(true);aa=" ("+X+")"}}Z=Z+aa;return Z};y=function(Y){var aa=Y.name,X=Y.name,W="0",ab=/\x28[0-9]+\x29$/;if(ab.test(aa.trim())){var ac=aa.lastIndexOf("(");X=aa.substring(0,ac).trim();W=aa.substring(ac).trim();W=W.substring(1,W.length-1)}else{X=aa;W="0"}var Z=this._toolNameMap[X];if(!Z){Z=[];this._toolNameMap[X]=Z}Z[W]=true};u=function(Y){var aa=Y.name,X=Y.name,W="0",ab=/\x28[0-9]+\x29$/;if(ab.test(aa.trim())){var ac=aa.lastIndexOf("(");X=aa.substring(0,ac).trim();W=aa.substring(ac).trim();W=W.substring(1,W.length-1)}else{X=aa;W="0"}var Z=this._toolNameMap[X];if(Z&&Z.length>0){Z[W]=false}};F=function(aa){var Z,Y=[],X,W;while(aa.length>0){Z=aa.pop();W=Z.model;this.$.toolPanel.removeItem(Z);u.call(this,W);Y.push(W)}this.session.removeTools(Y);X=a.call(this);X.tools=r.call(this);J.call(this)};r=function(){var W=[],X;if(this.$.toolPanel&&this.$.toolPanel.selections){for(X=0;X<this.$.toolPanel.selections.length;X++){if(this.$.toolPanel.selections[X]){W.push(this.$.toolPanel.selections[X].model)}}}return W};l=function(Z){var Y,X=new Date(),W,aa;if(Z.workDir&&Z.workDir.path&&Z.workDir.path.length>0){Y=Z.workDir;Y.lastModified=X.toJSON();Y.removeAfterJob=Z.removeWorkDir}else{Y=new G.ADExecDir();Y.name=Z.name+" "+X.toLocaleString().replace(/\u200E/g,"").replace(/\u200F/g,"");if(Z.isOnCloud()){Y.station=null;Y.removeAfterJob=true}else{Y.station=Z.station;Y.removeAfterJob=Z.removeWorkDir}Y.serverID=Z.server;Y.lastModified=X.toJSON();Y.accessDisabled=true;Y.creating=true;Z.waitingForWorkDir=Y;this.$.stationManager.addExecDir(Y)}if(Y.removeAfterJob){for(aa=0;aa<this.session.tools.length;aa++){if(this.session.tools[aa].workDir===Y){this.session.tools[aa].workDir=null}}}W=a.call(this);if(W){W.refresh()}this.fire(n.jobStarting,{});this.fire(n.appMessage,{level:"info",message:"Starting new job for <strong>"+Z.name+"</strong>",category:P});this.$.toolRunner.runTool(Z,Y)};K=function(X,W){return X.model.name.localeCompare(W.model.name)};a=function(){var X,W=this.DOM(this.$.toolConfigView).find("ad-tool-config-panel").elements();if(W.length===0){X=new O.SMAProcADUI.ADToolConfigPanel();this.DOM(this.$.toolConfigView).append(X)}else{X=W[0]}return X};d=function(){this.isLoading=true;J.call(this);this.session.loadTools(true)};o=function(aa,W){if(aa){var Y,Z=this.$.toolPanel.getItems(),X=null;for(Y=0;Y<Z.length;Y++){if(Z[Y].model.name===aa){X=Z[Y];break}}if(X){this.$.toolPanel.removeItem(X)}}var ab="Couldn't create tool "+aa+": ";if(W){ab+=W}else{ab+="Unspecified Web Service error"}this.fire(n.appMessage,{level:"error",message:ab})};p=function(){this._toolAddDlg.showDialog();this._toolAddDlg.showOk=false;if(this.session.hasPendingUpdates()){this.fire(n.appMessage,{level:"info",message:"Saving pending data changes...",category:w});var X=function(Y,Z){if(Z){this._toolAddDlg.showOk=true}}.bind(this);var W=function(){this.fire(n.appMessage,{level:"error",message:"Couldn't save pending data changes",category:w});this._toolAddDlg.showOk=true}.bind(this);this.session.flushPendingUpdates(X,W)}else{this._toolAddDlg.showOk=true}};V=function(){if(!this.$.inDash.getValue()){if(this.session.hasPendingUpdates()){this.fire(n.appMessage,{level:"info",message:"Saving pending data changes...",category:w});var X=function(Y,Z){if(Z){this._toolRunDlg.showDialog()}}.bind(this);var W=function(){this.fire(n.appMessage,{level:"error",message:"Couldn't save pending data changes",category:w})}.bind(this);this.session.flushPendingUpdates(X,W)}else{this._toolRunDlg.showDialog()}}else{this._toolRunDlg.showDialog()}};i=function(){this._toolNameMap={};this.$.toolPanel.sortFunction=K;f.call(this);J.call(this);console.log("Ad-hoc Toolkit View ready")};I=function(){this.async(function(){var W=localStorage["SMAProcAdhoc.preferences.toolsViewMode"];if(W&&W.length>0){this.viewMode=W}f.call(this)})};m=function(){f.call(this)};x=function(){if(!N.dom(this.$.viewIcons).classList.contains(j.disabled)){this.viewMode=O.SMAProcADUI.ADMultiviewPanel.VIEWMODE.icon;localStorage["SMAProcAdhoc.preferences.toolsViewMode"]=O.SMAProcADUI.ADMultiviewPanel.VIEWMODE.icon;f.call(this)}};D=function(){if(!N.dom(this.$.viewList).classList.contains(j.disabled)){this.viewMode=O.SMAProcADUI.ADMultiviewPanel.VIEWMODE.list;localStorage["SMAProcAdhoc.preferences.toolsViewMode"]=O.SMAProcADUI.ADMultiviewPanel.VIEWMODE.list;f.call(this)}};b=function(X){this.$.toolPanel.selections=[];var W=a.call(this);W.tools=r.call(this);f.call(this);X.stopPropagation();X.cancelBubble=true};L=function(){var W=a.call(this);W.tools=r.call(this);f.call(this)};k=function(){if(this.$.access.write){if(!this.$.toolConfigView.isOpen()){Q.call(this)}else{var W=a.call(this);W.tools=r.call(this)}}};h=function(){if(!this._toolAddDlg){this._toolAddDlg=new O.SMAProcADUI.ADToolAddDialog();this._toolAddDlg.viewMode=this.viewMode;this._toolAddDlg.addEventListener("accept",C.bind(this),false);N.dom(document.body).appendChild(this._toolAddDlg)}p.call(this)};C=function(){var Y=this._toolAddDlg.getSelectedToolDefs(),W,Z,X;this._pendingDescriptions={};for(X=0;X<Y.length;X++){W=t.call(this,Y[X].name);this._pendingDescriptions[W]=Y[X].description;Z=this.$.toolPanel.createItem("ad-multiview-tool-instance");Z.viewState=O.SMAProcADUI.ADMultiviewItem.VIEWSTATE.initializing;Z.model={name:W,description:Y[X].description,icon:"",toolDef:{name:Y[X].name,description:Y[X].description}};Z.modelSource=H;this.$.toolPanel.addItem(Z);this.$.toolManager.createToolInstance(X,Y.length,Y[X],W,{onComplete:d.bind(this),onFailure:o.bind(this)})}f.call(this);J.call(this)};Q=function(){var W=null;if(this.$.toolConfigView.isOpen()){this.$.toolConfigView.close()}else{W=a.call(this);W.tools=r.call(this);W.refresh();this.$.toolConfigView.open()}f.call(this)};q=function(){f.call(this)};z=function(){var X=r.call(this),W;if(X.length===1){X[0].configuration.prepareToRun();if(!X[0].workDir){W=this.$.stationManager.getStation(X[0].station);this.$.stationCredentials.getEncryptedCredentials(X[0].credentials,W,this.$.stationManager)}var Y=function(){if(!this._toolRunDlg){this._toolRunDlg=new O.SMAProcADUI.ADToolRunDialog();this._toolRunDlg.session=this.session;this._toolRunDlg.addEventListener(O.SMAProcADUI.ADToolRunDialog.EVENTS.accept,U.bind(this),false);N.dom(document.body).appendChild(this._toolRunDlg)}this._toolRunDlg.tool=X[0];V.call(this)}.bind(this);window.setTimeout(Y,1)}};U=function(){var W=r.call(this);if(W.length===1){l.call(this,W[0])}f.call(this)};A=function(){var W=r.call(this),X=null;if(!localStorage["SMAProcAdhoc.preferences.hideRemoveToolsConfirm"]){localStorage["SMAProcAdhoc.preferences.hideRemoveToolsConfirm"]="false"}X=localStorage["SMAProcAdhoc.preferences.hideRemoveToolsConfirm"].toLowerCase()==="true";if(!X){if(!this._toolRemoveDlg){this._toolRemoveDlg=new O.SMAProcADUI.ADToolRemoveDialog();this._toolRemoveDlg.viewMode=this.viewMode;this._toolRemoveDlg.addEventListener(O.SMAProcADUI.ADToolRemoveDialog.EVENTS.accept,e.bind(this),false);N.dom(document.body).appendChild(this._toolRemoveDlg)}this._toolRemoveDlg.hideConfirm=X;this._toolRemoveDlg.selectedTools=W;this._toolRemoveDlg.showDialog()}else{F.call(this,this.$.toolPanel.selections)}};e=function(){if(this._toolRemoveDlg){localStorage["SMAProcAdhoc.preferences.hideRemoveToolsConfirm"]=this._toolRemoveDlg.hideConfirm?"true":"false"}F.call(this,this.$.toolPanel.selections);f.call(this);J.call(this)};c=function(Y){var W,X;if(Y.detail.tool.workDir!==Y.detail.execDir){if(!Y.detail.execDir.removeAfterJob){Y.detail.tool.workDir=Y.detail.execDir}W=a.call(this);if(W){W.refresh()}}if(Y.detail.execDir&&!Y.detail.execDir.removeAfterJob){this.$.stationCredentials.setEncryptedCredentials(Y.detail.tool.credentials,Y.detail.execDir,this.$.stationManager)}else{X=this.$.stationManager.getStation(Y.detail.tool.station);this.$.stationCredentials.setEncryptedCredentials(Y.detail.tool.credentials,X,this.$.stationManager)}if(Y.detail.execDir){Y.detail.execDir.creating=false}this.fire(n.jobStarted,{});this.fire(n.appMessage,{level:"success",message:"Started new job for <strong>"+Y.detail.tool.name+"</strong>",category:P})};M=function(W){if(W.detail.execDir){W.detail.execDir.creating=false}if(W.detail.error===O.SMAProcADUI.ADRun.ERRORS.jobNotStarted){this.fire(n.appMessage,{level:"error",message:"Couldn't start a job for <strong>"+W.detail.tool.name+"</strong>: "+W.detail.message,category:P})}else{if(W.detail.error===O.SMAProcADUI.ADRun.ERRORS.execDirNotInitialized){this.fire(n.jobStarted,{});this.fire(n.appMessage,{level:"warning",message:"Started a job for <strong>"+W.detail.tool.name+"</strong>, but the execution directory could not be initialized. "+W.detail.message,category:g})}}};S=function(W){W.stopPropagation();W.cancelBubble=true;W.preventDefault();if(!this.$.dashboard.isInDashboard()){W.dataTransfer.dropEffect="none"}else{W.dataTransfer.dropEffect="move"}return true};R=function(){var Y=r.call(this);this.selectedToolIds=[];for(var X=0;X<Y.length;X++){this.selectedToolIds.push(Y[X].modelID)}var W=a.call(this);if(W){W.refresh()}this.session.initTools()};s=function(){var W=a.call(this);if(N.dom(W.$.panelOverlay).classList.contains("hidden")){N.dom(W.$.panelOverlay).classList.remove("hidden")}else{N.dom(W.$.panelOverlay).classList.add("hidden")}};O.SMAProcADUI=O.SMAProcADUI||{};O.SMAProcADUI.ADToolkitView=N({is:"ad-toolkit-view",properties:{access:{type:String,value:"",reflectToAttribute:true},session:{type:Object,value:null,observer:"sessionChanged"},viewMode:{type:String,value:function(){return O.SMAProcADUI.ADMultiviewPanel.VIEWMODE.icon},},selectedToolIds:{type:Object,value:[]},isLoading:{type:Boolean,value:false},loadingSpinner:{type:Object,value:null}},ready:function(){return i.apply(this,arguments)},attached:function(){return I.apply(this,arguments)},onVariableValueChange:function(){return m.apply(this,arguments)},onViewIcons:function(){return x.apply(this,arguments)},onViewList:function(){return D.apply(this,arguments)},onContentAreaClick:function(){return b.apply(this,arguments)},onToolSelect:function(){return L.apply(this,arguments)},onToolDrilldown:function(){return k.apply(this,arguments)},onAddTools:function(){return h.apply(this,arguments)},onAddToolsAccept:function(){return C.apply(this,arguments)},onConfigureTools:function(){return Q.apply(this,arguments)},onConfigureToolsClose:function(){return q.apply(this,arguments)},onRunTool:function(){return z.apply(this,arguments)},onRunToolAccept:function(){return U.apply(this,arguments)},onRemoveTools:function(){return A.apply(this,arguments)},onRemoveToolsAccept:function(){return e.apply(this,arguments)},onJobStarted:function(){return c.apply(this,arguments)},onJobError:function(){return M.apply(this,arguments)},onDragOver:function(){return S.apply(this,arguments)},refresh:function(){return R.apply(this,arguments)},sessionChanged:function(){T.call(this)},blockToolConfig:function(){return s.apply(this,arguments)},behaviors:[O.SMAProcSP.SPBase],_computeIconViewButtonClass:function(W){return this.tokenList({hidden:W==="icon"})+"btn btn-xs btn-default "+this.tokenList({hidden:W==="icon"})},_computeListViewButtonClass:function(W){return this.tokenList({hidden:W==="list"})+"btn btn-xs btn-default "+this.tokenList({hidden:W==="list"})},tokenList:function(Y){var X=[];for(var W in Y){if(Y[W]){X.push(W)}}return X.join(" ")}})});