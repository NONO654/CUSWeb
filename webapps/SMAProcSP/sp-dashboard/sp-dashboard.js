/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
(function(l){var j=l.Polymer,d=l.Promise||(l.UWA&&l.UWA.Promise)||(l.UWA&&l.UWA.Class&&l.UWA.Class.Promise);var f="x3dPlatformId",n="DS/PlatformAPI/PlatformAPI",o="DS/UWPClientCode/PublicAPI",h="app.urls.myapps",b=["collabspaces","collabspace"],m={"3DSwym":"swym","3DPassport":"passport","3DSpace":"cstorage","3DSearch":"search","3DMessaging":"rtc",ComputeOrchestration:"hpc","3DOrchestrate":"hpc","6WTags":"tagger"},a=null,k=null,c=null;function p(){var t=[],s=null;if(l.widget&&l.widget.getPreference){b.some(function(u){s=l.widget.getPreference(u);return s});if(s&&s.options){t=s.options.map(function(u){return{id:u.value,displayName:u.label}})}}return t}function r(){var s=this;return new d(function(w,v){var t=null,x,u;if(l.widget&&l.widget.getValue&&l.widget.getPreference&&l.widget.addPreference){b.some(function(y){t=l.widget.getValue(y)?y:null;return t});if(!t){b.some(function(y){t=l.widget.getPreference(y)?y:null;return t})}if(!t){t=b[0]}x={name:t,type:"list",label:"Collaborative Space",options:[],defaultValue:null};u=s.getCurrentSecurityContext();if(u){x.options.push(u);x.defaultValue=u}l.widget.addPreference(x);if(l.widget.isEdit){l.widget.dispatchEvent("onEdit")}require(["DS/WAFData/WAFData"],function(y){y.authenticatedRequest(s.getMcsUri()+"/resources/bps/cspaces?tenant="+s.getCurrentPlatform(),{type:"json",onComplete:function(B){var C,A=Array.isArray(B.cspaces)?B.cspaces:[{name:null,displayName:"No collabspaces found"}],z=false;x.options=A.map(function(D){z=z||D.name===u;return{value:D.name,label:D.displayName}});if(!z&&A.length>0){C=A.filter(function(D){return D.isDefault});if(C&&C.length===1){x.defaultValue=C[0].name}else{x.defaultValue=A[0].name}}l.widget.addPreference(x);if(l.widget.isEdit){l.widget.dispatchEvent("onEdit")}w(p.call(s))},onFailure:function(){v(new Error("Failed to get collaboration spaces"))}})},function(){v(new Error("Failed to load WAFData"))})}else{v(new Error("Cannot fetch security contexts and add as preference"))}})}function g(){var s=null;return this.fetchMyappsUri().then(function(t){return new d(function(v,u){require(["DS/WAFData/WAFData"],function(w){w.authenticatedRequest(t+"/resources/AppsMngt/environment/list",{type:"json",onComplete:function(x){if(x&&x.code===0&&x.environments){a=x.environments;if(l.widget&&l.widget.getValue&&l.widget.setValue){s=l.widget.getValue(f);if(!s&&(a.length===1)){l.widget.setValue(f,a[0].id)}}v(a)}else{u(new Error("sp-dashboard: invalid environment list"))}},onError:function(){u(new Error("sp-dashboard: failed to fetch environment list"))}})})})})}function e(){var s;return this.fetchMyappsUri().then(function(t){return new d(function(v,u){require(["DS/WAFData/WAFData"],function(w){w.authenticatedRequest(t+"/resources/AppsMngt/licenses/whereused",{type:"text",onComplete:function(x){if(x){s=x.split(/\n/)[0].split(/=/)[1].split(/,/).filter(function(y){return(y&&(y.trim().length>0))});if(s.length>0){k=s.map(function(y){return{id:y.trim(),displayName:y.trim()}})}c=(x.split(/\n/)[2].split(/=/)[1]).trim();v(k)}else{u(new Error("sp-dashboard: invalid environment list"))}},onError:function(){u(new Error("sp-dashboard: failed to fetch environment list"))}})})})})}function q(){var s=[];if(a){s=a.map(function(t){return{id:t.id,displayName:t.displayName}})}return s}function i(u,v){var s=null,t=a||[];t.some(function(w){if(!v||w.id===v){s=w[u]}return s});return s}l.DS=l.DS||{};l.DS.SMAProcSP=l.DS.SMAProcSP||{};l.DS.SMAProcSP.SPDashboard=j({is:"sp-dashboard",behaviors:[l.DS.SMAProcSP.SPBase],properties:{SERVICE_NAMES:{type:Object,value:function(){return m},readOnly:true}},created:function(){if(!d){require(["UWA/Class/Promise"],function(s){d=s})}},isInDashboard:function(){var s=l.UWA&&l.UWA.hosts&&l.UWA.hosts.exposition;return s&&["http://uwa.netvibes.com","https://uwa.netvibes.com"].indexOf(s)===-1},getMcsUri:function(){var u="",t=l.location,s=l.require||function(){};if(l.ODTServerEnv&&l.ODTServerEnv.url){u=l.ODTServerEnv.url}else{if(this.isInDashboard()){u=l.widget&&l.widget.getUrl()||"";if(u.indexOf("/webapps")>-1){u=u.substring(0,u.indexOf("/webapps"))}else{if(s.defined&&s.defined(n)){u=s(n).getApplicationConfiguration(h)}}if(!u&&l.console&&l.console.warn){l.console.warn("Could not guess base URI in dashboard")}}else{u=t.protocol+"//"+t.host+t.pathname.match(/^\/\w*/).join("")}}return u},getMyappsUri:function(){var s=null;if(l.ODTServerEnv&&l.ODTServerEnv.url){s=l.ODTServerEnv.url}else{try{s=l.top.myAppsURL}catch(u){s=null}}if(!s){try{require([n,o],function(v){s=v.getApplicationConfiguration(h)})}catch(t){s=null}}return s},fetchMyappsUri:function(){var t=this.getMyappsUri();if(t){return d.resolve(t)}else{if(l.dscef&&l.dscef.getMyAppsURL){return l.dscef.getMyAppsURL().then(function(u){return u.replace(/\/resources\/AppsMngt$/,"")})}else{var s=new Error("failed to fetchMyappsUri");return new d(function(v,u){require([n,o],function(w){v(w.getApplicationConfiguration(h))},function(w){s.originalError=w;u(s)})})}}},getWidgetId:function(s){var u=s||this,t=null;if(u){if(typeof u.widgetid==="string"){t=u.widgetid}else{if(typeof u.widgetId==="string"){t=u.widgetId}}}if(!t&&l.widget&&l.widget.id){t=l.widget.id}return t},getSecurityContext:function(s){var u=s||this,t=(u&&typeof u.securityContext==="string")?u.securityContext:null;if(!t&&l.widget&&l.widget.getValue){b.some(function(v){t=l.widget.getValue(v);return t})}return t},getCurrentSecurityContextLabel:function(u){var s=this.getSecurityContext(u),w=l.widget.preferences,v,t;for(v=0;v<w.length;v++){for(t=0;w[v].options.length;t++){if(s===w[v].options[t].value){return w[v].options[t].label}}}return s},addSecurityContextPreference:function(){var s=this;var t=new Error("empty error for addSecurityContextPreference stack");return new d(function(y,x){var u=null,w=l.widget||{},A,v,z="";if(w.getValue){b.some(function(B){u=l.widget.getValue(B)?B:null;return u});z=s.getCurrentPlatform()}if(!u&&w.getPreference){b.some(function(B){u=l.widget.getPreference(B)?B:null;return u})}if(!u){u=b[0]}if(w.addPreference){v=s.getSecurityContext();A={name:"collabspaces",type:"list",label:"Collaborative Space",options:[{value:v,name:v}],defaultValue:v};w.addPreference(A);if(w.isEdit){w.dispatchEvent("onEdit")}require(["DS/WAFData/WAFData"],function(B){B.authenticatedRequest(s.getMcsUri()+"/resources/bps/cspaces?tenant="+z,{type:"json",onComplete:function(E){var F,D=Array.isArray(E.cspaces)?E.cspaces:[{name:null,displayName:"No collabspaces found"}],C=false;A.options=D.map(function(G){C=C||G.name===v;return{value:G.name,label:G.displayName}});if(!C&&D.length>0){F=D.filter(function(G){return G.isDefault});if(F&&F.length===1){A.defaultValue=F[0].name}else{A.defaultValue=D[0].name}}w.addPreference(A);if(w.isEdit){w.dispatchEvent("onEdit")}y(s.getSecurityContext())},onFailure:function(){w.log("Failed to get collaboration spaces.");t.message="Failed to get collaboration spaces";x(t)}})},function(){t.message="Failed to load WAFData";x(t)})}else{t.message="Cannot add widget preference";x(t)}})},addWUTenantPreference:function(){var s=this;var u=new Error("empty error for addWUTenantPreference stack");var t=l.widget||{};return new d(function(x,w){var y=function(A){var z={name:"tenantId",type:"list",label:"License Pool"},D,E=[];if(A){var C=l.widget.getValue("x3dPlatformId");D=A.split(/\n/)[0].split(/=/)[1].split(/,/);if(D.length>1){z.defaultValue=D[0];for(var B=0;B<D.length;B++){E.push({value:D[B],label:D[B]});if(D[B].contains(C)){z.defaultValue=D[B]}}z.options=E;l.widget.setValue("tenantId",z.defaultValue);l.widget.addPreference(z)}else{if(D.length===1){l.widget.setValue("tenantId",D[0])}}x(true)}else{var F="Unable to fetch WU tenants Information";w(F)}},v=function(z){t.log(z);u.message="Failed to get tenant info";w(u)};require(["DS/WAFData/WAFData"],function(z){s.fetchMyappsUri().then(function(A){z.authenticatedRequest(A+"/resources/AppsMngt/licenses/whereused",{type:"text/plain",onComplete:y,onError:v})})})})},addReadOnlyWAPreference:function(){if(this.isInDashboard()){var s=l.widget.getValue("x3dPlatformId");if(s!=="OnPremise"){var t={name:"WAtenantId",type:"list",label:"Platform"};t.options=[{value:s,label:s}];t.defaultValue=s;l.widget.setValue("WAtenantId",t.defaultValue);l.widget.addPreference(t)}}},getAuthenticatedJspUri:function(s){var t=this.getSecurityContext(),u=s;if(t){u="/common/emxFrameworkContextManager.jsp?"+this.JS.toQueryString({SecurityContext:t,forwardUrl:s})}return this.getMcsUri()+u},getSecurityContexts:function(t){var s=null;if(l.widget&&l.widget.getPreference){b.some(function(u){s=l.widget.getPreference(u);return s})}if(!s||(!s.options)||(s.options.length===0)||t){return r.call(this)}else{return d.resolve(p.call(this))}},getCurrentSecurityContext:function(){var s=null;if(l.widget&&l.widget.getValue){b.some(function(t){s=l.widget.getValue(t);return s})}return s},getPlatforms:function(s){if(!a||(a.length===0)||s){return g.call(this).then(q.call(this))}else{return d.resolve(q.call(this))}},getCurrentPlatform:function(){var s=null;if(l.widget&&l.widget.getValue){s=l.widget.getValue(f)}if(l.dscef){s=this.parseTenantIdFromURL()}return s},parseTenantIdFromURL:(function(){var s=null;return function(){if(s===null){var u=l.top.location.href,t;t=u.split("&");for(var v=0;v<t.length;v++){if(t[v].contains("tenant")){var w=t[v].split("=");s=w[1]}}}return s}})(),getServiceUri:function(s,t){if(!a||(a.length===0)){return this.initPlatforms(true).then(function(){return i(s,t)})}else{return d.resolve(i(s,t))}},getWhereUsedTenantInfo:function(s){if(!k||(k.length===0)||s){return e.call(this)}else{return d.resolve(k)}},getDslsUrl:function(){return c}});DS.SMAProcSP.SPDashboard.SERVICE_NAMES=DS.SMAProcSP.SPDashboard.SERVICE_NAMES||m}(this));