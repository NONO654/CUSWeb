/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
require(["UWA/Class/Promise"],function(u){var Q=Polymer,B=window.Promise||u;var t=null,J=null,q=null,M=null,h=null,O=null,H=null,i=null,R=null,a=null,v=null,l=null,F=null,k=null,G=null,D=null,x=null,p=null,m=null,e=1000,d=30,f="_1",I="{localhost}",j=2000,P=20,g=200,c=204,S=404,K=410,N=50,C="{{physicalID}}",A="{{hasLocalHost}}",E="{{path}}",w="{{station}}",z='<?xml version="1.0" encoding="utf-8"?><fiper_Model version="6.417.0" rootComponentId="1"><Component id="1" name="MonitorFiles" type="com.dassault_systemes.sma.adapter.monitorfiles">  <Variable name="affinities" role="Property" structure="Aggregate">    <Variable name="Host" role="Property" structure="Scalar" type="string">      <Value>'+w+'</Value>    </Variable>  </Variable>  <Variable type="com.engineous.datatype.String" id="1:expression" name="workingDirectory" role="Property" mode="Local" parentId="1">    <Value>'+E+"</Value>  </Variable></Component></fiper_Model>",L='<JobInfo><Application name="adhoc" updatePLM="false"><PLMObject physicalid = "'+C+'"></PLMObject><HasLocalHost>'+A+"</HasLocalHost></Application></JobInfo>",o={args:1,cosJobNotDispatched:2,execdirPathNotFound:3,filemonJobUserStationMismatch:4,filemonJobNotStarted:5,transientMonitorFinished:6,filemonURLNotFound:7,credentialsNotSupplied:8,execDirContentNotFound:9,runtimeError:10},n,r,y,T,s,b;t=function(U){return new B(function(V){V(U)})};J=function(V,ac,Z){var U=null,W=null,ab=null,aa=null,X,Y="";if(V&&V.JobInfo&&V.JobInfo.JobSummary&&V.JobInfo.JobSummary.WorkItemSummaries){W=V.JobInfo.JobSummary.StationList?V.JobInfo.JobSummary.StationList:null;ab=V.JobInfo.JobSummary.WorkItemSummaries.WorkItemSummary?V.JobInfo.JobSummary.WorkItemSummaries.WorkItemSummary:null;if(W){if(Array.isArray(W)){if(!ac&&W.length>0){aa=W[0]["@stationTempDirectory"]}else{for(X=0;X<W.length;X++){if((W[X]["@stationName"]===ac)||((I===ac)&&(W[X]["@isPrivate"].toLowerCase()==="true"))){aa=W[X]["@stationTempDirectory"];break}}}}else{aa=W["@stationTempDirectory"]}if(ab&&(Z||!ac)){if(Array.isArray(ab)){if(ab.length>0){Y=ab[0]["@groupName"]}}else{Y=ab["@groupName"]}}if(aa){U=aa;if(Y){U+=Y+f}}}}return U};q=function(V,ac,Z){var U=null,W=null,ab=null,aa=null,X,Y="";if(V){if(Array.isArray(V)&&(V.length>0)){W=V[0].StationList?V[0].StationList:null;ab=V[0].WorkItemSummaries?V[0].WorkItemSummaries:null}else{W=V.StationList?V.StationList:null;ab=V.WorkItemSummaries?V.WorkItemSummaries:null}if(W){if(Array.isArray(W)){for(X=0;X<W.length;X++){if((W[X]["Station Name"]===ac)||((I===ac)&&(W[X]["isPrivate"].toLowerCase()==="true"))){aa=W[X]["Station Temp Directory"];break}}}else{aa=W["Station Temp Directory"]}if(Z&&ab){if(Array.isArray(ab)){if(ab.length>0){Y=ab[0]["Group Name"]}}else{Y=ab["Group Name"]}}if(aa){U=aa;if(Y){U+=Y+f}}}}return U};M=function(Y,U,V){var X=null,W=null;if(Y.execDir.filemonJobID){X=Y.that.$.monitorWS.uri.replace("<jobId>",Y.execDir.filemonJobID)}else{X=Y.that.$.monitorWS.uri.replace("<jobId>",Y.execDir.cosJobID)}W={uri:X,verb:"GET",onComplete:U,onError:V,objectId:Y.physicalID};if(Y.execDir.serverID){W.serverId=Y.execDir.serverID}Y.that.$.monitorWS.sendRequest(W)};h=function(Y){var V=null,U,X,W;if(typeof Y.MonitoringMessages.MessageList!=="undefined"&&Y.MonitoringMessages.MessageList&&typeof Y.MonitoringMessages.MessageList.Message!=="undefined"&&Y.MonitoringMessages.MessageList.Message){U=Y.MonitoringMessages.MessageList.Message["$"];if(typeof U!=="undefined"&&U){X=U.indexOf("<URL>");W=U.indexOf("</URL>",X);if(X>=0&&W>=0){V=U.substring(X+"<URL>".length,W)}}}return V};O=function(U){var V=this;return new B(function(Y){var W,X;W=U.execDir?U.execDir:{station:null};if(U.cosJobID&&(U.cosJobID.length>0)){W.cosJobID=U.cosJobID}if(U.serverID&&(U.serverID.length>0)){W.serverID=U.serverID}if(U.station&&(U.station.length>0)){W.station=U.station}if(U.mcsJobID&&(U.mcsJobID.length>0)){W.mcsJobID=U.mcsJobID}X={that:V,execDir:W,physicalID:U.physicalID,onComplete:U.onComplete,onFailure:U.onFailure};if(U.activityID&&(U.activityID.length>0)){X.activityID=U.activityID}else{if(W.activityID){X.activityID=W.activityID}}Y(X)})};H=function(U){var V=this;return new B(function(X){var W={that:V,execDir:U.execDir,physicalID:U.physicalID,onComplete:U.onComplete,onFailure:U.onFailure};if(U.subdirPath){W.subdirPath=U.subdirPath}if(U.filePath){W.filePath=U.filePath}if(U.start){W.start=U.start}if(U.credentialsFunction){W.credentialsFunction=U.credentialsFunction}if(typeof(U.numLines)!=="undefined"&&U.numLines!==null){W.numLines=U.numLines}X(W)})};i=function(U){return new B(function(aa,Z){var Y,V,ac=function(ad){var af=JSON.parse(ad.response);var ae=J.call(this,af,U.execDir.station,U.activityID);if(ae){U.execDir.path=ae;aa(U)}else{U.cosRetriesLeft--;if(U.cosRetriesLeft>0){window.setTimeout(W,e)}else{U.error={error:o.cosJobNotDispatched};Z(U)}}},X=function(ad){if(ad.status===K){aa(U)}else{U.error={error:o.runtimeError,cause:ad.status,message:ad.response};Z(U)}},W=function(){U.that.$.cosJobSummaryWS.sendRequest(V)};try{if(U.execDir.cosJobID){Y=U.that.$.cosJobSummaryWS.uri.replace("<jobId>",U.execDir.cosJobID);V={uri:Y,verb:"GET",onComplete:ac,onError:X,objectId:U.physicalID};if(U.execDir.serverID){V.serverId=U.execDir.serverID}U.cosRetriesLeft=d;W()}else{aa(U)}}catch(ab){U.error={error:o.runtimeError,message:ab.message};Z(U)}})};R=function(U){return new B(function(Z,Y){var X,V,ab=function(ac){var ae=JSON.parse(ac.response);var ad=q.call(this,ae,U.execDir.station,U.activityID);if(ad){U.execDir.path=ad;Z(U)}else{U.error={error:o.execdirPathNotFound};Y(U)}},W=function(ac){if(ac.status===K){Z(U)}else{U.error={error:o.runtimeError,cause:ac.status,message:ac.response};Y(U)}};try{X=U.that.$.dashboard.getMcsUri()+U.that.$.mcsJobSummaryWS.uri.replace("<jobId>",U.execDir.mcsJobID);V={uri:X,verb:"GET",onComplete:ab,onError:W};U.that.$.mcsJobSummaryWS.sendRequest(V)}catch(aa){U.error={error:o.runtimeError,message:aa.message};Y(U)}})};a=function(U){return new B(function(X,W){var Z=function(aa){if(aa){X(U)}else{U.error={error:o.credentialsNotSupplied,cause:null};W(U)}},V=(U.credentialsFunction)?U.credentialsFunction:U.that.credentialsFunction;try{if(V){V({execDir:U.execDir,onComplete:Z})}}catch(Y){U.error={error:o.runtimeError,message:Y.message};W(U)}})};v=function(U){return new B(function(ae,af){var ac=function(){U.that.$.runner.removeEventListener("success",ab);U.that.$.runner.removeEventListener("error",Z)},ab=function(ag){ac.call(U);if(ag&&ag.detail&&ag.detail.result){U.execDir.filemonJobID=ag.detail.result.EEDJobID}ae(U)},Z=function(ag){ac.call(U);U.error={error:(ag.detail.status===DS.SMAProcSP.SPRun.ERRORS.PRIVATE_STATION_USER_MISMATCH)?o.filemonJobUserStationMismatch:o.filemonJobNotStarted};af(U)},W=null,Y=null,X=null,ad=false,V=null;try{U.that.$.runner.addEventListener("success",ab);U.that.$.runner.addEventListener("error",Z);if(U.execDir.station===I){ad=true;W=z.replace(E,U.execDir.path).replace(w,I)}else{W=z.replace(E,U.execDir.path).replace(w,U.execDir.station)}Y=U.execDir.credentials?U.execDir.credentials:null;X=L.replace(C,U.physicalID).replace(A,ad);V=U.execDir.serverID?U.execDir.serverID:null;U.that.$.runner.runEXML(null,W,U.physicalID,null,Y,X,ad,V)}catch(aa){U.error={error:o.runtimeError,message:aa.message};af(U)}})};l=function(U){return new B(function(Z,Y){var X=null,V=null,ab=function(){if(U.execDir.filemonJobID){U.execDir.filemonJobID=null}U.execDir.filemonURL=null;Z(U)},W=function(ac){U.error={error:o.runtimeError,cause:ac.status,message:ac.response};Y(U)};try{if(U.execDir.filemonURL){U.that.$.stopWS.success=[g,c];X=U.that.$.stopWS.uri.replace("<host>",U.execDir.filemonURL);V={uri:X,serverId:U.execDir.serverID,onComplete:ab,onError:W};if(!U.that.unauthenticatedStations){V.objectId=U.physicalID}U.that.$.stopWS.sendRequest(V)}else{Z(U)}}catch(aa){U.error={error:o.runtimeError,message:aa.message};Y(U)}})};F=function(U){return new B(function(Y){var W=null,V=null,X=function(){Y(U)};try{if(U.execDir.filemonJobID){U.that.$.stopWS.success=[g,c];W=U.that.$.cancelWS.uri.replace("<jobId>",U.execDir.filemonJobID);V={uri:W,verb:"PUT",headers:{Accept:"text/plain"},serverId:U.execDir.serverID,objectId:U.physicalID,onComplete:X,onError:X};U.that.$.cancelWS.sendRequest(V)}else{Y(U)}}catch(Z){Y(U)}})};k=function(U){return new B(function(X,W){var Z=function(ad){var ae=false,ac=false,ag=false,aa=false,ah=null,af=null,ab=null;U.execDir.filemonURL=null;ah=JSON.parse(ad.response);if(ah){ab=h.call(this,ah);af=ah.MonitoringMessages["@status"];if(af.toLowerCase()==="done"){ag=true;if(ab&&ab.length>0){aa=true}}else{U.execDir.filemonURL=ab}}if(!U.execDir.filemonURL&&!aa){if(ag){if(!U.needNewJob){aa=true}else{ac=true}}else{if(U.numMonitorWSTries<P){ae=true}else{ac=true}}}if(ae){setTimeout(function(){U.numMonitorWSTries++;M.call(this,U,Z,V)},j)}else{if(aa){if(!U.execDir.station){U.error={error:o.transientMonitorFinished};W(U)}else{U.needNewJob=true;X(U)}}else{if(ac){U.error={error:o.filemonURLNotFound};W(U)}else{X(U)}}}},V=function(){if(!U.execDir.station){U.error={error:o.transientMonitorFinished};W(U)}else{U.needNewJob=true;X(U)}};try{U.numMonitorWSTries=1;M.call(this,U,Z,V)}catch(Y){U.error={error:o.runtimeError,message:Y.message};W(U)}})};G=function(U){return new B(function(Y,V){var W=false,Z=false;try{if(U.execDir.filemonJobID&&(U.execDir.filemonJobID.length>0)){W=true}if(U.execDir.credentials&&!U.execDir.credentials.encryptedCredentials){Z=true}if(U.execDir.credentials&&U.execDir.credentials.credentialsEncrypted){Z=false}B.resolve(U).then((!W&&Z)?a:t).then(!W?v:t).then(k).then(function(aa){return new B(function(ac,ab){if(aa.execDir.filemonURL&&(aa.execDir.filemonURL.length>0)){aa.error=null;ab(aa)}else{ac(aa)}})}).then(Z?a:t).then(v).then(k).then(function(aa){Y(aa)})["catch"](function(aa){var ab=aa.error;if(aa.error){B.resolve(aa).then(F)["catch"](function(ac){ac.error=ab});V(aa)}else{Y(aa)}})}catch(X){U.error={error:o.runtimeError,message:X.message};V(U)}})};D=function(U){return new B(function(X,V){try{B.resolve(U).then(k).then(function(Y){X(Y)})["catch"](function(Y){V(Y)})}catch(W){U.error={error:o.runtimeError,message:W.message};V(U)}})};x=function(U){return new B(function(Z,Y){var X=null,V=null,ab=function(ad){var ac;if((g===ad.status)&&ad.response){ac=ad.response;if(typeof ad.response==="string"){ac=JSON.parse(ad.response)}U.lsResult=ac;Z(U)}else{U.error={error:o.runtimeError,cause:ad.status,message:ad.response};Y(U)}},W=function(ac){U.error={error:o.runtimeError,cause:ac.status,message:ac.response};if(ac.status===S){U.error.error=o.execDirContentNotFound}Y(U)};try{X=U.that.$.lsWS.uri.replace("<host>",U.execDir.filemonURL);if(U.subdirPath){if(!U.subdirPath.startsWith("/")&&!U.subdirPath.startsWith("\\")){X+="/"}X+=U.subdirPath}else{X+="/"}V={uri:X,serverId:U.execDir.serverID,onComplete:ab,onError:W};if(!U.that.unauthenticatedStations){V.objectId=U.physicalID}U.that.$.lsWS.sendRequest(V)}catch(aa){U.error={error:o.runtimeError,message:aa.message};Y(U)}})};p=function(U){return new B(function(aa,Z){var Y=null,W=null,V,ac=function(ag){var af,ah=false,ae=false,ad;U.tailResult={};if(ag.response){af=JSON.parse(ag.response);ad=decodeURIComponent((new RegExp("[?|&]NextEndPoint=([^&;]+?)(&|#|;|$)").exec(ag.uri)||[,""])[1].replace(/\+/g,"%20"))||null;if(ad&&ad>0){ah=true;if(ad>=af.endPoint){ae=true}}U.tailResult.contents=af.contents?af.contents:"";U.tailResult.modified=af.modified?af.modified:null;U.tailResult.continuous=ah;U.tailResult.eof=ae}aa(U)},X=function(ad){U.error={error:o.runtimeError,cause:ad.status,message:ad.response};if(ad.status===S){U.error.error=o.execDirContentNotFound}Z(U)};try{Y=U.that.$.tailWS.uri.replace("<host>",U.execDir.filemonURL);if(!U.filePath.startsWith("/")&&!U.filePath.startsWith("\\")){Y+="/"}Y+=U.filePath;V=(typeof(U.numLines)!=="undefined"&&U.numLines!==null)?U.numLines:N;if((typeof U.start==="number")&&(U.start>0)&&(V>0)){Y+="?PreviousEndPoint="+U.start+"&NextEndPoint="+(U.start+V-1)}else{if(V>=0){Y+="?NumberOfLines="+V}}W={uri:Y,serverId:U.execDir.serverID,onComplete:ac,onError:X};if(!U.that.unauthenticatedStations){W.objectId=U.physicalID}U.that.$.tailWS.sendRequest(W)}catch(ab){U.error={error:o.runtimeError,message:ab.message};Z(U)}})};m=function(U){return new B(function(X,W){var Z=function(aa,ab){U.ticket=ab;X(U)},V=function(aa){U.error={error:o.runtimeError,cause:null,message:null};W(U)};try{U.that.$.fileWS.cosServerId=U.execDir.serverID;U.that.$.fileWS.$.spCosticket.getServerTicket(U.execDir.serverID,U.physicalID,true,Z,V)}catch(Y){U.error={error:o.runtimeError,message:Y.message};W(U)}})};n=function(V){var U=false;if(!V.physicalID||(V.physicalID.length===0)){U=true}if(!U){if(V.station||(V.execDir&&V.execDir.station)){O.call(this,V).then(i).then(function(W){return new B(function(Y,X){if(W.execDir.path&&(W.execDir.path.length>0)){W.error=null;X(W)}else{Y(W)}})}).then(R).then(function(W){if(W.onComplete){W.onComplete(W.execDir)}})["catch"](function(W){if(W.error){if(W.onFailure){W.onFailure(W.error)}}else{if(W.onComplete){W.onComplete(W.execDir)}}})}else{O.call(this,V).then(function(W){if(W.onComplete){W.onComplete(W.execDir)}})["catch"](function(W){if(W.error){if(W.onFailure){W.onFailure(W.error)}}else{if(W.onComplete){W.onComplete(W.execDir)}}})}}else{if(V.onFailure){V.onFailure({error:o.args})}}};r=function(V){var U=false;if(V.execDir&&(V.physicalID&&(V.physicalID.length>0))){if(V.execDir.station&&(V.execDir.station.length>0)){if(!V.execDir.path||(V.execDir.path===0)){U=true}}else{if(!V.execDir.cosJobID||(V.execDir.cosJobID===0)){U=true}}}else{U=true}if(!U){H.call(this,V).then(V.execDir.station?G:D).then(function(W){if(W.onComplete){W.onComplete(W.execDir)}})["catch"](function(W){if(W.onFailure){W.onFailure(W.error)}})}else{if(V.onFailure){V.onFailure({error:o.args})}}};y=function(V){var U=false;if(!V.execDir||!V.physicalID||(V.physicalID.length===0)){U=true}if(!U){H.call(this,V).then(V.execDir.station?G:D).then(x).then(function(W){if(W.onComplete){W.onComplete(W.lsResult)}})["catch"](function(W){if(W.onFailure){W.onFailure(W.error)}})}else{if(V.onFailure){V.onFailure({error:o.args})}}};T=function(V){var U=false;if(!V.execDir||!V.physicalID||(V.physicalID.length===0)||!V.filePath||(V.filePath.length===0)){U=true}if(!U){H.call(this,V).then(V.execDir.station?G:D).then(p).then(function(W){if(W.onComplete){W.onComplete(W.tailResult)}})["catch"](function(W){if(W.onFailure){W.onFailure(W.error)}})}else{if(V.onFailure){V.onFailure({error:o.args})}}};s=function(V){var U=false,W;if(!V.execDir||!V.physicalID||(V.physicalID.length===0)||!V.filePath||(V.filePath.length===0)){U=true}if(!U){H.call(this,V).then(V.execDir.station?G:D).then(m).then(function(X){if(X.onComplete){W=X.that.$.fileWS.uri.replace("<host>",X.execDir.filemonURL);if(!X.filePath.startsWith("/")&&!X.filePath.startsWith("\\")){W+="/"}W+=X.filePath;W+=("?EEDTicket="+X.ticket);X.onComplete(W)}})["catch"](function(X){if(X.onFailure){X.onFailure(X.error)}})}else{if(V.onFailure){V.onFailure({error:o.args})}}};b=function(V){var U=false;if(!V.execDir||!V.physicalID||(V.physicalID.length===0)){U=true}if(!U){H.call(this,V).then(V.execDir.station?l:function(W){return W}).then(function(W){if(W.onComplete){W.onComplete()}})["catch"](function(W){if(W.onFailure){W.onFailure(W.error)}})}else{if(V.onFailure){V.onFailure({error:o.args})}}};DS.SMAProcSP=DS.SMAProcSP||{};DS.SMAProcSP.SPCOSFileMonitor=Q({is:"sp-cos-filemonitor",properties:{credentialsFunction:{type:Object,value:function(){return null}},unauthenticatedStations:{type:Boolean,value:false}},initExecDir:function(){return n.apply(this,arguments)},getFileMonitor:function(){return r.apply(this,arguments)},ls:function(){return y.apply(this,arguments)},tail:function(){return T.apply(this,arguments)},getFileURL:function(){return s.apply(this,arguments)},stopFileMonitor:function(){return b.apply(this,arguments)},behaviors:[DS.SMAProcSP.SPBase]});DS.SMAProcSP.SPCOSFileMonitor.ERRORS=DS.SMAProcSP.SPCOSFileMonitor.ERRORS||o;DS.SMAProcSP.SPCOSFileMonitor.LOCALSTATIONNAME=DS.SMAProcSP.SPCOSFileMonitor.LOCALSTATIONNAME||I});