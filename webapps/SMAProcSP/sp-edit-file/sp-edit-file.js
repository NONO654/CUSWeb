/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
require(["UWA/Class/Promise"],function(e){var i=window.Polymer,l=window.DS;var s=null,b=null,q=null,j=null,o=null,m=null,r=null,k=null,f=null,g=null,n="/summary/full",c="/summary/brief",h=5,p={OK:"OK",KO:"Unknown",FAILED:"Failed",UNAUTHORIZED:401},a={failedFile:"ERROR GETTING SINGLE FILE TO EDIT",failedEXML:"ERROR GETTING EXML FROM MCS",failedKEY:"ERROR GETTING PUBLIC KEY FROM COS",failedENCR:"ERROR ENCRYPTING LOGIC TICKET AT MCS",failedRUN:"500 ON COS SERVER DURING RUN",failedTKT:"401 DUE TO INVALID TICKET",failedJobCreation:"Insufficient access rights to create job."},t={ELLIPSIS:"...",ERROR_GENERIC_ADMIN:"Failed opening file for edit. Please contact administrator.",ERROR_STATION_USER_MISMATCH:"Please check that you are using the same user for your local station.",ERROR_STATION_NOT_RUNNING:"The local station is necessary to edit files locally, and it is currently not running.  In order to edit this file, you must first start your local station.",ERROR_STATION_WIP:"Local station seems to be taking time opening this file.",ERROR_STATION_UIP:"Local station seems to be taking time uploading this file.",ERROR_EDITOR_PATH:"Please check the path provided for the editor.",ERROR_BACKUP:"Local station is down or not responding. Please save a backup of the file and contact administrator.",ERROR_NO_FILE:"This document has no files.",ERROR_MULTIPLE_FILES:"This document has multiple files.  Please select a file within the document to edit.",ERROR_LOCKED_FILE:"The file within this document is locked and cannot be edited.",LOG_OPENING:"Opening ",ERROR_FAILED_EDIT:"Failed opening "},d=window.Promise||e;s=function(A,B,v,y,u,z,x,w){return new d(function(D){var C={that:this,EEDJobID:null,exml:null,simulationID:A?A:this.simulationId,category:B?B:this.category,document:v?v:this.document,file:y?y:this.file,appName:u?u:this.appName,editor:z?z:this.editor,credentials:x?x:this.credentials,cosServerID:w?w:this.$.spCos.getDefaultServerId(),applicationData:null,downloadRequestCount:0,uploadRequestCount:0,autoRefreshTimeout:null,editStartCallBack:this.editStartCallBack,editCompleteCallBack:this.editCompleteCallBack,editFailCallBack:this.editFailCallBack,summarySuffix:n,error:null};D(C)}.bind(this))};b=function(u){return new d(function(z,y){var x=null,v=null,B=function(D){var E=JSON.parse(D.response),C=null;if(!E||(E.length===0)){C=t.ERROR_NO_FILE}else{if(E.length===1){if(E[0].basics.isLocked&&(E[0].basics.isLocked.toLowerCase()==="true")){C=t.ERROR_LOCKED_FILE}else{u.file={name:E[0].basics.name,version:0}}}else{C=t.ERROR_MULTIPLE_FILES}}if(C){u.editFailCallBack(a.failedFile,C);u.error={status:-1,response:C,uri:null}}else{z(u)}},w=function(C){u.editFailCallBack(a.failedFile,t.ERROR_FAILED_EDIT+u.file.name);u.error={status:C.status,response:C.response,uri:null};y(u)};try{if(!u.file){x=u.that.$.spDashboard.getMcsUri()+u.that.$.contentWS.uri+"?pid="+u.document.id;v={uri:x,onComplete:B,onError:w};u.that.$.contentWS.sendRequest(v)}else{z(u)}}catch(A){u.editFailCallBack(A.message,u.file.name+" : "+t.ERROR_GENERIC_ADMIN);u.error={status:-1,response:A.message,uri:null};y(u)}})};q=function(u){return new d(function(A,z){var y=null,w=null,v=null,C=function(D){u.exml=D.response;A(u)},x=function(D){u.editFailCallBack(a.failedEXML,t.ERROR_FAILED_EDIT+u.file.name);u.error={status:D.status,response:D.response,uri:null};z(u)};try{y=u.that.$.spDashboard.getMcsUri()+u.that.$.jobEXMLWS.uri;w={key_physical_id:u.simulationID,key_file_name:u.file.name,key_category:u.category,key_document_type:u.document.basics.type,key_document_id:u.document.id,key_app_path:u.editor.path,key_keep_dir:"0"};v={uri:y,verb:"POST",data:JSON.stringify(w),onComplete:C,onError:x};u.that.$.jobEXMLWS.sendRequest(v)}catch(B){u.editFailCallBack(B.message,u.file.name+" : "+t.ERROR_GENERIC_ADMIN);u.error={status:-1,response:B.message,uri:null};z(u)}})};j=function(u){return new d(function(v){u.applicationData='<Application name="'+u.appName+'" updatePLM="false"><PLMObject physicalid = "'+u.document.id+'"></PLMObject><AppUrl>'+u.that.$.spDashboard.getMcsUri()+"</AppUrl><AppResource>/resources/slmservices</AppResource><HasLocalHost>true</HasLocalHost><CsrfUrl>/token/CSRF</CsrfUrl></Application>";v(u)}.bind(this))};o=function(u){return new d(function(y,x){var v=function(){this.that.$.editRunner.removeEventListener("success",A);this.that.$.editRunner.removeEventListener("error",w)},A=function(B){v.call(u);if(B&&B.detail&&B.detail.result){u.EEDJobID=B.detail.result.EEDJobID;if(B.detail.result.credentials&&B.detail.result.credentials.encryptedCredentials){u.credentials.encryptedCredentials=B.detail.result.credentials.encryptedCredentials}}y(u)},w=function(B){v.call(u);if(B&&B.detail&&B.detail.status){if(B.detail.status===p.UNAUTHORIZED){u.editFailCallBack(a.failedTKT,"Authentication Error")}else{if(B.detail.status===l.SMAProcSP.SPRun.ERRORS.PRIVATE_STATION_USER_MISMATCH){u.editFailCallBack(a.failedRUN,u.file.name+" : "+t.ERROR_STATION_USER_MISMATCH)}else{if(B.detail.status===l.SMAProcSP.SPRun.ERRORS.PRIVATE_STATION_NO_STATION_FOUND){u.editFailCallBack(a.failedRUN,u.file.name+" : "+t.ERROR_STATION_NOT_RUNNING)}else{u.editFailCallBack(a.failedRUN,u.file.name+" : "+t.ERROR_GENERIC_ADMIN)}}}u.error={status:B.detail.status,response:"job not started",uri:null}}x(u)};try{u.that.$.editRunner.addEventListener("success",A);u.that.$.editRunner.addEventListener("error",w);u.that.$.editRunner.runEXML(null,u.exml,u.document.id,null,u.credentials,u.applicationData,true,u.cosServerID)}catch(z){u.editFailCallBack(z.message,u.file.name+" : "+t.ERROR_GENERIC_ADMIN);u.error={status:-1,response:z.message,uri:null};x(u)}})};m=function(u){return new d(function(v){u.autoRefreshTimeout=window.setTimeout(r.bind(u,n),u.that.startEditTimeout);v(u)})};r=function(){var w,u,y=function(z){if(this.summarySuffix===n){k.call(this,z)}else{f.call(this,z)}}.bind(this),v=function(){this.editFailCallBack(a.failedTKT,"Authentication Error")}.bind(this);try{w=this.that.$.jobStatusWS.uri+this.EEDJobID+this.summarySuffix,u={uri:w,verb:"GET",objectId:this.document.id,onComplete:y,onError:v};this.that.$.jobStatusWS.sendRequest(u)}catch(x){this.editFailCallBack(x.message,this.file.name+" : "+t.ERROR_GENERIC_ADMIN)}};k=function(x){var z=JSON.parse(x.response),v=z.JobInfo["@completionCode"],u=parseInt(z.JobInfo.JobSummary.WorkItemSummaries["@nSummary"]),w;this.summarySuffix=c;try{w=z.JobInfo.JobSummary.WorkItemSummaries.WorkItemSummary[2].SubflowSummary.SubflowSummaryDetails.SubflowSummaryDetail["@completionCode"]}catch(y){w=null}if(p.KO===v&&4===u){this.editStartCallBack("",t.LOG_OPENING+this.file.name);this.autoRefreshTimeout=window.setTimeout(r.bind(this),this.loopTimeout)}if(p.FAILED===v&&4===u&&w===p.FAILED){this.editFailCallBack(a.failedRUN,this.file.name+" : "+t.ERROR_EDITOR_PATH)}if(p.FAILED===v){this.editFailCallBack(a.failedRUN,this.file.name+" : "+t.ERROR_GENERIC_ADMIN)}if(p.KO===v&&3===u){if(this.downloadRequestCount<h){this.downloadRequestCount++;this.editStartCallBack(t.LOG_OPENING,this.file.name+" : "+t.ERROR_STATION_WIP)}this.autoRefreshTimeout=window.setTimeout(r.bind(this),this.that.loopTimeout)}};f=function(v){var x=JSON.parse(v.response);var u=x.JobInfoBrief["@completionCode"];var w=parseInt(x.JobInfoBrief.JobSummary["@nFinished"]);if(p.OK===u){this.uploadRequestCount=0;this.downloadRequestCount=0;this.editCompleteCallBack(t.LOG_OPENING,this.file.name+" : Edit successful")}else{if(p.KO===u&&(1===w||0===w)){this.autoRefreshTimeout=window.setTimeout(r.bind(this),this.that.loopTimeout)}else{if(p.FAILED===u&&4===w){this.editFailCallBack(t.LOG_OPENING,this.file.name+" : "+t.ERROR_BACKUP)}else{if(p.KO===u&&2===w){if(this.uploadRequestCount>0){this.editStartCallBack(t.LOG_OPENING,this.file.name+" : "+t.ERROR_STATION_UIP)}else{if(this.uploadRequestCount===0){this.uploadRequestCount++;this.editStartCallBack(t.LOG_OPENING,this.file.name+" : Uploading file")}}this.autoRefreshTimeout=window.setTimeout(r.bind(this),this.that.loopTimeout)}}}}};g=function(u){if(u.error&&u.error.response){console.error(u.error.response)}};l.SMAProcSP.SPEditFile=i({is:"sp-edit-file",properties:{simulationId:{type:String,value:null},category:{type:String,value:null},document:{type:Object,value:null},file:{type:Object,value:null},appName:{type:String,value:null},editor:{type:Object,value:null},editStartCallBack:{value:function(){return null}},editCompleteCallBack:{value:function(){return null}},editFailCallBack:{value:function(){return null}},startEditTimeout:{type:Number,value:2000},loopTimeout:{type:Number,value:10000}},onWSError:function(u){u.stopPropagation();u.cancelBubble=true},beginEdit:function(A,B,v,y,u,z,x,w){s.call(this,A,B,v,y,u,z,x,w).then(b).then(q).then(j).then(o).then(m)["catch"](g)},behaviors:[l.SMAProcSP.SPBase]});window.SPEditFile=l.SMAProcSP.SPEditFile});