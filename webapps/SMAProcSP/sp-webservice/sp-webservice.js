/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
(function(i){var o,v,b,w,q,c,l=1,n=200,s=400,a=401,h=500,p,e,d,m,u,f,k,j,t,x,g,r;d=[];g={REQUEST:"request",RESPONSE:"response",RETRY:"retry",ERROR:"error",ABORT:"abort",DATAREADY:"dataready",SESSIONTIMEOUT:"sessiontimeout"};r={GETTING:"is-getting",FAILING:"is-failing",ABORTING:"is-aborting"};p=function(y){this.uri=y.uri;this.verb=y.verb;this.wait=y.wait||0;this.retries=y.retries||0;this.beforeSend=y.beforeSend;this.beforeRetry=y.beforeRetry;this.onComplete=y.onComplete;this.onError=y.onError;this.context=y.context;this.headers=y.headers;this.success=y.success||[n];this.createdAt=new Date().getTime();this.id=p.identity++;this.isDefaultPrevented=false;this.payload=null;this.reqProcessing=null;this.ignoreFlush=y.ignoreFlush;this.disableDefaultHeaders=y.disableDefaultHeaders};p.identity=0;p.pendingRequests={};p.prototype.preventDefault=function(){this.isDefaultPrevented=true};p.prototype.send=function(A){var z=this,y;z.payload=A;z.currentTimestamp=new Date().getTime();p.pendingRequests[z.id]=z;if(z.lastTimestamp&&z.wait>0){return}else{z.lastTimestamp=z.currentTimestamp;if((x()||i.dscef)&&typeof require!=="undefined"&&!(z.headers&&z.headers.EEDTicket)&&z.uri.indexOf("/SMAExeServer-REST/")===-1&&z.uri.indexOf("/SMAExeStation-REST/")===-1){y=function(){require(["UWA/Core","DS/WAFData/WAFData"],function(G,B){var F,E;if(z.beforeSend){z.beforeSend(z,z.payload)}F=G.merge(z.headers||{},{Accept:"application/json","Content-Type":"application/json"});if(F.Accept.indexOf("application/json")===-1){F.Accept+=", application/json"}if(F.pragma){delete F.pragma}if(!z.isDefaultPrevented&&!z.aborted){if(z.payload){try{E=typeof z.payload==="string"?z.payload:JSON.stringify(z.payload)}catch(D){E=""+z.payload}}var C=new URL(z.uri);z.uri=C.href;z.uwaRequest=B.authenticatedRequest(z.uri,{method:z.verb,headers:F,data:E,cache:"-1",authentication:"passport",type:"text",onComplete:function(H){delete p.pendingRequests[z.id];z.response=H;z.status=n;if(z.onComplete){z.onComplete(z)}z.lastTimestamp=null},onFailure:function(I,H){delete p.pendingRequests[z.id];var J=/NetworkError: url "[^"]+" return ResponseCode with value "([^"]+)"./.exec(I);z.status=J?J[1]:h;z.response=H;if(z.retries>0){if(i.console&&i.console.trace){i.console.trace("proxified sp-webservice does not handle retries")}}if(z.onError){z.onError(z)}},onCancel:function(){if(z.onCancel){z.onCancel(z)}delete p.pendingRequests[z.id]}})}else{z.aborted=true;if(z.onCancel){z.onCancel(z)}delete p.pendingRequests[z.id]}})}}else{z.xhr=new XMLHttpRequest();z.xhr.onreadystatechange=function(){if(z.xhr.readyState!==XMLHttpRequest.DONE){return z.xhr}delete p.pendingRequests[z.id];if(z.success.indexOf(z.xhr.status)===-1){if(z.retries>0&&(!z.beforeRetry||!z.beforeRetry(z,z.payload))){z.retries--;z.lastTimestamp=z.currentTimestamp;i.setTimeout(y.bind(z,z,true),z.wait)}else{if(z.onError){z.status=z.xhr.status;z.response=z.xhr.response;z.onError(z)}}}else{z.status=z.xhr.status;z.response=z.xhr.response;if(z.onComplete){z.onComplete(z)}z.lastTimestamp=null}}.bind(z);y=function(D,C){var B={};if(!C&&z.xhr.readyState>0){return}if(z.currentTimestamp>z.lastTimestamp){z.lastTimestamp=z.currentTimestamp;i.setTimeout(y.bind(z,D),D.wait)}else{if(D.beforeSend){D.beforeSend(D,z.payload)}if(!D.isDefaultPrevented&&!D.aborted){if(z.payload&&z.payload.stringify){z.payload=z.payload.stringify()}if(z.uri.indexOf("/SMAExeStation-REST/")===-1){z.uri+=(z.uri.indexOf("?")>-1?"&":"?")+"_="+Date.now()}try{z.xhr.open(z.verb,z.uri,true)}catch(E){if(z.onError){z.onError(E)}throw E}if(typeof z.headers==="object"){Object.keys(z.headers).forEach(function(F){B[F.toLowerCase()]=true;if(z.headers[F]){this.xhr.setRequestHeader(F,z.headers[F])}},z)}if(z.payload&&!B["content-type"]&&!z.disableDefaultHeaders){z.xhr.setRequestHeader("Content-Type","application/json")}if(!B.accept&&!z.disableDefaultHeaders){z.xhr.setRequestHeader("Accept","application/json")}if(!B["x-requested-with"]&&!z.disableDefaultHeaders){z.xhr.setRequestHeader("X-Requested-With","XMLHttpRequest")}D.reqProcessing=true;try{D.xhr.send(z.payload)}catch(E){if(z.onError){z.onError(E)}throw E}}else{D.aborted=true;if(D.onCancel){D.onCancel(z)}delete p.pendingRequests[z.id];D.reqProcessing=false}}}}}i.setTimeout(y.bind(z,z),z.wait)};p.prototype.abort=function(){this.aborted=true;if(this.reqProcessing!==null){this.onAbort()}delete p.pendingRequests[this.id];if(this.uwaRequest){this.uwaRequest.cancel()}else{if(this.xhr&&this.reqProcessing!==null){this.xhr.abort()}}};x=function(){var z=i,y=z.UWA&&z.UWA.hosts&&z.UWA.hosts.exposition;return y&&["http://uwa.netvibes.com","https://uwa.netvibes.com"].indexOf(y)===-1};w=function(y){return/^(https?:)?\/\//.test(y)};t=function(){if(this.JS.isConsoleAvailable()&&console.trace){console.trace("sp-webservice.getMcsURI is deprecated, please use sp-dashboard.getMcsUri instead")}return this.$.dashboard.getMcsUri()};v=function(y){var z;z=this.parseUri(y);if(this.getAttribute("handleprefix")!=="false"&&z.prefix){z.href=z.prefix+(/^\//.test(z.href)?"":"/")+z.href}if(this.handlepostfix&&z.postfix){z.href=z.href.replace(z.postfix,"")+z.postfix}return z.href};q=function(A){var B=0,z,y,C;C=JSON.stringify(A);for(y=0;y<C.length;y++){z=C.charCodeAt(y);B=(B<<5)-B+z;B=B&B}return B};c=function(A){if(!A){return false}if(A.status===a){return true}else{if(A.status===s){var y;try{y=A.response?JSON.parse(A.response):null}catch(z){y=null}if(y&&y.error==="invalid_grant"){return true}}}return false};e=function(){this.container={};this.isCreate=false};e.prototype.insert=function(){var C,B,A,z={};if(arguments.length>1&&!this.isCreate){B=arguments[0];A=arguments[1];try{Object.keys(this.container).forEach(function(D){if(B.length>0&&!D.indexOf(B)){delete this.container[D]}else{if(D.length>0&&!B.indexOf(D)){throw z}}},this)}catch(y){if(y===z){return}}C=this.container[B];if(!C){C={path:B,data:A};this.container[B]=C}else{Object.keys(A).forEach(function(D){C.data[D]=A[D]})}}else{this.isCreate=true;this.container=arguments[0]}};e.prototype.stringify=function(){var y=[];if(!this.isCreate){Object.keys(this.container).forEach(function(z){y.push(this.container[z])},this)}else{y=this.container}return JSON.stringify(y)};b=function(A,D,z,y){var C,B;if(D){B=D(z)}if(y){C=A.fire(y,z);B=B||C.isDefaultPrevented||C.defaultPrevented}if(B){if(z&&z.preventDefault){z.preventDefault()}else{if(i.console&&i.console.warn){i.console.warn("sp-webservice: cannot prevent",z)}}}return B};u=function(z){var y;z.uri=z.uri||this.uri;z.verb=z.verb||"GET";z.success=z.success||this._getSuccessCodes();if(z.wait===undefined){z.wait=this.wait}if(z.retries===undefined){z.retries=this.retries}if(z.ignoreFlush===undefined){z.ignoreFlush=this.ignoreFlush}if(z.disableDefaultHeaders===undefined){z.disableDefaultHeaders=this.disableDefaultHeaders}y=new p(z);y.beforeSend=function(A){return b(this,z.beforeSend,A,g.REQUEST)}.bind(this);y.beforeRetry=function(A){return b(this,z.beforeRetry,A,g.RETRY)}.bind(this);y.onComplete=function(A){if(this.JS.isConsoleAvailable()&&this.JS.isInDebug()){(function(B){console.groupCollapsed("-----------DEBUG--STATEMENT-----------"+B.JS.generateDebugId()+" sp-webservice: httpRequest.onComplete");console.debug("Context");console.log(B);console.debug("Info");console.log(A);console.groupEnd()}(this,i))}return b(this,z.onComplete,A,g.RESPONSE)}.bind(this);y.onError=function(A){var B=this;if(this.JS.isConsoleAvailable()&&this.JS.isInDebug()){(function(C){console.groupCollapsed("-----------DEBUG--STATEMENT-----------"+C.JS.generateDebugId()+" sp-webservice: httpRequest.onError");console.debug("Context");console.log(C);console.debug("Info");console.log(A);console.groupEnd()}(this,i))}if(z.hasOwnProperty("onSessionTimeout")&&c(A.xhr)){this.sendSessionTimeoutRequest({onError:function(){b(B,z.onError,A,g.ERROR)},onSessionTimeout:function(){b(B,z.onSessionTimeout,A,g.SESSIONTIMEOUT)}})}else{b(B,z.onError,A,g.ERROR)}}.bind(this);y.onCancel=function(A){var B=this;if(this.JS.isConsoleAvailable()&&this.JS.isInDebug()){(function(C){console.groupCollapsed("-----------DEBUG--STATEMENT-----------"+C.JS.generateDebugId()+" sp-webservice: httpRequest.onError");console.debug("Context");console.log(C);console.debug("Info");console.log(A);console.groupEnd()}(this,i))}b(B,z.onCancel,A,g.ABORT)}.bind(this);y.onAbort=function(A){var B=this;if(this.JS.isConsoleAvailable()&&this.JS.isInDebug()){(function(C){console.groupCollapsed("-----------DEBUG--STATEMENT-----------"+C.JS.generateDebugId()+" sp-webservice: httpRequest.onError");console.debug("Context");console.log(C);console.debug("Info");console.log(A);console.groupEnd()}(this,i))}b(B,z.onError,A,g.ABORT)}.bind(this);if(z.headersPreparedPromise){z.headersPreparedPromise.then(function(){y.headers=z.headers;y.send(z.data)})}else{y.send(z.data)}return y};f=function(z){var y;y=new p({uri:this.parseUri("licence").prefix+"/license",verb:"GET",success:[s],onComplete:function(A){if(c(A.xhr)){z.onSessionTimeout()}else{z.onError()}},onError:z.onSessionTimeout});y.send()};k=function(){var y=p.pendingRequests,A,z;for(A in y){if(y.hasOwnProperty(A)){z=y[A];if(z.verb!=="GET"&&z.verb!=="HEAD"){return true}}}return false};j=function(z){var y=/^[0-9A-z\u00C0-\u00ff\s'"\.,-\/#!$%\^&\*;:{}=\-_`~()<>]+$/.test(z)?z:encodeURIComponent(z);return y};m=function(A){var z="",y="",B;if(!A){return}if(!w(A)){z=this.$.dashboard.getMcsUri()+"/resources/slmservices"}B=A.match(/\?.*/);if(B){y=B.join("").split("/")[0]}return{prefix:z,href:A,postfix:y}};o={properties:{ERROR_RESPONSEPARSE:{value:function(){return l}},_hashTime:{value:null},_hash:{value:null},_uncommitedHash:{value:null},_uncommitedHashTable:{type:Array,value:[]},_hashTable:{type:Array,value:[]},abortGET:{type:Boolean,value:true},builduri:{type:Boolean,value:true,notify:true},checkTimeout:{type:Boolean,value:false,notify:true},data:{value:null,notify:true,observer:"_dataChanged"},fireTimeout:{type:Boolean,value:false,notify:true},getasap:{type:Boolean,value:false,notify:true},handlepostfix:{type:Boolean,value:true,notify:true},handleprefix:{type:Boolean,value:true,notify:true},instances:{value:function(){return d}},json:{type:Boolean,value:true,notify:true},retries:{type:Number,value:0,notify:true},success:{type:Array,value:function(){return[n]},notify:true},uri:{value:null,notify:true,observer:"_uriChanged"},wait:{type:Number,value:0,notify:true},ignoreFlush:false,disableDefaultHeaders:{type:Boolean,value:false}},created:function(){this.requests={}},attached:function(){d.push(this)},sendRequest:function(){return u.apply(this,arguments)},sendSessionTimeoutRequest:function(){return f.apply(this,arguments)},getData:function(B){var z=v.call(this,this.uri),A,y;A=function(C){var E;if(this.json){try{C.response=JSON.parse(C.response)}catch(D){C.response={error:l,raw:C.response};console.log(C);console.warn("Error while trying to parse the response")}}E=b(this,B,C);if(!E){this.data=C.response}this.asyncFire(g.DATAREADY,C);return false}.bind(this);y=function(){this.data={$state:r.FAILING}}.bind(this);if(this.data){this.set("data.$state",r.GETTING)}this.sendRequest({uri:z,verb:"GET",wait:0,data:null,headers:{pragma:"no-cache"},onComplete:A,onError:y})},flushAll:function(z,y){this.flushRequests(z,y)},flushAllPendingUpdates:function(A,y){var z=p.pendingRequests;Object.keys(z).forEach(function(C){var B=z[C];if(B.ignoreFlush){delete p.pendingRequests[B.id]}});return this.flushRequests(A,y)},flushRequests:function(A,y){var z=p.pendingRequests,C,D,B=this;C=Object.keys(z).length;D=function(E){return function(F,H,G){if(E){E.call(F,H,G)}}};if(!C){D(A)(this,null,true);return}Object.keys(z).forEach(function(F){var E=z[F],I,H,G;H=!--C;if(E.verb==="GET"&&B.abortGET){E.abort();D(A)(this,E,H);return}I=E.onComplete;G=E.onError;E.onComplete=function(){D(I)(this,E);D(A)(this,E,H)};E.onError=function(){D(G)(this,E);D(y)(this,E,H)};E.wait=0;if(!E.reqProcessing){E.send(E.payload)}})},hasPendingUpdates:function(){return k.apply(this,arguments)},encodeHeader:function(){return j.apply(this,arguments)},parseUri:function(){return m.apply(this,arguments)},getMcsURI:function(){return t.apply(this,arguments)},isInDashboard:function(){return x.apply(this,arguments)},_uriChanged:function(){var z={},A;if(this.getAttribute("builduri")!=="false"){this._hashTable=[];this._uncommitedHashTable=[]}else{this._hash=null;this._uncommitedHash=null}if(!this.getasap||!this.uri){if(!this.data){this.data={}}return}try{A=this.uri.match(/{{ *[^ (}]+ *}}/g);if(A){A.forEach(function(C){var B=this.templateInstance.model;C=C.replace(/{{ */,"").replace(/ *}}/,"");C=C.split(/\./);C.forEach(function(D){if(!B[D]){throw z}B=B[D]})},this)}}catch(y){if(y===z){return}else{console.warn(y);console.trace(this)}}this.getData()},_dataChanged:function(){if(this.getAttribute("builduri")!=="false"){this._uncommitedHashTable=[];if(this.data&&this.data.forEach){this.data.forEach(function(y){this._hashTable[y.id]=y}.bind(this))}else{if(!this.data){this._hashTable=[]}}}else{this._uncommitedHash=null;this._hash=q(this.data);this._hashTime=new Date().getTime()}},_sendAutoRequest:function(z){var D,C,y,A;y=this;if(this.getAttribute("builduri")!=="false"){this._uncommitedHashTable[z.uid]=q(z.payload);A=this._uncommitedHashTable[z.uid]}else{this._uncommitedHash=q(this.data);A=q(this.data)}D=z.reqId||A;C=this._buildURI(z.uid);var B=this.sendRequest({uri:C,data:JSON.stringify(z.payload),verb:z.verb,wait:z.wait,onComplete:function(){if(y.getAttribute("builduri")!=="false"){y._hashTable[z.uid]=A;if(y._uncommitedHashTable[z.uid]===A){y._uncommitedHashTable[z.uid]=null}}else{y._hash=A;if(y._uncommitedHash===y._hash){y._uncommitedHash=null}}y._hashTime=new Date().getTime();z.onComplete.apply(this,arguments)},onError:function(){if(y.getAttribute("builduri")!=="false"){y._hashTable[z.uid]=null;if(y._uncommitedHashTable[z.uid]===A){y._uncommitedHashTable[z.uid]=null}}else{y._hash=null;if(y._uncommitedHash===A){y._uncommitedHash=null}}},onCancel:function(){if(y.getAttribute("builduri")!=="false"){if(y._uncommitedHashTable[z.uid]===A){y._uncommitedHashTable[z.uid]=null}}else{if(y._uncommitedHash===A){y._uncommitedHash=null}}}});this.requests[D]=B;return B},_onUpdate:function(y){var B=y.detail,G,C,E,D,H,F,A;H=(this.getAttribute("builduri")!=="false");G=H?B.child:B.payload;C=H?q(B.child):q(this.data);F=H?this._uncommitedHashTable[B.uid]:this._uncommitedHash;A=H?this._hashTable[B.uid]:this._hash;E=this.requests[C];D=this.requests[F];if(F===C){var z=E.onComplete;E.onComplete=function(I){z(I);if(B.payload.onUpdate){B.payload.onUpdate(E)}}}else{if((F===null)&&(A===C)&&(new Date().getTime()-this._hashTime<10000)){this.set("data.$state","");if(B.payload.onUpdate){B.payload.onUpdate(E)}}else{if(D&&D.reqProcessing===null){D.abort()}this._sendAutoRequest({uid:B.uid,reqId:C,verb:"PUT",payload:G,wait:3000,onComplete:function(I){if(B.payload.onUpdate){B.payload.onUpdate(I)}}})}}},_onCreate:function(z){var y=z.detail,A=y.payload;this._sendAutoRequest({uid:y.uid,verb:"POST",payload:A,wait:0,onComplete:function(B){if(A.onCreate){A.onCreate(B)}}})},_onDestroy:function(z){var y=z.detail,A=y.payload;this._sendAutoRequest({uid:y.uid,verb:"DELETE",payload:null,wait:0,onComplete:function(B){if(A.onDestroy){A.onDestroy(B)}}})},_buildURI:function(B){var z,A,y;z=this.uri;if(this.getAttribute("builduri")!=="false"){A="/"+B;if(!new RegExp(A).test(z)){y=z.split("?");y[0]+=A;z=y.join("?")}}z=v.call(this,z);return z},_getSuccessCodes:function(){var y;if(typeof this.success!=="object"){y=[];this.success.toString().split(",").forEach(function(z){y.push(parseInt(z,10))})}else{y=this.success}return y},_isAbsoluteURI:w,Payload:e,HTTPRequest:p,listeners:{update:"_onUpdate",create:"_onCreate",destroy:"_onDestroy"}};i.DS.SMAProcSP.SPWebservice=o;Polymer({is:"sp-webservice",behaviors:[i.DS.SMAProcSP.SPBase,o]})}(this));