/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
(function(f){var a=f.Polymer;var c=401;var b=null;var e=null;var d={};b=function(i){if(!f.DOMParser){return null}var j=new f.DOMParser();var g;try{g=j.parseFromString(i,"text/xml")}catch(h){g=null}return g};e=function(g){var h={response:g.response,responseText:String(g.response),responseXML:null},i=g.headers;if(i&&/xml/.test(i.Accept)&&h.responseText){h.responseXML=b(h.responseText)}return h};a({is:"sp-cosservice",behaviors:[f.DS.SMAProcSP.SPBase,f.DS.SMAProcSP.SPWebservice],properties:{cosServerId:{type:String,notify:true,observer:"_cosServerIdChanged"},objectId:{type:String,value:null,notify:true},cosTicketUrl:{type:String}},parseUri:function(i){this._getDefaultServerIdIfNoneSet();var h=this.$.spCos.getUrlForServer(this.cosServerId);var g=""+new URL(h+"/"+i);var j=f.DS.SMAProcSP.SPWebservice.parseUri.call(this,g);return j},sendRequest:function(o){var l=this,g,j,h,m,i,k=null,n;o=o||{};g=o.uri||this.uri||"";j=(o.objectId)?o.objectId:l.objectId;h=(o.serverId)?o.serverId:l.cosServerId;n=o.onComplete;k=o.onError;m=function(){o.onComplete=n;o.onError=k};i=function(){o.onComplete=function(p){m();if(o.onComplete){o.onComplete(p)}};o.onError=function(p){if(c===p.status){l.$.spCosticket.getServerTicket(h,j,true,function(q,r){o.headers=o.headers||{};o.headers.EEDTicket=r;m();f.DS.SMAProcSP.SPWebservice.sendRequest.call(l,o)},function(q,r){m();if(o.onError){o.onError({status:r})}})}else{m();if(o.onError){o.onError(p)}}};if(j){l.$.spCosticket.getServerTicket(h,j,false,function(p,q){o.headers=o.headers||{};o.headers.EEDTicket=q;f.DS.SMAProcSP.SPWebservice.sendRequest.call(l,o)},function(p,q){m();if(o.onError){o.onError({status:q})}})}else{f.DS.SMAProcSP.SPWebservice.sendRequest.call(l,o)}};if(!l._isAbsoluteURI(g)){l.$.spCos.getCosConfiguration({onComplete:function(){l._getDefaultServerIdIfNoneSet();var q=l.$.spCos.getUrlForServer(h);if(q&&!/\/$/.test(q)){q+="/"}try{o.uri=""+new URL(g,q);i()}catch(p){if(o.onError){o.onError({status:-1,response:(p?p.message:"sp-coservice failed to get uri")})}}},onFailure:function(p){if(o.onError){o.onError({status:-1,response:(p?p.message:"")})}}})}else{if(h){l.cosServerId=h}else{l._getDefaultServerIdIfNoneSet()}o.uri=g;i()}return null},getCOSPubkey:function(g){return new Promise(function(l,k){var o=null,i=null,n=function(q){var r=e(q);var p=r.responseXML.getElementsByTagName("KeyRep")[0].childNodes[0].nodeValue;d[g]=p;l(p)},j=function(q){var p={status:q.status,response:q.response,uri:q.status};k(p)};if(d[g]){l(d[g]);return}try{o={Accept:"application/xml"};i={verb:"GET",headers:o,onComplete:n,onError:j};i.serverId=g;i.uri="execution/pubkey";i.headers=o;this.sendRequest(i)}catch(m){var h={status:"Runtime Error",response:m.message,uri:null};k(h)}}.bind(this))},_getDefaultServerIdIfNoneSet:function(){if(!this.cosServerId){this.cosServerId=this.$.spCos.getDefaultServerId()}},_cosServerIdChanged:function(){this.cosTicketUrl=this.$.dashboard.getMcsUri()+"/resources/eepservices/cos/configurations/"+this.cosServerId+"/ticket"},_spCosticketErrorHandler:function(g){if(g&&g.stopPropagation){g.stopPropagation()}},unauthorizedAccessHandler:function(g){if(g&&g.stopPropagation&&g.detail&&g.detail.status===c){g.stopPropagation()}},listeners:{error:"unauthorizedAccessHandler"}})}(this));