/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
window.require(["UWA/Class/Promise","UWA/Utils"],function(d,f){var y=null,l=null,j=null,A=null,i=null,B=null,g=null,r=null,m=null,q=null,C=null,x=null,n=null,z=null,s=null,e=null,a=null,v=null,p=null,o=null,k=null,u=null,b=null,h=null,c=window.Promise||d,w
/*! ENABLE PRIVATE STATION */
,t=true
/*! END ENABLE PRIVATE STATION */
;b={success:"success",error:"error"};h={PRIVATE_STATION_USER_MISMATCH:600,PRIVATE_STATION_NO_USER_FOUND:601,PRIVATE_STATION_SERVER_MISMATCH:602,PRIVATE_STATION_NO_STATION_FOUND:603,ENCRYPTION_FAILED:604,RUNTIME_ERROR:605};y=function(F){if(!window.DOMParser){return null}var G=new window.DOMParser();var D;try{D=G.parseFromString(F,"text/xml")}catch(E){D=null}return D};l=function(F){if(!window.XMLSerializer){return F&&F.xml||""}var D=new window.XMLSerializer();var E;try{E=D.serializeToString(F)}catch(G){E=""}return E};j=function(D){var E={response:D.response,responseText:String(D.response),responseXML:null},F=D.headers;if(F&&/xml/.test(F.Accept)&&E.responseText){E.responseXML=y(E.responseText)}return E};A=function(E){var D=null;try{D=window.top.curUserId;if(D&&E.onComplete){E.onComplete(D)}else{require(["DS/PlatformAPI/PlatformAPI","DS/UWPClientCode/PublicAPI"],function(G){D=G.getUser()?G.getUser().login:null;if(E.onComplete){E.onComplete(D)}},function(G){if(E.onFailure){E.onFailure(G)}})}}catch(F){if(E.onFailure){E.onFailure(F)}}};i=function(D){return c.resolve(D)};B=function(H,I,K,G,F,D,E){var J={that:this,mcsURL:this.mcsURL||this.$.spDashboard.getMcsUri(),jobUrl:this.jobUrl,jobData:this.jobData,runInfo:this.runInfo,tenantID:this.tenantID,EEDTicket:null,MCSTicket:null,pubkey:null,pubkeyValue:null,EEDJobID:null,MCSJobID:null,ApplicationData:null,hasLocalStation:false,privateStationUri:null,objectID:I,credentials:F,resourceCredentials:null,stepID:K,allowMultipleJobs:G,appName:D?D:null,cosServerID:E?E:this.$.spCos.getDefaultServerId(),context:H,error:null};return c.resolve(J)};g=function(G,F,J,K,I,H,L,D){var E={that:this,EEDTicket:K,MCSTicket:null,mcsURL:this.mcsURL||this.$.spDashboard.getMcsUri(),pubkey:null,pubkeyValue:null,EEDJobID:null,executionXML:F,runInfo:this.runInfo,ApplicationData:H,hasLocalStation:Boolean(L),privateStationUri:null,objectID:J,credentials:I,resourceCredentials:null,cosServerID:D?D:this.$.spCos.getDefaultServerId(),context:G,error:null};return c.resolve(E)};r=function(D){return new c(function(I,H){var K=function(M){var N=j(M);var L=JSON.parse(N.responseText);if(L&&L.results&&L.results[0]&&L.results[0].id){D.objectID=L.results[0].id;I(D)}else{D.error={status:400,response:"Failed to get user login ID",uri:null};H(D)}},G=function(L){D.error={status:L.status,response:L.response,uri:L.status};H(D)},E=function(M){var L=null,O=null,P=null,N=null;L=D.that.$.user_id_ws;O=D.that.$.spDashboard.getMcsUri()+L.uri.replace("<login>",M);P={Accept:"application/json"};N={uri:O,verb:"GET",headers:P,onComplete:K,onError:G};L.sendRequest(N)};try{var F=null;try{F=window.top.curUserId}catch(J){}if(F){E(F)}else{require(["DS/PlatformAPI/PlatformAPI"],function(L){F=L.getUser()?L.getUser().login:null;E(F)},function(L){D.error={status:400,response:"Failed to get user login",uri:null};H(D)})}}catch(J){D.error={status:h.RUNTIME_ERROR,response:J.message,uri:null};H(D)}})};m=function(D){return new c(function(E){if(!D.ApplicationData&&D.ApplicationData!==null){D.ApplicationData='<JobInfo><Application name="sprun" updatePLM="false" stations=""><PLMObject physicalid="'+D.objectID+'"></PLMObject><AppUrl>'+D.that.$.spDashboard.getMcsUri()+"</AppUrl><AppResource>/resources/slmservices</AppResource><HasLocalHost>"+D.hasLocalStation+"</HasLocalHost></Application></JobInfo>"}E(D)})};q=function(D){return new c(function(M,N){var K=false,J=null,G=null,F=null,L=null,O=null,H=function(P){var Q=j(P);D.ApplicationData=(Q.responseText||"").replace(/(\r\n|\n|\r)/gm,"");D.EEDTicket=Q.responseXML.getElementsByTagName("EEDTicket")[0].childNodes[0].nodeValue;D.MCSJobID=Q.responseXML.getElementsByTagName("PLMObject")[0].attributes.physicalid.value;K=Q.responseXML.getElementsByTagName("HasLocalHost");D.hasLocalStation=Boolean(K&&K.length>0&&K[0].textContent==="true");if(D.context&&(typeof D.context.forceHasLocalHost!==undefined)&&D.context.forceHasLocalHost&&!D.hasLocalStation){D.hasLocalStation=true;D.ApplicationData=D.ApplicationData.replace("</Application>","<HasLocalHost>true</HasLocalHost></Application>")}if(D.tenantID){D.ApplicationData=D.ApplicationData.replace("</Application>","<TenantWU>"+D.tenantID+"</TenantWU></Application>")}M(D)},E=function(P){D.error={status:P.status,response:P.response,uri:P.status};N(D)};try{J=D.that.$.job_xml_ws;if(D.jobUrl&&(D.jobUrl.length>0)){G=D.that.$.spDashboard.getMcsUri()+D.jobUrl}else{G=D.that.$.spDashboard.getMcsUri()+J.uri}F={Accept:"application/xml","Content-Type":"application/ds-json"};L={simpid:D.objectID,MCSURL:D.mcsURL||D.that.$.spDashboard.getMcsUri(),stepID:D.stepID,multibuild:D.allowMultipleJobs};if(D.cosServerID){L.serverName=D.cosServerID}if(D.appName){L.appName=D.appName}if(D.jobData){L.jobData=D.jobData}O={uri:G,verb:"POST",data:JSON.stringify(L),headers:F,onComplete:H,onError:E};J.sendRequest(O)}catch(I){D.error={status:h.RUNTIME_ERROR,response:I.message,uri:null};N(D)}})};C=function(D){return new c(function(I,H){var F,G=null,E=D.that.$.spDashboard.getMcsUri();try{if(t&&D.hasLocalStation){D.that.$.spCos.requestCosVersionForServer(D.cosServerID,{onComplete:function(K){var M=418;var N=3;if(D.that.$.spCos.utils.isCosVersionSameOrNewer(K,M,N)){var L=D.that.$.spCos.getUrlForServer();D.that.$.spCos.getPrivateStationInfoMatched(D.mcsURL,L,D.cosServerID,{onComplete:function(P){if(P){var Q=P.info&&P.info.cosid;var O=D.that.$.spCos.getDefaultServerId();if(Q===D.cosServerID||Q===O){D.privateStationUri=P.uri;A({onComplete:function(S){if(P.info.user===S){var U=D.runInfo;var T=y(U);if(T){var R=T.getElementsByTagName("RunInfo");if(R&&R.length>0){R[0].setAttribute("submissionHost",P.info.name)}U=l(T);if(U){D.runInfo=U}}I(D)}else{D.error={status:h.PRIVATE_STATION_USER_MISMATCH,response:"Station user does not match connected user",uri:null};I(D)}},onFailure:function(R){D.error={status:h.PRIVATE_STATION_NO_USER_FOUND,response:"User login not found",uri:null};I(D)}})}}else{D.error={status:h.PRIVATE_STATION_SERVER_MISMATCH,response:"Private station COS server ID does not match job COS server",uri:null};I(D)}},onFailure:function(){D.error={status:h.PRIVATE_STATION_NO_STATION_FOUND,response:"No private station found",uri:null};I(D)}})}else{I(D)}},onFailure:function(L,K){var M=400;D.error={status:L.status||M,response:K,uri:null};I(D)}})}else{I(D)}}catch(J){D.error={status:h.RUNTIME_ERROR,response:J.message,uri:null};H(D)}})};x=function(D){return new c(function(K,L){var J=null,G=null,E=null,N=null,M=null,H=function(O){L(D)},F=function(O){D.error={status:O.status,response:O.response,uri:O.status};L(D)};try{if(t&&D.hasLocalStation&&D.error){if((typeof D.MCSJobID!=="undefined")&&D.MCSJobID){J=D.that.$.job_state_ws;E=String(Date.now());N=D.that.JS.toQueryString({State:"Done",CC:"Canceled",StartDate:E,EndDate:E});G=D.that.$.spDashboard.getMcsUri()+J.uri.replace("<jobId>",D.MCSJobID).replace("<stateparams>",N);M={uri:G,verb:"POST",onComplete:H,onError:F};J.sendRequest(M)}else{L(D)}}else{K(D)}}catch(I){D.error={status:h.RUNTIME_ERROR,response:I.message,uri:null};L(D)}})};n=function(D){return new c(function(J,I){var E=null,H=null,F=null,L=function(M){J(D)},G=function(M){D.error={status:M.status,response:M.response,uri:M.status};I(D)};try{if(D.privateStationUri){E=D.that.$.local_station_claim_ws;H=D.privateStationUri+E.uri.replace("<jobId>",D.EEDJobID);F={uri:H,onComplete:L,onError:G};E.sendRequest(F)}else{J(D)}}catch(K){D.error={status:h.RUNTIME_ERROR,response:K.message,uri:null};I(D)}})};z=function(E){var D=c.resolve(E);if(!E.credentials){D=D.then(e).then(a)}else{D=D.then(e).then(v).then(!E.credentials.encryptedCredentials?p:i)}return D};s=function(E){var D=c.resolve(E);delete E.credentials.credentialsEncrypted;D=D.then(e).then(v).then(function(F){return new c(function(H){var I=F.that.$.spEncryption;var G=I.encryptSingleCredential(I.ENCRYPTIONTYPES.MCS,"","",F.credentials.loginTicket,F.pubkeyValue);delete F.credentials.loginTicket;F.credentials.MCS=[];F.credentials.MCS.push(G);F.resourceCredentials=JSON.stringify(F.credentials);H(F)})});return D};e=function(D){return new c(function(I,H){var E=null,L=null,F=null,K=function(N){var P=j(N);var O=P.responseText;var M=P.responseXML.getElementsByTagName("KeyRep")[0].childNodes[0].nodeValue;O=O.replace(/(\r\n|\n|\r)/gm,"");D.pubkey=O;D.pubkeyValue=M;I(D)},G=function(M){D.error={status:M.status,response:M.response,uri:M.status};H(D)};try{E=D.that.$.cos_pubkey_ws;L={Accept:"application/xml"};if(D.EEDTicket){L.EEDTicket=D.EEDTicket}F={verb:"GET",headers:L,onComplete:K,onError:G};if(D.cosServerID){F.serverId=D.cosServerID}if(!D.EEDTicket&&D.objectID){F.objectId=D.objectID}E.sendRequest(F)}catch(J){D.error={status:h.RUNTIME_ERROR,response:J.message,uri:null};H(D)}})};a=function(D){return new c(function(K,L){var J=null,G=null,F=null,M=null,H=function(N){var O=j(N);D.resourceCredentials=O.responseText.trim();K(D)},E=function(N){D.error={status:N.status,response:N.response,uri:N.status};L(D)};try{J=D.that.$.encrypt_ws;G=D.that.$.spDashboard.getMcsUri()+J.uri;F={Accept:"*/*","Content-Type":"*/*"};M={uri:G,verb:"POST",headers:F,data:D.pubkey,onComplete:H,onError:E};J.sendRequest(M)}catch(I){D.error={status:h.RUNTIME_ERROR,response:I.message,uri:null};L(D)}})};v=function(D){return new c(function(L,M){var K=null,G=null,J=null,F=null,N=null,H=function(O){var P=j(O);D.credentials.loginTicket=JSON.parse(P.response).ticket;L(D)},E=function(O){D.error={status:O.status,response:O.response,uri:O.status};M(D)};try{J=D.that.$.mcs_ticket_ws;K=J.getSecurityContext();G=D.that.$.spDashboard.getMcsUri()+J.uri+"?ticket=dummy"+(K?"&runasctx="+encodeURIComponent(K):"");F={Accept:"application/json"};N={uri:G,verb:"POST",headers:F,onComplete:H,onError:E};J.sendRequest(N)}catch(I){D.error={status:h.RUNTIME_ERROR,response:I.message,uri:null};M(D)}})};p=function(D){return new c(function(G,F){try{var E=D.that.$.spEncryption.encryptCredentials(D.credentials,D.pubkeyValue);if(E){D.credentials.encryptedCredentials=E;G(D)}else{D.error={status:h.ENCRYPTION_FAILED,response:"Couldn't encrypt credentials",uri:null};F(D)}}catch(H){D.error={status:h.RUNTIME_ERROR,response:H.message,uri:null};F(D)}})};o=function(D){return new c(function(I,H){var E=null,L=null,F=null,K=function(N){var O=j(N);var M=JSON.parse(O.response);if(M&&M.JobInfoBrief){D.EEDJobID=M.JobInfoBrief.JobID}I(D)},G=function(M){D.error={status:M.status,response:M.response,uri:M.status};H(D)};try{E=D.that.$.run_ws;L={ResourceCredentials:D.resourceCredentials||D.credentials.encryptedCredentials,Accept:"application/json","Content-Type":"text/plain"};if(D.runInfo){L.RunInfo=E.encodeHeader(D.runInfo)}if(D.EEDTicket){L.EEDTicket=D.EEDTicket}if(D.ApplicationData){L.ApplicationData=E.encodeHeader(D.ApplicationData.replace(/(\n|\r)/gm,""))}if(D.objectID){L.ResourceId=E.encodeHeader(D.objectID)}F={verb:"POST",headers:L,onComplete:K,onError:G};if(D.cosServerID){F.serverId=D.cosServerID}if(D.executionXML){F.data=D.executionXML}else{F.data=null}if(!D.EEDTicket&&D.objectID){F.objectId=D.objectID}E.sendRequest(F)}catch(J){D.error={status:h.RUNTIME_ERROR,response:J.message,uri:null};H(D)}})};k=function(D){D.that.fire(b.success,{result:D})};u=function(D){D.that.fire(b.error,{status:D.error.status,url:D.error.uri,result:D,response:D.error.response})};window.DS.SMAProcSP.SPRun=Polymer({is:"sp-run",properties:{ERRORS:{type:Object,value:h,readOnly:true},jobData:{type:String,value:"",notify:true},mcsURL:{type:String,value:"",notify:true},jobUrl:{type:String,value:"",notify:true},runInfo:{type:String,value:"<RunInfo logLevel='Debug' submissionHost=''></RunInfo>",notify:true},tenantID:{type:String,value:"",notify:true},timeout:{type:Number,value:10000,notify:true}},attached:function(){w={};Object.keys(this.properties).forEach(function(D){if(!this[D]){var E=this.getAttribute(D);if(E){this[D]=E}}w[D.toLowerCase()]=D}.bind(this));delete w.timeout},getCOSPubkey:function(D){return e(D)},attributeChanged:function(D){if(w[D]){if(window.console&&window.console.warn){var E=w[D].replace(/[A-Z]/g,function(F){return"-"+F.toLowerCase()});window.console.warn("sp-run: attribute "+w[D]+" is no longer supported, please use "+E+" instead")}this[w[D]]=this.getAttribute(D)}},onWSError:function(D){D.stopPropagation();D.cancelBubble=true},runSimulation:function(G,H,I,F,D,E,J){return this.runSimulationAs(G,H,I,F,null,D,E,J)},runSimulationAs:function(H,I,J,G,F,D,E,K){B.call(this,H,I,J,G,F,D,E).then(q).then((!K)?C:i).then((!K)?x:i).then((F&&F.OS)?s:z).then(o).then(n).then(k)["catch"](u)},runEXML:function(F,E,I,J,H,G,K,D,L){g.call(this,F,E,I,J,H,G,K,D).then(!I?r:i).then((!L)?C:i).then((!L)?x:i).then((H&&H.OS)?s:z).then(m).then(o).then(n).then(k)["catch"](u)},behaviors:[window.DS.SMAProcSP.SPBase]});window.SPRun=window.DS.SMAProcSP.SPRun;window.DS.SMAProcSP.SPRun.ERRORS=window.DS.SMAProcSP.SPRun.ERRORS||h});