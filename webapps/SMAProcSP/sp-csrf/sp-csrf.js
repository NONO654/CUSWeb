/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
(function(b){var e=null,a="tenant",d=function(f,g){f.headers=f.headers||{};if(f.verb&&f.verb!=="GET"){f.headers.eno_csrf_token=g[0]}f.headers.SecurityContext=g[1]();return f},c=function(f){var g="",h=null;if(f.isInDashboard()){h=f.getCurrentPlatform();if(h){g="?"+a+"="+encodeURIComponent(h)}}return g};Polymer({is:"sp-csrf",properties:{},prepareHeaders:function(g){if(e){var f=e.then(function(h){d(g||{},h)})["catch"](function(h){this.fire(this.COMMON_EVENTS.ERROR,{message:"Unable to add csrf token. Error "+h,isFatal:true})}.bind(this));return f}else{if(g.verb&&g.verb!=="GET"){this.fire(this.COMMON_EVENTS.ERROR,{message:"sp-csrf : Component not initialized correctly",isFatal:true})}}},ready:function(){if(e===null){this.reset()}},reset:function(){e=false;this.$.csrfRequest.addEventListener("request",function(f){f.stopPropagation()});this.$.csrfRequest.addEventListener("response",function(f){f.stopPropagation()});e=b.Promise.all([new b.Promise(function(g,f){this.$.csrfRequest.sendRequest({uri:this.$.dashboard.getMcsUri()+"/resources/slmservices/token/CSRF"+c(this.$.dashboard),headers:{Accept:"text/plain"},onComplete:function(h){var i=h.response;g(i)},onError:function(h){f(h)}})}.bind(this)),new b.Promise(function(g,f){if(this.$.dashboard.isInDashboard()){g(this.$.dashboard.getSecurityContext)}else{this.$.csrfRequest.sendRequest({uri:this.$.dashboard.getMcsUri()+"/resources/pno/person/getsecuritycontext"+c(this.$.dashboard),onComplete:function(h){var i=JSON.parse(h.response);g(function(){return i.SecurityContext})},onError:function(h){f(h)}})}}.bind(this))])},behaviors:[b.DS.SMAProcSP.SPBase]})}(this));