(function(){var b="csrfTokenName",c="noOfFiles",d="__fcs__jobTicket",a="bfile0",i="fileName0",j="format0",g=window.Promise||require("UWA/Class/Promise"),e={csrfTokenName:"ENO_CSRF_TOKEN",number:"1",format:"generic"},f={},h={};window.DS.SMAProcSP=window.DS.SMAProcSP||{};window.DS.SMAProcSP.SPFileContent=Polymer({is:"sp-file-content",attached:function(){this.fire("sp-file-content-attached")},downloadFile:function(k,l,m,n){return this._getCheckoutTicket(k,l,"blob",m,n).then(this._fetchFileFromFCS.bind(this)).then(this._downloadToDisk.bind(this))},getFileContent:function(k,l,m){return this._getCheckoutTicket(k,l,m).then(this._fetchFileFromFCS.bind(this))},uploadFile:function(k){return this._getCheckinTicket(k).then(this._checkinFile.bind(this)).then(this._commit.bind(this))},createDocumentAndUploadFile:function(k){return this._getCheckinTicket(k).then(this._checkinFile.bind(this)).then(this._createDocument.bind(this)).then(this._commit.bind(this)).then(this._postProcessCreate.bind(this)).then(this._addAttributeGroup.bind(this))},deleteFile:function(m,l,k){return this._deleteFile(m,l,k)},removeReferenceContent:function(l,k,m){return this._removeReferenceContent(l,k,m)},getRelatedAttributeGroup:function(k){var l,m="";return new g(function(q,p){var r=function(s){try{l=JSON.parse(s.response);if(Object.prototype.hasOwnProperty.call(l,"success")&&l.success===true){try{m=l.datarecords.datagroups[0].dataelements.error.value[0].value}catch(u){}if(m===""){q(s.response)}else{p(s)}}else{p(s)}}catch(t){p(t)}},o=function(s){p(s)};var n={verb:"GET",headers:{Accept:"json",pragma:"no-cache"},uri:this.$.dashboard.getMcsUri()+"/resources/e6w/service/SMA_AttributeGroup?objectId="+k,onComplete:r,onError:o};this.$.mcsService.sendRequest(n)}.bind(this))},_postProcessCreate:function(k){return new g(function(m,l){if(k.createType==="Referenced"){this.addReferenceContent(k.simulationId,k.containerId,k.documentid,k.ioMode).then(function(){m(k)}.bind(this))["catch"](l)}else{m(k)}}.bind(this))},addReferenceContent:function(r,s,k,l){var n,p,o,t,m,q="";m=this.$.dashboard.getMcsUri()+"/resources/e6w/service/SMA_Content";return new g(function(v,u){n=function(w){try{o=JSON.parse(w.response);if(Object.prototype.hasOwnProperty.call(o,"success")&&o.success===true){try{q=o.datarecords.datagroups[0].dataelements.error.value[0].value}catch(y){}if(q===""){v(w)}else{u(w)}}else{u(w)}}catch(x){u(x)}};p=function(w){u(w)};t={verb:"POST",uri:m,onComplete:n,onError:p,headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"json"},data:"updateWidget="+encodeURIComponent(JSON.stringify(this._getCreateReferencePayLoad(r,s,k,l)))};this.$.mcsService.sendRequest(t)}.bind(this))},getContentInfo:function(k,m,l){if(m&&f[k]!==undefined&&!l){return g.resolve(f[k])}return new g(function(q,p){var r=function(s){if(m){f[k]=s.response}q(s.response)},o=function(s){p(s)};var n={verb:"GET",headers:{Accept:"json",pragma:"no-cache"},uri:this.$.dashboard.getMcsUri()+"/resources/slmservices/simulations/content?pid="+k,onComplete:r,onError:o};this.$.mcsService.sendRequest(n)}.bind(this))},_removeReferenceContent:function(q,r,k){var m,o,n,s,l,p="";l=this.$.dashboard.getMcsUri()+"/resources/e6w/service/SMA_Content";return new g(function(u,t){m=function(v){try{n=JSON.parse(v.response);if(Object.prototype.hasOwnProperty.call(n,"success")&&n.success===true){try{p=n.datarecords.datagroups[0].dataelements.error.value[0].value}catch(x){}if(p===""){u(v)}else{t(v)}}else{t(v)}}catch(w){t(w)}};o=function(v){t(v)};s={verb:"POST",uri:l,onComplete:m,onError:o,headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"json"},data:"updateWidget="+encodeURIComponent(JSON.stringify(this._getSMADisconnectPayload(q,r,k)))};this.$.mcsService.sendRequest(s)}.bind(this))},_deleteFile:function(l,m,k){return new g(function(q,p){var r=function(s){q(s.response)},o=function(s){p(s.response)};var n={verb:"DELETE",headers:{Accept:"json"},uri:this.$.dashboard.getMcsUri()+"/resources/slmservices/simulationdocuments/"+l+"/fileversion?version="+k+"&fileName="+m,onComplete:r,onError:o};this.$.mcsService.sendRequest(n)}.bind(this))},getSMAContentInfo:function(n,k,q,p,o){var l,m="";if(p&&h[k]!==undefined&&!o){return g.resolve(h[k])}return new g(function(u,t){var v=function(w){try{l=JSON.parse(w.response);if(Object.prototype.hasOwnProperty.call(l,"success")&&l.success===true){try{m=l.datarecords.datagroups[0].dataelements.error.value[0].value}catch(y){}if(m===""){if(p||o){h[k]=w.response}u(w.response)}else{t(w)}}else{t(w)}}catch(x){t(x)}},s=function(w){t(w)};var r={verb:"GET",headers:{Accept:"json",pragma:"no-cache"},uri:this.$.dashboard.getMcsUri()+"/resources/e6w/service/SMA_Content?SIMULATIONId="+n+"&containerId="+k+"&expandLevel="+q,onComplete:v,onError:s};this.$.mcsService.sendRequest(r)}.bind(this))},_getCheckoutTicket:function(l,k,p,s,n){var m=n||"download";var r=s||k;var o,q;return new g(function(w,v){var x=function(y){try{o=new DOMParser().parseFromString(y.response,"text/xml");q=o.getElementsByTagName("Ticket");w({fileName:q[0].getAttribute("Filename"),fcsURL:q[0].getAttribute("ActionURL"),exportTicket:q[0].getAttribute("ExportString"),responseType:p,downloadFileName:r})}catch(z){v(z)}},u=function(y){v(y)};var t={verb:"GET",headers:{Accept:"*/*",pragma:"no-cache"},uri:this.$.dashboard.getMcsUri()+"/resources/slmservices/data/ticket?oid="+l+"&fname="+k+"&action="+m,onComplete:x,onError:u};this.$.mcsService.sendRequest(t)}.bind(this))},_fetchFileFromFCS:function(k){return new g(function(m,l){window.require(["UWA/Ajax"],function(n){n.request(k.fcsURL+"/"+k.fileName,{headers:{"Content-Type":"application/x-www-form-urlencoded"},method:"POST",responseType:k.responseType,data:{__fcs__jobTicket:k.exportTicket},cors:true,onComplete:function(o){k.response=o;m(k)},onFailure:function(o){l(o)}})})})},_downloadToDisk:function(k){return new g(function(o){var m=new Blob([k.response]);var n=window.URL.createObjectURL(m);if(!(navigator.appVersion.indexOf("Trident/")>0)){var l=document.createElement("a");Polymer.dom(document.body).appendChild(l);l.style.display="none";l.href=n;l.download=k.downloadFileName;l.onload=function(){window.URL.revokeObjectURL(n)};this.async(function(){l.click();Polymer.dom(document.body).removeChild(l)},100)}else{window.navigator.msSaveOrOpenBlob(m,k.downloadFileName)}o()}.bind(this))},_getCheckinTicket:function(k){var m=k.policy?encodeURIComponent(k.policy):"";var l=k.count?k.count:"1";return new g(function(r,q){var p=this.$.dashboard.getMcsUri()+"/resources/e6w/service/SMA_Ticket?count="+l+"&policy="+m;var s=function(u){try{var t=JSON.parse(u.response);if(Object.prototype.hasOwnProperty.call(t,"success")&&t.success===true){k.fcstickets=[];t.datarecords.datagroups.forEach(function(w){k.fcstickets.push({fcsurl:w.dataelements.fcsurl.value[0].value,ticket:w.dataelements.ticket.value[0].value})});r(k)}else{q(u)}}catch(v){q(v)}},o=function(t){q(t)};var n={verb:"GET",headers:{Accept:"json",pragma:"no-cache"},uri:p,onComplete:s,onError:o};this.$.mcsService.sendRequest(n)}.bind(this))},_checkinFile:function(k){return new g(function(m,l){var n=new FormData(),o=new XMLHttpRequest();n.append(b,e.csrfTokenName);n.append(c,e.number);n.append(d,k.fcstickets[0].ticket);n.append(a,k.file);n.append(i,k.newFileName);if(k.format){n.append(j,k.format)}else{n.append(j,e.format)}o.onreadystatechange=function(){if(o.readyState!==4){return}k.responseText=o.responseText;if(o.status===200){m(k);delete this.$.checkin.HTTPRequest.pendingRequests[this.$.checkin.id]}else{l(k);delete this.$.checkin.HTTPRequest.pendingRequests[this.$.checkin.id]}}.bind(this);o.upload.addEventListener("progress",function(p){this.fire("sp-file-upload-progress",{fileInfo:k,uploaded:((p.loaded/p.total)*100)})}.bind(this),false);o.reqProcessing=true;this.$.checkin.HTTPRequest.pendingRequests[this.$.checkin.id]=o;o.open("POST",k.fcstickets[0].fcsurl,true);o.send(n)}.bind(this))},_commit:function(k){return new g(function(p,o){var n=this.$.dashboard.getMcsUri()+"/resources/e6w/service/SMA_Ticket";var q=function(s){try{var r=JSON.parse(s.response);if(Object.prototype.hasOwnProperty.call(r,"success")&&r.success===true){var v="";try{v=r.datarecords.datagroups[0].dataelements.error.value[0].value}catch(u){}if(v===""){p(k)}else{o(s)}}else{o(s)}}catch(t){o(t)}},m=function(r){o(r)};var l={verb:"POST",uri:n,onComplete:q,onError:m,headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"json"},data:"updateWidget="+encodeURIComponent(JSON.stringify(this._getCommitPostData(k)))};this.$.mcsService.sendRequest(l)}.bind(this))},_createDocument:function(k){if(k.createType==="Referenced"){return this._createStandAloneDocument(k)}else{return this._createOwnedDocument(k)}},_createOwnedDocument:function(q){var m,r,p,o;var l=q;var k,n="";return new g(function(t,s){r=function(u){try{k=JSON.parse(u.response);if(Object.prototype.hasOwnProperty.call(k,"success")&&k.success===true){try{n=k.datarecords.datagroups[0].dataelements.error.value[0].value}catch(w){}if(n===""){l.documentid=k.datarecords.datagroups[0].dataelements.contentId.value[0].value;t(l)}else{s(l)}}else{s(l)}}catch(v){s(v)}};p=function(u){s(u)};o=this.$.dashboard.getMcsUri()+"/resources/e6w/service/SMA_Content";m={verb:"POST",uri:o,onComplete:r,onError:p,headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"json"},data:"updateWidget="+encodeURIComponent(JSON.stringify(this._getDocumentCreatePayLoadOwned(q.simulationId,q.containerId,q.documentType,q.documentTitle,q.ioMode)))};this.$.mcsService.sendRequest(m)}.bind(this))},_createStandAloneDocument:function(p){var m,q,o,n,l;var k=p;return new g(function(s,r){q=function(t){try{l=JSON.parse(t.response);k.documentid=l.id;s(k)}catch(u){r(u)}};o=function(t){r(t)};n=this.$.dashboard.getMcsUri()+"/resources/slmservices/simulationdocuments";m={verb:"POST",uri:n,onComplete:q,onError:o,headers:{Accept:"json"},data:JSON.stringify({type:p.documentType,title:p.documentTitle})};this.$.mcsService.sendRequest(m)}.bind(this))},_addAttributeGroup:function(q){var m,r,p,o;var l=q;var k,n="";if(q.attributeGroupId!==undefined&&q.attributeGroupId!==null&&q.attributeGroupId.length>0){return new g(function(t,s){r=function(u){try{k=JSON.parse(u.response);if(Object.prototype.hasOwnProperty.call(k,"success")&&k.success===true){try{n=k.datarecords.datagroups[0].dataelements.error.value[0].value}catch(w){}if(n===""){t(l)}else{s(l)}}else{s(l)}}catch(v){s(v)}};p=function(u){s(u)};o=this.$.dashboard.getMcsUri()+"/resources/e6w/service/SMA_AttributeGroup";m={verb:"POST",uri:o,onComplete:r,onError:p,headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"json"},data:"updateWidget="+encodeURIComponent(JSON.stringify(this._getAddAttributeGroupPayload(q.documentid,q.attributeGroupId)))};this.$.mcsService.sendRequest(m)}.bind(this))}return g.resolve(q)},updateDocumentTitle:function(m,r){var l,q,p,o,k,n="";return new g(function(t,s){q=function(u){try{k=JSON.parse(u.response);if(Object.prototype.hasOwnProperty.call(k,"success")&&k.success===true){try{n=k.datarecords.datagroups[0].dataelements.error.value[0].value}catch(w){}if(n===""){t()}else{s()}}else{s()}}catch(v){s(v)}};p=function(u){s(u)};o=this.$.dashboard.getMcsUri()+"/resources/e6w/service/SMA_JobDetails";l={verb:"POST",uri:o,onComplete:q,onError:p,headers:{Accept:"json","Content-Type":"application/x-www-form-urlencoded"},data:"updateWidget="+encodeURIComponent(JSON.stringify(this._updateDocumentTitlePayload(m,r)))};this.$.mcsService.sendRequest(l)}.bind(this))},_getCommitPostData:function(k){var l=k.format?k.format:e.format;return{datarecords:{datagroups:[{updateAction:"CONNECT",objectId:k.documentid,dataelements:{comment:{value:[{value:k.comment}]},newName:{value:[{value:k.newFileName}]},name:{value:[{value:k.fileName}]},format:{value:[{value:l}]},receipt:{value:[{value:k.responseText.trim()}]}}}],name:"SMA_Ticket"},name:"SMA_Ticket"}},_getDocumentCreatePayLoadOwned:function(n,l,k,m,o){return{datarecords:{datagroups:[{updateAction:"CREATE",objectId:n,dataelements:{containerId:{value:[{value:l}]},type:{value:[{value:k}]},title:{value:[{value:m}]},ioMode:{value:[{value:o}]},multiOperation:{value:[{value:true}]}}}],name:"SMA_Content"},name:"SMA_Content"}},_getSMADisconnectPayload:function(l,k,m){return{datarecords:{datagroups:[{updateAction:"DISCONNECT",objectId:l,dataelements:{containerId:{value:[{value:k}]},contentId:{value:[{value:m}]}}}],name:"SMA_Content"},name:"SMA_Content"}},_getCreateReferencePayLoad:function(m,l,n,k){return{datarecords:{datagroups:[{updateAction:"CONNECT",objectId:m,dataelements:{containerId:{value:[{value:l}]},contentId:{value:[{value:n}]},ioMode:{value:[{value:k}]},multiOperation:{value:[{value:true}]}}}],name:"SMA_Content"},name:"SMA_Content"}},_getAddAttributeGroupPayload:function(k,l){return{datarecords:{datagroups:[{updateAction:"CONNECT",objectId:k,dataelements:{attributeGroupsIds:{value:[{value:l}]}}}],name:"SMA_AttributeGroup"},name:"SMA_AttributeGroup"}},_updateDocumentTitlePayload:function(k,l){return{datarecords:{datagroups:[{updateAction:"MODIFY",objectId:k,dataelements:{title:{value:[{value:l}]}}}],name:"SMA_JobDetails"},name:"SMA_JobDetails"}}})})();