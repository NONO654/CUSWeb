/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
(function(j){var h=j.Polymer,k=j.DS;var d=null,e=null,a=null,b=null,m=null,l=null,f="SMAProcSP.COSTickets",c="?physicalid=",n="eepservices/cos/configurations/",g={error:"error"},i=null;d=function(p,o){var q={serverID:p?p:null,physicalID:o?o:null};return q};e=function(){var o={},p=j.sessionStorage.getItem(f);if(p&&(p.length>0)){o=JSON.parse(p)}return o};a=function(p){var o=e.call(this),q=null;if(typeof o[JSON.stringify(p)]!=="undefined"){q=o[JSON.stringify(p)]}return q};b=function(p,q){var o=e.call(this);o[JSON.stringify(p)]=q;j.sessionStorage[f]=JSON.stringify(o)};m=function(){var o=e.call(this),q=null,p;q=Object.keys(o);for(p=0;p<q.length;p++){l.call(this,q[p],null,null)}i=j.setTimeout(m.bind(this),this.refreshInterval*1000)};l=function(v,p,o){var s=function(z){var y=null,B=null;if(/\s*{/.test(z.response)){try{y=JSON.parse(z.response);if(y){B=y.ticket}}catch(A){B=null}}else{B=z.response}if(B){b.call(this,v,B);if(p){p(B)}}else{this.fire(g.error,{status:null});if(o){o(null)}}}.bind(this);var u=function(y){this.fire(g.error,{status:y.status});if(o){o(y.status)}}.bind(this);var x=function(y){this.fire("sessiontimeout",y)}.bind(this);var q={};var r=null;if(this.cosTicketUrl){var w=this.cosTicketUrl.indexOf(n),t;if(w!==-1){if(v.serverID){w+=n.length;t=this.cosTicketUrl.indexOf("/",w);r=this.cosTicketUrl.slice(0,w);r+=v.serverID;r+=this.cosTicketUrl.slice(t);r+="?access=modify";if(v.physicalID){r+="&id="+v.physicalID}}else{r=this.cosTicketUrl+"?access=modify";if(v.physicalID){r+="&id="+v.physicalID}}q.Accept="text/plain";r+="&Timestamp="+Date.now()}else{r=this.cosTicketUrl+c+v.physicalID}}this.$.cos_ticket_ws.sendRequest({uri:r,headers:q,onComplete:s,onError:u,onSessionTimeout:x})};k.SMAProcSP.SPCOSTickets=h({is:"sp-costickets",properties:{cosTicketUrl:{value:null,type:String},refreshInterval:{type:Number,value:0,observer:"refreshIntervalChanged"}},getTicket:function(o,q,p,r){return this.getServerTicket(null,o,q,p,r)},getServerTicket:function(w,o,t,q,p){var s=d.call(this,w,o),u=null,v=function(x){if(q){q(o,x)}}.bind(this),r=function(x){if(p){p(o,x)}}.bind(this);if(!t){u=a.call(this,s)}if(!u){l.call(this,s,v,r)}else{v(u)}},refreshIntervalChanged:function(o){if(o>0){if(!i){m.call(this)}}else{if(i){j.clearTimeout(i);i=null}}},behaviors:[k.SMAProcSP.SPBase]})}(this));