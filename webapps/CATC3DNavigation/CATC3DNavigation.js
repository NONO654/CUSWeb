/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
(function(){var b=[];b.giveNavigationObject=function(c){var d;if(c&&c.context){d=null;b.some(function(e){if(e.context===c.context){d=e;return true}return false})}return d};b.getNavigationObject=function(c){var d=this.giveNavigationObject(c);if(d===null){d={context:c.context,onStart:null,onExit:null,controller:null,activated:false};b.push(d)}return d};define("DS/CATC3DNavigation/CATD3CBoxNavigation",["UWA/Core","UWA/Class","DS/VisuEvents/EventsManager","DS/Visualization/PathElement","DS/CAT3DComposeUtils/CAT3DCompose3DAnimation","DS/PADUtils/PADWSAccess","DS/Visualization/ThreeJS_DS","DS/Selection/PSOManager","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/WebappsUtils/WebappsUtils","DS/Visualization/Node3D","DS/Visualization/SceneGraphFactory","DS/Mesh/MeshUtils","DS/SceneGraphNodes/FixedSizeNode3D","DS/CATC3DNavigation/CATBreadCrumbs","DS/ApplicationFrame/CommandsManager","DS/CATWebUXTooltipManager/CATWebUXTooltipManager","DS/CAT3DComposeUtils/CATC3DDropManager","DS/SceneGraphNodes/AxisSystemNode","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/CAT3DComposeWidget/CAT3DComposeWidgetOptions","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(M,D,s,S,A,j,R,f,z,x,P,X,U,E,u,I,O,G,t,r,N,w,B){var F=function(aa){this.pts=[new R.Vector3(),new R.Vector3(),new R.Vector3(),new R.Vector3(),new R.Vector3(),new R.Vector3(),new R.Vector3(),new R.Vector3()];this.vecU=new R.Vector3();this.vecV=new R.Vector3();this.vecW=new R.Vector3();if(aa){this.pts[0].set(aa.min.x,aa.min.y,aa.min.z);this.pts[1].set(aa.max.x,aa.min.y,aa.min.z);this.pts[2].set(aa.min.x,aa.max.y,aa.min.z);this.pts[3].set(aa.max.x,aa.max.y,aa.min.z);this.pts[4].set(aa.min.x,aa.min.y,aa.max.z);this.pts[5].set(aa.max.x,aa.min.y,aa.max.z);this.pts[6].set(aa.min.x,aa.max.y,aa.max.z);this.pts[7].set(aa.max.x,aa.max.y,aa.max.z);this.vecU.subVectors(this.pts[1],this.pts[0]);this.vecV.subVectors(this.pts[2],this.pts[0]);this.vecW.subVectors(this.pts[4],this.pts[0])}};F.prototype={constructor:F,copy:function(ab){for(var aa=0;aa<8;++aa){this.pts[aa].copy(ab.pts[aa])}this.vecU.copy(ab.vecU);this.vecV.copy(ab.vecV);this.vecW.copy(ab.vecW);return this},clone:function(){return new this.constructor().copy(this)},center:function(ab){var aa=ab||new R.Vector3();return aa.set((this.pts[0].x+this.pts[7].x)*0.5,(this.pts[0].y+this.pts[7].y)*0.5,(this.pts[0].z+this.pts[7].z)*0.5)},applyMatrix4:function(aa){for(var ac=0;ac<8;++ac){this.pts[ac].applyMatrix4(aa)}var ab=new R.Matrix4().extractRotation(aa);this.vecU.applyMatrix4(ab);this.vecV.applyMatrix4(ab);this.vecW.applyMatrix4(ab);return this},containsPoint:function(aa){if(aa.x<this.pts[0].x||aa.x>this.pts[7].x||aa.y<this.pts[0].y||aa.y>this.pts[7].y||aa.z<this.pts[0].z||aa.z>this.pts[7].z){return false}return true},minX:function(){var aa=this.pts[0].x;for(var ab=1;ab<8;++ab){aa=Math.min(aa,this.pts[ab].x)}return aa},maxX:function(){var ab=this.pts[0].x;for(var aa=1;aa<8;++aa){ab=Math.max(ab,this.pts[aa].x)}return ab},minY:function(){var ab=this.pts[0].y;for(var aa=1;aa<8;++aa){ab=Math.min(ab,this.pts[aa].y)}return ab},maxY:function(){var ab=this.pts[0].y;for(var aa=1;aa<8;++aa){ab=Math.max(ab,this.pts[aa].y)}return ab},minZ:function(){var ab=this.pts[0].z;for(var aa=1;aa<8;++aa){ab=Math.min(ab,this.pts[aa].z)}return ab},maxZ:function(){var ab=this.pts[0].z;for(var aa=1;aa<8;++aa){ab=Math.max(ab,this.pts[aa].z)}return ab},min:function(){var ab=new R.Vector3().copy(this.pts[0]);for(var aa=1;aa<8;++aa){ab.x=Math.min(ab.x,this.pts[aa].x);ab.y=Math.min(ab.y,this.pts[aa].y);ab.z=Math.min(ab.z,this.pts[aa].z)}return ab},max:function(){var aa=new R.Vector3().copy(this.pts[0]);for(var ab=1;ab<8;++ab){aa.x=Math.max(aa.x,this.pts[ab].x);aa.y=Math.max(aa.y,this.pts[ab].y);aa.z=Math.max(aa.z,this.pts[ab].z)}return aa}};var q=function(){var ae,af,aa,ab,ac,ad;this.store=function(ah,ag){var aj=ag?new R.Matrix4().getInverse(ag):null,ai=aj?new R.Matrix4().extractRotation(aj):null;ae=ah.getEyePosition();if(aj){ae.applyMatrix4(aj)}af=ah.getUpDirection();if(ai){af.applyMatrix4(ai)}aa=ah.getSightDirection();if(ai){aa.applyMatrix4(ai)}ab=ah.getTargetDistance();ac=ah.getProjectionType();ad=ah.getAngle()};this.restore=function(ai,ag){if(ae){var ah=ag?new R.Matrix4().extractRotation(ag):null;ai.moveTo({eyePosition:ag?ae.applyMatrix4(ag):ae,upDirection:ah?af.applyMatrix4(ah):af,sightDirection:ah?aa.applyMatrix4(ah):aa,distanceToTarget:ab});ai.setProjectionType(ac);ai.setAngle(ad)}}};q.prototype={constructor:q};Object.freeze(q);var d=function(ad){var ab,aa,ac,af,ae=ad&&ad.externalPath.length>1;for(ab=0,aa=ad.externalPath.length-1;ae&&ab<aa;++ab){ac=ad.externalPath[ab];af=ad.externalPath[ab+1];if(ac.children.indexOf(af)<0){ae=false}}return ae};var v=function(ab){if(!ab){return false}if(B.isReference(ab)){return true}var aa=B.getNodeType(ab);if(aa==="CATDrawing"||aa==="Drawing"||aa==="CATAnalysis"||aa==="CATProcess"){return true}return false};var k=function(ab){if(!ab){return false}if(B.isInstance(ab)){return true}var aa=B.getNodeType(ab);if(aa==="CatDrawing"||aa==="CatAnalysis"||aa==="CatProcess"){return true}return false};var n=-1,C=144,e=108,V=0.000001,y=w.getOption("C3DSTR"),T=new R.Vector3(0,0,1),Q=new R.Vector3(1,0,0),Y=new R.Vector3(-1,0,0),o=Math.PI,L=0.5*Math.PI,K=0.25*Math.PI,W=0.75*Math.PI,p=new R.Color("rgb(202,202,202)").getHex(),m=new R.Color("rgb(54,142,196)").getHex(),c=0,h,i,H={},J=new R.MeshBasicMaterial({map:new R.ImageUtils.loadTexture(P.getWebappsAssetUrl("CATC3DNavigation","icons")+"/iconLargeDefault.png",undefined,null,null,true),side:R.DoubleSide,force:true,transparent:true}),l=new R.MeshBasicMaterial({map:new R.ImageUtils.loadTexture(P.getWebappsAssetUrl("CATC3DNavigation","icons")+"/iconLargeDefault.png",undefined,null,null,true),side:R.DoubleSide,force:true,transparent:true});function g(){h=new R.MeshBasicMaterial({color:p,opacity:0.95});i=new R.MeshBasicMaterial({color:m,opacity:0.95});h.line=i.line=new R.LineBasicMaterial({color:c,opacity:0.95});h.force=i.force=true}g();var Z=D.extend({init:function(aM){var aI=aM.context,a6=aI.getViewer(),ay=a6.getSceneGraphOverrideSetManager(),a1,aV=false,an,aG,ak,ao,a9=aI.getRootBagPath().getLastElement(true),ad,bb=A.get3DComposeAnimationEngine({viewer:a6}),aR={},al=[],aP,aW,at,ag,aH,ax,a5,a4,aQ=[],ba,aK,a7;function aT(be,bd,bi){var bc=be.pathElement.getLastElement(true);if(bc&&bc.navigationAssociatedPath){if(bd===2){be.pathElement=bc.navigationAssociatedPath.clone()}else{be.pathElement=new S(be.pathElement.externalPath.slice(0,3))}}else{if(be.pathElement.externalPath[0]===a9){if(bd===1&&bi){var bh=aR.levels[aR.levels.length-1].node.getChildByName("EmptyNodes");if(bh){bh.getChildren().some(function(bj){if(bj.children.length&&be.pathElement.isAParentOf(bj.navigationAssociatedPath)){var bk=M.extend({},be,false);bk.pathElement=new S([aR.levels[aR.levels.length-1].node,bh,bj,bj.children[0]]);if(!z.isIn(bk)){z.add(bk)}return true}return false})}}var bg=ak.clone(),bf=ak.getLastElement(true);if(be.pathElement.externalPath.length>bg.externalPath.length){bg.addElement(be.pathElement.externalPath[bg.externalPath.length]);if(bf!==a9&&be.pathElement.externalPath.length>bg.externalPath.length){bg.addElement(be.pathElement.externalPath[bg.externalPath.length])}be.pathElement=bg}}}return be}function aw(be,bc,bd){if(Array.isArray(be)){be.forEach(function(bf){aT(bf,bc,bd)})}else{aT(be,bc,bd)}}function au(bc){aw(bc,0,true)}function aA(bc){aw(bc,1,true)}function aF(bc){aw(bc,2,true)}function ah(bc){aw(bc,1,false)}function aq(bc){return aT({pathElement:bc},2,true).pathElement}function ai(bg){if(!bg||!bg.completed){return}if(!bg.arrayPath||bg.arrayPath.length!==1||!bg.token){bg.completed();return}var bh=aq(bg.arrayPath[0]);if(!bh){bg.completed();return}var bc=bh.getLastElement(true),bd=bc?B.getNodeID(bc):undefined,bf;if(!bd){bg.completed();return}if(bh.externalPath.length>1&&B.isInstance(bh.externalPath[bh.externalPath.length-2])){bf=B.getNodeID(bh.externalPath[bh.externalPath.length-2])}var be=[bd];if(bf){be.push(bf)}aI.getController().getAttributes({ids:be,attributes:["ds6w:label","type_icon_url"],callbacks:{onComplete:function(bi){var bl,bk=bi[bd]?bi[bd]["ds6w:label"]:"";if(bf&&bi[bf]&&bi[bf]["ds6w:label"]){bk+=" ("+bi[bf]["ds6w:label"]+")"}if(bk&&(typeof bk==="string")&&bk.trim().length!==0){bl=M.createElement("div");bl.setText(bk);var bj=bi[bd].type_icon_url;if(bj&&(typeof bj==="string")&&bj.length>0){bl.setStyles({"background-image":"url("+bj+")","background-repeat":"no-repeat","background-position-y":"center"});bl.setStyle("padding-left","21px")}}bg.completed({token:bg.token,div:bl})},onFailure:function(){bg.completed({token:bg.token})}}})}function aU(){if(!aW){aW=new q();aI.getFrameWindow().getViewpoint().reframe(null)}else{aW.restore(aI.getFrameWindow().getViewpoint(),ak.getWorldMatrix())}}function aE(be,bd){var bc=a1.createOverride({pathes:be});bd.push(bc);return bc}function a8(bg){var bc=bg.getLastElement(true),bd=ay.getCurrentVisibility(bg)===true?0:(ay.getCurrentVisibilityFree(bg)===true?-1:1);if(v(bc)||B.is3DLeaf(bc)){return bd}var be=bc.getChildren();if(be.length!==1){M.log("Instance or RepInstance with no or more than one Reference or RepReference");return bd}var bf=bg.clone();bf.addElement(be[0]);return ay.getCurrentVisibility(bf)===true?0:(ay.getCurrentVisibilityFree(bf)===true?-1:1)}function aj(bc,bf){if(!bc){return undefined}var bd=null,be=bc.angleTo(bf);if(be>V&&(o-be)>V){bd=new R.Matrix4();if(be<=L||(be-L)<V){bd.makeRotationAxis(new R.Vector3().crossVectors(bc,bf).normalize(),be)}else{bd.makeRotationAxis(new R.Vector3().crossVectors(bc,bf).normalize().negate(),o-be)}}return bd}function af(bc,bd,bk){if(!y){return undefined}var bi=bc.clone(),bl,bp;var bj=bi.vecU.length(),bh=bi.vecV.length(),bg=bi.vecW.length();var be,bo=bi.vecU,bn=bi.vecV,bm=bi.vecW,bf;if(bk){bf=bm.angleTo(T);if(bf>V){bl=new R.Matrix4().makeRotationAxis(new R.Vector3().crossVectors(bm,T).normalize(),bf);bi.applyMatrix4(bl)}bf=bo.angleTo(Q);if(bf>V&&(o-bf)>V&&Math.abs(bf-L)>V){bp=new R.Matrix4();if(bf<=K){bp.makeRotationAxis(new R.Vector3().crossVectors(bo,Q).normalize(),bf)}else{if(bf>=W){bp.makeRotationAxis(new R.Vector3().crossVectors(bo,Y).normalize(),o-bf)}else{bf=bn.angleTo(Q);if(bf<=K){bp.makeRotationAxis(new R.Vector3().crossVectors(bn,Q).normalize(),bf)}else{bp.makeRotationAxis(new R.Vector3().crossVectors(bn,Y).normalize(),o-bf)}}}bl=bl?bp.multiply(bl):bp}}else{if(bg<=bj&&bg<=bh){bo=bi.vecU;bn=bi.vecV;be=bi.vecW}else{if(bj<=bh&&bj<bg){bo=bi.vecV;bn=bi.vecW;be=bi.vecU}else{bo=bi.vecW;bn=bi.vecU;be=bi.vecV}}bl=aj(be,T);if(bl){bi.applyMatrix4(bl)}if(bd){bj=bo.length();bh=bn.length();if(bj===bh){be=bd.x?bo:bn}else{be=bj>bh?bo:bn}bp=aj(be,bd);if(bp){bl=bl?bp.multiply(bl):bp}}}return bl}function aJ(be,bg,bd){var bf=new R.Matrix4().setPosition(be);var bc=new R.Matrix4().copy(bg).multiply(new R.Matrix4().getInverse(bf).multiply(bd));return bf.multiply(bc)}function aL(be,bd){var bc=new R.Vector3(0,0,0);bc.applyMatrix4(bd);if(!be.containsPoint(bc)){be.center(bc)}return bc}function az(be,bd,bc){be.setSSAO(false);be.setShadow(false,false);be.setRenderDepth(1);if(!bd){be.excludeFromCSO(true);be.excludeFromHighlight(true,true);be.exludeFromBounding(true)}if(bc){be.name=bc}return be}function av(bk){if(!bk.box){return}var bg=false;if(bk.node.children.length===1){var bf=bk.node.children[0];if(B.is3DLeaf(bf)||B.is3DLeaf(bk.node)||(k(bk.node)&&!v(bf))||(v(bk.node)&&!k(bf))){bg=true}}var bl=bk.box;var bj=bl.minX(),bd=bl.maxX(),bi=bl.minY(),bc=bl.maxY(),bh=bl.minZ();if((bd-bj)>0&&(bc-bi)>0){var be=U.createRectangleNode({width:bd-bj,height:bc-bi,fill:true,material:bg?i:h});be.setMatrix(new R.Matrix4().setPosition(new R.Vector3(bj,bi,bh)));aR.levels[aR.levels.length-1].node.addChild(az(be))}}function ap(bc){var be=Math.sqrt(bc);var bd=Math.floor(be);return be-bd<0.5?bd:bd+1}function a3(bc){return Math.ceil(Math.sqrt(bc))}function aZ(bl,bk,bt){if(bl.length){var bs=new u({name:"EmptyNodes",ratio:1});bs.setMatrix(new R.Matrix4().setPosition(new R.Vector3(bt.max.x,(bk.minY()+bk.maxY())/2,bt.min.z)));aR.levels[aR.levels.length-1].node.addChild(bs);var bg=5,bo={},bh={};var be=bl.length>3?ap(bl.length):1,bc=bl.length>3?a3(bl.length):bl.length;var bi=(be*0.5-1)*(e+2*bg),bv=0,bn;for(var bm=0;bm<be;++bm){var bj=0;for(var bq=0;bq<bc;++bq){var bp=bl[bv].node,br=false;if(bp.children.length===0){if(!v(bp)){M.log("Inst or RepInst with no Ref or RepRef");br=true}}else{if(bp.children.length!==1&&!v(bp)){M.log("Inst or RepInst with more than one Ref or RepRef");br=false}else{if(B.isRepInstance(bp)||B.is3DLeaf(bp.children[0])){br=true}else{if(B.is3DLeaf(bp)){br=true}}}}var bu=U.createRectangleNode({width:C+2*bg,height:e+2*bg,fill:true,material:br?i:h});bu.setMatrix(new R.Matrix4().setPosition(new R.Vector3(bj,bi,0)));bs.addChild(az(bu,false,"Node_"+bl[bv].id));bu.navigationAssociatedPath=bl[bv].pathElement;bn=H[bl[bv].type];if(!bn){bn=br?J:l;if(!bo[bl[bv].type]){bo[bl[bv].type]=bl[bv].id}bh[bl[bv].id]=bl[bv].type}var bd=U.createRectangleNode({width:C,height:e,fill:true,noEdge:true,material:bn});bd.setMatrix(new R.Matrix4().setPosition(new R.Vector3(bg,bg,bg)));bj+=C+2*bg;bu.addChild(az(bd,true,"Texture_"+bl[bv].id));bd.navigationAssociatedPath=bl[bv].pathElement;bv++;if(bv>=bl.length){break}}bi-=e+2*bg;if(bv>bl.length){break}}var bf=Object.keys(bo).map(function(bw){return bo[bw]});if(!bf.length){return}j.fetch({enopad_webapis:require("DS/PADUtils/PADSettingsMgt").getSetting("enopad_webapis"),data:{intent:"explore_2D",select_file:["preview_url","thumbnail_2d"],select_predicate:["physicalid"]},pids:bf,onComplete:function(bx){var by=JSON.parse(bx),bw={};((by&&by.results)||[]).forEach(function(bE){if(bE.attributes){var bD,bB;for(var bC=0,bA=bE.attributes.length;bC<bA&&(!bD||!bB);++bC){var bz=bE.attributes[bC];if(!bD&&bz.name==="ds6w:type"){bD=bz.value}else{if(!bB&&(bz.name==="preview_url"||bz.name==="thumbnail_2d")){bB=bz.value}}}if(bD&&bB){bw[bD]=bB}}});bs.getChildren().forEach(function(bD){var bC=bD.getChildren();if(bC&&bC.length){var bB=bC[0].name.replace("Texture_",""),bA,bz;if(bh[bB]){bA=H[bh[bB]];if(!bA&&bw[bh[bB]]){bz=new R.ImageUtils.loadTexture(bw[bh[bB]],undefined,function(){if(!H[bh[bB]]){H[bh[bB]]=bA=new R.MeshBasicMaterial({map:bz,side:R.DoubleSide,force:true,transparent:true})}else{bA=H[bh[bB]]}bC[0].setMaterial(bA)},function(){},true)}if(bA){bC[0].setMaterial(bA)}}}});a6.render()},onFailure:function(){}})}}function aX(be,bg){var bd=null,bf,bh,bc;if(v(be)||B.is3DLeaf(be)){bd=bg.clone();bd.addElement(be);bh=B.getNodeID(be);bc=B.getNodeType(be)}else{if((bf=be.getChildren()).length===1){bd=bg.clone();bd.addElement(be);bd.addElement(bf[0]);bh=B.getNodeID(bf[0]);bc=B.getNodeType(bf[0])}}return{id:bh,node:be,pathElement:bd,type:bc}}function aS(bd,bc){return bd.valueForSort<bc.valueForSort?-1:(bd.valueForSort>bc.valueForSort?1:0)}function ar(bd,bc){return bd.valueForSort>bc.valueForSort?-1:(bd.valueForSort<bc.valueForSort?1:0)}function aa(bd,bc){var be=new R.Box3();bd.forEach(function(bf){be.union(new R.Box3(bf.box.min(),bf.box.max()))});bd.delta=0;if(bc.min.y>be.min.y){bd.delta=bc.min.y-be.min.y}if(bc.max.y<be.max.y){bd.delta=Math.min(bd.delta,be.max.y-bc.max.y)}}function ac(bd,bc){var be=new R.Box3();bd.forEach(function(bf){be.union(new R.Box3(bf.box.min(),bf.box.max()))});bd.delta=0;if(bc.min.x>be.min.x){bd.delta=bc.min.x-be.min.x}if(bc.max.x<be.max.x){bd.delta=Math.min(bd.delta,be.max.x-bc.max.x)}}function aB(bh,bd,bg,bf,bc){var be=new R.Matrix4().setPosition(new R.Vector3().copy(bf.dir).multiplyScalar(bc));bg.box.applyMatrix4(be);bg.worldMatrixTarget=bg.worldMatrixSource.multiplyMatrices(be,bg.worldMatrixSource);bg.matrixTarget=new R.Matrix4().multiplyMatrices(bh,bg.worldMatrixTarget);delete bg.worldMatrixSource;if(bg.centerRotation){bg.centerRotation.applyMatrix4(be)}bd.union(new R.Box3(bg.box.min(),bg.box.max()));return bd}function aO(){var bc=aI.getFrameWindow();if(bc&&bc.removeReviewModel){bc.removeReviewModel()}}function am(bj){bb.forward();aI.getFrameWindow().getContextualUIManager().hideContextualMenus();if(bj.div===aR.levels[aR.levels.length-1].button){return}var bl=[],be=[],bg=[],bh=[],bm,bi,bf,bn;while(aR.levels.length){var bd=aR.levels.pop();if(bd.button===bj.div){aR.levels.push(bd);ak=bd.path;if(at){at.setCurrentPath(ak)}break}else{var bk;if(aR.levels.length===1){for(bm=aR.levels[0].overridesMove.length-1;bm>=0;--bm){bf=aR.levels[0].overridesMove[bm];bn=bf.getPathes();if(bn.length!==1){M.log("More than one path in override, not expected")}if(bn[0].isEqual(bd.path)){bk=bf.getPosition();break}}}for(bm=0,bi=bd.overridesMove?bd.overridesMove.length:0;bm<bi;++bm){bf=bd.overridesMove[bm];bl.push(bf);bn=bf.getPathes();if(bn.length!==1){M.log("More than one path in override, not expected")}var bc=bn[0].getLastElement(true).getMatrix();if(bk&&bn[0].isEqual(bd.path)){bc=bk;bk=null}bh.push({override:bf,matrixSource:bf.getPosition(),matrixTarget:bc})}for(bm=0;bm<(bd.overridesHide?bd.overridesHide.length:0);++bm){bl.push(bd.overridesHide[bm]);be.push({override:bd.overridesHide[bm]})}aR.mainDiv.removeBreadCrumb(bd.button.idthumb);a6.removeNode(bd.node);al.push({path:bd.path,pathReference:bd.pathReference})}}aO();bb.addAnimation({animationType:"unmask",objectListToAnimate:be,duration:1000});bb.addAnimation({animationType:"move",objectListToAnimate:bh,duration:1000,callBackFct:function(){a1.deleteOverrides(bl);a1.deleteOverrides(bg);a6.addNode(aR.levels[aR.levels.length-1].node);a6.render({updateInfinitePlane:true})}});bb.startAnimation();a6.render({updateInfinitePlane:true})}function ab(bf,bc,bd){if(!aW&&bd){aI.getFrameWindow().getViewpoint().reframe("iso",0)}var bg=new r({headLength:10,arrowLength:50,arrowWidth:2,head:r.types.ARROW});bg.exludeFromBounding(true);bg.setVisibilityInTree(false);bg.setPickable(E.NODRAWHL);var be=aR.levels[aR.levels.length-2].node.getChildByName("EmptyNodes");if(be){bg.setMatrix(be.getMatrix())}aR.levels[aR.levels.length-1].node.addChild(bg);bb.axisSystemVisibility({objectListToAnimate:[bg],visibility:true,pickability:false,callBackFct:function(){a6.addNode(aR.levels[aR.levels.length-1].node);if(!aW){aU()}}});bb.startAnimation()}function aN(bo,bj){ak=bo;if(at){at.setCurrentPath(ak)}var be=a6.getVisibleSpace(),bn={button:aR.mainDiv.addHomeBreadCrumb({cb:am}),path:bo};bn.node=new X("Navigation_"+aR.levels.length);bn.node.setVisibility(a6.getVisibleSpace()===1);bn.node.setVisibilityFree(false);bn.node.setVisibilityInTree(false);a6.addNode(bn.node);aR.levels.push(bn);var bc=[],bi,bd,bm,bg=[],bh=[],bf,bl,bk=bo.getLastElement(true);aR.levels[aR.levels.length-1].overridesMove=bc;bk.getChildren().forEach(function(bs){var bA=bo.clone();bA.addElement(bs);var br=a8(bA);if(br===-1){return}bd=bA.getBoundingBox(null,a6,"visibleSpace");bm=bA.getBoundingBox(null,a6,"invisibleSpace");if((!bd||bd.isNaN())&&(!bm||bm.isNaN())){if((br===0&&be)||(br===1&&!be)){bh.push(aX(bs,bo))}}else{bi=be?bd:bm;if(bi&&!bi.isNaN()){bi=new F(bi);var bz=bo.clone();bz.addElement(bs);var bv=bz.getMatrix(),bp=new R.Matrix4().copy(bv);var by=bz.getWorldMatrix();bi.applyMatrix4(by);var bq=bi.center();var bx=af(bi,null,true);if(bx){bp=aJ(bq,bx,by);by=bp;bi=new F(bA.getBoundingBox(null,a6,be?"visibleSpace":"invisibleSpace"));bi.applyMatrix4(bp);bq=bi.center()}if(!bf){bl=new R.Vector3().copy(bq);bf=new R.Box3(bi.min(),bi.max());bg.push({override:aE(bz,bc),matrixSource:bv,matrixTarget:bp,box:bi,node:bs})}else{var bt=bi.min(),bu=new R.Vector3();bu.x=(bq.x<bl.x)?(bf.min.x-Math.abs(bq.x-bt.x)):(bf.max.x+Math.abs(bq.x-bt.x));bu.y=bl.y;bu.z=bf.min.z+(bq.z-bt.z);var bw=new R.Matrix4().setPosition(bu.sub(bq));bi.applyMatrix4(bw);bp=new R.Matrix4().copy(bw).multiply(bp);bg.push({override:aE(bz,bc),matrixSource:bv,matrixTarget:bp,box:bi,node:bs});bf.union(new R.Box3(bi.min(),bi.max()))}}}});if(!bf){bf=new R.Box3(new R.Vector3(),new R.Vector3())}if(!aW&&bj){aI.getFrameWindow().getViewpoint().reframe("iso",0)}bb.addAnimation({animationType:"move",objectListToAnimate:bg,duration:bj?1000:0,callBackFct:function(){if(bj){a6.render({updateInfinitePlane:true});if(!aW){aU()}}}});bb.startAnimation();aZ(bh,new F(bf),bf);bg.forEach(av)}function a2(bC){var bo=bC.path.getWorldMatrix(),bd=new R.Matrix4().getInverse(bo),by=a6.getVisibleSpace(),bA=bC.pathReference?bC.pathReference.getLastElement(true):null,bl,bm=[],bB;if(!bA){var bw=0;bC.pathsToExplode.forEach(function(bH){var bF=bH.getBoundingBox(null,a6,"visibleSpace"),bE=bH.getBoundingBox(null,a6,"invisibleSpace"),bG;if((bF&&!bF.isNaN())||(bE&&!bE.isNaN())){if(!bF||bF.isNaN()){bG=0}else{bF=new F(bF);bF.applyMatrix4(bo);bG=(bF.maxX()-bF.minX())*(bF.maxY()-bF.minY())}if(bG>bw){bw=bG;bC.pathReference=bH;bA=bH.getLastElement(true)}}})}if(!aW&&bC.applyViewpoint){aI.getFrameWindow().getViewpoint().reframe("iso",0)}if(!bC.pathReference){var bn=aR.levels[aR.levels.length-2].node.getChildByName("EmptyNodes");bC.pathsToExplode.forEach(function(bE){bm.push(aX(bE.getLastElement(true),bC.path))});var bu=new R.Vector3().getPositionFromMatrix(bn?bn.getMatrix():bo);bB=new R.Box3(new R.Vector3(bu.x-C,bu.y-e/2,bu.z),new R.Vector3(bu.x,bu.y+e/2,bu.z));bl=new F(bB);bb.startAnimation();aZ(bm,bl,bB);if(bC.startAnimation){a6.addNode(aR.levels[aR.levels.length-1].node);a6.render({updateInfinitePlane:true})}if(bC.applyViewpoint){aU()}return}var be=[];aR.levels[aR.levels.length-1].overridesMove=be;var bD=bC.pathReference.getMatrix(),bh=new R.Matrix4().multiplyMatrices(bo,bD);bl=bC.pathReference.getBoundingBox(null,a6,by?"visibleSpace":"invisibleSpace");if(!bl||bl.isNaN()){bl=new R.Box3(new R.Vector3(),new R.Vector3())}bl=new F(bl);bl.applyMatrix4(bh);var bv=aL(bl,bh);var bx=af(bl,null,false);if(bx){var bp={override:aE(bC.path,be),matrixSource:bo,matrixRotation:bx,centerRotation:bv,matrixParentInv:new R.Matrix4().getInverse(bC.path.getParentPath().getWorldMatrix())};bb.addAnimation({animationType:"rotate",objectListToAnimate:[bp],duration:bC.startAnimation?500:0,callBackFct:function(){if(bC.startAnimation){a6.render({updateInfinitePlane:true})}}});bo=aJ(bv,bx,bo);bd=new R.Matrix4().getInverse(bo);bh=new R.Matrix4().multiplyMatrices(bo,bD);bl=new F(bC.pathReference.getBoundingBox(null,a6,by?"visibleSpace":"invisibleSpace"));bl.applyMatrix4(bh);bv=aL(bl,bh)}var bf=bl.minZ();if(!y){var bk=bC.path.getBoundingBox(null,a6,by?"visibleSpace":"invisibleSpace");if(bk){bk.applyMatrix4(bo);bf=bk.min.z}}var bi={path:bC.pathReference,override:aE(bC.pathReference,be),node:bA,matrixSource:bD,matrixTarget:bD,worldMatrixTarget:bh,box:bl};bi.vectorZMatrix=new R.Matrix4().setPosition(new R.Vector3(0,0,bf-bl.minZ()));bl.applyMatrix4(bi.vectorZMatrix);var br=[bi];var bt={min:[],max:[]},bq={min:[],max:[]};bt.min.dir=new R.Vector3(-1,0,0);bt.max.dir=new R.Vector3(1,0,0);bq.min.dir=new R.Vector3(0,-1,0);bq.max.dir=new R.Vector3(0,1,0);bC.pathsToExplode.forEach(function(bK){if(bK.isEqual(bC.pathReference)){return}var bH=bK.getBoundingBox(null,a6,"visibleSpace"),bO=bK.getBoundingBox(null,a6,"invisibleSpace");if((!bH||bH.isNaN()||bH.min.distanceTo(bH.max)<=0)&&(!bO||bO.isNaN()||bO.min.distanceTo(bO.max)<=0)){bm.push(aX(bK.getLastElement(true),bC.path))}else{var bL=by?bH:bO;if(bL&&!bL.isNaN()){bL=new F(bL);var bP={path:bK,node:bK.getLastElement(true)};br.push(bP);bP.override=aE(bP.path,be);bP.matrixSource=bP.path.getMatrix();var bM=new R.Matrix4().multiplyMatrices(bo,bP.matrixSource),bF=new R.Matrix4().getInverse(bM);bL.applyMatrix4(bM);bP.worldMatrixSource=bM.clone();var bG;var bE=new R.Vector3();bL.center(bE);var bJ=Math.abs(bL.maxX()-bL.minX()),bI=Math.abs(bL.maxY()-bL.minY());if(bJ>bI){bP.valueForSort=bE.y;if(bE.y<bv.y){bq.min.push(bP)}else{bq.max.push(bP)}bG=new R.Vector3().copy(bt.max.dir)}else{bP.valueForSort=bE.x;if(bE.x<bv.x){bt.min.push(bP)}else{bt.max.push(bP)}bG=new R.Vector3().copy(bq.max.dir)}var bN=af(bL,bG,false);if(bN){bP.matrixRotation=bN;bP.centerRotation=bE;bP.matrixParent=bo;bP.matrixParentInv=bd;bM=aJ(bE,bN,bM);bL.applyMatrix4(bF);bL.applyMatrix4(bM);bF.getInverse(bM)}bP.vectorZMatrix=new R.Matrix4().setPosition(new R.Vector3(0,0,bf-bL.minZ()));bL.applyMatrix4(bP.vectorZMatrix);bP.box=bL}}});bt.min.sort(ar);bt.max.sort(aS);bq.min.sort(ar);bq.max.sort(aS);var bs=0;bs+=bt.min.length?0:1;bs+=bt.max.length?0:1;bs+=bq.min.length?0:1;bs+=bq.max.length?0:1;if(bs===3){if(bt.min.length||bt.max.length){bv.x=bt.min.length?bt.min[0].box.maxX():bt.max[0].box.minX()}else{bv.y=bq.min.length?bq.min[0].box.maxY():bq.max[0].box.minY()}}bB=new R.Box3(new R.Vector3(bl.minX(),bl.minY(),bl.minZ()),new R.Vector3(bl.maxX(),bl.maxY(),bl.maxZ()));aa(bt.min,bB);aa(bt.max,bB);ac(bq.min,bB);ac(bq.max,bB);var bg=[bt.min,bt.max,bq.min,bq.max];bg.sort(function(bF,bE){return bF.delta-bE.delta});bg.forEach(function(bE){if(bE===bt.min){bt.min.forEach(function(bH,bF,bG){bB=aB(bd,bB,bH,bG,-1*((bB?bB.min.x:bv.x)-bH.box.maxX()))})}else{if(bE===bt.max){bt.max.forEach(function(bH,bF,bG){bB=aB(bd,bB,bH,bG,(bB?bB.max.x:bv.x)-bH.box.minX())})}else{if(bE===bq.min){bq.min.forEach(function(bH,bF,bG){bB=aB(bd,bB,bH,bG,-1*((bB?bB.min.y:bv.y)-bH.box.maxY()))})}else{if(bE===bq.max){bq.max.forEach(function(bH,bF,bG){bB=aB(bd,bB,bH,bG,(bB?bB.max.y:bv.y)-bH.box.minY())})}}}}});var bz=[],bc=[],bj;br.forEach(function(bE){if(bE.matrixRotation){bj=M.extend({},bE);bc.push(bj);bj.matrixSource=bE.matrixTarget;bj.worldMatrixTarget=aJ(bE.centerRotation,bE.matrixRotation,bE.worldMatrixTarget);bE.centerRotation.applyMatrix4(bd);bj.matrixTarget=new R.Matrix4().multiplyMatrices(bd,bj.worldMatrixTarget);bE=bj}bj=M.extend({},bE);bz.push(bj);bj.matrixSource=bE.matrixTarget;bj.worldMatrixTarget.multiplyMatrices(bE.vectorZMatrix,bE.worldMatrixTarget);bj.matrixTarget=new R.Matrix4().multiplyMatrices(bd,bj.worldMatrixTarget)});bb.addAnimation({animationType:"move",objectListToAnimate:br,duration:bC.startAnimation?300:0,offsetTime:bx?500:0});bb.addAnimation({animationType:"rotate",objectListToAnimate:bc,duration:bC.startAnimation?400:0,offsetTime:bx?800:300});bb.addAnimation({animationType:"move",objectListToAnimate:bz,duration:bC.startAnimation?300:0,offsetTime:bx?(bc.length?1200:800):(bc.length?700:300),callBackFct:function(){if(bC.startAnimation){a6.addNode(aR.levels[aR.levels.length-1].node);a6.render({updateInfinitePlane:true})}if(bC.applyViewpoint){aU()}}});bb.startAnimation();a6.render({updateInfinitePlane:true});aZ(bm,bl,bB);br.forEach(av)}function ae(br,bh,bn,bo){bb.forward();var be=[],bg=[],bf=br.getLastElement(true),bj=false;if(v(bf)&&!B.is3DLeaf(bf)){bj=true;bf.children.forEach(function(bs){var bt=br.clone();bt.addElement(bs);if(a8(bt)!==-1){be.push(bt)}})}else{if(k(bf)){var bm=br.clone();bm.addElement(bf.children[0]);ae(bm,bh,bn,bo)}}if(be.length||bj){ak=br;aO();if(at){at.setCurrentPath(ak)}if(aR.levels&&aR.levels.length&&aR.levels[aR.levels.length-1].node){a6.removeNode(aR.levels[aR.levels.length-1].node)}var bk=[];var bl=ak.externalPath.length>1?ak.externalPath[ak.externalPath.length-2]:null;if(k(bl)&&bl.parents.length===1){bg=bg.concat(ak.getParentPath().getSiblingsPathes())}else{if(bl&&bl===a9){bg=bg.concat(ak.getSiblingsPathes())}}if(bg.length){bb.addAnimation({animationType:"mask",objectListToAnimate:[{override:aE(bg,bk),duration:bn?1000:0}]})}var bq={path:ak,node:new X("Navigation_"+aR.levels.length),overridesHide:bk,pathReference:bh};bq.node.setVisibility(a6.getVisibleSpace()===1);bq.node.setVisibilityFree(false);bq.node.setVisibilityInTree(false);aR.levels.push(bq);var bp=bf.getChildren().every(function(bt){var bs=bt.getChildren();if(bs.length===0){return true}if(bs.length!==1){M.log("Instance or RepInstance with no or more than one Reference or RepReference");return false}if(!B.isPLMNode(bs[0])){M.log("Navigation to a non PAD3DViewer node should not be possible");return true}if(B.is3DLeaf(bs[0])){return true}return false}),bd=B.getNodeID(bf),bc=[bd],bi=B.getNodeID(ak.externalPath[ak.externalPath.length-2]);if(bi){bc.push(bi)}if(!bq.button){bq.button=aR.mainDiv.addBreadCrumb({cb:am,lastBreadCrumb:bp})}aI.getController().getAttributes({ids:bc,attributes:["ds6w:label"],callbacks:{onComplete:function(bt){var bs=bt[bd]?bt[bd]["ds6w:label"]:"";if(bi&&bt[bi]&&bt[bi]["ds6w:label"]){bs+=" ("+bt[bi]["ds6w:label"]+")"}if(aR.mainDiv){aR.mainDiv.setLabel(bq.button.idthumb,bs)}},onFailure:function(){}}});if(be.length){a2({path:bq.path,pathsToExplode:be,pathReference:bq.pathReference,startAnimation:bn,applyViewpoint:bo})}else{ab(br)}}}function aD(bh){var bf=bh.gesture?bh.gesture.getEvents()[0]:bh.from[0];var be=a6.pick(a6.getMousePosition(bf.getCurrentPosition(a6.canvas)),"mesh",false);if(be.path&&be.path.length&&ak){var bd=be.path[0].getLastElement(true);if(bd.navigationAssociatedPath){be.path[0]=bd.navigationAssociatedPath}var bi=ak.clone();if(be.path[0].externalPath.length>bi.externalPath.length){bi.addElement(be.path[0].externalPath[bi.externalPath.length]);var bc=k(bi.externalPath[bi.externalPath.length-1])?[0,1]:[0];var bg;if(be.path[0].externalPath.length>=(bi.externalPath.length+bc.length)){bg=bi.clone();bc.forEach(function(bj){bg.addElement(be.path[0].externalPath[bi.externalPath.length+bj])})}z.empty();x.empty();al=[];ae(bi,bg,true,false)}}}function aC(bc){if(bc.key==="ArrowLeft"||bc.keyCode===37||bc.key==="ArrowUp"||bc.keyCode===38){if(aR.levels.length>1){document.removeEventListener("keydown",aC);aR.mainDiv.activate(aR.levels[aR.levels.length-2].button.idthumb);document.addEventListener("keydown",aC)}}else{if(bc.key==="ArrowRight"||bc.keyCode===39||bc.key==="ArrowDown"||bc.keyCode===40){if(al.length>0){var bd=al.pop();document.removeEventListener("keydown",aC);ae(bd.path,bd.pathReference,true,false);document.addEventListener("keydown",aC)}}}}var aY=(function(){var bc;return function(bh,bg){var bd,bm,bi,bj,bf,bn;if(bg===aQ[2]){bc=true;aR.levels.forEach(function(bo){a6.removeNode(bo.node);bo.node=null});for(bm=aR.levels.length-1;bm>0;--bm){aR.mainDiv.removeBreadCrumb(bm-1)}return}else{if(bg===aQ[3]||bg===aQ[10]){bc=false;var be=aI.getController();aR.levels.forEach(function(bu,bp,br){if(bp===0){return}var bt=bu.path,bq=br[bp-1].path.clone();for(bi=bq.externalPath.length,bj=bt.externalPath.length;bi<bj;++bi){bd=B.getNodeID(bt.externalPath[bi]);bf=be.getNode({id:bd});if(bf){bq.addElement(bf)}else{break}}var bo=bu.pathReference,bs=bo?bq.clone():undefined;if(bs){for(bi=bs.externalPath.length,bj=bo.externalPath.length;bi<bj;++bi){bd=B.getNodeID(bo.externalPath[bi]);bf=be.getNode({id:bd});if(bf){bs.addElement(bf)}else{break}}}bu.path=bq;bu.pathReference=bs})}}if(bc){return}bb.forward();ay.removeSceneGraphOverrideSet(a1);a1=null;aR.mainDiv.destroy();ao=[];aR.levels.forEach(function(bo){a6.removeNode(bo.node);bo.node=null;ao.push({path:bo.path,pathReference:bo.pathReference})});aR.mainDiv=new I({parentFrame:aI.getFrameWindow().getUIFrame()});aR.levels=[];a1=new N(aI.getRootBagPath().externalPath[0]);ay.pushSceneGraphOverrideSet(a1);var bk=ao,bl;if(bg===aQ[0]&&(bl=B.getRoots(aI))&&bl.length===1&&!B.is3DLeaf(bl[0])&&(bk.length===1||(bk.length>1&&!d(bk[1].path)))){bn=bk[0].path.clone();bn.addElement(bl[0]);bk.length=1;bk.push({path:bn})}else{if(bg===aQ[1]&&bk.length>1&&!d(bk[1].path)&&(bl=B.getRoots(aI))&&bl.length===1&&!B.is3DLeaf(bl[0])){bn=bk[0].path.clone();bn.addElement(bl[0]);bk.length=1;bk.push({path:bn})}}if(at){at.setCurrentPath(ak=null)}for(bm=0;bm<bk.length;++bm){if(bm===0){aN(bk[bm].path,(bk.length-1)===bm)}else{bn=bk[bm].path;if(!d(bn)||a8(bn)===-1){bb.startAnimation();a6.addNode(aR.levels[aR.levels.length-1].node);a6.render({updateInfinitePlane:true});break}ae(bn,bk[bm].pathReference,(bk.length-1)===bm,false)}}bb.forward()}}());function a0(){aI.getFrameWindow().getContextualUIManager().register({onContextualBarReady:function(bf,bj){var be=x.get();if(be.length===0){return undefined}var bh=B.getRoots(aI);var bi=[],bd=false,bg=be.some(function(bl){var bk=bl.pathElement.getLastElement(true);return bh.some(function(bm){var bo=bm!==bk;var bn=bl.pathElement.externalPath.some(function(bp){return bm===bp});if(!bd&&bn){bd=true}return bo&&bn})});if(bd&&bj&&bj.withContextMenu&&typeof bj.XmousePosition==="number"&&typeof bj.YmousePosition==="number"){var bc=a6.pick(a6.getMousePosition(new R.Vector2(bj.XmousePosition,bj.YmousePosition)),"mesh",false);if(bc.path.length===0){bg=bd=false}}if(bg&&O.getCommand("CAT3DComposeExamineSelectionHdr",aI.getCommandContext?aI.getCommandContext():null).canBeEnabled(be)){bi.push({name:"CATC3DNavigationExamineSelectionStr",line:1,hdr_list:["CAT3DComposeExamineSelectionHdr"]})}if(!y&&bd&&be.length===1&&!B.is3DLeaf(be[0].pathElement.getLastElement(true))){bi.push({name:"CATC3DNavigationOnChildStr",line:1,hdr_list:["CATC3DNavigationOnChildHdr"]})}return bi.length?{cmdList:bi}:undefined},context:aI.getCommandContext?aI.getCommandContext():null,workbenchName:"CATC3DNavigation",module:"CATC3DNavigation",cmdPrefix:"",merge:true,subscriberId:"CATC3DNavigation_"+(++n)})}this.start=function(){aV=true;aP=new q();var bd=aI.getFrameWindow().getViewpoint();aP.store(bd);c=a6.backgroundColor;g();ag=aI.isRobotVisible();aI.setRobotVisibility(false);aI.setDefaultContextualBarVisibility(false);aG=a6.picking.primitive;an=a6.pPicking.primitive;a6.setPrePicking({primitive:0});a6.setPicking({primitive:0});aH=f.onPreAdd(au);ax=z.onPreAdd(aA);a5=z.onRemove(ah);a4=x.onPreAdd(aF);ad=G.getTooltipManager({context:aI});ba=ad.register({onTooltipReady:ai,filterPath:aq});aQ.push(aI.subscribe({event:"onLoadingComplete"},aY));aQ.push(aI.subscribe({event:"onEndRootRemoved"},aY));aQ.push(aI.subscribe({event:"onRefreshBegin"},aY));aQ.push(aI.subscribe({event:"onRefreshCompleted"},aY));aQ.push(aI.subscribe({event:"onRootDetached"},aY));aQ.push(aI.subscribe({event:"onRootAttached"},aY));aQ.push(aI.subscribe({event:"onAuthoringTransactionEnd"},aY));aQ.push(aI.subscribe({event:"onShow"},aY));aQ.push(aI.subscribe({event:"onHide"},aY));aQ.push(aI.subscribe({event:"onExpandCompleted"},aY));aQ.push(aI.subscribe({event:"onEndDelete"},aY));aQ.push(aI.subscribe({event:"onEndMatriceUpdate"},aY));a7=a6.onSwapVisibleSpace?a6.onSwapVisibleSpace(aY):null;at=t.getDropManager({context:aI});at.connect();aK=at.subscribe({event:"onEndInsertDrop3D"},aY);a1=new N(aI.getRootBagPath().externalPath[0]);ay.pushSceneGraphOverrideSet(a1);s.addEvent(a6.canvas,"onLeftDoubleClick",aD);s.addEvent(a6.canvas,"onDoubleTap",aD);aR.mainDiv=new I({parentFrame:aI.getFrameWindow().getUIFrame()});aR.levels=[];var bg=[],bf;if(!ak||!d(ak)||!ao||ao.length===0){bg.push({path:aI.getRootBagPath()});var bc=B.getRoots(aI);if(bc.length===1&&!B.is3DLeaf(bc[0])){bf=bg[0].path.clone();bf.addElement(bc[0]);bg.push({path:bf})}aW=null}else{bg=ao}ak=null;if(at){at.setCurrentPath(ak)}for(var be=0;be<bg.length;++be){if(be===0){aN(bg[be].path,(bg.length-1)===be)}else{bf=bg[be].path;if(!d(bf)||a8(bf)===-1){bb.startAnimation();a6.addNode(aR.levels[aR.levels.length-1].node);a6.render({updateInfinitePlane:true});aU();break}ae(bf,bg[be].pathReference,(bg.length-1)===be,(bg.length-1)===be)}}document.addEventListener("keydown",aC);a0()};this.end=function(){aV=false;bb.stop();aI.getFrameWindow().getContextualUIManager().unregister("CATC3DNavigation_"+n);document.removeEventListener("keydown",aC);aO();aI.setRobotVisibility(ag);aI.setDefaultContextualBarVisibility(false);a6.setPicking({primitive:aG});a6.setPrePicking({primitive:an});at.disconnect();at.unsubscribe(aK);f.unsubscribe(aH);z.unsubscribe(ax);x.unsubscribe(a4);z.unsubscribe(a5);ad.unregister(ba);G.unreferenceTooltipManager({context:aI});aH=ax=a4=a5=ba=at=aK=null;for(var bd=z.get(),be=bd.length-1;be>=0;--be){var bf=bd[be];if(bf&&bf.pathElement.externalPath[0]!==a9&&bf.pathElement.getLastElement(true).navigationAssociatedPath){z.remove(bf);bf.pathElement=bf.pathElement.getLastElement(true).navigationAssociatedPath.clone();if(!z.isIn(bf)){z.add(bf)}}}aQ.forEach(function(bg){aI.unsubscribe(bg)});aQ=[];a6.unsubscribe(a7);a7=null;var bc=aI.getFrameWindow().getViewpoint();if(aW){aW.store(bc,d(ak)?ak.getWorldMatrix():null)}aP.restore(bc);ay.removeSceneGraphOverrideSet(a1);a1=null;s.removeEvent(a6.canvas,"onLeftDoubleClick",aD);s.removeEvent(a6.canvas,"onDoubleTap",aD);aR.mainDiv.destroy();ao=[];aR.levels.forEach(function(bg){a6.removeNode(bg.node);ao.push({path:bg.path,pathReference:bg.pathReference})});aR={};al=[];a6.render({updateInfinitePlane:true})};this.pause=function(){if(aH&&aV){document.removeEventListener("keydown",aC);a6.setPicking({primitive:aG});a6.setPrePicking({primitive:an});f.unsubscribe(aH);aH=undefined;z.unsubscribe(ax);ax=undefined;z.unsubscribe(a5);a5=undefined;x.unsubscribe(a4);a4=undefined;ad.unregister(ba);ba=undefined;s.removeEvent(a6.canvas,"onLeftDoubleClick",aD);s.removeEvent(a6.canvas,"onDoubleTap",aD);aI.getFrameWindow().getContextualUIManager().unregister("CATC3DNavigation_"+n);aR.mainDiv.hide();if(aR.levels[aR.levels.length-1].node){a6.removeNode(aR.levels[aR.levels.length-1].node)}}};this.resume=function(){if(!aH&&aV){aG=a6.picking.primitive;an=a6.pPicking.primitive;a6.setPrePicking({primitive:0});a6.setPicking({primitive:0});aH=f.onPreAdd(au);ax=z.onPreAdd(aA);a5=z.onRemove(ah);a4=x.onPreAdd(aF);ba=ad.register({onTooltipReady:ai,filterPath:aq});s.addEvent(a6.canvas,"onLeftDoubleClick",aD);s.addEvent(a6.canvas,"onDoubleTap",aD);document.addEventListener("keydown",aC);a0();aR.mainDiv.show();if(aR.levels[aR.levels.length-1].node){a6.addNode(aR.levels[aR.levels.length-1].node)}}};this.navigateOnChild=function(bd){var bc=bd&&bd.pathToExplode?bd.pathToExplode:null;if([1,2].some(function(){bc=bc?bc.getParentPath():null;return bc?bc.isEqual(ak):null})){z.empty();x.empty();al=[];ae(bd.pathToExplode,null,true,false)}}}});return Z});define("DS/CATC3DNavigation/CATC3DNavigationStartCmd",["DS/ApplicationFrame/Command","DS/PADUtils/PADContext","DS/ApplicationFrame/CommandsManager","DS/CATC3DNavigation/CATD3CBoxNavigation","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(h,i,c,g,d){var e="CATC3DNavigation";e+=require("DS/PADUtils/PADSettingsMgt").getSetting("appModelerType")==="DEC"?"DEC":"";e+=".xml";var f=h.extend({init:function(k){var n=this;this._parent(k,{mode:"exclusive",isAsynchronous:false});this.setRepeatMode(false);this.execute=function(){var p=b.getNavigationObject({context:i.get()}),o=this._ctx;if(p.onExit&&p.onExit.actionBar&&p.onExit.actionBar.length){if(p.onStart&&p.onStart.onStart){p.done=function(){delete p.done;var q=p.context.subscribe({event:"onActionBarReady"},function(){p.context.unsubscribe(q);c.setDefaultCommand({ID:"CATD3CNavigationDefaultHdr",className:"DS/CATC3DNavigation/CATC3DNavigationDefaultCmd",context:o});p.activated=true;if(!p.controller){p.controller=new g({context:p.context})}p.controller.start()});p.context.loadActionBar({merge:false,file:e,module:"CATC3DNavigation"})};p.onStart.onStart(p)}}};this.onNavigationStart=function(p){var o=b.getNavigationObject({context:i.get()});if(!o.activated){o.onStart=p}};this.onNavigationExit=function(p){var o=b.getNavigationObject({context:i.get()});if(!o.activated){o.onExit=p}};var j=i.get(),l=j.subscribe({event:"onRootAdded"},function(){if(d.getRoots(j).length===1){n.enable()}}),m=j.subscribe({event:"onEndRootRemoved"},function(){if(d.getRoots(j).length===0){n.disable()}});if(d.getRoots(j).length===0){this.disable()}this._destroy=function(){j.unsubscribe(l);l=null;j.unsubscribe(m);m=null;Object.getPrototypeOf(this)._destroy.apply(this,arguments);n=null}}});return f});var a=function(e,c,d){["_commands","_cmdCheckHeader"].forEach(function(g){var f=d?e[g][d]:e[g];if(f[c]){if(f[c]._destroy){f[c]._destroy()}delete f[c]}})};define("DS/CATC3DNavigation/CATC3DNavigationEndCmd",["DS/ApplicationFrame/Command","DS/PADUtils/PADContext","DS/ApplicationFrame/CommandsManager"],function(g,h,d){var e="CATC3DNavigation",c;e+=require("DS/CAT3DComposeWidget/CAT3DComposeWidgetOptions").getOption("authoring3d")&&require("DS/PADUtils/PADSettingsMgt").getSetting("appModelerType")!=="DEC"?"Next":"";require(["text!DS/CATC3DNavigation/assets/afr/"+e+".xml"],function(i){c=i});var f=g.extend({init:function(i){this._parent(i,{mode:"exclusive",isAsynchronous:false});this.setRepeatMode(false);this.execute=function(){var p=b.getNavigationObject({context:h.get()});p.activated=false;if(p.controller){p.controller.end()}var q={lastCommand:[],currentCommand:null,defaultCommand:null};if(this._ctx){d._commandsState[this._ctx]=q}else{d._commandsState=q}d.resetDefaultCommand(this._ctx);a(d,"CATD3CNavigationDefaultHdr",this._ctx);var n=new DOMParser().parseFromString(c,"text/xml").getElementsByTagName("CATCommandHeader");for(var m=n.length-1;m>=0;--m){var k=n[m].attributes.getNamedItem("ClassName").value;if(!k.startsWith("DS/ViewerCommands")&&!k.startsWith("DS/ENOPAD3DViewer")){var j=n[m].attributes.getNamedItem("ID").value;if(j!=="CAT3DComposeExamineSelectionHdr"){a(d,j,this._ctx)}}}var o=0;var l=p.context.subscribe({event:"onActionBarReady"},function(){if(p.onExit.actionBar[o-1].onActionBarReady){p.onExit.actionBar[o-1].onActionBarReady()}if(o<p.onExit.actionBar.length){p.context.loadActionBar({merge:true,file:p.onExit.actionBar[o].file,module:p.onExit.actionBar[o].module});o++}else{p.context.unsubscribe(l)}});p.context.loadActionBar({merge:false,file:p.onExit.actionBar[0].file,module:p.onExit.actionBar[0].module});o++}}});return f});define("DS/CATC3DNavigation/CATC3DNavigationOnChildCmd",["DS/ApplicationFrame/Command","DS/PADUtils/PADContext","DS/Selection/CSOManager"],function(d,e,c){return d.extend({init:function(f){this._parent(f,{mode:"exclusive",isAsynchronous:false});this.setRepeatMode(false);this.execute=function(){var g=e.get(),i=c.get(),j=i.length===1?i[0].pathElement:null,h=j?b.giveNavigationObject({context:g}):null;g.getFrameWindow().getContextualUIManager().hideContextualMenus();if(h){setTimeout(function(){h.controller.navigateOnChild({pathToExplode:j})},0)}}}})});define("DS/CATC3DNavigation/CATC3DNavigationContoller",["UWA/Class"],function(d){var c=d.singleton({init:function(){},getNavigationContoller:function(f){var e=b.getNavigationObject({context:f.context});return e.controller},isNavigationActivated:function(f){var e=b.giveNavigationObject({context:f.context});return e?e.activated:false}});return c})}());define("DS/CATC3DNavigation/CATBreadCrumbs",["UWA/Core","UWA/Class","DS/CoreEvents/Events","css!DS/CATC3DNavigation/CATC3DNavigation.css"],function(b,d,a){var c=d.extend({init:function(j){var o=10000;var e;var C=[];var l=j.parentFrame;var r,A,u;var g=null;var f=function(){if(!r){return}r.div.setStyle("z-index",o+1);if(C.length){r.div.setStyle("border-top-right-radius","0px");r.div.setStyle("border-bottom-right-radius","0px")}else{r.div.setStyle("border-top-right-radius","5px");r.div.setStyle("border-bottom-right-radius","5px")}};var B=function(){for(var D=0;D<C.length;D++){C[D].div.removeClassName("first-crumb");C[D].div.removeClassName("crumbs-with-home");C[D].div.removeClassName("last-crumb");if(D===0){C[D].div.addClassName("first-crumb");if(r){C[D].div.addClassName("crumbs-with-home")}}if(C[D].lastBreadCrumb){C[D].div.addClassName("last-crumb")}C[D].div.setStyle("z-index",o-D)}f()};var n=function(H){var F=null;var E=H.changedTouches[0].clientX,D=H.changedTouches[0].clientY;var G=e.getPosition();e.getChildren().some(function(L){var N=L.getPosition(),J=L.getDimensions();var K=N.x+G.x,O=K+J.width;var I=N.y+G.y,M=I+J.height;if(typeof L.idthumb==="number"&&(L.idthumb<C.length-1)){O+=16}if(K<=E&&E<=O&&I<=D&&D<=M){F=L;return true}return false});return F};var k=function(D){if(D&&A===D){D.addClassName("navigationBreadCrumbActivated")}if(D&&D.idthumb!=="Home"&&!g){g=setTimeout(function(){D.querySelector("p").addClassName("navigationBreadCrumbExpand");g=null},1000)}};var s=function(D){if(D){D.removeClassName("navigationBreadCrumbActivated")}if(D&&D.idthumb!=="Home"){if(g){clearTimeout(g);g=null}else{if(!A||A!==D){D.querySelector("p").removeClassName("navigationBreadCrumbExpand")}}}};var y=function(D){if(A&&D&&A===D.div){A.removeClassName("navigationBreadCrumbActivated");D.cb()}A=null};var p=function(D){if(D.touches.length!==1){return}D.preventDefault();D.stopPropagation();k(A=u=n(D))};var t=function(E){if(E.touches.length!==1){return}E.preventDefault();E.stopPropagation();var D=n(E);if(D!==u){s(u);k(D);u=D}};var m=function(D){D.preventDefault();D.stopPropagation();var E=n(D);y(E?(E.idthumb==="Home"?r:C[E.idthumb]):null);s(E)};var h=function(D){var E=D.target.idthumb;k(E==="Home"?r.div:C[E].div)};var x=function(D){var E=D.target.idthumb;s(E==="Home"?r.div:C[E].div)};var v=function(E){if(E.button!==0||E.buttons!==1){return}var F=E.target.idthumb;k(A=F==="Home"?r.div:C[F].div);var D=a.subscribe({event:"/VISU/onLeftMouseUp"},function(G){a.unsubscribe(D);D=undefined;var I=G.from[0].event.target.idthumb;var H=I==="Home"?r.div:(typeof I==="number"?C[I].div:null);if(H!==A){A.querySelector("p").removeClassName("navigationBreadCrumbExpand");A=null}})};var z=function(D){if(!A||D.button!==0||D.buttons!==0){return}var E=D.target.idthumb;y(E==="Home"?r:C[E])};this.activate=function(D){if(e){if(D!=="Home"){C[D].cb()}else{r.cb()}}};function q(){if(!e){e=b.createElement("ul",{"class":"navigationBreadCrumb"}).inject(l)}}function i(){if(e){if(C.length===0&&!r){e.destroy();e=null}else{B()}}}this.addHomeBreadCrumb=function(E){if(!E||r){return undefined}q();r={};r.div=b.createElement("li",{"class":"navigationBreadCrumb homeBreadCrumb"});var D=b.createElement("span",{"class":"homeBreadCrumb fonticon fonticon-home"}).inject(r.div);D.idthumb="Home";if(C.length===0){e.appendChild(r.div)}else{e.insertBefore(r.div,C[0].div)}r.cb=function(){return E.cb?E.cb({div:r.div}):undefined};r.div.setStyle("opacity","1");r.div.setStyle("right","0px");r.div.idthumb="Home";r.div.addEvents({mousedown:v,mouseup:z,mouseenter:h,mouseleave:x});r.div.addEvents({touchstart:p,touchmove:t,touchend:m});B();return r.div};this.removeHomeBreadCrumb=function(){if(e&&r){r.div.removeEvents();e.removeChild(r.div);r=null}i()};this.addBreadCrumb=function(F){q();var D=b.createElement("li",{"class":"navigationBreadCrumb"}).inject(e);D.idthumb=C.length;var G=b.createElement("p").inject(D);G.idthumb=C.length;G.innerHTML=b.is(F.label)&&b.is(F.label,"string")?F.label:"";var E=b.createElement("span").inject(D);E.idthumb=C.length;C.push({div:D,cb:function(){return F.cb?F.cb({div:D}):undefined},lastBreadCrumb:F.lastBreadCrumb});D.addEvents({mousedown:v,mouseup:z,mouseenter:h,mouseleave:x});D.addEvents({touchstart:p,touchmove:t,touchend:m});B();setTimeout(function(){D.setStyle("opacity","1");D.setStyle("right","0px")},10);return D};function w(E,D){if(e){C[E].div.setStyle("opacity","0");C[E].div.setStyle("right","25px");C[E].div.removeEvents();e.removeChild(C[E].div);C.splice(E,1)}if(D){i()}}this.removeBreadCrumb=function(D){w(D,true)};this.setLabel=function(E,D){if(!e){return}if(E!=="Home"&&E<C.length){C[E].div.querySelector("p").innerHTML=D}};this.destroy=function(){for(var D=C.length-1;D>=0;D--){w(D,false)}this.removeHomeBreadCrumb()};this.show=function(){if(e){e.show()}};this.hide=function(){if(e){e.hide()}}}});return c});define("DS/CATC3DNavigation/CATC3DNavigationDefaultCmd",["DS/ApplicationFrame/Command","DS/CATRelatedDataLauncher/CATRelatedDataController","DS/PADUtils/PADContext","DS/CATC3DNavigation/CATC3DNavigationContoller","DS/ApplicationFrame/CommandsManager"],function(d,f,e,b,a){var c=d.extend({init:function(j){this._parent(j,{mode:"exclusive",isAsynchronous:true});this.setRepeatMode(false);var i=e.get(),h=i.getCommandContext?i.getCommandContext():null;var g=b.getNavigationContoller({context:i});var k=f.giveDataLauncherController({context:i});this.beginExecute=function(){k.setActiveState(true);a.getCommand("CAT3DComposeExamineSelectionHdr",h).activate();if(g){g.resume()}};this.endExecute=function(){k.setActiveState(false);var l=a.getCommand("CAT3DComposeExamineSelectionHdr",h);if(l){l.deactivate()}if(g){g.pause()}};this.pauseExecute=function(){k.setActiveState(false);var l=a.getCommand("CAT3DComposeExamineSelectionHdr",h);if(l){l.deactivate()}if(g){g.pause()}};this.resumeExecute=function(){k.setActiveState(true);var l=a.getCommand("CAT3DComposeExamineSelectionHdr",h);if(l){l.activate()}if(g){g.resume()}}}});return c});