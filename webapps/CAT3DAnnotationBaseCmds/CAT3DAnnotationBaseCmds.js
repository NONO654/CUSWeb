/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CAT3DAnnotationBaseCmds/panels/CAT3DAnnotationStandardsInfoPanel",["UWA/Core","UWA/Class","DS/Controls/Toggle","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/Tree/TreeListView","DS/Controls/Button","DS/Tree/TreeNodeModel","DS/CoreEvents/ModelEvents","DS/WebappsUtils/WebappsUtils","i18n!DS/CAT3DAnnotationBaseCmds/assets/nls/CAT3DAnnotStandardInfosPanel","text!DS/CAT3DAnnotationBaseCmds/assets/json/SemanticStandardsSymbols.json","css!DS/CAT3DAnnotationBaseCmds/CAT3DAnnotationBaseCmds.css"],function(h,b,k,d,j,l,i,c,e,g,f){var a=b.extend({init:function(s){this._parent(s);var t,B,z,o,u,r,A;var w=[];var D;var E=new c();var p=JSON.parse(f);function C(I){var N=[];var J=I.length?null:I.children[0];var L,H,F,K,M,G;if(!J){for(L=0;L<I.length;L++){for(H=0;H<I[L].children.length;H++){J=I[L].children[H];if(J!==undefined&&J.semanticStandards!==undefined){for(F=0;F<J.semanticStandards.standards.length;F++){N.push({nameAnnot:J.name,code:J.semanticStandards.standards[F].code,title:J.semanticStandards.standards[F].title,year:J.semanticStandards.standards[F].year,standard:J.semanticStandards.stdName,namePart:I[L].name})}if(J.semanticStandards.defaultSpecs){for(K=0;K<J.semanticStandards.defaultSpecs.length;K++){G="";if(J.semanticStandards.defaultSpecs[K].symbols){for(M=0;M<J.semanticStandards.defaultSpecs[K].symbols.length;M++){if(p[J.semanticStandards.defaultSpecs[K].symbols[M]]){G=G+p[J.semanticStandards.defaultSpecs[K].symbols[M]].character}}}N.push({nameAnnot:J.name,code:J.semanticStandards.defaultSpecs[K].code,subtype:J.semanticStandards.defaultSpecs[K].subtype,type:J.semanticStandards.defaultSpecs[K].type,year:J.semanticStandards.defaultSpecs[K].year,standard:J.semanticStandards.stdName,symbols:G,namePart:I[L].name})}}}}}}else{if(J!==undefined&&J.semanticStandards!==undefined){for(F=0;F<J.semanticStandards.standards.length;F++){N.push({nameAnnot:J.name,code:J.semanticStandards.standards[F].code,title:J.semanticStandards.standards[F].title,year:J.semanticStandards.standards[F].year,standard:J.semanticStandards.stdName,namePart:I.name})}if(J.semanticStandards.defaultSpecs){for(K=0;K<J.semanticStandards.defaultSpecs.length;K++){G="";if(J.semanticStandards.defaultSpecs[K].symbols){for(M=0;M<J.semanticStandards.defaultSpecs[K].symbols.length;M++){if(p[J.semanticStandards.defaultSpecs[K].symbols[M]]){G=G+p[J.semanticStandards.defaultSpecs[K].symbols[M]].character}}}N.push({nameAnnot:J.name,code:J.semanticStandards.defaultSpecs[K].code,subtype:J.semanticStandards.defaultSpecs[K].subtype,type:J.semanticStandards.defaultSpecs[K].type,year:J.semanticStandards.defaultSpecs[K].year,standard:J.semanticStandards.stdName,symbols:G,namePart:I.name})}}}}return N}function x(M,Q){o=C(M);var K=[];var P;var F="";switch(Q){case"0":var G;var J=[];var N;var L;for(P=0;P<o.length;P++){if(o[P]){G=o[P].namePart+" / "+o[P].nameAnnot;F=o[P].symbols||"";if(J.indexOf(G)!==-1){N=new i({label:" ",icons:null,grid:{name:" ",code:o[P].code,title:o[P].title?o[P].title:g[o[P].type]+" "+g[o[P].subtype],year:o[P].year}});N.symbols=F;K[J.indexOf(G)].addChild(N)}else{N=new i({label:G,icons:null,grid:{name:G,standard:o[P].standard,}});L=new i({label:" ",icons:null,grid:{name:" ",code:o[P].code,title:o[P].title,year:o[P].year}});L.symbols=F;N.addChild(L);K.push(N);J.push(G)}}}break;case"1":var I;var O=[];for(P=0;P<o.length;P++){if(o[P]){I=o[P].code;F=o[P].symbols||"";if(O.indexOf(I)!==-1){N=new i({label:" ",icons:null,grid:{code:" ",name:o[P].namePart+" / "+o[P].nameAnnot,title:o[P].title?o[P].title:g[o[P].type]+" "+g[o[P].subtype],year:o[P].year}});N.symbols=F;K[O.indexOf(I)].addChild(N)}else{N=new i({label:I,icons:null,grid:{code:I,standard:o[P].standard,}});L=new i({label:" ",icons:null,grid:{code:" ",name:o[P].namePart+" / "+o[P].nameAnnot,title:o[P].title,year:o[P].year}});L.symbols=F;N.addChild(L);K.push(N);O.push(I)}}w.push(N)}break;case"2":var H;var R=[];for(P=1;P<o.length;P++){if(o[P]){H=o[P].standard;F=o[P].symbols||"";if(R.indexOf(H)!==-1){N=new i({label:" ",icons:null,grid:{name:o[P].namePart+" / "+o[P].nameAnnot,code:o[P].code,title:o[P].title?o[P].title:g[o[P].type]+" "+g[o[P].subtype],year:o[P].year}});N.symbols=F;K[R.indexOf(H)].addChild(N)}else{N=new i({label:H,icons:null,grid:{standard:H,}});L=new i({label:" ",icons:null,grid:{name:o[P].namePart+" / "+o[P].nameAnnot,code:o[P].code,title:o[P].title,year:o[P].year}});L.symbols=F;N.addChild(L);K.push(N);R.push(H)}}w.push(N)}break;default:break}w=K;return K}var q=function(G){for(var F=0;F<w.length;F++){if(w[F]){G?w[F].expand():w[F].collapse()}}};var v=function(G,F){return E.publish({event:G,data:F,context:this})};function n(F){var H=F.cellView.getParent().getManager().getTreeNodeModelFromRowID(F.cellModel.getRowID());var G;if(F.dataIndex==="title"&&F.view.innerHTML&&H.symbols){G=h.createElement("p",{"class":"CAT3DAnnotSymbol"});G.innerHTML=H.symbols;if(H.symbols[0]==="&"){G.setStyle("font-family","DSISO1")}if(G.innerHTML&&G.innerHTML!==" "){G.inject(F.view)}}}function m(J,G){if(t){t.destroy();t=null}var I=j.SETTINGS.STANDARD;I.height="auto";I.width=800;I.show.rowHeaders=false;I.selection.preSelection=true;I.performances.renderingMode="standard";I.enableActiveUI=true;I.enableKeyboardNavigation=true;I.defaultCellHeight=34;I.enableDragAndDrop=false;I.onContextualEvent={callback:function(K){if(!K.treeview.nodeModel){return undefined}else{if(K.treeview.virtualRowID===-1){return[{type:"PushItem",title:g.Autofit,action:{callback:function(){K.treeview.manager.sizeColumnToFit(K.treeview.dataIndex)}}}]}}return[{type:"PushItem",title:g.ExpandAll,action:{callback:function(){q(true)}}},{type:"PushItem",title:g.CollapseAll,action:{callback:function(){q(false)}}}]}};if(G==="0"){I.columns=[{text:"Name",dataIndex:"tree",width:D.columnSize.name,isSortable:true,isDraggable:false,isEditable:false},{text:"Standard",dataIndex:"standard",width:D.columnSize.standard,isSortable:true,isDraggable:false,isEditable:false},{text:"Code",dataIndex:"code",width:D.columnSize.code,isSortable:true,isDraggable:false,isEditable:false},{text:"Year",dataIndex:"year",width:D.columnSize.year,isSortable:true,isDraggable:false,isEditable:false},{text:"Title",dataIndex:"title",width:D.columnSize.title,isSortable:false,isDraggable:false,isEditable:false,isResizable:true},]}else{if(G==="1"){I.columns=[{text:"Code",dataIndex:"tree",width:D.columnSize.code,isSortable:true,isDraggable:false,isEditable:false},{text:"Name",dataIndex:"name",width:D.columnSize.name,isSortable:true,isDraggable:false,isEditable:false},{text:"Standard",dataIndex:"standard",width:D.columnSize.standard,isSortable:true,isDraggable:false,isEditable:false},{text:"Year",dataIndex:"year",width:D.columnSize.year,isSortable:true,isDraggable:false,isEditable:false},{text:"Title",dataIndex:"title",width:D.columnSize.title,isSortable:false,isDraggable:false,isEditable:false,isResizable:true},]}else{I.columns=[{text:"Standard",dataIndex:"tree",width:D.columnSize.standard,isSortable:true,isDraggable:false,isEditable:false},{text:"Name",dataIndex:"name",width:D.columnSize.name,isSortable:true,isDraggable:false,isEditable:false},{text:"Code",dataIndex:"code",width:D.columnSize.code,isSortable:true,isDraggable:false,isEditable:false},{text:"Year",dataIndex:"year",width:D.columnSize.year,isSortable:true,isDraggable:false,isEditable:false},{text:"Title",dataIndex:"title",width:D.columnSize.title,isSortable:false,isDraggable:false,isEditable:false,isResizable:true},]}}z=I.columns;t=new j(I);var F=x(J,G);for(var H=0;H<F.length;H++){t.addRoot(F[H])}if(F.length===1){t.getRoots()[0].expand()}t.getManager().onCellRequest(n);t.getManager().onColumnWidthUpdate(function(){switch(D.groupBy){case"0":D.columnSize={name:z[0].width,standard:z[1].width,code:z[2].width,year:z[3].width,title:z[4].width};break;case"1":D.columnSize={name:z[1].width,standard:z[2].width,code:z[0].width,year:z[3].width,title:z[4].width};break;case"2":D.columnSize={name:z[1].width,standard:z[0].width,code:z[2].width,year:z[3].width,title:z[4].width};break;default:break}v("onPreferenceModified",D)});return t}function y(F,G){D.groupBy=F;v("onPreferenceModified",D);t=m(G,D.groupBy);t.inject(B)}this.buildPanel=function(K,F,J){this.cleanPanel();A=K;D=JSON.parse(F);u=h.createElement("div",{id:"CAT3DAnnotInfoMainDiv","class":"CAT3DAnnotInfoMainDiv"});B=h.createElement("div",{"class":"CAT3DAnnotStdInfoTreeDiv"});var G=h.createElement("div",{"class":"CAT3DAnnotStdInfoRadioDiv"});var M=new k({type:"label",label:g.RadioLabel}).inject(G);var H=new k({type:"radio",value:"option1",label:g.RadioButtonName,checkFlag:D.groupBy==="0"}).inject(G);var L=new k({type:"radio",value:"option2",label:g.RadioButtonCode,checkFlag:D.groupBy==="1"}).inject(G);var I=new k({type:"radio",value:"option3",label:g.RadioButtonStandard,checkFlag:D.groupBy==="2"}).inject(G);if(J){r=new l({label:g.ShowAllButton,onClick:function(){v("onShowAllClick")}}).inject(G);r.getContent().setStyles({"margin-left":"320px",display:"inline-block"})}M.getContent().setStyle("display","inline-block");H.getContent().setStyles({"margin-left":"20px",display:"inline-block"});L.getContent().setStyles({"margin-left":"20px",display:"inline-block"});I.getContent().setStyles({"margin-left":"20px",display:"inline-block"});G.inject(u);H.addEventListener("buttonclick",function(){y("0",A)});L.addEventListener("buttonclick",function(){y("1",A)});I.addEventListener("buttonclick",function(){y("2",A)});t=m(K,D.groupBy);t.inject(B);B.inject(u);return u};this.updatePanel=function(F){A=F;if(r){r.getContent().setStyle("display","none")}t=m(F,D.groupBy);t.inject(B);B.inject(u);return u};this.cleanPanel=function(){if(t){t.destroy()}t=B=z=o=u=D=null;w.length=0};this.subscribe=function(G,F){if(!G||!F){return undefined}return E.subscribe({event:G},F)};this.unsubscribe=function(F){if(F===null||F===undefined){return}E.unsubscribe(F)}}});return a});define("DS/CAT3DAnnotationBaseCmds/CAT3DAnnotStandardsInfoCmd",["DS/ApplicationFrame/Command","DS/PADUtils/PADContext"],function(a,b){var c=a.extend({init:function(e){this.beginExecute=function(){};var d=this._destroy;this._destroy=function(){}}});return c});define("DS/CAT3DAnnotationBaseCmds/CAT3DAnnotationBaseCmds",[],function(){});define("DS/CAT3DAnnotationBaseCmds/controllers/CAT3DAnnotSwitchOnOffController",["UWA/Class","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader"],function(a,c){var b=a.extend({init:function(h){this._parent(h);var h=h||{};var g=false;var i=h.ctxViewer;var f;this.setActiveState=function(k){g=k;var l=this;if(!f){var j=setInterval(function(){f=c.giveAnnotationModelLoader({context:i});if(f&&f.getLoaderType()!=="undefined"){clearInterval(j);return l.setActiveState(g)}},10);return}f.setGlobalFTAVisibilityFlag(!g)};this.getActiveState=function(){return g};this.clearController=function(){this.setActiveState(false);i=f=null}}});var e=[];var d=a.singleton({init:function(){},give3DAnnotSwitchOnOffController:function(g){if(g&&g.context){for(var f=0;f<e.length;f++){if(e[f].context===g.context){return e[f].controller}}}},get3DAnnotSwitchOnOffController:function(g){if(g&&g.context){var h=this.give3DAnnotSwitchOnOffController(g);if(h){return h}var f=new b({ctxViewer:g.context});h=Object.freeze({setActiveState:function(i){if(f){return f.setActiveState(i)}},getActiveState:function(){if(f){return f.getActiveState()}},clearController:function(){if(f){f.clearController();f=null}}});e.push({context:g.context,controller:h});return h}},unreference3DAnnotSwitchOnOffController:function(g){if(g&&g.context){for(var f=0;f<e.length;f++){if(e[f].context===g.context){e[f].controller.clearController();e.splice(f,1);break}}}}});return d});define("DS/CAT3DAnnotationBaseCmds/CAT3DAnnotationShowHideCmd",["DS/ApplicationFrame/Command","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/PADUtils/PADContext","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils"],function(g,d,f,h,c,b,e){var a=g.extend({init:function(i){this._parent(i,{mode:"shared",isAsynchronous:true});this.setRepeatMode(false)},beginExecute:function(){var u=function(F){var D;if(F.getLastElement(true).getAnnotationClassType){var E=F;while(E){D=E.getLastElement(true);if(D.getAnnotationClassType&&D.getAnnotationClassType()==="tpsAnnotationSet"){return E}E=E.getParentPath()}return null}var B=F.getChildrenPathes();for(var C=0;C<B.length;C++){D=B[C].getLastElement(true);if(D.getAnnotationClassType&&D.getAnnotationClassType()==="tpsAnnotationSet"){return B[C]}}};var o=h.get();var m=0;if(o){this.ctxBarPosition=this.getFrameWindow().getContextualUIManager().getContextualBar().getPosition();this.ctxBarPosition=this.ctxBarPosition?{x:this.ctxBarPosition.x,y:this.ctxBarPosition.y}:{x:0,y:0};var y=c.giveAnnotationModelLoader({context:o});var s=d.get();var A=this.options.ID==="CAT3DAnnotationShowHdr"||this.options.ID==="CAT3DAnnotationSetShowHdr";for(var q=0;q<s.length;q++){var t=s[q].pathElement.clone();if(t.internalPath.length){while(t.internalPath.length){t=t.getParentPath()}}while(!e.isPLMNode(t.getLastElement(true))&&!t.getLastElement(true).getAnnotationClassType){t=t.getParentPath()}var i=u(t);var v=t.getLastElement(true);var x;if(v.getAnnotationClassType){v.setVisibility(A);var j=v.getAnnotationClassType();if(j==="tpsView"||j==="tpsCapture"){var r=v.getVisibleAnnotations(i,true);for(x=0;x<r.length;x++){r[x].getLastElement(true).setVisibility(A)}}else{if(j==="tpsAnnotationSet"&&A){y.loadFTALightModel(i.getParentPath())}}}else{if(e.is3DLeaf(v)){var p=false;if(i){p=true;i.getLastElement(true).setVisibility(A);if(A){y.loadFTALightModel(i.getParentPath())}}if(!p&&A){y.loadFTALightModel(t,true,false);m=500}}else{var n;if(e.getNodeType(v)==="CATProduct"){n=y.getDirectChildrenAnnotSets(t);if(n.length){for(x=0;x<n.length;x++){if(n[x].getLastElement(true).getContextType()===2||n[x].getParentPath().isEqual(t)){n[x].getLastElement(true).setVisibility(A)}}}if(A){y.loadFTALightModel(t,A,false);var k=b.getPreference("3DAnnotLoadARMPartsPref");if(k){y.loadFTALightModel(t,true,false,[2]);m=500}}}else{n=y.getDirectChildrenAnnotSets(t);if(n.length){for(x=0;x<n.length;x++){n[x].getLastElement(true).setVisibility(A)}}var l=t.getChildrenPathes();y.loadFTALightModel(t,true,false);for(x=0;x<l.length;x++){y.loadFTALightModel(l[q],true,false);var z=l[x].getChildrenPathes();if(z.length===1){y.loadFTALightModel(z[0],true,false)}}m=500}}}}o.getViewer().render()}var w=this;setTimeout(function(){w.end()},m)},endExecute:function(){var i=d.get();var k=[];for(var j=0;j<i.length;j++){k.push({pathElement:i[j].pathElement.clone()})}d.empty();f.empty();d.add(k);f.add(k);this.getFrameWindow().getContextualUIManager().showContextualBar({hideWithDistance:true,x:this.ctxBarPosition.x,y:this.ctxBarPosition.y});this.ctxBarPosition=null}});return a});define("DS/CAT3DAnnotationBaseCmds/panels/CAT3DAnnotationThumbnailPanel",["UWA/Core","UWA/Class","DS/CoreEvents/ModelEvents","DS/CAT3DAnnotationBaseUI/CAT3DAnnotationBrowserSection","DS/CATWebUXComponents/CATWebUXThumbnail","UWA/Controls/ThemedScroller","DS/WebappsUtils/WebappsUtils","DS/CATWebUXComponents/CATWebUXSectionHeader","i18n!DS/CAT3DAnnotationBaseCmds/assets/nls/CAT3DAnnotationBaseCmds","css!DS/CAT3DAnnotationBaseCmds/CAT3DAnnotationBaseCmds.css"],function(e,a,b,i,h,g,c,j,d){var f=a.extend({init:function(w){this._parent(w);var s=false;var l=[];var m;var t;var o;var v=new b();var q;this.buildPanel=function(E){this.cleanPanel();var z=0;q=E.backgroundColor;for(var J=0;J<E.length;J++){for(var D=0;D<E[J].children.length;D++){if(E[J].children[D].isVisible){z++}}}if(z>0){if(!m){m=e.createElement("div",{id:"CAT3DAnnotThumbMainDiv"})}m.setStyles({height:"100%"});var G=e.createElement("div",{"class":"CAT3DAnnotSectionMainDiv"}).inject(m);G.setStyles({"background-color":"rgba(255, 255, 255, 0)",height:"100%"});var F=c.getWebappsAssetUrl("CAT3DAnnotationBaseCmds","icons/22/")+"I_CAT3DAnnotResetDisplayHistory.png";var B=[];if(w.additionalCmdAvailability){B.push({type:"button",nls:d.ResetDisplayHistoryLbl,icon:F,cb:function(){k("onDeleteDisplayHistory",{})}})}o=new j({fontIcon:"fonticon fonticon-viewBrowser",sectionLabel:d.viewBrowserPanelLbl,cmdList:B,doubleClickCB:function(){k("onBrowserPanelResized")}});G.appendChild(o.getContent());var A=e.createElement("div",{"class":"CAT3DAnnotThumbMainContainer"});var C=0;var H,J;for(J=0;J<E.length;J++){H=false;for(var D=0;D<E[J].children.length;D++){var I=E[J].children[D];if(I.isVisible){if(I.semanticStandards){if(I.semanticStandards.standards.length||I.semanticStandards.defaultSpecs.length){H=true}}var x={id:J,thumbnails:p(I,[J,D]),section:{idPath:[J,D],name:I.referenceLabel+" / "+I.name,icon:I.referenceIcon}};if(x.thumbnails.length){for(var y=0;y<x.thumbnails.length;y++){x.hasInfos=H}l.push(x);C+=x.thumbnails.length}}}}if(l.length){for(J=0;J<l.length;J++){l[J].section.view=new i({touchMode:false,name:l[J].section.name,icon:l[J].section.icon,children:l[J].thumbnails,id:l[J].id,displayInExpanders:l.length>1,displayInfoButton:l[J].hasInfos,onInfoButtonClick:function(K){k("onInfoClick",E[K])}});A.appendChild(l[J].section.view.getContent())}}if(!C){return null}o.setHeaderLabel(d.viewBrowserPanelLbl+" ("+C+")");t=new g().inject(G);t.getInnerElement().setContent(A);t.getContent().setStyle("height","calc(100% - 40px)");r();return m}};var r=function(){var A=[];for(var y=0;y<l.length;y++){for(var z=0;z<l[y].thumbnails.length;z++){var B={idPath:l[y].thumbnails[z].idPath,dataTypes:[]};var x=false;if(!l[y].thumbnails[z].preview){x=true;B.dataTypes.push("preview")}if(l[y].thumbnails[z].displayFlag!==true&&l[y].thumbnails[z].displayFlag!==false){x=true;B.dataTypes.push("displayFlag")}if(x){A.push(B)}}}k("onAdditionalInfosRequired",A)};this.cleanPanel=function(){if(!m){return}for(var x=0;x<l.length;x++){if(l[x].section.view){l[x].section.view.clear()}for(var y=0;y<l[x].thumbnails.length;y++){l[x].thumbnails[y].view.clear()}}while(m.firstChild){m.removeChild(m.firstChild)}l.splice(0,l.length);if(o){o.clear()}if(t){t.destroy()}o=null;t=null};this.setDisplayOnlyCapturesFlag=function(x){s=x};this.getThumbnailsIDPaths=function(){var x=[];for(var y=0;y<l.length;y++){for(var z=0;z<l[y].thumbnails.length;z++){x.push(l[y].thumbnails[z].idPath)}}return x};this.setAdditionalInformations=function(D){for(var y=0;y<D.length;y++){var C=u(D[y].idPath);if(C){var x=C.thumbnail;var A=Object.keys(D[y].infos);var B=false;for(var z=0;z<A.length;z++){if(A[z]==="preview"){x.preview=D[y].infos[A[z]];x.view.setPreview(x.preview)}else{if(A[z]==="displayFlag"){x.displayFlag=D[y].infos[A[z]];x.view.setDisplayFlag(x.displayFlag,false);B=true}}}if(B&&C.section.view){C.section.view.updateShadingColor()}}}};var u=function(x){if(x.length!==4){return null}for(var y=0;y<l.length;y++){if(l[y].section.idPath[0]===x[0]&&l[y].section.idPath[1]===x[1]){for(var z=0;z<l[y].thumbnails.length;z++){if(l[y].thumbnails[z].idPath[2]===x[2]&&l[y].thumbnails[z].idPath[3]===x[3]){return{section:l[y].section,thumbnail:l[y].thumbnails[z]}}}}}};this.subscribe=function(y,x){if(!y||!x){return undefined}return v.subscribe({event:y},x)};this.unsubscribe=function(x){if(x===null||x===undefined){return}v.unsubscribe(x)};var n=function(y){if(o){o.closeContextualSectionHeader()}var x=u(y.data.idPath);x.thumbnail.displayFlag=true;if(!x.thumbnail.view.getDisplayFlag()){x.thumbnail.view.setDisplayFlag(true);if(x.section.view){x.section.view.updateShadingColor()}}k("onThumbnailSelected",y.data)};var p=function(O,B){var x=[];var M,N;for(var D=0;D<O.children.length;D++){if(O.children[D].type==="RootViews"){M=D}else{if(O.children[D].type==="RootCaptures"){N=D}}}if(s&&O.children[N].children.length){for(var D=0;D<O.children[N].children.length;D++){var H=O.children[N].children[D];var I={};I.idPath=[B[0],B[1],N,D];I.displayFlag=H.displayFlag;I.type=H.type;I.view=new h({id:"3DAnnotBrowserThumb_"+I.idPath[0]+"_"+I.idPath[1]+"_"+I.idPath[2]+"_"+I.idPath[3],width:154,height:118,data:{idPath:I.idPath,label:H.name,icon:H.icon},displayFlag:I.displayFlag,title:H.name,icon:H.icon,preview:H.preview,clickCB:n,backgroundColor:q});x.push(I)}}else{if(!s){for(var D=0;D<O.children[M].children.length;D++){var E=O.children[M].children[D];if(E.isSubView){continue}var I={};var J=null;var C=[B[0],B[1],M,D];var L=E.associatedCapture;I.displayFlag=E.displayFlag;I.type=E.type;var F=E.preview;if(L&&L.length){var G=O.children[N].children[L[0]-1];J=G.name;C=[B[0],B[1],N,L[0]-1];I.displayFlag=G.displayFlag;if(G.preview){F=G.preview}}I.idPath=C.slice(0,C.length);I.view=new h({id:"3DAnnotBrowserThumb_"+I.idPath[0]+"_"+I.idPath[1]+"_"+I.idPath[2]+"_"+I.idPath[3],width:154,height:118,data:{idPath:I.idPath,label:E.name,icon:E.icon},displayFlag:I.displayFlag,title:E.name,icon:E.icon,subtitle:J,preview:F,clickCB:n,backgroundColor:q});x.push(I);if(L.length>1){for(var K=1;K<L.length;K++){var H=O.children[N].children[L[K]-1];var I={};I.displayFlag=H.displayFlag;I.idPath=[B[0],B[1],N,L[K]-1];I.type=H.type;I.view=new h({id:"3DAnnotBrowserThumb_"+I.idPath[0]+"_"+I.idPath[1]+"_"+I.idPath[2]+"_"+I.idPath[3],width:154,height:118,data:{idPath:I.idPath,label:H.name,icon:H.icon},displayFlag:I.displayFlag,title:H.name,icon:H.icon,subtitle:E.name,preview:H.preview,clickCB:n,backgroundColor:q});x.push(I)}}if(E.isMultiSectionView){for(var K=0;K<E.multiSectionData.views.length;K++){var A=O.children[M].children[E.multiSectionData.views[K]-1];if(!A.isSubView){continue}var y=A.associatedCapture;if(!y||(y&&!y.length)){continue}for(var z=0;z<y.length;z++){var H=O.children[N].children[y[z]-1];var I={};I.displayFlag=H.displayFlag;I.idPath=[B[0],B[1],N,y[z]-1];I.type=H.type;I.view=new h({id:"3DAnnotBrowserThumb_"+I.idPath[0]+"_"+I.idPath[1]+"_"+I.idPath[2]+"_"+I.idPath[3],width:154,height:118,data:{idPath:I.idPath,label:H.name,icon:H.icon},displayFlag:I.displayFlag,title:H.name,icon:H.icon,subtitle:A.name,preview:H.preview,clickCB:n,backgroundColor:q});x.push(I)}}}}for(var D=0;D<O.children[N].children.length;D++){var H=O.children[N].children[D];if(!H.pointedView){var I={};I.displayFlag=H.displayFlag;I.idPath=[B[0],B[1],N,D];I.type=H.type;I.view=new h({id:"3DAnnotBrowserThumb_"+I.idPath[0]+"_"+I.idPath[1]+"_"+I.idPath[2]+"_"+I.idPath[3],width:154,height:118,data:{idPath:I.idPath,label:H.name,icon:H.icon},displayFlag:I.displayFlag,title:H.name,icon:H.icon,preview:H.preview,clickCB:n,backgroundColor:q});x.push(I)}}}}return x};var k=function(y,x){return v.publish({event:y,data:x,context:this})}}});return f});define("DS/CAT3DAnnotationBaseCmds/CAT3DAnnotationLevelSelectorCmd",["DS/ApplicationFrame/Command","DS/LevelSelector/LevelSelector","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/PADUtils/PADContext","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils"],function(b,f,d,c,g,i){var h=function(k){if(!k){return false}var j=k;while(j){if(j.getLastElement(true).getAnnotationClassType){break}j=j.getParentPath()}return j};var e=function(j){if(!j){return null}var m=j.getLastElement(true).getAnnotationID!==undefined?j.getLastElement(true).getAnnotationID():null;var q=j.getParentPath().getParentPath();if(!q.getLastElement(true).getAnnotationClassType||q.getLastElement(true).getAnnotationClassType()!=="tpsAnnotationSet"){return null}var k=null;var o=q.getChildrenPathes();for(var r=0;r<o.length;r++){if(o[r].getLastElement(true).getAnnotationType()==="RootViews"){k=o[r];break}}if(k){var p=k.getChildrenPathes();for(var r=0;r<p.length;r++){var l=p[r].getLastElement(true).getTPSList();if(l&&l.length){for(var n=0;n<l.length;n++){if(l[n]===m){return p[r]}}}}}};var a=b.extend({init:function(l){this._parent(l,{mode:"shared",isAsynchronous:true});this.setRepeatMode(false);var q=this;var p=g.get();var o;var j;var n=false;var m=0;var k={x:0,y:0};this.beginExecute=function(){m=d.onEmpty(function(){if(q._isRunning&&!n){q.end()}});var r=q.getFrameWindow().getContextualUIManager().getContextualBar();k=r&&r.getPosition()?r.getPosition():{x:0,y:0};if(r){k.x=k.x+r.elements.container.getDimensions().width-40*window.devicePixelRatio;k.y=k.y-r.elements.container.getDimensions().height/2-10*window.devicePixelRatio;r.hide()}},this.execute=function(){var t=o;if(!t){var w=d.get();o=w.length>0?w[w.length-1]:undefined;t=o}if(("pathElement" in t)&&t.pathElement){var v=t.pathElement;var s=h(v);var u;if(s){u=function(){var z=[];var B={levels:z};if(s.getLastElement(true).getAnnotationClassType&&s.getLastElement(true).getAnnotationClassType()==="tpsAnnotationSet"){return}z.push({pathElement:s,name:s.getLastElement(true).getAnnotationName(),icon:s.getLastElement(true).getAnnotationIcon()});var A=s.getParentPath();if(A.getLastElement(true).getAnnotationClassType&&A.getLastElement(true).getAnnotationClassType()==="tpsRoot"){var y=A.getLastElement(true).getAnnotationType?A.getLastElement(true).getAnnotationType():null;if(y&&(y!=="RootViews"&&y!=="RootCaptures"&&y!=="RootGeometries")){var x=e(s);if(x){z.push({pathElement:x,name:x.getLastElement(true).getAnnotationName(),icon:x.getLastElement(true).getAnnotationIcon()})}}A=A.getParentPath()}if(A.getLastElement(true).getAnnotationClassType&&A.getLastElement(true).getAnnotationClassType()==="tpsAnnotationSet"){z.push({pathElement:A,name:A.getLastElement(true).getAnnotationName(),icon:A.getLastElement(true).getAnnotationIcon()})}return B}}else{u=function(G){var H=[];var x=[],B=[];var y=v;while(y){var z=y.getLastElement(true);if(i.isPLMNode(z)&&(i.isReference(z)||i.is3DLeaf(z))){var I={pathElement:y,idRef:i.getNodeID(z)};H.push(I);x.push(I.idRef);B.push({node:y.getLastElement(true),id:I.idRef});var E=y.externalPath.length>1?y.externalPath[y.externalPath.length-2]:null;if(i.isPLMNode(E)&&i.isInstance(E)){x.push(I.idInst=i.getNodeID(E));B.push({node:E,id:I.idInst})}}y=y.getParentPath()}var D=function(J){H.forEach(function(K){K.name=J[K.idRef]?J[K.idRef]["ds6w:label"]:"";if(K.idInst&&J[K.idInst]&&J[K.idInst]["ds6w:label"]){K.name+=" ("+J[K.idInst]["ds6w:label"]+")"}K.icon=J[K.idRef]?J[K.idRef].type_icon_url:undefined;delete K.idRef;delete K.idInst});G(H)};if(i.getLoadedAssetType()==="3DXML"){var C=[];for(var F=0;F<B.length;F++){var A=i.getNodeInfos(B[F].node);C[B[F].id]={};C[B[F].id]["ds6w:label"]=A.name;C[B[F].id].type_icon_url=A.icon}D(C)}else{p.getController().getAttributes({ids:x,attributes:["ds6w:label","type_icon_url"],callbacks:{onComplete:D,onFailure:function(){G(H)}}})}return H}}var r={positionX:k.x,positionY:k.y,uiFrame:p.getFrameWindow().getUIFrame(),getLevels:u,onHover:function(x){c.empty();c.add(x)},onLeave:function(x){if(o){c.remove(x);c.add(o)}},onSelect:function(y){n=true;d.empty();c.empty();o.pathElement=y.pathElement;var x=o;setTimeout(function(){q.end();d.add(x);c.add(x);q.getFrameWindow().getContextualUIManager().showContextualBar({hideWithDistance:true})},0);n=false}};f.createView(r)}else{q.end()}};this.endExecute=function(){if(this._isRunning){o=undefined;j=undefined;f.destroyView()}d.unsubscribe(m)}}});return a});define("DS/CAT3DAnnotationBaseCmds/CAT3DAnnotationPreferencesCmd",["UWA/Core","DS/Controls/Toggle","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/ApplicationFrame/Command","DS/Controls/Button","DS/Windows/Dialog","DS/PADUtils/PADContext"],function(b,l,e,o,k,f,m){var d="";var j="";var r="";var t="";var i="";var c="";var a="";var n="";var h="",g="",q="",p="";require(["i18n!DS/CAT3DAnnotationBaseCmds/assets/nls/CAT3DAnnotationBaseCmds"],function(u){d=u.PreferencesLbl;t=u.DefaultParamsLbl;j=u.SaveLbl;r=u.CancelLbl;i=u.WhiteVecAsBlackLbl;c=u.LoadARMPartsLbl;n=u.UpdateThumbnailsLbl;a=u.DisplayCapturesLbl;h=u.FavoriteContextLabel;g=u.FavoriteContextOpen;q=u.FavoriteContextCheck;p=u.FavoriteContextIgnore});var s=o.extend({init:function(u){this._parent(u,{mode:"shared",isAsynchronous:true});this.setRepeatMode(false)},beginExecute:function(){var z=this,w;var v=this.getPreferencePanel();var x=new k({emphasize:"primary",touchMode:true,label:j,onClick:function(){v.saveCB();if(w.close){w.close()}else{w.destroy()}}});var u=new k({label:t,touchMode:true,onClick:v.resetCB});var y=new k({label:r,touchMode:true,onClick:function(){if(w.close){w.close()}else{w.destroy()}}});w=new f({touchMode:true,modalFlag:true,ensureHeightDefinitionOnHierarchy:true,title:d,content:v.body,immersiveFrame:m.get().getFrameWindow().getImmersiveFrame(),buttons:{Cancel:y,Ok:x,Apply:u}});w.addEventListener("close",function(){z.end()})},endExecute:function(){},getPreferencePanel:function(){var C=e.getPreference("3DAnnotLoadARMPartsPref");var A=e.getPreference("3DAnnotDisplayCapturesPref");var I=e.getPreference("3DAnnotWhiteVectorAsBlack");var w=e.getPreference("3DAnnotUpdateThumbnailsPref");var y=e.getPreference("FavoriteContextLoadMode");var x=b.createElement("div");var u=new l({label:i,value:"3DAnnotWhiteVectorAsBlack",type:"checkbox",checkFlag:I}).inject(x);var J=new l({label:c,value:"3DAnnotLoadARMPartsPref",type:"checkbox",checkFlag:C}).inject(x);var F=new l({label:a,value:"3DAnnotDisplayCapturesPref",type:"checkbox",checkFlag:A}).inject(x);var H=new l({label:n,value:"3DAnnotUpdateThumbnailsPref",type:"checkbox",checkFlag:w}).inject(x);var E,G,B;b.createElement("label",{text:h,styles:{"margin-bottom":"0px",padding:"10px 0px"}}).inject(x);var v=b.createElement("div",{styles:{"padding-bottom":"10px"}}).inject(x);E=new l({type:"radio",value:"option1",label:g,checkFlag:y==="0"}).inject(v);G=new l({type:"radio",value:"option2",label:q,checkFlag:y==="1"}).inject(v);B=new l({type:"radio",value:"option3",label:p,checkFlag:y==="2"}).inject(v);E.getContent().setStyle("margin-left","20px");G.getContent().setStyle("margin-left","20px");B.getContent().setStyle("margin-left","20px");function z(){var K=J.checkFlag;if(K!==C){e.setPreference("3DAnnotLoadARMPartsPref",K)}K=F.checkFlag;if(K!==A){e.setPreference("3DAnnotDisplayCapturesPref",K)}K=u.checkFlag;if(K!==I){e.setPreference("3DAnnotWhiteVectorAsBlack",K)}K=H.checkFlag;if(K!==w){e.setPreference("3DAnnotUpdateThumbnailsPref",K)}K=E.checkFlag?"0":G.checkFlag?"1":B.checkFlag?"2":"1";if(K!==y){e.setPreference("FavoriteContextLoadMode",K)}}function D(){J.checkFlag=false;F.checkFlag=false;u.checkFlag=true;H.checkFlag=true;G.checkFlag=true}return{body:x,saveCB:z,resetCB:D}}});return s});define("DS/CAT3DAnnotationBaseCmds/CAT3DAnnotationResetDisplayHistoryCmd",["DS/ApplicationFrame/Command","DS/PADUtils/PADContext","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader","DS/PADUtils/views/PADAlert"],function(d,e,c,a){var b="";require(["i18n!DS/CAT3DAnnotationBaseCmds/assets/nls/CAT3DAnnotationBaseCmds"],function(g){b=g.DisplayHistorySuccessfulLbl});var f=d.extend({init:function(g){this._parent(g,{mode:"shared",isAsynchronous:true});this.setRepeatMode(false)},beginExecute:function(){var j=e.get();var i=c.giveAnnotationModelLoader({context:j});var g=i.getLoadedAnnotationSets(j.getRootBagPath());for(var k=0;k<g.length;k++){var h=g[k].getLastElement(true).getRootAnnotationNode("RootCaptures");if(h&&h.children&&h.children.length){for(var l=0;l<h.children.length;l++){h.children[l].setDisplayFlag(false)}}var h=g[k].getLastElement(true).getRootAnnotationNode("RootViews");if(h&&h.children&&h.children.length){for(var l=0;l<h.children.length;l++){h.children[l].setDisplayFlag(false)}}}a.displayNotification({eventID:"info",msg:b});this.end()}});return f});define("DS/CAT3DAnnotationBaseCmds/CAT3DAnnotationSwitchOnOffCmd",["DS/ApplicationFrame/CommandCheckHeader","DS/PADUtils/PADContext","DS/CAT3DAnnotationBaseCmds/controllers/CAT3DAnnotSwitchOnOffController"],function(d,c,a){var b=d.extend({init:function(g){this._parent(g,{});var j=this;var h;var i=this.onStateChange(function(){if(!h){h=c.get()}a.get3DAnnotSwitchOnOffController({context:h}).setActiveState(j.getState());localStorage.setItem("CAT3DAnnotationSwitchOnOffCmd",j.getState()?"true":"false")});var f=this._destroy;this._destroy=function(){if(h){a.unreference3DAnnotSwitchOnOffController({context:h})}j._modelEvents.unsubscribe(i);f.call(j)};var e=localStorage.getItem("CAT3DAnnotationSwitchOnOffCmd");e=e==="true"?true:(e==="false"?false:undefined);this.setState(e===true?true:false,true)},_destroy:function(){this._parent()}});return b});define("DS/CAT3DAnnotationBaseCmds/CAT3DAnnotStandardsInfoMgr",["UWA/Class","DS/PADUtils/PADContext","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/CAT3DAnnotationBaseCmds/panels/CAT3DAnnotationStandardsInfoPanel","DS/Windows/Dialog","DS/Controls/Button","DS/CAT3DAnnotationController/CAT3DAnnotationController","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader","i18n!DS/CAT3DAnnotationBaseCmds/assets/nls/CAT3DAnnotStandardInfosPanel"],function(b,g,c,a,j,h,f,i,e){var d=b.extend({init:function(){this._parent();var p=this;var m=g.get();var n=f.giveAnnotationController({context:m});var o=i.giveAnnotationModelLoader({context:m});var l,k;this.build=function(r){var s;if(l){l.cleanPanel()}if(!n||!o){return}l=new a();l.subscribe("onPreferenceModified",function(x){c.setPreference("3DAnnotSemStd",JSON.stringify(x))});l.subscribe("onShowAllClick",function(){n.onAdditionalInfosRequired({cb:function(x){l.updatePanel(x)}})});var w=c.getPreference("3DAnnotSemStd");var v=true;if(o.getLoadedAnnotationSets().length===1){v=false}else{var u=0;for(var t=0;t<o.getLoadedAnnotationSets().length;t++){if(o.getLoadedAnnotationSets()[t].getLastElement().getSemanticStandards){u+=1}}if(u<2){v=false}}s=new h({emphasize:"primary",touchMode:true,label:e.CloseButton,onClick:function(){if(l){l.cleanPanel()}l=null;k.destroy()}});k=new j({modalFlag:true,maximizeButtonFlag:true,resizableFlag:true,width:750,height:800,ensureHeightDefinitionOnHierarchy:true,title:e.InfosPanelTitle,content:l.buildPanel(r,w?w:JSON.stringify({groupBy:"0",columnSize:{name:"200",code:"200",standard:"200",year:"200",title:"1000"}}),v),immersiveFrame:m.getFrameWindow().getImmersiveFrame(),buttons:{Close:s}});function q(y){if(k&&p){var x=y.keyCode||y.which;if(x===13||x===27){if(l){l.cleanPanel()}l=null;k.destroy()}}}k.addEventListener("close",function(){if(k&&p){if(l){l.cleanPanel()}l=null;k.destroy()}});k.addEventListener("keydown",function(x){q(x)});k.addEventListener("keypress",function(x){q(x)})};this.clearManager=function(){this.destroyPanel();l=p=m=n=o=null};this.destroyPanel=function(){if(l){l.cleanPanel()}if(k){k.destroy()}}}});return d});define("DS/CAT3DAnnotationBaseCmds/controllers/CAT3DAnnotationBrowserController",["UWA/Core","UWA/Class","DS/Visualization/ThreeJS_DS","DS/CAT3DAnnotationBaseCmds/panels/CAT3DAnnotationThumbnailPanel","DS/CATWebUXComponents/CATWebUXPanel","DS/CAT3DAnnotationController/CAT3DAnnotationController","DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader","DS/WebappsUtils/WebappsUtils","DS/ApplicationFrame/CommandsManager","DS/Visualization/SceneGraphUtils","DS/Visualization/Viewpoint","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/CAT3DAnnotationBaseCmds/CAT3DAnnotStandardsInfoMgr","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Selection/HSOManager","DS/Visualization/PathElement"],function(g,r,s,d,o,j,c,e,a,p,l,h,i,n,k,q){var f=r.extend({init:function(ab){this._parent(ab);var O=ab||{};var al=false;var J=false;var u=null;var W=null;var C;var U=true;var F=[];var K=O.ctxViewer;var aa;var P;var G;var N;var H=false;var D={},ah={},Z={};var ak=0,ac=0,ae=0,af=0;var X=0;var t=0;var ad=150;var L=0;var v=this;var I=g.createElement("canvas");var ag,aj;var an;this.setActiveState=function(ar){al=ar;if(!aa||!G){var ao=setInterval(function(){G=c.giveAnnotationModelLoader({context:K});aa=j.giveAnnotationController({context:K});if(aa&&G&&G.getLoaderType()!=="undefined"){clearInterval(ao);v.setActiveState(al)}},10);return}if(!v.getDataModel){aa.onAdditionalInfosRequired({controller:"AnnotBrowser",cb:function(){v.setActiveState(al)}});return}t=0;if(al){if(!H){P=new i();Z.onAnnotControllerActiveStateChanged=aa.subscribe("onAnnotControllerActiveStateChanged",function(at){if(at.state){Q()}else{Y()}});D.onAnnotModelLoaderActiveStateChanged=G.subscribe("onAnnotModelLoaderActiveStateChanged",function(at){if(at.state){Q()}else{Y()}});D.onAnnotationVisibilityModifiedToken=G.subscribe("onAnnotationVisibilityModified",function(at){if(at.annotNode.getAnnotationClassType()==="tpsAnnotationSet"){Q()}});D.onAnnotationSetLoadedToken=G.subscribe("onAnnotationSetLoaded",function(){R(true);Q();if(P){P.destroyPanel()}});D.onAnnotationSetPartiallyLoaded=G.subscribe("onAnnotationSetPartiallyLoaded",function(){R(true);Q()});D.onAnnotationSetRemovedToken=G.subscribe("onAnnotationSetRemoved",function(){ad=0;Q();if(P){P.destroyPanel()}});D.onAnnotationSetBeginLoadToken=G.subscribe("onAnnotationSetBeginLoad",function(){R(false)});D.onAnnotationSetLoadingFailedToken=G.subscribe("onAnnotationSetLoadingFailed",function(){R(true)});D.onNoAnnotationSetLoadedToken=G.subscribe("onNoAnnotationSetLoaded",function(at){if(at&&at.loadingAlreadyStarted){R(true)}});D.onAnnotationSetLoadingCanceledToken=G.subscribe("onAnnotationSetLoadingCanceled",function(){R(true)});C=h.getPreference("3DAnnotUpdateThumbnailsPref");S();ac=h.subscribe("onPreferenceModified",function(at){if(at.preference==="3DAnnotDisplayCapturesPref"){Q()}if(at.preference==="3DAnnotUpdateThumbnailsPref"){C=at.value;S()}});D.onVisuModificationToken=G.subscribe("onAnnotationParentVisibilityModified",function(){Q()});ak=K.subscribe({event:"onModelUpdated"},w);ae=K.getViewer().onBackgroundModify(w);af=K.getViewer().onSwapVisibleSpace?K.getViewer().onSwapVisibleSpace(function(){J=K.getViewer().getVisibleSpace()===0;if(K.getViewer().getVisibleSpace()===1){Q()}else{Y()}}):null;J=K.getViewer().getVisibleSpace()===0;ag=new l({viewer:K.getViewer()});H=true}Q()}else{if(H){var aq=Object.keys(D),ap;for(ap=0;ap<aq.length;ap++){G.unsubscribe(D[aq[ap]])}aq=Object.keys(Z);for(ap=0;ap<aq.length;ap++){aa.unsubscribe(Z[aq[ap]])}if(ac){h.unsubscribe(ac)}if(ae){K.getViewer().unsubscribe(ae)}if(af&&K.getViewer()){K.getViewer().unsubscribe(af)}if(ak){K.unsubscribe(ak)}D={};Z={};ac=0;ae=0;af=0;ak=0;Y();P.clearManager();ag=null;H=false;P=null}if(X){clearTimeout(X);X=0}if(L){clearTimeout(L);L=0}}};this.getActiveState=function(){return al};this.clearController=function(){this.setActiveState(false);if(u){var ap=Object.keys(ah);for(var ao=0;ao<ap.length;ao++){u.unsubscribe(ah[ap[ao]])}}ah={};if(W){W.setPanelVisibilityFlag(false);W.clean()}u=W=F=K=aa=G=v=I=ag=aj=null;an=null};this.setPanelVisibilityFlag=function(ao){U=ao;if(W&&u){W.setPanelVisibilityFlag(U&&u.getThumbnailsIDPaths().length!==0)}};this.getPanelVisibilityFlag=function(){return U};var w=function(){setTimeout(function(){if(al&&u){var ao=u.getThumbnailsIDPaths();for(var ap=0;ap<ao.length;ap++){var aq=ai(ao[ap]);if(aq&&aq.getLastElement(true).previewUpdated){aq.getLastElement(true).previewUpdated=false}}S()}},100)};var ai=function(ao){if(F&&F.length&&F[ao[0]]){if(F[ao[0]].children&&F[ao[0]].children[ao[1]]){if(F[ao[0]].children[ao[1]].path){var ap=F[ao[0]].children[ao[1]].path.getChildrenPathes();if(ap&&ap.length&&ap[ao[2]]){var aq=ap[ao[2]].getChildrenPathes();if(aq&&aq.length&&aq[ao[3]]){return aq[ao[3]]}}}}}return undefined};var S=function(){if(!Z.onViewOrCaptureDisplayed){Z.onViewOrCaptureDisplayed=aa.subscribe("onViewOrCaptureDisplayed",function(ao){an=ao;if(!("requestIdleCallback" in window)&&C){E(ao.path)}if(u){u.setAdditionalInformations([{idPath:z(ao.path),infos:{displayFlag:true}}])}})}if(!Z.onFilteringAndClippingRemoved){Z.onFilteringAndClippingRemoved=aa.subscribe("onFilteringAndClippingRemoved",function(){an=null})}if("requestIdleCallback" in window){window.requestIdleCallback(B)}};var B=function(ap){var ar=function(){window.requestIdleCallback(B)};if(!al||!u||!C||J){return}if(!K.getFrameWindow().getViewpoint().isMoving()&&ap.timeRemaining()>0&&t>=0&&k.get().length===0){var ao=u.getThumbnailsIDPaths();for(var aq=0;aq<ao.length;aq++){var at=ai(ao[aq]);if(at&&!at.getLastElement(true).previewUpdated){E(at,ar);return}}}else{setTimeout(ar,500)}};var E=function(ao,ap){if(!ao.getLastElement(true).previewUpdated){aa.getFTAViewOrCaptureDisplayInfos({path:ao,cb:function(aP){var aE;var av=K.getViewer();var aM=[ao],aS=[];var aq;var au=G.getLoadedAnnotationSets(K.getRootBagPath());for(aE=0;aE<au.length;aE++){if(au[aE].isAParentOf(ao)){aq=au[aE];aM.push(aq)}aS.push(au[aE])}if(!aq){if(ap){ap()}return}var aT=av.infinitePlane;av.displayInfinitePlane(false);var aD=av.useShadowPlane;av.setShadowPlane(false);var ax=av.useSSAO;av.setSSAO(false);var ay=av.getShadow();av.setShadow(false);var aU=av.getGrid();av.setGrid(false);var aI=av.getMirror(),aC=av.blurryMirror;av.setMirror(false,false);var aR=ao.getLastElement(true);var aA=aq.getChildrenPathes();for(aE=0;aE<aA.length;aE++){var aQ=aA[aE].getChildrenPathes();for(var aO=0;aO<aQ.length;aO++){aS.push(aQ[aO])}}var aN=K.getRootBagPath().getChildrenPathes();for(aE=0;aE<aN.length;aE++){if(aN[aE].isAParentOf(ao)){aM.push(aN[aE])}else{aS.push(aN[aE])}}var aL=v.getOverloadedPaths();if(aL){if(aL.hiddenBodies&&aL.hiddenBodies.length&&aL.hiddenBodies[0].getLastElement){for(aE=0;aE<aL.hiddenBodies.length;aE++){if(p.getVisibilityFromPath&&!p.getVisibilityFromPath(aL.hiddenBodies[aE])){p.applyVisibilityToPath(aL.hiddenBodies[aE],1)}}}if(aL.visibleBodies&&aL.visibleBodies.length&&aL.visibleBodies[0].getLastElement){for(aE=0;aE<aL.visibleBodies.length;aE++){if(p.getVisibilityFromPath&&p.getVisibilityFromPath(aL.visibleBodies[aE])){p.applyVisibilityToPath(aL.visibleBodies[aE],0)}}}}var aJ=[],aB=[];if((aP.hiddenBodies&&aP.hiddenBodies.length)||(aP.visibleBodies&&aP.visibleBodies.length)){if(aP.visibleBodies&&aP.visibleBodies.length){for(aE=0;aE<aP.visibleBodies.length;aE++){if(p.getVisibilityFromPath&&!p.getVisibilityFromPath(aP.visibleBodies[aE])){aB.push(aP.visibleBodies[aE]);p.applyVisibilityToPath(aP.visibleBodies[aE],1)}}}if(aP.hiddenBodies&&aP.hiddenBodies.length){for(aE=0;aE<aP.hiddenBodies.length;aE++){if((p.getVisibilityFromPath&&p.getVisibilityFromPath(aP.hiddenBodies[aE]))||!p.getVisibilityFromPath){aJ.push(aP.hiddenBodies[aE]);p.applyVisibilityToPath(aP.hiddenBodies[aE],0)}}}}if(an&&an.visibleAssyComponents&&an.visibleAssyComponents.length){aS=aS.concat(an.visibleAssyComponents)}if(an&&an.hiddenAssyComponents&&an.hiddenAssyComponents.length){aM=aM.concat(an.hiddenAssyComponents)}if(aP.visibleAnnotations&&aP.visibleAnnotations.length){aM=aM.concat(aP.visibleAnnotations)}if(aP.hiddenAssyComponents&&aP.hiddenAssyComponents.length){aS=aS.concat(aP.hiddenAssyComponents)}if(aP.visibleAssyComponents&&aP.visibleAssyComponents.length){aM=aM.concat(aP.visibleAssyComponents)}var az=v.getCurrentClipping();v.removeClipping(az);if(aP.clippingInfos){v.addClipping(aP.clippingInfos)}if(!aj){aj=new n(K.getRootBagPath().getLastElement(true))}av.getSceneGraphOverrideSetManager().pushSceneGraphOverrideSet(aj);var ar=aj.createOverride({pathes:aS});if(ar){ar.setVisibility(false)}var aw=aj.createOverride({pathes:aM});if(aw){aw.setVisibility(true)}var aK=av.getNodes();var aG=[],at;for(aE=0;aE<aK.length;aE++){if(aK[aE].name.indexOf("3D Grid")!==-1){aG.push(new n(aK[aE]));av.getSceneGraphOverrideSetManager().pushSceneGraphOverrideSet(aG[aG.length-1]);at=aG[aG.length-1].createOverride({pathes:[new q([aK[aE]])]});at.setVisibility(false)}}av.addViewpoint(ag);ag.setProjectionType(K.getFrameWindow().getViewpoint().getProjectionType());v.reframe(ag,aP.reframeInfos,0);var aH=A(ag,144,108);aR.setPreview(aH);aR.previewUpdated=true;u.setAdditionalInformations([{idPath:z(ao),infos:{preview:aH}}]);av.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(aj);var aF=[];if(ar){aF.push(ar)}if(aw){aF.push(aw)}if(aF.length){aj.deleteOverrides(aF)}av.removeViewpoint(av.getViewpoints().length-1);for(aE=0;aE<aG.length;aE++){av.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(aG[aE])}for(aE=0;aE<aJ.length;aE++){p.applyVisibilityToPath(aJ[aE],1)}for(aE=0;aE<aB.length;aE++){p.applyVisibilityToPath(aB[aE],0)}if(aL&&aL.hiddenBodies&&aL.hiddenBodies.length){for(aE=0;aE<aL.hiddenBodies.length;aE++){p.applyVisibilityToPath(aL.hiddenBodies[aE],0)}}if(aL&&aL.visibleBodies&&aL.visibleBodies.length){for(aE=0;aE<aL.visibleBodies.length;aE++){p.applyVisibilityToPath(aL.visibleBodies[aE],1)}}if(aT){av.displayInfinitePlane(aT)}if(aD){av.setShadowPlane(aD)}if(ax){av.setSSAO(ax)}if(ay){av.setShadow(ay)}if(aU){av.setGrid(aU)}if(aI||aC){av.setMirror(aI,aC)}if(aP.clippingInfos){v.removeClipping(aP.clippingInfos)}if(az){v.addClipping(az)}if(ap){ap()}}})}};var A=function(az,aq,ap){var av={data:null,width:Math.round(K.getViewer().SCREEN_WIDTH*window.devicePixelRatio),height:Math.round(K.getViewer().SCREEN_HEIGHT*window.devicePixelRatio)};K.getViewer().renderToTarget(av,az);var aA=av.width/av.height;if(aA>(aq/ap)){I.height=ap;I.width=I.height*aA}else{I.width=aq;I.height=I.width/aA}var au=2;I.width*=au;I.height*=au;var ar=I.getContext("2d");ar.clearRect(0,0,I.width,I.height);var aw=function(aG,aF,aE,aI,aH){if(aH){aF=aI-aF-1}return aE*Math.floor(aF)+Math.floor(aG)};var aC=ar.getImageData(0,0,I.width,I.height);var aB=av.width/aC.width,at=av.height/aC.height;for(var ax=0;ax<aC.height;ax++){for(var aD=0;aD<aC.width;aD++){var ao=aw(aD,ax,aC.width,aC.height,false);var ay=aw(aB*aD,at*ax,av.width,av.height,true);aC.data[4*ao]=av.data[4*ay];aC.data[4*ao+1]=av.data[4*ay+1];aC.data[4*ao+2]=av.data[4*ay+2];aC.data[4*ao+3]=av.data[4*ay+3]}}av.data=null;av=null;ar.putImageData(aC,0,0);return I.toDataURL("image/jpeg",0.3)};var z=function(av){for(var aq=0;aq<F.length;aq++){for(var ar=0;ar<F[aq].children.length;ar++){var ao=F[aq].children[ar].path;for(var at=0;at<ao.getChildrenPathes().length;at++){var ap=ao.getChildrenPathes()[at];for(var au=0;au<ap.getChildrenPathes().length;au++){if(ap.getChildrenPathes()[au].isEqual(av)){return[aq,ar,at,au]}}}}}return null};var R=function(ao){if(al){t+=ao===true?1:-1;if(L){clearTimeout(L);L=0}if(W){W.setEnableFlag(t>=0);if(t<0){L=setTimeout(function(){if(al&&W){W.setEnableFlag(true)}t=0},20000)}}}};var Q=function(){if(!al||!aa.getActiveState()){return}if(J){var ao=setInterval(function(){if(!J){clearInterval(ao);Q()}})}if(X){clearTimeout(X);X=0}X=setTimeout(function(){v._internalRefresh();ad=150;X=0},ad)};var Y=function(){if(X){clearTimeout(X);X=0}if(W){N=W.getWidth();W.clean();W=null}if(u){u.cleanPanel()}};this._internalRefresh=function(){if(!al||!v.getDataModel){Y();return}F.splice(0,F.length);v.getDataModel(function(au){if(!al){Y();return}F=au;for(var ap=0;ap<F.length;ap++){if(F[ap].children){for(var ar=0;ar<F[ap].children.length;ar++){var aq=F[ap].children[ar];if(aq.isVisible){for(var at=0;at<aq.children.length;at++){var ao=aq.children[at];if(ao.type==="RootViews"||ao.type==="RootCaptures"&&ao.children.length>0){y();if(W){W.setEnableFlag(t>=0)}return}}}}}}Y()})};var y=function(){if(!u){var au=a.getCommand("CAT3DAnnotationResetDisplayHistoryHdr",K.getCommandContext?K.getCommandContext():null);u=new d({additionalCmdAvailability:au!==undefined&&au!==null});ah={};ah.onBrowserPanelResized=u.subscribe("onBrowserPanelResized",T);ah.onInfoStandardsClicked=u.subscribe("onInfoClick",function(aw){P.build(aw)});ah.onThumbnailSelected=u.subscribe("onThumbnailSelected",V);ah.onDeleteDisplayHistory=u.subscribe("onDeleteDisplayHistory",am);ah.onAdditionalInfosRequired=u.subscribe("onAdditionalInfosRequired",x)}u.setDisplayOnlyCapturesFlag(h.getPreference("3DAnnotDisplayCapturesPref"));F.backgroundColor="#"+new s.Color(K.getViewer().backgroundColor).getHexString();var ar=u.buildPanel(F);if(ar){var aq,ao=313;var ap=M();var av=window&&window.widget?window.widget.id:"";if(sessionStorage.getItem("CAT3DAnnotBrowserExpFlag_"+av)==="true"){aq=parseFloat(sessionStorage.getItem("CAT3DAnnotBrowserWidth_"+av))}if(!aq){aq=N!==undefined?N:ap}aq=aq>=ap?aq:ap;if(!W){var at={id:"CAT3DAnnotBrowserPanel",className:"CAT3DAnnotBrowserSidePanel",showTitleFlag:false,icon:e.getWebappsAssetUrl("CAT3DAnnotationBaseCmds","icons/32/")+"I_CAT3DAnnotBrowser.png",immersiveFrame:K.getFrameWindow().getImmersiveFrame(),content:ar,minWidth:ap,width:aq,widthStep:165,minHeight:ao,height:ao,heightStep:129,allowedDockAreas:WUXDockAreaEnum.RightDockArea|WUXDockAreaEnum.LeftDockArea,currentDockArea:O.defaultDockingSide==="right"?WUXDockAreaEnum.RightDockArea:WUXDockAreaEnum.LeftDockArea,onPanelResizedCB:function(ax){if(ax.currentDockArea===WUXDockAreaEnum.RightDockArea||ax.currentDockArea===WUXDockAreaEnum.LeftDockArea){N=ax.width;if(ax.widthModifiedInteractively){var aw=window&&window.widget?window.widget.id:"";sessionStorage.setItem("CAT3DAnnotBrowserExpFlag_"+aw,"true");sessionStorage.setItem("CAT3DAnnotBrowserWidth_"+aw,ax.width)}}}};W=new o(at)}else{W.setMinWidth(ap)}W.setEnableFlag(t>=0)}if(W&&u){W.setPanelVisibilityFlag(U&&u.getThumbnailsIDPaths().length!==0)}S()};var T=function(){var aq=window&&window.widget?window.widget.id:"";if(typeof sessionStorage!=="undefined"){var ao=sessionStorage.getItem("CAT3DAnnotBrowserExpFlag_"+aq);if(ao==="true"){sessionStorage.setItem("CAT3DAnnotBrowserExpFlag_"+aq,"false");W.setWidth(M())}else{var ap=parseFloat(sessionStorage.getItem("CAT3DAnnotBrowserWidth_"+aq));if(ap&&ap!==M()){sessionStorage.setItem("CAT3DAnnotBrowserExpFlag_"+aq,"true");W.setWidth(ap)}}}};var M=function(){var ao=0;for(var aq=0;aq<F.length;aq++){if(F[aq].children){for(var at=0;at<F[aq].children.length;at++){var ar=F[aq].children[at];if(ar.isVisible){for(var au=0;au<ar.children.length;au++){var ap=ar.children[au];if((ap.type==="RootViews"||ap.type==="RootCaptures")&&ap.children.length>0){ao++;break}}}}}}return(ao===0||ao===1)?186:211};var V=function(ao){var ap=ai(ao.idPath);if(ap){aa.displayFTAViewOrCapture({path:ap,data:ap.getLastElement(true).getAnnotationType()===6?{label:ao.label,icon:ao.icon.replace("icons/22/","icons/32/")}:null});if(C&&!("requestIdleCallback" in window)&&!ap.getLastElement(true).previewUpdated){u.setAdditionalInformations([{idPath:ao.idPath,infos:{preview:null}}])}}};var am=function(){var aq=a.getCommand("CAT3DAnnotationResetDisplayHistoryHdr",K.getCommandContext?K.getCommandContext():null);if(aq){aq.begin();var ao=u.getThumbnailsIDPaths();var ar=[];for(var ap=0;ap<ao.length;ap++){ar.push({idPath:ao[ap],infos:{displayFlag:false}})}if(ar.length){u.setAdditionalInformations(ar)}}};var x=function(at){if(!at){return}var aw=[];for(var aq=0;aq<at.length;aq++){var au=ai(at[aq].idPath);if(au){var ap=au.getLastElement(true);var ao=at[aq].dataTypes;var av={idPath:at[aq].idPath,infos:{}};for(var ar=0;ar<ao.length;ar++){if(ao[ar]==="preview"){av.infos.preview=ap.getPreview()}else{if(ao[ar]==="displayFlag"){av.infos.displayFlag=ap.getDisplayFlag()}}}aw.push(av)}}u.setAdditionalInformations(aw)}}});var b=[];var m=r.singleton({init:function(){},give3DAnnotBrowserController:function(u){if(u&&u.context){for(var t=0;t<b.length;t++){if(b[t].context===u.context){return b[t].browserController}}}return undefined},get3DAnnotBrowserController:function(u){var v;if(u&&u.context){v=this.give3DAnnotBrowserController(u);if(!v){var t=new f({ctxViewer:u.context,defaultDockingSide:u.defaultDockingSide});v=Object.freeze({setActiveState:function(w){if(t){t.setActiveState(w)}},getActiveState:function(){if(t){return t.getActiveState()}return null},setPanelVisibilityFlag:function(w){if(t){t.setPanelVisibilityFlag(w)}},getPanelVisibilityFlag:function(){if(t){return t.getPanelVisibilityFlag()}return null},clearController:function(){if(t){t.clearController();t=null}},setDataModelMethods:function(y,x,A,z,w,B){if(t&&!t.dataModelInitialized){t.getDataModel=y;t.addClipping=x;t.removeClipping=A;t.getCurrentClipping=z;t.reframe=w;t.getOverloadedPaths=B;t.dataModelInitialized=true;if(t.getActiveState()){t._internalRefresh()}}}});b.push({context:u.context,browserController:v})}}return v},unreference3DAnnotBrowserController:function(u){if(u&&u.context){for(var t=0;t<b.length;t++){if(b[t].context===u.context){b[t].browserController.clearController();b.splice(t,1);break}}}}});return m});define("DS/CAT3DAnnotationBaseCmds/CAT3DAnnotationBrowserCmd",["DS/ApplicationFrame/CommandCheckHeader","DS/PADUtils/PADContext","DS/CAT3DAnnotationBaseCmds/controllers/CAT3DAnnotationBrowserController"],function(d,b,a){var c=d.extend({init:function(g){this._parent(g,{});var j=this;var h;var i=this.onStateChange(function(){if(!h){h=b.get()}var k=j.options&&j.options["arguments"]&&j.options["arguments"].length===1&&j.options["arguments"][0].ID==="defaultDockingSide"?j.options["arguments"][0].Value:null;a.get3DAnnotBrowserController({context:h,defaultDockingSide:k}).setActiveState(j.getState());localStorage.setItem("CAT3DAnnotationBrowserCmd",j.getState()?"true":"false")});var f=this._destroy;this._destroy=function(){if(h){a.unreference3DAnnotBrowserController({context:h})}j._modelEvents.unsubscribe(i);f.call(j)};var e=localStorage.getItem("CAT3DAnnotationBrowserCmd");e=e==="true"?true:(e==="false"?false:undefined);this.setState(e===false?false:true,true)},_destroy:function(){this._parent()}});return c});