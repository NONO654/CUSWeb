/*!  Copyright 2017 Dassault Systemes. All rights reserved. */
define(["DS/WebappsUtils/WebappsUtils","DS/SMAPoweredByState/ad-state-loading-utils","DS/SMAPoweredByState/ad-state-utils","DS/SMAPoweredByState/ad-state-defs","UWA/Class/Promise"],function(g,s,c,j,f){var A={};A.ErrorCodes={COS_RUNTIME_ERROR:"SMAPoweredByState.ad-state-wc-adapter.COS_RUNTIME_ERROR",COS_WS_NOT_FOUND:"SMAPoweredByState.ad-state-wc-adapter.COS_WS_NOT_FOUND",COS_RUNAS_CREDENTIALS_ERROR:"SMAPoweredByState.ad-state-wc-adapter.COS_RUNAS_CREDENTIALS_ERROR",COS_PRIVATE_STATION_USER_MISMATCH:"SMAPoweredByState.ad-state-wc-adapter.COS_PRIVATE_STATION_USER_MISMATCH",COS_PRIVATE_STATION_SERVER_MISMATCH:"SMAPoweredByState.ad-state-wc-adapter.COS_PRIVATE_STATION_SERVER_MISMATCH",COS_PRIVATE_STATION_NOT_FOUND:"SMAPoweredByState.ad-state-wc-adapter.COS_PRIVATE_STATION_NOT_FOUND",COS_BUILD_JOB_ERROR:"SMAPoweredByState.ad-state-wc-adapter.COS_BUILD_JOB_ERROR",COS_SSO_LOGIN_REQUEST_ERROR:"SMAPoweredByState.ad-state-wc-adapter.COS_SSO_LOGIN_REQUEST_ERROR"};var m="/resources/slmservices",t="adhoc",k=5,p=5000;var b=null,e=null,r=null,u=null,i=null,h=null,z=null,a=null;var d=window.Promise||f;function q(E,D){var F,G,C,B;if(r.$.dashboard.isInDashboard()){F=r.$.dashboard.getMcsUri()+D}else{G=window.location.pathname;if(G&&G.length>0){if(G[0]==="/"){G=G.substr(1)}C=G.split("/");if(C.length>0){B=C[0]}}F=window.location.protocol+"//"+window.location.host+"/"+B+D}return F+((E[0]!=="/")?"/":"")+E}function l(G,I,B,C){var H,F=function(){if(this.retryTimer){window.clearTimeout(this.retryTimer);delete this.retryTimer}if(this.successCallback){this.successCallback({objectID:I})}},E=function(J){if(this.numRetries<k){this.numRetries++;this.retryTimer=window.setTimeout(H.bind(this),p)}else{if(this.errorCallback){this.errorCallback(J)}}};H=function(){A.callSMAProcService({verb:"PUT",headers:{Accept:"text/plain"},data:this.checkinResponse,uri:"/fcs/commit",onComplete:F.bind(this),onError:E.bind(this)})};var D={numRetries:0,name:name,checkinResponse:G,successCallback:B,errorCallback:C};H.call(D)}function y(E,B,H,I,C,G,F){var D=new FormData(),J=new XMLHttpRequest();D.append("csrfTokenName","ENO_CSRF_TOKEN");D.append("noOfFiles","1");D.append("__fcs__jobTicket",H);if(E instanceof Blob){D.append("file",E,E.name)}else{D.append("bfile0",E);D.append("fileName0",E.name);D.append("format0","generic")}if(F&&J.upload){J.upload.onprogress=F}J.onreadystatechange=function(){if(J.readyState!==4){return}if(J.status===200){l(J.responseText,B,C,G)}else{if(G){G(J)}}};J.open("POST",I,true);J.send(D)}function x(F,C,H,D,I,G){var J,E=function(M){var N=JSON.parse(M.response),P,O,K,L;P=N.id;O=new DOMParser().parseFromString(N.fcsTicket,"text/xml");K=O.getElementsByTagName("Ticket")[0].textContent;L=O.getElementsByTagName("FcsUrl")[0].textContent;y(F,P,K,L,D,I,G)},B=function(K){if(I){I(K)}};J={uri:C,verb:H,onComplete:E,onError:B};A.callSMAProcService(J)}function o(B,D){var C=function(){var E=B;if((typeof D!=="undefined")&&(D!==null)){E=c.shallowCopy(B);E.uri=q(E.uri,D)}if(E.sessionTimeoutInfo){E.onSessionTimeout=function(F){E.sessionTimeoutInfo.handler(c.buildError(j.ErrorCodes.SESSION_TIMEOUT_ERROR,F,E.sessionTimeoutInfo.context))}}r.sendRequest(E)};if(!r){s.loadWebComponents([g.getWebappsBaseUrl()+"SMAProcSP/sp-mcsservice/sp-mcsservice.html",g.getWebappsBaseUrl()+"SMAProcSP/sp-dashboard/sp-dashboard.html"],["DS.SMAProcSP.SPMCSService","DS.SMAProcSP.SPDashboard"],function(){if(!r){r=document.createElement("sp-mcsservice");document.body.appendChild(r)}C()})}else{C()}}function w(B,D){var C=function(){var E=B;if((typeof D!=="undefined")&&(D!==null)){E=c.shallowCopy(B);E.uri=q(E.uri,D)}if(E.sessionTimeoutInfo){E.onSessionTimeout=function(F){E.sessionTimeoutInfo.handler(c.buildError(j.ErrorCodes.SESSION_TIMEOUT_ERROR,F,E.sessionTimeoutInfo.context))}}e.sendRequest(E)};if(!e){s.loadWebComponent(g.getWebappsBaseUrl()+"SMAProcSP/sp-webservice/sp-webservice.html","DS.SMAProcSP.SPWebservice",function(){if(!e){e=document.createElement("sp-webservice");document.body.appendChild(e)}C()})}else{C()}}function n(B){if(!a){s.loadWebComponent(g.getWebappsBaseUrl()+"SMAProcSP/sp-cos-filemonitor/sp-cos-filemonitor.html","DS.SMAProcSP.SPCOSFileMonitor",function(){if(!a){a=document.createElement("sp-cos-filemonitor");document.body.appendChild(a)}B()})}else{B()}}function v(B){if(B){B.linuxPass=null;B.windowsPass=null}}A.getDashboard=function(){return new d(function(B){if(!b){s.loadWebComponent(g.getWebappsBaseUrl()+"SMAProcSP/sp-dashboard/sp-dashboard.html","DS.SMAProcSP.SPDashboard",function(){if(!b){b=document.createElement("sp-dashboard");document.body.appendChild(b)}B(b)})}else{B(b)}})};A.callSMAProcService=function(B){o(B,m)};A.call3DSpaceService=function(B){o(B,"")};A.callENOService=function(B){o(B,null)};A.callSPWebService=function(B){w(B,null)};A.callCOSService=function(B){if(u){u.sendRequest(B)}else{s.loadWebComponent(g.getWebappsBaseUrl()+"SMAProcSP/sp-cosservice/sp-cosservice.html",null,function(){if(!u){u=document.createElement("sp-cosservice");document.body.appendChild(u)}u.sendRequest(B)})}};A.callUploadLocalFile=function(B){x(B.file,B.createURL,B.createMethod,(typeof B.onComplete!=="undefined")?B.onComplete:null,(typeof B.onFailure!=="undefined")?B.onFailure:null,(typeof B.onProgress!=="undefined")?B.onProgress:null)};A.callRefreshCOSConfigurations=function(B){if(i){i.refreshCosConfigurations(B.onComplete)}else{s.loadWebComponent(g.getWebappsBaseUrl()+"SMAProcSP/sp-cos/sp-cos.html",null,function(){if(!i){i=document.createElement("sp-cos");document.body.appendChild(i)}i.refreshCosConfigurations(B.onComplete)})}};A.callGetPrivateStations=function(B){var C,E=[],F=function(G){if(G){for(C=0;C<G.length;C++){if(G[C].info.cosid===B.serverID){E.push(G[C].info)}}}if(B.onComplete){B.onComplete(E)}},D=function(){if(B.onComplete){B.onComplete(E)}};if(i){i.getPrivateStationInfo({onComplete:F,onFailure:D})}else{s.loadWebComponent(g.getWebappsBaseUrl()+"SMAProcSP/sp-cos/sp-cos.html",null,function(){if(!i){i=document.createElement("sp-cos");document.body.appendChild(i)}i.getPrivateStationInfo({onComplete:F,onFailure:D})})}};A.callRunUpload=function(B){var F=null,D=null,C=function(){h.removeEventListener("success",F);h.removeEventListener("error",D)},E=function(){var G={successCallback:F,errorCallback:D};h.addEventListener("success",F);h.addEventListener("error",D);h.jobData=JSON.stringify(B.data);if(B.isLocalStation===true){G.forceHasLocalHost=true}if(B.credentials){B.credentials.encryptedCredentials=null;h.runSimulationAs(G,B.studyID,"",true,B.credentials,t,B.serverID)}else{h.runSimulation(G,B.studyID,"",true,t,B.serverID)}};F=function(G){G.stopPropagation();G.cancelBubble=true;G.preventDefault();v(B.credentials);if(B.onComplete){B.onComplete({serverID:G.detail.result.cosServerID,eedJobID:G.detail.result.EEDJobID,mcsJobID:G.detail.result.MCSJobID})}C();return true};D=function(G){var H=A.ErrorCodes.COS_RUNTIME_ERROR;G.stopPropagation();G.cancelBubble=true;G.preventDefault();v(B.credentials);if(G.detail.status===404){H=A.ErrorCodes.COS_WS_NOT_FOUND}else{if(G.detail.status===DS.SMAProcSP.SPRun.ERRORS.PRIVATE_STATION_USER_MISMATCH){H=A.ErrorCodes.COS_PRIVATE_STATION_USER_MISMATCH}else{if(G.detail.status===DS.SMAProcSP.SPRun.ERRORS.PRIVATE_STATION_SERVER_MISMATCH){H=A.ErrorCodes.COS_PRIVATE_STATION_SERVER_MISMATCH}else{if(G.detail.status===DS.SMAProcSP.SPRun.ERRORS.PRIVATE_STATION_NO_STATION_FOUND){H=A.ErrorCodes.COS_PRIVATE_STATION_NOT_FOUND}else{if(G.detail.status===DS.SMAProcSP.SPRun.ERRORS.BUILD_JOB_ERROR){H=A.ErrorCodes.COS_BUILD_JOB_ERROR}}}}}if(B.onFailure){B.onFailure({code:H,message:(G.detail.response)?G.detail.response:null})}C();return true};if(h){E()}else{s.loadWebComponent(g.getWebappsBaseUrl()+"SMAProcSP/sp-run/sp-run.html","DS.SMAProcSP.SPRun",function(){if(!h){h=document.createElement("sp-run");h.jobUrl="/resources/slmservices/jobs/uploadJob";h.timeout=60000;document.body.appendChild(h)}E()})}};A.callRunJob=function(B){var F=null,D=null,C=function(){z.removeEventListener("success",F);z.removeEventListener("error",D)},E=function(){z.addEventListener("success",F);z.addEventListener("error",D);if(B.credentials){B.credentials.encryptedCredentials=null;z.runSimulationAs(B.context?B.context:null,B.jobID,"",true,B.credentials,t,B.serverID?B.serverID:null,B.disablePrivateStationCheck)}else{z.runSimulation(B.context?B.context:null,B.jobID,"",true,t,B.serverID?B.serverID:null,B.disablePrivateStationCheck)}};F=function(G){G.stopPropagation();G.cancelBubble=true;G.preventDefault();v(B.credentials);if(B.onComplete){B.onComplete({serverID:G.detail.result.cosServerID,eedJobID:G.detail.result.EEDJobID,mcsJobID:G.detail.result.MCSJobID,credentials:G.detail.result.credentials})}C();return true};D=function(G){var H=A.ErrorCodes.COS_RUNTIME_ERROR;G.stopPropagation();G.cancelBubble=true;G.preventDefault();v(B.credentials);if(G.detail.status===404){H=A.ErrorCodes.COS_WS_NOT_FOUND}else{if((G.detail.status===500)&&(G.detail.response&&(G.detail.response.toLowerCase().indexOf(j.MCS_NO_CREATE_ACCESS_RESPONSE))!==-1)){H=j.ErrorCodes.UNAUTHORIZED_ACCESS_ERROR}else{if((G.detail.status===500)&&(G.detail.response&&(G.detail.response.toLowerCase().indexOf(j.SSO_LOGIN_REQUEST))!==-1)){H=A.ErrorCodes.COS_SSO_LOGIN_REQUEST_ERROR}else{if(G.detail.status===DS.SMAProcSP.SPRun.ERRORS.PRIVATE_STATION_USER_MISMATCH){H=A.ErrorCodes.COS_PRIVATE_STATION_USER_MISMATCH}else{if(G.detail.status===DS.SMAProcSP.SPRun.ERRORS.PRIVATE_STATION_SERVER_MISMATCH){H=A.ErrorCodes.COS_PRIVATE_STATION_SERVER_MISMATCH}else{if(G.detail.status===DS.SMAProcSP.SPRun.ERRORS.PRIVATE_STATION_NO_STATION_FOUND){H=A.ErrorCodes.COS_PRIVATE_STATION_NOT_FOUND}else{if(G.detail.status===DS.SMAProcSP.SPRun.ERRORS.BUILD_JOB_ERROR){H=A.ErrorCodes.COS_BUILD_JOB_ERROR}}}}}}}if(B.onFailure){B.onFailure({code:H,message:(G.detail.response)?G.detail.response:null})}C();return true};if(z){E()}else{s.loadWebComponent(g.getWebappsBaseUrl()+"SMAProcSP/sp-run/sp-run.html","DS.SMAProcSP.SPRun",function(){if(!z){z=document.createElement("sp-run");document.body.appendChild(z)}E()})}};A.callInitExecDir=function(B){var F={},E=function(G){if(B.onComplete){B.onComplete(G.path)}},C=function(G){if(B.onFailure){B.onFailure(G)}},D=function(){F.mcsJobID=B.execDir.mcsJobID;F.cosJobID=B.execDir.eedJobID;F.activityID="ANY";F.physicalID=F.mcsJobID;if(B.execDir.station){F.station=B.execDir.station}if(B.execDir.server){F.serverID=B.execDir.server}F.onComplete=E;F.onFailure=C;a.initExecDir(F)};n(D)};A.callLs=function(C){var H={},G={},F={},E=function(I){v(C.credentials);if(G.filemonJobID){F.filemonJobID=G.filemonJobID}if(G.filemonURL){F.filemonURL=G.filemonURL}F.data=I;if(C.onComplete){C.onComplete(F)}},D=function(I){v(C.credentials);if(G.filemonJobID){F.filemonJobID=G.filemonJobID}if(G.filemonURL){F.filemonURL=G.filemonURL}if(C.credentials&&(I.error===DS.SMAProcSP.SPCOSFileMonitor.ERRORS.filemonURLNotFound)){F.error=A.ErrorCodes.COS_RUNAS_CREDENTIALS_ERROR}else{F.error=I}if(C.onFailure){C.onFailure(F)}},B=function(){G={mcsJobID:C.execDir.mcsJobID,cosJobID:C.execDir.eedJobID,path:C.execDir.path};if(C.execDir.station){G.station=C.execDir.station}if(C.execDir.server){G.serverID=C.execDir.server}if(C.credentials){G.credentials=C.credentials;if(G.credentials.encryptedCredentials){G.credentials.reuseEncryptedCredentials=true}}if(C.execDir.filemonJobID){G.filemonJobID=C.execDir.filemonJobID}if(C.execDir.filemonURL){G.filemonURL=C.execDir.filemonURL}H.execDir=G;H.physicalID=C.execDir.mcsJobID;if(C.subdirPath){H.subdirPath=C.subdirPath}H.onComplete=E;H.onFailure=D;H.credentialsFunction=function(I){I.execDir.credentials=C.credentials;I.onComplete(true)};a.ls(H)};n(B)};A.callTail=function(C){var G={},F={},E=function(H){v(C.credentials);if(C.onComplete){C.onComplete(H)}},D=function(H){v(C.credentials);if(C.onFailure){C.onFailure({error:(C.credentials&&(H.error===DS.SMAProcSP.SPCOSFileMonitor.ERRORS.filemonURLNotFound))?A.ErrorCodes.COS_RUNAS_CREDENTIALS_ERROR:H})}},B=function(){F={mcsJobID:C.execDir.mcsJobID,cosJobID:C.execDir.eedJobID,path:C.execDir.path};if(C.execDir.station){F.station=C.execDir.station}if(C.execDir.server){F.serverID=C.execDir.server}if(C.credentials){F.credentials=C.credentials;if(F.credentials.encryptedCredentials){F.credentials.reuseEncryptedCredentials=true}}if(C.execDir.filemonJobID){F.filemonJobID=C.execDir.filemonJobID}if(C.execDir.filemonURL){F.filemonURL=C.execDir.filemonURL}G.execDir=F;G.physicalID=C.execDir.mcsJobID;G.filePath=C.filePath;if(C.start){G.start=C.start}if(typeof(C.numLines)!=="undefined"&&C.numLines!==null){G.numLines=C.numLines}G.onComplete=E;G.onFailure=D;G.credentialsFunction=function(H){H.execDir.credentials=C.credentials;H.onComplete(true)};a.tail(G)};n(B)};A.callStopFileMonitor=function(B){var F={},E={},D=function(){if(B.onComplete){B.onComplete()}},C=function(H){if(B.onFailure){B.onFailure({error:H})}},G=function(){E={mcsJobID:B.execDir.mcsJobID,cosJobID:B.execDir.eedJobID,path:B.execDir.path};if(B.execDir.station){E.station=B.execDir.station}if(B.execDir.server){E.serverID=B.execDir.server}if(B.execDir.filemonJobID){E.filemonJobID=B.execDir.filemonJobID}if(B.execDir.filemonURL){E.filemonURL=B.execDir.filemonURL}F.execDir=E;F.physicalID=B.execDir.mcsJobID;F.onComplete=D;F.onFailure=C;a.stopFileMonitor(F)};n(G)};return A});