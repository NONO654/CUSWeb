/*!  Copyright 2017 Dassault Systemes. All rights reserved. */
define(["DS/SMAPoweredByState/ad-state-store","DS/SMAPoweredByState/ad-state-domain/action-impls","DS/SMAPoweredByState/ad-state-domain-connector-definitions/actions","DS/SMAPoweredByState/ad-state-app/selectors","DS/SMAPoweredByState/ad-state-cos/selectors","DS/SMAPoweredByState/ad-state-domain-jobs/selectors","DS/SMAPoweredByState/ad-state-domain-jobs/actions","DS/SMAPoweredByState/ad-state-domain-job-types/selectors","DS/SMAPoweredByState/ad-state-domain-job-types/actions","DS/SMAPoweredByState/ad-state-domain-managed-data/actions","DS/SMAPoweredByState/ad-state-domain-study/actions","DS/SMAPoweredByState/ad-state-domain-work-data/actions"],function(h,n,c,d,i,g,l,m,b,k,j,a){var f={};function e(p,o,r){var q=o.getState();if(d.isCloudEnabled(q)&&g.jobGenerateResults(q,r)){return p(l.setJob3DXParameters(r,d.currentPlatformID(q),d.myAppsURL(q)))}else{return Promise.resolve()}}f.openStudy=function(o){return function(p){return p(j.refreshStudy(o)).then(function(){return p(k.refreshManagedData())}).then(function(){return p(l.refreshJobs(o))}).then(function(){return p(b.refreshJobTypes())}).then(function(){return p(c.refreshConnectorDefinitions())})}};f.reloadStudy=function(o){return function(p){return p(j.refreshStudy(o)).then(function(){return p(k.refreshManagedData())}).then(function(){return p(l.refreshJobs(o))})}};f.createJob=function(s,p,r,q){var o=m.jobTypeWithID(h.getStore().getState(),p);return function(t){if(!o.options||(o.options.length===0)){return t(b.refreshJobTypeOptions(p)).then(function(){return t(l.createJob(s,p,r,q))})}else{return t(l.createJob(s,p,r,q))}}};f.cloneJob=function(s,t,r,p){var q=g.jobWithID(h.getStore().getState(),t),o=m.jobTypeWithID(h.getStore().getState(),q.jobType);return function(u){if(!o.options||(o.options.length===0)){return u(b.refreshJobTypeOptions(o.id)).then(function(){return u(l.cloneJob(s,t,r,p))})}else{return u(l.cloneJob(s,t,r,p))}}};f.refreshJob=function(s,t,p){var o=h.getStore(),r=g.jobWorkDirectory(o.getState(),t),q=p?p:false;return function(u){return u(l.refreshJobData(t,q)).then(function(){if(g.isJobDone(o.getState(),t)&&r&&r.removeAfterExecution){return Promise.resolve().then(function(){u(a.removeExecDir(r.id))}).then(function(){u(l.setJobExecutionWorkDirectory(t,null))}).then(function(){return u(j.updateStudy(s))})}else{return null}})}};f.runJob=function(u,v,q,s,r){var p=h.getStore(),o={eedJobID:null,mcsJobID:null,credentials:null,needNewExecDir:false,removeExecDir:null},t;return function(w){return e(w,p,v).then(function(){return w(l.startJob(u,v,q,s,r))}).then(function(x){o.eedJobID=x.value.eedJobID;o.mcsJobID=x.value.mcsJobID;o.credentials=x.value.credentials;o.needNewExecDir=x.value.needNewExecDir;o.removeExecDir=x.value.removeExecDir;if(o.needNewExecDir){return w(a.createExecDir(o.mcsJobID,o.credentials))}else{if(o.removeExecDir){return w(a.markForRemoval(o.removeExecDir))}else{return null}}}).then(function(x){if(o.needNewExecDir){t=x.execDir.id}}).then(function(){return w(l.storeJobConfiguration(o.mcsJobID))}).then(function(){if(o.needNewExecDir){return w(j.updateStudy(u))}else{return null}}).then(function(){if(o.needNewExecDir){return w(a.initializeExecDir(t))}else{if(r){return w(a.setExecDirCredentials(t,r))}else{return null}}}).then(function(){if(o.needNewExecDir||o.removeExecDir||r){return w(j.updateStudy(u))}else{return null}})}};f.uploadWorkData=function(r,o,p,q){return function(s){return s(k.uploadWorkData(o,p,q)).then(function(){return s(l.refreshJobs(r))})}};f.processUploadJob=function(p){var o=[];if(!g.isUploadJobProcessed(h.getStore().getState(),p)){return function(q){return q(l.refreshJobData(p)).then(function(r){return{jobID:r.value.configuration.attachToJobID,managedData:n.getAvailableUploadedManagedData({projections:r.value.configuration.managedDataProjections})}}).then(function(r){r.managedData.forEach(function(s){o.push(Promise.resolve().then(function(){return q(l.addJobOutput(r.jobID,s))}))});return Promise.all(o)}).then(function(){return q(l.markUploadJobProcessed(p))})}}else{return null}};return f});