/*!  Copyright 2017 Dassault Systemes. All rights reserved. */
define(["DS/SMAPoweredByState/ad-state-store","DS/SMAPoweredByState/ad-state-utils","DS/SMAPoweredByState/ad-state-domain-jobs/action-types","DS/SMAPoweredByState/ad-state-domain-jobs/action-impls","DS/SMAPoweredByState/ad-state-domain-jobs/selectors","DS/SMAPoweredByState/ad-state-domain-job-types/selectors","DS/SMAPoweredByState/ad-state-app/selectors","DS/SMAPoweredByState/ad-state-cos/selectors","UWA/Class/Promise"],function(e,f,b,k,d,j,a,i,g){var c={};var h=window.Promise||g;c.refreshJobs=function(m,l){var n=[];n.push(k.getExecutedJobs({studyID:m}));if(l){n.push(k.getConfiguringJobs({studyID:m}))}return{type:b.REFRESH_JOBS,payload:{promise:h.all(n).then(function(o){return{jobSets:o}}).then(k.combineJobs)}}};c.refreshJobData=function(n,l){var m=d.jobWithID(e.getStore().getState(),n);return{type:b.REFRESH_JOB_DATA,payload:{promise:(m.kind===d.JobKind.UPLOAD)?k.refreshUploadJob({job:m,refreshConfiguration:l}):k.refreshExecutedJob({job:m,refreshConfiguration:l}),data:{jobID:n}}}};c.storeJobConfiguration=function(m){var l=d.jobWithID(e.getStore().getState(),m);return{type:b.STORE_JOB_CONFIGURATION,payload:{promise:k.storeJobConfiguration({job:l}),data:{jobID:m}}}};c.createJob=function(q,p,r,t){var s=e.getStore(),m=f.generateID(),l,u,o,n;l=j.jobTypeWithID(s.getState(),p);u=r?r:l.title;o=t?t:null;n={type:b.CREATE_JOB,payload:{promise:k.createJobActivity({studyID:q,jobTypeID:p,jobTitle:u,jobDescription:o,pendingJobID:m}).then(function(v){return{studyID:q,jobID:v.id,jobTypeID:p}}).then(k.refreshConfiguringJob).then(function(v){v.job.executionOptions.drmMode=a.isCloudEnabled(s.getState())?i.DRMMode.CLOUD:i.DRMMode.FIPER;return{pendingJobID:m,job:v.job}}),data:{pendingJobID:m,jobTypeID:p,title:u}}};return n};c.cloneJob=function(p,o,q,r){var l=f.generateID(),t,s,n,m;t=d.jobWithID(e.getStore().getState(),o);s=q?q:t.title;n=r?r:(t.description?t.description:null);m={type:b.CLONE_JOB,payload:{promise:k.createJobActivity({studyID:p,jobTypeID:t.jobType,jobTitle:s,jobDescription:n,pendingJobID:l}).then(function(u){return{studyID:p,jobID:u.id,jobTypeID:t.jobType}}).then(k.refreshConfiguringJob).then(function(u){return{studyID:p,originalJob:t,cloneJob:u.job}}).then(k.updateJobClone).then(function(u){return{pendingJobID:l,job:u.cloneJob}}),data:{pendingJobID:l,jobTypeID:t.jobType,originalJob:t,title:s}}};return m};c.startJob=function(o,p,l,n,m){return function(q){return q({type:b.START_JOB,payload:{promise:k.startJob({jobID:p,serverID:l,workDirID:n,credentials:(typeof m!=="undefined")?m:null}).then(function(r){return{jobID:p,eedJobID:r.eedJobID,mcsJobID:r.mcsJobID,serverID:l,credentials:(typeof r.credentials!=="undefined")?r.credentials:null,needNewExecDir:r.needNewExecDir,removeExecDir:r.removeExecDir}}),data:{jobID:p}}})}};c.updateJob=function(m,n){var l=d.jobWithID(e.getStore().getState(),n);return{type:b.UPDATE_JOB,payload:{promise:(d.JobStatus.CONFIGURING===l.status)?k.updateJobActivity({studyID:m,jobID:n}):k.updateJob({jobID:n}),data:{jobID:n}}}};c.abortJob=function(l){return{type:b.ABORT_JOB,payload:{promise:k.abortJob({jobID:l}),data:{jobID:l}}}};c.deleteJobs=function(m,l){return{type:b.DELETE_JOBS,payload:{promise:k.deleteJobs({studyID:m,jobIDs:l}),data:l}}};c.setJobTitle=function(n,m){var l=d.jobWithID(e.getStore().getState(),n);if(d.JobStatus.CONFIGURING===l.status){return{type:b.SET_JOB_TITLE,jobID:n,title:m}}else{return{type:b.SET_JOB_TITLE,payload:{promise:k.setJobDetails({jobID:n,title:m,description:l.description}),data:{jobID:n,title:m}}}}};c.setJobDescription=function(n,l){var m=d.jobWithID(e.getStore().getState(),n);if(d.JobStatus.CONFIGURING===m.status){return{type:b.SET_JOB_DESCRIPTION,jobID:n,description:l}}else{return{type:b.SET_JOB_DESCRIPTION,payload:{promise:k.setJobDetails({jobID:n,title:m.title,description:l}),data:{jobID:n,description:l}}}}};c.setJobWorkDirectory=function(m,l){return{type:b.SET_JOB_WORK_DIRECTORY,jobID:m,execDirID:l}};c.setJobReady=function(m,l){return{type:b.SET_JOB_READY,jobID:m,ready:l}};c.setJobStatus=function(m,l){return{type:b.SET_JOB_STATUS,jobID:m,status:l}};c.setJob3DXParameters=function(n,m,l){return{type:b.SET_JOB_3DX_PARAMETERS,payload:{promise:k.setJob3DXParameters({jobID:n,tenantID:m,myAppsURL:l}),data:{jobID:n,tenantID:m,myAppsURL:l}}}};c.markUploadJobProcessed=function(n){var l=d.jobWithID(e.getStore().getState(),n),m=l.title+d.UPLOAD_JOB_PROCESSED_MARKER;return{type:b.SET_JOB_TITLE,payload:{promise:k.setJobDetails({jobID:n,title:m,description:l.description}),data:{jobID:n,title:m}}}};return c});