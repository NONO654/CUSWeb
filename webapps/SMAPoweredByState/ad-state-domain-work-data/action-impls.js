/*!  Copyright 2017 Dassault Systemes. All rights reserved. */
define(["DS/SMAPoweredByState/ad-state-store","DS/SMAPoweredByState/ad-state-utils","DS/SMAPoweredByState/ad-state-defs","DS/SMAPoweredByState/ad-state-wc-adapter","DS/SMAPoweredByState/ad-state-domain-jobs/selectors","DS/SMAPoweredByState/ad-state-domain-work-data/selectors","DS/SMAPoweredByState/ad-state-app-alerts/selectors","UWA/Class/Promise"],function(e,f,i,a,d,c,l,g){var b={};var h=window.Promise||g;function k(q,o,m){var s,r,n,p=function(w,x,u){if((typeof w.isDirectory!=="undefined")&&w.isDirectory){for(var v=0;v<w.fileList.length;v++){s=(u&&u.id)?(u.id+"/"):"";s+=w.fileList[v].name;r={persistenceStatus:i.PersistenceStatus.CLEAN,id:s,type:c.Types.FILE,name:w.fileList[v].name,size:w.fileList[v].fileSize,modified:f.getTimestamp(w.fileList[v].modified)};n={id:s,parent:u.id,children:[]};x.push(r);u.children.push(n)}for(var t=0;t<w.directoryList.length;t++){s=(u&&u.id)?(u.id+"/"):"";s+=w.directoryList[t].name;r={persistenceStatus:i.PersistenceStatus.CLEAN,id:s,type:c.Types.FOLDER,name:w.directoryList[t].name,modified:f.getTimestamp(w.directoryList[t].lastModified)};n={id:s,parent:u.id,children:[]};x.push(r);u.children.push(n);p(w.directoryList[t],x,n)}}};p(q,o,m)}function j(m){var n={};n.msg=c.ErrorCodes.REFRESH_WORK_DATA_ERROR;switch(m.error){case 2:n.msg=c.ErrorCodes.COS_JOB_NOT_DISPATCHED;break;case 3:n.msg=c.ErrorCodes.EXE_DIR_PATH_NOT_FOUND;break;case 4:n.msg=c.ErrorCodes.FILE_MON_JOB_USR_MISMATCH;break;case 5:n.msg=c.ErrorCodes.FILE_MON_JOB_NOT_STARTED;break;case 6:n.msg=c.ErrorCodes.TRANSIENT_MON_FINISHED;n.level=l.Level.INFO;break;case 7:n.msg=c.ErrorCodes.FILE_MON_URL_NOT_FOUND;break;case 8:n.msg=c.ErrorCodes.CREDENTILAS_NOT_SUPPIED;break;case 9:n.msg=c.ErrorCodes.EXE_DIR_CONTENT_NOT_FOUND;break;case 10:n.msg=c.ErrorCodes.REFRESH_WORK_DATA_ERROR;break;default:n.msg=c.ErrorCodes.REFRESH_WORK_DATA_ERROR}return n}b.initializeExecDir=function(m){return new h(function(r,q){var o,n,s=function(t){r({execDirID:m.execDirID,path:t})},p=function(){if(d.isJobClaimed(e.getStore().getState(),o.mcsJobID)){q(f.buildError(c.ErrorCodes.INITIALIZE_EXEC_DIR_ERROR,null,m.execDirID))}else{r()}};o=c.workDataWithID(e.getStore().getState(),m.execDirID);n={execDir:o,onComplete:s,onFailure:p};if(o.server&&(o.server.length>0)){n.serverID=o.server}if(o.station&&(o.station.length>0)){n.station=o.station}a.callInitExecDir(n)})};b.refreshWorkData=function(m){return new h(function(r,q){var o,t,n,s=function(x){var w=[],v={},u;v={id:m.workDataID,children:[]};k(x.data,w,v);u={workDataID:m.workDataID,modified:f.getTimestamp(x.data.lastModified),descendants:w,descendantHierarchy:v,execDirID:o.id,credentials:m.credentials};if(x.filemonJobID){u.filemonJobID=x.filemonJobID}if(x.filemonURL){u.filemonURL=x.filemonURL}r(u)},p=function(w){var u={workDataID:m.workDataID,execDirID:o.id,credentials:m.credentials},v=j(w.error);if(w.filemonJobID){u.filemonJobID=w.filemonJobID}if(w.filemonURL){u.filemonURL=w.filemonURL}q(f.buildError(v.msg,null,u,v.level))};if(c.workDataType(e.getStore().getState(),m.workDataID)===c.Types.FILE){r({workDataID:m.workDataID,objects:[]})}else{o=c.workDataExecDir(e.getStore().getState(),m.workDataID);t=c.workDataRelPath(e.getStore().getState(),m.workDataID);n={execDir:o,credentials:m.credentials,subdirPath:t,onComplete:s,onFailure:p};a.callLs(n)}})};return b});