/*!  Copyright 2017 Dassault Systemes. All rights reserved. */
define(["DS/SMAPoweredByState/ad-state-store","DS/SMAPoweredByState/ad-state-utils","DS/SMAPoweredByState/ad-state-defs","DS/SMAPoweredByState/ad-state-wc-adapter","DS/SMAPoweredByState/ad-state-domain-study/selectors","DS/SMAPoweredByState/ad-state-domain-study-templates/selectors","DS/SMAPoweredByState/ad-state-domain-work-data/selectors","UWA/Class/Promise"],function(o,e,k,w,m,r,q,h){var v={};var t="__AdHoc_RemoveAfterJob",s="__AdHoc_Disabled",n="__AdHoc_EEDJobID=",a="__AdHoc_MCSJobID=",f="__AdHoc_ServerID=",b="|";var g=window.Promise||h;function u(B){var A={name:"",accessDisabled:false,removeAfterExecution:false,eedJobID:null,mcsJobID:null,server:null},z=B.name.split(b),x=false,y;for(y=0;y<z.length;y++){if(z[y]===s){x=true;A.accessDisabled=true}else{if(z[y]===t){x=true;A.removeAfterExecution=true}else{if(z[y].indexOf(n)===0){x=true;A.eedJobID=z[y].substring(n.length)}else{if(z[y].indexOf(a)===0){x=true;A.mcsJobID=z[y].substring(a.length)}else{if(z[y].indexOf(f)===0){x=true;A.server=z[y].substring(f.length)}else{if(!x){if(y>0){A.name+=b}A.name+=z[y]}}}}}}}return A}function d(x){var y=x.name;if(x.accessDisabled){y+=b;y+=s}if(x.removeAfterExecution){y+=b;y+=t}if(x.eedJobID&&x.eedJobID.length>0){y+=b;y+=n;y+=x.eedJobID}if(x.mcsJobID&&x.mcsJobID.length>0){y+=b;y+=a;y+=x.mcsJobID}if(x.server&&x.server.length>0){y+=b;y+=f;y+=x.server}return y}function j(z){var x=null,y;if(z.user&&(z.user.length>0)){y=z.user.split("\\");if(y.length===2){x={encryptedCredentials:null,domainName:y[0],windowsUser:y[1],windowsPass:null,linuxUser:null,linuxPass:null}}else{if(y.length===1){x={encryptedCredentials:null,domainName:null,windowsUser:null,windowsPass:null,linuxUser:y[0],linuxPass:null}}}}return x}function c(y){var x="";if(y.credentials){if(y.credentials.domainName&&y.credentials.domainName.length>0&&y.credentials.windowsUser&&y.credentials.windowsUser.length>0){x=y.credentials.domainName+"\\"+y.credentials.windowsUser}else{if(y.credentials.linuxUser&&y.credentials.linuxUser.length>0){x=y.credentials.linuxUser}}}return x}function p(z){var A=[],x,y,B;x=z.attributes.definition.process.ExecutionConfig.properties.SCExecutionDirectories;if(x&&Array.isArray(x)){x.forEach(function(C){B=u(C);y={persistenceStatus:k.PersistenceStatus.CLEAN,id:"execdir"+B.mcsJobID,name:B.name,type:"execdir",server:B.server,station:(C.station?C.station:""),path:(C.path?C.path:""),credentials:j(C),modified:e.getTimestamp(C.lastModified),eedJobID:B.eedJobID,mcsJobID:B.mcsJobID,accessDisabled:B.accessDisabled,removeAfterExecution:B.removeAfterExecution};A.push(y)})}return A}function l(y){var x={};if(y.basics.fromconnectMask){x.fromconnectMask=y.basics.fromconnectMask}if(y.basics.fromdisconnectMask){x.fromdisconnectMask=y.basics.fromdisconnectMask}if(y.basics.locked){x.locked=y.basics.locked}if(y.basics.lockedByCurrentUser){x.lockedByCurrentUser=y.basics.lockedByCurrentUser}if(y.basics.modifyMask){x.modifyMask=y.basics.modifyMask}return x}function i(x,z){var A=[],B,y;if(x){A=x.filter(function(C){return(C.type==="execdir")})}z.attributes.definition.process.ExecutionConfig.properties.SCExecutionDirectories=[];A.forEach(function(C){y=new Date(C.modified);B={lastModified:y.toUTCString(),name:d(C),path:(C.path?C.path:""),station:(C.station?C.station:""),user:c(C)};if(C.station){B.station=C.station}z.attributes.definition.process.ExecutionConfig.properties.SCExecutionDirectories.push(B)})}v.createStudyFromPLMProcess=function(x){var y={persistenceStatus:k.PersistenceStatus.CLEAN,id:x.id,title:x.attributes.title,description:x.attributes.description,created:e.getTimestamp(x.basics.originated),modified:e.getTimestamp(x.basics.modified),owner:x.basics.owner,managedDataRootID:x.connections.SimulationCategory["Internal Data"],masks:l(x)};y._plmProcess=x;return y};v.createExecDirsFromPLMProcess=function(x){return p(x)};v.createPLMProcessFromStudy=function(z,x){var y=z._plmProcess;y.attributes.title=z.title;y.attributes.description=z.description;i(x,y);return y};v.createStudy=function(x){return new g(function(D,C){var E=function(G){var H=null,F=JSON.parse(G.response);if(F&&(F.length>0)){H={persistenceStatus:k.PersistenceStatus.CLEAN,id:F[0]["Instantiated Process"],title:x.title,description:x.description,created:null,modified:null,owner:null,managedDataRootID:null}}D(H)},z=function(F){C(e.buildError(m.ErrorCodes.STUDY_CREATE_WS_ERROR,F))},B,A=[],y;B=r.studyTemplateWithID(o.getStore().getState(),x.studyTemplateID);if(B){A=B.options.slice();for(y=0;y<A.length;y++){if(A[y].title==="Title"){A[y].value=x.title?x.title:B.title;A[y].modified="true"}else{if(x.description&&A[y].title==="Description"){A[y].value=x.description;A[y].modified="true"}}}}w.callSMAProcService({uri:"/templates/"+x.studyTemplateID+"/instantiate",verb:"POST",data:JSON.stringify(A),onComplete:E,onError:z,sessionTimeoutInfo:{handler:C,context:null}})})};v.updateStudy=function(x){return new g(function(B,A){var z=m.studyObject(o.getStore().getState()),C=function(){B(z)},y=function(D){if(D&&(D.status===403)){A(e.buildError(m.ErrorCodes.STUDY_UPDATE_ACCESS_ERROR,D,z.id))}else{A(e.buildError(m.ErrorCodes.STUDY_UPDATE_WS_ERROR,D,z.id))}};w.callSMAProcService({uri:"/simulations/"+x.studyID,verb:"PUT",data:v.createPLMProcessFromStudy(z,q.allWorkData(o.getStore().getState())),onComplete:C,onError:y,sessionTimeoutInfo:{handler:A,context:z.id}})})};v.refreshStudy=function(x){return new g(function(A,z){var B=function(D){var E={},C=JSON.parse(D.response);if(C){E.study=v.createStudyFromPLMProcess(C);E.execDirs=v.createExecDirsFromPLMProcess(C)}A(E)},y=function(C){z(e.buildError(m.ErrorCodes.STUDY_WS_ERROR,C))};w.callSMAProcService({uri:"/simulations/"+x.studyID,onComplete:B,onError:y,sessionTimeoutInfo:{handler:z,context:null}})})};v.deleteStudy=function(x){return new g(function(A,z){var B=function(){A()},y=function(C){z(e.buildError(m.ErrorCodes.STUDY_WS_ERROR,C))};w.callSMAProcService({uri:"/simulations/"+x.studyID,verb:"DELETE",onComplete:B,onError:y,sessionTimeoutInfo:{handler:z,context:x.studyID}})})};return v});