/*!  Copyright 2017 Dassault Systemes. All rights reserved. */
define(["DS/SMAPoweredByState/ad-state-store","DS/SMAPoweredByState/ad-state-utils","DS/SMAPoweredByState/ad-state-defs","DS/SMAPoweredByState/ad-state-domain-managed-data/action-types","DS/SMAPoweredByState/ad-state-domain-managed-data/action-impls","DS/SMAPoweredByState/ad-state-domain-managed-data/selectors"],function(f,d,e,g,c,h){var b={};function a(m){var q=f.getStore(),p={specificObjectIDs:[],descendantIDs:[]},j,l,n,o,i,k,r={},s={};m.forEach(function(t){j=h.managedDataWithID(q.getState(),t);if(j){if((j.type===h.Types.FILE)||(j.type===h.Types.FILEVERSION)){l=(j.type===h.Types.FILEVERSION)?j:null;n=(j.type===h.Types.FILE)?j:h.managedDataParent(q.getState(),l.id,false);o=h.managedDataParent(q.getState(),n.id,false);if(l&&(h.managedDataChildren(q.getState(),n.id,false).length>1)){r[l.id]=true}else{if(h.managedDataChildren(q.getState(),o.id,false).length>1){r[n.id]=true;if(l){s[l.id]=true}else{k=h.managedDataChildren(q.getState(),n.id);k.forEach(function(u){s[u.id]=true})}}else{r[o.id]=true;s[n.id]=true;if(l){s[l.id]=true}else{k=h.managedDataChildren(q.getState(),n.id);k.forEach(function(u){s[u.id]=true})}}}}else{if((j.type===h.Types.DOCUMENT)||(j.type===h.Types.NVDOCUMENT)){r[j.id]=true;i=h.managedDataChildren(q.getState(),j.id);i.forEach(function(u){s[u.id]=true;k=h.managedDataChildren(q.getState(),u.id);k.forEach(function(v){s[v.id]=true})})}else{r[j.id]=true}}}});Object.keys(r).forEach(function(t){p.specificObjectIDs.push(t)});Object.keys(s).forEach(function(t){p.descendantIDs.push(t)});return p}b.refreshManagedData=function(){return{type:g.REFRESH_MANAGED_DATA,payload:{promise:c.refreshManagedData()}}};b.refreshManagedDataDocument=function(j){var i=h.managedDataParent(f.getStore().getState(),j);return{type:g.REFRESH_MANAGED_DATA_DOCUMENT,payload:{promise:c.refreshManagedDataDocument({documentID:j,containerID:i?i.id:null})}}};b.uploadLocalFile=function(u,k,m){var r=f.getStore(),j=h.managedDataWithID(f.getStore().getState(),u),t=u,n,p,l=null,q={persistenceStatus:e.PersistenceStatus.CLEAN,persistenceOperation:e.PersistenceOperation.CREATING,id:d.generateID(),type:(h.Types.FILE===j.type)?h.Types.FILEVERSION:h.Types.FILE,name:k.name,size:k.size},o,s;if(h.Types.FILE===j.type){l=j;p=h.managedDataParent(r.getState(),j.id,false)}else{p=j}if((h.Types.DOCUMENT===p.type)||(h.Types.NVDOCUMENT===p.type)){n=h.managedDataChildren(r.getState(),p.id);for(o=0;o<n.length;o++){if(n[o].name===q.name){q.type=h.Types.FILEVERSION;s=parseInt(n[o].latestVersion);q.version=isNaN(s)?"":(String(++s));t=n[o].id;break}}}return{type:g.UPLOAD_LOCAL_FILE,payload:{promise:c.uploadLocalFile({containerObject:p,containerFile:l,file:k,placeholder:q,progressHandler:b.setFileUploadProgress,progressIncrement:m?m:null}).then(function(i){return{documentID:i.documentID,containerID:(h.Types.FILE===j.type)?h.managedDataParent(r.getState(),i.documentID,false).id:u}}).then(c.refreshManagedDataDocument).then(function(i){return{placeholder:q,objects:i.objects,hierarchy:i.hierarchy,containerID:i.containerID}}),data:{containerID:t,placeholder:q}}}};b.uploadWorkData=function(i,j,k){return{type:g.UPLOAD_WORK_DATA,payload:{promise:c.startUploadWorkDataJob({containerID:i,workDataIDs:j}).then(function(l){if((typeof k!=="undefined")&&k){c.storeUploadJobInfo({attachToJobID:k,uploadJobID:l.jobID,workDataIDs:j,containerID:i})}})}}};b.addReferencedContent=function(i,m,k,j){if(!h.managedDataWithID(f.getStore().getState(),m)){var l={persistenceStatus:e.PersistenceStatus.CLEAN,persistenceOperation:e.PersistenceOperation.CREATING,id:m,type:((typeof j!=="undefined")&&j)?j:h.Types.UNKNOWN,title:((typeof k!=="undefined")&&k)?k:"Referenced content"};return{type:g.ADD_REFERENCED_CONTENT,payload:{promise:c.addReferencedContent({containerID:i,objectID:m,placeholder:l}).then(c.refreshManagedData).then(function(n){return{placeholder:l,objects:n.objects,hierarchy:n.hierarchy}}),data:{containerID:i,placeholder:l}}}}else{return{type:g.ADD_REFERENCED_CONTENT+e.AsyncStatus.FAILURE,payload:{error:{code:h.ErrorCodes.ADD_REF_CONTENT_EXISTS_ERROR}}}}};b.deleteManagedData=function(j){var i=a(j);return{type:g.DELETE_MANAGED_DATA,payload:{promise:c.deleteManagedData({objectIDs:i.specificObjectIDs,doDelete:true}),data:{objectIDs:i.specificObjectIDs.concat(i.descendantIDs),doDelete:true}}}};b.removeManagedData=function(j){var i=a(j);return{type:g.REMOVE_MANAGED_DATA,payload:{promise:c.deleteManagedData({objectIDs:i.specificObjectIDs,doDelete:false}),data:{objectIDs:i.specificObjectIDs.concat(i.descendantIDs),doDelete:false}}}};b.setFileVersionComments=function(i,j){return{type:g.SET_FILE_VERSION_COMMENTS,payload:{promise:c.setFileVersionComments({fileVersionID:i,comments:j}),data:{fileVersionID:i,comments:j}}}};b.setFileUploadProgress=function(i,j){return{type:g.SET_FILE_UPLOAD_PROGRESS,fileID:i,uploadProgress:j}};b.clearManagedDataPersistenceError=function(){return{type:g.CLEAR_MANAGED_DATA_PERSISTENCE_ERROR}};return b});