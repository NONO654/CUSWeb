/*!  Copyright 2017 Dassault Systemes. All rights reserved. */
define(["DS/SMAPoweredByState/ad-state-domain-managed-data/action-types","DS/SMAPoweredByState/ad-state-domain-managed-data/selectors","DS/SMAPoweredByState/ad-state-domain-study/action-types","DS/SMAPoweredByState/ad-state-utils","DS/SMAPoweredByState/ad-state-defs"],function(m,i,p,c,f){var r={};const d={uninitialized:true,objects:[],hierarchy:{}};function q(z,v,y,u){var A,w={},x,t;if(u){A={objects:z.objects.slice(),hierarchy:z.hierarchy};for(x=0;x<A.objects.length;x++){w[A.objects[x].id]=x}v.forEach(function(B){if(w[B.id]){A.objects.splice(w[B.id],1,B)}else{A.objects.push(B)}});t=c.findNodeInHierarchy(u,A.hierarchy);if(t){y.parent=t.id;if(!t.children.some(function(C,B){if(C.id===y.id){t.children.splice(B,1,y);return true}else{return false}})){t.children.push(y)}}}else{A={objects:v,hierarchy:y}}return A}function b(v,w,u){var t=c.findNodeInHierarchy(u,v.hierarchy);if(t){v.objects.push(w);t.children.push({id:w.id,parent:u,children:[]})}}function o(t,u){c.clearNodeDescendants(t,u.id,true)}function a(w,x,z){var v={},A,t,D,u=[],B,C,y;x.objects.forEach(function(E){t=E.name?E.name:E.title;if(!v[t]){v[t]=[]}v[t].push(E)});w.objects.forEach(function(E){if((E.persistenceOperation===f.PersistenceOperation.CREATING)&&(!z||(E.id!==z.id))){u.push(E)}});u.forEach(function(E){B=E.name?E.name:E.title;C=c.getNodeParent(w,E.id);if(C&&v[B]){for(y=0;y<v[B].length;y++){D=c.getNodeParent(x,v[B][y].id);if(D&&(D.id===C.id)){A=v[B][y];break}}}if(A){c.clearNodeDescendants(x,A.id,true);b(x,E,C.id)}})}function h(u,t){var v;switch(t.type){case p.CLOSE_STUDY:v=c.deepCopy(d);break;case p.CREATE_STUDY+f.AsyncStatus.SUCCESS:v=c.deepCopy(d);break;default:v=u;break}return v}function s(u,t){var v;switch(t.type){case m.REFRESH_MANAGED_DATA+f.AsyncStatus.PENDING:v={persistenceOperation:f.PersistenceOperation.READING,objects:u.objects,hierarchy:u.hierarchy};break;case m.REFRESH_MANAGED_DATA+f.AsyncStatus.SUCCESS:v=q(u,t.payload.objects,t.payload.hierarchy);a(u,v,null);break;case m.REFRESH_MANAGED_DATA+f.AsyncStatus.FAILURE:v={persistenceError:t.payload.error,objects:u.objects,hierarchy:u.hierarchy};break;case m.REFRESH_MANAGED_DATA_DOCUMENT+f.AsyncStatus.PENDING:v={persistenceOperation:f.PersistenceOperation.READING,objects:u.objects,hierarchy:u.hierarchy};break;case m.REFRESH_MANAGED_DATA_DOCUMENT+f.AsyncStatus.SUCCESS:v=q(u,t.payload.objects,t.payload.hierarchy,t.payload.containerID);a(u,v,t.payload.placeholder);break;case m.REFRESH_MANAGED_DATA_DOCUMENT+f.AsyncStatus.FAILURE:v={persistenceError:t.payload.error,objects:u.objects,hierarchy:u.hierarchy};break;default:v=u;break}return v}function e(u,t){var v;switch(t.type){case m.UPLOAD_LOCAL_FILE+f.AsyncStatus.PENDING:case m.ADD_REFERENCED_CONTENT+f.AsyncStatus.PENDING:v={objects:u.objects.slice(),hierarchy:u.hierarchy};if(t.payload&&t.payload.placeholder){b(v,t.payload.placeholder,t.payload.containerID)}break;case m.UPLOAD_WORK_DATA+f.AsyncStatus.PENDING:v={objects:u.objects,hierarchy:u.hierarchy};break;case m.UPLOAD_LOCAL_FILE+f.AsyncStatus.SUCCESS:v=q(u,t.payload.objects,t.payload.hierarchy,t.payload.containerID);o(v,t.payload.placeholder);break;case m.ADD_REFERENCED_CONTENT+f.AsyncStatus.SUCCESS:v=q(u,t.payload.objects,t.payload.hierarchy);a(u,v,t.payload.placeholder);break;case m.UPLOAD_WORK_DATA+f.AsyncStatus.SUCCESS:v={objects:u.objects,hierarchy:u.hierarchy};break;case m.UPLOAD_LOCAL_FILE+f.AsyncStatus.FAILURE:case m.ADD_REFERENCED_CONTENT+f.AsyncStatus.FAILURE:v={persistenceError:t.payload.error,objects:u.objects.slice(),hierarchy:u.hierarchy};if(t.payload&&t.payload.context){o(v,t.payload.context)}break;case m.UPLOAD_WORK_DATA+f.AsyncStatus.FAILURE:v={persistenceError:t.payload.error,objects:u.objects,hierarchy:u.hierarchy};break;default:v=u;break}return v}function g(w,v){var x,t,u;switch(v.type){case m.DELETE_MANAGED_DATA+f.AsyncStatus.PENDING:case m.REMOVE_MANAGED_DATA+f.AsyncStatus.PENDING:x={objects:w.objects.slice(),hierarchy:w.hierarchy};x.objects.forEach(function(y){if(v.payload.objectIDs.indexOf(y.id)>=0){t=c.shallowCopy(y);if(t){t.persistenceOperation=v.payload.doDelete?f.PersistenceOperation.DELETING:f.PersistenceOperation.REMOVING;if(t.persistenceError){delete t.persistenceError}c.replaceObject(x.objects,t)}}});break;case m.DELETE_MANAGED_DATA+f.AsyncStatus.FAILURE:case m.REMOVE_MANAGED_DATA+f.AsyncStatus.FAILURE:case m.DELETE_MANAGED_DATA+f.AsyncStatus.SUCCESS:case m.REMOVE_MANAGED_DATA+f.AsyncStatus.SUCCESS:x={objects:w.objects.slice(),hierarchy:w.hierarchy};if(v.payload.successes){v.payload.successes.forEach(function(y){t=c.getNodeParent(x,y.id);if(t&&(t.type===i.Types.FILE)){u=parseInt(t.latestVersion);if(!isNaN(u)){t.latestVersion=String(u-1)}}c.clearNodeDescendants(x,y.id,true)})}if(v.payload.failures&&(v.payload.failures.length>0)){x.persistenceError=v.payload.failures[0].error.error}x.objects.forEach(function(y){if(y.persistenceOperation){t=c.shallowCopy(y);delete t.persistenceOperation;c.replaceObject(x.objects,t)}});break;default:x=w;break}return x}function l(v,u){var w,t;switch(u.type){case m.SET_FILE_VERSION_COMMENTS+f.AsyncStatus.PENDING:w={objects:v.objects.slice(),hierarchy:v.hierarchy};t=c.shallowCopy(c.getObject(w.objects,u.payload.fileVersionID));if(t){t.comments=u.payload.comments;t.persistenceOperation=f.PersistenceOperation.UPDATING;if(t.persistenceError){delete t.persistenceError}c.replaceObject(w.objects,t)}break;case m.SET_FILE_VERSION_COMMENTS+f.AsyncStatus.SUCCESS:w={objects:v.objects.slice(),hierarchy:v.hierarchy};t=c.shallowCopy(c.getObject(w.objects,u.payload.fileVersionID));if(t){if(t.persistenceOperation){delete t.persistenceOperation}t.comments=u.payload.comments;c.replaceObject(w.objects,t)}break;case m.SET_FILE_VERSION_COMMENTS+f.AsyncStatus.FAILURE:w={persistenceError:u.payload.error,objects:v.objects.slice(),hierarchy:v.hierarchy};t=c.shallowCopy(c.getObject(w.objects,u.payload.context));if(t){if(t.persistenceOperation){delete t.persistenceOperation}c.replaceObject(w.objects,t)}break;default:w=v;break}return w}function k(v,u){var w,t;switch(u.type){case m.SET_FILE_UPLOAD_PROGRESS:w={objects:v.objects.slice(),hierarchy:v.hierarchy};t=c.shallowCopy(c.getObject(w.objects,u.fileID));if(t){t.uploadProgress=u.uploadProgress;c.replaceObject(w.objects,t)}break;default:w=v;break}return w}function n(u,t){var v;switch(t.type){case m.CLEAR_MANAGED_DATA_PERSISTENCE_ERROR:v={objects:u.objects,hierarchy:u.hierarchy};break;default:v=u;break}return v}function j(u,t){var v;if(typeof u==="undefined"){v=c.deepCopy(d)}else{v=u;v=h(v,t);v=s(v,t);v=e(v,t);v=g(v,t);v=l(v,t);v=k(v,t);v=n(v,t)}return v}r["default"]=j;return r});