/*!  Copyright 2017 Dassault Systemes. All rights reserved. */
define(["DS/SMAPoweredByState/ad-state-utils","DS/SMAPoweredByState/ad-state-wc-adapter","DS/SMAPoweredByState/ad-state-cos/selectors","UWA/Class/Promise"],function(e,a,h,f){var c={};var g=window.Promise||f;function i(k,m){var l={};l={id:h.LOCALSTATIONNAME,name:h.LOCALSTATIONNAME,server:k,spaceURL:m.spaceurl,isPrivate:true,isRunAsEnabled:false,allowedUsers:[m.user],os:(m.os.toLowerCase()==="linux")?h.OS.LINUX:h.OS.WINDOWS,domains:[],status:m.status};return l}function j(n,r){var q={},p="",m,l="",k,o;q.id=r["@name"];q.name=r["@name"];q.server=n;q.status=r["@status"];q.os=(r.GeneralInfo["@os"].toLowerCase()==="unix")?h.OS.LINUX:h.OS.WINDOWS;q.isPrivate=false;q.isRunAsEnabled=r.GeneralInfo["@disableRunAs"]!=="disabled";q.allowedUsers=[];q.domains=[];p=r.GeneralInfo["@allowedUsers"];if(p){m=p.split(/[\s,]/);for(o=0;o<m.length;o++){if(m[o].length>0){q.allowedUsers.push(m[o])}}}if(q.os===h.OS.WINDOWS){l=r.GeneralInfo["@domain"];if(l){k=l.split(/[\s,]/);for(o=0;o<k.length;o++){if(k[o].length>0){q.domains.push(k[o])}}}}return q}function b(k){var m=function(n){var p=[],o;if(n){for(o=0;o<n.length;o++){p.push(i(k.serverID,n[o]))}}k.onComplete(p)},l=function(n){k.onFailure(n)};a.callGetPrivateStations({serverID:k.serverID,onComplete:m,onError:l})}function d(k){var m=function(o){var p=[],n=JSON.parse(o.response);if(n&&(typeof n.StationList!=="undefined"&&n.StationList)&&(typeof n.StationList.Station!=="undefined"&&n.StationList.Station)){if(Array.isArray(n.StationList.Station)){n.StationList.Station.forEach(function(q){if(q.GeneralInfo&&q.GeneralInfo["@drmMode"]&&q.GeneralInfo["@drmMode"].toLowerCase()!==h.DRMMode.LSF){p.push(j(k.serverID,q))}})}else{if(n.StationList.Station.GeneralInfo&&n.StationList.Station.GeneralInfo["@drmMode"]&&n.StationList.Station.GeneralInfo["@drmMode"].toLowerCase()!==h.DRMMode.LSF){p.push(j(k.serverID,n.StationList.Station))}}}k.onComplete(p)},l=function(n){k.onFailure(n)};a.callCOSService({uri:"admin/station/query",serverId:k.serverID,onComplete:m,onError:l})}c.getServers=function(){return new g(function(n,m){var o=function(q){var s=[],p=JSON.parse(q.response),r=p.COSConfiguration||p.configurations;if(Array.isArray(p)){r=p}else{r=p.COSConfiguration||p.configurations}if(r&&(r.length>0)){s=r.map(function(t){return{id:t.id,url:t.fullCosUrl,isDefault:t.isDefault,isCloud:false,isRunAsEnabled:false}})}n(s)},k=function(p){m(e.buildError(h.ErrorCodes.SERVERS_WS_ERROR,p))},l=function(){a.callSMAProcService({uri:"../eepservices/cos/configurations",onComplete:o,onError:k,sessionTimeoutInfo:{handler:m,context:null}})};a.callRefreshCOSConfigurations({onComplete:l})})};c.getServerStatus=function(k){return new g(function(n,m){var o=function(p){k.server.status=(p.response)?p.response:h.ServerStatus.UNKNOWN;n(k.server)},l=function(p){k.server.status=h.ServerStatus.NOTRESPONDING;m(e.buildError(h.ErrorCodes.SERVER_STATUS_WS_ERROR,p,k.server.id))};a.callCOSService({headers:{Accept:"text/plain"},serverId:k.server.id,uri:"admin/status",onComplete:o,onError:l})})};c.getRunAsEnabled=function(k){return new g(function(n,m){var o=function(p){k.server.isRunAsEnabled=(p.response)?p.response.toLowerCase().startsWith("true"):false;n(k.server)},l=function(p){m(e.buildError(h.ErrorCodes.RUNASENABLED_WS_ERROR,p,k.server.id))};a.callCOSService({headers:{Accept:"text/plain"},serverId:k.server.id,uri:"admin/runAsEnabled",onComplete:o,onError:l})})};c.getDRMInfo=function(k){return new g(function(q,p){var o=function(r){var t=(r.response)?parseInt(r.response):h.CLOUD_DRM_CPULIMIT_DEFAULT,s;for(s=0;s<k.server.drmInfo.length;s++){if(k.server.drmInfo[s].name===h.DRMMode.CLOUD){k.server.drmInfo[s].cpuLimit=t;break}}q(k.server)},n=function(r){p(e.buildError(h.ErrorCodes.DRM_CPULIMIT_WS_ERROR,r,k.server.id))},l=function(t){var s=JSON.parse(t.response),r=false;k.server.drmInfo=[];if(s&&s.Drms&&s.Drms.Drm){if(Array.isArray(s.Drms.Drm)){s.Drms.Drm.forEach(function(u){k.server.drmInfo.push({name:u["@name"]});if(u["@name"]===h.DRMMode.CLOUD){r=true}})}else{k.server.drmInfo.push({name:s.Drms.Drm["@name"]});if(s.Drms.Drm["@name"]===h.DRMMode.CLOUD){r=true}}}if(r){a.callCOSService({headers:{Accept:"text/plain"},serverId:k.server.id,uri:"admin/drm/Cloud/cpu",onComplete:o,onError:n})}else{q(k.server)}},m=function(r){p(e.buildError(h.ErrorCodes.DRM_WS_ERROR,r,k.server.id))};a.callCOSService({serverId:k.server.id,uri:"admin/drm",onComplete:l,onError:m})})};c.getStations=function(k){return new g(function(p,o){var r=[],q=function(s){r=r.concat(s);p({stations:r})},l=function(s){o(e.buildError(h.ErrorCodes.PRIVATE_STATIONS_ERROR,null,{serverID:k.serverID,error:s}))},m=function(s){r=r.concat(s);b({serverID:k.serverID,onComplete:q,onFailure:l})},n=function(s){o(e.buildError(h.ErrorCodes.STATIONS_WS_ERROR,s,k.serverID))};d({serverID:k.serverID,onComplete:m,onFailure:n})})};return c});