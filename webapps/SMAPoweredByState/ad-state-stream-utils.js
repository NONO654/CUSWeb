/*!  Copyright 2017 Dassault Systemes. All rights reserved. */
define(["DS/SMAPoweredByState/ad-state-wc-adapter","DS/SMAPoweredByState/ad-state-domain-managed-data/selectors"],function(b,d){var a={};function c(f,h){var e=null,g;if(f.relateddata&&f.relateddata.files){for(g=0;g<f.relateddata.files.length;g++){if(f.relateddata.files[g].dataelements&&f.relateddata.files[g].dataelements.title&&(f.relateddata.files[g].dataelements.title===h)){e=f.relateddata.files[g].id;break}}}return e}a.getFileURL=function(f,h,j,i,p){var g,k,l,n=function(q){var r=JSON.parse(q.response);if(r.data&&(r.data.length>0)&&r.data[0].dataelements&&r.data[0].dataelements.ticketURL){if(j){j(r.data[0].dataelements.ticketURL)}}else{if(i){i(q)}}},m=function(q){if(i){i(q)}},e=function(q){if(p){p(q)}},o=function(q){var r=JSON.parse(q.response);if(r.csrf&&r.data&&(r.data.length===1)){l=c(r.data[0],g.name);b.call3DSpaceService({uri:(d.Types.FILEVERSION===g.type)?"/resources/v1/modeler/documents/"+k+"/files/"+l+"/versions/"+g.id+"/DownloadTicket":"/resources/v1/modeler/documents/"+k+"/files/"+l+"/DownloadTicket",verb:"PUT",data:JSON.stringify({csrf:{name:r.csrf.name,value:r.csrf.value}}),onComplete:n,onError:m,onSessionTimeout:e})}else{if(i){i(q)}}};g=d.managedDataWithID(f,h);if(g){if(d.Types.FILEVERSION===g.type){l=d.managedDataParent(f,g.id,false).id}else{l=g.id}k=d.managedDataParent(f,l,false).id;b.call3DSpaceService({uri:"/resources/v1/modeler/documents/"+k,onComplete:o,onError:m,onSessionTimeout:e})}else{if(i){i()}}};a.getFileContent=function(e,g,i,h,m){var j=function(n){if(n.response||(n.response==="")){if(i){i(n.response)}}else{if(h){h(n)}}},k=function(n){if(h){h(n)}},f=function(n){if(m){m(n)}},l=function(p){var o=p.split("?"),n=o[0],q=o[1];b.callSPWebService({uri:n,headers:{"X-Requested-With":null,"Content-Type":"application/x-www-form-urlencoded",Accept:"*/*"},verb:"POST",data:q,onComplete:j,onError:k,onSessionTimeout:f})};a.getFileURL(e,g,l,k,f)};return a});