/*!  Copyright 2014 Dassault Systemes. All rights reserved. */
define("DS/CAT3DComposeCommands/CAT3DComposeSetIdentityMatrixCmd",["DS/ApplicationFrame/Command","DS/Selection/CSOManager","DS/PADUtils/PADContext","DS/Visualization/ThreeJS_DS","DS/CAT3DComposeMoveManager/CATC3DMoveReferent","DS/CAT3DComposeMoveManager/CAT3DComposeMoveManager"],function(e,c,f,d,a,g){var b=e.extend({init:function(i){this._parent(i,{mode:"shared",isAsynchronous:false});this.setRepeatMode(false);var k=this;var h=g.getMoveManager({context:f.get()});var j=a.getMoveReferentManager({context:f.get()});this.execute=function(){var l=[];c.get().forEach(function(n){var m=j.getMoveReferent(n.pathElement);if(m){l.push({path:m})}});if(l.length){h.onMoveBegin({objectsMoved:l,from:k,moveMode:"Persistent"});h.onMove({objectsMoved:l,from:k,leafMatrix:new d.Matrix4()});h.onMoveEnd({from:k,status:"Moved"})}}}});return b});define("DS/CAT3DComposeCommands/CATC3DReverseDirectionCmd",["DS/ApplicationFrame/Command","DS/Selection/CSOManager","DS/Visualization/ThreeJS_DS","DS/PADUtils/PADContext","DS/CAT3DComposeMoveManager/CATC3DMoveReferent","DS/CAT3DComposeConstraints/CAT3DComposeConstraintsController","DS/CAT3DComposeMoveManager/CAT3DComposeMoveManager","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(a,e,i,h,g,f,c,b){var d=a.extend({init:function(j){this._parent(j,{mode:"shared",isAsynchronous:false});this.setRepeatMode(false);this.execute=function(){var o=e.get();if(!o.length){return}var n=h.get(),q=c.getMoveManager({context:n}),s=g.getMoveReferentManager({context:n}),m=f.giveConstraintsController({context:n}),t,l=o.some(function(x){t=s.getMoveReferent(x.pathElement);var w;if(m&&t&&(w=t.getLastElement(true))&&b.isInstance(w)&&w.children.length>0){t.addElement(w.children[0]);return m.isThereACstSuppportingReverseDirection(t)}return false});if(l&&t&&m){var p=m.simulateReverseDirection(t)||{};var r=p.matrix||new i.Matrix4(),u=new i.Matrix4(),k=p.rc,v=p.redundancy;if(k===0&&!v){q.onMoveBegin({objectsMoved:o,from:this,moveMode:"Persistent"});o.forEach(function(w){q.onMove({objectsMoved:[{path:w.pathElement}],from:this,worldMatrix:u.multiplyMatrices(r,w.pathElement.getWorldMatrix())})},this);q.onMoveEnd({from:this,status:"Moved"})}}}}});return d});define("DS/CAT3DComposeCommands/CATC3DPasteAtLocalCoordinatesCmd",["DS/ApplicationFrame/CommandCheckHeader","DS/Selection/CSOManager","DS/PADUtils/PADContext","DS/Visualization/ThreeJS_DS","DS/ApplicationFrame/CommandsManager","DS/CAT3DComposeMoveManager/CAT3DComposeMoveManager"],function(f,c,e,d,b,h){var g=new d.Matrix4();var a=f.extend({init:function(j){this._parent(j);var k=this,i=h.getMoveManager({context:e.get()});this.onStateChange(function(){if(k.getState()){var m=[];c.get().forEach(function(n){m.push({path:n.pathElement})});if(m.length){i.onMoveBegin({objectsMoved:m,from:k,moveMode:"Persistent"});i.onMove({objectsMoved:m,from:k,leafMatrix:g});i.onMoveEnd({from:k,status:"Moved"});e.get().getViewer().render()}var l=e.get();b.getCommandCheckHeader("CATC3DPasteAtOriginalPositionHdr",l.getCommandContext?l.getCommandContext():null).setState(false)}});this.toggleState=function(){if(!k.getState()){k.setState(true)}};this._destroy=function(){if(Object.getPrototypeOf(this)._destroy){Object.getPrototypeOf(this)._destroy.apply(this,arguments)}k=undefined}}});return a});define("DS/CAT3DComposeCommands/CATC3DPasteAtOriginalPositionCmd",["DS/ApplicationFrame/CommandCheckHeader","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/PADUtils/PADContext","DS/Visualization/ThreeJS_DS","DS/CAT3DComposeMoveManager/CAT3DComposeMoveManager","DS/ApplicationFrame/CommandsManager"],function(i,d,c,f,h,b,a){var e=new h.Matrix4();var g=i.extend({init:function(r){this._parent(r);var n=this,q,o=false,p=[],k=f.get().getFrameWindow().getContextualUIManager(),m=b.getMoveManager({context:f.get()}),j=function(){q=[];k.hideContextualMenus();d.get().forEach(function(t){var u=m.getSubPathToMovable(t.pathElement);var s=u.getLastElement(true).getMatrix();if(!s.equals(e)){q.push({pathElement:t.pathElement,path:u,matrix:s})}});if(q.length>0){k.showContextualBar({x:f.get().getViewer().SCREEN_WIDTH/2,y:f.get().getViewer().SCREEN_HEIGHT/2,hideWithDistance:false,fillingList:[{onContextualBarReady:function(){return{cmdList:[{name:"CATC3DPasteAtOriginalPositionStr",line:1,hdr_list:["CATC3DPasteAtOriginalPositionHdr"]},{name:"CATC3DPasteAtLocalCoordinatesStr",line:1,hdr_list:["CATC3DPasteAtLocalCoordinatesHdr"]}]}},context:f.get().getCommandContext?f.get().getCommandContext():null,workbenchName:"CAT3DComposeWidgetWkb",module:"CAT3DComposeWidget",cmdPrefix:""}]});o=true;n.setState(true)}},l=f.get().subscribe({event:"onAuthoringTransactionEnd"},j);require(["DS/CAT3DComposeUtils/CATC3DDropManager"],function(t){var s=t.getDropManager({context:f.get()});p.push(s.subscribe({event:"onBeginInsertDrop3D"},function(){f.get().unsubscribe(l)}));p.push(s.subscribe({event:"onEndInsertDrop3D"},function(u){if(u&&u.type==="inPosition"){j()}l=f.get().subscribe({event:"onAuthoringTransactionEnd"},j)}))});this.onStateChange(function(){if(n.getState()){if(!o){if(q.length>0){m.onMoveBegin({objectsMoved:q,from:n,moveMode:"Persistent"});q.forEach(function(u){var t=u.path.getLastElement(true).getMatrix();if(!t.equals(u.matrix)&&d.isIn(u)){m.onMove({objectsMoved:[u],from:n,leafMatrix:u.matrix})}});m.onMoveEnd({from:n,status:"Moved"});f.get().getViewer().render()}}else{o=false}var s=f.get();a.getCommandCheckHeader("CATC3DPasteAtLocalCoordinatesHdr",s.getCommandContext?s.getCommandContext():null).setState(false)}});this.toggleState=function(){if(!this.getState()){n.setState(true)}};this._destroy=function(){f.get().unsubscribe(l);require(["DS/CAT3DComposeUtils/CATC3DDropManager"],function(t){var s=t.getDropManager({context:f.get()});if(s){p.forEach(function(u){s.unsubscribe(u)})}p=[]});if(Object.getPrototypeOf(this)._destroy){Object.getPrototypeOf(this)._destroy.apply(this,arguments)}m=q=o=l=k=j=n=undefined}}});return g});define("DS/CAT3DComposeCommands/CATC3DCommandsUtils",["DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(b){var c=function(g){return g&&b.isPLMNode(g)};var e=function(g){return g&&b.isReference(g)};var a=function(g){return g&&b.isInstance(g)};var f=function(g){return g&&b.is3DLeaf(g)};var d={};d.isPLMNode=c;d.isPLMReferenceNode=e;d.isPLMInstanceNode=a;d.isPLMLeafNode=f;d.getLevelSelectorLevels=function(w){if(!w){return undefined}var p=w.pathElement,h=w.pathElementCurrent,g=w.onInfoCompleted,i=w.context;if(!p||!i){return undefined}var l=[],s=[],k=[],q=null,v=i.getBIController()?i.getBIController().isColorizeActivated():false;var n={levels:l};var t=p.clone(),u=t.getLastElement(true),j=false;while(u){var m={};if(a(u)&&l.length===0&&u.children.length===1){m.pathElement=t.clone();var o=u.children[0];m.pathElement.addElement(o);if(!v){k.push(m.modifID=b.getNodeID(u))}else{m.canvasColor=b.getBIColor(o)}s.push(m.idRef=b.getNodeID(o));s.push(m.idInst=b.getNodeID(u));q=1}else{if(e(u)){m.pathElement=t.clone();s.push(m.idRef=b.getNodeID(u));var x=t.externalPath.length>1?t.externalPath[t.externalPath.length-2]:null;if(a(x)){s.push(m.idInst=b.getNodeID(x));if(!v){k.push(m.modifID=b.getNodeID(x))}}else{j=true}if(v){m.canvasColor=b.getBIColor(u)}}else{if(f(u)){m.pathElement=t.clone();s.push(m.idRef=b.getNodeID(u));if(v){m.canvasColor=b.getBIColor(u)}}else{if(j){if(c(u)){var r=t.externalPath.length>1?t.externalPath[t.externalPath.length-2]:null;if(!c(r)){m.pathElement=t.clone();s.push(m.idRef=b.getNodeID(u));if(!v){k.push(m.modifID=b.getNodeID(u))}else{m.canvasColor=b.getBIColor(u)}j=false}}}}}}if(m.pathElement){if(q===null&&h&&h.isEqual(m.pathElement)){q=l.length}l.push(m)}t=t.getParentPath();u=t?t.getLastElement(true):undefined}if(q!==null){n.currentLevel=q}i.getController().getAttributes({ids:s,attributes:["ds6w:label","type_icon_url"],callbacks:{onComplete:function(y){l.forEach(function(z){z.name=y[z.idRef]?y[z.idRef]["ds6w:label"]:"";if(z.idInst&&y[z.idInst]&&y[z.idInst]["ds6w:label"]){z.name+=" ("+y[z.idInst]["ds6w:label"]+")"}z.icon=y[z.idRef]?y[z.idRef].type_icon_url:undefined;delete z.idRef;delete z.idInst});if(g){g()}},onFailure:function(){l.forEach(function(y){delete y.idRef;delete y.idInst})}}});if(!v&&k.length&&require("DS/PADUtils/PADSettingsMgt").getSetting("appModelerType")==="DEC"){i.getController().getEditability({data:k,intent:"MOVE",callbacks:{onComplete:function(y){l.forEach(function(z){if(z.modifID in y&&!y[z.modifID]){z.canvasColor="#FF6565"}delete z.modifID});if(g){g()}},onFailure:function(){}}})}return n};return d});define("DS/CAT3DComposeCommands/CAT3DComposeCtxMenuAgent",["UWA/Class","DS/Selection/CSOManager","DS/Visualization/ThreeJS_DS","DS/ApplicationFrame/CommandsManager","DS/CATC3DGeometry/CATC3DGeometryEnums","DS/CAT3DComposeConstraints/CAT3DComposeConstraintsController","DS/CAT3DComposeMoveManager/CATC3DMoveReferent","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(j,c,i,a,d,e,f,b){var h=0;var g=j.extend({init:function(o){this._parent(o);var m=o.context,l=m.getCommandContext?m.getCommandContext():null,n,p,k=[];this.activate=function(){if(k.length===0){n=m.getViewer();p=f.getMoveReferentManager({context:m});k=["CAT3DComposeCtxMenuAgent_"+(h++),"CAT3DComposeCtxMenuAgent_"+(h++)];m.getFrameWindow().getContextualUIManager().register({onContextualBarReady:function(x,y){var r=c.get();if(r.length===0){return undefined}var z=b.getRoots(m),v=[],u=false,s=false,q=e.giveConstraintsController({context:m});r.some(function(C){var B=p.getMoveReferent(C.pathElement),A;if(B&&(A=B.getLastElement(true))&&b.isInstance(A)&&A.children.length>0){B.addElement(A.children[0]);if(q&&q.isThereACstSuppportingReverseDirection(B)){u=true}var D=q?q.getAxisTypeIfCstOnProductAxis(B):null;if(D){s=true;if(D===d.GeometryType.AXISX){a.getCommandCheckHeader("CATC3DSwitchAxisXHdr",l).setState(true)}else{if(D===d.GeometryType.AXISY){a.getCommandCheckHeader("CATC3DSwitchAxisYHdr",l).setState(true)}else{a.getCommandCheckHeader("CATC3DSwitchAxisZHdr",l).setState(true)}}}return u&&s}return false});if(s){v.push({name:"CATC3DSwitchAxisIcb",line:1,hdr_list:["CATC3DSwitchAxisXHdr","CATC3DSwitchAxisYHdr","CATC3DSwitchAxisZHdr"]})}if(u){v.push({name:"CATC3DReverseDirectionStr",line:1,hdr_list:["CATC3DReverseDirectionHdr"]})}var t=r.some(function(B){var A=B.pathElement.getLastElement(true);return z.some(function(C){var E=C!==A;var D=B.pathElement.externalPath.some(function(F){return C===F});return E&&D})});if(t&&y&&y.withContextMenu&&typeof y.XmousePosition==="number"&&typeof y.YmousePosition==="number"){var w=n.pick(n.getMousePosition(new i.Vector2(y.XmousePosition,y.YmousePosition)),"mesh",false);if(w.path.length===0){t=false}}if(t){if(a.getCommand("CAT3DComposeExamineSelectionHdr",l).canBeEnabled(r)){v.push({name:"CAT3DComposeExamineSelectionStr",line:1,hdr_list:["CAT3DComposeExamineSelectionHdr"]})}if(r.length===1){v.push({name:"LevelSelector",line:1,hdr_list:["LevelSelectorHdr"]})}}return v.length?{cmdList:v}:undefined},context:l,workbenchName:"CAT3DComposeWidgetWkb",module:"CAT3DComposeWidget",cmdPrefix:"",merge:true,subscriberId:k[0]});m.getFrameWindow().getContextualUIManager().register({onContextualBarReady:function(s,v){var u=[];var r=c.get();if(r.length===1){var t=r[0].pathElement.getLastElement(true);if(b.getRoots(m).some(function(w){return w===t})){u.push({name:"RemoveRoot",line:1,hdr_list:["RemoveRootHdr"]})}}if(v&&v.withContextMenu&&typeof v.XmousePosition==="number"&&typeof v.YmousePosition==="number"){var q=n.pick(n.getMousePosition(new i.Vector2(v.XmousePosition,v.YmousePosition)),"mesh",false);if(q.path.length===0){return undefined}}return u.length?{cmdList:u}:undefined},context:l,workbenchName:"ENOPAD3DViewerContextualBar",module:"ENOPAD3DViewer",cmdPrefix:"",merge:true,subscriberId:k[1]})}};this.deactivate=function(){n=p=null;k.forEach(function(q){m.getFrameWindow().getContextualUIManager().unregister(q)});k=[]}}});return g});define("DS/CAT3DComposeCommands/CATC3DSwitchAxisCmd",["DS/ApplicationFrame/CommandCheckHeader","DS/ApplicationFrame/CommandsManager","DS/Selection/CSOManager","DS/PADUtils/PADContext","DS/Visualization/ThreeJS_DS","DS/CAT3DComposeConstraints/CAT3DComposeConstraintsController","DS/CAT3DComposeMoveManager/CATC3DMoveReferent","DS/CAT3DComposeMoveManager/CAT3DComposeMoveManager","DS/CATC3DGeometry/CATC3DGeometryEnums","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(k,a,e,i,j,g,h,d,f,b){var c=f.GeometryType;return k.extend({init:function(l){this._parent(l);var n,m;switch(l.ID){case"CATC3DSwitchAxisXHdr":n=c.AXISX;m=["CATC3DSwitchAxisYHdr","CATC3DSwitchAxisZHdr"];break;case"CATC3DSwitchAxisYHdr":n=c.AXISY;m=["CATC3DSwitchAxisXHdr","CATC3DSwitchAxisZHdr"];break;default:n=c.AXISZ;m=["CATC3DSwitchAxisXHdr","CATC3DSwitchAxisYHdr"];break}var o=this.onStateChange(function(){if(this.getState()){var r=g.giveConstraintsController({context:i.get()}),t=d.getMoveManager({context:i.get()}),w=h.getMoveReferentManager({context:i.get()});var u=e.get(),z,x;u.some(function(B){x=w.getMoveReferent(B.pathElement);var C;if(r&&x&&(C=x.getLastElement(true))&&b.isInstance(C)&&C.children.length>0){x.addElement(C.children[0]);return(z=r.getAxisTypeIfCstOnProductAxis(x))}return false});if(r&&z&&z!==n&&x){var s=r.simulateSwitchAxis(x,n)||{};var v=s.matrix||new j.Matrix4(),y=new j.Matrix4(),p=s.rc,A=s.redundancy;if(p===0&&!A){t.onMoveBegin({objectsMoved:u,from:this,moveMode:"Persistent"});u.forEach(function(B){t.onMove({objectsMoved:[{path:B.pathElement}],from:this,worldMatrix:y.multiplyMatrices(v,B.pathElement.getWorldMatrix())})},this);t.onMoveEnd({from:this,status:"Moved"});r.setProductAxisForConstraint(n)}}var q=i.get();m.forEach(function(B){a.getCommandCheckHeader(B,q.getCommandContext?q.getCommandContext():null).setState(false)})}});this._destroy=function(){this._modelEvents.unsubscribe(o);Object.getPrototypeOf(this)._destroy.call(this);o=m=null}},toggleState:function(){if(!this.getState()){this.setState(true,true)}},_destroy:function(){this._parent()}})});define("DS/CAT3DComposeCommands/CATC3DAxisSystemDisplayAgent",["UWA/Class","DS/Visualization/PathElement","DS/Selection/PSOManager","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/CAT3DComposeUtils/CAT3DCompose3DAnimation","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/RenderStyle","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(k,e,j,c,d,b,h,g,a){var f="AxisSystems",i=k.extend({init:function(p){var u=p.context,v,m,x,q,A,l,n=u.getViewer().getSceneGraphOverrideSetManager(),t;function s(G,F){return G&&F&&G.isEqual(F)}function y(F){return q&&!q.get().some(function(G){return G.pathElement.getLastElement(true)===F.getLastElement(true)})}function B(H){var G=H?new e(H.externalPath):null,F;while(G&&!((F=G.getLastElement())&&a.is3DLeaf(F))){G=G.getParentPath()}return G}function z(G,F){var H=null;F.push(G);H=G.getChildrenPathes();if(H&&H.length>0){H.forEach(function(I){z(I,F)})}}function w(M){var F=B(M),K,G,N,L,I=null;if(F){N=[];K=F.getLastElement(true);G=K.getChildByName(f);if(G){L=G.getParents();while(L&&L[0]&&L[0]!==K){N.unshift(L[0]);L=L[0].getParents()}N.push(G);I=F;N.forEach(function(O){I.addElement(O)})}}if(I){var H=I.getChildrenPathes(),J=[];H.forEach(function(P){var O={paths:[]};z(P,O.paths);J.push(O)});return{axisBagPath:I,axisSystems:J}}return null}function E(F){if(!F||!F.pathElement){return null}if(u.getViewer().getAxisFilter()){if(t){n.removeSceneGraphOverrideSet(t);t=null;u.getViewer().render()}return null}if(t&&n.getSceneGraphOverrideSetIndex(t)===-1){n.pushSceneGraphOverrideSet(t)}var G=w(F.pathElement);if(G&&G.axisSystems&&G.axisSystems.length>0){var H=[];G.axisSystems.forEach(function(I){if(y(I.paths[0])){I.node=I.paths[0].getLastElement(true);H.push(I)}});if(H.length===G.axisSystems.length){H.push({paths:[G.axisBagPath]})}if(H.length>0){H.forEach(function(K){if(!t){t=new h(u.getRootBagPath().externalPath[0]);n.pushSceneGraphOverrideSet(t)}var J=t.getUniqueOverrideFromPathElement(K.paths[0]),I;if(!J){J=t.createOverride({pathes:K.paths});I=new g();I.setRenderMode("AxisSystem",true);J.setRenderStyle(I)}K.override=J})}b.get3DComposeAnimationEngine({viewer:u.getViewer()}).axisSystemVisibility({objectListToAnimate:H,visibility:F.visibility,pickability:F.pickability})}return F.pathElement}function D(F){var G=B(F.pathElement);if(!s(A,G)){E({pathElement:A,visibility:false,pickability:false});A=E({pathElement:G,visibility:true,pickability:true})}}function o(){var F=j.get();clearTimeout(l);l=null;if(F.length!==1){E({pathElement:A,visibility:false,pickability:false});return}D({pathElement:F[0].pathElement?F[0].pathElement:F[0].originalPathElement})}function C(F){var G=B(F.pathElement?F.pathElement:F.originalPathElement);if(G){l=setTimeout(function(){E({pathElement:G,visibility:false,pickability:false});A=null},1000)}}function r(F){var G=B(F.pathElement);if(!A||(A&&G&&!s(G,A))){E({pathElement:F.pathElement,visibility:false,pickability:false})}}u.getViewer().onAxisFilterChange(function(){if(t){n.removeSceneGraphOverrideSet(t);t=null;u.getViewer().render()}});this.activate=function(F){if(q){return}if(t){n.pushSceneGraphOverrideSet(t);u.getViewer().render()}v=j.onPostAdd(o);m=j.onRemove(C);q=(F&&F.type==="HSO")?c:d;x=q.onRemove(r)};this.analyze=D;this.deactivate=function(){if(!q){return}if(t){n.removeSceneGraphOverrideSet(t);u.getViewer().render()}j.unsubscribe(v);j.unsubscribe(m);q.unsubscribe(x);v=m=x=q=null}}});return i});define("DS/CAT3DComposeCommands/CAT3DComposeMoveCmd",["UWA/Class","UWA/Core","DS/ApplicationFrame/Command","DS/CoreEvents/ModelEvents","DS/UIKIT/Spinner","DS/Visualization/SceneGraphUtils","DS/CAT3DComposeUtils/CAT3DCompose3DAnimation","DS/CAT3DComposeBoxes/CAT3DComposeBoxController","DS/ApplicationFrame/CommandsManager","DS/CAT3DComposeCommands/CAT3DComposeCtxMenuAgent","DS/PADUtils/PADContext","DS/CAT3DComposeMoveManager/CAT3DComposeMoveManager","DS/CAT3DComposeCommands/CATC3DCommandsUtils","DS/CATWebUXComponents/CATWebUXNotifBar"],function(z,s,v,k,c,u,d,t,a,o,n,r,h,p){var i,A,q,j,f,y,e,g,m,x;require(["i18n!DS/CAT3DComposeCommands/assets/nls/CAT3DComposeNotificationAgent"],function(B){i=B.PositionModifiedLbl;A=B.PositionModifiedOK;q=B.PositionModifiedCancel;j=B.PositionLockedLbl;f=B.PositionLockedLink;y=B.PositionModifiedSaveOK;e=B.PositionModifiedSaveKO;g=B.singleSplitInstance;m=B.multipleSplitInstance});require(["DS/Selection/CSOManager"],function(B){x=B});var l=z.extend({init:function(C){var F,B,E,D;this.show=function(){if(!F){F=new p({className:"c3dMoveCmdDlg"}).inject(C.uiFrame);this.hide();B=F.add({msgType:"primary",message:i,closable:false,buttons:[{className:"spinner"},{className:"primary",label:A,onClick:C.onSave},{className:"default",label:q,onClick:C.onCancel}]});this.hideSpinner();this.hideSave();E=F.add({msgType:"warning",message:j,closable:false,buttons:[{className:"link",label:f,onClick:C.onCancelLocked}]});E.hide()}F.show()};this.showSave=function(){this.hideSpinner();if(B){B.buttons[1].show();D=true}};this.showSpinner=function(){if(D===false){B.buttons[0].show()}};this.showLock=function(){if(E){E.show()}};this.hide=function(){if(F){F.hide()}};this.hideSave=function(){if(B){D=false;B.buttons[1].hide()}};this.hideSpinner=function(){if(B){B.buttons[0].hide()}};this.hideLock=function(){if(E){E.hide()}};this.destroy=function(){if(F){F.destroy()}F=B=E=null}}});var b,w=v.extend({init:function(F){this._parent(F,{mode:"exclusive",isAsynchronous:true});this.setRepeatMode(false);var T=this,Q=true,U=false,N=n.get(),K=N.getCommandContext?N.getCommandContext():null,G=r.getMoveManager({context:N}),R,S=new o({context:N}),H=function(){U=true;Q=false;G.terminateMove({save:false});T.end()},L=function(){U=true;Q=false;G.terminateMove({save:true});T.end()},C=function(){G.cancelLocked()},M=false,D=new v({ID:"CAT3DComposeFakeMoveHdr",mode:"shared",isAsynchronous:false,context:K}),E=G.subscribe("MoveBegin",function(){if(T.isRunning()){a.getCommand("CAT3DComposeExamineSelectionHdr",K).deactivate()}}),V=G.subscribe("Move",function(X){if(X.objectsMoved.length>0&&X.moveMode==="Persistent"){X.objectsMoved.forEach(function(Z){var Y=Z.path.getLastElement(true);if(h.isPLMInstanceNode(Y)){if(!T._isRunning){M=true;T.begin()}R.showSpinner();G.isPathLocked({pathElement:Z.path,onCompleted:function(aa){if(R){R.hideSpinner();if(aa.isLocked){R.showLock()}else{R.showSave()}}}})}})}}),I=G.subscribe("MoveEnd",function(){if(T.isRunning()){var X=t.getBoxController({context:N});if(X){X.setActiveState(true)}a.getCommand("CAT3DComposeExamineSelectionHdr",K).activate()}M=false}),O,P,B=function(aa){var Z=(aa.eventID==="success"&&aa.objectsMoved.length>0)?y:(aa.eventID==="error"&&aa.objectsCancelled.length>0)?e:null;if(Z){N.displayNotification({eventID:aa.eventID,msg:Z})}var ab=d.get3DComposeAnimationEngine({viewer:N.getViewer()});if(aa&&aa.splitInstances&&aa.splitInstances.length){N.displayNotification({eventID:"info",msg:aa.splitInstances.length>1?m:g});var ad=[],Y=N.getController(),ac=N.getRootBagPath().getLastElement(true);aa.splitInstances.forEach(function(ae){ad=ad.concat(u.buildPathesLeadingToNode(Y.getNode({id:ae.newId}),ac).map(function(af){return{path:af}}))});ab.addAnimation({animationType:"opacityOnOff",objectListToAnimate:ad,duration:1000,createOverrideSet:true});ab.addAnimation({animationType:"color",objectListToAnimate:ad,duration:1000,createOverrideSet:true,color:"#ff821e"});if(x){var X=x.get();if(X.length){x.empty()}if(ad.length){x.add(ad.map(function(ae){return{pathElement:ae.path}}))}if(X.length){x.empty()}x.add(X)}}if(aa.objectsCancelled&&aa.objectsCancelled.length>0){ab.addAnimation({animationType:"cancel",objectListToAnimate:aa.objectsCancelled,callBackFct:function(){setTimeout(function(){D.begin()},0)},createOverrideSet:true})}ab.startAnimation();if(U){G.unsubscribe(O);G.unsubscribe(P)}},J=function(X){if(R&&X.bEmptyMove===true){R.hideSave();R.hideLock()}else{if(R&&!X.someMovedObjectsAreLocked){R.hideLock()}}if(X.objectsCancelled&&X.objectsCancelled.length>0){var Z=d.get3DComposeAnimationEngine({viewer:N.getViewer()});var Y={animationType:"cancel",objectListToAnimate:X.objectsCancelled,callBackFct:function(){setTimeout(function(){D.begin()},0)},createOverrideSet:true};Z.addAnimation(Y);Z.startAnimation()}else{N.getViewer().render()}if(U){G.unsubscribe(O);G.unsubscribe(P)}},W=function(X){if(X.key==="Enter"||X.keyCode===13){if(X.ctrlKey===false&&X.altKey===false&&X.shiftKey===false&&X.metaKey===false){L();document.removeEventListener("keydown",W)}}};if(!b){require(["DS/CAT3DComposeDirectMove/CAT3DComposeDirectMove"],function(X){b=X;if(T.isRunning()){b.activate({context:N})}})}this.beginExecute=function(){Q=true;U=false;R=new l({uiFrame:N.getFrameWindow().getUIFrame(),onSave:L,onCancel:H,onCancelLocked:C});R.show();S.activate();if(!M){var Y=t.getBoxController({context:N});if(Y){Y.setActiveState(true)}var X=a.getCommand("CAT3DComposeExamineSelectionHdr",K);X.activate()}if(b){b.activate({context:N})}document.addEventListener("keydown",W);O=G.subscribe("onValidateMove",B);P=G.subscribe("onCancelMove",J)};this.endExecute=function(){document.removeEventListener("keydown",W);if(Q){U=true;G.terminateMove({save:false})}R.destroy();R=null;S.deactivate();var Y=t.getBoxController({context:N});if(Y){Y.setActiveState(false)}var X=a.getCommand("CAT3DComposeExamineSelectionHdr",K);if(X){X.deactivate()}N.getFrameWindow().getContextualUIManager().hideContextualMenus();if(b){b.deactivate({context:N})}};this.pauseExecute=function(){var X=t.getBoxController({context:N});if(X){X.setActiveState(false)}R.hide();S.deactivate();a.getCommand("CAT3DComposeExamineSelectionHdr",K).deactivate();if(b){b.deactivate({context:N})}document.removeEventListener("keydown",W)};this.resumeExecute=function(){var X=t.getBoxController({context:N});if(X){X.setActiveState(true)}R.show();S.activate();a.getCommand("CAT3DComposeExamineSelectionHdr",K).activate();if(b){b.activate({context:N})}document.addEventListener("keydown",W)};this.getRequestedCommandMode=function(X){return(X.cmd==="Measure"||X.cmd==="Section")?"shared":undefined};this.allowManipulation=function(X){return(X.object==="Measure"||X.object==="Section")?true:undefined};this._destroy=function(){Object.getPrototypeOf(this)._destroy.apply(this,arguments);G.unsubscribe(E);G.unsubscribe(V);G.unsubscribe(I);G.unsubscribe(O);G.unsubscribe(P);if(b){b.unreference({context:N})}N=G=S=R=O=P=E=V=I=T=null}}});return w});define("DS/CAT3DComposeCommands/CAT3DComposeLevelSelectorCmd",["DS/ApplicationFrame/Command","DS/LevelSelector/LevelSelector","DS/Selection/CSOManager","DS/Selection/HSOManager","DS/PADUtils/PADContext","DS/VisuEvents/EventsManager","DS/VisuEvents/ScreenEvent","DS/CAT3DComposeMoveManager/CATC3DMoveReferent","DS/CAT3DComposeCommands/CATC3DCommandsUtils"],function(a,f,d,c,h,b,g,e,j){var i=a.extend({init:function(t){this._parent(t,{mode:"shared",isAsynchronous:true});this.setRepeatMode(false);var m=this;var k=h.get();var s;var o;var n;var l;var p;var r=function(u){p=null;if(u&&u.from&&u.from.length===1&&u.from[0].event&&u.from[0].event.type==="touchend"&&u.from[0].event.changedTouches.length===1){p=u.from[0]}};b.addEvent(document,"onRelease",r);this.execute=function(){l=d.onChange(function(){m.end()});var w=s;if(!w){var B=d.get();s=B.length>0?B[B.length-1]:undefined;w=s;o=s?s.pathElement:undefined}if(w&&w.pathElement){k.getFrameWindow().getContextualUIManager().hideContextualMenus();var u={x:0,y:0};if(p){var A=p.event.changedTouches[0];u.x=A.clientX;u.y=A.clientY}else{var v=b.getMouseEvents(g.MouseButton.NONE);if(v&&v.length){u.x=v[0].event.clientX;u.y=v[0].event.clientY}}p=null;var y=o;if(!m.setRobotParams){y=e.getMoveReferentManager({context:k}).getMoveReferent(o);var x=y.getLastElement(true);if(x&&j.isPLMInstanceNode(x)&&x.children.length){y.addElement(x.children[0])}}var z={display:{type:"position",x:u.x,y:u.y},uiFrame:k.getFrameWindow().getUIFrame(),getLevels:function(C){var G=j.getLevelSelectorLevels({pathElement:w.pathElement,pathElementCurrent:y,onInfoCompleted:C,context:k});if(G&&!m.setRobotParams){G.selectColor="#ff821e";G.selectOverColor="#ffb477";for(var D=G.levels.length-1;D>=0;--D){var F=G.levels[D];var E=F.pathElement.getLastElement(true);if(!j.isPLMReferenceNode(E)){F.selection="notCurrent";continue}F.selection="notCurrent";if(G.currentLevel>=D){delete G.currentLevel}break}}return G},onHover:function(C){c.empty();c.add(C)},onLeave:function(C){if(s){c.remove(C);c.add(s)}},onSelect:function(E){l=d.unsubscribe(l);if(E&&E.pathElement&&E.pathElement.internalPath.length===0){if(!m.setRobotParams){e.getMoveReferentManager({context:k}).addMoveReferent(E.pathElement)}s.pathElement=E.pathElement;c.empty();d.empty();var D=s,C=n;setTimeout(function(){c.add(D);d.add(D);if(C){C(E)}k.getFrameWindow().getContextualUIManager().showContextualBar({hideWithDistance:true})},0)}m.end()}};f.createView(z)}else{m.end()}};this.endExecute=function(){l=d.unsubscribe(l);n=undefined;s=undefined;o=undefined;f.destroyView()};this.pauseExecute=function(){m.endExecute()};this.resumeExecute=function(){m.execute()};if(t.ID==="CAT3DComposeRobotLevelSelectorHdr"){this.setRobotParams=function(u){n=u.selectCB;s={pathElement:u.pathContext.clone()};o=u.pathCurrent.clone()}}var q=this._destroy;this._destroy=function(){if(!m){return}b.removeEvent(document,"onRelease",r);q.call(m);m=k=null}}});return i});define("DS/CAT3DComposeCommands/CATC3DDefaultSelectionFilter",["UWA/Class","DS/Visualization/PathElement","DS/Selection/PSOManager","DS/WebappsUtils/WebappsUtils","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","DS/CAT3DComposeCommands/CATC3DAxisSystemDisplayAgent","DS/CATC3DGeometry/CATC3DEquivalentGeometry","DS/CATC3DGeometry/CATC3DGeometryEnums"],function(p,e,n,c,a,m,g,h){var f={};require(["i18n!DS/CAT3DComposeCommands/assets/nls/CAT3DComposeCommands"],function(q){f.point=q.point;f.center=q.center;f.axisSystem=q.axisSystem;f.line=q.line;f.plane=q.plane;f.cylinder=q.cylinder;f.product=q.product});var b=c.getWebappsAssetUrl("DMUBaseCommands","icons/32/");var k=c.getWebappsAssetUrl("CAT3DComposeCommands","icons/32/");var i,l,j=function(q){if(i){q()}else{if(!l){l=true;require(["DS/Web3DUXFilterBar/Web3DUXFilterBar"],function(r){l=false;i=r;q()})}}};var d=p.extend({init:function(v){var B=v.context,I=true,H={none:0,point:0,center:0,axisSystem:1,line:0,plane:1,cylinder:1,product:1},J,F,A,E,C,z,r,x=localStorage.getItem("C3DSelectionFilter"),s=new m({context:B}),G=function(){H={none:1,point:0,center:0,axisSystem:0,line:0,plane:0,cylinder:0,product:0};if(E.getActiveState("point")){H.none=0;H.point=1}if(E.getActiveState("center")){H.none=0;H.center=1}if(E.getActiveState("axisSystem")){H.none=0;H.axisSystem=1}if(E.getActiveState("line")){H.none=0;H.line=1}if(E.getActiveState("plane")){H.none=0;H.plane=1}if(E.getActiveState("cylinder")){H.none=0;H.cylinder=1}if(E.getActiveState("product")){H.none=0;H.product=1}var L="0-"+H.point+H.center+H.axisSystem+H.line+H.plane+H.cylinder+H.product+"-"+(I?1:0);localStorage.setItem("C3DSelectionFilter",L);if(H.axisSystem){s.activate()}else{s.deactivate()}},t=(function(){var M;function L(N){if(!N){M=false;if(E){E.setVisibleFlag(false)}return}M=true;if(I){if(!E){j(function(){E=new i({body:B.getFrameWindow().getUIFrame(),frmWindow:B.getFrameWindow(),Idpanel:"c3dSelectionFilter",classpanel:"c3dSelectionFilter",typeSeparator:"bubble",lJsonElement:[{type:"element",id:"point",nls:f.point,url:b+"I_Meas_Point.png",callback:G,bexclude:false,bstateActif:H.point},{type:"element",id:"center",nls:f.center,url:b+"I_Meas_PointCircle.png",callback:G,bexclude:false,bstateActif:H.center},{type:"element",id:"axisSystem",nls:f.axisSystem,url:k+"I_3DComposeAxisSystem.png",callback:G,bexclude:false,bstateActif:H.axisSystem},{type:"element",id:"line",nls:f.line,url:b+"I_Meas_Line.png",callback:G,bexclude:false,bstateActif:H.line},{type:"element",id:"plane",nls:f.plane,url:b+"I_Meas_Plane.png",callback:G,bexclude:false,bstateActif:H.plane},{type:"element",id:"cylinder",nls:f.cylinder,url:b+"I_Meas_Cylinder.png",callback:G,bexclude:false,bstateActif:H.cylinder},{type:"element",id:"product",nls:f.product,url:b+"I_Meas_Product.png",callback:G,bexclude:false,bstateActif:H.product}]});E.build();var O=document.querySelector(".c3dSelectionFilter");if(O){O.style.position="absolute"}E.setVisibleFlag(false);if(M&&I){E.setVisibleFlag(true)}})}else{E.setVisibleFlag(true)}}else{if(E){E.setVisibleFlag(false)}}}return function(){if(!C){L(false);return}L(B&&a.getRoots(B).length>0)}}());if(x&&x.length>8&&x.startsWith("0-")){H.point=x.charAt(2)==="1"?1:0;H.center=x.charAt(3)==="1"?1:0;H.axisSystem=x.charAt(4)==="1"?1:0;H.line=x.charAt(5)==="1"?1:0;H.plane=x.charAt(6)==="1"?1:0;H.cylinder=x.charAt(7)==="1"?1:0;H.product=x.charAt(8)==="1"?1:0;if(H.point===0&&H.center===0&&H.axisSystem===0&&H.line===0&&H.plane===0&&H.cylinder===0&&H.product===0){H.none=1}if(x.length>10&&x.charAt(9)==="-"){I=x.charAt(10)==="1"}}function K(L){var M=L.pathElement;L.pathElement=new e();M.externalPath.some(function(N){L.pathElement.addElement(N);return N&&a.is3DLeaf(N)});if(M.internalPath.length>0){L.originalPathElement=M}return L}function D(M){if(!M||!M.pathElement||!M.pathElement.externalPath.length||!a.isAModelPath(M.pathElement)){return M}if(H.none){return K(M)}if(H.axisSystem||H.point||H.center||H.line||H.plane||H.cylinder){var L=g.getEquivalentGeometry(M),N=L?L.getType():null;if(H.axisSystem&&N===h.GeometryType.AXISSYSTEM){M.originalPathElement=M.pathElement;M.pathElement=L.getPathElement();M.equivalentGeometry=L;return M}else{if((H.point&&N===h.GeometryType.POINT)||(H.center&&(N===h.GeometryType.CIRCLE||N===h.GeometryType.SPHERE))||(H.line&&N===h.GeometryType.LINE)||(H.plane&&(N===h.GeometryType.PLANE||N===h.GeometryType.REFPLANE))||(H.cylinder&&(N===h.GeometryType.CYLINDER||N===h.GeometryType.CONE))){M.equivalentGeometry=L;return M}}}if(H.product){return K(M)}M.originalPathElement=M.pathElement;M.pathElement=null;return M}function w(L){if(L instanceof Array){L.forEach(D)}else{D(L)}}function y(){if(C){return}var L=B.getViewer();F=L.picking.primitive;J=L.pPicking.primitive;A=L.picking.trapSelectionMesh;L.setPicking({primitive:1,trapSelectionMesh:true});L.setPrePicking({primitive:1});C=n.onPreAdd(w);z=B.subscribe({event:"onRootAdded"},t);r=B.subscribe({event:"onRootRemoved"},t);t();if(H.axisSystem){s.activate()}}function q(){if(!C){return}var L=B.getViewer();L.setPicking({primitive:F,trapSelectionMesh:A});L.setPrePicking({primitive:J});n.unsubscribe(C);B.unsubscribe(z);B.unsubscribe(r);C=z=r=null;t();s.deactivate()}function u(L){if(typeof L==="boolean"&&L!==I){I=L;t()}}this.filter={activate:y,deactivate:q,display:u,filterPath:D,getFiltersState:function(){return{point:H.point,center:H.center,line:H.line,axisSystem:H.axisSystem,plane:H.plane,cylinder:H.cylinder,product:H.product}}};Object.freeze(this.filter);this.unreference=function(){q();if(E){E.clear()}s=E=B=null}}});var o=[];return p.singleton({init:function(){},getDefaultSelectionFilter:function(q){var s;if(q&&q.context&&q.context.name==="ENOPAD3DViewer"){o.some(function(t){if(t.context===q.context){s=t.mng.filter;return true}return false});if(!s){var r=new d({context:q.context});o.push({context:q.context,mng:r});s=r.filter}}return s},unreferenceDefaultSelectionFilter:function(q){if(q&&q.context){o.some(function(s,r){if(s.context===q.context){s.mng.unreference();o.splice(r,1);return true}return false})}}})});define("DS/CAT3DComposeCommands/CAT3DComposeExamineSelection",["UWA/Core","DS/ApplicationFrame/Command","DS/CoreEvents/ModelEvents","DS/Selection/HSOManager","DS/Selection/CSOManager","DS/VisuEvents/EventsManager","DS/Visualization/ThreeJS_DS","DS/CAT3DComposeUtils/CAT3DCompose3DAnimation","DS/PADUtils/PADContext","DS/ApplicationFrame/CommandsManager","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/Visualization/PathElement","DS/CAT3DComposeMoveManager/CATC3DMoveReferent","DS/CAT3DComposeMoveManager/CAT3DComposeMoveManager","DS/LevelSelector/LevelSelector","DS/CAT3DComposeCommands/CATC3DCommandsUtils","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","css!DS/CAT3DComposeCommands/CAT3DComposeCommands.css"],function(o,q,j,g,t,s,u,f,k,a,l,p,c,n,e,i,h){var d=Math.PI/4;function w(z){var x,y,B,A=z&&z.externalPath.length>1;for(x=0;A&&x<z.externalPath.length-1;++x){y=z.externalPath[x];B=z.externalPath[x+1];if(y.children.indexOf(B)<0){A=false}}return A}var r=function(){var B,C,x,y,z,A;this.store=function(F,D){B=C=x=y=z=A=undefined;var E=D?new u.Matrix4().extractRotation(D):null;B=F.getEyePosition();if(D){B.applyMatrix4(D)}C=F.getUpDirection();if(E){C.applyMatrix4(E)}x=F.getSightDirection();if(E){x.applyMatrix4(E)}y=F.getTargetDistance();z=F.getProjectionType();A=F.getAngle()};this.restore=function(F,D){if(B){var E=D?new u.Matrix4().extractRotation(D):null;F.moveTo({eyePosition:D?B.applyMatrix4(D):B,upDirection:E?C.applyMatrix4(E):C,sightDirection:E?x.applyMatrix4(E):x,distanceToTarget:y});F.setProjectionType(z);F.setAngle(A)}}};r.prototype={constructor:r};Object.freeze(r);var b,v,m=q.extend({init:function(W){this._parent(W,{mode:"shared",isAsynchronous:true});this.setRepeatMode(false);var B=this,T=k.get(),al=T.getViewer(),M=al.getSceneGraphOverrideSetManager(),D,J=n.getMoveManager({context:T}),A,V,ap,ai,O,ad=[],C,L,ae,af,ah,Z,X,ag=[],aa=[],ao={},F,E,P,ab=c.getMoveReferentManager({context:T}),K,ac,H,G=T.getCommandContext?T.getCommandContext():null;if(require("DS/PADUtils/PADSettingsMgt").getSetting("appModelerType")==="VPM"){require(["DS/CfgAuthoringContextUX/scripts/CfgAuthoringContext"],function(aq){K=aq})}if(!b){require(["DS/CAT3DComposeDirectMove/CAT3DComposeDirectMove"],function(aq){b=aq;if(B.isRunning()){b.activate({context:T})}})}if(!v){require(["DS/CATC3DNavigation/CATC3DNavigationContoller"],function(aq){v=aq})}this.canBeEnabled=function(){var aq=t.get();if(!B||!aq||!Array.isArray(aq)){return false}return aq.length>50?true:aq.some(function(at){if(!at||!at.pathElement||at.pathElement.externalPath.length<2||!h.isAModelPath(at.pathElement)){return false}var au=at.pathElement,ar=M.getCurrentVisibilityFree(au);if(typeof ar!=="boolean"){return false}return(ar!==true||M.getCurrentVisibility(au))&&(!au.getBoundingBox(null,al,"visibleSpace").isNaN()||!au.getBoundingBox(null,al,"invisibleSpace").isNaN())})};function S(){if(B.canBeEnabled()){if(!B.isEnabled()){B.enable()}}else{if(B.isEnabled()&&!B.isRunning()){B.disable()}}}function x(){if(ag.some(function(aq){return typeof M.getCurrentVisibility(aq.path)!=="boolean"})){B.end()}}function aj(at){if(at&&at.from&&at.from.some(function(au){return au.view.id===al.canvas.id})){var ar=at.gesture?at.gesture.getEvents()[0]:at.from[0];if(ar&&ar.event&&ar.event.button===0&&ar.event.buttons===0){var aq=al.pick(al.getMousePosition(ar.getCurrentPosition(al.canvas)),"mesh",false);if(!aq||!aq.path||aq.path.length===0){D=null;B.end()}}}}var am=function(){var ar=T.getFrameWindow().getViewpoint(),at=new u.Matrix4();var aq=ar.getUpDirection(),au=ar.getSightDirection();if(this.className.search("right")>=0){at.makeRotationAxis(aq,d)}else{if(this.className.search("left")>=0){at.makeRotationAxis(aq,-d)}else{if(this.className.search("top")>=0){at.makeRotationAxis(au.cross(aq),-d)}else{at.makeRotationAxis(au.cross(aq),d)}}}ag.forEach(function(av){av.matrixRotation=at});ap.addAnimation({animationType:"rotate",objectListToAnimate:ag.filter(function(av){return av.rotate}),callBackFct:function(){ag.forEach(function(av){av.matrixSource=av.override.getPosition()})}});ap.startAnimation()};var y=function(at,au,aw,ar){var av=[];if(at){var aq=at.getKey();if(aw.indexOf(aq)===-1&&(ar.getCurrentVisibilityFree(at)!==true||ar.getCurrentVisibility(at))){if(au.some(function(ax){return at.isAParentOf(ax)})){at.getChildrenPathes().forEach(function(ax){av=av.concat(y(ax,au,aw,ar))})}else{av.push(at)}}}return av};var an=(function(){var aq=new u.Color();return function ar(){aq.set(al.backgroundColor);var at=aq.getHSL().l*255;return at>120?"black":"white"}})();function N(av){if(!av){return}var au=ab.getMoveReferent(av);var at=au.getLastElement(true),ar;if(i.isPLMInstanceNode(at)){if(at&&at.children.length){au.addElement(at.children[0])}var aq={display:{type:"docked",marginW:10,marginH:10},background:al,disableKeyboard:true,displayWhileViewpointIsManipulated:true,uiFrame:T.getFrameWindow().getUIFrame(),getLevels:function(ax){var aA=i.getLevelSelectorLevels({pathElement:av,pathElementCurrent:au,onInfoCompleted:ax,context:T});if(aA){aA.selectColor="#ff821e";aA.selectOverColor="#ffb477";for(var ay=aA.levels.length-1,aw=false;ay>=0;--ay){var az=aA.levels[ay];if(!i.isPLMReferenceNode(az.pathElement.getLastElement(true))){az.selection="notSelectable"}else{if(!aw){aw=true;az.selection="notSelectable"}}}}return aA},onHover:function(aw){if(O){O.setColor(an(),false);O.setOpacity(0.05,false);O.setVisibility(true);O.setVisibilityFree(null)}ar=ai.createOverride({pathes:[au]});ar.setColor(16744448,true);ar.setOpacity(1,true);al.render();g.empty();g.add(aw)},onLeave:function(){if(O){O.setColor(null,null);O.setOpacity(null,null);O.setVisibility(false);O.setVisibilityFree(true)}ai.deleteOverride(ar);ar=null;al.render();g.empty();g.add(t.get())},onSelect:function(aw){if(aw&&aw.pathElement&&ab){ab.addMoveReferent(aw.pathElement);ai.deleteOverride(ar);ar=null;au=ab.getMoveReferent(av);at=au.getLastElement(true);if(at&&at.children.length){au.addElement(at.children[0])}ar=ai.createOverride({pathes:[au]});ar.setColor(16744448,true);ar.setOpacity(1,true);al.render()}}};e.createView(aq)}}function U(){var aw=Math.sqrt(2)*60;var av=T.getViewer(),at=av.SCREEN_WIDTH,ar=av.SCREEN_HEIGHT,ax=at/2,aq=ar/2;ao.main.setStyles({top:aq+"px",left:ax+"px"});ao.right.setStyle("left",ax-aw-10+"px");ao.left.setStyle("left",-1*ax+aw+10+"px");ao.top.setStyle("top",-1*aq+aw+10+"px");var au=T.getFrameWindow().getActionBar().elements.container.getAttribute("data-open")==="true"?73:30;ao.bottom.setStyle("top",aq-aw-au+"px")}function Q(aq){ap.forward();var ar;if(aq.key==="ArrowLeft"||aq.keyCode===37){ar=ao.left}else{if(aq.key==="ArrowUp"||aq.keyCode===38){ar=ao.top}else{if(aq.key==="ArrowRight"||aq.keyCode===39){ar=ao.right}else{if(aq.key==="ArrowDown"||aq.keyCode===40){ar=ao.bottom}}}}if(ar){ar.addClassName("active");am.call(ar)}}function I(aq){var ar;if(aq.key==="ArrowLeft"||aq.keyCode===37){ar=ao.left}else{if(aq.key==="ArrowUp"||aq.keyCode===38){ar=ao.top}else{if(aq.key==="ArrowRight"||aq.keyCode===39){ar=ao.right}else{if(aq.key==="ArrowDown"||aq.keyCode===40){ar=ao.bottom}}}}if(ar){ar.removeClassName("active")}}ac=function(aq){if(aq.key===" "||aq.key==="Spacebar"||aq.keyCode===32){if(aq.ctrlKey===false&&aq.altKey===false&&aq.shiftKey===false&&aq.metaKey===false){document.removeEventListener("keypress",ac);document.addEventListener("keyup",H);if(ag.length===0){B.begin()}else{B.end()}}}};H=function(aq){if(aq.key===" "||aq.key==="Spacebar"||aq.keyCode===32){document.removeEventListener("keyup",H);document.addEventListener("keypress",ac)}};function z(){if(ag.length){if(!F){F=new p(ag[0].path.externalPath)}if(!w(F)){F=P=null}else{P=new r();P.store(T.getFrameWindow().getViewpoint(),new u.Matrix4().getInverse(F.getWorldMatrix()))}}}function ak(at){B.deactivate();if(b&&!at){b.deactivate({context:T})}T.setRobotVisibility(A);if(K&&window.widget&&window.widget.getValue("changeControlActivation")==="true"){K.show()}var ar=a.getCommandCheckHeader("PAD3DLineLayoutHdr",G);if(ar&&V){ar.enable()}s.removeEvent(al.canvas,"onPrimaryPointerClick",aj);if(L){J.unsubscribe(L);L=undefined}if(!at&&C){J.unsubscribe(C);C=undefined}aa.forEach(function(au){T.unsubscribe(au)});aa=[];e.destroyView();if(ao.main){ao.main.hide()}if(ah){T.getViewer().unsubscribe(ah)}var aq=T.getFrameWindow().getActionBar();if(Z){aq.removeCallback(Z)}if(X){aq.removeCallback(X)}ah=Z=X=undefined;document.removeEventListener("keydown",Q);document.removeEventListener("keyup",I)}function Y(){z();ag=[];D=null;ak(true);var aq=T.getViewer();aq.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(ai);ai=O=null;aq.render();E.restore(T.getFrameWindow().getViewpoint())}function R(){B.activate();if(b&&v&&!v.isNavigationActivated({context:T})){b.activate({context:T})}T.getFrameWindow().getContextualUIManager().hideContextualMenus();A=T.isRobotVisible();T.setRobotVisibility(false);if(K){K.hide()}var ar=a.getCommandCheckHeader("PAD3DLineLayoutHdr",G);if(ar&&ar.isEnabled()){ar.disable();V=true}s.addEvent(al.canvas,"onPrimaryPointerClick",aj);L=J.subscribe("Move",Y);C=J.subscribe("MoveEnd",B.end.bind(B));["onRootRemoved","onRootDetached","onAuthoringTransactionEnd","onEndDelete"].forEach(function(at){aa.push(T.subscribe({event:at},x))});N(ag.length===1?ag[0].path:null);ao.main.show();U();ah=al.onViewerResize(U);var aq=T.getFrameWindow().getActionBar();Z=aq.onActionBarOpen(U);X=aq.onActionBarClose(U);document.addEventListener("keydown",Q);document.addEventListener("keyup",I)}this.execute=function(){E=new r();E.store(T.getFrameWindow().getViewpoint());T.getFrameWindow().getActionBar().close();ap=f.get3DComposeAnimationEngine({viewer:al});ag=[];ai=new l(T.getRootBagPath().externalPath[0]);M.pushSceneGraphOverrideSet(ai);var ax=[],at=[],au=new u.Box3(),aw=al.getVisibleSpace();D=[];t.get().forEach(function(aB){D.push(aB);var aF=new p(aB.pathElement.externalPath);while(aF&&!i.isPLMNode(aF.getLastElement(true))){aF=aF.getParentPath()}if(aF&&aF.externalPath.length&&(M.getCurrentVisibilityFree(aF)===false||typeof M.getCurrentVisibility(aF)==="boolean")){var aE=aF.getParentPath().getWorldMatrix();var aC=new u.Matrix4().getInverse(aE);var aA=aF.getMatrix();var az={path:aF,override:ai.createOverride({pathes:[aF]}),matrixSource:aA,matrixParent:aE,matrixParentInv:aC,rotate:true};var aD=aw?aF.getBoundingBox(null,al,"visibleSpace"):aF.getBoundingBox(null,al,"invisibleSpace");if(aD&&!aD.isNaN()){aD.applyMatrix4(aF.getWorldMatrix());au.union(aD)}else{az.rotate=false}ag.push(az);ax.push(aF);at.push(aF.getKey())}});if(ax.length>0){var ar=au.center();ag.forEach(function(az){az.centerRotation=new u.Vector3().copy(ar).applyMatrix4(az.matrixParentInv)});var aq=false;if(F){if(!F.isEqual(new p(ax[0].externalPath))||!w(F)){P=F=null}}if(!P){aq=true}var ay=y(T.getRootBagPath(),ax,at,M);O=ai.createOverride({pathes:ay});ap.addAnimation({animationType:"mask",objectListToAnimate:[{override:O}],callBackFct:function(){if(aq){T.getFrameWindow().getViewpoint().reframe(null,0,au.getBoundingSphere())}else{if(P){P.restore(T.getFrameWindow().getViewpoint(),F.getWorldMatrix());P=null}}}});ap.startAnimation();var av=function(aA){var aB=new o.createElement("div",{"class":aA}).inject(ao.main);aB.addEvents({click:am});new o.createElement("div",{"class":"background"}).inject(aB);var az=new o.createElement("div",{"class":"arrow"}).inject(aB);new o.createElement("div",{"class":"borderBottom"}).inject(az);new o.createElement("div",{"class":"borderRight"}).inject(az);ao[aA]=aB};ao.main=o.createElement("div",{id:"C3D-viewpoint"}).inject(T.getFrameWindow().getUIFrame());["left","top","right","bottom"].forEach(av);R();g.empty();t.empty()}else{B.end()}};this.endExecute=function(){z();ag=[];ak();if(ao.main){ao.main.destroy()}ao={};if(ai){var ar=T.getViewer();ar.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(ai);ai=O=null;ar.render();T.getFrameWindow().getActionBar().open();E.restore(T.getFrameWindow().getViewpoint())}if(D&&D.length&&t.get().length===0){g.empty();t.empty();var aq=D.filter(function(at){return typeof M.getCurrentVisibility(at.pathElement)==="boolean"});if(aq.length){g.add(D);t.add(D)}}};this.pauseExecute=function(){ak(false)};this.resumeExecute=function(){R(false);g.empty();t.empty();var ar=new u.Box3(),at=al.getVisibleSpace();ag.forEach(function(aw){var av=aw.path,au=at?av.getBoundingBox(null,al,"visibleSpace"):av.getBoundingBox(null,al,"invisibleSpace");if(au&&!au.isNaN()){au.applyMatrix4(av.getWorldMatrix());ar.union(au);aw.rotate=true}else{aw.rotate=false}});var aq=ar.center();ag.forEach(function(au){au.centerRotation=new u.Vector3().copy(aq).applyMatrix4(au.matrixParentInv)})};this.activate=function(){if(!B){return}B.enable();document.addEventListener("keypress",ac);if(ad.length===0){ad.push(t.onPostAdd(S));ad.push(t.onPostRemove(S))}if(!ae){ae=T.subscribe({event:"onShow"},S)}if(!af){af=T.subscribe({event:"onHide"},S)}S()};this.deactivate=function(){if(!B){return}document.removeEventListener("keypress",ac);document.removeEventListener("keyup",H);ad.forEach(function(aq){t.unsubscribe(aq)});T.unsubscribe(ae);T.unsubscribe(af);ad.length=0;ae=af=null;if(!this.isRunning()){this.disable()}};this.disable();this.getRequestedCommandMode=function(aq){return(aq.cmd==="Measure"||aq.cmd==="Section")?"shared":undefined};this.allowManipulation=function(aq){return(aq.object==="Measure"||aq.object==="Section")?true:undefined};this._destroy=function(){if(!B){return}B.deactivate();if(b){b.unreference({context:T})}Object.getPrototypeOf(this)._destroy.apply(this,arguments);B=T=al=M=null}}});return m});define("DS/CAT3DComposeCommands/CAT3DComposeWidgetDefaultCmd",["DS/ApplicationFrame/Command","DS/ApplicationFrame/CommandsManager","DS/CAT3DComposeBoxes/CAT3DComposeBoxController","DS/CATRelatedDataLauncher/CATRelatedDataController","DS/CAT3DComposeCommands/CAT3DComposeCtxMenuAgent","DS/PADUtils/PADContext","DS/CAT3DComposeMoveManager/CAT3DComposeMoveManager"],function(a,b,h,e,f,g,c){var i,d=a.extend({init:function(u){this._parent(u,{mode:"exclusive",isAsynchronous:true});this.setRepeatMode(false);var p=this,l=false,j=g.get(),s=j.getCommandContext?j.getCommandContext():null,q=new f({context:j}),t=h.getBoxController({context:j}),n=e.giveDataLauncherController({context:j}),o=c.getMoveManager({context:j});if(!i){require(["DS/CAT3DComposeDirectMove/CAT3DComposeDirectMove"],function(v){i=v;if(p.isRunning()){i.activate({context:j})}})}var k=[];function m(){if(k.length>0){return}k.push(o.subscribe("MoveBegin",function(){b.getCommand("CAT3DComposeExamineSelectionHdr",s).deactivate()}));k.push(o.subscribe("Move",function(){if(n){n.setVisibility(false)}}));k.push(o.subscribe("MoveEnd",function(){if(n){n.setVisibility(true)}b.getCommand("CAT3DComposeExamineSelectionHdr",s).activate()}))}function r(){k.forEach(function(v){o.unsubscribe(v)});k=[]}this.execute=function(){if(!j||l){return}q.activate();t.setActiveState(true);n.setActiveState(true);if(i){i.activate({context:j})}b.getCommand("CAT3DComposeExamineSelectionHdr",s).activate();m()};this.endExecute=function(){if(!j){return}q.deactivate();t.setActiveState(false);n.setActiveState(false);if(i){i.deactivate({context:j})}var v=b.getCommand("CAT3DComposeExamineSelectionHdr",s);if(v){v.deactivate()}r()};this.pauseExecute=function(){q.deactivate();t.setActiveState(false);n.setActiveState(false);if(i){i.deactivate({context:j})}b.getCommand("CAT3DComposeExamineSelectionHdr",s).deactivate();r()};this.resumeExecute=function(){q.activate();t.setActiveState(true);n.setActiveState(true);if(i){i.activate({context:j})}b.getCommand("CAT3DComposeExamineSelectionHdr",s).activate();m()};this.getRequestedCommandMode=function(v){return(v.cmd==="Measure"||v.cmd==="Section")?"shared":undefined};this.allowManipulation=function(v){return(v.object==="Measure"||v.object==="Section")?true:undefined};this._destroy=function(){r();if(i){i.unreference({context:j})}l=true;Object.getPrototypeOf(this)._destroy.apply(this,arguments);p=j=q=t=n=o=null}}});return d});
/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CAT3DComposeCommands/CATC3DPathElementAgentWithFilter",["DS/StateCommandEngine/PathElementAgent","DS/DMUMeasurable/DMUMeshRecognition","DS/DMUMeasurable/DMUGeometryEnums","DS/CATC3DGeometry/CATC3DEquivalentGeometry","DS/CATC3DGeometry/CATC3DGeometryEnums","DS/Web3DUXFilterBar/Web3DUXFilterBar","DS/CAT3DComposeCommands/CATC3DAxisSystemDisplayAgent","DS/WebappsUtils/WebappsUtils","DS/Selection/CSOManager","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","i18n!DS/CAT3DComposeCommands/assets/nls/CAT3DComposeCommands"],function(h,l,j,e,f,a,i,d,c,b,k){var m,g=h.extend({_frameWindow:null,_filterUI:null,_activeFilters:null,_filtersEnum:null,_postFilter:null,_axisAgent:null,geometryTypesEnum:{POINT:f.GeometryType.POINT,LINE:f.GeometryType.LINE,CIRCLE:f.GeometryType.CIRCLE,PLANE:f.GeometryType.PLANE,CYLINDER:f.GeometryType.CYLINDER,CONE:f.GeometryType.CONE,SPHERE:f.GeometryType.SPHERE,REFERENCE:10,AXISSYSTEM:f.GeometryType.AXISSYSTEM,AXISSYSTEMAXIS:f.GeometryType.AXISSYSTEMAXIS,AXISSYSTEMORIGIN:f.GeometryType.AXISSYSTEMORIGIN},init:function(n){var o,p=d.getWebappsAssetUrl("DMUBaseCommands","icons/32/"),q=d.getWebappsAssetUrl("CAT3DComposeCommands","icons/32/");this._preselection=true;m=this;if(!n.context){return null}this._frameWindow=n.context.getFrameWindow();this._axisAgent=new i({context:n.context});this._activeFilters=n.activeFilters||{POINT:1,CENTER:1,CIRCLE:1,AXISSYSTEM:1,AXISSYSTEMAXIS:1,AXISSYSTEMORIGIN:1,LINE:1,PLANE:1,CYLINDER:1,REFERENCE:1};this._postFilter=n.postFilter;this._filtersEnum={POINT:{type:"element",id:"POINT",nls:k.point,url:p+"I_Meas_Point.png",callback:function(){m.updateFilters()},bexclude:false,bstateActif:m._activeFilters.POINT},CENTER:{type:"element",id:"CENTER",nls:k.center,url:p+"I_Meas_PointCircle.png",callback:function(){m.updateFilters()},bexclude:false,bstateActif:m._activeFilters.CENTER},CIRCLE:{type:"element",id:"CIRCLE",nls:k.circle,url:p+"I_WebMarkerCircle.png",callback:function(){m.updateFilters()},bexclude:false,bstateActif:m._activeFilters.CIRCLE},AXISSYSTEM:{type:"element",id:"AXISSYSTEM",nls:k.axisSystem,url:q+"I_3DComposeAxisSystem.png",callback:function(){m._lastClicked="AXISSYSTEM";m.updateFilters()},bexclude:false,bstateActif:m._activeFilters.AXISSYSTEM},AXISSYSTEMAXIS:{type:"element",id:"AXISSYSTEMAXIS",nls:k.axisSystemAxis,url:q+"I_C3DAxisAxis.png",callback:function(){m._lastClicked="AXISSYSTEMAXIS";m.updateFilters()},bexclude:false,bstateActif:m._activeFilters.AXISSYSTEMAXIS},AXISSYSTEMORIGIN:{type:"element",id:"AXISSYSTEMORIGIN",nls:k.axisSystemOrigin,url:q+"I_C3DAxisOrigin.png",callback:function(){m._lastClicked="AXISSYSTEMORIGIN";m.updateFilters()},bexclude:false,bstateActif:m._activeFilters.AXISSYSTEMORIGIN},LINE:{type:"element",id:"LINE",nls:k.line,url:p+"I_Meas_Line.png",callback:function(){m.updateFilters()},bexclude:false,bstateActif:m._activeFilters.LINE},PLANE:{type:"element",id:"PLANE",nls:k.plane,url:p+"I_Meas_Plane.png",callback:function(){m.updateFilters()},bexclude:false,bstateActif:m._activeFilters.PLANE},CYLINDER:{type:"element",id:"CYLINDER",nls:k.cylinder,url:p+"I_Meas_Cylinder.png",callback:function(){m.updateFilters()},bexclude:false,bstateActif:(m._activeFilters.CYLINDER)},REFERENCE:{type:"element",id:"REFERENCE",nls:k.reference,url:p+"I_Meas_Product.png",callback:function(){m.updateFilters()},bexclude:true,bstateActif:m._activeFilters.REFERENCE}};o={agentId:"CAT3DComposeAssemblyPatternSelect",frameWindow:this._frameWindow,withPrevaluation:false,engWithPSOHSO:false,withPSO:true,withHSO:false,valuedFromCSO:false,saveToCSO:false,multiAcquisition:false,multiAcquisitionCtrl:false,pickingMode:"primHybrid",prePickingMode:"primHybrid",withUndoStep:false};o.prePickingFilter=o.pickingFilter=function(u){var w,x,t=false,s=0,r=e.getEquivalentGeometry({pathElement:u,axisSystemSub:!(m._activeFilters.AXISSYSTEM),axisSystemOrigin:!(m._activeFilters.AXISSYSTEMORIGIN)}),v=r?r.getType():null;if(m._activeFilters.AXISSYSTEM||m._activeFilters.AXISSYSTEMAXIS||m._activeFilters.AXISSYSTEMORIGIN){m._axisAgent.analyze({pathElement:u})}if((m._activeFilters.AXISSYSTEM===1&&v===m.geometryTypesEnum.AXISSYSTEM)||(m._activeFilters.AXISSYSTEMAXIS===1&&v===m.geometryTypesEnum.AXISSYSTEMAXIS)||(m._activeFilters.AXISSYSTEMORIGIN===1&&v===m.geometryTypesEnum.AXISSYSTEMORIGIN)){if(r){x=r.getPathElement();if(x){u.internalPath=x.internalPath;u.externalPath=x.externalPath}}t=true}if((!t)&&((m._activeFilters.POINT===1&&v===m.geometryTypesEnum.POINT)||(m._activeFilters.CENTER===1&&(v===m.geometryTypesEnum.CIRCLE||v===m.geometryTypesEnum.SPHERE))||(m._activeFilters.CIRCLE===1&&v===m.geometryTypesEnum.CIRCLE)||(m._activeFilters.LINE===1&&v===m.geometryTypesEnum.LINE)||(m._activeFilters.PLANE===1&&(v===m.geometryTypesEnum.PLANE||f.GeometryType.REFPLANE))||(m._activeFilters.CYLINDER===1&&(v===m.geometryTypesEnum.CYLINDER||v===m.geometryTypesEnum.CONE)))){t=true}if(!t&&m._activeFilters.REFERENCE===1){s=u.externalPath.length-1;for(;s>=0;--s){w=u.externalPath[s];if(w&&b.isReference(w)){u.setFromArray(u.externalPath.slice(0,(s+1)));t=true;break}}}if(t&&typeof m._postFilter==="function"){t=m._postFilter(u)}return t};this._parent(o);this.updateFilters();return null},activate:function(){var n=c.get();this._parent();if(this._preselection&&n.length>0){this._preselection=false;this.object3D=[];if(this.options.pickingFilter(n[0].pathElement)){this.object3D.push(n[0]);this._modelEvents.publish({event:this._agentId,data:this.object3D})}}this.updateFilters()},deactivate:function(){if(this._filterUI){this._filterUI.clear();this._filterUI.destroy();this._filterUI=null}m._axisAgent.deactivate();this._parent()},getSelType:function(o){var n=e.getEquivalentGeometry({pathElement:o,axisSystemSub:!(m._activeFilters.AXISSYSTEM)}),p=n?n.getType():null;if(!o||!o.externalPath||!b.isAModelPath(o)){return null}if(!p&&o.internalPath.length===0&&o.externalPath.some(function(q){return q&&b.isReference(q)})){return this.geometryTypesEnum.REFERENCE}if(typeof p==="number"){return p}return null},getActiveFilters:function(){return this._activeFilters},updateFilters:function(t,q){var s,r,p,o=false,n=[];if(typeof q!=="boolean"){q=true}if(t&&typeof t==="object"){m._activeFilters={};for(s in t){if(t.hasOwnProperty(s)&&m._filtersEnum.hasOwnProperty(s)){m._activeFilters[s]=t[s];if(m._activeFilters[s]!==1){m._activeFilters[s]=0}}}o=true}if(m._filterUI&&q){for(r in m._activeFilters){if(m._activeFilters.hasOwnProperty(r)){m._activeFilters[r]=(m._filterUI.getActiveState(r))?1:0}}}if(m._lastClicked&&m._activeFilters[m._lastClicked]===1){if(m._activeFilters.AXISSYSTEM){m._activeFilters.AXISSYSTEM=0}if(m._activeFilters.AXISSYSTEMAXIS){m._activeFilters.AXISSYSTEMAXIS=0}if(m._activeFilters.AXISSYSTEMORIGIN){m._activeFilters.AXISSYSTEMORIGIN=0}m._activeFilters[m._lastClicked]=1;o=true}m._lastClicked=null;if(m._activeFilters.AXISSYSTEM||m._activeFilters.AXISSYSTEMAXIS||m._activeFilters.AXISSYSTEMORIGIN){m._axisAgent.activate({type:"HSO",noPSOcb:true})}else{m._axisAgent.deactivate()}if(o&&m._filterUI){m._filterUI.clear();m._filterUI.destroy();m._filterUI=null}if(!m._filterUI){for(r in m._activeFilters){if(m._activeFilters.hasOwnProperty(r)&&m._filtersEnum.hasOwnProperty(r)){p=m._filtersEnum[r];p.bstateActif=m._activeFilters[r];n.push(p)}}m._filterUI=new a({body:m._frameWindow.getUIFrame(),frmWindow:m._frameWindow,Idpanel:"c3dPatternSelectionFilter",typeSeparator:"bubble",lJsonElement:n});m._filterUI.build();m._viewer.render()}}});return g});
/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CAT3DComposeCommands/CAT3DComposeAssemblyPatternCmd",["UWA/Core","DS/StateCommandEngine/StateCommand","DS/CoreEvents/Events","DS/CATWebUXComponents/CATWebUXNotifBar","DS/FlagPanel/FlagPanel","DS/FlagPanel/FlagPanelEnums","DS/FlagPanel/FlagPanelManager","DS/PADUtils/PADContext","DS/StateCommandEngine/PathElementAgent","DS/CATC3DGeometry/CATC3DEquivalentGeometry","DS/CAT3DComposeCommands/CATC3DPathElementAgentWithFilter","DS/Selection/HSOManager","DS/Visualization/ThreeJS_DS","DS/Visualization/Node3D","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/CAT3DComposeUtils/CATC3DUtils","DS/WebappsUtils/WebappsUtils","DS/SceneGraphNodes/AxisSystemNode","DS/CAT3DComposeUtils/CAT3DCompose3DAnimation","DS/Mesh/Mesh","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices","i18n!DS/CAT3DComposeCommands/assets/nls/CAT3DComposeAssemblyPatternCmd","css!DS/UIKIT/UIKIT"],function(s,t,i,p,a,r,u,m,j,e,v,g,w,k,n,q,b,l,f,c,h,d){var o=t.extend({init:function(ab){var H=this,K=this.beginExecute,T=this.endExecute,al=0,C,V,aw,W=m.get(),aq=W.getFrameWindow(),az=W.getViewer(),y=false,E,D,an,z=false,ao={},x={},F,aC,aj="NOPATTERN",G=true,X="LINEAR",ag="LINEAR",P={count:2,spacing:50,angle:30,reverse:false},O={count:2,spacing:50,angle:30,reverse:false},ay={NOPATTERN:{REFERENCE:1,POINT:0,CENTER:0,LINE:0,CYLINDER:0,AXISSYSTEM:0,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:0},NOPATTERN_LINEAR:{POINT:1,CENTER:1,LINE:1,CYLINDER:1,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:1},NOPATTERN_RECTANGULAR:{POINT:1,CENTER:1,LINE:1,CYLINDER:1,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:1},NOPATTERN_CIRCULAR:{POINT:1,CENTER:1,LINE:1,CYLINDER:1,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:1},NOPATTERN_USERDEFINED:{POINT:1,CENTER:1,AXISSYSTEM:1},LINEAR:{POINT:1,CENTER:1,LINE:1,CYLINDER:1,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:1},RECTANGULAR:{POINT:1,CENTER:1,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:1},CIRCULAR:{POINT:1,CENTER:1,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:1},USERDEFINED:{POINT:1,CENTER:1,AXISSYSTEM:1}},ad={NOPATTERN:["POINT","CENTER","LINE","CYLINDER","AXISSYSTEM","AXISSYSTEMORIGIN","AXISSYSTEMAXIS","REFERENCE"],NOPATTERN_LINEAR:["POINT","CENTER","LINE","CYLINDER","AXISSYSTEMORIGIN","AXISSYSTEMAXIS"],NOPATTERN_RECTANGULAR:["POINT","CENTER","LINE","CYLINDER","AXISSYSTEMORIGIN","AXISSYSTEMAXIS"],NOPATTERN_CIRCULAR:["POINT","CENTER","LINE","CYLINDER","AXISSYSTEMORIGIN","AXISSYSTEMAXIS"],NOPATTERN_USERDEFINED:["POINT","CENTER","AXISSYSTEM"],LINEAR:["POINT","CENTER","LINE","CYLINDER","AXISSYSTEMORIGIN","AXISSYSTEMAXIS"],RECTANGULAR:["POINT","CENTER","AXISSYSTEMORIGIN","AXISSYSTEMAXIS"],CIRCULAR:["POINT","CENTER","AXISSYSTEMORIGIN","AXISSYSTEMAXIS"],USERDEFINED:["POINT","CENTER","AXISSYSTEM"]},am=new u(az),M=function(aE){return(aE===F.geometryTypesEnum.POINT||aE===F.geometryTypesEnum.CIRCLE||aE===F.geometryTypesEnum.AXISSYSTEM||aE===F.geometryTypesEnum.AXISSYSTEMORIGIN)},J=function(){var aE={version:3,reuse:G,radioPattern:ag,direction1:P,direction2:O,filters:ay};aE.reuse=true;localStorage.setItem("CAT3DComposeAssemblyPatternCmd",JSON.stringify(aE))},S=function(){var aE=JSON.parse(localStorage.getItem("CAT3DComposeAssemblyPatternCmd"));if(aE&&aE.version===3){G=(typeof aE.reuse==="object")?aE.reuse:G;ag=(typeof aE.radioPattern==="object")?aE.radioPattern:ag;P=(typeof aE.direction1==="object")?aE.direction1:P;O=(typeof aE.direction2==="object")?aE.direction2:O;ay=(typeof aE.filters==="object")?aE.filters:ay}},L=function(aH){var aE,aG,aF={bReference:Boolean(z),bOrigin:Boolean(y),typesCount:{}};for(aE in F.geometryTypesEnum){if(F.geometryTypesEnum.hasOwnProperty(aE)){aF.typesCount[F.geometryTypesEnum[aE]]=0}}for(aE in ao){if(ao.hasOwnProperty(aE)&&aE!==y&&aE!==z){aF.typesCount[ao[aE].type]++}}if(F.object3D[0]&&!ao[F.object3D[0].pathElement.getKey()]){aG=F.getSelType(F.object3D[0].pathElement);if(!z&&aG===F.geometryTypesEnum.REFERENCE){aF.bReference=true}else{if(!y&&M(aG)){aF.bOrigin=true}else{if(y||aH===aC.USERDEFINED.id||!M(aG)){aF.typesCount[aG]++}}}}return aF},N=function(aI,aF,aE,aH){var aG;aE=(typeof aE==="undefined")?true:aE;aH=(typeof aH==="undefined")?true:aH;am.removeFlag(V[aI]);V[aI].destroy();delete V[aI];if(aI!==z&&aH){delete ao[aI]}if(aI===E){E=null;if(D){P.count=O.count;P.spacing=O.spacing;O.reverse=O.reverse;V[D].destroy();delete V[D];E=D;D=null}}else{if(aI===D){D=null}else{if(aI===y){if(aF&&aF==="NOPATTERN"){aG="NOPATTERN";if(z){aG=aG+"_"+ag}ay[aG]=F.getActiveFilters();aj=null}az.removeNode(an);y=null}}}F.object3D[0]=null;if(aE){i.publish({event:"C3D_UNSELECT_EVT"})}},I=function(aE){var aL,aH,aG,aM,aI,aF,aJ=0,aK=L(aE.stateID);if(!aK||!aK.bReference){return false}aJ=0;aM=Object.keys(aK.typesCount);aI=aM.length;aG=aE.validTypes.length;for(aL=0;aL<aI;++aL){if(aK.typesCount[aM[aL]]>0){aF=false;for(aH=0;aH<aG;++aH){if(aM[aL]===aE.validTypes[aH].type.toString()&&!(aE.validTypes[aH].maxcount&&aK.typesCount[aM[aL]]>aE.validTypes[aH].maxcount)){aJ+=aK.typesCount[aM[aL]];aF=true;break}}if(!aF){return false}}}if(aE.stateID===aC.USERDEFINED.id&&aK.bOrigin){aJ++}if(aE.stateID===aC.CIRCULAR.id&&aK.bOrigin&&aJ===0){aJ++}if((aE.validSelCount>-1&&aJ===aE.validSelCount)||(aE.validSelCount===-1&&aJ>0)){return true}return false},ax=function(aG,aE,aF){var aH=new w.Vector3();if(aG.type===F.geometryTypesEnum.POINT){aH.subVectors(aG.canonicGeom.getPoint(),aE.position)}else{if(aG.type===F.geometryTypesEnum.LINE){aH.subVectors(aG.canonicGeom.getEndPoints().endPoint,aG.canonicGeom.getEndPoints().startPoint)}else{if(aG.type===F.geometryTypesEnum.CIRCLE){aH.subVectors(aG.canonicGeom.getCenter(),aE.position)}else{if(aG.type===F.geometryTypesEnum.CYLINDER){aH.subVectors(aG.canonicGeom.getEndPoints().endPoint,aG.canonicGeom.getEndPoints().startPoint)}else{if(aG.type===F.geometryTypesEnum.AXISSYSTEM||aG.type===F.geometryTypesEnum.AXISSYSTEMORIGIN){aH.subVectors(aG.position,aE.position)}else{if(aG.type===F.geometryTypesEnum.AXISSYSTEMAXIS){aH=aG.canonicGeom.getDirection()}}}}}}if(aF){return aH.normalize()}return aH},at=function(aG){var aH,aI,aF,aE;if(!aG.getParentPath){return null}aI=aG.getParentPath().clone();aE=aI.getLength();for(aF=(aE-1);aF>=0;--aF){aH=aI.externalPath[aF];if(aH&&h.isReference(aH)){aI.setFromArray(aI.externalPath.slice(0,(aF+1)));return aI}}return null},U=function(){var aF,aE=[];for(aF in aC){if((aC[aF].conditions&&I(aC[aF].conditions))||(z&&y&&Object.keys(ao).length===2&&["LINEAR","CIRCULAR","USERDEFINED"].indexOf(aF)!==-1)){aE.push(aF)}}if(aE.length===0){aE=["LINEAR","CIRCULAR","USERDEFINED"]}return aE},Z=function(aE){if(x.hasOwnProperty(aE)){x[aE].pRefParent.getLastElement().removeChild(x[aE].node);delete x[aE];al--}az.render()},ap=function(){var aE;if(x){for(aE in x){if(x.hasOwnProperty(aE)){Z(aE)}}}},ae=function(aF){var aE=f.get3DComposeAnimationEngine({viewer:az}),aG=new l({headLength:10,arrowLength:50,arrowWidth:2,colors:{colorX:new c.Color(0.25,0.63,0.85,1),colorY:new c.Color(0.25,0.63,0.85,1),colorZ:new c.Color(0.25,0.63,0.85,1)},head:l.types.ARROW});aG.exludeFromBounding(true);aG.setVisibilityInTree(false);aG.setPickable(c.NODRAWHL);aG.setMatrix(aF);az.addNode(aG);aE.axisSystemVisibility({objectListToAnimate:[aG],visibility:true,pickability:false});aE.startAnimation();return aG},af=function(aL,aK,aH){var aJ,aI,aG,aE,aF;aG=aK.clone();aF=aK.getWorldMatrix();aF.getInverse(aF);aJ=new w.Matrix4();aJ.multiplyMatrices(aF,aH);al++;aI=new k("PreviewNode"+al);aI.setMatrix(aJ);aI.addChild(aL.pathElement.getLastElement());aK.getLastElement().addChild(aI);aG.addElement(aI);aE=aG.getKey();x[aE]={node:aI,activated:true,pathElement:aG,pRefParent:aK};return aE},aD=function(aG,aF,aE){var aH={position:new w.Matrix4().setPosition(ao[aG].position),iconUrl:ao[aG].iconUrl?ao[aG].iconUrl:"",closeButton:true,closeCB:function(){N(aG,aE)}};V[aG]=new a(az,aH);if(aF){V[aG].setOffset(aF)}am.addFlag(V[aG])},B=function(aF,aI,aE,aG,aH){var aJ={position:ao[aI].clickPos?new w.Matrix4().setPosition(ao[aI].clickPos):new w.Matrix4(),label:aE,iconUrl:ao[aI].iconUrl?ao[aI].iconUrl:"",closeButton:true,closeCB:function(){N(aI,aF)},dialogs:[{type:r.fieldsTypeEnum.INTEGER,value:aG.count,suffix:d.SUFFIX_INSTANCES,fnCallback:function(aK){aG.count=parseInt(aK);i.publish({event:"C3D_PARAMETERS_CHG"})}},{type:r.fieldsTypeEnum.DOUBLE,prefix:d.PREFIX_SPACING,value:(aF==="CIRCULAR")?aG.angle:aG.spacing,suffix:(aF==="CIRCULAR")?"":"mm",fnCallback:function(aK){if(aF==="CIRCULAR"){aG.angle=parseInt(aK)}else{aG.spacing=parseInt(aK)}i.publish({event:"C3D_PARAMETERS_CHG"})}},{type:r.fieldsTypeEnum.BOOLEAN,iconUrl:b.getWebappsAssetUrl("CAT3DComposeCommands","icons/32/")+"I_C3DReverseDirection.png",value:aG.reverse,fnCallback:function(aK){aG.reverse=aK;i.publish({event:"C3D_PARAMETERS_CHG"})}}]};V[aI]=new a(az,aJ);if(aH){V[aI].setOffset(aH)}am.addFlag(V[aI])},au=function(aL){var aI,aN,aK,aM,aG,aH,aF,aE,aO,aP=(aL==="NOPATTERN")?ag:aL,aJ={};for(aN in V){if(V.hasOwnProperty(aN)){aJ[aN]=V[aN].getOffset();am.removeFlag(V[aN]);V[aN].destroy();delete V[aN]}}if(an){az.removeNode(an)}if(z){aH=U();aI=[{value:aP,iconUrl:aC[aP].iconUrl,label:d["LABEL_"+aP],isdefault:true}];aG=aH.length||0;for(aM=0;aM<aG;++aM){if(aH[aM]!==aP){aI.push({value:aH[aM],iconUrl:aC[aH[aM]].iconUrl,label:d["LABEL_"+aH[aM]]})}}aF={position:ao[z].clickPos?new w.Matrix4().setPosition(ao[z].clickPos):new w.Matrix4().setPosition(ao[z].position),label:d.FLAG_REF_LABEL,iconUrl:ao[z].iconUrl?ao[z].iconUrl:"",closeButton:true,closeCB:function(){am.removeFlag(V[z+"ref"]);V[z+"ref"].destroy();delete V[z+"ref"];if(z!==y){delete ao[z]}if(aL==="NOPATTERN"){aE="NOPATTERN";if(z){aE=aE+"_"+ag}ay[aE]=F.getActiveFilters();aj=null}z=null;F.object3D[0]=null;i.publish({event:"C3D_UNSELECT_EVT"})},dialogs:[{type:r.fieldsTypeEnum.RADIO,radios:aI,fnCallback:function(aQ){X=ag;ag=aQ;au(ag);i.publish({event:"C3D_PATTERN_CHG"})}},{type:r.fieldsTypeEnum.BOOLEAN,iconUrl:b.getWebappsAssetUrl("CAT3DComposeCommands","icons/32/")+"I_C3DReuse.png",value:G}]};V[z+"ref"]=new a(az,aF);V[z+"ref"].setOffset(aJ[z+"ref"]);aO=V[z+"ref"].flagPanel.getElement().getElementsByClassName("WUXFlagPanelBtnDialog")[1];aO.style.width=0;aO.style.border=0;aO.style.padding=0;aO.style.margin=0;am.addFlag(V[z+"ref"])}if(z&&V[z+"ref"]&&z!==y){V[z+"ref"].flagPanel.getElement().getElementsByClassName("WUXFlagPanelBtnDialog")[1].removeClassName("hidden")}else{if(z&&V[z+"ref"]){V[z+"ref"].flagPanel.getElement().getElementsByClassName("WUXFlagPanelBtnDialog")[1].addClassName("hidden")}}if(y&&!(aL===aC.USERDEFINED.id||aP===aC.USERDEFINED.id)){an=ae(ao[y].worldMatrix.clone().setPosition(ao[y].position));if(aL===aC.CIRCULAR.id&&!E&&!D){B(aL,y,d.LABEL_AXIS,P,aJ[y])}else{aF={position:new w.Matrix4().setPosition(ao[y].position),label:d.FLAG_ORIGIN_LABEL,iconUrl:ao[y].iconUrl?ao[y].iconUrl:"",closeButton:true,closeCB:function(){N(y,aL)}};if(y===z){aF.offset=new w.Vector2(0,50)}V[y]=new a(az,aF);V[y].setOffset(aJ[y]);am.addFlag(V[y])}}if(aL===aC.USERDEFINED.id||aP===aC.USERDEFINED.id){for(aK in ao){if(ao.hasOwnProperty(aK)&&aK!==z){aD(aK,aJ[aK],aL)}}}else{if(E){B(aL,E,d.LABEL_DIR1,P,aJ[E])}if(D){B(aL,D,d.LABEL_DIR2,O,aJ[D])}}},Y=function(aS){var aX,aQ,aZ,aN,a0,aF,aG,aE,aR,aT,a1,aI,aJ,aP,aV,aO,aU,aW,aH,aY,aL,aK=[],aM=az.getSceneGraphOverrideSetManager();if(aw){aM.removeSceneGraphOverrideSet(aw);aw=null}aw=new n(W.getRootBagPath().externalPath[0]);for(aX in x){if(x.hasOwnProperty(aX)){Z(aX)}}if(z){aK.push(ao[z].pathElement);aZ=(y&&ao.hasOwnProperty(y))?ao[y]:null;if(aS!=="USERDEFINED"&&ag!=="USERDEFINED"){if(y){aG=y}if(E){aP=ax(ao[E],aZ,true);aG=E;aW=aP.clone().setLength(((P.reverse)?-1:1)*P.spacing);aV=new w.Matrix4().makeTranslation(aW.x,aW.y,aW.z)}if(D){aO=ax(ao[D],aZ,true);aW=aO.clone().setLength(((O.reverse)?-1:1)*O.spacing);aU=new w.Matrix4().makeTranslation(aW.x,aW.y,aW.z)}}aJ=ao[z];a1=at(aJ.pathElement);aI=a1.getWorldMatrix();aI.getInverse(aI);aH=(G)?aJ.worldMatrix.clone().setPosition(aJ.position):aJ.worldMatrix.clone().setPosition(aZ.position);switch(aS){case aC.LINEAR.id:if(E){for(aN=0;aN<P.count;++aN){if(aN===0&&!G){}else{if(aN>0){aH=aV.clone().multiply(aH);aY=af(aJ,a1,aH);aK.push(x[aY].pathElement)}}}}break;case aC.RECTANGULAR.id:if(E&&D){aT=aH.clone();for(aR=0;aR<O.count;++aR){if(aR>0){aT=aU.clone().multiply(aT)}aH=aT.clone();for(aN=0;aN<P.count;++aN){if(aN===0&&(aR>0||!G)){aY=af(aJ,a1,aH);aK.push(x[aY].pathElement)}else{if(aN>0){aH=aV.clone().multiply(aH);aY=af(aJ,a1,aH);aK.push(x[aY].pathElement)}}}}}break;case aC.CIRCULAR.id:if(aG){aF=(aP)?aP:ao[aG].canonicGeom.getNormal().clone();aQ=new w.Matrix4().makeRotationAxis(aF,((P.reverse)?-1:1)*P.angle*Math.PI/180);aE=new w.Matrix4().setPosition(ao[aG].position);for(aN=0;aN<P.count;++aN){if(aN===0&&!G){}else{if(aN>0){aH=aE.clone().multiply(aQ.clone().multiply(new w.Matrix4().getInverse(aE).multiply(aH)));aY=af(aJ,a1,aH);aK.push(x[aY].pathElement)}}}}break;case aC.USERDEFINED.id:for(a0 in ao){if(ao.hasOwnProperty(a0)&&a0!==z){if(ao[a0].type===F.geometryTypesEnum.AXISSYSTEM){aH=ao[a0].worldMatrix.clone()}else{aH=aJ.worldMatrix.clone().setPosition(ao[a0].position)}aY=af(aJ,a1,aH);aK.push(x[aY].pathElement)}}break;default:}}if(aw){aL=aw.createOverride({pathes:aK});if(aL){aL.setOpacity(0.5);aL.setPickability("IGNORED")}aM.pushSceneGraphOverrideSet(aw)}},R=function(){var aE;g.empty();for(aE in ao){if(ao.hasOwnProperty(aE)){g.add(ao[aE])}}for(aE in x){if(x.hasOwnProperty(aE)){g.add(x[aE])}}},aB=function(aF){var aE=null,aG=b.getWebappsAssetUrl("DMUBaseCommands","icons/32/"),aH=b.getWebappsAssetUrl("CAT3DComposeCommands","icons/32/");switch(aF){case F.geometryTypesEnum.POINT:aE=aG+"I_Meas_Point.png";break;case F.geometryTypesEnum.CENTER:aE=aG+"I_Meas_PointCircle.png";break;case F.geometryTypesEnum.CIRCLE:aE=aG+"I_Meas_PointCircle.png";break;case F.geometryTypesEnum.AXISSYSTEM:aE=aH+"I_3DComposeAxisSystem.png";break;case F.geometryTypesEnum.AXISSYSTEMORIGIN:aE=aH+"I_C3DAxisOrigin.png";break;case F.geometryTypesEnum.AXISSYSTEMAXIS:aE=aH+"I_C3DAxisAxis.png";break;case F.geometryTypesEnum.PLANE:aE=aG+"I_Meas_Plane.png";break;case F.geometryTypesEnum.CYLINDER:aE=aG+"I_Meas_Cylinder.png";break;case F.geometryTypesEnum.LINE:aE=aG+"I_Meas_Line.png";break;default:}return aE},aA=function(aE){var aF=h.getNodeID(ao[aE].pathElement.getLastElement(true));z=aE;ao[aE].iconUrl="";W.getController().getAttributes({ids:[aF],attributes:["type_icon_url"],callbacks:{onComplete:function(aG){ao[aE].iconUrl=aG[aF]?aG[aF].type_icon_url:"";if(V[aE+"ref"]){V[aE+"ref"].setIcon(ao[aE].iconUrl)}},onFailure:function(){}}})},aa=function(aE){y=aE},Q=function(aF){var aE=null,aG=aF.getType();if(typeof aG==="undefined"){return null}switch(aG){case F.geometryTypesEnum.POINT:aE=aF.getPoint();break;case F.geometryTypesEnum.LINE:case F.geometryTypesEnum.CYLINDER:aE=aF.getEndPoints().startPoint;break;case F.geometryTypesEnum.CIRCLE:case F.geometryTypesEnum.CENTER:aE=aF.getCenter();break;default:}return aE},A=function(aJ){var aG,aF,aE,aI=aJ,aH;if(aj){ay[aj]=F.getActiveFilters()}if(z&&aI===aC.NOPATTERN.id){aI=aI+"_"+ag}aH=ay[aI];if(z&&aH.REFERENCE){delete aH.REFERENCE}aF=0;aE=ad[aI].length;for(aF;aF<aE;++aF){if(!aH.hasOwnProperty(ad[aI][aF])){aH[ad[aI][aF]]=0}}for(aG in aH){if(aH.hasOwnProperty(aG)&&ad[aI].indexOf(aG)===-1){delete aH[aG]}}if(aJ===aC.CIRCULAR.id&&E){aH={}}F.updateFilters(aH,false)},ai=function(aG){var aH=Object.keys(ao),aF,aE=aH.length;if(!y){if(D&&M(ao[D].type)){N(D,aG,false,false)}if(E&&M(ao[E].type)){N(E,aG,false,false)}}for(aF=0;aF<aE;++aF){if(M(ao[aH[aF]].type)){if(!y&&aH[aF]!==E&&aH[aF]!==D){aa(aH[aF]);continue}if(!E&&aH[aF]!==y&&aH[aF]!==D){E=aH[aF];continue}if(!D&&aH[aF]!==E&&aH[aF]!==y){D=aH[aF];continue}}}au(aG)},av=function(aG,aI,aL){var aF=null,aM,aJ=new w.Vector3(),aH,aE,aK;if(F.object3D[0]&&F.object3D[0].pathElement){aF=F.object3D[0].pathElement}if(aF&&!ao[aF.getKey()]){aM=e.getEquivalentGeometry({pathElement:aF,axisSystemSub:true});aE=aM?aM.getType():F.geometryTypesEnum.REFERENCE;aK=aF.getWorldMatrix();aH=aF.getKey();if(aE===F.geometryTypesEnum.REFERENCE||aE===F.geometryTypesEnum.AXISSYSTEM||aE===F.geometryTypesEnum.AXISSYSTEMAXIS){aJ.getPositionFromMatrix(aK)}else{aJ=Q(aM)}ao[aH]={pathElement:aF,type:aE,worldMatrix:aK,position:aJ,clickPos:F.object3D[0].position,canonicGeom:aM,iconUrl:aB(aE)};if(aE===F.geometryTypesEnum.AXISSYSTEM){ao[aH].clickPos=aJ}if(!z&&aE===F.geometryTypesEnum.REFERENCE){aA(aH)}else{if(!y&&aG.id!==aC.USERDEFINED.id&&M(aE)){aa(aH)}else{if(aH!==y&&aH!==z){if(!E){E=aH;if(y&&(aE===F.geometryTypesEnum.POINT||aE===F.geometryTypesEnum.CIRCLE||aE===F.geometryTypesEnum.AXISSYSTEMORIGIN)){P.spacing=Math.round(ao[y].position.distanceTo(aJ)*1000)/1000}}else{if(!D){D=aH;if(y&&(aE===F.geometryTypesEnum.POINT||aE===F.geometryTypesEnum.CIRCLE||aE===F.geometryTypesEnum.AXISSYSTEM)){O.spacing=Math.round(ao[y].position.distanceTo(aJ)*1000)/1000}}}}}}F.object3D=[]}au(aG.id);A(aG.id,aj);J();Y(aG.id);if(aG.id!==aC.NOPATTERN.id){C.removeAll(function(){C.add({message:d["LABEL_"+aG.id],closable:false,buttons:[{label:d.SAVEBTN,className:"primary",onClick:function(){i.publish({event:"C3D_SAVE_CLICK"})},doClose:true},{label:d.CANCELBTN,className:"default",onClick:function(){i.publish({event:"C3D_CANCEL_CLICK"})},doClose:true}]})})}else{C.removeAll(function(){var aN=0;if(z){aN=1}C.add({message:d["LABEL_"+aG.id+"_"+aN],closable:false,buttons:[{label:d.CANCELBTN,className:"default",onClick:function(){i.publish({event:"C3D_CANCEL_CLICK"})},doClose:true}]})})}aL();R()},ar=function(aG,aE,aF){Y(aG.id);A(aG.id,aj);J();aF();R()},ak=function(){if(z){return true}else{C.add({message:d.NOREFERROR,msgType:"warning",autoHide:true,closable:true})}return false},ah=function(aE){var aJ,aI,aG,aH=az,aF={context:W,parentID:null,children:[],onCompleted:function(aK){var aL=aK.length||0;if(aL===0){aE();return}aK.forEach(function(aM){aL--;if(!aM.instID&&aM.message){C.add({message:aM.message,msgType:"error",autoHide:true,closable:true})}if(aL===0){aE()}})}};if(x&&ao){aI=ao[z];aG=h.getNodeID(aI.pathElement.getLastElement());aF.parentID=h.getNodeID(at(aI.pathElement).getLastElement());for(aJ in x){if(x.hasOwnProperty(aJ)&&x[aJ].activated){aF.children.push({id:aG,matrix:x[aJ].pathElement.getMatrix(aH)})}}q.insertExisting(aF)}},ac=function(aE){aE()};this.beginExecute=function(){y=null;z=null;E=null;D=null;ao={};C=new p().inject(aq.getUIFrame());V=[];if(g.isEmpty()){C.add({message:d.LABEL_NOPATTERN_0,closable:false,buttons:[{label:d.CANCELBTN,className:"default",onClick:function(){i.publish({event:"C3D_CANCEL_CLICK"})},doClose:true}]})}az.setDefaultPicking(false);K.call(H)};this.endExecute=function(){var aE;J();g.empty();y=null;z=null;E=null;D=null;if(x){ap()}if(aw){az.getSceneGraphOverrideSetManager().removeSceneGraphOverrideSet(aw);aw=null}az.setDefaultPicking(true);if(F){F.deactivate()}ap();if(C){C.destroy();C=null}if(an){az.removeNode(an)}for(aE in V){if(V.hasOwnProperty(aE)){am.removeFlag(V[aE]);V[aE].destroy();delete V[aE]}}V.length=0;T.call(H)};this.buildGraph=function(){var aK=b.getWebappsAssetUrl("CAT3DComposeCommands","icons/32/"),aE=this.createInitialState("NoPatternState"),aF=this.createState("LinearState"),aH=this.createState("RectangularState"),aI=this.createState("CircularState"),aL=this.createState("UserDefineState"),aJ=this.getFinalState(),aG=ay.NOPATTERN;if(!z){aG={POINT:0,CENTER:0,LINE:0,CYLINDER:0,AXISSYSTEM:0,AXISSYSTEMORIGIN:0,AXISSYSTEMAXIS:0,REFERENCE:1}}F=new v({context:W,activeFilters:aG,postFilter:function(aN){var aM=h.getRoots(W);if(!h.isAModelPath(aN)){return false}if(Array.isArray(aM)&&aM.indexOf(aN.getLastElement())!==-1){return false}return true}});aC={NOPATTERN:{id:"NOPATTERN",iconUrl:"",chkConditions:function(){return true},actions:function(aM){av(aC.NOPATTERN,"NoPattern State",aM)}},LINEAR:{id:"LINEAR",iconUrl:aK+"I_C3DRectangularPattern.png",chkConditions:function(){if(ag!=="LINEAR"&&ag!=="RECTANGULAR"){return false}return I(aC.LINEAR.conditions)},conditions:{stateID:"LINEAR",debugTxt:"Linear pattern condition",validSelCount:1,validTypes:[{type:F.geometryTypesEnum.POINT},{type:F.geometryTypesEnum.CIRCLE},{type:F.geometryTypesEnum.LINE},{type:F.geometryTypesEnum.AXISSYSTEM},{type:F.geometryTypesEnum.AXISSYSTEMAXIS},{type:F.geometryTypesEnum.CYLINDER}]},actions:function(aM){av(aC.LINEAR,"Linear State",aM)}},RECTANGULAR:{id:"RECTANGULAR",iconUrl:aK+"I_C3DRectangularPattern.png",chkConditions:function(){if((ag!=="LINEAR"&&ag!=="RECTANGULAR")||!E){return false}return I(aC.RECTANGULAR.conditions)},conditions:{stateID:"RECTANGULAR",debugTxt:"Rectangular pattern condition",validSelCount:2,validTypes:[{type:F.geometryTypesEnum.POINT},{type:F.geometryTypesEnum.CIRCLE},{type:F.geometryTypesEnum.LINE},{type:F.geometryTypesEnum.CYLINDER},{type:F.geometryTypesEnum.AXISSYSTEM},{type:F.geometryTypesEnum.AXISSYSTEMAXIS}]},actions:function(aM){av(aC.RECTANGULAR,"Rectangular State",aM);az.setDefaultPicking(false)}},CIRCULAR:{id:"CIRCULAR",iconUrl:aK+"I_C3DCircularPattern.png",chkConditions:function(){if(ag!=="CIRCULAR"){return false}return I(aC.CIRCULAR.conditions)},conditions:{stateID:"CIRCULAR",debugTxt:"Circular pattern condition",validSelCount:1,validTypes:[{type:F.geometryTypesEnum.POINT},{type:F.geometryTypesEnum.CIRCLE},{type:F.geometryTypesEnum.CYLINDER},{type:F.geometryTypesEnum.LINE},{type:F.geometryTypesEnum.AXISSYSTEM},{type:F.geometryTypesEnum.AXISSYSTEMAXIS}]},actions:function(aM){av(aC.CIRCULAR,"Circular State",aM)}},USERDEFINED:{id:"USERDEFINED",iconUrl:aK+"I_C3DUserPattern.png",chkConditions:function(){if(ag!=="USERDEFINED"){return false}return I(aC.USERDEFINED.conditions)},conditions:{stateID:"USERDEFINED",debugTxt:"User defined pattern condition",validSelCount:-1,validTypes:[{type:F.geometryTypesEnum.POINT},{type:F.geometryTypesEnum.CIRCLE},{type:F.geometryTypesEnum.AXISSYSTEM}]},actions:function(aM){av(aC.USERDEFINED,"User defined State",aM)}}};this.addTransition({iInitialState:aE,iFinalState:aF,iEvent:F,iCondition:function(){return aC.LINEAR.chkConditions()},iAction:function(aM){aj="NOPATTERN_LINEAR";aC.LINEAR.actions(aM)},iSender:H});this.addTransition({iInitialState:aE,iFinalState:aH,iEvent:F,iCondition:function(){return aC.RECTANGULAR.chkConditions()},iAction:function(aM){aj="NOPATTERN_LINEAR";aC.RECTANGULAR.actions(aM)},iSender:H});this.addTransition({iInitialState:aE,iFinalState:aI,iEvent:F,iCondition:function(){return aC.CIRCULAR.chkConditions()},iAction:function(aM){aj="NOPATTERN_CIRCULAR";aC.CIRCULAR.actions(aM)},iSender:H});this.addTransition({iInitialState:aE,iFinalState:aL,iEvent:F,iCondition:function(){return aC.USERDEFINED.chkConditions()},iAction:function(aM){aj="NOPATTERN_USERDEFINED";aC.USERDEFINED.actions(aM)},iSender:H});this.addTransition({iInitialState:aE,iFinalState:aJ,iEvent:"C3D_CANCEL_CLICK",iAction:function(aM){aj="NOPATTERN";if(z){aj=aj+"_"+ag}ac(aM)}});this.addTransition({iInitialState:aE,iFinalState:aE,iEvent:F,iCondition:function(){return aC.NOPATTERN.chkConditions()},iAction:function(aM){aj="NOPATTERN";if(z){aj=aj+"_"+ag}aC.NOPATTERN.actions(aM)},iSender:H});this.addTransition({iInitialState:aF,iFinalState:aF,iEvent:F,iCondition:function(){return aC.LINEAR.chkConditions()},iAction:function(aM){aj="LINEAR";aC.LINEAR.actions(aM)},iSender:H});this.addTransition({iInitialState:aF,iFinalState:aF,iEvent:"C3D_PARAMETERS_CHG",iAction:function(aM){aj="LINEAR";ar(aC.LINEAR,"linearState to linearState",aM)}});this.addTransition({iInitialState:aF,iFinalState:aH,iEvent:F,iCondition:function(){return aC.RECTANGULAR.chkConditions()},iAction:function(aM){aj="LINEAR";aC.RECTANGULAR.actions(aM)},iSender:H});this.addTransition({iInitialState:aF,iFinalState:aJ,iEvent:"C3D_CANCEL_CLICK",iAction:function(aM){aj="LINEAR";ac(aM)}});this.addTransition({iInitialState:aF,iFinalState:aJ,iEvent:"C3D_SAVE_CLICK",iCondition:function(){return ak()},iAction:function(aM){aj="LINEAR";ah(aM)}});this.addTransition({iInitialState:aH,iFinalState:aH,iEvent:"C3D_PARAMETERS_CHG",iAction:function(aM){aj="RECTANGULAR";ar(aC.RECTANGULAR,"rectangularState to rectangularState",aM)}});this.addTransition({iInitialState:aH,iFinalState:aJ,iEvent:"C3D_CANCEL_CLICK",iAction:function(aM){aj="RECTANGULAR";ac(aM)}});this.addTransition({iInitialState:aH,iFinalState:aJ,iEvent:"C3D_SAVE_CLICK",iCondition:function(){return ak()},iAction:function(aM){aj="RECTANGULAR";ah(aM)}});this.addTransition({iInitialState:aI,iFinalState:aI,iEvent:F,iCondition:function(){return aC.CIRCULAR.chkConditions()},iAction:function(aM){aj="CIRCULAR";aC.CIRCULAR.actions(aM)},iSender:H});this.addTransition({iInitialState:aI,iFinalState:aI,iEvent:"C3D_PARAMETERS_CHG",iAction:function(aM){aj="CIRCULAR";ar(aC.CIRCULAR,"circularState to circularState",aM)}});this.addTransition({iInitialState:aI,iFinalState:aJ,iEvent:"C3D_CANCEL_CLICK",iAction:function(aM){aj="CIRCULAR";ac(aM)}});this.addTransition({iInitialState:aI,iFinalState:aJ,iEvent:"C3D_SAVE_CLICK",iCondition:function(){return ak()},iAction:function(aM){aj="CIRCULAR";ah(aM)}});this.addTransition({iInitialState:aL,iFinalState:aL,iEvent:F,iCondition:function(){return aC.USERDEFINED.chkConditions()},iAction:function(aM){aj="USERDEFINED";aC.USERDEFINED.actions(aM)},iSender:H});this.addTransition({iInitialState:aL,iFinalState:aJ,iEvent:"C3D_CANCEL_CLICK",iAction:function(aM){aj="USERDEFINED";ac(aM)}});this.addTransition({iInitialState:aL,iFinalState:aJ,iEvent:"C3D_SAVE_CLICK",iCondition:function(){return ak()},iAction:function(aM){aj="USERDEFINED";ah(aM)}});this.addTransition({iInitialState:aF,iFinalState:aI,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return aC.CIRCULAR.chkConditions()},iAction:function(aM){aj="LINEAR";aC.CIRCULAR.actions(aM)}});this.addTransition({iInitialState:aF,iFinalState:aL,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return aC.USERDEFINED.chkConditions()},iAction:function(aM){aj="LINEAR";aC.USERDEFINED.actions(aM)}});this.addTransition({iInitialState:aI,iFinalState:aF,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return aC.LINEAR.chkConditions()},iAction:function(aM){aj="CIRCULAR";aC.LINEAR.actions(aM)}});this.addTransition({iInitialState:aI,iFinalState:aL,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return aC.USERDEFINED.chkConditions()},iAction:function(aM){aj="CIRCULAR";aC.USERDEFINED.actions(aM)}});this.addTransition({iInitialState:aL,iFinalState:aI,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return aC.CIRCULAR.chkConditions()},iAction:function(aM){ai(aC.CIRCULAR.id);aj="USERDEFINED";aC.CIRCULAR.actions(aM)}});this.addTransition({iInitialState:aH,iFinalState:aL,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return aC.USERDEFINED.chkConditions()},iAction:function(aM){aj="RECTANGULAR";aC.USERDEFINED.actions(aM)}});this.addTransition({iInitialState:aL,iFinalState:aH,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return aC.RECTANGULAR.chkConditions()},iAction:function(aM){ai(aC.RECTANGULAR.id);aj="USERDEFINED";aC.RECTANGULAR.actions(aM)}});this.addTransition({iInitialState:aL,iFinalState:aF,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return aC.LINEAR.chkConditions()},iAction:function(aM){ai(aC.LINEAR.id);aj="USERDEFINED";aC.LINEAR.actions(aM)}});this.addTransition({iInitialState:aF,iFinalState:aE,iEvent:"C3D_PATTERN_CHG",iAction:function(aM){aj="LINEAR";aC.NOPATTERN.actions(aM)}});this.addTransition({iInitialState:aH,iFinalState:aE,iEvent:"C3D_PATTERN_CHG",iAction:function(aM){aj="RECTANGULAR";aC.NOPATTERN.actions(aM)}});this.addTransition({iInitialState:aI,iFinalState:aE,iEvent:"C3D_PATTERN_CHG",iAction:function(aM){aj="CIRCULAR";aC.NOPATTERN.actions(aM)}});this.addTransition({iInitialState:aL,iFinalState:aE,iEvent:"C3D_PATTERN_CHG",iAction:function(aM){aj="USERDEFINED";aC.NOPATTERN.actions(aM)}});this.addTransition({iInitialState:aE,iFinalState:aF,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return aC.LINEAR.chkConditions()},iAction:function(aM){aj="NOPATTERN";aC.LINEAR.actions(aM)}});this.addTransition({iInitialState:aE,iFinalState:aH,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return aC.RECTANGULAR.chkConditions()},iAction:function(aM){aj="NOPATTERN";aC.RECTANGULAR.actions(aM)}});this.addTransition({iInitialState:aE,iFinalState:aI,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return aC.CIRCULAR.chkConditions()},iAction:function(aM){aj="NOPATTERN";aC.CIRCULAR.actions(aM)}});this.addTransition({iInitialState:aE,iFinalState:aL,iEvent:"C3D_PATTERN_CHG",iCondition:function(){return aC.USERDEFINED.chkConditions()},iAction:function(aM){aj="NOPATTERN";aC.USERDEFINED.actions(aM)}});this.addTransition({iInitialState:aE,iFinalState:aE,iEvent:"C3D_PATTERN_CHG",iAction:function(aM){aj="NOPATTERN";if(z){aj=aj+"_"+X}aC.NOPATTERN.actions(aM)}});this.addTransition({iInitialState:aH,iFinalState:aF,iEvent:"C3D_UNSELECT_EVT",iCondition:function(){return aC.LINEAR.chkConditions()},iAction:function(aM){aj="RECTANGULAR";aC.LINEAR.actions(aM)}});this.addTransition({iInitialState:aL,iFinalState:aL,iEvent:"C3D_UNSELECT_EVT",iCondition:function(){return aC.USERDEFINED.chkConditions()},iAction:function(aM){aC.USERDEFINED.actions(aM)}});this.addTransition({iInitialState:aF,iFinalState:aE,iEvent:"C3D_UNSELECT_EVT",iAction:function(aM){aj="LINEAR";aC.NOPATTERN.actions(aM)}});this.addTransition({iInitialState:aI,iFinalState:aI,iEvent:"C3D_UNSELECT_EVT",iCondition:function(){return aC.CIRCULAR.chkConditions()},iAction:function(aM){aj="CIRCULAR";aC.CIRCULAR.actions(aM)}});this.addTransition({iInitialState:aI,iFinalState:aE,iEvent:"C3D_UNSELECT_EVT",iAction:function(aM){aj="CIRCULAR";aC.NOPATTERN.actions(aM)}});this.addTransition({iInitialState:aL,iFinalState:aE,iEvent:"C3D_UNSELECT_EVT",iAction:function(aM){aj="USERDEFINED";aC.NOPATTERN.actions(aM)}});this.addTransition({iInitialState:aH,iFinalState:aE,iEvent:"C3D_UNSELECT_EVT",iAction:function(aM){aj="RECTANGULAR";aC.NOPATTERN.actions(aM)}});this.addTransition({iInitialState:aE,iFinalState:aE,iEvent:"C3D_UNSELECT_EVT",iAction:function(aM){aC.NOPATTERN.actions(aM)}})};S();this._parent(ab,{mode:"exclusive",isAsynchronous:true,doServerCall:false});this.odtUtilsSetDefaultNbInstances=function(aE){P.count=aE;O.count=aE}}});return o});