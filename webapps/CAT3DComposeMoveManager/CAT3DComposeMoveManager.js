/*!  Copyright 2015 Dassault Systemes. All rights reserved. */
define("DS/CAT3DComposeMoveManager/CAT3DComposeMoveManager",["UWA/Core","UWA/Class","DS/ApplicationFrame/Command","DS/CoreEvents/ModelEvents","DS/Visualization/PathElement","DS/Visualization/ThreeJS_DS","DS/SceneGraphOverrides/SceneGraphOverrideSet","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(o,p,a,e,h,m,j,c){var b=require("DS/PADUtils/PADSettingsMgt").getSetting("appModelerType");function k(s){var r=[];if(!s||!s.modelController){o.log("Creation fails");return r}r.modelController=s.modelController;r.isIn=function(t){var u;this.some(function(v){return(u=v.path.isEqual(t)?v:null)});return u};r.initMove=function(t){var u=this.isIn(t);if(!u){u={path:t.clone(),initMatrix:t.getMatrix()};this.push(u)}return u};r.addMove=function(u){var t=this.isIn(u);if(t){t.moved=true;if(!t.hasOwnProperty("isLocked")){if(b==="DEC"){if(!t.editabilityRequested){this.modelController.getEditability({data:[c.getNodeID(u.getLastElement(true))],intent:"MOVE",callbacks:{onComplete:function(v){delete t.editabilityRequested;t.isLocked=!v[c.getNodeID(t.path.getLastElement(true))]},onFailure:function(){delete t.editabilityRequested;t.isLocked=false}}});t.editabilityRequested=true}}else{t.isLocked=false}}}return t};return r}function i(r){return r&&c.isPLMNode(r)}function g(r){return r&&c.isReference(r)}function n(r){return r&&c.isInstance(r)}function l(u,A,t){var y,B;if(!u||!u.path){return undefined}if(A&&t){y=A.getUniqueOverrideFromPathElement(u.path);if(!y){y=A.createOverride({pathes:[u.path]})}}if(u.transformation){B=new m.Matrix4().copy(u.initWorldMatrix).multiply(u.transformation)}else{if(u.leafMatrix){if(y){y.setPosition(u.leafMatrix)}else{u.path.getLastElement(true).setMatrix(u.leafMatrix)}return 0}else{if(u.worldMatrix){B=u.worldMatrix}else{if(u.vector){var x=new m.Vector3().getPositionFromMatrix(u.initWorldMatrix).add(u.vector);B=new m.Matrix4().copy(u.initWorldMatrix).setPosition(x)}else{if(u.axis&&u.center&&u.angle!==undefined){var s=new m.Matrix4().copy(u.initWorldMatrix);var w=new m.Matrix4().makeRotationAxis(u.axis,u.angle);var C=new m.Matrix4().setPosition(u.center);var v=new m.Matrix4().getInverse(C).multiply(s);var z=new m.Matrix4().copy(w).multiply(v);B=new m.Matrix4().copy(C).multiply(z)}}}}}if(B){var r=new m.Matrix4().getInverse(u.path.getParentPath().getWorldMatrix());if(y){y.setPosition(r.multiply(B))}else{u.path.getLastElement(true).setMatrix(r.multiply(B))}return 0}return undefined}var d=p.extend({init:function(y){var A=this,t,s,E=new e(),x=y.context,C=[],J=new k({modelController:x.getController()}),H,w="Persistent",D,v,G=[];function z(){if(!x){return}J=new k({modelController:x.getController()});C=[];w=null;if(s&&t){t.removeSceneGraphOverrideSet(s);if(x.getViewer()){x.getViewer().render()}}s=t=null}function I(){var L=[],O=[],K=[],N={};function P(){E.publish({event:"onValidateMove",data:{objectsMoved:O,objectsCancelled:L,splitInstances:K,eventID:"success"}});if(x.getController().onMove3D&&Array.isArray(N.instances)){var Q=N.instances.filter(function(R){return !K.some(function(S){return S.oldId===R.instance})});if(Q.length){x.getController().onMove3D({instances:Q})}}z()}function M(){O.forEach(function(Q){Q.path.getLastElement(true).setMatrix(Q.initMatrix)});E.publish({event:"onValidateMove",data:{objectsMoved:[],objectsCancelled:L.concat(O),eventID:"error"}});z()}J.forEach(function(R){if(R.moved){var Q={};(R.isLocked&&!s?L:O).push(Q);Q.path=R.path;Q.initMatrix=R.initMatrix;Q.currentMatrix=R.path.getMatrix();Q.isLocked=R.isLocked;if(R.isLocked){if(!s){R.path.getLastElement(true).setMatrix(R.initMatrix)}}delete R.moved;delete R.isLocked}});if(s){E.publish({event:"onValidateMove",data:{objectsMoved:O,eventID:"success"}});z();return}if(b==="DEC"){N={data:O.map(function(R){var Q=R.path.getLastElement(true);return{id:c.getNodeID(Q),matrix:Q.getMatrix()}}),userFeedback:true,callbacks:{onComplete:function(){E.publish({event:"onValidateMove",data:{objectsMoved:O,objectsCancelled:L,eventID:"success"}});z()},onFailure:function(){O.forEach(function(Q){Q.path.getLastElement(true).setMatrix(Q.initMatrix)});E.publish({event:"onValidateMove",data:{objectsMoved:[],objectsCancelled:L.concat(O),eventID:"error"}});z()}}};if(N.data.length){x.getController().storePositions(N)}else{E.publish({event:"onValidateMove",data:{objectsMoved:[],objectsCancelled:L,eventID:"success"}});z()}}else{if(b==="VPM"){N={onComplete:function(Q){if(Q.status!=="success"){M();return}if(Q.results&&Q.results.length){Q.results.forEach(function(R){if(R.status!=="success"){window.console.log("Whole transaction is OK but it fails for an instance. Unexpected!!")}if(R.instanceOut&&R.instance&&R.instance!==R.instanceOut){K.push({oldId:R.instance,newId:R.instanceOut})}})}if(O.length){x.getController().switchAuthoringMode(true,true,"PADSession_disabling_index_authoring")}if(K.length){x.getController().replaceInstances({data:K},{onComplete:P,onFailure:function(){window.console.log("An id has no node associated. Unexpected!!");P()}})}else{P()}},onFailure:M,instances:O.map(function(S){var R=S.path.getLastElement(true),Q=R.getMatrix();return{instance:c.getNodeID(R),hasPositioningMatrix:[0,1,2,4,5,6,8,9,10,12,13,14].map(function(T){return Q.elements[T]})}})};if(N.instances.length){H.move3D(N)}else{P()}}}}function F(L){var K=[];L.forEach(function(O){if(O.moved){var M={};K.push(M);M.path=O.path;M.initMatrix=O.initMatrix;M.currentMatrix=O.path.getMatrix();M.isLocked=O.isLocked;if(!s){O.path.getLastElement(true).setMatrix(O.initMatrix)}else{var N=s.getUniqueOverrideFromPathElement(O.path);if(N){N.setPosition(null)}}delete O.moved;delete O.isLocked}});E.publish({event:"onCancelMove",data:{objectsCancelled:K,bEmptyMove:!J.some(function(M){return M.moved}),someMovedObjectsAreLocked:J.some(function(M){return M.isLocked})}});if(x){if(x.getViewer()){x.getViewer().render();x.publish({event:"onModelUpdated",data:{rootNodes:x.getRoots()}})}}}function r(){var M=[];for(var K=J.length-1;K>=0;--K){var L=J[K];if(L.moved&&L.isLocked){M.push(L);J.splice(K,1)}}F(M)}function B(){var M=[];for(var K=J.length-1;K>=0;--K){var L=J[K];if(L.moved){M.push(L);J.splice(K,1)}}F(M);z()}G.push(x.subscribe({event:"onRootRemoved"},function(M){var K=[],L=new k({modelController:x.getController()});J.forEach(function(N){if(!M.path.isAParentOf(N.path)){L.push(N)}else{K.push(N)}});if(L.length!==J.length){F(K);J=L}}));G.push(x.subscribe({event:"onEndDelete"},function(N){var O=[],L=c.getNodeID(N.pathToReparent);for(var M=J.length-1;M>=0;--M){var K=J[M];if(K.path.externalPath.some(function(P){return c.getNodeID(P)===L})){O.push(K);J.splice(M,1)}}F(O)}));G.push(x.subscribe({event:"onBeginReparent"},function(){B()}));G.push(x.subscribe({event:"onEndMatriceUpdate"},function(K){K.instances.forEach(function(N){for(var M=J.length-1;M>=0;--M){var L=c.getNodeID(J[M].path.getLastElement(true));if(L===N.instance){J.splice(M,1)}}});B()}));function u(L){var K=[];L.forEach(function(P){if(P.path||P.pathElement){var O=A.getSubPathToMovable(P.path||P.pathElement);var M=K.some(function(Q){if(Q.path.isEqual(O)){return true}return false});if(!M){var N={path:O};K.push(N)}}});return K}this.setMode=function(K){var L=(typeof K.useOverride==="boolean")?K.useOverride:true;if((L&&s)||(!L&&!s)){return}if(J.length){B()}z();if(L){t=x.getViewer().getSceneGraphOverrideSetManager();s=new j(x.getRootBagPath().externalPath[0]);t.pushSceneGraphOverrideSet(s)}};this.setMode({useOverride:y.useOverride});if(b==="VPM"){require(["DS/UPSCommands/UPSCmdUtils"],function(K){H=K})}else{if(b!=="DEC"){o.log("Unknown modeler type")}}this.cancelLocked=function(){r()};this.onMoveBegin=function(K){C=[];if(!K||!K.objectsMoved||!K.from||!K.moveMode){return}if(K.moveMode!=="Persistent"&&K.moveMode!=="Transient"){return}w=K.moveMode;D=undefined;v=undefined;var L=u(K.objectsMoved);L.forEach(function(N){var M={path:N.path,initMatrix:N.path.getLastElement(true).getMatrix(),initWorldMatrix:N.path.getWorldMatrix()};if(K.axis&&K.center){M.axis=K.axis;M.center=K.center;M.angle=0}else{M.vector=new m.Vector3()}C.push(M);J.initMove(N.path)});E.publish({event:"MoveBegin",data:{objectsMoved:L,from:K.from,moveMode:w}})};this.onMove=function(N){if(!N||!N.objectsMoved||!N.from){return}if(!N.vector&&N.angle===undefined&&!N.transformation&&!N.leafMatrix&&!N.worldMatrix){return}if(w!=="Persistent"&&w!=="Transient"){return}if(N.transformation||N.leafMatrix||N.worldMatrix){D=undefined;v=undefined}else{if(D===undefined&&N.vector){D=new m.Vector3()}else{if(v===undefined&&N.angle!==undefined){v=0}else{if((v&&N.angle===undefined)||(D&&N.vector===undefined)){return}}}}var O=u(N.objectsMoved);var M,L;if(D){M=new m.Vector3().subVectors(N.vector,D);D=new m.Vector3().copy(N.vector)}else{if(v!==undefined){L=N.angle-v;v=N.angle}}var K=false;O.forEach(function(P){C.some(function(Q){if(P.path.isEqual(Q.path)){if(N.transformation){Q.transformation=N.transformation;Q.vector=Q.angle=Q.leafMatrix=Q.worldMatrix=undefined}else{if(N.leafMatrix){Q.leafMatrix=N.leafMatrix;Q.vector=Q.angle=Q.transformation=Q.worldMatrix=undefined}else{if(N.worldMatrix){Q.worldMatrix=N.worldMatrix;Q.vector=Q.angle=Q.transformation=Q.leafMatrix=undefined}else{if(Q.vector){Q.vector.add(M);Q.transformation=Q.leafMatrix=Q.worldMatrix=undefined}else{if(Q.axis&&Q.axis!==undefined){Q.angle+=L;Q.transformation=Q.leafMatrix=Q.worldMatrix=undefined}}}}}if(w==="Transient"||(w==="Persistent"&&0===l(Q,s,x))){K=true}return true}return false})});if(O.length>0&&w==="Persistent"){O.forEach(function(Q){var P=Q.path.getLastElement(true);if(n(P)){J.addMove(Q.path);J.bPersistantMoved=true}})}if(K){E.publish({event:"Move",data:{objectsMoved:O,from:N.from,moveMode:w}})}};this.onMoveEnd=function(L){if(!L||!L.from||!L.status){return}if(w!=="Persistent"&&w!=="Transient"){return}if(w==="Persistent"&&L.status==="Cancelled"){C.forEach(function(O){if(!s){O.path.getLastElement(true).setMatrix(O.initMatrix)}else{var N=s.getUniqueOverrideFromPathElement(O.path);if(N){N.setPosition(null)}}})}else{if(w==="Transient"&&L.status==="Moved"){var K=[];C.forEach(function(N){if(l(N,s,x)===0){var O={path:N.path.clone()};K.push(O)}});if(K.length>0){var M={objectsMoved:[],from:L.from,moveMode:"Persistent"};K.forEach(function(P){var N=P.path.getLastElement(true);if(n(N)){var O=J.addMove(P.path);if(O){M.objectsMoved.push(O)}}});E.publish({event:"Move",data:M})}}}E.publish({event:"MoveEnd",data:{from:L.from,status:L.status}});x.publish({event:"onModelUpdated",data:{rootNodes:x.getRoots()}});C=[]};this.subscribe=function(K,M){var L;if(K==="MoveBegin"||K==="Move"||K==="MoveEnd"||K==="onValidateMove"||K==="onCancelMove"){L=E.subscribe({event:K},M)}return L};this.unsubscribe=function(K){E.unsubscribe(K)};this.getSubPathToMovable=function(L){if(!L){return undefined}var M=new h(L.externalPath),N;while(M&&!n(M.getLastElement(true))){M=M.getParentPath()}if(!M){N=new h();var O=L.externalPath.some(function(P){N.addElement(P);return g(P)});if(O){M=N}}if(!M){N=new h();var K=L.externalPath.some(function(P){N.addElement(P);return i(P)});if(K){M=N}}return M};this.terminateMove=function(K){if((typeof K.save==="boolean")&&K.save){I()}else{B()}};this.isPathLocked=function(N){if(!N||!N.pathElement||!N.onCompleted){return{returnCode:-1}}var M=N.pathElement.getLastElement(true),O,L=c.getRoots(x);if(L.some(function(P){return P===M})){O={returnCode:0,pathElement:N.pathElement,isLocked:false};setTimeout(function(){N.onCompleted(O)},0);return O}if(!c.isInstance(M)){return{returnCode:-2}}O={returnCode:0};var K=J.isIn(N.pathElement);if(K&&K.hasOwnProperty("isLocked")){O.pathElement=N.pathElement;O.isLocked=K.isLocked;setTimeout(function(){N.onCompleted({pathElement:N.pathElement,isLocked:K.isLocked})},0)}else{if(b==="DEC"){x.getController().getEditability({data:[c.getNodeID(N.pathElement.getLastElement(true))],intent:"MOVE",callbacks:{onComplete:function(P){var Q=!P[c.getNodeID(N.pathElement.getLastElement(true))];if(J.bPersistantMoved===true){if(!K){K=J.initMove(N.pathElement)}K.isLocked=Q}N.onCompleted({pathElement:N.pathElement,isLocked:Q})},onFailure:function(){N.onCompleted({pathElement:N.pathElement,isLocked:false})}}})}else{if(!K){K=J.initMove(N.pathElement)}K.isLocked=false;O.pathElement=N.pathElement;O.isLocked=K.isLocked;setTimeout(function(){N.onCompleted({pathElement:N.pathElement,isLocked:K.isLocked})},0)}}return O};this._destroy=function(){G.forEach(function(K){x.unsubscribe(K)});G=[];B();z();x=t=A=null}}});var q=[];var f=p.singleton({init:function(){},getMoveManager:function(s){var t;if(s&&s.context){q.some(function(u){if(u.context===s.context){t=u.moveManager;return true}return false});if(!t){var r=new d(s);q.push({context:s.context,moveManager:r});t=r}}return t},unreferenceMoveManager:function(r){q.some(function(t,s){if(t.context===r.context){q.splice(s,1);t.moveManager._destroy();return true}return false})}});return f});define("DS/CAT3DComposeMoveManager/CATC3DMoveReferent",["UWA/Class","DS/Visualization/PathElement","DS/ENOPAD3DViewer/utils/PAD3DViewerModelServices"],function(j,c,a){var f=function(l){return l&&a.isPLMNode(l)},b=function(l){return l&&a.isReference(l)},i=function(l){return l&&a.isInstance(l)},g=function(m){if(!m||!m.externalPath||m.externalPath.length===0||(m.internalPath&&m.internalPath.length>0)){return false}if(!f(m.externalPath[m.externalPath.length-1])){return false}for(var l=m.externalPath.length-2;l>=0;--l){if(f(m.externalPath[l])){return false}}return true},h=function(n){if(!n||!n.externalPath){return undefined}for(var l=0;l<n.externalPath.length;l++){var m=n.externalPath[l];if(f(m)){return m}}return undefined},d=j.extend({init:function(m){var o=[],l=m.context,n=(function(){function q(s,r){if(!b(s)){s.getChildren().forEach(function(t){q(t,r)})}else{s.getChildren().forEach(function(u){if(i(u)){var t=u.children.length===1?u.children[0]:undefined;if(t){if(!r.some(function(v){return t===v})){r.push(t)}}}})}}return function p(t){var r=t.path?h(t.path):t;if(r&&!(o.some(function(u){return u.rootNode===r}))){var s=[];o.push({rootNode:r,referentList:s});q(r,s)}}})();l.subscribe({event:"onRootAdded"},n);a.getRoots(l).forEach(n);l.subscribe({event:"onRootRemoved"},function(p){var q=h(p.path);if(!q){return}o.some(function(s,r){if(s.rootNode===q){o.splice(r,1);return true}return false})});l.subscribe({event:"onInsertExisting"},function(p){if(!b(p.modifiedNode)||!i(p.createdNode)||!b(p.insertedNode)){return}o.forEach(function(r){var q=r.rootNode;if(q===p.modifiedNode){if(!r.referentList.some(function(s){return s===p.insertedNode})){r.referentList.push(p.insertedNode)}return}if(b(q)){return}q.getChildren().forEach(function(s){if(s.children&&s.children.length===1&&s.children[0]===p.modifiedNode){if(!r.referentList.some(function(t){return t===p.insertedNode})){r.referentList.push(p.insertedNode)}}})})});this.addMoveReferent=function(q){var p=h(q);if(!p){return}o.some(function(s){if(s.rootNode===p){var r=false;q.externalPath.slice().reverse().forEach(function(u){if(!r){if(i(u)){var t=u.children&&u.children.length>0?u.children[0]:null;if(!b(t)){return}if(!s.referentList.some(function(v){return v===t})){s.referentList.push(t)}r=true}}else{if(b(u)){s.referentList.some(function(w,v){if(w===u){s.referentList.splice(v,1);return true}return false})}}});return true}return false})};this.getMoveReferent=function(s){var t;if(s){if(g(s)){t=s.clone()}else{t=new c();var r=this.getSubPathToMovable(s);var q=h(r);var p=o.some(function(z){if(z.rootNode===q){for(var x=0;x<r.externalPath.length;x++){var v=false;var y=r.externalPath[x];if(i(y)){var w=y.children[0];for(var u=0;u<z.referentList.length;u++){if(z.referentList[u]===w){v=true;break}}}t.addElement(y);if(v){break}}return true}return false});if(!p){t=undefined}}}return t};this.getSubPathToMovable=function(q){if(!q){return undefined}var r=new c(q.externalPath),s;while(r&&!i(r.getLastElement(true))){r=r.getParentPath()}if(!r){s=new c();var t=q.externalPath.some(function(u){s.addElement(u);return b(u)});if(t){r=s}}if(!r){s=new c();var p=q.externalPath.some(function(u){s.addElement(u);return f(u)});if(p){r=s}}return r}}}),e=[],k=j.singleton({init:function(){},getMoveReferentManager:function(m){var n;if(m&&m.context){e.some(function(o){if(o.context===m.context){n=o.moveReferent;return true}return false});if(!n){var l=new d(m);e.push({context:m.context,moveReferent:l});n=l}}return n}});return k});