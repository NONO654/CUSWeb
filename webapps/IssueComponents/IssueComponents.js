define("DS/IssueComponents/utils/Utils",["UWA/Class/Promise","UWA/Controls/Input","UWA/Core","DS/Logger/Logger","DS/PADUtils/views/PADAlert","DS/WebappsUtils/WebappsUtils","DS/IssueServices/Contexts","DS/IssueServices/services/PlatformServices","i18n!DS/IssueCommon/assets/nls/IssueCommon"],function(j,i,g,c,b,e,d,a,k){var h={CREATE_STATE:"Create",ASSIGN_STATE:"Assign",ACTIVE_STATE:"Active",REVIEW_STATE:"Review",CLOSED_STATE:"Closed",DATES:["created","modified","estimatedStartDate","estimatedEndDate","actualStartDate","actualEndDate","resolutionDate"]};var f={getIconByState:function(m){var l="";switch(m){case h.CREATE_STATE:l=e.getWebappsAssetUrl("IssueCommon","icons/22/iconCreateState.png");break;case h.ASSIGN_STATE:l=e.getWebappsAssetUrl("IssueCommon","icons/22/iconAssignState.png");break;case h.ACTIVE_STATE:l=e.getWebappsAssetUrl("IssueCommon","icons/22/iconActiveState.png");break;case h.REVIEW_STATE:l=e.getWebappsAssetUrl("IssueCommon","icons/22/iconReviewState.png");break;case h.CLOSED_STATE:l=e.getWebappsAssetUrl("IssueCommon","icons/22/iconClosedState.png");break;default:break}return l},getColorByState:function(m){var l="";switch(m){case h.CREATE_STATE:l="#9B2C98";break;case h.ASSIGN_STATE:l="#FF8A2E";break;case h.ACTIVE_STATE:l="#009DDB";break;case h.REVIEW_STATE:l="#6FBC4B";break;case h.CLOSED_STATE:l="#ADADAD";break;default:break}return l},getFormattedDate:function(m,l){var p=window.widget.lang;var o=h.DATES;for(var n=0;n<o.length;n++){if(!isNaN(Date.parse(m[o[n]]))){m[o[n]]=new Date(m[o[n]]).toLocaleString(p,l)}else{m[o[n]]=""}}return m},getTextFromHTML:function(l){var m=g.createElement("div",{html:l});return m.textContent||m.innerText||""},timeSince:function(m){var n=Math.floor((new Date()-m)/1000);var l=Math.floor(n/31536000);if(l>1){return k.replace(k.dates.years,{number:l})}l=Math.floor(n/2592000);if(l>1){return k.replace(k.dates.months,{number:l})}l=Math.floor(n/86400);if(l>1){return k.replace(k.dates.days,{number:l})}l=Math.floor(n/3600);if(l>1){return k.replace(k.dates.hours,{number:l})}l=Math.floor(n/60);if(l>1){return k.replace(k.dates.minutes,{number:l})}return k.replace(k.dates.seconds,{number:Math.floor(n)})},getFilesFromDrop:function(o){var n=[];if(o.dataTransfer.items){for(var m=0;m<o.dataTransfer.items.length;m++){if(o.dataTransfer.items[m].kind==="file"){n.push(o.dataTransfer.items[m].getAsFile())}}}else{for(var l=0;l<o.dataTransfer.files.length;l++){n.push(o.dataTransfer.files[l])}}return n},uploadImages:function(l){var m=this;return new j(function(o){var n=new i.File("Input.File",{visibility:"hidden",styles:{display:"none"}});n.elements.container.setStyle("display","none");n.elements.input.multiple=(l!==undefined)?l:true;n.elements.input.accept="image/png, image/jpeg";n.elements.input.addEventListener("change",function(p){n.destroy();n=null;o(p.target.files)},false);n.elements.input.addEventListener("click",function(p){p.stopPropagation()});n.elements.input.click()}).then(function(n){n=Array.from(n);if(n.length===0){return j.reject(new Error("No selected files to be uploaded"))}var o=[];n.forEach(function(p){o.push(m.isImage(p))});return j.all(o)}).then(function(n){n=n.reduce(function(p,o){if(o.status==="success"){p.push(o.file)}else{b.displayNotification({msg:k.replace(k.images.errorUpload,{name:o.file.name}),eventID:"error"})}return p},[]);if(n.length===0){return j.reject(new Error("No valid files to be uploaded"))}return j.resolve(n)})},isImage:function(m){var l=new FileReader();return new j(function(o){l.onload=function n(r){var q=r.target.result,p=new Uint8Array(q);if(p[0]===255&&p[1]===216&&p[p.byteLength-2]===255&&p[p.byteLength-1]===217){o({status:"success",file:m})}else{if(p[0]===137&&p[1]===80&&p[2]===78&&p[3]===71){o({status:"success",file:m})}else{if(p[0]===71&&p[1]===73&&p[2]===70&&p[3]===56){o({status:"error",file:m})}else{if(p[0]===66&&p[1]===77){o({status:"error",file:m})}else{o({status:"error",file:m})}}}}};l.readAsArrayBuffer(m)})},readImageURI:function(m){var l=new FileReader();return new j(function(n){l.onload=function(o){n(o.target.result)};l.readAsDataURL(m)})},getDroppableData:function(l){var n={};var t=g.is(l.dataTransfer.types.indexOf,"function")?"indexOf":"contains",q="";var o=["text/searchitems","text/plain","Text"];for(var s=0;s<o.length&&q==="";s++){var r=l.dataTransfer.types[t](o[s]);if((g.is(r,"number")&&r>=0)||(g.is(r,"boolean")&&r===true)){q=o[s]}}var m={};if(q===""){throw new Error("Unknown type in DnD")}else{m=l.dataTransfer.getData(q)}try{n=JSON.parse(m)}catch(p){n={data:{items:[]}}}return n},setDroppableData:function(l){var r=d.get("widget");var p={protocol:"3DXContent",version:"1.1",source:r.name,widgetId:r.id,data:{items:[]}};for(var m=0;m<l.length;m++){var q=l[m];p.data.items.push({envId:a.getTenant(),serviceId:"3DSpace",contextId:"",objectId:q.options.id,objectType:q.options.type,displayName:q.options.name,displayType:q.options.type})}var o="text/plain";try{if(window.navigator.userAgent.indexOf("MSIE ")>0||navigator.userAgent.match(/Trident.*rv\:11\./)){o="text"}}catch(n){}if(p.data.items.length===0){return null}return{type:o,data:p}},createGhostDrag:function(l,m){var n=g.createElement("div",{"class":"issue-ghost-container",html:[g.createElement("div",{"class":"issue-ghost-panel",html:[g.createElement("img",{"class":"issue-ghost-image",src:l.icons[l.icons.length-1]}),g.createElement("div",{"class":"issue-ghost-title",html:l.title+" ("+l.name+")"})]}),g.createElement("span",{"class":"issue-ghost-counter",html:m})]});n.setStyle("transform","translate3d(0,0,0)");return n},isJson:function(m){try{JSON.parse(m)}catch(l){return false}return true},utils:{isInteger:function(l){return Number.isInteger?Number.isInteger(l):typeof l==="number"&&isFinite(l)&&Math.floor(l)===l}}};return f});define("DS/IssueComponents/routes/Routes",["UWA/Class/View","UWA/Core","UWA/Class/Promise","DS/Logger/Logger","DS/Tree/TreeListView","DS/TreeModel/TreeNodeModel","DS/UIKIT/Scroller","DS/UIKIT/Tooltip","DS/IssueCommon/commands/CommandsManager","DS/IssueCommon/utils/Utils","DS/IssueServices/Contexts","DS/IssueServices/services/IssueServices","DS/IssueServices/services/PlatformServices","DS/IssueServices/utils/Performance","i18n!DS/IssueComponents/assets/nls/IssueComponents","css!DS/IssueComponents/IssueComponents.css"],function(c,j,o,g,l,k,h,p,a,n,f,i,b,e,q){var m={STATES:{CREATE:0,ASSIGN:1,ACTIVE:2,REVIEW:3,CLOSED:4},STATES_ORDER:{0:"CREATE",1:"ASSIGN",2:"ACTIVE",3:"REVIEW",4:"CLOSED"},CSS:{ELEMENTS:{SCROLLCONTENT:"im-routes-scroll-content",SCROLLCONTAINER:"im-routes-scroll-container",TABLE_CONTAINER:"im-routes-table-container",TABLE_HEADER:"im-routes-table-header",TABLE_HEADER_STATES:"im-routes-table-header-states",TABLE_HEADER_ROUTES:"im-routes-table-header-routes",TABLE_ROWS_CONTAINER:"im-routes-table-rows-container",TABLE_ROW:"im-routes-table-row",TABLE_ROW_STATES_CELL:"im-routes-table-row-states-cell",TABLE_ROW_STATES_CELL_STATE_BLOCK:"im-routes-table-row-states-cell-state-block",TABLE_ROW_STATES_CELL_STATE_BLOCK_CURRENT:"im-routes-table-row-states-cell-state-block-curr",TABLE_ROW_STATES_CELL_STATE_BLOCK_CREATE:"im-routes-table-row-states-cell-state-block-create",TABLE_ROW_STATES_CELL_STATE_BLOCK_ASSIGN:"im-routes-table-row-states-cell-state-block-assign",TABLE_ROW_STATES_CELL_STATE_BLOCK_ACTIVE:"im-routes-table-row-states-cell-state-block-active",TABLE_ROW_STATES_CELL_STATE_BLOCK_REVIEW:"im-routes-table-row-states-cell-state-block-review",TABLE_ROW_STATES_CELL_STATE_BLOCK_CLOSED:"im-routes-table-row-states-cell-state-block-closed",TABLE_ROW_STATES_CELL_ARROW_ASC:"fonticon fonticon-2x fonticon-double-chevron-down im-lifecycle-approve-modal-preview-arrow",TABLE_ROW_STATES_CELL_ARROW_DESC:"fonticon fonticon-2x fonticon-double-chevron-up im-lifecycle-approve-modal-preview-arrow",TABLE_ROW_ROUTES_CELL:"im-routes-table-row-routes-cell",TABLE_ROW_ROUTES_CELL_STATUS:"im-routes-table-row-routes-cell-status",TABLE_ROW_ROUTES_CELL_MULTI:"im-routes-table-row-routes-cell-multi",TABLE_ROW_ROUTES_CELL_DECISION_ROW:"im-routes-table-row-routes-cell-decision-row",TABLE_ROW_ROUTES_CELL_DECISION_STATUS:"im-routes-table-row-routes-cell-decision-status",ICON_APPROVED:"fonticon fonticon-check im-routes-icon-approved",ICON_REJECTED:"fonticon fonticon-wrong im-routes-icon-rejected",ICON_ABSTAINED:"fonticon fonticon-minus im-routes-icon-abstained",ICON_INPROGRESS:"fonticon fonticon-clock im-routes-icon-inprogress",CELL_DECISION_TEXT:"im-routes-table-row-routes-cell-decision-text",CELL_DECISION_TOOLTIP_TEXT:"im-routes-table-row-routes-cell-decision-tooltip-text",WEBUX_CELL_SINGLE:"im-routes-wux-datagrid-cell-single",WEBUX_CELL_MULTI:"im-routes-wux-datagrid-cell-multi"}},TREELIST:{CELLHEIGHT:32,GRID:{allowUnsafeHTMLContent:false,height:"100%",apiVersion:2,defaultCellHeight:26,headersDimensions:{width:undefined,height:26},useTransparentScroller:false,useNativeScroller:false,useAsyncPreExpand:true,resize:{columns:true,rows:false},selection:{unselectAllOnEmptyArea:true,toggle:false,canMultiSelect:true,enableListSelection:true,renderingMode:"adaptive"},columns:[{dataIndex:"tree",isHidden:true,isSortable:false},{dataIndex:"status",width:55,isDraggable:false,text:"",isSortable:false},{width:37,dataIndex:"decisionStatus",isDraggable:false,text:"",isSortable:false},{width:"auto",dataIndex:"reviewer",isDraggable:false,text:q.routes.columns.reviewer,isSortable:false},{width:"auto",dataIndex:"date",isDraggable:false,text:q.routes.columns.date,isSortable:false},{width:"auto",dataIndex:"reason",isDraggable:false,text:q.routes.columns.reason,isSortable:false},{width:"auto",dataIndex:"attachments",isDraggable:false,text:q.routes.columns.attachments,isSortable:false},]}}};var d=c.extend({name:"DS/IssueComponents/routes/Routes",tagName:"div",className:"im-routes-component",_logger:null,domEvents:{},defaultOptions:{ids:[],states:["Create","Assign","Active","Review","Closed"],},setup:function(r){var s=this;e.start(s.name+" setup");s._parent(r);s._logger=g.getLogger(s.name);s.elements={};s._tooltips=[];s._deferred={};s.isLoaded=new o(function(u,t){s._deferred.resolve=u;s._deferred.reject=t});s.physicalId=r.physicalId;s.order="descending";s.routes=null;s.treeLists=null;s.isEmpty=false;e.end(s.name+" setup")},render:function(){var u=this;e.start(u.name+" render");var t=u.elements.tableContainer=j.createElement("div",{"class":m.CSS.ELEMENTS.TABLE_CONTAINER+" "+m.CSS.ELEMENTS.SCROLLCONTENT});t.inject(u.container);var r=u.elements.tableHeader=j.createElement("div",{"class":m.CSS.ELEMENTS.TABLE_HEADER});r.inject(t);var x=j.createElement("div",{"class":m.CSS.ELEMENTS.TABLE_HEADER_STATES,html:q.routes.header.states,title:q.routes.header.states});x.inject(r);var w=j.createElement("div",{"class":m.CSS.ELEMENTS.TABLE_HEADER_ROUTES,html:q.routes.header.routes});w.inject(r);var v=u.elements.tableRowsContainer=j.createElement("div",{"class":m.CSS.ELEMENTS.TABLE_ROWS_CONTAINER});v.inject(t);var s=u.elements.scrollContainer=j.createElement("div",{"class":m.CSS.ELEMENTS.SCROLLCONTAINER}).inject(u.container);u._scroller=new h({element:t}).inject(s);u.refresh(u.physicalId);return u},refresh:function(r){var s=this;s.reset();s.physicalId=r;s.setOption("physicalId",r);return i.routes.retrieve({data:{objects:[{physicalId:r}]}}).then(function(w){if(Array.isArray(w)&&w.length===1){var t=s.routes=w[0].body;var v={create:[],assign:[],active:[],review:[],closed:[]};s.treeLists={create:null,assign:null,active:null,review:null,closed:null};t.history.forEach(function(x){v[x.from.toLowerCase()].push(x)});Object.keys(v).forEach(function(x){v[x]=v[x].sort(function(A,z){var y=0;if(!A.date){y=-1}else{if(!z.date){y=1}else{var C=new Date(A.date);var B=new Date(z.date);y=C-B}}return y*(s.order==="ascending"?1:-1)});v[x].forEach(function(y){y.decisions=y.decisions.sort(function(B,A){var z=0;if(!B.date){z=-1}else{if(!A.date){z=1}else{var D=new Date(B.date);var C=new Date(A.date);z=D-C}}return z*(s.order==="ascending"?1:-1)})})});if(t.current&&t.current.from){if(s.order==="ascending"){v[t.current.from.toLowerCase()].push(t.current)}else{v[t.current.from.toLowerCase()].unshift(t.current)}}s.isEmpty=Object.keys(v).every(function(x){return v[x].length===0});var u=Object.keys(v);if(s.order!=="ascending"){u=u.reverse()}u.forEach(function(y){var B=v[y];if(B.length>0){var I=j.createElement("div",{"class":m.CSS.ELEMENTS.TABLE_ROW});I.setData("state",y);I.inject(s.elements.tableRowsContainer);var x=j.createElement("div",{"class":m.CSS.ELEMENTS.TABLE_ROW_STATES_CELL});x.inject(I);var C=j.createElement("div",{"class":m.CSS.ELEMENTS.TABLE_ROW_STATES_CELL_STATE_BLOCK+" "+m.CSS.ELEMENTS["TABLE_ROW_STATES_CELL_STATE_BLOCK_"+y.toUpperCase()]+" "+m.CSS.ELEMENTS.TABLE_ROW_STATES_CELL_STATE_BLOCK_CURRENT,html:q.maturity[y]});C.inject(x);C.setStyle("order",s.order==="ascending"?1:3);var E=j.createElement("span",{"class":s.order==="ascending"?m.CSS.ELEMENTS.TABLE_ROW_STATES_CELL_ARROW_ASC:m.CSS.ELEMENTS.TABLE_ROW_STATES_CELL_ARROW_DESC});E.inject(x);E.setStyle("order",2);var F=m.STATES_ORDER[m.STATES[y.toUpperCase()]+1].toLowerCase();var A=j.createElement("div",{"class":m.CSS.ELEMENTS.TABLE_ROW_STATES_CELL_STATE_BLOCK+" "+m.CSS.ELEMENTS["TABLE_ROW_STATES_CELL_STATE_BLOCK_"+F.toUpperCase()],html:q.maturity[F]});A.inject(x);A.setStyle("order",s.order==="ascending"?3:1);var H=j.createElement("div",{"class":m.CSS.ELEMENTS.TABLE_ROW_ROUTES_CELL});H.inject(I);var G=j.clone(m.TREELIST.GRID);G.id="im-routes-component-treelist-"+y;var D=B.reduce(function(K,J){if(J.decisions.length>K){K=J.decisions.length}return K},1);G.defaultCellHeight=m.TREELIST.CELLHEIGHT*D;G.columns=s._customizeColumnRendering(G.columns);var z=new l(G);z.onNodeClick(function(){Object.keys(s.treeLists).forEach(function(J){if(s.treeLists[J]!==null&&s.treeLists[J]!==z){s.treeLists[J].getManager().unselectAll()}})});z.inject(H);B.forEach(function(J){var M=J.physicalId;var L={id:M,grid:j.clone(J)};L.grid.issueId=t.physicalId;var K=new k(L);z.addRoot(K)});I.setStyle("height",(B.length*D+1)*(m.TREELIST.CELLHEIGHT)+20);z.elements.container.setStyle("height","100%");s.treeLists[y]=z}})}}).then(function(){s.resize();s.dispatchEvent("onReady")})["catch"](function(t){s.dispatchEvent("onFailure",t)})},resize:function(){},reset:function(){var s=this;s.elements.tableRowsContainer.empty();try{s._tooltips.forEach(function(t){t.destroy()})}catch(r){}s._tooltips=[]},destroy:function(){var r=this;r.reset()},selectRoute:function(r){var s=this;Object.keys(s.treeLists).forEach(function(u){if(s.treeLists[u]!==null){s.treeLists[u].getManager().unselectAll()}});var t=s.treeLists[r.from.toLowerCase()];if(t!==null&&t!==undefined){t.getRoots().forEach(function(u){if(u.options.id===r.physicalId){u.highlight();u.select()}})}},_customizeColumnRendering:function(r){var s=this;var t=j.clone(r);t.forEach(function(u){switch(u.dataIndex){case"status":u.onCellRequest=s._columnRenderer.status.bind(s);break;case"decisionStatus":u.onCellRequest=s._columnRenderer.decisionStatus.bind(s);break;case"reviewer":u.onCellRequest=s._columnRenderer.reviewer.bind(s);break;case"date":u.onCellRequest=s._columnRenderer.date.bind(s);break;case"reason":u.onCellRequest=s._columnRenderer.reason.bind(s);break;case"attachments":u.onCellRequest=s._columnRenderer.attachments.bind(s);break;default:break}});return t},_columnRenderer:{status:function(t){if(!t.isHeader){var s=t.nodeModel.options.grid;var v=j.createElement("div",{"class":m.CSS.ELEMENTS.TABLE_ROW_ROUTES_CELL_STATUS});var u=m.CSS.ELEMENTS["ICON_"+s.status.toUpperCase()];var r=j.createElement("div",{"class":u});r.inject(v);t.cellView.getContent().addClassName(m.CSS.ELEMENTS.WEBUX_CELL_SINGLE);t.cellView.getContent().setContent(v)}},decisionStatus:function(s){if(!s.isHeader){var r=s.nodeModel.options.grid;var t=j.createElement("div",{"class":m.CSS.ELEMENTS.TABLE_ROW_ROUTES_CELL_MULTI});r.decisions.forEach(function(x){s.cellView.getContent().addClassName(m.CSS.ELEMENTS.WEBUX_CELL_MULTI);var v=j.createElement("div",{"class":m.CSS.ELEMENTS.TABLE_ROW_ROUTES_CELL_DECISION_ROW});var u=Math.floor((1/r.decisions.length)*100);v.setStyle("height",u+"%");v.inject(t);var y=m.CSS.ELEMENTS["ICON_"+x.status.toUpperCase()];var w=j.createElement("span",{"class":y});w.inject(v)});s.cellView.getContent().setContent(t)}},reviewer:function(s){var t=this;if(!s.isHeader){var r=s.nodeModel.options.grid;var u=j.createElement("div",{"class":m.CSS.ELEMENTS.TABLE_ROW_ROUTES_CELL_MULTI});r.decisions.forEach(function(y){s.cellView.getContent().addClassName(m.CSS.ELEMENTS.WEBUX_CELL_MULTI);var w=j.createElement("div",{"class":m.CSS.ELEMENTS.TABLE_ROW_ROUTES_CELL_DECISION_ROW});var v=Math.floor((1/r.decisions.length)*100);w.setStyle("height",v+"%");w.inject(u);var x=y.reviewer.fullName;var z=j.createElement("div",{"class":m.CSS.ELEMENTS.CELL_DECISION_TEXT,html:x});z.inject(w);t._tooltips.push(new p({position:"bottom",target:z,body:j.createElement("span",{"class":m.CSS.ELEMENTS.CELL_DECISION_TOOLTIP_TEXT,html:x})}))});s.cellView.getContent().setContent(u)}},date:function(s){var t=this;if(!s.isHeader){var r=s.nodeModel.options.grid;var u=j.createElement("div",{"class":m.CSS.ELEMENTS.TABLE_ROW_ROUTES_CELL_MULTI});r.decisions.forEach(function(y){s.cellView.getContent().addClassName(m.CSS.ELEMENTS.WEBUX_CELL_MULTI);var w=j.createElement("div",{"class":m.CSS.ELEMENTS.TABLE_ROW_ROUTES_CELL_DECISION_ROW});var v=Math.floor((1/r.decisions.length)*100);w.setStyle("height",v+"%");w.inject(u);var x=y.date?(new Date(y.date)).toLocaleString(f.get("widget").lang):"";var z=j.createElement("div",{"class":m.CSS.ELEMENTS.CELL_DECISION_TEXT,html:x});z.inject(w);t._tooltips.push(new p({position:"bottom",target:z,body:j.createElement("span",{"class":m.CSS.ELEMENTS.CELL_DECISION_TOOLTIP_TEXT,html:x})}))});s.cellView.getContent().setContent(u)}},reason:function(s){var t=this;if(!s.isHeader){var r=s.nodeModel.options.grid;var u=j.createElement("div",{"class":m.CSS.ELEMENTS.TABLE_ROW_ROUTES_CELL_MULTI});r.decisions.forEach(function(y){s.cellView.getContent().addClassName(m.CSS.ELEMENTS.WEBUX_CELL_MULTI);var w=j.createElement("div",{"class":m.CSS.ELEMENTS.TABLE_ROW_ROUTES_CELL_DECISION_ROW});var v=Math.floor((1/r.decisions.length)*100);w.setStyle("height",v+"%");w.inject(u);var x=y.reason||y.comment;var z=j.createElement("div",{"class":m.CSS.ELEMENTS.CELL_DECISION_TEXT,html:n.getTextFromHTML(x)});z.inject(w);t._tooltips.push(new p({position:"bottom",target:z,body:j.createElement("span",{"class":m.CSS.ELEMENTS.CELL_DECISION_TOOLTIP_TEXT,html:n.getTextFromHTML(x)})}))});s.cellView.getContent().setContent(u)}},attachments:function(u){var w=this;if(!u.isHeader){var t=u.nodeModel.options.grid;var y=j.createElement("div",{"class":m.CSS.ELEMENTS.TABLE_ROW_ROUTES_CELL_MULTI});u.cellView.getContent().addClassName(m.CSS.ELEMENTS.WEBUX_CELL_MULTI);var s=j.createElement("div",{"class":m.CSS.ELEMENTS.TABLE_ROW_ROUTES_CELL_DECISION_ROW});var r=Math.floor((1/t.decisions.length)*100);s.setStyle("height",r+"%");s.inject(y);var v=j.createElement("span",{"class":"fonticon fonticon-popup"});var x=j.createElement("div",{"class":m.CSS.ELEMENTS.CELL_DECISION_TEXT+" clickable",html:v});x.inject(s);x.addEventListener("click",function(){a.getCommand("AttachmentManager").selectedObject={physicalId:t.issueId,title:q.replace(q.routes.attachmentsManagerTitle,{fromState:q.maturity[t.from.toLowerCase()],toState:q.maturity[t.approveTo.toLowerCase()],}),};a.getCommand("AttachmentManager").begin()});u.cellView.getContent().setContent(y)}}}});return d});define("DS/IssueComponents/models/TreeNodeModel",["UWA/Core","DS/Tree/TreeNodeModel"],function(c,a){function b(d){var f=this;var e={id:"",label:"",icons:[],grid:{},type:""};d=c.extend(e,d);a.call(f,d)}b.prototype=Object.create(a.prototype);b.prototype.getID=function(){var d=this;return d.options.id};return b});define("DS/IssueComponents/create/Finalize",["UWA/Class/Promise","UWA/Class/View","UWA/Core","DS/UIKIT/Form","DS/UIKIT/Input/Text","DS/UIKIT/Input/Toggle","DS/ENOFloatingPanel/ENOFloatingPanel","DS/Logger/Logger","DS/IssueServices/Contexts","DS/IssueServices/services/IssueServices","DS/IssueServices/services/PlatformServices","DS/IssueServices/utils/Performance","i18n!DS/IssueComponents/assets/nls/IssueComponents","css!DS/IssueComponents/IssueComponents.css"],function(l,b,h,k,f,m,i,e,d,g,a,c,n){var j={ENABLE_APPROVAL_WAITING_ON:"Analyst"};var o=b.extend({name:"DS/IssueComponents/create/Finalize",tag:"div",className:"create-view-content-subview create-finalize",isInit:null,_deferredInit:{resolve:null,reject:null},setup:function(p){var q=this;q._parent(p);q.parent=p.parent;q.isInit=new l(function(s,r){q._deferredInit.resolve=s;q._deferredInit.reject=r});q.form=null;q.formElements={enableApproval:null,saveAsTemplate:null};q.formElementsToggler={enableApproval:null,saveAsTemplate:null};q.fields={automation:{enableApproval:null},saveAsTemplate:{container:null}};q._appliedTemplate=null;q._deferredInit.resolve()},destroy:function(){var p=this;p.form=null;p.formElements={enableApproval:null,saveAsTemplate:null};p.formElementsToggler={enableApproval:null,saveAsTemplate:null};p.fields={automation:{enableApproval:null},saveAsTemplate:{container:null}};p._appliedTemplate=null},render:function(){var q=this;q.form=new k({className:"create-finalize-form",fields:[],events:{onInvalid:function(){}}}).inject(q.container);var p=h.createElement("div",{"class":"create-form-content",html:[q._renderApprovalField(),q._renderSaveAsTemplateField()]});p.inject(q.form.elements.container);return q},_renderApprovalField:function(){var r=this;var t=d.get("widget");var q=false;if(h.is(t.getPreference("validation"),"object")){var s=t.getValue("validation");q=h.is(s,"boolean")?s:s==="true"}var p=r.formElements.enableApproval=h.createElement("div",{"class":"create-form-element",html:[{tag:"div","class":"create-form-visibility-mask"},{tag:"div","class":"create-form-visibility-toggle",html:[r.formElementsToggler.enableApproval=h.createElement("span",{"class":"fonticon fonticon-eye"})]},{tag:"div","class":"create-form-field form-group",html:[{tag:"h5","class":"",html:n.create.finalize.labels.approval},(r.fields.automation.enableApproval=new m({type:"switch",checked:q,label:n.create.finalize.enableApproval}))]}]});return p},_renderSaveAsTemplateField:function(){var r=this;r.fields.saveAsTemplate.form=new k({className:"save-as-template-form",fields:[]});var q=h.createElement("div",{"class":"create-form-content",html:[{tag:"div","class":"create-form-field form-group",html:[(r.fields.saveAsTemplate.name=new f({placeholder:n.create.finalize.labels.templateNamePlaceholder,required:true,events:{onChange:function(t){var s=this;if(!t||document.activeElement!==t.target){s.setValue(s.getValue().trim())}}}}))]},{tag:"div","class":"create-form-field form-group",html:[(r.fields.saveAsTemplate.description=new f({name:"template-description",id:"template-description",className:"",placeholder:n.create.finalize.labels.templateDescriptionPlaceholder,value:"",multiline:true,required:false}))]}]});r.fields.saveAsTemplate.form.texts.push(r.fields.saveAsTemplate.name);r.fields.saveAsTemplate.name.getContent().addEventListener("keyup",function(){var s=r.fields.saveAsTemplate.name.getValue();r._onTemplateNameChange(s)},false);var p=r.formElements.saveAsTemplate=h.createElement("div",{"class":"create-form-element",html:[{tag:"div","class":"create-form-visibility-mask"},{tag:"div","class":"create-form-visibility-toggle",html:[r.formElementsToggler.saveAsTemplate=h.createElement("span",{"class":"fonticon fonticon-eye"})]},{tag:"div","class":"create-form-field form-group",html:[{tag:"h5","class":"required-form-field",html:[h.createElement("span",{"class":"required-form-field-title-label"+(r.parent.isTemplate?" highlight":" "),html:n.create.finalize.labels.template}),h.createElement("span",{"class":"required-form-field-required-label"+(r.parent.isTemplate?" highlight":" hidden"),html:n.create.required})]},(r.fields.automation.saveAsTemplate=new m({type:"switch",checked:r.parent.isTemplate,label:n.create.finalize.saveAsTemplateToggle,events:{onChange:function(){var s=this;if(s.isChecked()===true){q.show();r.fields.saveAsTemplate.name.focus();r.fields.saveAsTemplate.form.enable();if(r.fields.saveAsTemplate.name.getValue()===""){r.formElements.saveAsTemplate.getElement(".required-form-field-required-label").addClassName("highlight");r.formElements.saveAsTemplate.getElement(".required-form-field-title-label").addClassName("highlight");r.formElements.saveAsTemplate.getElement(".required-form-field-required-label").removeClassName("hidden")}}else{q.hide();r.fields.saveAsTemplate.form.disable();r.formElements.saveAsTemplate.getElement(".required-form-field-required-label").removeClassName("highlight");r.formElements.saveAsTemplate.getElement(".required-form-field-title-label").removeClassName("highlight");r.formElements.saveAsTemplate.getElement(".required-form-field-required-label").addClassName("hidden")}}}})),q]}]});p.inject(r.fields.saveAsTemplate.form.elements.container);if(r.parent.isTemplate===true){q.show();r.fields.saveAsTemplate.form.enable();r.fields.automation.saveAsTemplate.disable()}else{q.hide();r.fields.saveAsTemplate.form.disable()}return r.fields.saveAsTemplate.form},validate:function(){var p=this;return p.form.validate(false,false)},getTasks:function(){var p=this;var q=[];Object.keys(p.fields.automation).forEach(function(r){if("isChecked" in p.fields.automation[r]&&p.fields.automation[r].isChecked()){q.push(r)}});return q},getApprovalValue:function(){var p=this;return p.fields.automation.enableApproval.isChecked()},getValues:function(){var q=this;var p={};if(q.getApprovalValue()===true){p.waitingOn=j.ENABLE_APPROVAL_WAITING_ON}return p},getHiddenAttributes:function(){var q=this;var r={};for(var p in q.formElements){if(h.is(q.formElementsToggler[p])){r[p]=q.formElementsToggler[p].hasClassName("fonticon-eye-off")}}return r},getTemplateValues:function(){var q=this;var p={name:q.fields.saveAsTemplate.name.getValue(),description:q.fields.saveAsTemplate.description.getValue()};if(q.parent.options.editMode&&q._appliedTemplate&&q._appliedTemplate.lastUsed){p.lastUsed=q._appliedTemplate.lastUsed}else{p.lastUsed=null}return p},applyTemplate:function(p){var q=this;return new l(function(r){q.reset().then(function(){q._appliedTemplate=p;if(Array.isArray(p.data.automationTasks)){Object.keys(q.fields.automation).forEach(function(v){if(v!=="saveAsTemplate"&&p.data.automationTasks.indexOf(v)!==-1&&"check" in q.fields.automation[v]){q.fields.automation[v].check();q.fields.automation[v].events.input.change()}if(v==="enableApproval"&&p.data.automationTasks.indexOf(v)===-1){if(q.fields.automation[v].isChecked()){q.fields.automation[v].uncheck()}}})}if(h.is(p.info,"object")){if(h.is(p.info.name,"string")===true){q.fields.saveAsTemplate.name.setValue(p.info.name);q._onTemplateNameChange(p.info.name)}if(h.is(p.info.description,"string")===true){q.fields.saveAsTemplate.description.setValue(p.info.description)}}if(h.is(p.hidden,"object")){if(h.is(q.formElements,"object")&&h.is(q.formElementsToggler,"object")){var t=q.formElements;var u=q.formElementsToggler;for(var s in t){if(p.hidden[s]===true){if(q.parent.isTemplate){if(h.is(t[s])){t[s].toggleClassName("visibility-masked",true)}if(h.is(u[s])){u[s].toggleClassName("fonticon-eye-off",true);u[s].toggleClassName("fonticon-eye",false)}}else{if(h.is(t[s])){t[s].hide()}}}}}}r()})})},reset:function(){var p=this;p._appliedTemplate=null;return new l(function(q){Object.keys(p.fields.automation).forEach(function(r){if("uncheck" in p.fields.automation[r]&&"check" in p.fields.automation[r]){if(p.fields.automation[r].options.checked){p.fields.automation[r].check()}else{p.fields.automation[r].uncheck()}p.fields.automation[r].events.input.change()}});p.fields.saveAsTemplate.description.setValue("");q()})},_onTemplateNameChange:function(q){var p=this;if("fields" in p&&"saveAsTemplate" in p.fields&&"name" in p.fields.saveAsTemplate){if(p.parent&&p.parent.isTemplate){p.parent.updateTitle(q)}if(q===""){p.formElements.saveAsTemplate.getElement(".required-form-field-required-label").addClassName("highlight");p.formElements.saveAsTemplate.getElement(".required-form-field-title-label").addClassName("highlight");p.formElements.saveAsTemplate.getElement(".required-form-field-required-label").removeClassName("hidden")}else{p.formElements.saveAsTemplate.getElement(".required-form-field-required-label").removeClassName("highlight");p.formElements.saveAsTemplate.getElement(".required-form-field-title-label").removeClassName("highlight");p.formElements.saveAsTemplate.getElement(".required-form-field-required-label").addClassName("hidden")}}}});return o});define("DS/IssueComponents/external/Compare",[],function(){var b={TRANSIENT:{WIDTH:700,HEIGHT:800}};var a={execute:function(c){require(["DS/TransientWidget/TransientWidget","DS/IssueServices/Contexts","DS/IssueServices/services/PlatformServices"],function(e,d,g){var i=[];c.forEach(function(j){i.push({envId:g.getTenant(),serviceId:"3DSpace",contextId:"",objectId:j,objectType:"",displayName:""})});if(i.length>0){var f={protocol:"3DXContent",version:"1.1",source:d.get("widget").name,data:{items:i}};var h={mode:"panel",height:b.TRANSIENT.HEIGHT,width:b.TRANSIENT.WIDTH};e.showWidget("ENOCOMP_AP","",{X3DContentId:JSON.stringify(f)},h)}})}};return a});define("DS/IssueComponents/create/Attachments",["UWA/Class/View","UWA/Class/Promise","UWA/Core","DS/ENOFloatingPanel/ENOFloatingPanel","DS/Logger/Logger","DS/PADUtils/views/PADAlert","DS/PlatformAPI/PlatformAPI","DS/UIKIT/Form","DS/UIKIT/Iconbar","DS/UIKIT/Mask","DS/IssueAttachmentManager/components/Collection","DS/IssueAttachmentManager/components/Item","DS/IssueAttachmentManager/services/AttachmentServices","DS/IssueAttachmentManager/views/Catalog","i18n!DS/IssueAttachmentManager/assets/nls/IssueAttachmentManager","DS/IssueCommon/commands/CommandsManager","DS/IssueCommon/utils/Utils","DS/IssueServices/services/IssueServices","DS/IssueServices/services/PlatformServices","DS/IssueServices/Contexts","DS/IssueServices/utils/Performance","i18n!DS/IssueComponents/assets/nls/IssueComponents","css!DS/IssueComponents/IssueComponents.css"],function(s,g,j,o,v,t,e,k,a,x,w,c,n,u,q,b,f,h,m,l,d,i){var p={ISSUE_MANAGEMENT:"ENXISSU_AP",ISSUE_3D_REVIEW:"ENX3DIR_AP"};var r=s.extend({name:"DS/IssueComponents/create/Attachments",tag:"div",className:"create-view-content-subview create-attachments",isInit:null,_deferredInit:{resolve:null,reject:null},setup:function(y){var z=this;z._parent(y);z.parent=y.parent;z.isInit=new g(function(B,A){z._deferredInit.resolve=B;z._deferredInit.reject=A});z._logger=v.getLogger(z.name);z.form=null;z.formElements={attachments:null};z.formElementsToggler={attachments:null};z.fields={attachments:{container:null,iconBar:null,title:null}};z.collection=new w({id:Date.now().toString()});z._deferredInit.resolve()},destroy:function(){var y=this;y.form=null;y.formElements={attachments:null};y.formElementsToggler={attachments:null};y.fields={attachments:{container:null,iconBar:null,title:null}};y.collection=null;y.catalog=null},render:function(){var y=this;y._renderAttachmentsField();y.form=new k({className:"create-attachments-form",fields:[],events:{onInvalid:function(){}}}).inject(y.container);var z=j.createElement("div",{"class":"create-form-content",html:[y.formElements.attachments=j.createElement("div",{"class":"create-form-element create-attachments-form-element-attachments",html:[{tag:"div","class":"create-form-visibility-mask"},{tag:"div","class":"create-form-visibility-toggle",html:[y.formElementsToggler.attachments=j.createElement("span",{"class":"fonticon fonticon-eye"})]},{tag:"div","class":"create-form-field form-group",html:[y.fields.attachments.title,y.fields.attachments.container]},{tag:"div","class":"create-form-help",html:[j.createElement("div",{"class":"create-form-help-content",html:[j.createElement("span",{"class":"fonticon fonticon-help"}),i.create.attachments.labels.attachmentsHelper]})]}]})]});z.inject(y.form.elements.container);return y},_renderAttachmentsField:function(){var y=this;y.fields.attachments.title=j.createElement("div",{"class":"create-form-title-with-iconbar",html:[{tag:"h5",html:i.create.attachments.labels.attachments}]});y.fields.attachments.iconBar=new a({renderTo:y.fields.attachments.title,items:[{id:"screenshot",fonticon:"camera",text:i.create.attachments.screenshotAvailable,selectable:true,handler:function(){y._screenshot()}},{id:"attachFromLocalDisk",fonticon:"upload",text:i.create.attachments.attach.fromLocalDisk,selectable:false,handler:function(){y._onRequestAttachFromLocalDisk()}},{id:"attachFrom3DX",text:i.create.attachments.attach.from3DX,fonticon:"list-add",selectable:false,handler:function(){y._onRequestAttachFrom3DX()}},{className:"divider"},{id:"setAsPrimary",fonticon:"star",text:q.views.Header.Iconbar.actions.setAsPrimary,selectable:true,handler:function(){var A=y.collection.getSelectedItems();var B=A[0];var D=y.collection.filter(function(F){return F.get("isPrimary")===true});var E=D.some(function(F){return F.get("id")===B.get("id")});if(E){B.set("isPrimary",false)}else{for(var z=0;z<y.collection.size();z++){var C=y.collection.at(z);if(C.id!==B.id){C.set("isPrimary",false)}else{C.set("isPrimary",true)}}}}},{id:"remove",fonticon:"trash",text:i.create.attachments.remove,selectable:false,handler:function(){var z=y.collection.getSelectedItems();y.collection.unselectAll();y.collection.remove(z)}},{className:"divider"},{id:"switchCatalogLayout",type:"checkbox",fonticon:"view-list",text:q.views.Header.Iconbar.actions.switchCatalogLayout,selectable:true,handler:function(){y.catalog.switchLayout(y.catalog.layout%2+1)}}]});y.fields.attachments.iconBar.disableItem("remove");y.fields.attachments.iconBar.disableItem("setAsPrimary");y.fields.attachments.container=j.createElement("div",{"class":"create-form-attachments-container"});y.catalog=new u({collection:y.collection,layout:1}).render().inject(y.fields.attachments.container);y.listenTo(y.catalog,"onSwitchLayout",y._onCatalogSwitchLayout.bind(y));y.listenTo(y.catalog,"request:attachFrom3DX",y._onRequestAttachFrom3DX.bind(y));y.listenTo(y.catalog,"request:attachFromLocalDisk",y._onRequestAttachFromLocalDisk.bind(y));y.listenTo(y.collection,"onSelect",y._onCollectionSelect.bind(this));y.listenTo(y.collection,"onUnselect",y._onCollectionSelect.bind(this));y._addDropEvent(y.catalog.container)},reset:function(){var y=this;return new g(function(z){y.collection.reset();y.fields.attachments.iconBar.disableItem("remove");y.fields.attachments.iconBar.disableItem("setAsPrimary");z()})},getValues:function(z){var A=this;var y={attachments:[],primaryAttachment:null};if(z){y.attachments=A.collection.filter(function(B){return !B.get("isFile")}).map(function(B){if(B.get("isPrimary")){y.primaryAttachment=B.id}return B.get("id")})}return y},getHiddenAttributes:function(){var z=this;var A={};for(var y in z.formElements){if(j.is(z.formElementsToggler[y])){A[y]=z.formElementsToggler[y].hasClassName("fonticon-eye-off")}}return A},applyTemplate:function(y){var z=this;return z.reset().then(function(){if(j.is(y.hidden,"object")){if(j.is(z.formElements,"object")&&j.is(z.formElementsToggler,"object")){var B=z.formElements;var C=z.formElementsToggler;for(var A in B){if(y.hidden[A]===true){if(z.parent.isTemplate){if(j.is(B[A])){B[A].toggleClassName("visibility-masked",true)}if(j.is(C[A])){C[A].toggleClassName("fonticon-eye-off",true);C[A].toggleClassName("fonticon-eye",false)}}else{if(j.is(B[A])){B[A].hide()}}}}}}if(j.is(y.data,"object")&&y.data.hasOwnProperty("attachments")&&y.data.attachments.length>0){return n.getDocuments(y.data.attachments).then(function(E){if(!j.is(E.attachments,"array")){return g.resolve()}else{if(E.attachments.length!==y.data.attachments.length){t.displayNotification({msg:i.create.templateApplyWarningAttachments,eventID:"warning"});if(E.attachments.length===0){return g.resolve()}}var D=E.attachments.map(function(F){return F.id});return n.fetch(D).then(function(G){if(!j.is(G.results,"array")||G.results.length!==D.length){throw new Error("Unexpected number of fetch results for attachments.")}else{var H=G.results.map(function(I){return n.parseFromFetch(I)});if(y.data.primaryAttachment){for(var F=0;F<H.length;F++){if(y.data.primaryAttachment===H[F].id){H[F].isPrimary=true}}}return z._addObjects(H)}})}})}else{return g.resolve()}})},_addFiles:function(C){var B=this;var y=[];for(var A=0;A<C.length;A++){var z=C[A];var E="temporary_"+Math.floor(Date.now())+"_"+A;var G=z.type;var F={id:E,title:z.name,type:"Document",owner:{firstName:e.getUser().firstName,fullName:e.getUser().firstName.trim()+" "+e.getUser().lastName.trim(),lastName:e.getUser().lastName,user:e.getUser().login},relOwner:{firstName:e.getUser().firstName,fullName:e.getUser().firstName.trim()+" "+e.getUser().lastName.trim(),lastName:e.getUser().lastName,user:e.getUser().login},relOriginated:(new Date()).toString()};if(z.hasOwnProperty("lastModifiedDate")){if(z.lastModifiedDate instanceof Date){F.modified=z.lastModifiedDate.toString();F.created=z.lastModifiedDate.toString()}else{F.modified=(new Date(z.lastModifiedDate)).toString();F.created=(new Date(z.lastModifiedDate)).toString()}}else{F.modified=(new Date()).toString();F.created=(new Date()).toString()}var D=new c(F);D.setDocumentTypeByMIME(G);D.set("isFile",true);D.set("file",z);y.push(D)}B.collection.add(y);y.forEach(function(H){if(H.get("documentType")==="image"){f.readImageURI(H.get("file")).then(function(I){H.set("thumbnailUrl",I)});if(B.collection.size()===1){H.set("isPrimary",true)}}})},_addObjects:function(H){var F=this;var E=H.filter(function(K){return F.collection.get(K.id)===undefined});if(E.length!==H.length){t.displayNotification({msg:q.replace(q.notifications.Attach.alreadyAttached,{count:H.length-E.length}),eventID:"warning"})}if(E.length>0){var y=[];for(var D=0;D<E.length;D++){var J=E[D];J.relOwner={firstName:e.getUser().firstName,fullName:e.getUser().firstName.trim()+" "+e.getUser().lastName.trim(),lastName:e.getUser().lastName,user:e.getUser().login};var I=new c(J);y.push(I)}F.collection.add(y);var z=[];var C=[];for(var B=0;B<y.length;B++){var A=y[B];z.push(A.id);if(A.get("type")==="Document"){C.push(A.id)}}var G=[g.resolve()];if(z.length>0){G.push(n.fetch(z).then(function(L){for(var N=0;N<L.results.length;N++){var Q=L.results[N].attributes.find(function(R){return R.name==="resourceid"}).value;var M=F.collection.get(Q);if(M){M.set("isProcessing",true);var K=L.results[N].attributes.find(function(R){return R.name==="owner"});var O=L.results[N].attributes.find(function(R){return R.name==="ds6w:responsible"});if(K&&K.value&&O&&O.value){M.set("owner",{user:K.value,fullName:O.value,firstName:"",lastName:""})}var P=L.results[N].attributes.find(function(R){return R.name==="ds6w:docextension"});if(P&&P.value){M.setDocumentType(P.value)}if(F.collection.size()===1&&M.get("documentType")==="image"){M.set("isPrimary",true)}M.set("isProcessing",false)}}})["catch"](function(K){t.displayNotification({msg:i.replace(q.notifications.Fetch.failure),eventID:"error"});F._logger.error(K)}))}if(C.length>0){G.push(n.downloadDocuments(C).then(function(M){for(var L=0;L<M.length;L++){var N=M[L].id;var K=F.collection.get(N);if(K){if(M[L].downloadUrl&&M[L].errorMessage===undefined){K.set("contentUrl",M[L].downloadUrl)}}}})["catch"](function(K){t.displayNotification({msg:i.replace(q.notifications.Download.failure),eventID:"error"});F._logger.error(K)}))}}},_screenshot:function(){var E=this;var B=(l.get("widget").name===p.ISSUE_3D_REVIEW);if(j.is(E.parent)&&j.is(E.parent.elements)&&j.is(E.parent.elements.dialog)){E.parent.elements.dialog.hide()}if(!B){var F=l.get("component");var y=F.taskManager.addTakeScreenshotTask(function z(N){var I=N.data;var O=N.fileName;var R=N.fileType;var J=N.lastModified;var M=atob(I.split(",")[1]);var Q=new ArrayBuffer(M.length);var L=new Uint8Array(Q);for(var P=0;P<M.length;P++){L[P]=M.charCodeAt(P)}var K=new File([Q],O,{type:R,lastModified:J});E._addFiles([K]);if(j.is(E.parent)&&j.is(E.parent.elements)&&j.is(E.parent.elements.dialog)){E.parent.elements.dialog.show()}F.unmaskForTask(y)},function C(){if(j.is(E.parent)&&j.is(E.parent.elements)&&j.is(E.parent.elements.dialog)){E.parent.elements.dialog.show()}F.unmaskForTask(y)});F.maskForTask(y,i.tasks.addAttachments)}else{var G=l.get("component");G.utils.takeAnnotation(function A(J){var I=J.blob;I.lastModifiedDate=new Date();I.name="screenshot-"+Math.floor(Date.now())+".png";E._addFiles([I]);E.parent.elements.dialog.show()},function H(){E.parent.elements.dialog.show()},function D(I){E._logger.error(I)})}},_onCollectionSelect:function(){var y=this.collection.getSelectedItems();if(y.length>0){this.fields.attachments.iconBar.enableItem("remove");if(y.length===1&&y[0].get("documentType")==="image"){this.fields.attachments.iconBar.enableItem("setAsPrimary")}else{this.fields.attachments.iconBar.disableItem("setAsPrimary")}}else{this.fields.attachments.iconBar.disableItem("remove");this.fields.attachments.iconBar.disableItem("setAsPrimary")}},_onCatalogSwitchLayout:function(){this.fields.attachments.iconBar.getItem("switchCatalogLayout").elements.icon.toggleClassName("fonticon-view-small-thb",(this.catalog.layout+1)%2===1);this.fields.attachments.iconBar.getItem("switchCatalogLayout").elements.icon.toggleClassName("fonticon-view-list",this.catalog.layout%2===1)},_onDrop:function(A){var z=this;A.preventDefault();A.stopPropagation();var B=n.parseFromDragEvent(A);if(B.hasOwnProperty("files")&&(B.files instanceof FileList)){z._addFiles(B.files)}else{if(f.isValid3DXContent(B)){var y=B.data.items.map(function(C){return C.objectId});n.fetch(y).then(function(C){if(j.is(C.results,"array")){var D=C.results.map(function(E){return n.parseFromFetch(E)});z._addObjects(D)}else{throw new Error("Unexpected empty fetch results.")}})["catch"](function(C){t.displayNotification({msg:i.replace(q.notifications.Attach.failure,{count:y.length}),eventID:"error"});z._logger.error(C)})}else{t.displayNotification({msg:i.notifications.Drop.unsupported,eventID:"error"})}}},_onRequestAttachFrom3DX:function(){var B=this;var C=l.get("application");var E=j.is(C,"object")&&C.isStandalone;if(E){var A=l.get("component");var z=A.taskManager.addObjectsTask(function D(G){if(Array.isArray(G.physicalIds)){var F=G.physicalIds;n.fetch(F).then(function(H){if(!j.is(H.results,"array")||H.results.length!==F.length){throw new Error("Unexpected number of fetch results for attachments.")}else{var I=H.results.map(function(J){return n.parseFromFetch(J)});return B._addObjects(I)}})["finally"](function(){B.parent.elements.dialog.show();A.unmaskForTask(z)})}else{B.parent.elements.dialog.show();A.unmaskForTask(z)}},function y(){B.parent.elements.dialog.show();A.unmaskForTask(z)});A.maskForTask(z,i.tasks.addAttachments)}else{m.search({title:q.Attach.SearchTitle,default_search_criteria:"",multiSel:true,callback:function(G){var F=G.map(function(H){return n.parseFromSearch(H)});B._addObjects(F)},cancel:function(){}})}},_onRequestAttachFromLocalDisk:function(){var y=this;n.browseFileFromLocalDisk().then(y._addFiles.bind(y))["catch"](function(z){t.displayNotification({msg:q.replace(q.notifications.BrowseFile.failure),eventID:"error"});y._logger.error(z)})},_addDropEvent:function(A){var z=this;var y=0;A.addEventListener("drop",function(){A.removeClassName("dragenter");z._onDrop.apply(z,arguments)});A.addEventListener("dragenter",function(){A.addClassName("dragenter");y++});A.addEventListener("dragleave",function(){y--;if(y<=0){A.removeClassName("dragenter")}});A.addEventListener("mouseleave",function(){y--;if(y<=0){A.removeClassName("dragenter")}});document.addEventListener("dragover",function(B){B.preventDefault();B.dataTransfer.dropEffect="copy";B.dataTransfer.effectAllowed="copy"})}});return r});define("DS/IssueComponents/external/WhereUsed",[],function(){var b={TRANSIENT:{WIDTH:700,HEIGHT:800}};var a={execute:function(c){require(["DS/TransientWidget/TransientWidget","DS/IssueServices/Contexts","DS/IssueServices/services/PlatformServices"],function(e,d,g){var i=[];c.forEach(function(j){i.push({envId:g.getTenant(),serviceId:"3DSpace",contextId:"",objectId:j,objectType:"",displayName:""})});if(i.length>0){var f={protocol:"3DXContent",version:"1.1",source:d.get("widget").name,data:{items:i}};var h={mode:"panel",height:b.TRANSIENT.HEIGHT,width:b.TRANSIENT.WIDTH};e.showWidget("ENORIPE_AP","",{X3DContentId:JSON.stringify(f)},h)}})}};return a});define("DS/IssueComponents/external/History",[],function(){var b={TRANSIENT:{WIDTH:700,HEIGHT:800}};var a={execute:function(c){require(["DS/TransientWidget/TransientWidget","DS/IssueServices/Contexts","DS/IssueServices/services/PlatformServices"],function(e,d,g){var i=[];c.forEach(function(j){i.push({envId:g.getTenant(),serviceId:"3DSpace",contextId:"",objectId:j,objectType:"",displayName:""})});if(i.length>0){var f={protocol:"3DXContent",version:"1.1",source:d.get("widget").name,data:{items:i}};var h={mode:"panel",height:b.TRANSIENT.HEIGHT,width:b.TRANSIENT.WIDTH};e.showWidget("ENOLCMI_AP","",{X3DContentId:JSON.stringify(f)},h)}})}};return a});define("DS/IssueComponents/create/Custom",["UWA/Class/Promise","UWA/Class/View","UWA/Core","DS/UIKIT/Form","DS/UIKIT/Input/Date","DS/UIKIT/Input/Text","DS/IssueServices/services/IssueServices","i18n!DS/IssueComponents/assets/nls/IssueComponents","css!DS/IssueComponents/IssueComponents.css"],function(h,a,d,g,e,b,c,i){var f={CUSTOM_PROPERTY_TYPE:{MEMO:"textarea",DATE:"timestamp",TEXT:"string"}};var j=a.extend({name:"DS/IssueComponents/create/Custom",tag:"div",className:"create-view-content-subview create-custom",isInit:null,_deferredInit:{resolve:null,reject:null},setup:function(k){var l=this;l._parent(k);l.parent=k.parent;l.isInit=new h(function(o,n){l._deferredInit.resolve=o;l._deferredInit.reject=n});l.formElements={};l.formElementsToggler={};l.fields={};l.noShow=true;l._customProperties=[];var m=new h(function(o,n){c.custom.getCustomAttributes({onComplete:function(p){var q=p.body;if(Array.isArray(q)&&q.length>0){l._customProperties=q;l.noShow=false}o()},onFailure:function(p){n(p)}})});m.then(l._deferredInit.resolve)["catch"](l._deferredInit.reject)},destroy:function(){var l=this;l.form=null;var k=Object.keys(l.fields);k.forEach(function(m){l.fields[m]=null;l.formElements[m]=null;l.formElementsToggler[m]=null})},render:function(){var k=this;k.form=new g({className:"create-properties-form",fields:[],events:{onInvalid:function(){}}}).inject(k.container);var l=d.createElement("div",{"class":"create-form-content"});k._customProperties.forEach(function(p,n){var m=k.getLabel(p);var r=k.getPlaceholder(p);var o=k.getHelper(p);switch(p.type){case f.CUSTOM_PROPERTY_TYPE.DATE:var q=k.formElements[p.name]=d.createElement("div",{"class":"create-form-element create-properties-form-element-date",html:[{tag:"div","class":"create-form-visibility-mask"},{tag:"div","class":"create-form-visibility-toggle",html:[k.formElementsToggler[p.name]=d.createElement("span",{"class":"fonticon fonticon-eye"})]},{tag:"div","class":"create-form-field form-group",html:[{tag:"h5",html:m},(k.fields[p.name]=new e({name:p.name,id:p.name,required:false,placeholder:r,events:{onChange:function(){var u=this.getDate();if(u!==null){k._customProperties[n].value=(u.getMonth()+1)+"/"+u.getDate()+"/"+u.getFullYear()}}}}))]},{tag:"div","class":"create-form-help",html:[d.createElement("div",{"class":"create-form-help-content",html:[d.createElement("span",{"class":"fonticon fonticon-help"}),o]})]}]});k.fields[p.name].reset=function(){this.setValue("")};k.fields[p.name].setVal=function(u){this.setDate(u)};q.inject(l);break;case f.CUSTOM_PROPERTY_TYPE.TEXT:case f.CUSTOM_PROPERTY_TYPE.MEMO:default:var t=p.type===f.CUSTOM_PROPERTY_TYPE.MEMO;var s=k.formElements[p.name]=d.createElement("div",{"class":"create-form-element create-properties-form-element-text",html:[{tag:"div","class":"create-form-visibility-mask"},{tag:"div","class":"create-form-visibility-toggle",html:[k.formElementsToggler[p.name]=d.createElement("span",{"class":"fonticon fonticon-eye"})]},{tag:"div","class":"create-form-field form-group",html:[{tag:"h5",html:m},(k.fields[p.name]=new b({name:p.name,id:p.name,className:"",value:"",multiline:t,required:false,placeholder:r,events:{onChange:function(){k._customProperties[n].value=this.getValue()}}}))]},{tag:"div","class":"create-form-help",html:[d.createElement("div",{"class":"create-form-help-content",html:[d.createElement("span",{"class":"fonticon fonticon-help"}),o]})]}]});k.fields[p.name].reset=function(){this.setValue("")};k.fields[p.name].setVal=function(u){this.setValue(u)};s.inject(l);break}});l.inject(k.form.elements.container);return k},show:function(){var k=this;k._parent();if(k.fields[k._customProperties[0].name]&&"focus" in k.fields[k._customProperties[0].name]){k.fields[k._customProperties[0].name].focus()}},hide:function(){var k=this;k._parent()},validate:function(){var k=false;k=this.form.validate(false,false);return k},getValues:function(){var l=this;var k={custom:{},};l._customProperties.forEach(function(m){k.custom[m.name]=m.value});return k},getHiddenAttributes:function(){var l=this;var m={custom:{}};for(var k in l.formElements){if(d.is(l.formElementsToggler[k])){m.custom[k]=l.formElementsToggler[k].hasClassName("fonticon-eye-off")}}return m},reset:function(){var k=this;k._customProperties.forEach(function(l){l.value="";k.fields[l.name].reset()})},applyTemplate:function(m){var o=this;o.reset();if(d.is(m.data,"object")&&d.is(m.data.custom,"object")){o._customProperties.forEach(function(p){if(d.is(m.data.custom[p.name],"string")){p.value=m.data.custom[p.name];o.fields[p.name].setVal(m.data.custom[p.name])}})}if(d.is(m.hidden,"object")&&d.is(m.hidden.custom,"object")){if(d.is(o.formElements,"object")&&d.is(o.formElementsToggler,"object")){var l=o.formElements;var n=o.formElementsToggler;for(var k in l){if(m.hidden.custom[k]===true){if(o.parent.isTemplate){if(d.is(l[k])){l[k].toggleClassName("visibility-masked",true)}if(d.is(n[k])){n[k].toggleClassName("fonticon-eye-off",true);n[k].toggleClassName("fonticon-eye",false)}}else{if(d.is(l[k])){l[k].hide()}}}}}}return h.resolve()},getLabel:function(m){var l="";var k=i.create.properties.custom;if(k!==undefined){var n=k[m.name];if(n!==undefined){l=n.label}}if(l===""||l===undefined){l=m.title}if(l===""||l===undefined){l=m.name}return l},getPlaceholder:function(l){var m="";var k=i.create.properties.custom;if(k!==undefined){var n=k[l.name];if(n!==undefined){m=n.placeholder}}if(m===""||m===undefined){m=l.title}if(m===""||m===undefined){m=l.name}return m},getHelper:function(m){var l="";var k=i.create.properties.custom;if(k!==undefined){var n=k[m.name];if(n!==undefined){l=n.helper}}if(l===""||l===undefined){l=m.title}if(l===""||l===undefined){l=m.name}return l}});return j});define("DS/IssueComponents/duplicate/Duplicate",["UWA/Class/Promise","UWA/Class/View","UWA/Core","DS/UIKIT/Input/Button","DS/UIKIT/Input/Text","DS/UIKIT/Tooltip","DS/UIKIT/Input/Toggle","DS/UIKIT/Mask","DS/UIKIT/Scroller","DS/Controls/SpinBox","DS/ENOFloatingPanel/ENOFloatingPanel","DS/Logger/Logger","DS/PADUtils/views/PADAlert","DS/PlatformAPI/PlatformAPI","DS/IssueServices/Contexts","DS/IssueServices/services/PlatformServices","DS/IssueServices/services/IssueServices","DS/IssueServices/utils/Performance","i18n!DS/IssueComponents/assets/nls/IssueComponents","css!DS/IssueComponents/IssueComponents.css"],function(c,m,g,j,n,o,l,s,q,e,k,r,p,b,h,i,d,a,f){return m.extend({name:"DS/IssueComponents/duplicate/Duplicate",tag:"div",className:"duplicate-view",_logger:null,defaultOptions:{physicalIds:[]},physicalIds:[],issues:{},duplicateIssues:[],modal:null,confirm:null,validate:null,isLoaded:null,_deferred:{resolve:null,reject:null},setup:function(t){var u=this;u._parent(t);u._logger=r.getLogger("DS/IssueComponents/components");u._logger.log("Initializing the duplicate component");u.issues={};u.modal=null;u.validate=null;u.confirm=null;u.isLoaded=null;u._deferred={resolve:null,reject:null};u.isLoaded=new c(function(w,v){u._deferred.resolve=w;u._deferred.reject=v})},render:function(){var t=this;a.start(t.name+" render");t.dialog().then(function(){t._deferred.resolve()},function(){t._deferred.reject()});a.end(t.name+" render");return t},destroy:function(){var t=this;a.start(t.name+" destroy");t.physicalIds=[];t.issues={};t.duplicateIssues=[];t.confirm.destroy();t.confirm=null;t.modal.destroy();t.modal=null;t.validate=null;t.isLoaded=null;t._deferred={resolve:null,reject:null};a.end(t.name+" destroy")},dialog:function(){var t=this;var u=h.get("widget");s.mask(t.container);t.modal=new k({animate:true,autocenter:true,closable:true,limitParent:false,overlay:true,resizable:true,visible:true,className:"duplicate-issues-dialog",title:f.duplicate.preparing,header:null,body:t.container,footer:[t.validate=new j({value:f.duplicate.duplicate,className:"primary",events:{onClick:function(){t._duplicate()}},disabled:true}),new j({value:f.duplicate.cancel,events:{onClick:function(){t.destroy()}}})],events:{onClose:function(){t.destroy()}}}).inject(u.body);return t.build().then(function(v){new q({element:v}).inject(t.container);t.elements.optionsButton=new l({type:"switch",className:"options-button",checked:false,label:f.duplicate.advancedOptions,events:{onChange:function(){t.displayOptions()}}}).inject(t.container);t.elements.Options=g.createElement("div",{"class":"options-view"}).inject(t.container);t.elements.keepAttachments=new l({type:"checkbox",className:"keep-attachments toggle-primary",checked:false,label:f.duplicate.keepAttachments}).inject(t.elements.Options);t.elements.copyCount=g.createElement("div",{"class":"copy-count",html:[{tag:"span","class":"title-copy-count",html:f.duplicate.copyCount},t.count=new e({minValue:1,maxValue:20,stepValue:1,pageStepValue:1})]}).inject(t.elements.Options);t.elements.titleOptions=g.createElement("div",{"class":"title-options-view",html:[{tag:"span","class":"title-modifier",html:f.duplicate.titleModifier}]}).inject(t.elements.Options);g.createElement("div",{"class":"advanced-options-item",html:[{tag:"span","class":"advanced-options-label",html:f.duplicate.replace},t.replaceHelp=g.createElement("span",{"class":"fonticon fonticon-help"}),t.replace=(new n({className:"advanced-options-text",placeholder:f.duplicate.replacePlaceholder}))]}).inject(t.elements.titleOptions);g.createElement("div",{"class":"advanced-options-item",html:[{tag:"span","class":"advanced-options-label",html:f.duplicate.suffix},t.suffixHelp=g.createElement("span",{"class":"fonticon fonticon-help"}),t.suffix=(new n({className:"advanced-options-text",placeholder:f.duplicate.suffixPlaceholder}))]}).inject(t.elements.titleOptions);g.createElement("div",{"class":"advanced-options-item",html:[{tag:"span","class":"advanced-options-label",html:f.duplicate.prefix},t.prefixHelp=g.createElement("span",{"class":"fonticon fonticon-help"}),t.prefix=(new n({className:"advanced-options-text",placeholder:f.duplicate.prefixPlaceholder}))]}).inject(t.elements.titleOptions);g.createElement("div",{"class":"advanced-options-item",html:[{tag:"span","class":"advanced-options-label",html:f.duplicate.iterator},t.iteratorHelp=g.createElement("span",{"class":"fonticon fonticon-help"}),(t.iterator=new n({className:"advanced-options-text",placeholder:f.duplicate.iteratorPlaceholder}))]}).inject(t.elements.titleOptions);t.replaceTooltip=new o({target:t.replaceHelp,body:f.duplicate.replaceHelp});t.suffixTooltip=new o({target:t.suffixHelp,body:f.duplicate.suffixHelp});t.suffixTooltip=new o({target:t.prefixHelp,body:f.duplicate.prefixHelp});t.suffixTooltip=new o({target:t.iteratorHelp,body:f.duplicate.iteratorHelp});t.elements.Options.hide();t.validate.enable();t.modal.setTitle(f.replace(f.duplicate.title,{number:t.physicalIds.length}));t.buildConfirmationDialog();t.confirm.hide();t.validate.focus();s.unmask(t.container)})},build:function(){var t=this;a.start(t.name+" build");return t._check(t.getOption("physicalIds")).then(function(x){var w=[];for(var v=0;v<t.physicalIds.length;v++){var u=x[t.physicalIds[v]];var y=u.title+" ("+u.name+")";w.push(g.createElement("li",{html:[{tag:"span","class":"fonticon fonticon-issue "+u.state.toLowerCase()},y],title:y}))}a.end(t.name+" build");return g.createElement("div",{html:[{tag:"div","class":"duplicate-issues-label",html:[{tag:"span","class":"duplicate-issues-label",html:f.duplicate.content}]},{tag:"div","class":"duplicate-issues-content",html:g.createElement("ul",{html:w,"class":"duplicate-issues-content-list"})}]})})},displayOptions:function(){var v=this;var t=v.elements.optionsButton.isChecked();var u=null;var w=null;if(t){v.elements.Options.show();u=v.elements.Options.getSize();w=v.modal.elements.container.getSize();w.height=w.height+u.height;v.modal.setNewSize(w)}else{u=v.elements.Options.getSize();w=v.modal.elements.container.getSize();w.height=w.height-u.height;v.modal.setNewSize(w);v.elements.Options.hide()}},_check:function(u){var t=this;a.start(t.name+" _check");return d.issues.retrieve({data:{objects:u.reduce(function(w,v){w.push({physicalId:v});return w},[])}}).then(function(w){var x={};for(var y=0;y<w.length;y++){var v=w[y].body;x[v.physicalId]={physicalId:v.physicalId,name:v.name,state:v.state,title:v.title?v.title:""}}t.physicalIds=u;t.issues=x;return x},function(v){t._logger.error(v);p.displayNotification({msg:f.duplicate.error,eventID:"error"})})["finally"](function(){a.end(t.name+" _check")})},_duplicate:function(){var y=this;a.start(y.name+" _duplicate");y.duplicateIssues=[];var B=false;var x=1;var I=y.elements.optionsButton.isChecked();var D=y.physicalIds.length;var t="",A="";for(var E=0;E<D;E++){var u=y.physicalIds[E];var K=y.issues[u].title;var G=K;if(I){B=y.elements.keepAttachments.isChecked();x=y.count.value;var H="",F="";var J=y.replace.getValue();if(J!==null&&J.length>1){H=J.split(":")[0];F=J.split(":")[1]}var v=y.suffix.getValue();var z=y.prefix.getValue();t=y.iterator.getValue();if(H.length>0&&F.length>0){G=y.replaceTitle(G,H,F)}if(t.length>0){A=y.findIterator(K,t);var w=y.nextIterator(A);if(w!==null&&w.length>0){G=y.replaceIterator(G,A,w)}A=w}if(z.length>0){G=z+G}if(v){G=G+v}}y.duplicateIssues.push({issue:y.issues[u],newTitle:G,keepAttachments:B});for(var C=1;C<x;C++){if(t.length>0){var w=y.nextIterator(A);G=y.replaceIterator(G,A,w);A=w}y.duplicateIssues.push({issue:y.issues[u],newTitle:G,keepAttachments:B})}}if(I){y.confirmDuplication()}else{y.duplicate(y.duplicateIssues).then(function(){y.destroy()})}},duplicate:function(t){var u=this;a.start(u.name+" duplicate");u.validate.setDisabled();u.confirmButton.setDisabled();var v=h.get("widget");s.mask(v.body);return d.issues.duplicate({data:{objects:t.map(function(w){return{physicalId:w.issue.physicalId,title:w.newTitle,attachments:w.keepAttachments}})}}).then(function(x){var y="";if(u.count.value>1){y=f.replace(f.duplicate.multipleCopiesSuccess,{number:u.physicalIds.length,multiplication:u.count.value})}else{if(u.physicalIds.length===1){y=f.replace(f.duplicate.singleSuccess,{title:u.issues[u.physicalIds[u.physicalIds.length-1]].title+" ("+u.issues[u.physicalIds[u.physicalIds.length-1]].name+")"})}else{y=f.replace(f.duplicate.multipleSuccess,{number:u.physicalIds.length})}}s.unmask(v.body);p.displayNotification({msg:y,eventID:"success"});var z=x.reduce(function(B,A){B.push([A.body.physicalId]);return B},[]),w=x.reduce(function(B,A){B[A.body.physicalId]=A.body;return B},{});a.end(u.name+" _duplicate");b.publish("DS/Object/create",{metadata:{appId:v.id,appName:v.name,timestamp:Math.floor(Date.now())},data:{paths:z,attributes:w},version:"1.0"})},function(w){s.unmask(v.body);p.displayNotification({msg:f.duplicate.error,eventID:"error"});u._logger.error("Cannot duplicate the selected issue(s) because %o",w);a.end(u.name+" _duplicate")})},replaceTitle:function(z,x,y){if(x.length===0||y.length===0){return z}var t=x;t=t.replace(/[-[\]{}()*+?\\^$]/g,"\\$&");var w=t.concat("|",x);var v=null;try{v=new RegExp(w,"i")}catch(u){v=new RegExp(t,"i")}return z.replace(v,y)},findIterator:function(y,t){var x=null;try{x=new RegExp(t,"i")}catch(u){t=t.replace(/[-[\]{}()*+?\\^$]/g,"\\$&");x=new RegExp(t,"i")}var w=x.exec(y);var v=null;if(w!==null){v=w[w.length-1]}return v},nextIterator:function(u){var t=null;if(u!==null){var x=(new RegExp("[0-9]+")).exec(u);if(x!==null){var y="";x.forEach(function(z){y=y+z});var v=parseInt(y);var w=v+1;t=u.replace(v.toString(),w.toString())}}return t},replaceIterator:function(w,z,t){var y=w;if(t!==null&&t.length>0){var x=w.lastIndexOf(z);if(x!==-1){var u=w.substring(0,x);var v=w.substring(x+z.length);y=u+t+v}}return y},buildConfirmationDialog:function(){var t=this;var u=h.get("widget");t.confirmMsgCont=new q();t.confirm=new k({animate:true,autocenter:true,closable:true,limitParent:false,overlay:true,resizable:true,visible:false,className:"duplicate-confirm-dialog",title:f.replace(f.duplicate.confirmTitle,{number:t.physicalIds.length}),header:null,body:t.confirmMsgCont,footer:[t.confirmButton=new j({value:f.duplicate.confirm,className:"primary",events:{onClick:function(){t.duplicate(t.duplicateIssues).then(function(){t.destroy()})}},disabled:false}),new j({value:f.duplicate.cancel,events:{onClick:function(){t.modal.show();t.confirm.hide()}}})],events:{onClose:function(){t.modal.show();t.confirm.hide()}}}).inject(u.body)},confirmDuplication:function(){var v=this;v.modal.hide();v.confirmMsgCont.getInnerElement().empty();var u={};Object.keys(v.issues).forEach(function(x){u[x]={title:v.issues[x].title,newTitles:[]}});v.duplicateIssues.forEach(function(x){u[x.issue.physicalId].newTitles.push(x.newTitle)});var t=g.createElement("div",{});var w="";Object.keys(u).forEach(function(y,x){w=w+f.replace(f.duplicate.confirmMsg,{title:u[y].title});u[y].newTitles.forEach(function(z){w=w+"<br> - "+z});if(x<Object.keys(u).length-1){w=w+"<hr>"}});g.createElement("span",{html:w}).inject(t);v.confirm.show();t.inject(v.confirmMsgCont.getInnerElement());v.confirm.onResize()}})});define("DS/IssueComponents/search/PeopleSearchUI",["DS/SearchWidget/componentUI/SearchWidgetUI","i18n!DS/IssueComponents/assets/nls/IssueComponents"],function(a,c){var b={SELECTION_CLASS:"js-selected"};return a.extend({init:function(e){var f=this;f._parent(e);var d=f.searchInput.options.events.onKeyDown;f.searchInput.removeEvent("onKeyDown");f.searchInput.addEvent("onKeyDown",function(h){if(h.which===13){var g=f.filterAreaContent.getElement("."+b.SELECTION_CLASS);if(g!==null){var i=f._elementIsButton(g);if(i){f.selectNextOrPreviousResult("previous");g.click();f.selectNextOrPreviousResult("next")}else{f.__setInput(g)}}else{f.hideLoadingGif();f.ClearDialog();f.dispatchEvent("onExpressSearch",f.searchInput.getValue())}}else{f.hideLoadingGif();f.ClearDialog();d(h)}});f._raiseError=f.raiseError;f.raiseError=function(g){f.customRaiseError(g)}},customRaiseError:function(d){var e=this;if(d.customClass==="SW_WarningNotFound"){if(e.searchInput.getValue().contains(";")){d.code="info";d.message=c.search.info.expressSearch}}e._raiseError(d)}})});define("DS/IssueComponents/delete/Delete",["UWA/Class/Promise","UWA/Class/View","UWA/Core","DS/UIKIT/Input/Button","DS/UIKIT/Mask","DS/UIKIT/Scroller","DS/ENOFloatingPanel/ENOFloatingPanel","DS/Logger/Logger","DS/PADUtils/views/PADAlert","DS/PlatformAPI/PlatformAPI","DS/IssueServices/Contexts","DS/IssueServices/services/PlatformServices","DS/IssueServices/services/IssueServices","DS/IssueServices/utils/Performance","i18n!DS/IssueComponents/assets/nls/IssueComponents","css!DS/IssueComponents/IssueComponents.css"],function(n,c,j,m,i,g,k,f,b,o,e,a,h,d,p){var l={CREATE_STATE:"Create"};return c.extend({name:"DS/IssueComponents/delete/Delete",tag:"div",className:"delete-view",_logger:null,defaultOptions:{physicalIds:[]},physicalIds:[],issues:{},titles:[],names:[],indelible:[],modal:null,validate:null,isLoaded:null,_deferred:{resolve:null,reject:null},setup:function(q){var r=this;r._parent(q);r._logger=f.getLogger("DS/IssueComponents/components");r._logger.log("Initializing the delete component");r.issues={};r.titles=[];r.names=[];r.indelible=[];r.validate=null;r.modal=null;r.isLoaded=null;r._deferred={resolve:null,reject:null};r.isLoaded=new n(function(t,s){r._deferred.resolve=t;r._deferred.reject=s})},render:function(){var q=this;d.start(q.name+" render");q.dialog().then(function(){q._deferred.resolve()},function(){q._deferred.reject()});d.end(q.name+" render");return q},destroy:function(){var q=this;d.start(q.name+" destroy");q.physicalIds=[];q.issues={};q.titles=[];q.names=[];q.indelible=[];q.validate=null;q.modal.destroy();q.modal=null;q.isLoaded=null;q._deferred={resolve:null,reject:null};d.end(q.name+" destroy")},dialog:function(){var q=this;var r=e.get("widget");i.mask(q.container);q.modal=new k({animate:true,autocenter:true,closable:true,limitParent:false,overlay:true,resizable:true,visible:true,className:"delete-issues-dialog",title:p["delete"].preparing,header:null,body:q.container,footer:[q.validate=new m({value:p["delete"]["delete"],className:"primary",events:{onClick:function(){q._delete().then(function(){q.destroy()})}},disabled:true}),new m({value:p["delete"].cancel,events:{onClick:function(){q.destroy()}}})],events:{onClose:function(){q.destroy()}}}).inject(r.body);return q.build().then(function(s){s.inject(q.container);if(q.physicalIds.length>0){q.validate.enable();q.modal.setTitle(p.replace(p["delete"].title,{number:q.physicalIds.length}));if(q.indelible.length===0){q.container.getElement(".no-delete-issues-label").addClassName("hidden");q.container.getElement(".no-delete-issues-content").addClassName("hidden")}}else{q.validate.disable();q.modal.setTitle(p["delete"].nothing);q.container.getElement(".delete-issues-label").addClassName("hidden");q.container.getElement(".delete-issues-content").addClassName("hidden")}q.validate.focus();i.unmask(q.container);new g({element:q.container}).inject(q.modal.getBody())})},build:function(){var q=this;d.start(q.name+" build");return q._check(q.getOption("physicalIds")).then(function(v){var w=v.deletable,t=v.indelible;var u={physicalIds:[],titles:[],icons:[]};for(var s=0;s<w.length;s++){u.physicalIds.push(w[s].physicalId);u.titles.push(w[s].title+" ("+w[s].name+")");u.icons.push({tag:"span","class":"fonticon fonticon-issue "+w[s].state.toLowerCase()})}var z=[];u.titles.forEach(function(B,x){z.push(j.createElement("li",{html:[u.icons[x],B],title:B}))});var r={physicalIds:[],titles:[],icons:[]};for(var A=0;A<t.length;A++){r.physicalIds.push(t[A].physicalId);r.titles.push(t[A].title+" ("+t[A].name+")");r.icons.push({tag:"span","class":"fonticon fonticon-issue "+t[A].state.toLowerCase()})}var y=[];r.titles.forEach(function(B,x){y.push(j.createElement("li",{html:[r.icons[x],B],title:B}))});q.physicalIds=u.physicalIds;q.titles=u.titles;q.indelible=r.physicalIds;d.end(q.name+" build");return j.createElement("div",{html:[{tag:"div","class":"delete-issues-label",html:[{tag:"span","class":"delete-issues-label-first",html:p["delete"].warning},{tag:"span","class":"delete-issues-label-second",html:p["delete"].deletable}]},{tag:"div","class":"delete-issues-content",html:j.createElement("ul",{html:z,"class":"delete-issues-content-list"})},{tag:"div","class":"no-delete-issues-label",html:p["delete"].indelible},{tag:"div","class":"no-delete-issues-content",html:j.createElement("ul",{html:y,"class":"no-delete-issues-content-list"})}]})})},_check:function(r){var q=this;d.start(q.name+" _check");return h.issues.retrieve({data:{objects:r.map(function(s){return{physicalId:s}})}}).then(function(s){var t={deletable:[],indelible:[]};for(var u=0;u<s.length;u++){var v=s[u].body;if(q.utils.isDeletable(v)===true){t.deletable.push({physicalId:v.physicalId,name:v.name,state:v.state,title:v.title?v.title:""})}else{t.indelible.push({physicalId:v.physicalId,name:v.name,state:v.state,title:v.title?v.title:""})}}q.issues=t;d.end(q.name+" _check");return t},function(s){q._logger.error(s);b.displayNotification({msg:p["delete"].error,eventID:"error"});d.end(q.name+" _check")})},_delete:function(){var q=this;d.start(q.name+" _delete");var r=e.get("widget");i.mask(r.body);return h.issues["delete"]({data:{objects:q.physicalIds.map(function(s){return{physicalId:s}})}}).then(function(){var t="";if(q.physicalIds.length===1){t=p.replace(p["delete"].singleSuccess,{title:q.titles[q.titles.length-1]})}else{t=p.replace(p["delete"].multipleSuccess,{number:q.physicalIds.length})}i.unmask(r.body);b.displayNotification({msg:t,eventID:"success"});var u=q.physicalIds.reduce(function(w,v){w.push([v]);return w},[]),s=q.physicalIds.reduce(function(x,w,v){x[w]=q.issues.deletable[v];return x},{});d.end(q.name+" _delete");o.publish("DS/Object/delete",{metadata:{appId:r.id,appName:r.name,timestamp:Math.floor(Date.now())},data:{paths:u,attributes:s},version:"1.0"})},function(s){i.unmask(r.body);b.displayNotification({msg:p["delete"].error,eventID:"error"});d.end(q.name+" _delete");q._logger.error("Cannot delete the selected issue(s) because %o",s)})},utils:{isDeletable:function(q){return q.state===l.CREATE_STATE}}})});define("DS/IssueComponents/konami/Konami",["UWA/Core","DS/WebappsUtils/WebappsUtils","css!DS/IssueComponents/IssueComponents.css"],function(c,b){var a={kojima:function(){var d=this;d.onKonamiCode(function(){var e=new Audio(b.getWebappsAssetUrl("IssueComponents","others/kojima.png"));e.play()})},onKonamiCode:function(d){var e="";var f="38384040373937396665";document.addEventListener("keydown",function(g){e+=g.keyCode.toString();if(e===f){return d()}if(!f.indexOf(e)){return(function(){}())}e=g.keyCode.toString();return(function(){}())})}};return a});define("DS/IssueComponents/open/Open",["UWA/Class/Promise","UWA/Core","DS/Logger/Logger","DS/PADUtils/views/PADAlert","DS/WAFData/WAFData","DS/IssueServices/Contexts","DS/IssueServices/services/PlatformServices","DS/IssueServices/utils/LocalStorage","DS/IssueServices/utils/Performance","DS/IssueServices/utils/Views","i18n!DS/IssueComponents/assets/nls/IssueComponents","css!DS/IssueComponents/IssueComponents.css"],function(m,h,e,c,n,f,b,l,d,i,o){var a="DS/IssueComponents/open/Open";var j={TEN_MINUTES:600000,ISSUE_MANAGEMENT:"ENXISSU_AP",ISSUE_3D_REVIEW:"ENX3DIR_AP"};var k={expand:function(p){var q=f.get("widget");return new m(function(u,t){var r={};r.method="POST";r.headers={Accept:"application/json","Accept-Language":q.lang,"Content-Type":"application/json",SecurityContext:"ctx::"+b.getSecurityContext()};r.timeout=j.TEN_MINUTES;r.onComplete=function(x){var w=h.is(x,"string")?JSON.parse(x):x;u(w)};r.onFailure=function(w){t(w)};var v=p.reduce(function(x,w){x.push([w]);return x},[]);var s={label:q.name+"-"+b.getUserName()+"-"+Date.now(),authored:false,root_path_physicalid:v,intent:"explore_2D","q.iterative_filter_query_bo":'[ds6w:globalType]:"ds6w:Document" OR [ds6w:globalType]:"ds6w:Part"',no_type_filter_rel:["XCADBaseDependency"],include_param_Attributes:true,paths:v,level:"-1",source:"cstorage"};r.data=JSON.stringify(s);n.authenticatedRequest(b.assembleURLFor3DSpace("/resources/enopad/lwc/expand"),r)})},generateFileContent:function(p){var r=this;var q={version:"2.2",results:[],structures:[],viewpoint:[]};return r.expand(p).then(function(t){var y=t.results;var F={},I={};for(var z=0;z<y.length;z++){if(y[z]&&Array.isArray(y[z].attributes)){var v=y[z].attributes,D="",B="";for(var u=0;u<v.length;u++){if(D===""&&v[u].name==="did"){D=v[u].value}if(B===""&&v[u].name==="physicalid"){B=v[u].value}}if(D!==""){F[D]={did:D,physicalId:B};q.results.push({id:D,phid:B,CADOrigin:"CATIAV5"})}}if(y[z]&&Array.isArray(y[z].path)){var H=y[z].path;var w=null;for(var C=0;C<H.length;C++){if(w===null){if(h.is(I[H[C]],"object")){w=I[H[C]]}else{I[H[C]]={};w=I[H[C]]}}else{if(h.is(w[H[C]],"object")){w=w[H[C]]}else{w[H[C]]={};w=w[H[C]]}}}}}var A=function(K,s){for(var J in K){if(K.hasOwnProperty(J)){var x=[];var L={id:J,show:true,children:x};s.push(L);A(K[J],x)}}};var E=[];A(I,E);for(var G=0;G<E.length;G++){q.structures.push({structure:E[G]})}return q},function(s){throw new Error("An error occurred during the expand "+s)})}};var g={setTypesCallbackForOFW:function(r,q){d.start(a+" setTypesCallbackForOFW");var p=i.getCompassPubSub();if(q.setTypesCallbackSubscribe===false){p.subscribe("setTypesCallback",function(s){d.start(a+" setTypesCallbackForOFW setTypesCallback");var v=f.get("widget");if(s.widgetId===v.id){var u=[];if(!s.data||!Array.isArray(s.data.items)){if(v.name===j.ISSUE_MANAGEMENT){u=f.get("component").document.getReportedAgainstFromSelectedNodes()}else{if(v.name===j.ISSUE_3D_REVIEW){var t=f.get("component").manager;if(t!==null){u=t.getReportedAgainstFromSelectedIssues()}}}}else{u=s.data.items.reduce(function(x,w){x.push(w.objectId);return x},[])}if(Array.isArray(u)&&u.length>0){k.generateFileContent(u).then(function(w){var x={appId:s.appId,widgetId:s.widgetId,fileName:"-file",fileContent:JSON.stringify(w)};p.publish("launchApp",x)},function(){c.displayNotification({msg:o.open.error,eventID:"error"})})}else{p.publish("launchApp",{appId:s.appId,widgetId:s.widgetId})}d.end(a+" setTypesCallbackForOFW setTypesCallback")}})}if(r.length>0){p.publish("setTypes",{widgetId:f.get("widget").id})}else{p.publish("resetTypes")}d.end(a+" setTypesCallbackForOFW")},modal:null,openWith:function(){var q=this;var r=f.get("widget");var p="";if(r.name===j.ISSUE_MANAGEMENT){p="DS/IssueManagement/components/ContextualMenu"}else{if(r.name===j.ISSUE_3D_REVIEW){p="DS/Issue3DReview/components/ContextualMenu"}}require(["UWA/Class/Promise","DS/UIKIT/Input/Button","DS/UIKIT/Input/Select","DS/UIKIT/Input/Toggle","DS/ENOFloatingPanel/ENOFloatingPanel",p],function(u,s,x,w,v,t){t.getContextualMenu().then(function(z){for(var y=0;y<z.length;y++){if(z[y].name==="Open"){return z[y]}}return{submenu:[]}}).then(function(A){var I=l.getItem("open"),D={};if(h.is(I,"object")){D={type:I.type?I.type:"",app:I.app?I.app:""}}else{D={type:"",app:""}}var E=null,F=null,J=null,G=null;var C=null,z=null,H={};var y=function(L,K){if(G===null||!h.is(L,"object")||!Array.isArray(L.submenu)||L.submenu.length===0){return}G.remove();H={};L.submenu.forEach(function(M){if(M&&h.is(M.name,"string")){G.add({value:M.name,label:M.title,selected:M.name===K});H[M.name]=M.action.callback;if(M.name===K){C.enable()}}})};A.submenu.forEach(function(K){if(K.name==="contexts"){E=new w({className:"primary contexts-chooser",name:"typeChooser",value:"contexts",label:"",checked:D.type==="contexts",events:{onChange:function(){D.type="contexts";l.setItem("open",D);y(K,D.app)}}});E.elements.label.setContent([h.createElement("i",{"class":"where-to-open-icon where-to-open-contexts wux-ui-3ds wux-ui-3ds-3d-object"}),o.open.labels.contexts]);if(D.type==="contexts"){z=K}}if(K.name==="reportedAgainst"){F=new w({className:"primary reported-against-chooser",name:"typeChooser",value:"reportedAgainst",label:"",checked:D.type==="reportedAgainst",events:{onChange:function(){D.type="reportedAgainst";l.setItem("open",D);y(K,D.app)}}});F.elements.label.setContent([h.createElement("i",{"class":"where-to-open-icon where-to-open-reported-against wux-ui-3ds wux-ui-3ds-location"}),o.open.labels.reportedAgainst]);if(D.type==="reportedAgainst"){z=K}}if(K.name==="resolvedBy"){J=new w({className:"primary resolved-by-chooser",name:"typeChooser",value:"resolvedBy",label:"",checked:D.type==="resolvedBy",events:{onChange:function(){D.type="resolvedBy";l.setItem("open",D);y(K,D.app)}}});J.elements.label.setContent([h.createElement("i",{"class":"where-to-open-icon where-to-open-contexts-resolved-by fonticon fonticon-docs"}),o.open.labels.resolvedBy]);if(D.type==="resolvedBy"){z=K}}});var B=null;if(A.submenu.length>0){G=new x({custom:false,multiple:false,placeholder:o.open.labels.placeholder,options:[],events:{onChange:function(){var L=this,K=L.getValue();if(K.length>0&&K[K.length-1]===""){C.disable()}else{D.app=K[K.length-1];l.setItem("open",D);C.enable()}}}});B=h.createElement("div",{html:[E,F,J,G]})}else{B=h.createElement("div",{"class":"nothing-to-open",html:h.createElement("span",{"class":"nothing-to-open-label",html:o.open.labels.nothing})})}q.modal=new v({animate:true,autocenter:true,closable:true,limitParent:false,overlay:true,resizable:true,visible:true,className:"open-issues-dialog",title:o.open.dialog.title,header:null,body:B,footer:[C=new s({value:o.open.dialog.open,className:"primary",events:{onClick:function(){var K=G.getValue();if(K.length>0&&K[K.length-1]&&h.is(H[K[K.length-1]],"function")){H[K[K.length-1]].call()}q.modal.destroy()}},disabled:true}),new s({value:o.open.dialog.cancel,events:{onClick:function(){q.modal.destroy()}}})],events:{onClose:function(){this.destroy()}}}).inject(r.body);if(z!==null){y(z,D.app)}})})}};return g});define("DS/IssueComponents/users/Users",["UWA/Class/Promise","UWA/Core","DS/UIKIT/Popover","DS/UIKIT/Spinner","DS/WAFData/WAFData","DS/IssueServices/Contexts","DS/IssueServices/services/PlatformServices","DS/IssueServices/services/SwymServices","i18n!DS/IssueComponents/assets/nls/IssueComponents","css!DS/IssueComponents/IssueComponents.css"],function(h,g,d,e,i,c,b,j,k){var a={content:function(l){return g.createElement("div",{"class":"issue-user-content",html:[{"class":"issue-user-image",html:l.image},{"class":"issue-user-info",html:l.info}]})},image:function(l){return g.createElement("div",{"class":"issue-user-image-sub",html:g.createElement("img",{"class":"issue-user-image-sub-img img-circle",src:b.getUserImage(l.user)})})},info:function(l){return g.createElement("div",{"class":"issue-user-info-sub",html:[{"class":"issue-user-info-sub-id",html:[{"class":"issue-user-info-sub-name",html:l.name},{"class":"issue-user-info-sub-user",html:"("+l.user+")"}]},{"class":"issue-user-info-sub-email",html:l.email},{"class":"issue-user-info-sub-address",html:[{"class":"issue-user-info-sub-address-city",html:l.city},{"class":"issue-user-info-sub-address-city",html:l.country}]},{"class":"issue-user-info-sub-more",html:k.users.more,events:{click:function(){b.getUserProfile(l.user)}}}]})}};var f={create:function(m){var p=this;var l=g.createElement("div",{"class":"issue-users-list"});var o=function(q){var r=g.createElement("div",{"class":"issue-user-image",html:g.createElement("img",{"class":"issue-user-image-img",src:b.getUserImage(q)})});r.addEventListener("click",function(){var s=this;p.display({user:q,target:s})});return r};for(var n=0;n<m.users.length;n++){o(m.users[n]).inject(l)}return l},display:function(l){var p=new e();var o=g.createElement("div",{"class":"issue-user-info-ph",html:p});var n=a.image({user:l.user});var m=null;m=new d({className:"issue-user-popover",target:l.target,body:a.content({image:n,info:o})});m.show();m.updatePosition();p.show();j.users.retrieve({user:l.user}).then(function(q){p.destroy();o.parentNode.replaceChild(a.info(q),o);m.updatePosition()})},open:function(m){var l=m.user;b.getUserProfile(l)}};return f});define("DS/IssueComponents/close/Close",["UWA/Class/Promise","UWA/Class/View","UWA/Core","DS/UIKIT/Input/Button","DS/UIKIT/Input/Text","DS/UIKIT/Mask","DS/UIKIT/Scroller","DS/ENOFloatingPanel/ENOFloatingPanel","DS/Logger/Logger","DS/PADUtils/views/PADAlert","DS/PlatformAPI/PlatformAPI","DS/IssueServices/Contexts","DS/IssueServices/services/PlatformServices","DS/IssueServices/services/IssueServices","DS/IssueServices/utils/Performance","i18n!DS/IssueComponents/assets/nls/IssueComponents","css!DS/IssueComponents/IssueComponents.css"],function(o,c,k,n,g,j,h,l,f,b,p,e,a,i,d,q){var m={CLOSED_STATE:"Closed"};return c.extend({name:"DS/IssueComponents/close/Close",tag:"div",className:"isu-close-view",_logger:null,defaultOptions:{physicalIds:[]},physicalIds:[],issues:{},titles:[],names:[],indelible:[],modal:null,validate:null,isLoaded:null,_deferred:{resolve:null,reject:null},setup:function(r){var s=this;s._parent(r);s._logger=f.getLogger("DS/IssueComponents/components");s._logger.log("Initializing the close component");s.issues={};s.titles=[];s.names=[];s.indelible=[];s.fields={};s.validate=null;s.modal=null;s.isLoaded=null;s._deferred={resolve:null,reject:null};s.isLoaded=new o(function(u,t){s._deferred.resolve=u;s._deferred.reject=t})},render:function(){var r=this;d.start(r.name+" render");r.dialog().then(r._deferred.resolve,r._deferred.reject);d.end(r.name+" render");return r},destroy:function(){var r=this;d.start(r.name+" destroy");r.physicalIds=[];r.issues={};r.titles=[];r.names=[];r.indelible=[];r.fields={};r.validate=null;r.modal.destroy();r.modal=null;r.isLoaded=null;r._deferred={resolve:null,reject:null};d.end(r.name+" destroy")},dialog:function(){var r=this;var s=e.get("widget");j.mask(r.container);r.modal=new l({animate:true,autocenter:true,closable:true,limitParent:false,overlay:true,resizable:true,visible:true,className:"isu-close-dialog",title:q.close.preparing,header:null,body:r.container,footer:[r.validate=new n({value:q.close.close,className:"primary",events:{onClick:function(){r.close().then(function(){r.destroy()})}},disabled:true}),new n({value:q.close.cancel,events:{onClick:function(){r.destroy()}}})],events:{onClose:function(){r.destroy()}}}).inject(s.body);return r.build().then(function(t){t.inject(r.container);if(r.physicalIds.length>0){r.validate.enable();r.modal.setTitle(q.replace(q.close.title,{number:r.physicalIds.length}));if(r.indelible.length===0){r.container.getElement(".isu-close-no-issues-label").addClassName("hidden");r.container.getElement(".isu-close-no-issues-content").addClassName("hidden")}}else{r.validate.disable();r.modal.setTitle(q.close.nothing);r.container.getElement(".isu-close-label").addClassName("hidden");r.container.getElement(".isu-close-content").addClassName("hidden")}r.validate.focus();j.unmask(r.container);new h({element:r.container}).inject(r.modal.getBody())})},build:function(){var r=this;d.start(r.name+" build");return r._check(r.getOption("physicalIds")).then(function(z){var u=k.createElement("div",{"class":"isu-close-form",html:[{tag:"h5","class":"",html:q.create.properties.labels.resolutionStatement},(r.fields.resolutionStatement=new g({name:"isu-close-resolution-statement",id:"isu-close-resolution-statement",className:"isu-close-resolution-statement",value:"",multiline:true,required:false,placeholder:q.create.properties.labels.resolutionStatementPlaceholder}))]});var E=z.closable,y=z.indelible;var w={physicalIds:[],titles:[],icons:[]};for(var v=0;v<E.length;v++){w.physicalIds.push(E[v].physicalId);w.titles.push(E[v].title+" ("+E[v].name+")");w.icons.push({tag:"span","class":"fonticon fonticon-issue "+E[v].state.toLowerCase()})}var s=[];w.titles.forEach(function(F,x){s.push(k.createElement("li",{html:[w.icons[x],F],title:F}))});var t={physicalIds:[],titles:[],icons:[]};for(var D=0;D<y.length;D++){t.physicalIds.push(y[D].physicalId);t.titles.push(y[D].title+" ("+y[D].name+")");t.icons.push({tag:"span","class":"fonticon fonticon-issue "+y[D].state.toLowerCase()})}var C=[];t.titles.forEach(function(F,x){C.push(k.createElement("li",{html:[t.icons[x],F],title:F}))});r.physicalIds=w.physicalIds;r.titles=w.titles;r.indelible=t.physicalIds;d.end(r.name+" build");var B=k.createElement("div",{"class":"isu-close-list",html:[{tag:"div","class":"isu-close-label",html:[{tag:"span","class":"isu-close-label-first",html:q.close.warning},{tag:"span","class":"isu-close-label-second",html:q.close.closable}]},{tag:"div","class":"isu-close-content",html:k.createElement("ul",{html:s,"class":"isu-close-content-list"})},{tag:"div","class":"isu-close-no-issues-label",html:q.close.indelible},{tag:"div","class":"isu-close-no-issues-content",html:k.createElement("ul",{html:C,"class":"isu-close-no-issues-content-list"})}]});var A=k.createElement("div",{html:[]});if(r.physicalIds.length>0){u.inject(A)}B.inject(A);return A})},_check:function(s){var r=this;d.start(r.name+" _check");return i.issues.retrieve({data:{objects:s.map(function(t){return{physicalId:t}})}}).then(function(t){var u={closable:[],indelible:[]};for(var v=0;v<t.length;v++){var w=t[v].body;if(r.utils.isClosable(w)===true){u.closable.push({physicalId:w.physicalId,name:w.name,state:w.state,title:w.title?w.title:""})}else{u.indelible.push({physicalId:w.physicalId,name:w.name,state:w.state,title:w.title?w.title:""})}}r.issues=u;d.end(r.name+" _check");return u},function(t){r._logger.error(t);b.displayNotification({msg:q.close.error,eventID:"error"});d.end(r.name+" _check")})},close:function(){var s=this;d.start(s.name+" close");var t=e.get("widget");j.mask(t.body);var r=s.fields.resolutionStatement.getValue().trim();return i.issues.close({data:{objects:s.physicalIds.map(function(u){var v={physicalId:u,};if(r!==""){v.resolutionStatement=r}return v})}}).then(function(){var v="";if(s.physicalIds.length===1){v=q.replace(q.close.singleSuccess,{title:s.titles[s.titles.length-1]})}else{v=q.replace(q.close.multipleSuccess,{number:s.physicalIds.length})}j.unmask(t.body);b.displayNotification({msg:v,eventID:"success"});var w=s.physicalIds.reduce(function(y,x){y.push([x]);return y},[]),u=s.physicalIds.reduce(function(z,y,x){z[y]=s.issues.closable[x];z[y].state="Closed";z[y].type="Issue";z[y].modifiedAttributes=["state"];return z},{});d.end(s.name+" close");p.publish("DS/Object/update",{metadata:{appId:t.id,appName:t.name,timestamp:Math.floor(Date.now())},data:{paths:w,attributes:u},version:"1.0"})},function(u){j.unmask(t.body);b.displayNotification({msg:q.close.error,eventID:"error"});d.end(s.name+" close");s._logger.error("Cannot close the selected issue(s) because %o",u)})},utils:{isClosable:function(r){return r.state!==m.CLOSED_STATE}}})});define("DS/IssueComponents/helper/Helper",["UWA/Core","DS/UIKIT/Input/Button","DS/UIKIT/Scroller","DS/UIKIT/Toggler","DS/ENOFloatingPanel/ENOFloatingPanel","DS/IssueComponents/utils/Utils","DS/WebappsUtils/WebappsUtils","i18n!DS/IssueComponents/assets/nls/IssueComponents","css!DS/IssueComponents/IssueComponents.css"],function(e,h,c,b,f,i,a,j){var g={CREATE_STATE:"Create",ASSIGN_STATE:"Assign",ACTIVE_STATE:"Active",REVIEW_STATE:"Review",CLOSED_STATE:"Closed",MARGIN_BOTTOM:120,DIALOG_MINIMIZED:"minimized"};var d={name:"DS/IssueComponents/helper/Helper",show:function(n){var p=this;if(p.modal){return null}var m=e.createElement("div",{"class":"helper-dialog-body",html:p.getDialogBody()});var o=new f({animate:true,autocenter:true,closable:true,limitParent:false,overlay:false,resizable:true,visible:true,className:"helper-dialog",title:j.helper.dialog.title,header:null,body:m,events:{onClose:function(){o.destroy();p.modal=null;p.views=null}}}).inject(n);var q=e.createElement("span",{"class":"right-actions minimize fonticon fonticon-minus"});var l=o.rightButtons.querySelector(".fonticon-cancel");o.rightButtons.insertBefore(q,l);q.addEventListener("click",function(){p.minimize()});p.views.minimize={};p.views.minimize.icon=q;o.addEvent("onResizeFloating",function(){var r=o.elements.container.getStyle("height");if(r!=="44px"){if(p.views.minimize.icon.hasClassName(g.DIALOG_MINIMIZED)){p.views.minimize.icon.removeClassName(g.DIALOG_MINIMIZED)}}});var k=new c({element:p.views.contentsBody});o.show();p.modal=o;return k},getBody:function(){var q=this;var k=e.createElement("div",{"class":"tooltip-header-body"});var p=[];var l=[g.CREATE_STATE,g.ASSIGN_STATE,g.ACTIVE_STATE,g.REVIEW_STATE,g.CLOSED_STATE];for(var m=0;m<l.length;m++){var o="";if(m===l.length-1){o="th-last-row"}p.push(q.getStateHelper(l[m],o))}var n=e.createElement("table");n.setContent(p);k.setContent(n);return k},getStateHelper:function(l,k){var m=[e.createElement("th",{"class":"th-title "+k,html:e.createElement("span",{"class":"state-title",html:e.createElement("span",{"class":"state-content",html:j.maturity[l.toLowerCase()]}),styles:{"background-color":i.getColorByState(l)}})}),e.createElement("th",{"class":"th-description "+k,html:e.createElement("span",{"class":"state-description",html:j.helper.states[l.toLowerCase()]})})];return e.createElement("tr",{"class":"helper-state",html:m})},getDialogBody:function(){var m=this;var l=e.createElement("nav",{"class":"tab",html:[e.createElement("li",{"class":"tab-item active",id:"state",html:[e.createElement("span",{"class":"fonticon fonticon-issue "}),j.helper.dialog.tabStates]}),e.createElement("li",{"class":"tab-item",id:"shortcut",html:[e.createElement("span",{"class":"fonticon fonticon-keyboard"}),j.helper.dialog.tabShortcuts]}),e.createElement("li",{"class":"tab-item",id:"workflow",html:[e.createElement("span",{"class":"fonticon fonticon-route"}),j.helper.dialog.workflow]})]});var n=new b({container:l,events:{onToggle:function(p){if("id" in p){var o=Object.keys(m.views.contents);o.forEach(function(q){m.views.contents[q].hide()});m.views.contents[p.id].show()}}}});m.views={};m.views.contents={};m.views.contents.state=m.state();m.views.contents.shortcut=m.shortcut();m.views.contents.workflow=m.workflow();m.views.contents.shortcut.hide();m.views.contents.workflow.hide();var k=e.createElement("div",{"class":"helper-content-main",html:[m.views.contents.state,m.views.contents.shortcut,m.views.contents.workflow]});m.views.contentsBody=k;return[n,k]},workflow:function(){var t=this;var w=e.createElement("div",{"class":"helper-content-workflow helper-content-state"});t.lifecycle={Create:{name:"Create",type:"state",index:0,next:["route1","Closed"],organisation:"Reporting",previous:""},route1:{name:"Confirm",type:"route",index:1,organisation:"Reporting",next:["Assign"],previous:""},Assign:{name:"Assign",type:"state",index:2,organisation:"Responsible",next:["route2","Closed"],previous:""},route2:{name:"Approve",type:"route",index:3,organisation:"Responsible",next:["Active"],previous:"Create"},Active:{name:"Active",type:"state",index:4,organisation:"Responsible",next:["route3","Closed"],previous:""},route3:{name:"Confirm",type:"route",index:5,organisation:"Responsible",next:["Review"],previous:""},Review:{name:"Review",type:"state",index:6,organisation:"Reporting",next:["route4","Closed"],previous:""},route4:{name:"Approve",type:"route",index:7,organisation:"Reporting",next:["Closed"],previous:"Active"},Closed:{name:"Closed",type:"state",index:8,organisation:"Reporting",next:[],previous:""}};var D=Object.keys(t.lifecycle);t.grid=e.createElement("table",{"class":"helper-workflow-grid"}).inject(w);var B=0,s=0,n=[];D.forEach(function(r){if(t.lifecycle[r].next.length>0){B=B+t.lifecycle[r].next.length-1}if(t.lifecycle[r].previous!==""){s=s+1}if(t.lifecycle[r].organisation.length>0){if(!n.includes(t.lifecycle[r].organisation)){n.push(t.lifecycle[r].organisation)}}});var u=n.length;var I=D.length+((D.length-1)*2)+1;var C=B+s+5+u+((u-1)*2);var F=0,E=0;for(F=0;F<C;F++){var q=e.createElement("tr",{"class":"helper-workflow-grid-row"}).inject(t.grid);for(E=0;E<I;E++){e.createElement("td",{"class":"helper-workflow-grid-cell",html:e.createElement("div",{"class":"lifecycle-cell-content"})}).inject(q)}}var m=new Array(C);for(F=0;F<C;F++){m[F]=new Array(I)}for(var y=0;y<C;y++){for(var G=0;G<I;G++){m[y][G]=t.grid.getChildren()[y].getChildren()[G].getElement(".lifecycle-cell-content")}}t.graphComponents.cells=m;t.nodes=[];var x=B===0?0:B+2;t.createNodes(m,x,n);var A={forward:t.grid.getChildren().length-1,reverse:1};var H=[];t.nodes.forEach(function(K){var r=t.connectNodes(K,m,A);H=H.concat(r)});var z=[];if(n.length>1){var o=0,l=x+1;for(F=0;F<n.length;F++){var p={name:n[F],start:o,end:l};o=p.end+1;l=o+2;if(F===n.length-1){p.end=C-1}z.push(p)}t.grid.setStyle("background","#f9f9f9");t.grid.setStyle("border","1px solid");var v=t.grid.getChildren();v.forEach(function(r){r.getChildren()[0].getChildren()[0].setStyle("width","30px");r.getChildren()[0].setStyle("border-right","1px solid")});for(F=0;F<z.length;F++){var J=z[F].name;o=z[F].start;l=z[F].end;for(E=o;E<=l;E++){if(F%2===0){v[E].setStyle("background","#f0f8ff")}if(E===l){v[E].setStyle("border-bottom","1px solid");var k=v[E].getChildren()[0].getChildren()[0];z[F].caption=e.createElement("div",{"class":"lifecycle-helper-caption-wrapper",html:e.createElement("div",{"class":"lifecycle-helper-caption",html:j.lifecycle.orgs[J]})}).inject(k)}}}}w.show=function(){w.setStyle("display","table");H.forEach(function(L){var N=0,P=0,K=0;if((L.end.c-L.start.c)>0){P=L.start.c;K=L.end.c}else{P=L.end.c;K=L.start.c}var O=L.start.r;for(var M=P+1;M<K;M++){N=N+m[O][M].getSize().width}L.caption.setStyle("width",N)});z.forEach(function(L){var r=0;for(var K=L.start;K<=L.end-1;K++){r=r+m[K][0].getSize().height}L.caption.setStyle("width",r);L.caption.setStyle("padding","15px");L.caption.setStyle("transform-origin","left");L.caption.setStyle("transform","rotate(-90deg)")})};return w},createNodes:function(t,r,u){var p=this;var k=Object.keys(p.lifecycle);var q=1;for(var n=0;n<k.length;n++){var m={};var s=u.indexOf(p.lifecycle[k[n]].organisation);var o=0;if(s!==0){o=r+s+(s*2)}else{o=r}m.cell=p.createNode(p.lifecycle[k[n]],o,q);m.index={r:o,c:q};m.state=p.lifecycle[k[n]];p.nodes.push(m);q=q+3}},createNode:function(m,o,k){var l=this;var n=null;if(m.type==="state"){n=l.graphComponents.createStateNode(m,o,k)}else{if(m.type==="route"){n=l.graphComponents.createRouteNode(m,o,k)}}return n},connectNodes:function(B,p,y){var u=this;var G=B.state.next.length;var w=0,F=0;var q=0,s=0;var C=[],l=null;var m=function(I,r){return u.nodes.find(function(J){return J.state.index===r.index})};var v=function(I,r){return u.nodes.find(function(J){return J.state.index===r.index})};for(var D=0;D<G;D++){var t=u.lifecycle[B.state.next[D]];var o=m(B,t);var z=t.index-B.state.index;var k=o.index.r-B.index.r;if(z===1){w=B.index.r;F=B.index.c+1;if(k===0){u.graphComponents.createHorizontalLine().inject(p[w][F]);F=F+1;if(B.state.name==="Approve"){u.graphComponents.createHorizontalLine().inject(p[w][F]);var E=e.createElement("span",{"class":"lifecycle-helper-caption",html:j.lifecycle.paths.approve}).inject(p[w][F]);E.setStyle("position","inherit");E.setStyle("white-space","pre")}u.graphComponents.createHorizontalConnectorArrowRight(w,F)}else{if(k>0){u.graphComponents.createHorizontalConnector(0,"left",w,F,"start");l=u.graphComponents.createVerticalConnector(k-1,"down",w,F);w=l.end.r;F=l.end.c;u.graphComponents.createHorizontalConnector(0,"Right",w,F,"start");F=F+1;u.graphComponents.createHorizontalConnectorArrowRight(w,F)}else{if(k<0){k=Math.abs(k);u.graphComponents.createHorizontalConnector(0,"left",w,F,"start");l=u.graphComponents.createVerticalConnector(k-1,"up",w,F);w=l.end.r;F=l.end.c;u.graphComponents.createHorizontalConnector(0,"Right",w,F,"start");F=F+1;u.graphComponents.createHorizontalConnectorArrowRight(w,F)}}}}else{if(z>1){var H=y.forward-B.index.r-1;z=o.index.c-B.index.c-1;y.forward=y.forward-1;w=B.index.r+1;F=B.index.c;l=u.graphComponents.createVerticalConnector(H,"down",w,F,"end");w=l.end.r;F=l.end.c;l=u.graphComponents.createHorizontalConnector(z,"Right",w,F);w=l.end.r;F=l.end.c;q=l.start.c+1;s=l.start.r;l.caption=e.createElement("div",{"class":"lifecycle-helper-caption-wrapper",html:e.createElement("div",{"class":"lifecycle-helper-caption",html:j.lifecycle.paths.anyStateToClose})}).inject(p[s][q]);C.push(l);H=w-o.index.r-1;l=u.graphComponents.createVerticalConnector(H-1,"up",w,F,"start");w=l.end.r;F=l.end.c;l=u.graphComponents.createVerticalConnectorArrowUp(w,F);w=l.end.r;F=l.end.c}}var n=u.lifecycle[B.state.previous];if(n!==undefined){var x=B.index.r-y.reverse-1;var A=v(B,n);z=B.index.c-A.index.c-1;w=B.index.r-1;F=B.index.c;l=u.graphComponents.createVerticalConnector(x,"up",w,F,"end");w=l.end.r;F=l.end.c;l=u.graphComponents.createHorizontalConnector(z,"Left",w,F);w=l.end.r;F=l.end.c;q=l.end.c+1;s=l.start.r;l.caption=e.createElement("div",{"class":"lifecycle-helper-caption-wrapper",html:e.createElement("div",{"class":"lifecycle-helper-caption",html:j.lifecycle.paths.reject})}).inject(p[s][q]);C.push(l);x=A.index.r-w-1;l=u.graphComponents.createVerticalConnector(x-1,"down",w,F,"start");w=l.end.r;F=l.end.c;l=u.graphComponents.createVerticalConnectorArrowDown(w,F);w=l.end.r;F=l.end.c}}return C},state:function(){var o=e.createElement("div",{"class":"helper-content helper-content-state"});var m=e.createElement("div",{"class":"helper-content-header-container",html:e.createElement("div",{"class":"helper-content-header-title",html:j.helper.dialog.tabStates})});var n=e.createElement("div",{"class":"helper-content-body-container"});var p=function(u,t){var v=[e.createElement("th",{"class":"th-title "+t,html:e.createElement("span",{"class":"state-title",html:e.createElement("span",{"class":"state-content",html:j.maturity[u.toLowerCase()]}),styles:{"background-color":i.getColorByState(u)}})}),e.createElement("th",{"class":t,html:e.createElement("span",{"class":"th-description",html:j.helper.dialog.states[u.toLowerCase()]})})];return e.createElement("tr",{"class":"helper-state",html:v})};o.addContent(m);o.addContent(n);var k=[];var r=[g.CREATE_STATE,g.ASSIGN_STATE,g.ACTIVE_STATE,g.REVIEW_STATE,g.CLOSED_STATE];for(var l=0;l<r.length;l++){var s="";if(l===r.length-1){s="th-last-row"}k.push(p(r[l],s))}var q=e.createElement("table");q.setContent(k);n.addContent(q);return o},shortcut:function(){var m=e.createElement("div",{"class":"helper-content"});var k=function(n,o,p){var q=[e.createElement("th",{"class":"th-helper-dialog-key "+p,html:e.createElement("span",{"class":"default-helper-title key-shortcut-key",html:e.createElement("span",{"class":"default-helper-content ",html:j.helper.dialog.shortcut.key[o][n]})})}),e.createElement("th",{"class":p,html:e.createElement("span",{"class":"th-helper-dialog-description",html:j.helper.dialog.shortcut.detail[o][n]})})];return e.createElement("tr",{"class":"helper-state",html:q})};var l=function(r,t,u,s){var p=e.createElement("div",{"class":"helper-content-header-container",html:e.createElement("div",{"class":"helper-content-header-title",html:t})});var q=e.createElement("div",{"class":"helper-content-body-container default-content-body-container"});r.addContent(p);r.addContent(q);var n=[];for(var o=0;o<u.length;o++){var w="";if(o===u.length-1){w="th-last-row"}n.push(k(u[o],s,w))}var v=e.createElement("table");v.setContent(n);q.addContent(v)};l(m,j.helper.dialog.subtitleShortcuts,["arrowUp","arrowDown","arrowLeft","arrowRight","shiftArrow","ctrlA","ctrlC","delete","enter"],"shortcut");l(m,j.helper.dialog.subtitleMouseOperation,["ctrlClick","shiftClick","doubleClick"],"mouse");return m},minimize:function(){var k=this;if(k.views.minimize.icon.hasClassName(g.DIALOG_MINIMIZED)){k.views.minimize.icon.removeClassName(g.DIALOG_MINIMIZED);k.modal.elements.container.setStyle("height",k.views.minimize.height)}else{k.views.minimize.icon.addClassName(g.DIALOG_MINIMIZED);k.views.minimize.height=k.modal.elements.container.getStyle("height");k.modal.elements.container.setStyle("height","44px")}},graphComponents:{createRouteNode:function(k,p,m){var n=this;var o=a.getWebappsAssetUrl("IssueComponents","images/decisionBox.PNG");var l=e.createElement("div",{"class":"lifecycle-decision-box",html:[e.createElement("img",{src:o}),e.createElement("div",{"class":"route-content",html:j.routes[k.name.toLowerCase()]})]}).inject(n.cells[p][m]);return l},createStateNode:function(m,o,k){var l=this;var n=e.createElement("div",{"class":"state-content",html:e.createElement("span",{"class":"state-title",html:e.createElement("span",{"class":"state-content",html:j.maturity[m.name.toLowerCase()]}),styles:{"background-color":i.getColorByState(m.name)}})}).inject(l.cells[o][k]);return n},createHorizontalLine:function(){return e.createElement("div",{"class":"lifecycle-horizontal-line",html:e.createElement("hr",{"class":"horizontal-line"})})},createVerticalLine:function(){return e.createElement("div",{"class":"lifecycle-vertical-line",html:e.createElement("div",{"class":"vertical-line"})})},createVerticalConnector:function(m,o,p,k,n){var l=this;if(o==="up"){return l.createVerticalConnectorUp(m,p,k,n)}else{return l.createVerticalConnectorDown(m,p,k,n)}},createVerticalConnectorUp:function(k,q,p,m){var o=this;var l={div:e.createElement("div"),start:{r:q,c:p},end:{r:q,c:p}};if(m!=="end"){var s=o.createVerticalLine().inject(o.cells[q][p]);s.getChildren()[0].setStyle("height","50%");q--}for(var n=0;n<k;n++){o.createVerticalLine().inject(o.cells[q][p]);q--}if(m!=="start"){var r=o.createVerticalLine().inject(o.cells[q][p]);r.getChildren()[0].setStyle("height","50%");r.style.transform="rotateZ(180deg)"}l.end.r=q;l.end.c=p;return l},createVerticalConnectorDown:function(k,q,p,m){var o=this;var l={div:e.createElement("div"),start:{r:q,c:p},end:{r:q,c:p}};if(m!=="end"){var r=o.createVerticalLine().inject(o.cells[q][p]);r.getChildren()[0].setStyle("height","50%");r.style.transform="rotateZ(180deg)";q++}for(var n=0;n<k;n++){o.createVerticalLine().inject(o.cells[q][p]);q++}if(m!=="start"){var s=o.createVerticalLine().inject(o.cells[q][p]);s.getChildren()[0].setStyle("height","50%")}l.end.r=q;l.end.c=p;return l},createHorizontalConnector:function(m,o,p,k,n){var l=this;if(o==="Right"){return l.createHorizontalConnectorRight(m,p,k,n)}else{return l.createHorizontalConnectorLeft(m,p,k,n)}},createHorizontalConnectorRight:function(k,q,p,m){var o=this;var l={div:e.createElement("div"),start:{r:q,c:p},end:{r:q,c:p}};if(m!=="end"){var s=o.createHorizontalLine().inject(o.cells[q][p]);s.getChildren()[0].setStyle("width","50%");s.style.transform="rotate(180deg)"}p++;for(var n=0;n<k;n++){o.createHorizontalLine().inject(o.cells[q][p]);p++}if(m!=="start"){var r=o.createHorizontalLine().inject(o.cells[q][p]);r.getChildren()[0].setStyle("width","50%")}l.end.r=q;l.end.c=p;return l},createHorizontalConnectorLeft:function(k,q,p,m){var o=this;var l={div:e.createElement("div"),start:{r:q,c:p},end:{r:q,c:p}};if(m!=="end"){var s=o.createHorizontalLine().inject(o.cells[q][p]);s.getChildren()[0].setStyle("width","50%")}p--;for(var n=0;n<k;n++){o.createHorizontalLine().inject(o.cells[q][p]);p--}if(m!=="start"){var r=o.createHorizontalLine().inject(o.cells[q][p]);r.getChildren()[0].setStyle("width","50%");r.style.transform="rotate(180deg)"}l.end.r=q;l.end.c=p;return l},createVerticalConnectorArrowUp:function(n,l){var m=this;var k={div:e.createElement("div"),start:{r:n,c:l},end:{r:n,c:l}};e.createElement("div",{"class":"lifecycle-vertical-arrow-up",html:[e.createElement("div",{"class":"lifecycle-vertical-line",html:e.createElement("div",{"class":"vertical-line"})}),e.createElement("div"),{"class":"lifecycle-helper-arrow",html:e.createElement("div",{"class":"vertical-arrow-up"})}]}).inject(m.cells[n][l]);k.end.r=n;k.end.c=l;return k},createVerticalConnectorArrowDown:function(n,l){var m=this;var k={div:e.createElement("div"),start:{r:n,c:l},end:{r:n,c:l}};e.createElement("div",{"class":"lifecycle-vertical-arrow-down",html:[e.createElement("div",{"class":"lifecycle-vertical-line",html:e.createElement("div",{"class":"vertical-line"})}),e.createElement("div"),{"class":"lifecycle-helper-arrow",html:e.createElement("div",{"class":"vertical-arrow-down"})}]}).inject(m.cells[n][l]);k.end.r=n;k.end.c=l;return k},createHorizontalConnectorArrowRight:function(m,k){var l=this;e.createElement("div",{"class":"lifecycle-horizontal-arrow-right",html:[l.createHorizontalLine(),e.createElement("div"),{"class":"lifecycle-helper-arrow",html:e.createElement("div",{"class":"lifecycle-arrow"})}]}).inject(l.cells[m][k])},createHorizontalConnectorArrowleft:function(m,k){var l=this;e.createElement("div",{"class":"lifecycle-horizontal-arrow-left",html:[e.createElement("div"),{"class":"lifecycle-helper-arrow",html:e.createElement("div",{"class":"lifecycle-arrow"}).setStyle("transform","rotate(180deg)")},l.createHorizontalLine()]}).inject(l.cells[m][k])}}};return d});define("DS/IssueComponents/lifecycle/Lifecycle",["UWA/Class/View","UWA/Core","UWA/Class/Promise","DS/Logger/Logger","DS/UIKIT/Input/Button","DS/UIKIT/Input/Text","DS/UIKIT/Tooltip","DS/ENOFloatingPanel/ENOFloatingPanel","DS/PADUtils/views/PADAlert","DS/IssueAttachmentManager/components/Collection","DS/IssueAttachmentManager/services/AttachmentServices","DS/IssueAttachmentManager/views/Catalog","i18n!DS/IssueAttachmentManager/assets/nls/IssueAttachmentManager","DS/IssueCommon/utils/Utils","DS/IssueComponents/create/Attachments","DS/IssueComponents/close/Close","DS/IssueServices/Contexts","DS/IssueServices/services/IssueServices","DS/IssueServices/services/PlatformServices","DS/IssueServices/utils/Performance","i18n!DS/IssueComponents/assets/nls/IssueComponents","css!DS/IssueComponents/IssueComponents.css"],function(p,g,c,v,k,q,r,l,t,w,j,u,n,b,o,s,h,d,i,a,f){var m={STATES:{CREATE:0,ASSIGN:1,ACTIVE:2,REVIEW:3,CLOSED:4},STATES_ORDER:{0:"CREATE",1:"ASSIGN",2:"ACTIVE",3:"REVIEW",4:"CLOSED"},STATES_VALUES:{CREATE:"Create",ASSIGN:"Assign",ACTIVE:"Active",REVIEW:"Review",CLOSED:"Closed"},CSS:{ELEMENTS:{GRAPH_CONTAINER:"im-lifecycle-graph-container",GRAPH_NOT_SUPPORTED:"im-lifecycle-graph-not-supported",GRAPH_NOT_SUPPORTED_TEXT:"im-lifecycle-graph-not-supported-text",GRAPH_ARIADNE:"im-lifecycle-graph-ariadne",GRAPH_ARIADNE_PLACEHOLDER:"im-lifecycle-graph-ariadne-placeholder",GRAPH_ARIADNE_ROPE:"im-lifecycle-graph-ariadne-rope",GRAPH_STATES_CONTAINER:"im-lifecycle-graph-states-ctn",GRAPH_STATE:"im-lifecycle-graph-state",GRAPH_STATE_TEXT:"im-lifecycle-graph-state-text",GRAPH_STATE_PREV:"im-lifecycle-graph-state-prev",GRAPH_STATE_CURR:"im-lifecycle-graph-state-curr",GRAPH_STATE_NEXT:"im-lifecycle-graph-state-next",GRAPH_STATE_CLICKABLE:"im-lifecycle-graph-state-clickable",GRAPH_STATE_CREATE:"im-lifecycle-graph-state-create",GRAPH_STATE_ASSIGN:"im-lifecycle-graph-state-assign",GRAPH_STATE_ACTIVE:"im-lifecycle-graph-state-active",GRAPH_STATE_REVIEW:"im-lifecycle-graph-state-review",GRAPH_STATE_CLOSED:"im-lifecycle-graph-state-closed",GRAPH_STATE_CURRENT_INDICATOR:"fonticon fonticon-expand-down im-lifecycle-graph-state-current-indicator",GRAPH_STATE_APPROVE:"fonticon fonticon-check im-lifecycle-graph-state-approve",GRAPH_STATE_REJECT:"fonticon fonticon-wrong im-lifecycle-graph-state-reject",GRAPH_STATE_INPROGRESS:"fonticon fonticon-clock im-lifecycle-graph-state-inprogress",GRAPH_HISTORY_CONTAINER:"im-lifecycle-graph-history-container",GRAPH_HISTORY_APPROVED:"fonticon fonticon-check im-lifecycle-graph-history-approved ",GRAPH_HISTORY_REJECTED:"fonticon fonticon-wrong im-lifecycle-graph-history-rejected",GRAPH_HISTORY_MORE:"fonticon fonticon-menu-dot im-lifecycle-graph-history-more",GRAPH_HISTORY_TOOLTIP:"im-lifecycle-graph-history-tooltip",GRAPH_HISTORY_TOOLTIP_TITLE:"im-lifecycle-graph-history-tooltip-title",STATE_APPROVE_MODAL:"im-lifecycle-approve-modal",STATE_APPROVE_MODAL_HEIGHT:560,STATE_APPROVE_MODAL_WIDTH:560,STATE_APPROVE_MODAL_BODY:"im-lifecycle-approve-modal-body",STATE_APPROVE_MODAL_PREVIEW:"im-lifecycle-approve-modal-preview",STATE_APPROVE_MODAL_PREVIEW_ARROW:"fonticon fonticon-2x fonticon-double-chevron-right im-lifecycle-approve-modal-preview-arrow",STATE_APPROVE_MODAL_REASON:"im-lifecycle-approve-modal-reason",STATE_APPROVE_MODAL_ATTACHMENTS:"im-lifecycle-approve-modal-attachments"}}};var e=p.extend({name:"DS/IssueComponents/lifecycle/Lifecycle",tagName:"div",className:"im-lifecycle-graph-component",_logger:null,domEvents:{"click div.im-lifecycle-graph-state":"_onStateClick"},defaultOptions:{ids:[],state:"Create",states:["Create","Assign","Active","Review","Closed"]},setup:function(x){var y=this;a.start(y.name+" setup");y._parent(x);y._logger=v.getLogger(y.name);y.elements={};y._tooltips=[];y._statesTooltips=[];y._deferred={};y.isLoaded=new c(function(A,z){y._deferred.resolve=A;y._deferred.reject=z});y.physicalIds=[];a.end(y.name+" setup")},render:function(){var C=this;a.start(C.name+" render");var D=C.elements.graph=g.createElement("div",{"class":m.CSS.ELEMENTS.GRAPH_CONTAINER});D.inject(C.container);var B=C.elements.notSupported=g.createElement("span",{"class":m.CSS.ELEMENTS.GRAPH_NOT_SUPPORTED_TEXT,html:f.lifecycle.notSupported,title:f.lifecycle.notSupported});B.inject(D);var E=g.createElement("div",{"class":m.CSS.ELEMENTS.GRAPH_ARIADNE});var A=g.createElement("div",{"class":m.CSS.ELEMENTS.GRAPH_ARIADNE_PLACEHOLDER});A.inject(E);var y=C.elements.ariadneRope=g.createElement("div",{"class":m.CSS.ELEMENTS.GRAPH_ARIADNE_ROPE});y.inject(E);E.inject(D);var z=g.createElement("div",{"class":m.CSS.ELEMENTS.GRAPH_STATES_CONTAINER});z.inject(D);var x=Object.keys(m.STATES);C.elements.states={create:null,assign:null,active:null,review:null,closed:null};C.elements.routesContainer={create:null,assign:null,active:null,review:null};x.sort(function(G,F){return m.STATES[G.toUpperCase()]-m.STATES[F.toUpperCase()]}).forEach(function(L,H){var J=m.CSS.ELEMENTS["GRAPH_STATE_"+L.toUpperCase()];var F=f.maturity[L.toLowerCase()];var K=g.createElement("span",{"class":m.CSS.ELEMENTS.GRAPH_STATE_TEXT,html:F});var I=g.createElement("div",{"class":m.CSS.ELEMENTS.GRAPH_STATE+" "+J,html:K});I.setData("state",L.toLowerCase());C.elements.states[L.toLowerCase()]=I;I.inject(z);I.hide();C._statesTooltips.push(new r({position:"top",target:K,body:f.lifecycle[L.toLowerCase()]}));if(H<x.length-1){var G=g.createElement("div",{"class":m.CSS.ELEMENTS.GRAPH_HISTORY_CONTAINER,});C.elements.routesContainer[L.toLowerCase()]=G;G.inject(z);G.hide()}});a.end(C.name+" render");return C},_renderApproveRejectButtons:function(x){var z=this;var B=h.get("widget");var y=x[0];var C=g.createElement("span",{"class":m.CSS.ELEMENTS.GRAPH_STATE_APPROVE});z._tooltips.push(new r({position:"left",target:C,body:f.replace(f.lifecycle.approveModal.header,{approveTo:y.current.approveTo.toUpperCase()})}));C.addEventListener("click",function(){var J=g.createElement("div",{"class":m.CSS.ELEMENTS.STATE_APPROVE_MODAL_BODY});var E=g.createElement("div",{"class":m.CSS.ELEMENTS.STATE_APPROVE_MODAL_PREVIEW});E.inject(J);var D=g.createElement("div",{"class":m.CSS.ELEMENTS.GRAPH_STATE+" "+m.CSS.ELEMENTS["GRAPH_STATE_"+y.current.from.toUpperCase()]+" "+m.CSS.ELEMENTS.GRAPH_STATE_CURR,html:f.maturity[y.current.from.toLowerCase()]});D.inject(E);var M=g.createElement("span",{"class":m.CSS.ELEMENTS.STATE_APPROVE_MODAL_PREVIEW_ARROW});M.inject(E);var N=g.createElement("div",{"class":m.CSS.ELEMENTS.GRAPH_STATE+" "+m.CSS.ELEMENTS["GRAPH_STATE_"+y.current.approveTo.toUpperCase()],html:f.maturity[y.current.approveTo.toLowerCase()]});N.inject(E);var L=g.createElement("div",{"class":m.CSS.ELEMENTS.STATE_APPROVE_MODAL_REASON});L.inject(J);var H=g.createElement("label",{html:f.lifecycle.approveModal.reasonLabel});H.inject(L);var I=new q({multiline:true,rows:4,placeholder:f.lifecycle.approveModal.reasonPlaceholder});I.inject(L);I.getContent().toggleClassName("highlight",I.getValue()==="");I.getContent().addEventListener("keyup",function(){I.getContent().toggleClassName("highlight",I.getValue()==="")});var G=g.createElement("div",{"class":m.CSS.ELEMENTS.STATE_APPROVE_MODAL_ATTACHMENTS});G.inject(J);var F=new o({parent:z});F.render();F.inject(G);var K=new l({animate:true,autocenter:true,closable:true,limitParent:false,overlay:true,resizable:true,visible:true,className:m.CSS.ELEMENTS.STATE_APPROVE_MODAL,header:g.createElement("h4",{html:f.replace(f.lifecycle.approveModal.header,{approveTo:f.maturity[y.current.approveTo.toLowerCase()].toUpperCase()})}),body:J,footer:[new k({value:f.lifecycle.approveModal.okButton,className:"primary",events:{onClick:function(){if(I.getValue()===""){t.displayNotification({msg:f.lifecycle.approveModal.reasonRequired,eventID:"warning"});return}b.Mask.mask(J);z._approveRoutes(z.routes,I.getValue(),F).then(function(){K.destroy()})["catch"](function(O){t.displayNotification({msg:f.lifecycle.error,eventID:"error"});z._logger.error(O);b.Mask.unmask(J)})}}}),new k({value:f.lifecycle.approveModal.cancelButton,className:"default",events:{onClick:function(){K.destroy()}}})]});K.inject(B.body);K.elements.container.setStyle("height",m.CSS.ELEMENTS.STATE_APPROVE_MODAL_HEIGHT);K.elements.container.setStyle("width",m.CSS.ELEMENTS.STATE_APPROVE_MODAL_WIDTH);K.show()});z.elements.approve=C;C.inject(z.elements.states[y.current.approveTo.toLowerCase()]);var A=g.createElement("span",{"class":m.CSS.ELEMENTS.GRAPH_STATE_REJECT});z._tooltips.push(new r({position:"left",target:A,body:f.replace(f.lifecycle.rejectModal.header,{approveTo:y.current.approveTo.toUpperCase(),rejectTo:y.current.rejectTo.toUpperCase()})}));A.addEventListener("click",function(){var H=g.createElement("div",{"class":m.CSS.ELEMENTS.STATE_APPROVE_MODAL_BODY});var K=g.createElement("div",{"class":m.CSS.ELEMENTS.STATE_APPROVE_MODAL_PREVIEW});K.inject(H);var D=g.createElement("div",{"class":m.CSS.ELEMENTS.GRAPH_STATE+" "+m.CSS.ELEMENTS["GRAPH_STATE_"+y.current.from.toUpperCase()]+" "+m.CSS.ELEMENTS.GRAPH_STATE_CURR,html:f.maturity[y.current.from.toLowerCase()]});D.inject(K);var M=g.createElement("span",{"class":m.CSS.ELEMENTS.STATE_APPROVE_MODAL_PREVIEW_ARROW});M.inject(K);var L=g.createElement("div",{"class":m.CSS.ELEMENTS.GRAPH_STATE+" "+m.CSS.ELEMENTS["GRAPH_STATE_"+y.current.rejectTo.toUpperCase()],html:f.maturity[y.current.rejectTo.toLowerCase()]});L.inject(K);var G=g.createElement("div",{"class":m.CSS.ELEMENTS.STATE_APPROVE_MODAL_REASON});G.inject(H);var I=g.createElement("label",{html:f.lifecycle.rejectModal.reasonLabel});I.inject(G);var J=new q({multiline:true,rows:4,placeholder:f.lifecycle.rejectModal.reasonPlaceholder});J.inject(G);J.getContent().toggleClassName("highlight",J.getValue()==="");J.getContent().addEventListener("keyup",function(){J.getContent().toggleClassName("highlight",J.getValue()==="")});var N=g.createElement("div",{"class":m.CSS.ELEMENTS.STATE_APPROVE_MODAL_ATTACHMENTS});N.inject(H);var F=new o({parent:z});F.render();F.inject(N);var E=new l({animate:true,autocenter:true,closable:true,limitParent:false,overlay:true,resizable:true,visible:true,className:m.CSS.ELEMENTS.STATE_APPROVE_MODAL,header:g.createElement("h4",{html:f.replace(f.lifecycle.rejectModal.header,{approveTo:f.maturity[y.current.approveTo.toLowerCase()].toUpperCase(),rejectTo:f.maturity[y.current.rejectTo.toLowerCase()].toUpperCase()})}),body:H,footer:[new k({value:f.lifecycle.rejectModal.okButton,className:"primary",events:{onClick:function(){if(J.getValue()===""){t.displayNotification({msg:f.lifecycle.rejectModal.reasonRequired,eventID:"warning"});J.elements.container.addClassName("highlight");return}b.Mask.mask(H);z._rejectRoutes(z.routes,J.getValue(),F).then(function(){E.destroy()})["catch"](function(O){t.displayNotification({msg:f.lifecycle.error,eventID:"error"});z._logger.error(O);b.Mask.unmask(H)})}}}),new k({value:f.lifecycle.rejectModal.cancelButton,className:"default",events:{onClick:function(){E.destroy()}}})]});E.inject(B.body);E.elements.container.setStyle("height",m.CSS.ELEMENTS.STATE_APPROVE_MODAL_HEIGHT);E.elements.container.setStyle("width",m.CSS.ELEMENTS.STATE_APPROVE_MODAL_WIDTH);E.show()});z.elements.reject=A;A.inject(z.elements.states[y.current.approveTo.toLowerCase()])},_renderInProgressIndicator:function(F){var A=this;var E=g.createElement("span",{"class":m.CSS.ELEMENTS.GRAPH_STATE_INPROGRESS});A.elements.inProgressIndicator=E;var x=g.createElement("div",{"class":m.CSS.ELEMENTS.GRAPH_HISTORY_TOOLTIP});var D=F[0];if(F.length>1){A._tooltips.push(new r({position:"bottom",target:E,body:"<span>"+f.lifecycle.routeIndicatorTooltip.inProgressTooltip.multiSelectionTitle+"</span>"}));E.inject(A.elements.states[D.current.approveTo.toLowerCase()])}else{if(F.length===1){var H=D.current.reviewers;var G=D.current.decisions.filter(function(I){return I.status==="approved"||I.status==="rejected"}).map(function(I){return I.reviewer.user});var z=H.filter(function(I){return G.indexOf(I.user)===-1});if(z.length>0){var C=g.createElement("div",{html:'<span class="'+m.CSS.ELEMENTS.GRAPH_HISTORY_TOOLTIP_TITLE+'">'+f.lifecycle.routeIndicatorTooltip.inProgressTooltip.title+"</span>"});z.forEach(function(J){var I=g.createElement("span",{html:"<span>"+J.fullName+"</span>"});I.inject(C)});C.inject(x)}var B=D.current.decisions.filter(function(I){return I.status==="approved"});if(B.length>0){var y=g.createElement("div",{html:'<span class="'+m.CSS.ELEMENTS.GRAPH_HISTORY_TOOLTIP_TITLE+'">'+f.lifecycle.routeIndicatorTooltip.approvalTitle+"</span>"});B.forEach(function(J){var I=f.replace(f.lifecycle.routeIndicatorTooltip.approvalText,{name:J.reviewer.fullName,date:(new Date(J.date)).toLocaleString(h.get("widget").lang)});var K=g.createElement("span",{html:"<span>"+I+"</span>"});K.inject(y)});y.inject(x)}A._tooltips.push(new r({position:"bottom",target:E,body:x}));E.inject(A.elements.states[D.current.approveTo.toLowerCase()])}}},_renderRoutesHistory:function(y){var z=this;if(Array.isArray(y.history)&&y.history.length>0){z.elements.routesIndicators={create:{more:null,last:null,nonLast:[]},assign:{more:null,last:null,nonLast:[]},active:{more:null,last:null,nonLast:[]},review:{more:null,last:null,nonLast:[]}};var x={create:[],assign:[],active:[],review:[]};y.history.forEach(function(A){x[A.from.toLowerCase()].push(A)});Object.keys(x).forEach(function(B){z.elements.routesContainer[B].empty();var A=g.createElement("div",{"class":m.CSS.ELEMENTS.GRAPH_HISTORY_MORE});A.inject(z.elements.routesContainer[B]);A.hide();z.elements.routesIndicators[B].more={element:A,tooltip:null};x[B]=x[B].sort(function(D,C){if(!D.date){return 1}else{if(!C.date){return -1}else{var F=new Date(D.date);var E=new Date(C.date);return F-E}}});x[B].forEach(function(G,H){var I=G.status==="approved"?m.CSS.ELEMENTS.GRAPH_HISTORY_APPROVED:m.CSS.ELEMENTS.GRAPH_HISTORY_REJECTED;var K=g.createElement("div",{"class":I});K.addEventListener("click",function(){z.dispatchEvent("request:openRoute",{issueId:y.physicalId,route:G})});var E=z.elements.routesContainer[B];K.inject(E);if(H===(x[B].length-1)){z.elements.routesIndicators[B].last={data:G,element:K}}else{z.elements.routesIndicators[B].nonLast.unshift({data:G,element:K})}var D=g.createElement("div",{"class":m.CSS.ELEMENTS.GRAPH_HISTORY_TOOLTIP});var L=G.decisions.filter(function(M){return M.status==="rejected"});if(L.length>0){var C=g.createElement("div",{html:'<span class="'+m.CSS.ELEMENTS.GRAPH_HISTORY_TOOLTIP_TITLE+'">'+f.lifecycle.routeIndicatorTooltip.rejectionTitle+"</span>"});L.forEach(function(M){var N=f.replace(f.lifecycle.routeIndicatorTooltip.rejectionText,{name:M.reviewer.fullName,date:(new Date(M.date)).toLocaleString(h.get("widget").lang)});var O=g.createElement("span",{html:"<span>"+N+"</span>"});O.inject(C)});C.inject(D)}var J=G.decisions.filter(function(M){return M.status==="approved"});if(J.length>0){var F=g.createElement("div",{html:'<span class="'+m.CSS.ELEMENTS.GRAPH_HISTORY_TOOLTIP_TITLE+'">'+f.lifecycle.routeIndicatorTooltip.approvalTitle+"</span>"});J.forEach(function(N){var M=f.replace(f.lifecycle.routeIndicatorTooltip.approvalText,{name:N.reviewer.fullName,date:(new Date(N.date)).toLocaleString(h.get("widget").lang)});var O=g.createElement("span",{html:"<span>"+M+"</span>"});O.inject(F)});F.inject(D)}z._tooltips.push(new r({position:"bottom",target:K,body:D}))})})}},refresh:function(y){var x=this;x.physicalIds=y;return d.routes.retrieve({data:{objects:y.map(function(z){return{physicalId:z}})}}).then(function(E){x.reset();x.routes=E.map(function(L){return L.body});var D=x.routes.every(function(L){return L.state===x.routes[0].state});if(y.length===E.length&&D){var F=g.is(x.routes[0].current,"object")&&g.is(x.routes[0].current.from,"string");var A=x.routes.every(function(L){return(g.is(L.current,"object")&&g.is(L.current.from,"string"))===F});if(!A){x.container.addClassName(m.CSS.ELEMENTS.GRAPH_NOT_SUPPORTED)}else{var I=x.routes[0];var B=I.state;var J=m.STATES[B.toUpperCase()];var K=m.STATES_ORDER[J+1];var H=m.STATES_ORDER[J-1];Object.keys(x.elements.states).forEach(function(L){if(L!==m.STATES_VALUES.CLOSED.toLowerCase()){x.elements.states[L].toggleClassName(m.CSS.ELEMENTS.GRAPH_STATE_CLICKABLE,false)}else{x.elements.states[L].toggleClassName(m.CSS.ELEMENTS.GRAPH_STATE_CLICKABLE,true)}x.elements.states[L].removeClassName(m.CSS.ELEMENTS.GRAPH_STATE_CURR);if(L===I.state.toLowerCase()){x.elements.states[L].addClassName(m.CSS.ELEMENTS.GRAPH_STATE_CURR);x.elements.currentIndicator=g.createElement("span",{"class":m.CSS.ELEMENTS.GRAPH_STATE_CURRENT_INDICATOR});x.elements.currentIndicator.inject(x.elements.states[L])}});if(I.current&&I.current.from===B){if(K!==undefined){x.elements.states[K.toLowerCase()].toggleClassName(m.CSS.ELEMENTS.GRAPH_STATE_CLICKABLE,false)}if(H!==undefined){x.elements.states[H.toLowerCase()].toggleClassName(m.CSS.ELEMENTS.GRAPH_STATE_CLICKABLE,false)}var C=i.getUserName();var z=x.routes.every(function(M){var L=M.current.reviewers.map(function(N){return N.user});return L.indexOf(C)!==-1});if(z){var G=x.routes.some(function(L){var M=L.current.decisions.filter(function(N){return N.status==="approved"||N.status==="rejected"}).map(function(N){return N.reviewer.user});return M.indexOf(C)===-1});if(G){x._renderApproveRejectButtons(x.routes)}else{x._renderInProgressIndicator(x.routes)}}else{x._renderInProgressIndicator(x.routes)}}else{if(K!==undefined){x.elements.states[K.toLowerCase()].toggleClassName(m.CSS.ELEMENTS.GRAPH_STATE_CLICKABLE,true);x.elements.states[m.STATES_VALUES.CLOSED.toLowerCase()].toggleClassName(m.CSS.ELEMENTS.GRAPH_STATE_CLICKABLE,true)}if(H!==undefined){x.elements.states[H.toLowerCase()].toggleClassName(m.CSS.ELEMENTS.GRAPH_STATE_CLICKABLE,true)}}}if(x.routes.length===1){x._renderRoutesHistory(x.routes[0])}}else{x.container.addClassName(m.CSS.ELEMENTS.GRAPH_NOT_SUPPORTED)}}).then(function(){x.resize();x.dispatchEvent("onReady")})},resize:function(){var F=this;if(!Array.isArray(F.routes)||F.routes.length===0){return}var z=Object.keys(F.elements.states);var Q=F.routes[0].state.toLowerCase();var D=m.STATES[Q.toUpperCase()];var G=F.container.offsetWidth;var K=(80+20);var H=Math.floor(G/(K+40));H=(H>z.length)?5:H;z.forEach(function(R){F.elements.states[R].hide();if(F.elements.routesContainer[R]!==undefined&&F.elements.routesContainer[R]!==null){F.elements.routesContainer[R].hide()}});F.elements.states[Q].show();if(F.elements.routesContainer[Q]!==undefined&&F.elements.routesContainer[Q]!==null){F.elements.routesContainer[Q].show()}if(Q==="closed"){var M=D-1;var A=m.STATES_ORDER[M].toLowerCase();F.elements.states[A].show();if(F.elements.routesContainer[A]!==undefined&&F.elements.routesContainer[A]!==null){F.elements.routesContainer[A].show()}}else{var O=D+1;var E=m.STATES_ORDER[O].toLowerCase();F.elements.states[E].show()}if(H>=2){var I=(Q==="closed")?(D-1):D;for(var L=0;L<H-2;L++){var x=(I-L-1);if(x>=0){var P=m.STATES_ORDER[x].toLowerCase();F.elements.states[P].show();if(F.elements.routesContainer[P]!==undefined&&F.elements.routesContainer[P]!==null){F.elements.routesContainer[P].show()}}else{x=L+2;var N=m.STATES_ORDER[x].toLowerCase();F.elements.states[N].show();var C=m.STATES_ORDER[x-1].toLowerCase();if(F.elements.routesContainer[C]!==undefined&&F.elements.routesContainer[C]!==null){F.elements.routesContainer[C].show()}}}}var B=G-(K*H);var J=B/(H-1);Object.keys(F.elements.routesContainer).forEach(function(R){F.elements.routesContainer[R].setStyle("width",J);if(F.elements.routesIndicators!==undefined&&F.elements.routesIndicators!==null){if(F.elements.routesIndicators[R].last!==null){F.elements.routesIndicators[R].last.element.show()}if(Array.isArray(F.elements.routesIndicators[R].nonLast)&&F.elements.routesIndicators[R].nonLast.length===1){F.elements.routesIndicators[R].nonLast[0].element.show();F.elements.routesIndicators[R].more.element.hide()}else{if(F.elements.routesIndicators[R].nonLast.length>1){var Y=Math.floor(J/(20+6))-1;var aa=0;F.elements.routesIndicators[R].nonLast.forEach(function(ab,ac){if(aa<Y){if(aa===Y-1&&ac<F.elements.routesIndicators[R].nonLast.length-1){ab.element.hide();aa=aa+1}else{ab.element.show();aa=aa+1}}else{ab.element.hide()}});var V=F.elements.routesIndicators[R].nonLast.filter(function(ab){return ab.element.isHidden()});if(V.length>0){F.elements.routesIndicators[R].more.element.show();if(F.elements.routesIndicators[R].more.tooltip!==null){try{F.elements.routesIndicators[R].more.tooltip.destroy()}catch(X){}}var S=g.createElement("div",{"class":m.CSS.ELEMENTS.GRAPH_HISTORY_TOOLTIP,html:'<span class="'+m.CSS.ELEMENTS.GRAPH_HISTORY_TOOLTIP_TITLE+'">'+f.replace(f.lifecycle.routeIndicatorTooltip.moreTooltip.title,{number:V.length,})+"</span>",});for(var W=V.length-1;W>=0;W--){var T=V[W].data.date;var U=V[W].data.status==="approved"?"approvalText":"rejectionText";var Z=g.createElement("div",{html:"<span>"+f.replace(f.lifecycle.routeIndicatorTooltip.moreTooltip[U],{date:(new Date(T)).toLocaleString(h.get("widget").lang)})+"</span>"});Z.inject(S)}F.elements.routesIndicators[R].more.tooltip=new r({position:"bottom",target:F.elements.routesIndicators[R].more.element,body:S})}else{F.elements.routesIndicators[R].more.element.hide();if(F.elements.routesIndicators[R].more.tooltip!==null){try{F.elements.routesIndicators[R].more.tooltip.destroy()}catch(X){}}}}}}});var y=F.elements.states[Q].offsetLeft;F.elements.ariadneRope.setStyles({width:y+"px"})},reset:function(){var y=this;y.container.removeClassName(m.CSS.ELEMENTS.GRAPH_NOT_SUPPORTED);Object.keys(y.elements.states).forEach(function(z){if(z!==m.STATES_VALUES.CLOSED.toLowerCase()){y.elements.states[z].toggleClassName(m.CSS.ELEMENTS.GRAPH_STATE_CLICKABLE,false)}else{y.elements.states[z].toggleClassName(m.CSS.ELEMENTS.GRAPH_STATE_CLICKABLE,true)}y.elements.states[z].removeClassName(m.CSS.ELEMENTS.GRAPH_STATE_CURR);if(y.elements.routesContainer[z]!==undefined){y.elements.routesContainer[z].empty()}});if(y.elements.currentIndicator){y.elements.currentIndicator.destroy()}if(y.elements.approve){y.elements.approve.destroy()}if(y.elements.reject){y.elements.reject.destroy()}if(y.elements.inProgressIndicator){y.elements.inProgressIndicator.destroy()}try{y._tooltips.forEach(function(z){z.destroy()})}catch(x){}y._tooltips=[]},destroy:function(){var y=this;y.reset();try{y._statesTooltips.forEach(function(z){z.destroy()})}catch(x){}y._statesTooltips=[]},_onStateClick:function(x){var D=this;var A=null;if(x.target.hasClassName(m.CSS.ELEMENTS.GRAPH_STATE)){A=x.target}else{if(x.target.getParent().hasClassName(m.CSS.ELEMENTS.GRAPH_STATE)){A=x.target.getParent()}}if(A!==null&&A.hasClassName(m.CSS.ELEMENTS.GRAPH_STATE_CLICKABLE)){var y=D.routes[0].state.toLowerCase();var F=A.getData("state");var E=m.STATES[F.toUpperCase()]-m.STATES[y.toUpperCase()];if(E===1||E===-1){b.Mask.mask(D.container);var z=E===1?"promote":"demote";var C=D.routes.map(function(G){return{physicalId:G.physicalId,state:m.STATES_VALUES[F.toUpperCase()]}});d.issues[z]({data:{objects:C}}).then(function(G){if(G.status==="failure"){for(var H=0;H<G.report.length;H++){t.displayNotification({msg:G.report[H].error,eventID:"error"})}D._logger.error(new Error("Unexpected error from promotion/demotion service."))}if(E===1){D.dispatchEvent("onPromotionCompleted",{issues:C})}else{D.dispatchEvent("onDemotionCompleted",{issues:C})}})["catch"](function(G){var H=f.lifecycle.error;if(G&&G.error&&g.is(G.error.message,"string")){H=G.error.message}t.displayNotification({msg:H,eventID:"error"});D._logger.error(G)})["finally"](function(){D.refresh(D.physicalIds).then(function(){b.Mask.unmask(D.container)})})}else{if(F===m.STATES_VALUES.CLOSED.toLowerCase()&&E!==1){var B=D.routes.map(function(G){return G.physicalId});new s({physicalIds:B}).render()}else{t.displayNotification({msg:f.replace((E>0)?f.kanban.dnd.unsupportedPromote:f.kanban.dnd.unsupportedDemote,{currState:y,state:F}),eventID:"error"});D._logger.error(new Error("Unexpected or unsupported promotion/demotion."))}}}else{}},_approveRoutes:function(y,A,x){var z=this;b.Mask.mask(z.container);return d.routes.approve({data:{objects:y.map(function(B){return{physicalId:B.physicalId,comment:A}})}}).then(function(D){var B=D.map(function(E){return{physicalId:E.body.physicalId,task:E.body.task}});z.dispatchEvent("onApprovalCompleted",{issues:B});var C=y.map(function(E){return E.physicalId});return z._connectAttachments(C,x).then(function(){})})["finally"](function(){z.refresh(z.physicalIds).then(function(){b.Mask.unmask(z.container)})})},_rejectRoutes:function(y,A,x){var z=this;b.Mask.mask(z.container);return d.routes.reject({data:{objects:y.map(function(B){return{physicalId:B.physicalId,reason:A}})}}).then(function(D){var B=D.map(function(E){return{physicalId:E.body.physicalId,task:E.body.task}});z.dispatchEvent("onRejectionCompleted",{issues:B});var C=y.map(function(E){return E.physicalId});return z._connectAttachments(C,x).then(function(){})})["finally"](function(){z.refresh(z.physicalIds).then(function(){b.Mask.unmask(z.container)})})},_connectAttachments:function(x,A){var E=this;var B=h.get("widget");var C=A.collection;var F=function(L){this.set("isCancelable",true);this.set("request",L)};var G=function(M){if(M.lengthComputable){var L=M.loaded/M.total;this.set("requestProgress",L)}};var I=function(){this.set("isCancelable",false);this.set("request",null)};var D=C.filter(function(L){return L.get("isFile")===true}).map(function(L){var M=L.clone();M.set("isProcessing",true);return M});var y=[];if(D.length>0){var K=new w({id:"uploadAttachmentsToRoutes",attachments:D});var z=new u({collection:K,layout:2}).render();var H=new l({animate:true,autocenter:true,closable:true,limitParent:false,overlay:false,resizable:true,visible:true,className:"im-lifecycle-file-upload-dialog",title:f.replace(f.create.attachments.uploadDialog.title,{number:K.size()}),header:null,body:z,events:{onClose:function(){H.destroy()}}}).inject(B.body);var J=0;y=D.map(function(L){var M=j.uploadFile(L.get("file"),null,{onCheckinStart:F.bind(L),onCheckinProgress:G.bind(L),onCheckinComplete:I.bind(L)});M=M.then(function(N){if(N&&N.data&&N.data.length>0&&N.data[0].id){C.get(L.id).set("isFile",false);C.get(L.id).set("id",N.data[0].id);L.set("id",N.data[0].id);L.set("isFile",false);L.set("isProcessing",false);J++}})["catch"](function(N){L.set("isFailed",true);L.set("isProcessing",false);L.set("isCancelable",false);L.set("request",null);if(N instanceof Error){t.displayNotification({msg:n.replace(n.notifications.Upload.failure,{count:1}),eventID:"error"});E._logger.error(N)}});return M});c.all(y)["finally"](function(){H.setTitle(f.replace(f.create.attachments.uploadDialog.uploadCompleted,{success:J,total:y.length,}))})}return c.all(y).then(function(){var M=C.filter(function(N){return N.get("isFile")!==true}).map(function(N){return N.clone()});var L=[];if(M.length>0){x.forEach(function(N){L.push(M.map(function(O){return j.connectDocumentToParent(O.id,N)["catch"](function(P){t.displayNotification({msg:n.replace(n.notifications.Attach.failure,{count:1}),eventID:"error"});E._logger.error(P)})}))})}return c.all(L)})}});return e});define("DS/IssueComponents/search/PeopleSearch",["DS/PADUtils/views/PADAlert","DS/SearchWidget/controllers/SW_FullPos_Controller","DS/IssueComponents/search/PeopleSearchUI","DS/IssueServices/services/PlatformServices","i18n!DS/IssueComponents/assets/nls/IssueComponents"],function(b,d,a,c,e){return d.extend({init:function(f){var h=this;h._parent(f);var g=f.events;if(g===null){g={}}g.onExpressSearch=function(){h.expressSearch()};f.events=g;h.searchWidgetUI.destroy();h.searchWidgetUI=h.container=new a(f)},expressSearch:function(){var l=this;var m=[];var j="";var k=function(){if(j.length>0){j=j.trim();j=j.replace(/.$/,"");b.displayNotification({msg:e.replace(e.search.error.usersNotFound,{users:j}),eventID:"info"})}};var h=function(){if(m.length>0){var o=Object.assign({},m);l.dispatchEvent("onValidUsers",o)}k()};var n=l.searchWidgetUI.searchInput.getValue().trim();var f=0,i=n.split(";");var g=function(o){return o!==""};i=i.filter(g);if(i.length>0){i.forEach(function(o){o=o.trim();c.getUserInfo(o,{onComplete:function(p){f+=1;var q=JSON.parse(p);m.push(q);if(f===i.length){h()}},onFailure:function(){f+=1;j=j+o+", ";if(f===i.length){h()}}})})}}})});define("DS/IssueComponents/team/Team",["UWA/Class/Promise","UWA/Class/View","UWA/Core","DS/UIKIT/Iconbar","DS/UIKIT/Input/Button","DS/UIKIT/Input/Text","DS/UIKIT/Mask","DS/UIKIT/Scroller","DS/UIKIT/Tooltip","DS/ENOFloatingPanel/ENOFloatingPanel","DS/Logger/Logger","DS/PADUtils/views/PADAlert","DS/SearchWidget/SearchWidgetConstant","DS/IssueCommon/commands/CommandsManager","DS/IssueComponents/search/PeopleSearch","DS/IssueServices/services/IssueServices","DS/IssueServices/services/PlatformServices","DS/IssueServices/Contexts","DS/IssueServices/utils/Performance","i18n!DS/IssueComponents/assets/nls/IssueComponents","css!DS/IssueComponents/IssueComponents.css"],function(e,q,h,j,l,r,x,u,s,m,w,t,n,a,v,f,k,i,d,g){var o={owners:"owner",coOwners:"coOwners",assignees:"assignees",participants:"participants"};var p={LIST:"list",THUMBNAIL:"thumbnail"};var c="_PRJ";var b=q.extend({name:"DS/IssueComponents/team/Team",tag:"div",className:"team-view-panel",setup:function(y){var z=this;z._logger=w.getLogger("DS/IssueComponents/team/Team");z._logger.log("Initializing the team component");z.isLoaded=null;z._deferred={resolve:null,reject:null};z.physicalIds=y.physicalIds;z.issues=[];z.options=y;z._tooltips=[];z.reset()},reset:function(){var y=this;y.isLoaded=new e(function(A,z){y._deferred.resolve=A;y._deferred.reject=z});y.members={};if(h.is(y.view,"object")){if(y.view.container){y.view.container.destroy()}if(y.view.scrollerContainer){y.view.scrollerContainer.destroy()}}y.view={container:null,scroller:null,scrollerContainer:null};y.mainHeader={container:null};y.filter={container:null,input:null,isHidden:true,reg:null};y.owners={roleName:o.owners,isUnique:false,users:{},container:null,header:{container:null,title:{container:null,label:null}},content:null,commonUsers:{},notSavedUsers:{},userContainers:{},layout:p.LIST};y.coOwners={roleName:o.coOwners,isUnique:false,users:{},container:null,header:{container:null,title:{container:null,label:null,count:{},filteredCount:null},search:{container:null},iconBar:{container:null}},content:null,commonUsers:{},notSavedUsers:{},userContainers:{},layout:p.LIST};y.assignees={roleName:o.assignees,isUnique:false,users:{},container:null,header:{container:null,title:{container:null,label:null,count:{},filteredCount:null},search:{container:null},iconBar:{container:null}},content:null,commonUsers:{},notSavedUsers:{},userContainers:{},layout:p.LIST};y.participants={roleName:o.participants,isUnique:false,users:{},container:null,header:{container:null,title:{container:null,label:null,count:{},filteredCount:null},search:{container:null},iconBar:{container:null}},content:null,commonUsers:{},notSavedUsers:{},userContainers:{},layout:p.THUMBNAIL};y._tooltips.forEach(function(z){z.destroy()});y._tooltips=[]},destroy:function(){var z=this;if(z.view){if(z.view.container){z.view.container.destroy()}if(z.view.scrollerContainer){z.view.scrollerContainer.destroy()}}for(var y in z){if(z.hasOwnProperty(y)){delete z[y]}}},render:function(){var A=this;x.mask(A.container);A.view={};A.view.container=h.createElement("div",{"class":"team-view-container"});var y=h.createElement("div",{"class":"team-view-scrollerContainer"}).inject(A.container);var z=h.createElement("div",{"class":"team-view-scroller"}).inject(y);A.view.scroller=new u({element:z}).inject(y);A.view.scrollerContainer=y;A.view.container.inject(A.view.scroller.getInnerElement());A.renderFilterView();A.renderOwnersView();A.createSubContainerLayout(A.coOwners);A.createSubContainerLayout(A.assignees);A.createSubContainerLayout(A.participants);A.loadContent(A.physicalIds).then(function(C){A.issues=C;if(C&&C.length>0){if(C.length>1){A.view.container.addClassName("multiple-issues-selected")}var F=A.getUsersMap(C,A.owners.roleName);A.addUsers(A.owners,F);var E=A.getUsersMap(C,A.coOwners.roleName);A.addUsers(A.coOwners,E);var D=A.getUsersMap(C,A.assignees.roleName);A.addUsers(A.assignees,D);var B=A.getUsersMap(C,A.participants.roleName);A.addUsers(A.participants,B)}x.unmask(A.container);A._deferred.resolve();A.dispatchEvent("onReady",{})},function(B){x.unmask(A.container);A._deferred.reject(B);A.dispatchEvent("onFailure",{error:B})});return A},refresh:function(z){var y=this;y.reset();if(Array.isArray(z)){y.physicalIds=z;y.setOption("physicalIds",z)}y.render();return y.isLoaded},renderFilterView:function(){var y=this;y.mainHeader.container=h.createElement("div",{"class":"team-main-header"}).inject(y.view.container);y.mainHeader.title={};y.mainHeader.title.container=h.createElement("div",{"class":"team-main-header-title"}).inject(y.mainHeader.container);y.mainHeader.label={};y.mainHeader.label.container=h.createElement("div",{"class":"team-main-header-label",html:g.replace(g.team.title,{count:Object.keys(y.members).length.toString()})}).inject(y.mainHeader.title.container);y.mainHeader.iconBar=new j({renderTo:y.mainHeader.title.container,items:[{name:"Filter",className:"team-main-header-iconbar team-header-iconbar",fonticon:"filter",text:g.team.filter.title,handler:function(){var z=y.mainHeader.iconBar.getItem("Filter").elements.icon;if(y.filter.isHidden){z.addClassName("btn-active");y.filter.isHidden=false;y.filter.container.show();y.filter.input.focus()}else{z.removeClassName("btn-active");y.filter.isHidden=true;y.filter.container.hide();y.filter.input.setValue("");y.filterContent("")}}}]});y.filter.container=h.createElement("div",{"class":"team-filter-container"}).inject(y.mainHeader.container);y.filter.input=new r({id:"team-filter",className:"team-filter",value:"",required:true,placeholder:g.team.filter.placeholder,events:{}});y.filter.input.inject(y.filter.container);y.filter.input.elements.input.onkeyup=function(){y.filterContent(y.filter.input.getValue())};y.filter.input.elements.input.onkeydown=function(A){var z=true;if("/\\!@#$%^&*()_+-=`~][|}{\":<>,.;'".indexOf(A.key)>-1){z=false}return z};y.filter.reg=new RegExp("","i");y.filter.isHidden=true;y.filter.container.hide()},renderOwnersView:function(){var y=this;y.createSubContainerLayout(y.owners);y.owners.iconBar=new j({renderTo:y.owners.header.container,items:[{name:"ChangeOwnership",fonticon:"user-change",text:g.team[y.owners.roleName].changeOwnership,handler:function(){a.getCommand("ChangeOwner").begin()}}]})},createSubContainerLayout:function(A){var y=this;var B=(A.layout===p.THUMBNAIL);A.container=h.createElement("div",{"class":"team-sub-container"}).inject(y.view.container);A.header.container=h.createElement("div",{"class":"team-header"}).inject(A.container);A.header.title={};A.header.title.container=h.createElement("div",{"class":"team-header-title"}).inject(A.header.container);A.header.title.container.addClassName("team-header-title-expandable");A.header.title.expandIcon=h.createElement("span",{"class":"fonticon fonticon-expand-down team-header-title-expand-icon"}).inject(A.header.title.container);A.isExpanded=true;A.header.title.container.addEventListener("click",function(){if(A.isExpanded){A.header.title.expandIcon.removeClassName("fonticon-expand-down");A.header.title.expandIcon.addClassName("fonticon-expand-right");A.content.hide();A.isExpanded=false}else{A.header.title.expandIcon.removeClassName("fonticon-expand-right");A.header.title.expandIcon.addClassName("fonticon-expand-down");A.content.show();A.isExpanded=true}});A.header.title.label=h.createElement("div",{"class":"team-header-title-label",html:g.team[A.roleName].title}).inject(A.header.title.container);A.header.title.count=h.createElement("div",{"class":"team-header-title-count",html:Object.keys(A.users).length.toString()}).inject(A.header.title.container);if(A.roleName!==o.owners){A.header.search.container=h.createElement("div",{"class":"team-header-search-container"}).inject(A.header.container);if(y.physicalIds&&y.physicalIds.length){A.header.search.widget=new v({className:"team-header-search-widget",ForbiddenChar:"",MaxNumber:"5",MaxSize:"300",position:"auto",showEmptyCategory:false,type:n.TYPE_PERSON,hint:g.team[A.roleName].search.placeholder,events:{onValid:function(){if(!A.header.search.widget.getNewOwner()||!A.header.search.widget.getNewOwner().person){}else{var D=A.header.search.widget.getNewOwner().person,C={firstName:D.personFirstName,fullName:D.personFullName,lastName:D.personLastName,user:D.personID.replace(c,""),notSaved:true};y.addNotSavedUser(A,C);y.save(A);A.header.search.widget.clearInput();A.header.search.widget.getContent().searchInput.focus()}},onUnvalid:function(){},onError:function(){},onValidUsers:function(C){var D=Object.keys(C).map(function(E){return C[E]});new e(function(E){D.forEach(function(G){var F={firstName:G.firstname,fullName:G.firstname+" "+G.lastname,lastName:G.lastname,user:G.name,notSaved:true};y.addNotSavedUser(A,F)});E()}).then(function(){y.save(A)});A.header.search.widget.clearInput();A.header.search.widget.getContent().searchInput.focus()}}});var z=y.physicalIds.map(function(C){return{objectID:C}});A.header.search.widget.setSelectedItemList(z);A.header.search.widget.inject(A.header.search.container);A.header.search.isActive=false;A.header.search.widget.hide()}A.header.iconBar.container=h.createElement("div",{"class":"team-header-iconbar-container"}).inject(A.header.container);A.iconBar=new j({renderTo:A.header.iconBar.container,items:[{className:"team-header-iconbar team-header-iconbar-propagate-all disabled",name:"PropagateAll",fonticon:"propagate",text:g.team[A.roleName].propagateAll,handler:function(){var E=Object.keys(A.users).map(function(F){return A.users[F]});for(var C=0;C<E.length;C++){x.mask(A.userContainers[E[C].user])}y.addPeople(A,E).then(function D(){for(var F=0;F<E.length;F++){x.unmask(A.userContainers[E[F].user]);y.addUser(A,E[F],true,false)}})}},{className:"team-header-iconbar",name:"Add",fonticon:"user-add",text:g.team[A.roleName].add,handler:function(){y.toggleEditMode(A)}},{className:"divider"},{className:"team-header-iconbar",name:"ChangeLayout",fonticon:B?"view-small-thb":"view-list",text:g.team.changeLayout,handler:function(){y.toggleLayout(A)}}]})}A.content=h.createElement("div",{"class":B?"team-content-thumbnail":"team-content"}).inject(A.container);A.placeHolder=h.createElement("div",{"class":"team-content-placeholder"});if(A.roleName!==o.coOwners&&A.roleName!==o.participants){A.placeHolder=h.createElement("div",{"class":"team-content-placeholder",html:{"class":"label-holder",html:g.team[A.roleName].addSelf},events:{click:function(){var C={user:k.getUserName(),fullName:k.getFullName()};y.addNotSavedUser(A,C);y.save(A)}}})}A.placeHolder.inject(A.container);if(A.roleName!==o.owners){y._addDropEvent(A)}},_addDropEvent:function(A){var z=this;var B=A.container;var y=0;B.addEventListener("drop",z._onDrop.bind({component:z,data:A}));B.addEventListener("dragenter",function(){B.addClassName("drag-enter");y+=1});B.addEventListener("dragleave",function(){y-=1;if(y===0){B.removeClassName("drag-enter")}});document.addEventListener("dragover",function(C){C.preventDefault()})},_onDrop:function(C){C.currentTarget.removeClassName("drag-enter");C.preventDefault();var B=this.component;var D=this.data;var A;if(C.dataTransfer.getData("text/searchitems")!==""){A=JSON.parse(C.dataTransfer.getData("text/searchitems"))}else{if(C.dataTransfer.getData("text/plain")!==""){try{A=JSON.parse(C.dataTransfer.getData("text/plain"))}catch(z){}}}if(A&&A.data&&A.data.items){var y=A.data.items.every(function(E){return E.objectType==="pno:Person"});if(y===true){A.data.items.forEach(function(F){var E={user:F.objectId.split(":")[1],fullName:F.displayName,notSaved:true};B.addNotSavedUser(D,E)});B.save(D)}else{t.displayNotification({msg:g.team.error.notSupportedDrop,eventID:"error"})}}else{t.displayNotification({msg:g.team.error.notSupportedDrop,eventID:"error"})}},toggleEditMode:function(z,y){var B=z.iconBar;var A=B.getItem("Add");if(z.header.search.isActive||y){A.elements.icon.removeClassName("btn-active");Object.keys(z.userContainers).forEach(function(C){z.userContainers[C].removeClassName("editable")});z.header.search.widget.hide();z.header.search.widget.clearInput();z.header.search.isActive=false}else{A.elements.icon.addClassName("btn-active");if(Object.keys(z.notSavedUsers).length===0){B.disableItem("Save");B.disableItem("Discard")}Object.keys(z.userContainers).forEach(function(C){z.userContainers[C].addClassName("editable")});z.header.search.widget.show();z.header.search.widget.getContent().searchInput.focus();z.header.search.isActive=true}},toggleLayout:function(z){if(z.layout===p.THUMBNAIL){z.layout=p.LIST}else{z.layout=p.THUMBNAIL}z.content.toggleClassName("team-content-thumbnail");z.content.toggleClassName("team-content");var y=z.iconBar.getItem("ChangeLayout");y.elements.icon.toggleClassName("fonticon-view-small-thb");y.elements.icon.toggleClassName("fonticon-view-list")},loadContent:function(y){var z=this;return new e(function(B,A){f.issues.retrieve({timestamp:z._timestampUpdate?z._timestampUpdate:null,data:{objects:y.map(function(C){return{physicalId:C}})},onComplete:function(D){if(Array.isArray(D)){var G=D.map(function(H){return H.body});var E=[];for(var F=0;F<G.length;F++){var C={id:G[F].physicalId,name:G[F].name,state:G[F].state,title:G[F].title?G[F].title:"",type:G[F].type,assignees:G[F].assignees,coOwners:G[F].coOwners,owner:G[F].owner,participants:G[F].participants};E.push(C)}B(E)}else{A(new Error("Unexpected response when retrieving issues."))}},onFailure:function(C){z._logger.error(C);t.displayNotification({msg:g.team.error.loadContent,eventID:"error"});A(C)}})})},getUsersMap:function(z,y){var A={};if(z&&z.length>0){A=z.reduce(function(D,E){if(E[y]){if(Array.isArray(E[y])){var B=E[y];for(var C=0;C<B.length;C++){D[E[y][C].user]=E[y][C]}}else{D[E[y].user]=E[y]}}return D},{})}return A},isUserCommonToAllIssues:function(A,y){var z=this;return z.issues.every(function(E){var D=false,B=A.roleName;if(E[B]){if(Array.isArray(E[B])){var C=E[B];D=C.some(function(F){return y.user===F.user})}else{D=(y.user===E[B].user)}}return D})},addUser:function(D,C,G,B){var F=this;if(D.content){if(!D.users.hasOwnProperty(C.user)){F.members[C.user]=C;D.users[C.user]=C;if(G){D.commonUsers[C.user]=C}if(B){D.notSavedUsers[C.user]=C}D.userContainers[C.user]=F.createUserHTML(C,G,B);if(D.roleName!==o.owners){if(F.issues&&G){D.userContainers[C.user].addClassName("common-to-all")}var A=h.createElement("span",{"class":"team-content-user-common-to-all-label",html:G?g.team.common.label:g.team.common.notLabel}).inject(D.userContainers[C.user]);F._tooltips.push(new s({position:"top",target:A,body:g.team.common.tooltip,trigger:"touch",}));var I=h.createElement("span",{"class":"team-content-user-propagate fonticon fonticon-propagate"}).inject(D.userContainers[C.user]);var H=new s({position:"left",target:I,body:g.team[D.roleName].propagate,animate:false});F.listenTo(H,"onShow",function(){if(D.layout===p.THUMBNAIL){H.hide()}});I.addEventListener("click",function(){x.mask(D.userContainers[C.user]);F.addPeople(D,[C]).then(function J(){x.unmask(D.userContainers[C.user]);F.addUser(D,C,true,false)})});var y=h.createElement("span",{"class":"team-content-user-remove fonticon fonticon-cancel-circled"}).inject(D.userContainers[C.user]);var E=new s({position:"left",target:y,body:g.team[D.roleName].remove,animate:false});F.listenTo(E,"onShow",function(){if(D.layout===p.THUMBNAIL){E.hide()}});y.addEventListener("click",function(){var K=new m({animate:true,autocenter:true,closable:true,limitParent:false,overlay:true,resizable:true,visible:true,className:"confirm-remove-team-dialog",title:g.replace(g.team.confirmRemoveTitle,{user:C.fullName,role:g.team[D.roleName].title}),header:null,body:g.replace(g.team.confirmRemoveText,{user:C.fullName,role:g.team[D.roleName].title}),footer:[new l({value:g.team.removeOkButton,className:"primary",id:"team-remove-confirm-ok-button",events:{onClick:function(){K.destroy();F.removePeople(D,[C])}}}),new l({value:g.team.removeCancelButton,className:"default",id:"team-remove-confirm-cancel-button",events:{onClick:function(){K.destroy()}}})],events:{onClose:function(){K.destroy()}}});var J=i.get("widget");K.inject(J.body)})}D.userContainers[C.user].inject(D.content,"top");F.refreshView(D)}else{if(G){D.commonUsers[C.user]=C;D.userContainers[C.user].addClassName("common-to-all");D.userContainers[C.user].getElement(".team-content-user-common-to-all-label").innerHTML=g.team.common.label;if(D.iconBar&&D.iconBar.getItem("PropagateAll")){var z=Object.keys(D.users).map(function(J){return D.users[J]});D.iconBar.getItem("PropagateAll").elements.container.toggleClassName("disabled",z.length===0||z.every(function(J){return F.isUserCommonToAllIssues(D,J)}))}}if(B){D.notSavedUsers[C.user]=C;D.userContainers[C.user].addClassName("not-saved")}D.userContainers[C.user].remove();D.userContainers[C.user].inject(D.content,"top")}}},addUsers:function(C,B){var A=this;for(var D in B){if(B.hasOwnProperty(D)){var y=B[D];var z=A.isUserCommonToAllIssues(C,y);A.addUser(C,y,z)}}},addNotSavedUser:function(B,z){var A=this;if(!A.isUserCommonToAllIssues(B,z)){var y=(B.roleName===o.coOwners)&&A.issues.every(function(C){return C.owner.user===z.user});if(!y){A.addUser(B,z,true,true)}else{t.displayNotification({msg:g.replace(g.team.error.isOwner,{name:z.fullName}),eventID:"info"})}}else{t.displayNotification({msg:g.replace(g.team.error.alreadyAdded,{name:z.fullName,role:g.team[B.roleName].title}),eventID:"info"})}},removeUser:function(C,A){var B=this;var z=C.userContainers[A.user];var y=C.users[A.user];if(z&&y){delete C.userContainers[A.user];delete C.users[A.user];delete C.commonUsers[A.user];delete C.notSavedUsers[A.user];z.destroy();if(C.roleName===o.participants){B.removeUser(B.assignees,A);B.removeUser(B.coOwners,A)}if(!B.owners.users.hasOwnProperty(A.user)&&!B.assignees.users.hasOwnProperty(A.user)&&!B.coOwners.users.hasOwnProperty(A.user)){delete B.members[A.user]}B.refreshView(C)}else{B._logger.error("removeUser: not found")}},refreshView:function(D){var F=this;F.mainHeader.label.container.innerHTML=g.replace(g.team.title,{count:Object.keys(F.members).length.toString()});var y=Object.keys(D.users);var H=y.length.toString();if(F.filter.isHidden){D.header.title.count.innerHTML=H;for(var E=0;E<y.length;E++){D.userContainers[y[E]].show()}}else{D.header.title.filteredCount=0;for(var B=0;B<y.length;B++){var C=D.users[y[B]];var A=F.filter.reg;if(A.test(C.user)||A.test(C.fullName)){D.userContainers[y[B]].show();D.header.title.filteredCount++}else{D.userContainers[y[B]].hide()}}var G=D.header.title.filteredCount.toString();D.header.title.count.innerHTML=G+" / "+H}if(D.placeHolder){if(Object.keys(D.userContainers).length){D.placeHolder.hide()}else{D.placeHolder.show()}}if(D.iconBar&&D.iconBar.getItem("PropagateAll")){var z=Object.keys(D.users).map(function(I){return D.users[I]});D.iconBar.getItem("PropagateAll").elements.container.toggleClassName("disabled",z.length===0||z.every(function(I){return F.isUserCommonToAllIssues(D,I)}))}},refreshAllViews:function(){var y=this;y.refreshView(y.owners);y.refreshView(y.coOwners);y.refreshView(y.assignees);y.refreshView(y.participants)},createUserHTML:function(A,F,z){var E=this;var D=k.getUserImage(A.user);var y=h.createElement("div",{"class":"team-content-user-container"});var C=h.createElement("img",{"class":"team-content-user-img",title:A.fullName+" ("+A.user+")",src:D});C.addEventListener("click",function(){k.getUserProfile(A.user)});C.inject(y);var G=h.createElement("div",{"class":"team-content-user-info"}).inject(y);var B=h.createElement("span",{"class":"team-content-user-full-name",html:A.fullName}).inject(G);h.createElement("span",{"class":"team-content-user-id",html:A.user}).inject(G);if(z){y.addClassName("not-saved");y.addClassName("editable");y.addClassName("is-new")}var H=h.createElement("span",{"class":"team-content-user-not-saved-icon fonticon fonticon-attention"}).inject(B);E._tooltips.push(new s({position:"top",target:H,body:g.team.notSaved.tooltip,trigger:"touch",}));return y},filterContent:function(z){var y=this;var A=z||"";y.filter.reg=new RegExp(A,"i");y.refreshAllViews()},addPeople:function(D,F){var B=this;var E=F.map(function(G){return G.user});var C=[];for(var A=0;A<B.issues.length;A++){var z=B.issues[A];var y={physicalId:z.id};y[D.roleName]={};if(F.length){y[D.roleName]=F.map(function(G){return{user:G.user}})}C.push(y)}return new e(function(H,G){f.people.update({data:{objects:C}}).then(function(){for(var L=0;L<B.issues.length;L++){var I=B.issues[L];if(!I[D.roleName]){I[D.roleName]=[]}for(var K=0;K<E.length;K++){var J=E[K];if(I[D.roleName].length===0){I[D.roleName].push(D.users[J])}else{for(var M=I[D.roleName].length-1;M>=0;M--){if(J!==I[D.roleName][M].user){I[D.roleName].push(D.users[J])}}}}}B.dispatchEvent("onUpdate",{issues:B.issues});t.displayNotification({msg:g.replace(g.team.success.update,{role:g.team[D.roleName].title}),eventID:"success"});H()})["catch"](function(I){B._logger.error(I);t.displayNotification({msg:g.replace(g.team.error.update,{role:g.team[D.roleName].title}),eventID:"error"});G(I)})})},removePeople:function(A,y){var C=this;var F=y.map(function(H){return H.user});var G=[];for(var B=0;B<C.issues.length;B++){var D=C.issues[B];var z={physicalId:D.id};z[A.roleName]={};if(y.length){z[A.roleName]=y.map(function(H){return{user:H.user}})}G.push(z)}for(var E=0;E<y.length;E++){x.mask(A.userContainers[y[E].user])}return f.people["delete"]({data:{objects:G}}).then(function(){for(var L=0;L<C.issues.length;L++){var I=C.issues[L];if(!I[A.roleName]){I[A.roleName]=[]}for(var J=0;J<F.length;J++){var H=F[J];for(var M=I[A.roleName].length-1;M>=0;M--){if(H===I[A.roleName][M].user){I[A.roleName].splice(M,1)}}}}for(var K=0;K<y.length;K++){x.unmask(A.userContainers[y[K].user]);C.removeUser(A,y[K])}C.dispatchEvent("onUpdate",{issues:C.issues});t.displayNotification({msg:g.replace(g.team.success.update,{role:g.team[A.roleName].title}),eventID:"success"})})["catch"](function(I){for(var H=0;H<y.length;H++){x.unmask(A.userContainers[y[H].user])}C._logger.error(I);t.displayNotification({msg:g.replace(g.team.error.update,{role:g.team[A.roleName].title}),eventID:"error"})})},save:function(A){var z=this;var B=Object.keys(A.notSavedUsers);B.forEach(function(C){x.mask(A.userContainers[C])});var y=B.map(function(C){return A.notSavedUsers[C]});if(Array.isArray(y)&&y.length>0){z.addPeople(A,y).then(function(){B.forEach(function(C){A.userContainers[C].removeClassName("not-saved");x.unmask(A.userContainers[C]);delete A.notSavedUsers[C]})})["catch"](function(){B.forEach(function(C){z.removeUser(A,A.users[C])})})}}});return b});define("DS/IssueComponents/create/Properties",["UWA/Class/Promise","UWA/Class/View","UWA/Core","DS/UIKIT/Form","DS/UIKIT/Input/Button","DS/UIKIT/Input/ButtonGroup","DS/UIKIT/Input/Date","DS/UIKIT/Input/Text","DS/CKEditor/CKEditor","DS/ENOFloatingPanel/ENOFloatingPanel","DS/Logger/Logger","DS/WebappsUtils/WebappsUtils","DS/IssueCommon/commands/CommandsManager","DS/IssueCommon/utils/Utils","DS/IssueComponents/utils/Utils","DS/IssueServices/Contexts","DS/IssueServices/services/IssueServices","DS/IssueServices/services/PlatformServices","DS/IssueServices/utils/Parser","DS/IssueServices/utils/Performance","i18n!DS/IssueComponents/assets/nls/IssueComponents","css!DS/IssueComponents/IssueComponents.css"],function(e,t,i,j,o,r,u,v,l,p,w,g,b,n,d,k,f,m,a,c,h){var q={TIMEOUT_CKEDITOR_INJECTION:50,SEARCH_DEBOUNCE_TIMEOUT:1000,PRIORITY_MAPPINGS:{Low:0,Medium:1,High:2,Urgent:3}};var s=t.extend({name:"DS/IssueComponents/create/Properties",tag:"div",className:"create-view-content-subview create-properties",isInit:null,_deferredInit:{resolve:null,reject:null},setup:function(x){var y=this;y._parent(x);y.parent=x.parent;y.isInit=new e(function(A,z){y._deferredInit.resolve=A;y._deferredInit.reject=z});y.form=null;y.formElements={title:null,similarIssues:null,description:null,resolutionRecommendation:null,priority:null,resolutionDate:null};y.formElementsToggler={description:null,resolutionRecommendation:null,priority:null,resolutionDate:null};y.fields={title:null,titleLabel:null,similarIssues:null,similarIssuesLabel:null,description:null,resolutionRecommendation:null,priority:null,resolutionDate:null};y._ckeditor="issue-description-creation-"+Date.now();y._similarIssues=[];y._debouncedSearch=n.debounce(y._searchSimilarIssues.bind(y),q.SEARCH_DEBOUNCE_TIMEOUT);y._deferredInit.resolve()},destroy:function(){var x=this;x.form=null;x.formElements={title:null,similarIssues:null,description:null,resolutionRecommendation:null,priority:null,resolutionDate:null};x.formElementsToggler={description:null,resolutionRecommendation:null,priority:null,resolutionDate:null};x.fields={title:null,titleLabel:null,similarIssues:null,similarIssuesLabel:null,description:null,resolutionRecommendation:null,priority:null,resolutionDate:null};delete l.instances[x._ckeditor];x._ckeditor="";x._issuesForSimilarity=null},render:function(){var y=this;y.form=new j({className:"create-properties-form",fields:[],events:{onInvalid:function(){}}}).inject(y.container);var x=new Date();var A=new Date(x);A.setDate(A.getDate()+7);var z=i.createElement("div",{"class":"create-form-content",html:[y.formElements.title=i.createElement("div",{"class":"create-form-element create-properties-form-element-title",html:[{tag:"div","class":"create-form-field form-group",html:[(y.fields.titleLabel=i.createElement("h5",{"class":"required-form-field",html:[i.createElement("span",{"class":"required-form-field-title-label"+(y.parent.isTemplate?"":" highlight"),html:h.create.properties.labels.title}),i.createElement("span",{"class":"required-form-field-required-label"+(y.parent.isTemplate?"":" highlight"),html:h.create.required})]})),(y.fields.title=new v({id:"issue-title",className:"",value:"",required:!y.parent.isTemplate,placeholder:h.create.properties.labels.titlePlaceholder,events:{onChange:function(B){if(!B||document.activeElement!==B.target){var C=this.getValue().trim();this.setValue(C);if(this.getValue()===""&&!y.parent.isTemplate){y.fields.titleLabel.getElement(".required-form-field-required-label").addClassName("highlight");y.fields.titleLabel.getElement(".required-form-field-title-label").addClassName("highlight")}else{y.fields.titleLabel.getElement(".required-form-field-required-label").removeClassName("highlight");y.fields.titleLabel.getElement(".required-form-field-title-label").removeClassName("highlight")}y._debouncedSearch()}}}}))]},{tag:"div","class":"create-form-help",html:[i.createElement("div",{"class":"create-form-help-content",html:[i.createElement("span",{"class":"fonticon fonticon-help"}),h.create.properties.labels.titleHelper]})]}]}),y.formElements.similarIssues=i.createElement("div",{"class":"create-form-element create-properties-form-element-similar-issues",html:[{tag:"div","class":"create-form-field form-group",html:[(y.fields.similarIssuesLabel=i.createElement("h5",{"class":"create-form-field-similar-issues-label",html:h.create.properties.labels.similarIssues})),(y.fields.similarIssues=i.createElement("div",{"class":"create-form-field-similar-issues"}))]},{tag:"div","class":"create-form-help",html:[i.createElement("div",{"class":"create-form-help-content",html:[i.createElement("span",{"class":"fonticon fonticon-help"}),h.create.properties.labels.similarIssuesHelper]})]}]}),y.formElements.description=i.createElement("div",{"class":"create-form-element create-properties-form-element-description",html:[{tag:"div","class":"create-form-visibility-mask"},{tag:"div","class":"create-form-visibility-toggle",html:[y.formElementsToggler.description=i.createElement("span",{"class":"fonticon fonticon-eye"})]},{tag:"div","class":"create-form-field form-group",html:[{tag:"h5",html:h.create.properties.labels.description},(y.fields.description=new v({name:y._ckeditor,id:y._ckeditor,className:"",value:"",multiline:true,required:false,placeholder:h.create.properties.labels.descriptionPlaceholder}))]},{tag:"div","class":"create-form-help",html:[i.createElement("div",{"class":"create-form-help-content",html:[i.createElement("span",{"class":"fonticon fonticon-help"}),h.create.properties.labels.descriptionHelper]})]}]}),y.formElements.resolutionRecommendation=i.createElement("div",{"class":"create-form-element create-properties-form-element-recommendation-fix",html:[{tag:"div","class":"create-form-visibility-mask"},{tag:"div","class":"create-form-visibility-toggle",html:[y.formElementsToggler.resolutionRecommendation=i.createElement("span",{"class":"fonticon fonticon-eye"})]},{tag:"div","class":"create-form-field form-group",html:[{tag:"h5","class":"",html:h.create.properties.labels.resolutionRecommendation},(y.fields.resolutionRecommendation=new v({name:"issue-resolution-recommendation-fix",id:"issue-resolution-recommendation-fix",className:"issue-resolution-recommendation-fix",value:"",multiline:true,required:false,placeholder:h.create.properties.labels.resolutionRecommendationPlaceholder}))]},{tag:"div","class":"create-form-help",html:[i.createElement("div",{"class":"create-form-help-content",html:[i.createElement("span",{"class":"fonticon fonticon-help"}),h.create.properties.labels.resolutionRecommendationHelper]})]}]}),y.formElements.priority=i.createElement("div",{"class":"create-form-element create-properties-form-element-priority",html:[{tag:"div","class":"create-form-visibility-mask"},{tag:"div","class":"create-form-visibility-toggle",html:[y.formElementsToggler.priority=i.createElement("span",{"class":"fonticon fonticon-eye"})]},{tag:"div","class":"create-form-field form-group",html:[{tag:"h5","class":"",html:h.priorities.title},(y.fields.priority=new r({type:"radio",name:"issue-priority",id:"issue-priority",required:false,buttons:[new o({value:h.priorities.low,id:"Low",className:"success small",icon:"level-low",active:true}),new o({value:h.priorities.medium,id:"Medium",className:"info small",icon:"level-medium"}),new o({value:h.priorities.high,id:"High",className:"warning small",icon:"level-high"}),new o({value:h.priorities.urgent,id:"Urgent",className:"error small",icon:"alert"})]}))]},{tag:"div","class":"create-form-help",html:[i.createElement("div",{"class":"create-form-help-content",html:[i.createElement("span",{"class":"fonticon fonticon-help"}),h.create.properties.labels.priorityHelper]})]}]}),y.formElements.resolutionDate=i.createElement("div",{"class":"create-form-element create-properties-form-element-date",html:[{tag:"div","class":"create-form-visibility-mask"},{tag:"div","class":"create-form-visibility-toggle",html:[y.formElementsToggler.resolutionDate=i.createElement("span",{"class":"fonticon fonticon-eye"})]},{tag:"div","class":"create-form-field form-group",html:[{tag:"h5",html:h.create.properties.labels.dueDate},(y.fields.resolutionDate=new u({name:"DueDate",id:"DueDate",required:false,min:new Date(),value:A,placeholder:h.create.properties.labels.dueDatePlaceholder,events:{onChange:function(){}}}))]},{tag:"div","class":"create-form-help",html:[i.createElement("div",{"class":"create-form-help-content",html:[i.createElement("span",{"class":"fonticon fonticon-help"}),h.create.properties.labels.dueDateHelper]})]}]})]});y.formElements.similarIssues.hide();y.fields.title.getContent().addEventListener("keyup",function(){var B=y.fields.title.getValue();if(y.parent&&!y.parent.isTemplate){y.parent.updateTitle(B)}if(B===""&&!y.parent.isTemplate){y.fields.titleLabel.getElement(".required-form-field-required-label").addClassName("highlight");y.fields.titleLabel.getElement(".required-form-field-title-label").addClassName("highlight")}else{y.fields.titleLabel.getElement(".required-form-field-required-label").removeClassName("highlight");y.fields.titleLabel.getElement(".required-form-field-title-label").removeClassName("highlight")}y._debouncedSearch()},false);z.inject(y.form.elements.container);y._richTextField();return y},show:function(){var x=this;x._parent();if(x.fields.title&&"focus" in x.fields.title){x.fields.title.focus()}},hide:function(){var x=this;x._parent()},validate:function(){var x=false;x=this.form.validate(false,false);return x},getValues:function(){var A=this;var y=new Date();var z=A.fields.resolutionDate.getDate();var x={title:A.fields.title.getValue(),description:l.instances[A._ckeditor].getData(),resolutionRecommendation:A.fields.resolutionRecommendation.getValue(),priority:A.fields.priority.getActive()[0].getId(),resolutionDate:(z.getMonth()+1)+"/"+z.getDate()+"/"+z.getFullYear(),estimatedStartDate:(y.getMonth()+1)+"/"+y.getDate()+"/"+y.getFullYear(),estimatedEndDate:(y.getMonth()+1)+"/"+y.getDate()+"/"+y.getFullYear()};return x},getHiddenAttributes:function(){var y=this;var z={};for(var x in y.formElements){if(i.is(y.formElementsToggler[x])){z[x]=y.formElementsToggler[x].hasClassName("fonticon-eye-off")}}return z},applyTemplate:function(x){var y=this;return y.reset().then(function(){var B=[];if(i.is(x.data.title)){y.fields.title.setValue(x.data.title);y.fields.title.events.input.change();if(y.parent&&!y.parent.isTemplate){y.parent.updateTitle(x.data.title)}}if(i.is(x.data.description)){var D=new e(function(F){var E=setInterval(function(){if(l.instances[y._ckeditor]!==undefined){clearInterval(E);l.instances[y._ckeditor].setData(x.data.description,{callback:F})}},q.TIMEOUT_CKEDITOR_INJECTION)});B.push(D)}if(i.is(x.data.resolutionRecommendation)){y.fields.resolutionRecommendation.setValue(x.data.resolutionRecommendation)}if(i.is(x.data.priority)){y.fields.priority.setActive(q.PRIORITY_MAPPINGS[x.data.priority])}if(i.is(x.data.resolutionDate)){y.fields.resolutionDate.setDate(x.data.resolutionDate)}if(i.is(x.hidden,"object")){if(i.is(y.formElements,"object")&&i.is(y.formElementsToggler,"object")){var A=y.formElements;var C=y.formElementsToggler;for(var z in A){if(x.hidden[z]===true){if(y.parent.isTemplate){if(i.is(A[z])){A[z].toggleClassName("visibility-masked",true)}if(i.is(C[z])){C[z].toggleClassName("fonticon-eye-off",true);C[z].toggleClassName("fonticon-eye",false)}}else{if(i.is(A[z])){A[z].hide()}}}}}}return e.all(B)})},reset:function(){var x=this;return new e(function(B){x.fields.title.setValue("");x.fields.title.events.input.change();var z=setInterval(function(){if(l.instances[x._ckeditor]!==undefined){clearInterval(z);l.instances[x._ckeditor].setData("",{callback:B})}},q.TIMEOUT_CKEDITOR_INJECTION);var y=new Date();var A=new Date(y);A.setDate(A.getDate()+7);x.fields.resolutionRecommendation.setValue("");x.fields.priority.setActive(q.PRIORITY_MAPPINGS.Low);x.fields.resolutionDate.setDate(A)})},_searchSimilarIssues:function(){var x=this;if(i.is(x.fields)&&i.is(x.fields.title)&&i.is(x.fields.similarIssues)&&i.is(x.fields.similarIssuesLabel)&&i.is(x.formElements)&&i.is(x.formElements.similarIssues)){var y=x.fields.title.getValue();if(y.length>0){f.search({data:{query:"([ds6w:type]:Issue) "+y,select_predicate:["resourceid","ds6w:created","ds6w:modified","ds6w:identifier","owner","ds6w:responsible","ds6wg:revision","ds6w:status","ds6w:label","ds6w:type"]}}).then(function(A){if(Array.isArray(A.body.results)){x._similarIssues=A.body.results.map(function(H){return a.parseFetchResponse(H).value})}else{x._similarIssues=[]}if(x._similarIssues.length>0){x.fields.similarIssues.empty();for(var C=0;C<x._similarIssues.length;C++){var z=i.clone(x._similarIssues[C]);var D="  ";var E=x._similarIssues[C].name+D+"Created "+n.timeSince(new Date(z.created))+" ago by "+z.responsible+D+"Updated "+n.timeSince(new Date(z.modified))+" ago";var B=n.computeSharedIssuesURL([z.physicalId]);var G=i.createElement("div",{"class":"create-form-field-similar-issues-line",html:[i.createElement("a",{html:[i.createElement("div",{"class":"create-form-field-similar-issues-line-title",html:[i.createElement("img",{src:n.getIconByState(z.state),title:h.maturity[z.state.toLowerCase()]}),i.createElement("span",{html:n.getTextFromHTML(x._similarIssues[C].title)})]}),i.createElement("div",{"class":"create-form-field-similar-issues-line-info",html:n.getTextFromHTML(E)})],href:B,target:"_blank"})]});G.inject(x.fields.similarIssues)}var F=n.computeSharedIssuesURL(x._similarIssues.map(function(H){return H.physicalId}));x.fields.similarIssuesLabel.setContent([h.create.properties.labels.similarIssues," (",{tag:"a",html:x._similarIssues.length,href:F,target:"_blank"},")"]);x.formElements.similarIssues.show()}else{x.formElements.similarIssues.hide()}})["catch"](function(){x.formElements.similarIssues.hide()})}else{x.formElements.similarIssues.hide()}}},_richTextField:function(){var C=this;var A=k.get("widget");var x=g.getWebappsBaseUrl()+"/ExternalComponents/libraries/ckeditor";var G=x+"/config.js";var E="Rich";var y={sharedspace:x+"/plugins/sharedspace/",colorbutton:x+"/plugins/colorbutton/",panelbutton:x+"/plugins/panelbutton/",quicktable:x+"/plugins/quicktable/"};var D="";for(var B in y){l.plugins.addExternal(B,y[B],"plugin.js");D+=B+","}D=D.slice(0,-1);var z={skin:"office2013,"+x+"/skins/office2013/",contentsCss:x+"/contents.css",customConfig:G,extraPlugins:D,removePlugins:"elementspath",language:A.lang,toolbar:E,height:100,autoGrow_minHeight:100,on:{focus:function(){},instanceReady:function(){var I=this;var J=i.Utils.Client.Features.touchEvents;if(J){var H=I.document.getBody();H.$.addEventListener("touchstart",function(){I.focusManager.focus();H.$.focus()});document.addEventListener("mouseup",function(){if(I.focusManager.hasFocus){I.focusManager.blur();C.fields.title.focus();C.fields.title.blur()}})}},blur:function(){},change:function(){}}};var F=setInterval(function(){if(l.dom.element.get(C._ckeditor)!==undefined){clearInterval(F);if(!l.instances.hasOwnProperty(C._ckeditor)){l.replace(C._ckeditor,z)}}},q.TIMEOUT_CKEDITOR_INJECTION)}});return s});define("DS/IssueComponents/related/TreeListView",["UWA/Core","UWA/Class","UWA/Controls/Abstract","UWA/Class/Promise","DS/Core/Events","DS/Logger/Logger","DS/UIKIT/Iconbar","DS/UIKIT/Input/Button","DS/UIKIT/Mask","DS/UIKIT/Scroller","DS/UIKIT/Tooltip","DS/Tree/TreeDocument","DS/Tree/TreeListView","DS/LifecycleServices/LifecycleServicesSettings","DS/IssueServices/Contexts","DS/IssueServices/services/IssueServices","DS/IssueServices/utils/Parser","DS/IssueServices/utils/Performance","DS/IssueServices/utils/Views","DS/IssueComponents/models/TreeNodeModel","DS/IssueComponents/utils/Utils","DS/ENOFloatingPanel/ENOFloatingPanel","DS/PADUtils/views/PADAlert","DS/PADUtils/PADUtilsServices","DS/PlatformAPI/PlatformAPI","DS/UIBehaviors/ContextualMenuManager","DS/WebappsUtils/WebappsUtils","i18n!DS/IssueComponents/assets/nls/IssueComponents","css!DS/IssueComponents/IssueComponents.css"],function(l,y,w,h,u,C,c,q,D,B,x,o,n,z,m,j,b,g,a,s,f,r,A,p,e,d,i,k){var t={ISSUE_TYPE:"Issue",TREE_TYPE_REPORTED_AGAINST:"reportedAgainst",TIMEOUT_UPDATE_COLUMN_WITH:250,REVISION_TARGETS:{STABLE_LATEST:"STABLE_LATEST",RELEASE_LATEST:"RELEASE_LATEST",LATEST:"LATEST"},TREE_TYPES:{TREE_TYPE_REPORTED_AGAINST:"reportedAgainst",TREE_TYPE_RESOLVED_BY:"resolvedBy",TREE_TYPE_CONTEXTS:"contexts"}};var v=w.extend({name:"DS/IssueComponents/related/TreeListView",_preventEvents:false,_syncSort:false,_logger:null,treeList:null,parentView:null,tooltips:null,relatedObjects:null,timestampLastRefresh:null,addObjects:function(G,E){var H=this;g.start(H.name+" addObjects");var F=[].concat(G);if(F&&F.length){F.forEach(function(L){var K=0;for(var I=0;I<F.length;I++){var J=F[I];if(L===J){K++}if(K>1){F.splice(I,1);I--;H._logger.log("remove the same id from object-id list")}}})}H.addRelatedObjects(F,E);g.end(H.name+" addObjects")},getCount:function(){var F=this;g.start(F.name+" getCount");var E={sum:F.treeList.getDocument().getChildren().length};g.end(F.name+" getCount");return E},destroy:function(){var E=this;if(E.visualizationEventToken){u.unsubscribe(E.visualizationEventToken);E.visualizationEventToken=null}if(E.treeList){E.treeList=null}if(E.tooltips){E.tooltips.forEach(function(F){F.destroy()})}},defaultOptions:{type:"reportedAgainst",grid:{allowUnsafeHTMLContent:false,apiVersion:2,defaultCellHeight:26,height:"100%",useAsyncPreExpand:true,isEditable:false,isSortable:true,alternateRowColor:false,resize:{columns:true},headersDimensions:{height:26},selection:{unselectAllOnEmptyArea:true,toggle:false,canMultiSelect:true,enableListSelection:true,renderingMode:"adaptive"},performances:{buildLinks:false,enableColumnVirtualization:true,useRequestAnimationFrameRendering:true,preloadPool:true},enableExpandOnDoubleClick:true,columns:[{text:k.resolveIssues.common,dataIndex:"common",width:40,isDraggable:true},{text:k.resolveIssues.label,dataIndex:"tree",width:200,isDraggable:true},{text:k.resolveIssues.type,dataIndex:"type",width:150,isDraggable:true},{text:k.resolveIssues.name,dataIndex:"name",width:200,isDraggable:true},{text:k.resolveIssues.revision,dataIndex:"revision",width:150,isDraggable:true},{text:k.resolveIssues.state,dataIndex:"dispState",width:150,isDraggable:true},{text:k.resolveIssues.isLastRevision,dataIndex:"isLastRevision",width:150,isDraggable:true}]}},callbacks:{onModifyGrid:null},init:function(E,F,I){var H=this;g.start(H.name+" init");H._logger=C.getLogger("DS/IssueCommon/components/IssueTreeListView");H.container=E;H.options=l.merge(F||{},H.defaultOptions);H.treeList=null;H.tooltips=null;H.relatedObjects=null;H.parentView=I;H.isLoaded=null;H._deferred={resolve:null,reject:null};H.tooltips=[];H.timestampLastRefresh=null;H.options.grid.columns=H.preferences.getColumnsPreference(H.options.grid.columns,H.options.type);var G=H.options.grid;G.shouldDisplayTooltip=function(J){g.start(H.name+" shouldDisplayTooltip");var K="";if(J.isHeader){switch(J.dataIndex){default:if(typeof J.cellModel.options.value==="string"){K=J.cellModel.options.value}break}}else{switch(J.dataIndex){case"tree":K=J.nodeModel.options.label;break;case"isLastRevision":if(J.nodeModel.options.isLastRevision===true){K=k.resolveIssues.tooltips.isLastRevision}else{if(J.nodeModel.options.isLastRevision===false){K=k.resolveIssues.tooltips.isNotLastRevision}else{K=k.resolveIssues.tooltips.noIsLastRevision}}break;case"common":if(J.nodeModel.options.common===true){K=null}else{K=k.resolveIssues.tooltips.propagateTooltip}break;default:if(typeof J.cellModel.options.value==="string"){K=J.cellModel.options.value}break}}g.end(H.name+" shouldDisplayTooltip");return{longHelp:K}};G.onDragEnterCell=function(){return true};G.onDragEnterBlank=function(){return true};G.onDragOverBlank=function(){return true};G.onDragOverCell=function(K,J){if(J){J.dropPosition="middle";return true}return false};G.onDropCell=function(K){var L=f.getDroppableData(K);if(L.source===H.options.type){return false}var J=H.getDroppedInfo(K);if(J===null){return false}H.addRelatedObjects(J);return true};G.onDropBlank=function(K){var L=f.getDroppableData(K);if(L.source===H.options.type){return false}var J=H.getDroppedInfo(K);if(J===null){return false}H.addRelatedObjects(J);return true};G.onContextualEvent={callback:function(M){if(M&&M.treeview){var J=M.treeview;if(J.virtualRowID===-1){return false}else{if(J.nodeModel){var L;var N=H.treeList.getDocument().getSelectedNodes();if(N.length>1){L=N}else{if(J.nodeModel){H.treeList.getManager().unselectAll();J.nodeModel.select();L=[J.nodeModel]}}var K="blank";if(L&&L.length>0){K="children"}return H.getContextualMenu({type:K,models:L?L:[]})}}}return h.resolve()}};G.onDragStartCell=function(M,N){var J=H.treeList.getDocument().getSelectedNodes();if(J.length===0){return false}var K=f.setDroppableData(J);K.data.source=H.options.type;var L={type:K.type,data:JSON.stringify(K.data)};var O=K.data.data.items.length;M.dataTransfer.setData(L.type,L.data);if(H._ghost){H._ghost.destroy();H._ghost=null}H._ghost=f.createGhostDrag(N.nodeModel.options,O);document.body.appendChild(H._ghost);M.dataTransfer.setDragImage(H._ghost,M.offsetX,M.offsetY);return true};H._customizeColumnRendering(G.columns);H.treeList=new n(G);H.treeList.inject(E);H.treeList.elements.container.addClassName("issue-tree-list-view");z.app_initialization(function(){if(!l.is(z.getOption("platform_services"),"array")){H._logger.log("LifecycleServicesSettings is initialized...")}else{H._logger.log("LifecycleServicesSettings is not initialized...")}});H.initializeManager();H.treeList.parentView=H;g.end(H.name+" init")},initializeManager:function(){var H=this;g.start(H.name+" initializeManager");var G=H.treeList.getManager();G.onReady(function(){if(H.options.onReady){H.options.onReady()}});G.onColumnWidthUpdate(H.utils.debounce(function(){H.preferences.savePreferencesColumns(G.getColumns(),H.options.type)},t.TIMEOUT_UPDATE_COLUMN_WITH));var F=G.getKeymapManager(),E=G.getCommandRegistry();F.registerKeymap("del","treelistview:delete-node");E.registerCommand("treelistview:delete-node",function(){H.treeList.getDocument().withTransactionUpdate(function(){var I=H.treeList.getDocument().getSelectedNodes();H.removeRelatedObjects(I)},function(){H._logger.error('An error occurred during "%s"',"detachCommand")})});g.end(H.name+" initializeManager")},_customizeColumnRendering:function(E){var F=this;E.forEach(function(G){switch(G.dataIndex){case"tree":break;case"common":G.onCellRequest=F.rendering.common.bind(F);break;case"isLastRevision":G.onCellRequest=F.rendering.isLastRevision.bind(F);break;default:break}})},load:function(F){var H=this;g.start(H.name+" load");H.isLoaded=new h(function(J,I){H._deferred.resolve=J;H._deferred.reject=I});H.issues=F;var E=new o({useAsyncPreExpand:true,shouldAcceptDrag:function(){return true},shouldBeSelected:function(){return true}});var G=H.computeRelatedObjectsCommon();H.treeList.getManager().loadDocument(E);H.timestampLastRefresh=null;H.fetchRelatedObjects(G,false).then(function(I){H.treeList.getDocument().withTransactionUpdate(function(){H.timestampLastRefresh=Math.floor(Date.now());for(var J=0;J<I.length;J++){var K=I[J];if(H.relatedObjects.objects[K.options.id]){K.options.common=H.relatedObjects.objects[K.options.id].common}E.addChild(K);H.relatedObjects.objects[K.options.id].model=K}H.callbacks.onModifyGrid();H._deferred.resolve()},function(){H._logger.error('An error occurred during "%s"',"load")})});g.end(H.name+" load")},fetch:function(E){var F=this;g.start(F.name+" fetch");return new h(function(H,G){if(E.length===0){H([]);return}j.fetch({data:{objects:E.map(function(I){return{physicalId:I}})},onComplete:function(I){var J=I.body;F._logger.log("fetch :Success...");g.end(F.name+" fetch");if(J.results&&J.results.length===E.length){H(J.results)}else{F._logger.error("fetch :Failure... Not indexed.");G(new Error("fetch :Failure... Not indexed."))}},onFailure:function(I){F._logger.error("fetch :Failure...");F._logger.error(I);g.end(F.name+" fetch");G(new Error("fetch :Failure..."))}})})},fetchRelatedObjects:function(E){var F=this;return new h(function(G){var H=[];D.mask(F.container);F.fetch(E).then(function(K){for(var J=0;J<K.length;J++){var L=true;var I=b.parseFetchResponse(K[J]);var M=new s({id:I.value.id,name:I.value.name,title:I.value.title,type:I.value.type,dispTypeValue:I.display.type,revision:I.value.revision,label:I.value.title,icons:[I.value.typeIcon],isLastRevision:I.value.isLastRevision,common:L,state:I.value.state,grid:{name:I.display.name,type:I.display.type,revision:I.display.revision,dispState:I.display.state}});H.push(M)}D.unmask(F.container);G(H)},function(){A.displayNotification({msg:k.resolveIssues.errorFetch,eventID:"error"});D.unmask(F.container);F._deferred.reject()})})},getContextualMenu:function(K){var L=this;g.start(L.name+" getContextualMenu");var J=[];var M=K.models;var H={name:"Detach",title:k.resolveIssues.contextualMenus.detach,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-flow-branch-delete"},data:M,action:{callback:function(Q){L.treeList.getDocument().withTransactionUpdate(function(){L.removeRelatedObjects(Q.context)},function(){L._logger.error('An error occurred during "%s"',"detachCommand")})},context:M}};var O={title:k.resolveIssues.contextualMenus.propagate,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-propagate"},data:M,action:{callback:function(Q){L.propagate(Q.context)},context:M}};var G={name:"History",title:k.resolveIssues.contextualMenus.history,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-compass"},data:M,action:{callback:function(Q){require(["DS/IssueComponents/external/History"],function(U){var T=[];var R=Q.context;for(var S=0;S<R.length;S++){T.push(R[S].options.id)}U.execute(T)})},context:M}};var N={name:"Compare",title:k.resolveIssues.contextualMenus.compare,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-compare-on"},data:M,action:{callback:function(Q){require(["DS/IssueComponents/external/Compare"],function(U){var T=[];var R=Q.context;for(var S=0;S<R.length;S++){T.push(R[S].options.id)}U.execute(T)})},context:M}};var I={name:"WhereUsed",title:k.resolveIssues.contextualMenus.whereused,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-path-related"},data:M,action:{callback:function(Q){require(["DS/IssueComponents/external/WhereUsed"],function(T){var U=[];var R=Q.context;for(var S=0;S<R.length;S++){U.push(R[S].options.id)}T.execute(U)})},context:M}};var E={name:"ReplaceByLatestRevision",title:k.resolveIssues.contextualMenus.replaceByLatestRevision,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-step-3"},data:M,action:{callback:function(Q){L.replaceByRevision(Q.context,t.REVISION_TARGETS.LATEST)},context:M}};var F={name:"ReplaceByReleasedLatestRevision",title:k.resolveIssues.contextualMenus.replaceByReleasedLatestRevision,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-step-1"},data:M,action:{callback:function(Q){L.replaceByRevision(Q.context,t.REVISION_TARGETS.RELEASE_LATEST)},context:M}};var P={name:"ReplaceByStableLatestRevision",title:k.resolveIssues.contextualMenus.replaceByStableLatestRevision,type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-step-2"},data:M,action:{callback:function(Q){L.replaceByRevision(Q.context,t.REVISION_TARGETS.STABLE_LATEST)},context:M}};return L._getOpenWithMenu(K).then(function(T){J=J.concat(T);if(K.type==="children"){if(K.models.length===1){J.push(G)}J.push(I);if(K.models.length<=2){J.push(N)}J.push(H);for(var R=0;R<K.models.length;R++){if(!K.models[R].options.common){J.push(O);break}}var S=[];var Q={name:"ReplaceByRevision",type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x fonticon-part-replace"},title:k.resolveIssues.contextualMenus.replaceByRevision,submenu:S};S.push(F);S.push(P);S.push(E);J.push(Q)}g.end(L.name+" getContextualMenu");return J})},_getOpenWithMenu:function(F){g.start(name+" getMenu");var E=[],G=F.models||[];if(G.length===0||F.type==="blank"){return h.resolve([])}return new h(function(L){g.start(name+" getOpenWithMenu");var H=[];for(var I=0;I<G.length;I++){var M=G[I];if(M.options.type!==t.ISSUE_TYPE){H.push({serviceId:"3DSpace",objectId:M.options.id,objectType:M.options.type,displayName:M.options.title?M.options.title:M.options.name})}if(M.options.type===t.ISSUE_TYPE){M.options.children.forEach(function(N){H.push({serviceId:"3DSpace",objectId:N.options.id,objectType:N.options.type,displayName:N.options.title?N.options.title:N.options.name})})}}if(H.length===0){g.end(name+" getOpenWithMenu");L(E);return}var K=m.get("widget");var J=a.getOpenWith().set3DXContent({protocol:"3DXContent",version:"1.1",source:K.name,widgetId:K.id,data:{items:H}},true);J.retrieveCompatibleApps(function(O){if(O&&O.length>0){var N=[];O.forEach(function(Q){N.push({name:Q.text.replace(/ /g,""),type:"PushItem",title:Q.text,fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-"+Q.fonticon},action:{callback:Q.handler}})});if(N.length>0){var P={name:"OpenWith",type:"PushItem",fonticon:{content:"wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-export"},title:k.resolveIssues.contextualMenus.openWith,submenu:N};E.push(P);E.push({type:"SeparatorItem"})}}L(E)});g.end(name+" getOpenWithMenu")})},addRelatedObjects:function(E,I){var N=this;var P=[];var J=[];var K=function(Q,U){var S=[].concat(U);for(var T=0;T<Q.length;T++){var V=Q[T];for(var R=0;R<S.length;R++){if(V===S[R]){S.splice(R,1);break}}}return S};for(var H=0;H<N.issues.length;H++){var O={physicalId:N.issues[H].id};O[N.options.type]={};var M=[].concat(E);var F=N.utils.getRelatedObjects(N.issues[H],N.options.type);M=K(F,M);if(M.length>0){O[N.options.type]=M.map(function(S){var R={physicalId:S};if(I){for(var Q=0;Q<I.length;Q++){if(I[Q].id===S){R.position=I[Q]}}}return R});P.push(O);var G={id:N.issues[H].id,issue:N.issues[H]};J.push(G)}}if(P.length>0){var L=N.timestampLastRefresh;N.updateIssues(P).then(function(){N.fetchRelatedObjects(E,true).then(function(Q){if(N.timestampLastRefresh===L){N.treeList.getDocument().withTransactionUpdate(function(){for(var W=0;W<Q.length;W++){var U=Q[W];var S=N.treeList.getDocument();var V=N.treeList.getDocument().getChildren();var X=-1;if(N.relatedObjects.objects[U.options.id]&&N.relatedObjects.objects[U.options.id].model){X=V.indexOf(N.relatedObjects.objects[U.options.id].model)}if(X!==-1){V.splice(X,1);S.addChild(U,X)}else{S.addChild(U)}N.relatedObjects.objects[U.options.id]={};N.relatedObjects.objects[U.options.id].model=U;N.relatedObjects.objects[U.options.id].common=true;for(var T=0;T<N.issues.length;T++){var R=N.utils.getRelatedObjects(N.issues[T],N.options.type);if(R.indexOf(U.options.id)===-1){R.push(U.options.id)}}}N.callbacks.onModifyGrid();A.displayNotification({msg:k.resolveIssues.successResolved,eventID:"success"})},function(){N._logger.error('An error occurred during "%s"',"add child")});N.dispatchEvent("onUpdate",{issues:J})}})},function(){})}else{A.displayNotification({msg:k.resolveIssues.nothingToAdd,eventID:"info"})}},removeRelatedObjects:function(E){var M=this;var O=[];var J=[];var P=[];E.forEach(function(Q){P.push(Q.options.id)});var F=function(Q,T){var R=[].concat(T);for(var S=0;S<R.length;S++){var U=R[S];if(Q.indexOf(U)===-1){R.splice(S,1);S--}}return R};for(var I=0;I<M.issues.length;I++){var N={physicalId:M.issues[I].id};N[M.options.type]={};var L=[].concat(P);var G=M.utils.getRelatedObjects(M.issues[I],M.options.type);L=F(G,L);if(L.length>0){N[M.options.type]=L.map(function(Q){return{physicalId:Q}});O.push(N);var H={id:M.issues[I].id,issue:M.issues[I]};J.push(H)}}if(O.length>0){var K=M.timestampLastRefresh;M.confirmDetach(E).then(function(){M.updateIssues(O,true).then(function(){if(M.timestampLastRefresh===K){M.treeList.getDocument().withTransactionUpdate(function(){for(var R=0;R<E.length;R++){var U=E[R];U.remove();M.relatedObjects.objects[U.options.id]=null;delete M.relatedObjects.objects[U.options.id];for(var T=0;T<M.issues.length;T++){var Q=M.utils.getRelatedObjects(M.issues[T],M.options.type);var S=Q.indexOf(U.options.id);if(S>-1){Q.splice(S,1)}}}M.callbacks.onModifyGrid();A.displayNotification({msg:k.resolveIssues.successResolved,eventID:"success"})},function(){M._logger.error('An error occurred during "%s"',"remove child")});M.dispatchEvent("onUpdate",{issues:J})}},function(){M._logger.error('An error occurred during "%s"',"remove child in withTransactionUpdate")})},function(){M._logger.log('User cancel the operation. "%s"',"Detach related objects")})}},updateIssues:function(F,E){var G=this;g.start(G.name+" updateIssues");return new h(function(J,I){D.mask(G.container);var H=E?"delete":"update";j.related[H]({data:{objects:F},onComplete:function(){D.unmask(G.container);G.treeList.dispatchEvent("onUpdateComplete");J()},onFailure:function(K){G._logger.error(K);A.displayNotification({msg:k.resolveIssues.errorResolved,eventID:"error"});D.unmask(G.container);G.treeList.dispatchEvent("onUpdateFailure");G.parentView.refresh();I(new Error("Failed to update issues..."))}})})},propagate:function(F){var E=this;E.confirmPropagate(F).then(function(){var H=[];for(var G=0;G<F.length;G++){H.push(F[G].options.id)}E.addRelatedObjects(H)},function(){E._logger.log('User cancel the operation. "%s"',"Propagate related objects")})},replaceByRevision:function(I,G){var H=this;H.getRevisions(I).then(function F(J){var P=[];var O=[];J.forEach(function(R){if(R[G]!==null){if(R[G].id!==R.id){P.push(R);O.push(R)}}});var M={issuesToAdd:[],issuesToRemove:[]};var K=[];var L=[];H.issues.forEach(function(T){var S={physicalId:T.id};S[H.options.type]=[];var U={physicalId:T.id};U[H.options.type]=[];P.forEach(function(W){var X=H.utils.getRelatedObjects(T,H.options.type);var V=X.indexOf(W.id);if(W[G]&&V>-1){if(U[H.options.type].indexOf(W.id)===-1){U[H.options.type].push({physicalId:W.id})}if(S[H.options.type].indexOf(W[G].id)===-1){S[H.options.type].push({physicalId:W[G].id});if(L.indexOf(W[G].id)===-1){L.push(W[G].id)}}}});if(U[H.options.type].length>0||S[H.options.type].length>0){M.issuesToAdd.push(S);M.issuesToRemove.push(U);var R={id:T.id,issue:T};K.push(R)}});var N=H.treeList.getDocument().getChildren();N.forEach(function(S){var R=L.indexOf(S.options.id);if(R>-1){L.splice(R,1)}});if(M.issuesToAdd.length>0||M.issuesToRemove.length>0){var Q=H.timestampLastRefresh;H.confirmReplaceByRevision(O,G).then(function(){H.updateIssues(M.issuesToAdd,false).then(function(){H.updateIssues(M.issuesToRemove,true).then(function(){H.fetchRelatedObjects(L,true).then(function(S){var R={};S.forEach(function(T){R[T.options.id]=T});if(H.timestampLastRefresh===Q){H.treeList.getDocument().withTransactionUpdate(function(){var T=H.treeList.getDocument();var U=T.getChildren();P.forEach(function(V){var W=U.indexOf(V.targetModel);if(W>-1){V.targetModel.remove();var X=R[V[G].id];if(X){T.addChild(X,W);R[V[G].id]=null}else{}}H.issues.forEach(function(Z){var Y=H.utils.getRelatedObjects(Z,H.options.type);var aa=Y.indexOf(V.id);if(aa>-1){Y.splice(aa,1);var ab=Y.indexOf(V[G].id);if(ab>-1){}else{Y.splice(aa,0,V[G].id)}}})});H.computeRelatedObjectsCommon();H.updateRelatedObjectsCommon(T.getChildren());H.callbacks.onModifyGrid();A.displayNotification({msg:k.resolveIssues.successResolved,eventID:"success"})},function(){H._logger.error('An error occurred during "%s"',"add child")});H.dispatchEvent("onUpdate",{issues:K})}})},function(){H._logger.error('An error occurred during "%s"',"removing in replace revision in withTransactionUpdate")})},function(){H._logger.error('An error occurred during "%s"',"adding in replace revision in withTransactionUpdate")})},function(){H._logger.log('User cancel the operation. "%s"',"replace revision")})}else{A.displayNotification({msg:k.resolveIssues.nothingToReplace,eventID:"info"})}},function E(){})},getRevisions:function(F){var E=this;g.start(E.name+" getRevisions");return new h(function(I,H){if(!F||F.length===0){I([]);return}var G={graphRequests:[]};F.forEach(function(J){G.graphRequests.push({id:J.options.id})});j.getRevisions({data:G,onComplete:function(L){var J=L.body;E._logger.log("getRevisions :Success...");var K=[];F.forEach(function(W){var Z=null;var P=null;var X=null;var S=null;var Y=null;var V=J.graphs;for(var R=0;R<V.length;R++){var N=V[R];if(N.versions){for(var Q=0;Q<N.versions.length;Q++){if(W.options.id===N.versions[Q].id){Z=N.versions;break}}}if(Z){break}}if(!Z){E._logger.log("getRevisions :no revision -> "+W.options.id)}else{for(var O=0;O<Z.length;O++){if(Z[O].isLastVersion){P=Z[O];break}}for(var U=Z.length-1;U>=0;U--){if(Z[U].maturity==="RELEASED"){Y=Z[U];break}}for(var aa=Z.length-1;aa>=0;aa--){if(Z[aa].maturity==="RELEASED"||Z[aa].maturity==="FROZEN"){S=Z[aa];break}}for(var T=0;T<Z.length;T++){if(Z[T].id===W.options.id){X=Z[T];break}}}var M={id:W.options.id,targetModel:W,revisionFamily:Z,CURRENT:X,STABLE_LATEST:S,RELEASE_LATEST:Y,LATEST:P};K.push(M)});g.end(E.name+" getRevisions");I(K)},onFailure:function(J){E._logger.error("getRevisions :Failure...");E._logger.error(J);A.displayNotification({msg:k.resolveIssues.errorResolved,eventID:"error"});g.end(E.name+" getRevisions");H(J)}})})},confirmDetach:function(G){var F=this;var I=[];for(var E=0;E<G.length;E++){var H=G[E];I.push(H.options.title+" ("+H.options.name+")")}return F._showConfirm(I,k.resolveIssues.confirmDialog.confirmDetach,k.resolveIssues.confirmDialog.detachTitle)},confirmPropagate:function(G){var F=this;var I=[];for(var E=0;E<G.length;E++){var H=G[E];I.push(H.options.title+" ("+H.options.name+")")}return F._showConfirm(I,k.resolveIssues.confirmDialog.confirmPropagate,k.resolveIssues.confirmDialog.propagateTitle)},confirmReplaceByRevision:function(K,I){var G=this;var J=k.resolveIssues.confirmDialog.replaceByLatestRevisionTitle;var M=k.resolveIssues.confirmDialog.confirmReplaceByLatestRevision;if(I===t.REVISION_TARGETS.RELEASE_LATEST){J=k.resolveIssues.confirmDialog.replaceByReleasedLatestRevisionTitle;M=k.resolveIssues.confirmDialog.confirmReplaceByReleasedLatestRevision}else{if(I===t.REVISION_TARGETS.STABLE_LATEST){J=k.resolveIssues.confirmDialog.replaceByStableLatestRevisionTitle;M=k.resolveIssues.confirmDialog.confirmReplaceByStableLatestRevision}}var F=[];for(var E=0;E<K.length;E++){var H=K[E].targetModel;var L=k.replace(k.resolveIssues.confirmDialog.confirmReplaceByTitleMessage,{target:H.options.title+" ("+H.options.name+") "+H.options.revision,latest:K[E][I].code});F.push(L)}return G._showConfirm(F,M,J)},_showConfirm:function(K,M,F){var J=this;var H=m.get("widget");var I=K;var E=[];I.forEach(function(N){E.push(l.createElement("li",{html:N,title:N}))});var G=l.createElement("div",{html:[M,l.createElement("ul",{"class":"related-confirm-dialog-ul",html:E})]});var L=k.replace(F,{number:I.length,issues:J.issues.length});return new h(function(P,O){var Q;var N=J.dialog=new r({animate:true,autocenter:true,closable:true,limitParent:false,overlay:true,resizable:true,visible:true,className:"related-confirm-dialog",title:L,header:null,body:G,footer:[Q=new q({value:k.resolveIssues.okButton,className:"primary related-confirm-dialog-ok",events:{onClick:function(){N.destroy();J.dialog=null;P()}}}),new q({value:k.resolveIssues.cancel,className:"default related-confirm-dialog-cancel",events:{onClick:function(){N.destroy();J.dialog=null;O(new Error("The dialog has been closed by the end user"))}}})],events:{onClose:function(){N.destroy();J.dialog=null;O(new Error("The dialog has been closed by the end user"))}}}).inject(H.body);new B({element:G}).inject(N.getBody());N.show();Q.focus()})},getDroppedInfo:function(I){var H=[];try{var E=f.getDroppableData(I).data.items;var F=0;E.forEach(function(J){if(J.objectType===t.ISSUE_TYPE){F++}else{if(H.indexOf(J.objectId)===-1){H.push(J.objectId)}}});if(F!==0){A.displayNotification({msg:k.replace(k.resolveIssues.issueNotDroppable,{number:F}),eventID:"error"})}}catch(G){A.displayNotification({msg:k.resolveIssues.errorNotSupportedObject,eventID:"error"});return null}return H},computeRelatedObjectsCommon:function(){var F=this;var E=[];F.issues.forEach(function(H){var G=F.utils.getRelatedObjects(H,F.options.type);for(var I=0;I<G.length;I++){var J=G[I];if(E.indexOf(J)===-1){E.push(J)}}});F.relatedObjects={};F.relatedObjects.objects={};E.forEach(function(G){var I=true;for(var H=0;H<F.issues.length;H++){var J=F.utils.getRelatedObjects(F.issues[H],F.options.type);if(J&&J.indexOf(G)===-1){I=false;break}}F.relatedObjects.objects[G]={};F.relatedObjects.objects[G].common=I});return E},updateRelatedObjectsCommon:function(F){var E=this;F.forEach(function(G){G.options.common=E.relatedObjects.objects[G.options.id].common})},preferences:{savePreferencesColumns:function(E,G){var H=m.get("widget");var F=[];E.forEach(function(I){F.push({dataIndex:I.dataIndex,width:I.width})});H.setValue("IssueManagementRelatedViewTableDefinition-"+G,JSON.stringify(F))},getColumnsPreference:function(L,O){var J=m.get("widget");var S=[];try{S=JSON.parse(J.getValue("IssueManagementRelatedViewTableDefinition-"+O));if(!Array.isArray(S)){throw new Error("The columns preference has an incorrect format")}}catch(M){J.setValue("IssueManagementRelatedViewTableDefinition-"+O,null);S=[]}var E=L.slice(0),P=S.slice(0);var N=E.reduce(function(U,V){U[V.dataIndex]=V;return U},{}),G=P.reduce(function(U,V){U[V.dataIndex]=V;return U},{});var F=[];var T=Math.max(E.length,P.length);for(var I=0;I<T;I++){var R=P[I],Q=R!==undefined?N[R.dataIndex]:undefined;if(Q===undefined){}else{Q.width=R.width;F.push(Q)}}for(var H=0;H<E.length;H++){var K=E[H].dataIndex;if(G[K]===undefined){F.push(E[H])}}return F}},rendering:{common:function(G){var J=this;g.start(J.name+" rendering common");if(!G.isHeader){var I=G.cellView.getContent();var H=G.nodeModel.options.common;var F="";var E=l.createElement("span",{"class":"clickable-column",html:l.createElement("span",{"class":F})});if(!H){F="fonticon fonticon-propagate related-propagate";E.addContent(l.createElement("span",{"class":F}));E.addEventListener("click",function(){if(G.parent._parentObject&&G.parent._parentObject.parentView){G.parent._parentObject.parentView.propagate([G.nodeModel])}})}else{}I.addContent(E)}g.end(J.name+" rendering common")},isLastRevision:function(F){var H=this;g.start(H.name+" rendering isLastRevision");if(!F.isHeader){var G=F.cellView.getContent();var E;if(F.nodeModel.options.isLastRevision===true){E=l.createElement("div",{"class":"is-last-revision wux-ui-3ds wux-ui-3ds-1x wux-ui-3ds-check"});G.addContent(E)}else{if(F.nodeModel.options.isLastRevision===false){E=l.createElement("div",{"class":"is-not-last-revision wux-ui-3ds wux-ui-3ds-1x  wux-ui-3ds-wrong"});G.addContent(E)}else{}}}g.end(H.name+" rendering isLastRevision")}},utils:{_debounceTimeouts:[],debounce:function(G,I,E){var F=this;var H;return function(){var N=this,M=arguments;var K=function(){H=null;if(!E){G.apply(N,M)}};var J=E&&!H;clearTimeout(H);var L=F._debounceTimeouts.indexOf(H);if(L!==-1){F._debounceTimeouts.splice(L,1)}H=setTimeout(K,I);F._debounceTimeouts.push(H);if(J){G.apply(N,M)}}},getRelatedObjects:function(E,F){return E.relatedObjects[F]}}});return v});define("DS/IssueComponents/related/Related",["UWA/Class/View","UWA/Class/Promise","UWA/Core","DS/Logger/Logger","DS/PADUtils/views/PADAlert","DS/PADUtils/PADUtilsServices","DS/PlatformAPI/PlatformAPI","DS/UIKIT/Iconbar","DS/UIKIT/Mask","DS/UIKIT/Scroller","DS/IssueComponents/utils/Utils","DS/IssueComponents/related/TreeListView","DS/IssueServices/Contexts","DS/IssueServices/services/IssueServices","DS/IssueServices/utils/Performance","css!DS/IssueComponents/IssueComponents.css","i18n!DS/IssueComponents/assets/nls/IssueComponents"],function(q,e,g,t,r,l,b,a,u,s,c,j,i,f,d,o,h){var p={VERTICAL:"vertical",HORIZONTAL:"horizontal"};var n={ISSUE_TYPE:"Issue",TREE_TYPE_REPORTED_AGAINST:"reportedAgainst",TREE_TYPE_RESOLVED_BY:"resolvedBy",TREE_TYPE_CONTEXTS:"contexts",ISSUE_3D_REVIEW:"ENX3DIR_AP"};var k="DS/IssueComponents/related/Related_Layout";var m=q.extend({name:"DS/IssueComponents/related/Related",tag:"div",className:"related-objects-view",_deferred:{resolve:null,reject:null},setup:function(v){var w=this;d.start(w.name+" setup");w._logger=t.getLogger(w.name);w._logger.log("Initializing related");this._parent(v);w.options.ids=v.ids;w.issues={};w.views={};w.views.main=null;w.views.small=null;w.views.related={};w.views.contexts={};w.grids={};var x=localStorage.getItem(k);w.viewLayout=x===p.HORIZONTAL?p.HORIZONTAL:p.VERTICAL;w.isLoaded=null;d.end(w.name+" setup")},render:function(){var v=this;v.build();v.changeView();v.load(v.options.ids);d.end(v.name+" init");return v},build:function(){var x=this;d.start(x.name+" build");x.views.main=g.createElement("div",{"class":"related-objects-view-main",html:[x.views.small=g.createElement("div",{"class":"related-objects-view-related",html:x.createRelated()}),g.createElement("div",{"class":"related-objects-view-contexts",html:x.createContexts()})]});var v=g.createElement("div",{"class":"related-objects-view-scrollerContainer"}).inject(x.container);var w=g.createElement("div",{"class":"related-objects-view-scroller"}).inject(v);x.views.scroller=new s({element:w}).inject(v);x.views.main.inject(x.views.scroller.getInnerElement());x.grids.reportedAgainst=x.createTreeViews(x.views.related.reportedAgainst,n.TREE_TYPE_REPORTED_AGAINST);x.grids.resolvedBy=x.createTreeViews(x.views.related.resolvedBy,n.TREE_TYPE_RESOLVED_BY);x.grids.contexts=x.createTreeViews(x.views.contexts.contextListView,n.TREE_TYPE_CONTEXTS);x.grids.reportedAgainst.callbacks.onModifyGrid=x.refreshItemCount.bind(x);x.grids.resolvedBy.callbacks.onModifyGrid=x.refreshItemCount.bind(x);x.grids.contexts.callbacks.onModifyGrid=x.refreshItemCount.bind(x);x.listenTo(x.grids.reportedAgainst,"onUpdate",function(z){var y={issues:g.clone(z.issues).map(function(A){return A.issue}),relation:[n.TREE_TYPE_REPORTED_AGAINST]};x.dispatchEvent("onUpdate",y)});x.listenTo(x.grids.resolvedBy,"onUpdate",function(z){var y={issues:g.clone(z.issues).map(function(A){return A.issue}),relation:[n.TREE_TYPE_RESOLVED_BY]};x.dispatchEvent("onUpdate",y)});x.listenTo(x.grids.contexts,"onUpdate",function(z){var y={issues:g.clone(z.issues).map(function(A){return A.issue}),relation:[n.TREE_TYPE_CONTEXTS]};x.dispatchEvent("onUpdate",y)});d.end(x.name+" build")},createRelated:function(){var w=this;d.start(w.name+" createRelated");w.views.related.main=g.createElement("div",{"class":"related-view-main",html:[w.views.related.header=g.createElement("div",{"class":"related-view-title-container",html:w.views.related.relateditems=g.createElement("div",{"class":"related-view-title-item-header",html:h.replace(h.resolveIssues.items,{count:0})})}),w.views.related.raRbContainer=g.createElement("div",{"class":"related-view-ra-rb-container fade-in-element",html:[w.views.related.reportedAgainst=g.createElement("div",{"class":"related-view-reported-against",html:w.views.related.reportedAgainstHeader=g.createElement("div",{"class":"reported-against-header",html:[{tag:"label",html:h.resolveIssues.reportedAgainst},w.views.related.reportedAgainstCount=g.createElement("div",{"class":"related-objects-count",html:"0"})]})}),w.views.related.resolvedBy=g.createElement("div",{"class":"related-view-resolved-by",html:w.views.related.resolvedByHeader=g.createElement("div",{"class":"resolved-by-header",html:[{tag:"label","class":"resolved-by-title",html:h.resolveIssues.resolvedBy},w.views.related.resolvedByCount=g.createElement("div",{"class":"related-objects-count",html:"0"})]})})]})]});w.views.related.treeListContainerReportedAgainst=g.createElement("div",{"class":"related-form-treelist treelist-empty",id:n.TREE_TYPE_REPORTED_AGAINST}).inject(w.views.related.reportedAgainst);w.views.related.reportedAgainstPlaceholder=g.createElement("span",{"class":"treelist-placeholder",html:h.placeholder.reportedAgainstPlaceholder}).inject(w.views.related.treeListContainerReportedAgainst);w._addDropEvent(w.views.related.treeListContainerReportedAgainst);w.views.related.treeListContainerResolvedBy=g.createElement("div",{"class":"related-form-treelist treelist-empty",id:n.TREE_TYPE_RESOLVED_BY}).inject(w.views.related.resolvedBy);w.views.related.resolvedByPlaceholder=g.createElement("span",{"class":"treelist-placeholder",html:h.placeholder.resolvedByPlaceholder}).inject(w.views.related.treeListContainerResolvedBy);w._addDropEvent(w.views.related.treeListContainerResolvedBy);w.views.related.headerToolbarContainer=g.createElement("div",{"class":"relatedobject-header-toolbar-container"}).inject(w.views.related.header);var v=(i.get("widget").name===n.ISSUE_3D_REVIEW);w.views.related.iconbar=new a({renderTo:w.views.related.headerToolbarContainer,items:[{id:"location",fonticon:"location",className:"",text:h.resolveIssues.pickObjects,content:{type:"dropdownmenu",options:{items:[{fonticon:"location",text:h.resolveIssues.addObjectsForReportedAgainst,handler:function(){var z=i.get("component");if(v){if(z.isInspected()){r.displayNotification({msg:h.resolveIssues.pickupError_needtoExitInspectionMode,eventID:"error"})}else{z.utils.selectIn3D(function(D,B){var C=[{id:D,x:B[D].x,y:B[D].y,z:B[D].z}];w.grids.reportedAgainst.addObjects([D],C)})}}else{var y=z.taskManager.addSelectIn3DTask(function A(C){var E=C.target;var B=C.positions;var D=[{id:E,x:B[E].x,y:B[E].y,z:B[E].z}];w.grids.reportedAgainst.addObjects([E],D);z.unmaskForTask(y)},function x(){z.unmaskForTask(y)});z.maskForTask(y,h.tasks.selectIn3D)}}},{fonticon:"docs",text:h.resolveIssues.addObjectsForResolvedBy,handler:function(){var z=i.get("component");if(v){if(z.isInspected()){r.displayNotification({msg:h.resolveIssues.pickupError_needtoExitInspectionMode,eventID:"error"})}else{z.utils.selectIn3D(function(B){w.grids.resolvedBy.addObjects([B])})}}else{var y=z.taskManager.addSelectIn3DTask(function A(B){w.grids.resolvedBy.addObjects([B.target]);z.unmaskForTask(y)},function x(){z.unmaskForTask(y)});z.maskForTask(y,h.tasks.selectIn3D)}}}]}}},{fonticon:"list-add",className:"",name:"search",text:h.resolveIssues.searchObjects,content:{type:"dropdownmenu",options:{items:[{fonticon:"location",text:h.resolveIssues.addObjectsForReportedAgainst,handler:function(){var A=i.get("application");var C=g.is(A,"object")&&A.isStandalone;if(C){var z=i.get("component");var y=z.taskManager.addObjectsTask(function B(D){if(Array.isArray(D.physicalIds)){w.grids.reportedAgainst.addObjects(D.physicalIds)}else{}z.unmaskForTask(y)},function x(){z.unmaskForTask(y)});z.maskForTask(y,h.tasks.addObjects)}else{l.in_apps_search({callback:function(E){var D=[];var F=0;for(var G=0;G<E.length;G++){if(E[G]["ds6w:type_value"]===n.ISSUE_TYPE){F++}else{D.push(E[G].id)}}if(F!==0){r.displayNotification({msg:h.replace(h.resolveIssues.issueNotDroppable,{number:F}),eventID:"error"});return}w.grids.reportedAgainst.addObjects(D)},cancel:function(){}})}}},{fonticon:"docs",text:h.resolveIssues.addObjectsForResolvedBy,handler:function(){var A=i.get("application");var C=g.is(A,"object")&&A.isStandalone;if(C){var z=i.get("component");var y=z.taskManager.addObjectsTask(function B(D){if(Array.isArray(D.physicalIds)){w.grids.resolvedBy.addObjects(D.physicalIds)}else{}z.unmaskForTask(y)},function x(){z.unmaskForTask(y)});z.maskForTask(y,h.tasks.addObjects)}else{l.in_apps_search({callback:function(D){var G=[];var E=0;for(var F=0;F<D.length;F++){if(D[F]["ds6w:type_value"]===n.ISSUE_TYPE){E++}else{G.push(D[F].id)}}if(E!==0){r.displayNotification({msg:h.replace(h.resolveIssues.issueNotDroppable,{number:E}),eventID:"error"});return}w.grids.resolvedBy.addObjects(G)},cancel:function(){}})}}}]}}},{fonticon:"arrow-combo-"+w.viewLayout,name:"viewLayout",text:h.resolveIssues.changeViewLayout,handler:function(){w.toggleLayout(w)}}]});d.end(w.name+" createContent");return w.views.related.main},createContexts:function(){var w=this;d.start(w.name+" createContexts");w.views.contexts.main=g.createElement("div",{"class":"issue-context-main",html:[w.views.contexts.contextHeader=g.createElement("div",{"class":"issue-context-header",html:[{tag:"label",html:h.resolveIssues.contexts.contexts},w.views.contexts.contextsCount=g.createElement("div",{"class":"related-objects-count",html:"0"})]}),w.views.contexts.contextListView=g.createElement("div",{"class":"issue-context-treelistview"}),w.views.contexts.treeListContainer=g.createElement("div",{"class":"related-form-treelist treelist-empty",id:n.TREE_TYPE_CONTEXTS})]});w.views.contexts.contextPlaceholder=g.createElement("span",{"class":"treelist-placeholder",html:h.placeholder.contextPlaceholder}).inject(w.views.contexts.treeListContainer);w._addDropEvent(w.views.contexts.treeListContainer);var v=(i.get("widget").name===n.ISSUE_3D_REVIEW);w.views.contexts.iconbar=new a({renderTo:w.views.contexts.contextHeader,items:[{fonticon:"location",name:"location",text:h.resolveIssues.contexts.pickContext,handler:function(){var z=i.get("component");if(v){if(z.isInspected()){r.displayNotification({msg:h.resolveIssues.pickupError_needtoExitInspectionMode,eventID:"error"})}else{z.utils.selectIn3D(function(B){w.grids.contexts.addObjects([B])})}}else{var y=z.taskManager.addSelectIn3DTask(function A(B){var C=B.target;w.grids.contexts.addObjects([C]);z.unmaskForTask(y)},function x(){z.unmaskForTask(y)});z.maskForTask(y,h.tasks.selectIn3D)}}},{fonticon:"list-add",name:"searchContext",text:h.resolveIssues.contexts.addContext,handler:function(){var A=i.get("application");var C=g.is(A,"object")&&A.isStandalone;if(C){var z=i.get("component");var y=z.taskManager.addObjectsTask(function B(D){if(Array.isArray(D.physicalIds)){w.grids.contexts.addObjects(D.physicalIds)}else{}z.unmaskForTask(y)},function x(){z.unmaskForTask(y)});z.maskForTask(y,h.tasks.addObjects)}else{l.in_apps_search({callback:function(D){var F=[];for(var E=0;E<D.length;E++){F.push(D[E].id)}if(F.length>0){w.grids.contexts.addObjects(F)}},cancel:function(){}})}}}]});d.end(w.name+" createContexts");return w.views.contexts.main},toggleLayout:function(){var v=this;if(v.viewLayout===p.VERTICAL){v.viewLayout=p.HORIZONTAL}else{v.viewLayout=p.VERTICAL}var w=v.views.related.iconbar.getItem("viewLayout");w.elements.icon.toggleClassName("fonticon-arrow-combo-"+p.HORIZONTAL);w.elements.icon.toggleClassName("fonticon-arrow-combo-"+p.VERTICAL);localStorage.setItem(k,v.viewLayout);v.changeView()},changeView:function(){var v=this;if(v.viewLayout===p.VERTICAL){if(v.views.small&&v.views.small.hasClassName("related-objects-view-related-smallview")){v.views.small.removeClassName("related-objects-view-related-smallview")}if(v.views.related.raRbContainer&&!v.views.related.raRbContainer.hasClassName("related-view-ra-rb-container-smallview")){v.views.related.raRbContainer.addClassName("related-view-ra-rb-container-smallview")}}else{if(v.views.small&&!v.views.small.hasClassName("related-objects-view-related-smallview")){v.views.small.addClassName("related-objects-view-related-smallview")}if(v.views.related.raRbContainer&&v.views.related.raRbContainer.hasClassName("related-view-ra-rb-container-smallview")){v.views.related.raRbContainer.removeClassName("related-view-ra-rb-container-smallview")}}},clear:function(){var v=this;v.issues={}},destroy:function(){var v=this;if(v.views.main){v.views.main.destroy()}v.stopListening(v.grids.reportedAgainst,"onUpdate");v.stopListening(v.grids.resolvedBy,"onUpdate");v.stopListening(v.grids.contexts,"onUpdate");if(v.grids.reportedAgainst){v.grids.reportedAgainst.destroy();v.grids.reportedAgainst=null}if(v.grids.resolvedBy){v.grids.resolvedBy.destroy();v.grids.resolvedBy=null}if(v.grids.contexts){v.grids.contexts.destroy();v.grids.contexts=null}v.views={};v.grids={};v._timestampUpdate=0},reBuildPanel:function(v){var w=this;d.start(w.name+" reBuildPanel");if(!w.grids.reportedAgainst||!w.grids.resolvedBy){w._logger.log("this dialog is already closed.");return}w.clear();w.options.ids=v;w.load(w.options.ids);d.end(w.name+" reBuildPanel")},refresh:function(x){var w=this;d.start(w.name+" refresh");var v=x;if(!v){v=w.options.ids}w.reBuildPanel(v);d.end(w.name+" refresh");return w.isLoaded},load:function(v){var w=this;w.isLoaded=new e(function(y,x){w._deferred.resolve=y;w._deferred.reject=x});w.fetchIssuesAndRelatedObjects(v).then(function(x){w.issues=x.issues;if(w.issues.length>0){w.grids.reportedAgainst.load(x.issues);w.grids.resolvedBy.load(x.issues);w.grids.contexts.load(x.issues);var A=0;var y=0;var z=function(D){A++;if(!D){y++}if(A===3){if(y>0){w._deferred.reject();w.dispatchEvent("onFailure",{error:"Cannot load the related view"})}else{w._deferred.resolve();w.dispatchEvent("onReady",{})}}};var C=function(){z(true)};var B=function(){z(false)};w.grids.reportedAgainst.isLoaded.then(C,B);w.grids.resolvedBy.isLoaded.then(C,B);w.grids.contexts.isLoaded.then(C,B)}},function(){r.displayNotification({msg:h.resolveIssues.errorGetIssues,eventID:"error"});w._deferred.reject()})},fetchIssuesAndRelatedObjects:function(v){var w=this;return new e(function(y,x){f.issues.retrieve({timestamp:w._timestampUpdate?w._timestampUpdate:null,data:{objects:v.map(function(z){return{physicalId:z}})},onComplete:function(D){if(Array.isArray(D)){var z={issues:[]};for(var F=0;F<D.length;F++){var G=D[F].body;var B={id:G.physicalId,name:G.name,title:G.title,type:G.type,revision:"",state:G.state,description:G.description,rowNumForEmpty:{},relatedObjects:{}};z.issues.push(B);B.relatedObjects[n.TREE_TYPE_REPORTED_AGAINST]=[];B.relatedObjects[n.TREE_TYPE_RESOLVED_BY]=[];B.relatedObjects[n.TREE_TYPE_CONTEXTS]=[];for(var C=0;C<G.reportedAgainst.length;C++){B.relatedObjects[n.TREE_TYPE_REPORTED_AGAINST].push(G.reportedAgainst[C].physicalId)}for(var E=0;E<G.resolvedBy.length;E++){B.relatedObjects[n.TREE_TYPE_RESOLVED_BY].push(G.resolvedBy[E].physicalId)}for(var A=0;A<G.contexts.length;A++){B.relatedObjects[n.TREE_TYPE_CONTEXTS].push(G.contexts[A].physicalId)}}y(z)}else{x(new Error("Unexpected response when retrieving issues."))}},onFailure:function(z){w._logger.log("getIssues :Failure..."+z);x(z)}})})},createTreeViews:function(v,y){var x=this;d.start(x.name+" createTreeViews");var w=new j(v,{type:y},x);d.end(x.name+" createTreeViews");return w},_addDropEvent:function(x){var w=this;var v=0;x.addEventListener("drop",w._onTreeListDrop.bind(w));x.addEventListener("dragenter",function(){x.addClassName("drag-enter");v++});x.addEventListener("dragleave",function(){v--;if(v===0){x.removeClassName("drag-enter")}});document.addEventListener("dragover",function(y){y.preventDefault()})},getDroppedInfo:function(z){var y=[];try{var v=c.getDroppableData(z).data.items;var w=0;v.forEach(function(A){if(A.objectType===n.ISSUE_TYPE){w++}else{if(y.indexOf(A.objectId)===-1){y.push(A.objectId)}}});if(w!==0){r.displayNotification({msg:h.replace(h.resolveIssues.issueNotDroppable,{number:w}),eventID:"error"})}}catch(x){r.displayNotification({msg:h.resolveIssues.errorNotSupportedObject,eventID:"error"});return null}return y},_onTreeListDrop:function(y){var x=this;y.currentTarget.removeClassName("drag-enter");y.preventDefault();var w=y.currentTarget.id;var v=x.getDroppedInfo(y);if(v.length>=1){if(w===n.TREE_TYPE_REPORTED_AGAINST){x.grids.reportedAgainst.addObjects(v)}if(w===n.TREE_TYPE_RESOLVED_BY){x.grids.resolvedBy.addObjects(v)}if(w===n.TREE_TYPE_CONTEXTS){x.grids.contexts.addObjects(v)}x.refreshItemCount()}else{r.displayNotification({msg:h.create.related.dropError,eventID:"error"})}},refreshItemCount:function(){var A=this;d.start(A.name+" refreshItemCount");var x=A.grids.reportedAgainst;var z=A.grids.resolvedBy;var C=A.grids.contexts;var B=x.getCount();A.views.related.reportedAgainstCount.innerHTML=B.sum;var w=z.getCount();A.views.related.resolvedByCount.innerHTML=w.sum;var v={sum:B.sum+w.sum,deleted:B.deleted+w.deleted,added:B.added+w.added};A.views.related.relateditems.innerHTML=h.replace(h.resolveIssues.items,{count:v.sum});var y=C.getCount();A.views.contexts.contextsCount.innerHTML=y.sum;A.hideShowPlaceHolder(B.sum,w.sum,y.sum);d.end(A.name+" refreshItemCount")},hideShowPlaceHolder:function(y,v,w){var x=this;x.views.related.reportedAgainstListView=x.views.related.reportedAgainst.querySelector(".wux-tree-treelistview.issue-tree-list-view");if(y===0){if(x.views.related.reportedAgainstListView&&!x.views.related.reportedAgainstListView.hasClassName("hidden")){x.views.related.reportedAgainstListView.addClassName("hidden")}if(x.views.related.treeListContainerReportedAgainst&&x.views.related.treeListContainerReportedAgainst.hasClassName("hidden")){x.views.related.treeListContainerReportedAgainst.removeClassName("hidden")}}else{if(x.views.related.reportedAgainstListView&&x.views.related.reportedAgainstListView.hasClassName("hidden")){x.views.related.reportedAgainstListView.removeClassName("hidden")}if(x.views.related.treeListContainerReportedAgainst&&!x.views.related.treeListContainerReportedAgainst.hasClassName("hidden")){x.views.related.treeListContainerReportedAgainst.addClassName("hidden")}}x.views.related.resolvedListView=x.views.related.resolvedBy.querySelector(".wux-tree-treelistview.issue-tree-list-view");if(v===0){if(x.views.related.resolvedListView&&!x.views.related.resolvedListView.hasClassName("hidden")){x.views.related.resolvedListView.addClassName("hidden")}if(x.views.related.treeListContainerResolvedBy&&x.views.related.treeListContainerResolvedBy.hasClassName("hidden")){x.views.related.treeListContainerResolvedBy.removeClassName("hidden")}}else{if(x.views.related.resolvedListView&&x.views.related.resolvedListView.hasClassName("hidden")){x.views.related.resolvedListView.removeClassName("hidden")}if(x.views.related.treeListContainerResolvedBy&&!x.views.related.treeListContainerResolvedBy.hasClassName("hidden")){x.views.related.treeListContainerResolvedBy.addClassName("hidden")}}if(w===0){if(x.views.contexts.contextListView&&!x.views.contexts.contextListView.hasClassName("hidden")){x.views.contexts.contextListView.addClassName("hidden")}if(x.views.contexts.treeListContainer&&x.views.contexts.treeListContainer.hasClassName("hidden")){x.views.contexts.treeListContainer.removeClassName("hidden")}}else{if(x.views.contexts.contextListView&&x.views.contexts.contextListView.hasClassName("hidden")){x.views.contexts.contextListView.removeClassName("hidden")}if(x.views.contexts.treeListContainer&&!x.views.contexts.treeListContainer.hasClassName("hidden")){x.views.contexts.treeListContainer.addClassName("hidden")}}},utils:{pushObjectIdIntoArrayOnce:function(v,w){if(w.indexOf(v)>-1){w.push(v);return true}return false}}});return m});define("DS/IssueComponents/create/Team",["UWA/Class/View","UWA/Class/Promise","UWA/Core","DS/ENOFloatingPanel/ENOFloatingPanel","DS/Logger/Logger","DS/PADUtils/views/PADAlert","DS/SearchWidget/SearchWidgetConstant","DS/UIKIT/Form","DS/UIKIT/Input/Select","DS/UIKIT/Input/Toggle","DS/UIKIT/Tooltip","DS/IssueCommon/commands/CommandsManager","DS/IssueCommon/utils/Utils","DS/IssueComponents/search/PeopleSearch","DS/IssueServices/services/IssueServices","DS/IssueServices/services/PlatformServices","DS/IssueServices/Contexts","DS/IssueServices/utils/Performance","i18n!DS/IssueComponents/assets/nls/IssueComponents","css!DS/IssueComponents/IssueComponents.css"],function(q,c,f,k,u,s,o,g,m,n,r,a,j,t,d,i,h,b,e){var l={PERSONAL_COLLABORATIVE_SPACE:"_PRJ",ROLES_TYPES:{RESPONSIBLE_ORGANIZATION:"responsibleOrganization",OWNER:"owner",CO_OWNERS:"coOwners",ASSIGNEES:"assignees",PARTICIPANTS:"participants"},COMMA_SEPARATOR:","};var p=q.extend({name:"DS/IssueComponents/create/Team",tag:"div",className:"create-view-content-subview create-team",isInit:null,_deferredInit:{resolve:null,reject:null},setup:function(v){var w=this;w._parent(v);w.parent=v.parent;w.isInit=new c(function(y,x){w._deferredInit.resolve=y;w._deferredInit.reject=x});w.form=null;w.formElements={responsibleOrganization:null,owner:null,coOwners:null,assigness:null,participants:null};w.formElementsToggler={responsibleOrganization:null,owner:null,coOwners:null,assigness:null,participants:null};w.fields={responsibleOrganization:null,assignToMe:null,addOwner:null,addCoOwners:null,addAssignees:null,addReviewers:null,addParticipants:null};w.values={responsibleOrganization:null,owner:{},coOwners:{},assignees:{},participants:{}};w.listenTo(w.parent,"related-add-reportedAgainst",function(x){w._addUser({user:x.data.owner,fullName:x.data.responsible},"assignees");w._setOrganization(x.data.organizationResponsible,l.ROLES_TYPES.RESPONSIBLE_ORGANIZATION)});d.organizations.getCompanies({onComplete:function(x){w.organizations=x.body},onFailure:function(){w.organizations=[]}})["finally"](function(){w._deferredInit.resolve()})},destroy:function(){var v=this;v.form=null;v.formElements={responsibleOrganization:null,coOwners:null,assigness:null,participants:null};v.formElementsToggler={responsibleOrganization:null,coOwners:null,assigness:null,participants:null};v.fields={responsibleOrganization:null,assignToMe:null};v.values={coOwners:{},assignees:{},participants:{}}},render:function(){var v=this;v.form=new g({className:"create-team-form",fields:[],events:{onInvalid:function(){}}}).inject(v.container);var w=f.createElement("div",{"class":"create-form-content",html:[v.formElements.owner=f.createElement("div",{"class":"create-form-element create-team-form-element-owner",html:[{tag:"div","class":"create-form-visibility-mask"},{tag:"div","class":"create-form-visibility-toggle",html:[v.formElementsToggler.owner=f.createElement("span",{"class":"fonticon fonticon-eye"})]},{tag:"div","class":"create-form-field form-group",html:[f.createElement("div",{"class":"create-form-element-title",html:[{tag:"h5",html:e.create.team.labels.owner}]}),{tag:"div","class":"issue-owner-search-container",html:[f.createElement("div",{"class":"form-group-owner",html:(v.fields.addOwner=v._peopleSearch(l.ROLES_TYPES.OWNER))}),(v.fields.owner=f.createElement("div",{"class":"form-group-owner-holder"}))]}]},{tag:"div","class":"create-form-help",html:[f.createElement("div",{"class":"create-form-help-content",html:[f.createElement("span",{"class":"fonticon fonticon-help"}),e.create.team.labels.ownerHelper]})]}]}),v.formElements.coOwners=f.createElement("div",{"class":"create-form-element create-team-form-element-coowners",html:[{tag:"div","class":"create-form-visibility-mask"},{tag:"div","class":"create-form-visibility-toggle",html:[v.formElementsToggler.coOwners=f.createElement("span",{"class":"fonticon fonticon-eye"})]},{tag:"div","class":"create-form-field form-group",html:[f.createElement("div",{"class":"create-form-element-title",html:[{tag:"h5",html:e.create.team.labels.coOwners}]}),{tag:"div","class":"issue-coowners-search-container",html:[f.createElement("div",{"class":"form-group-coowners",html:(v.fields.addCoOwners=v._peopleSearch(l.ROLES_TYPES.CO_OWNERS))}),(v.fields.coOwners=f.createElement("div",{"class":"form-group-coowners-holder"}))]}]},{tag:"div","class":"create-form-help",html:[f.createElement("div",{"class":"create-form-help-content",html:[f.createElement("span",{"class":"fonticon fonticon-help"}),e.create.team.labels.coOwnersHelper]})]}]}),v.formElements.assignees=f.createElement("div",{"class":"create-form-element create-team-form-element-assignees",html:[{tag:"div","class":"create-form-visibility-mask"},{tag:"div","class":"create-form-visibility-toggle",html:[v.formElementsToggler.assignees=f.createElement("span",{"class":"fonticon fonticon-eye"})]},{tag:"div","class":"create-form-field form-group",html:[f.createElement("div",{"class":"create-form-element-title",html:[{tag:"h5",html:e.create.team.labels.assignees},{tag:"span","class":"issue-assign-to-me",html:(v.fields.assignToMe=new n({type:"checkbox",value:"assign-me",label:e.create.team.labels.assignToMe,checked:false,className:"primary",events:{onChange:function(){if(this.isChecked()){v._addUser({user:i.getUserName(),fullName:i.getFullName(),position:0},l.ROLES_TYPES.ASSIGNEES)}else{v._removeUser({user:i.getUserName(),fullName:i.getFullName()},l.ROLES_TYPES.ASSIGNEES)}}}}))}]}),{tag:"div","class":"issue-assignees-search-container",html:[f.createElement("div",{"class":"form-group-assignees",html:(v.fields.addAssignees=v._peopleSearch(l.ROLES_TYPES.ASSIGNEES))}),(v.fields.assignees=f.createElement("div",{"class":"form-group-assignees-holder"}))]}]},{tag:"div","class":"create-form-help",html:[f.createElement("div",{"class":"create-form-help-content",html:[f.createElement("span",{"class":"fonticon fonticon-help"}),e.create.team.labels.assigneesHelper]})]}]}),v.formElements.responsibleOrganization=f.createElement("div",{"class":"create-form-element create-team-form-element-responsible-organization",html:[{tag:"div","class":"create-form-visibility-mask"},{tag:"div","class":"create-form-visibility-toggle",html:[v.formElementsToggler.responsibleOrganization=f.createElement("span",{"class":"fonticon fonticon-eye"})]},{tag:"div","class":"create-form-field form-group",html:[{tag:"h5",html:e.create.team.labels.responsibleOrganization},{tag:"div",html:[(v.fields.addResponsibleOrganization=v._orgSearch(l.ROLES_TYPES.RESPONSIBLE_ORGANIZATION)),(v.fields.responsibleOrganization=f.createElement("div",{"class":"form-group-responsible-organization-holder"}))]}]},{tag:"div","class":"create-form-help",html:[f.createElement("div",{"class":"create-form-help-content",html:[f.createElement("span",{"class":"fonticon fonticon-help"}),e.create.team.labels.responsibleOrganizationHelper]})]}]}),v.formElements.participants=f.createElement("div",{"class":"create-form-element create-team-form-element-participants",html:[{tag:"div","class":"create-form-visibility-mask"},{tag:"div","class":"create-form-visibility-toggle",html:[v.formElementsToggler.participants=f.createElement("span",{"class":"fonticon fonticon-eye"})]},{tag:"div","class":"create-form-field form-group",html:[f.createElement("div",{"class":"create-form-element-title",html:[{tag:"h5",html:e.create.team.labels.participants}]}),{tag:"div","class":"issue-participants-search-container",html:[f.createElement("div",{"class":"form-group-participants",html:(v.fields.addParticipants=v._peopleSearch(l.ROLES_TYPES.PARTICIPANTS))}),(v.fields.participants=f.createElement("div",{"class":"form-group-participants-holder"}))]}]},{tag:"div","class":"create-form-help"}]})]});w.inject(v.form.elements.container);v.reset().then(v._deferredInit.resolve);return v},getValues:function(){var w=this;var v={owner:{user:Object.keys(w.values.owner)[0]},coOwners:Object.keys(w.values.coOwners).map(function(x){return{user:x}}),assignees:Object.keys(w.values.assignees).map(function(x){return{user:x}}),responsibleOrganization:w.values.responsibleOrganization,reportingOrganization:i.getCurrentCredentials().organization};return v},getUIValues:function(){var w=this;var v={owner:w.values.owner,coOwners:w.values.coOwners,assignees:w.values.assignees,responsibleOrganization:w.values.responsibleOrganization};return v},getHiddenAttributes:function(){var w=this;var x={};for(var v in w.formElements){if(f.is(w.formElementsToggler[v])){x[v]=w.formElementsToggler[v].hasClassName("fonticon-eye-off")}}return x},applyTemplate:function(v){var w=this;return w.reset().then(function(){if(f.is(v.ui)){if(f.is(v.ui.owner,"object")){Object.keys(v.ui.owner).forEach(function(A){w._addUser(v.ui.owner[A],l.ROLES_TYPES.OWNER)})}if(f.is(v.ui.coOwners,"object")){Object.keys(v.ui.coOwners).forEach(function(A){w._addUser(v.ui.coOwners[A],l.ROLES_TYPES.CO_OWNERS)})}if(f.is(v.ui.assignees,"object")){Object.keys(v.ui.assignees).forEach(function(A){w._addUser(v.ui.assignees[A],l.ROLES_TYPES.ASSIGNEES)})}}if(f.is(v.data,"object")){if(f.is(v.data.responsibleOrganization)){w._setOrganization(v.data.responsibleOrganization,l.ROLES_TYPES.RESPONSIBLE_ORGANIZATION)}}if(f.is(v.hidden,"object")){if(f.is(w.formElements,"object")&&f.is(w.formElementsToggler,"object")){var y=w.formElements;var z=w.formElementsToggler;for(var x in y){if(v.hidden[x]===true){if(w.parent.isTemplate){if(f.is(y[x])){y[x].toggleClassName("visibility-masked",true)}if(f.is(z[x])){z[x].toggleClassName("fonticon-eye-off",true);z[x].toggleClassName("fonticon-eye",false)}}else{if(f.is(y[x])){y[x].hide()}}}}}}return c.resolve()})},reset:function(){var v=this;return new c(function(w){Object.keys(v.values.owner).forEach(function(x){v._removeUser(v.values.owner[x],l.ROLES_TYPES.OWNER)});v._addUser({user:i.getUserName(),fullName:i.getFullName()},l.ROLES_TYPES.OWNER);Object.keys(v.values.coOwners).forEach(function(x){v._removeUser(v.values.coOwners[x],l.ROLES_TYPES.CO_OWNERS)});v._setOrganization(i.getCurrentCredentials().organization,l.ROLES_TYPES.RESPONSIBLE_ORGANIZATION);Object.keys(v.values.assignees).forEach(function(x){v._removeUser(v.values.assignees[x],l.ROLES_TYPES.ASSIGNEES)});w()})},_orgSearch:function(x){var v=this;var w=new t({className:"searchPeople_TransferOwnership",MaxNumber:"5",MaxSize:"300",position:"auto",showEmptyCategory:false,type:o.TYPE_ORGANIZATION,events:{onValid:function(){var y=w.getNewOwner().organization;v._setOrganization(y.orgID,x);w.clearInput();w.getContent().searchInput.focus()},onUnvalid:function(){},onError:function(){s.displayNotification({msg:e.team.error.orgNotFound,eventID:"info"})}}});w.setSelectedItemList([{objectID:v.organizations[0].physicalId}]);return w},_setOrganization:function(w,y){var x=this;var v=f.createElement("div",{"class":"team-content-org-container",html:[f.createElement("span",{"class":"team-content-org-icon fonticon view-icon fonticon-users"}),f.createElement("span",{"class":"team-content-org-info",html:j.getTextFromHTML(w)})]});x.fields[y].empty();x.fields[y].appendChild(v);x.values[y]=w},_peopleSearch:function(x){var v=this;var w=new t({className:"searchPeople_TransferOwnership",MaxNumber:"5",MaxSize:"300",position:"auto",showEmptyCategory:false,type:o.TYPE_PERSON,events:{onValid:function(){var y=w.getNewOwner().person;v._addUser({user:y.personID.replace(l.PERSONAL_COLLABORATIVE_SPACE,""),fullName:y.personFullName},x);w.clearInput();w.getContent().searchInput.focus()},onUnvalid:function(){},onError:function(){s.displayNotification({msg:e.team.error.notFound,eventID:"info"})},onValidUsers:function(y){var z=Object.keys(y).map(function(A){return y[A]});z.forEach(function(B){var A={};A.user=B.name;A.fullName=B.firstname+" "+B.lastname;if(B.hasOwnProperty("company")&&B.company.hasOwnProperty("name")){A.responsibleOrganization=B.company.name}v._addUser(A,x)});w.clearInput();w.getContent().searchInput.focus()}}});w.setSelectedItemList([{objectID:v.organizations[0].physicalId}]);return w},_addUser:function(x,A){var y=this;if(A===l.ROLES_TYPES.OWNER){Object.keys(y.values.owner).forEach(function(B){y._removeUser(y.values.owner[B],l.ROLES_TYPES.OWNER)});if(y.values.coOwners.hasOwnProperty(x.user)){y._removeUser(y.values.coOwners[x.user],l.ROLES_TYPES.CO_OWNERS)}}if(A===l.ROLES_TYPES.CO_OWNERS&&y.values.owner.hasOwnProperty(x.user)){s.displayNotification({msg:e.create.team.cannotAddOwnerAsCoOwner,eventID:"error"});return}if(y.values[A][x.user]){s.displayNotification({msg:e.replace(e.create.team.alreadyAssigned,{name:x.fullName}),eventID:"info"});return}var v=y._createUserHTML(x,A);if(A!==l.ROLES_TYPES.OWNER){var w=f.createElement("span",{"class":"team-content-user-remove fonticon fonticon-cancel-circled"}).inject(v);var z=new r({position:"left",target:w,body:e.create.team.removeAssignee,animate:false});w.addEventListener("click",function(){y._removeUser(x,A);z.destroy()})}if(y._isInteger(x.position)){y.fields[A].insertBefore(v,y.fields[A].children[x.position])}else{y.fields[A].appendChild(v)}if(A===l.ROLES_TYPES.ASSIGNEES&&x.user===i.getUserName()&&!y.fields.assignToMe.isChecked()){y.fields.assignToMe.check()}x.element=v;y.values[A][x.user]=x;if(A===l.ROLES_TYPES.ASSIGNEES){if(x.responsibleOrganization!==undefined){y._setOrganization(x.responsibleOrganization,l.ROLES_TYPES.RESPONSIBLE_ORGANIZATION)}else{i.getUserInfo(x.user,{onComplete:function(C){var B=JSON.parse(C);if(B.hasOwnProperty("company")&&B.company.hasOwnProperty("name")){y._setOrganization(B.company.name,l.ROLES_TYPES.RESPONSIBLE_ORGANIZATION)}},onFailure:function(){}})}}},_removeUser:function(v,x){var w=this;if(!w.values[x][v.user]){return}if(x===l.ROLES_TYPES.ASSIGNEES&&v.user===i.getUserName()&&w.fields.assignToMe.isChecked()===true){w.fields.assignToMe.uncheck()}w.values[x][v.user].element.destroy();delete w.values[x][v.user]},_createUserHTML:function(w,A){var x=i.getUserImage(w.user);var y=f.createElement("div",{id:A+"-"+j.getTextFromHTML(w.user),"class":"team-content-user-container"});var z=f.createElement("img",{"class":"team-content-user-img",title:j.getTextFromHTML(w.fullName+" ("+w.user+")"),src:x});z.addEventListener("click",function(){i.getUserProfile(w.user)});z.inject(y);var v=f.createElement("div",{"class":"team-content-user-info"}).inject(y);f.createElement("span",{"class":"team-content-user-full-name",html:j.getTextFromHTML(w.fullName)}).inject(v);f.createElement("span",{"class":"team-content-user-id",html:j.getTextFromHTML(w.user)}).inject(v);return y},_isInteger:function(v){return Number.isInteger?Number.isInteger(v):typeof v==="number"&&isFinite(v)&&Math.floor(v)===v}});return p});define("DS/IssueComponents/create/Related",["UWA/Class/Promise","UWA/Class/View","UWA/Core","DS/UIKIT/Form","DS/UIKIT/Iconbar","DS/ENOFloatingPanel/ENOFloatingPanel","DS/Logger/Logger","DS/PADUtils/views/PADAlert","DS/Tree/TreeListView","DS/TreeModel/TreeNodeModel","DS/Visualization/ThreeJS_DS","DS/IssueCommon/commands/CommandsManager","DS/IssueComponents/utils/Utils","DS/IssueServices/Contexts","DS/IssueServices/services/IssueServices","DS/IssueServices/services/PlatformServices","DS/IssueServices/utils/Parser","DS/IssueServices/utils/Performance","i18n!DS/IssueComponents/assets/nls/IssueComponents","css!DS/IssueComponents/IssueComponents.css"],function(g,s,j,k,c,o,u,t,m,p,a,d,f,l,h,n,b,e,i){var q={ISSUE_MANAGEMENT:"ENXISSU_AP",ISSUE_3D_REVIEW:"ENX3DIR_AP",PATH_TO_PARSE:0,RELATED_OBJECTS_TYPES:{CONTEXTS:"contexts",REPORTED_AGAINST:"reportedAgainst"}};var r=s.extend({name:"DS/IssueComponents/create/Related",tag:"div",className:"create-view-content-subview create-related",defaultOptions:{treelist:{grid:{height:"100%",apiVersion:2,defaultCellHeight:26,useTransparentScroller:false,useNativeScroller:false,useAsyncPreExpand:true,resize:{columns:true,rows:false},selection:{unselectAllOnEmptyArea:true,toggle:false,canMultiSelect:true,enableListSelection:true,renderingMode:"adaptive"},columns:[{text:i.create.related.treelist.tree,dataIndex:"tree",width:"auto",isDraggable:false},{text:i.create.related.treelist["ds6w:type"],width:"auto",dataIndex:"ds6w:type",isDraggable:false},{text:i.create.related.treelist["ds6w:identifier"],width:"auto",dataIndex:"ds6w:identifier",isDraggable:false},{text:i.create.related.treelist["ds6wg:revision"],width:"auto",dataIndex:"ds6wg:revision",isDraggable:false}]}}},isInit:null,_deferredInit:{resolve:null,reject:null},setup:function(v){var w=this;w._parent(v);w.parent=v.parent;w.isInit=new g(function(y,x){w._deferredInit.resolve=y;w._deferredInit.reject=x});w.form=null;w.formElements={reportedAgainst:null,contexts:null};w.formElementsToggler={reportedAgainst:null,contexts:null};w.fields={reportedAgainst:{},contexts:{},balloons:null};w._deferredInit.resolve()},destroy:function(){var v=this;if(v.fields.reportedAgainst.treeList){v.fields.reportedAgainst.treeList.getRoots().forEach(function(x){if(x.options.position&&x.options.position.balloons&&x.options.position.balloons.length){var y=x.options.position.balloons;for(var w=0;w<y.length;w++){x.options.position.balloons[w].destroy()}}})}v.form=null;v.formElements={reportedAgainst:null,contexts:null};v.formElementsToggler={reportedAgainst:null,contexts:null};v.fields={reportedAgainst:{},contexts:{},balloons:null}},render:function(){var v=this;v._renderReportedAgainstField();v._renderContextField();v.form=new k({className:"create-related-form",fields:[],events:{onInvalid:function(){}}}).inject(v.container);var w=j.createElement("div",{"class":"create-form-content",html:[v.formElements.reportedAgainst=j.createElement("div",{"class":"create-form-element create-related-form-element-reported-against",html:[{tag:"div","class":"create-form-visibility-mask"},{tag:"div","class":"create-form-visibility-toggle",html:[v.formElementsToggler.reportedAgainst=j.createElement("span",{"class":"fonticon fonticon-eye"})]},{tag:"div","class":"create-form-field form-group",html:[v.fields.reportedAgainst.title,v.fields.reportedAgainst.treeListContainer]},{tag:"div","class":"create-form-help",html:[j.createElement("div",{"class":"create-form-help-content",html:[j.createElement("span",{"class":"fonticon fonticon-help"}),i.create.related.labels.reportedAgainstHelper]})]}]}),v.formElements.contexts=j.createElement("div",{"class":"create-form-element create-related-form-element-contexts",html:[{tag:"div","class":"create-form-visibility-mask"},{tag:"div","class":"create-form-visibility-toggle",html:[v.formElementsToggler.contexts=j.createElement("span",{"class":"fonticon fonticon-eye"})]},{tag:"div","class":"create-form-field form-group",html:[v.fields.contexts.title,v.fields.contexts.treeListContainer]},{tag:"div","class":"create-form-help",html:[j.createElement("div",{"class":"create-form-help-content",html:[j.createElement("span",{"class":"fonticon fonticon-help"}),i.create.related.labels.contextHelper]})]}]})]});w.inject(v.form.elements.container);return v},getValues:function(){var x=this;var v=[];x.fields.reportedAgainst.treeList.getDocument().getRoots().forEach(function(z){var A={physicalId:z.options.id,};v.push(A);if(z.options.hasOwnProperty("position")&&z.options.position!==null&&z.options.position!==undefined){A.position={x:z.options.position.x,y:z.options.position.y,z:z.options.position.z}}});var y=[];x.fields.contexts.treeList.getDocument().getRoots().forEach(function(z){var A={physicalId:z.options.id};y.push(A)});var w={reportedAgainst:v,contexts:y};return w},getHiddenAttributes:function(){var w=this;var x={};for(var v in w.formElements){if(j.is(w.formElementsToggler[v])){x[v]=w.formElementsToggler[v].hasClassName("fonticon-eye-off")}}return x},applyTemplate:function(v){var w=this;return w.reset().then(function(){var z=[];if(Array.isArray(v.data.reportedAgainst)&&v.data.reportedAgainst.length>0){v.data.reportedAgainst.forEach(function(F){var I=F.position&&j.is(F.position,"object");var C=j.merge(F.automation||{},{assignee:false,context:false});if(I===true){var E=(l.get("widget").name===q.ISSUE_3D_REVIEW);var K=l.get("component");var J=(K&&"getManager" in K&&K.getManager());var B=[];var H={};H[F.physicalId]={x:F.position.x,y:F.position.y,z:F.position.z,balloons:[]};if(E&&J){B=K.getManager().getNodesById(F.physicalId)}if(B.hasOwnProperty("nodes")&&B.nodes.length>0){var D=[];for(var G=0;G<B.nodes.length;G++){D.push(new g(function(L){w._addBalloon(H[F.physicalId],F.physicalId,B.paths[G],function(){H[F.physicalId].balloons.push(this);L()})}))}z.push(g.all(D).then(function(){w.parent.elements.dialog.show();return w._addNodes([F.physicalId],q.RELATED_OBJECTS_TYPES.REPORTED_AGAINST,H,!C.assignee)}))}else{z.push(w._addNodes([F.physicalId],q.RELATED_OBJECTS_TYPES.REPORTED_AGAINST,H,!C.assignee))}}else{z.push(w._addNodes([F.physicalId],q.RELATED_OBJECTS_TYPES.REPORTED_AGAINST,null,!C.assignee))}})}if(Array.isArray(v.data.contexts)&&v.data.contexts.length>0){z.push(w._addNodes(v.data.contexts.map(function(B){return B.physicalId}),q.RELATED_OBJECTS_TYPES.CONTEXTS))}if(j.is(v.hidden,"object")){if(j.is(w.formElements,"object")&&j.is(w.formElementsToggler,"object")){var y=w.formElements;var A=w.formElementsToggler;for(var x in y){if(v.hidden[x]===true){if(w.parent.isTemplate){if(j.is(y[x])){y[x].toggleClassName("visibility-masked",true)}if(j.is(A[x])){A[x].toggleClassName("fonticon-eye-off",true);A[x].toggleClassName("fonticon-eye",false)}}else{if(j.is(y[x])){y[x].hide()}}}}}}return g.all(z)})},reset:function(){var v=this;return new g(function(x){var w=v.fields.reportedAgainst.treeList.getRoots();v._removeNodes(w,q.RELATED_OBJECTS_TYPES.REPORTED_AGAINST);v._removeNodes(v.fields.contexts.treeList.getRoots(),q.RELATED_OBJECTS_TYPES.CONTEXTS);x()})},_renderReportedAgainstField:function(){var x=this;var w=(l.get("widget").name===q.ISSUE_3D_REVIEW);x.fields.reportedAgainst.title=j.createElement("div",{"class":"create-form-title-with-iconbar",html:[{tag:"h5",html:i.create.related.labels.reportedAgainst}]});x.fields.reportedAgainst.iconBar=new c({renderTo:x.fields.reportedAgainst.title,items:[{id:"location",fonticon:"location",text:i.create.related.addBalloonAvailable,handler:function(){var A=l.get("component");var B=function(I,D,E,G){var H=[];for(var F=0;F<E.nodes.length;F++){if(w){H.push(new g(function(J){x._addBalloon(D[I],I,E.paths[F],function(){D[I].balloons.push(this);J()})}))}else{H.push(g.resolve())}}g.all(H).then(function(){x.parent.elements.dialog.show();var J=[x._addNodes([I],q.RELATED_OBJECTS_TYPES.REPORTED_AGAINST,D)];if(j.is(G,"string")){J.push(x._addNodes([G],q.RELATED_OBJECTS_TYPES.CONTEXTS))}return J})};if(w){x.parent.elements.dialog.hide();A.utils.selectIn3D(function(G,D,E,F){B(G,D,E,F)},function(){x.parent.elements.dialog.show()})}else{var z=A.taskManager.addSelectIn3DTask(function C(F){var H=F.target;var D=F.positions;var E=F.nodes;var G=F.context;B(H,D,E,G);A.unmaskForTask(z)},function y(){A.unmaskForTask(z)});A.maskForTask(z,i.tasks.selectIn3D)}}},{id:"addReported",text:i.create.related.search,fonticon:"list-add",handler:function(){var B=l.get("application");var D=j.is(B,"object")&&B.isStandalone;if(D){var A=l.get("component");var z=A.taskManager.addObjectsTask(function C(E){if(Array.isArray(E.physicalIds)){x._addNodes(E.physicalIds,q.RELATED_OBJECTS_TYPES.REPORTED_AGAINST)}else{}A.unmaskForTask(z)},function y(){A.unmaskForTask(z)});A.maskForTask(z,i.tasks.addObjects)}else{n.search({title:i.create.related.labels.reportedAgainst,default_search_criteria:"",callback:function(E){var G=[];for(var F=0;F<E.length;F++){G.push(E[F].id)}x._addNodes(G,q.RELATED_OBJECTS_TYPES.REPORTED_AGAINST)},cancel:function(){}})}}},{id:"removeReported",text:i.create.related.remove,fonticon:"trash",handler:function(){x._removeSelectedNodes(q.RELATED_OBJECTS_TYPES.REPORTED_AGAINST)}}]});x.fields.reportedAgainst.treeListContainer=j.createElement("div",{"class":"create-form-treelist treelist-empty",id:q.RELATED_OBJECTS_TYPES.REPORTED_AGAINST});x.fields.reportedAgainst.treeListPlaceholder=j.createElement("span",{"class":"treelist-placeholder",html:i.create.related.labels.reportedAgainstPlaceholder}).inject(x.fields.reportedAgainst.treeListContainer);x._addDropEvent(x.fields.reportedAgainst.treeListContainer);var v=j.clone(x.options.treelist.grid);v.id=q.RELATED_OBJECTS_TYPES.REPORTED_AGAINST;v.onDropBlank=x._onTreeListDrop.bind(x);v.onDropCell=x._onTreeListDrop.bind(x);v.onDragStartCell=x._onDragStartCell.bind(x);v.allowUnsafeHTMLContent=false;x.fields.reportedAgainst.treeList=new m(v);x.fields.reportedAgainst.treeList.inject(x.fields.reportedAgainst.treeListContainer)},_renderContextField:function(){var x=this;var w=(l.get("widget").name===q.ISSUE_3D_REVIEW);x.fields.contexts.title=j.createElement("div",{"class":"create-form-title-with-iconbar",html:[{tag:"h5",html:i.create.related.labels.contexts}]});x.fields.contexts.iconBar=new c({renderTo:x.fields.contexts.title,items:[{id:"location",fonticon:"location",text:i.create.related.selectContextIn3D,handler:function(){var A=l.get("component");if(w){x.parent.elements.dialog.hide();A.utils.selectIn3D(function(C){x.parent.elements.dialog.show();x._addNodes([C],q.RELATED_OBJECTS_TYPES.CONTEXTS)},function(){x.parent.elements.dialog.show()})}else{var z=A.taskManager.addSelectIn3DTask(function B(C){var D=C.target;A.unmaskForTask(z);x._addNodes([D],q.RELATED_OBJECTS_TYPES.CONTEXTS)},function y(){A.unmaskForTask(z)});A.maskForTask(z)}}},{id:"addContext",text:i.create.related.search,fonticon:"list-add",handler:function(){var B=l.get("application");var D=j.is(B,"object")&&B.isStandalone;if(D){var A=l.get("component");var z=A.taskManager.addObjectsTask(function C(E){if(Array.isArray(E.physicalIds)){x._addNodes(E.physicalIds,q.RELATED_OBJECTS_TYPES.CONTEXTS)}else{}A.unmaskForTask(z)},function y(){A.unmaskForTask(z)});A.maskForTask(z,i.tasks.addObjects)}else{n.search({title:i.create.related.labels.contexts,default_search_criteria:"",multiSel:true,callback:function(E){var G=[];for(var F=0;F<E.length;F++){G.push(E[F].id)}x._addNodes(G,q.RELATED_OBJECTS_TYPES.CONTEXTS)},cancel:function(){}})}}},{id:"removeContext",text:i.create.related.remove,fonticon:"trash",handler:function(){x._removeSelectedNodes(q.RELATED_OBJECTS_TYPES.CONTEXTS)}}]});x.fields.contexts.treeListContainer=j.createElement("div",{"class":"create-form-treelist treelist-empty",id:q.RELATED_OBJECTS_TYPES.CONTEXTS});x.fields.contexts.treeListPlaceholder=j.createElement("span",{"class":"treelist-placeholder",html:i.create.related.labels.contextPlaceholder}).inject(x.fields.contexts.treeListContainer);x._addDropEvent(x.fields.contexts.treeListContainer);var v=j.clone(x.options.treelist.grid);v.id=q.RELATED_OBJECTS_TYPES.CONTEXTS;v.onDropBlank=x._onTreeListDrop.bind(x);v.onDropCell=x._onTreeListDrop.bind(x);v.onDragStartCell=x._onDragStartCell.bind(x);x.fields.contexts.treeList=new m(v);x.fields.contexts.treeList.inject(x.fields.contexts.treeListContainer)},_addNodes:function(y,x,v,w){var z=this;var A=z.fields[x].treeList;return new g(function(D,C){var E={skipped:{ids:[]},error:{ids:[]},result:{ids:[]}};var B=[];var F=j.clone(y);A.getRoots().forEach(function(H){var G=F.indexOf(H.options.id);if(G!==-1){F.splice(G,1);E.skipped.ids.push(H.options.id);B.push(H)}});B.forEach(function(G){if(v&&G.options.id in v){var I=G.options.position.balloons||[];for(var H=0;H<I.length;H++){I[H].destroy()}G.options.position=v[G.options.id]}});if(F.length){h.fetch({data:{objects:F.map(function(G){return{physicalId:G}})},onComplete:function(G){var H=G.body;A.getDocument().withTransactionUpdate(function(){if("results" in H){H.results.forEach(function(I){var L={label:null,icons:[],grid:{}};var J=b.parseFetchResponse(I);L.icons.push(J.value.typeIcon);L.id=J.value.id;L.grid["ds6w:label"]=J.display.title;L.label=J.value.title;L.title=J.value.title;L.grid["ds6w:type"]=J.display.type;L.type=J.value.type;L.grid["ds6w:identifier"]=J.display.name;L.name=J.value.name;L.grid["ds6wg:revision"]=J.display.revision;L.revision=J.value.revision;L.grid["ds6w:organizationResponsible"]=J.display.organization;L.organizationResponsible=J.value.organization;L.grid["ds6w:responsible"]=J.display.responsible;L.responsible=J.value.responsible;L.grid.owner=J.display.owner;L.owner=J.value.owner;if(L.type==="Issue"){E.error.ids.push(L.id)}else{var K=new p(L);if(v&&K.options.id in v){K.options.position=v[K.options.id]}A.addRoot(K);E.result.ids.push(L.id);if(!w&&x===q.RELATED_OBJECTS_TYPES.REPORTED_AGAINST){z.parent.dispatchEvent("related-add-reportedAgainst",{data:K.options})}}},C)}else{C(G)}});if(A.getDocument().getRoots().length){z.fields[x].treeListContainer.removeClassName("treelist-empty")}D(E)},onFailure:function(G){C(G)}})}else{D(E)}})},_addBalloon:function(v,w,y,z){var x=this;l.get("component").utils.createBalloon({id:w,position:v,path:y,color:"red",parent:x,temporary:true}).then(function(A){z.call(A)})},_removeSelectedNodes:function(w){var x=this;var v=x.fields[w].treeList.getDocument().getSelectedNodes();if(v.length){x._removeNodes(v,w)}else{t.displayNotification({msg:i.create.related.removeErrorNoSelection,eventID:"warning"})}},_removeNodes:function(v,w){var x=this;var y=x.fields[w].treeList;y.getDocument().withTransactionUpdate(function(){for(var A=v.length-1;A>=0;A--){var B=v[A];if(B.options.position&&B.options.position.balloons&&B.options.position.balloons.length){var C=B.options.position.balloons;for(var z=0;z<C.length;z++){B.options.position.balloons[z].destroy()}}y.getDocument().removeRoot(B)}});if(y.getDocument().getRoots().length===0){x.fields[w].treeListContainer.addClassName("treelist-empty")}},_addDropEvent:function(x){var w=this;var v=0;x.addEventListener("drop",w._onTreeListDrop.bind(w));x.addEventListener("dragenter",function(){x.addClassName("drag-enter");v++});x.addEventListener("dragleave",function(){v--;if(v===0){x.removeClassName("drag-enter")}});document.addEventListener("dragover",function(y){y.preventDefault()})},_onTreeListDrop:function(B,v){B.currentTarget.removeClassName("drag-enter");B.preventDefault();var A=this;var z;if(v){z=v.parent.options.id}else{z=B.currentTarget.id}var C;if(B.dataTransfer.getData("text/searchitems")!==""){C=JSON.parse(B.dataTransfer.getData("text/searchitems"))}else{if(B.dataTransfer.getData("text/plain")!==""){try{C=JSON.parse(B.dataTransfer.getData("text/plain"))}catch(x){}}}if(C){var w=C.data.items;var y=[];if(w.length>1&&z===q.RELATED_OBJECTS_TYPES.CONTEXTS){t.displayNotification({msg:i.create.related.contextMultiError,eventID:"error"});return}w.forEach(function(D){if("objectId" in D){y.push(D.objectId)}});A._addNodes(y,z)}else{t.displayNotification({msg:i.create.related.dropError,eventID:"error"})}},_onDragStartCell:function(A,B){var z=this;var y="";if(j.is(B,"object")){y=B.parent.options.id}else{y=A.currentTarget.id}var v=z.fields[y].treeList.getDocument().getSelectedNodes();if(v.length===0){return false}var w=f.setDroppableData(v);var x={type:w.type,data:JSON.stringify(w.data)};A.dataTransfer.setData(x.type,x.data);if(z._ghost){z._ghost.destroy();z._ghost=null}z._ghost=f.createGhostDrag(B.nodeModel.options,v.length);document.body.appendChild(z._ghost);A.dataTransfer.setDragImage(z._ghost,A.offsetX,A.offsetY);return true}});return r});define("DS/IssueComponents/create/Create",["UWA/Class/Events","UWA/Class/Promise","UWA/Controls/Abstract","UWA/Core","DS/UIKIT/Iconbar","DS/UIKIT/Input/Button","DS/UIKIT/Mask","DS/UIKIT/Scroller","DS/UIKIT/Toggler","DS/UIKIT/Tooltip","DS/ENOFloatingPanel/ENOFloatingPanel","DS/Logger/Logger","DS/PADUtils/views/PADAlert","DS/PlatformAPI/PlatformAPI","DS/IssueAttachmentManager/components/Collection","DS/IssueAttachmentManager/services/AttachmentServices","DS/IssueAttachmentManager/views/Catalog","i18n!DS/IssueAttachmentManager/assets/nls/IssueAttachmentManager","DS/IssueCommon/commands/CommandsManager","DS/IssueCommon/utils/Utils","DS/IssueComponents/create/Custom","DS/IssueComponents/create/Attachments","DS/IssueComponents/create/Finalize","DS/IssueComponents/create/Properties","DS/IssueComponents/create/Related","DS/IssueComponents/create/Team","DS/IssueComponents/utils/Utils","DS/IssueServices/Contexts","DS/IssueServices/services/IssueServices","DS/IssueServices/services/PlatformServices","DS/IssueServices/utils/Performance","i18n!DS/IssueComponents/assets/nls/IssueComponents","css!DS/IssueComponents/IssueComponents.css"],function(v,h,y,k,b,r,H,C,l,A,s,E,B,g,G,q,D,w,a,o,p,x,d,z,u,c,f,m,i,n,e,j){var t={MARGIN_BOTTOM:120,VIEW_MODES_ENUM:{MULTI_STEP:"multi-step",FULL_VIEW:"full-view"},VIEW_MODES_FONTICON_ENUM:{MULTI_STEP:"view-big-tile",FULL_VIEW:"view-list"},COMMON_APP_NAME:"IssueCommon",RESIZE_THROTTLE_WAIT:100,MIN_WIDTH:600,MIN_HEIGHT:600};var F=y.extend(v,{name:"DS/IssueComponents/create/Create",isLoaded:null,_deferred:{resolve:null,reject:null},_tooltips:[],_defaultViewMode:null,defaultOptions:{editMode:false,isTemplate:false,escapeToClose:true,resizable:true},overwrite:null,init:function(I,J){var K=this;K._parent(J);K.parentContainer=I;K._logger=E.getLogger(K.name);K._logger.log("Initializing the creation component");K.elements={dialog:null,header:null,body:null,footer:null};K.modeToggler={iconBar:null};K.navigator={container:null,toggler:null};K.content={container:null};K.scroller=null;K.buttons={create:null,saveAsDraft:null,cancel:null};K._tooltips=[];K.isTemplate=K.options.isTemplate;K._allViewsHaveBeenRendered=false;K._defaultViewMode=localStorage.getItem("IssueCommonCreateViewMode");K.activeMode=null;K.activeView=null;K.views={};K.views={properties:{id:"properties",label:j.create.views.properties,fonticon:"view-icon fonticon-newspaper",view:new z({parent:K}),order:2},custom:{id:"custom",label:j.create.views.moreAttributes,fonticon:"view-icon fonticon-book-add",view:new p({parent:K}),order:3},related:{id:"related",label:j.create.views.relatedObjects,fonticon:"view-icon fonticon-location",view:new u({parent:K}),order:4},team:{id:"team",label:j.create.views.team,fonticon:"view-icon fonticon-users",view:new c({parent:K}),order:5},attachments:{id:"attachments",label:j.create.views.attachments,fonticon:"view-icon fonticon-attach",view:new x({parent:K}),order:6},finalize:{id:"finalize",label:j.create.views.finalize,fonticon:"view-icon fonticon-floppy",view:new d({parent:K}),order:7}}},destroy:function(){var I=this;I._tooltips.forEach(function(J){J.destroy()});Object.keys(I.views).forEach(function(J){I.views[J].view.destroy();I.views[J]=null});I.elements={dialog:null,header:null,body:null,footer:null};I.modeToggler={iconBar:null};I.navigator={container:null,toggler:null};I.content={container:null};I.scroller.destroy();I.scroller=null;I.buttons={create:null};I._tooltips=[];I._allViewsHaveBeenRendered=false;I._defaultViewMode=null;I.activeMode=null;I.activeView=null;I.sortedViewsIds=null;I.views={};I.parentContainer=null},render:function(){var J=this;J.isLoaded=new h(function(L,K){J._deferred.resolve=L;J._deferred.reject=K});var I=Object.keys(J.views).map(function(K){var L=J.views[K];return L.view.isInit});h.all(I).then(function(){Object.keys(J.views).forEach(function(K){var L=J.views[K];if(L.view.noShow){delete J.views[K]}});J.sortedViewsIds=Object.keys(J.views);J.sortedViewsIds.sort(function(L,K){return J.views[L].order-J.views[K].order});J.footer();J.body();J.dialog(J.parentContainer)})["catch"](J._deferred.reject)},dialog:function(I){var K=this;var J=o.throttle(function(){K.onResize()},t.RESIZE_THROTTLE_WAIT);K.elements.dialog=new s({animate:true,autocenter:true,closable:true,escapeToClose:K.options.escapeToClose,limitParent:false,overlay:false,resizable:K.options.resizable,visible:true,className:"create-view-dialog",title:"",body:K.elements.body,footer:K.elements.footer,events:{onShow:function(){K.build()},onResizeFloating:function(){J()},onMove:function(){},onClose:function(){a.enableAll();K.dispatchEvent("onCreateDialogClose");K.elements.dialog.destroy();K.destroy()}}});K.updateTitle();K.elements.dialog.inject(I)},body:function(){var J=this;J.elements.body=k.createElement("div",{"class":"create-view-body multi-step"+(J.isTemplate?" template-mode":"")});J.navigator.container=k.createElement("nav",{"class":"create-view-navigator-container"}).inject(J.elements.body);var L=k.createElement("div",{"class":"ariadne-container",html:[k.createElement("div",{"class":"ariadne-rope-placeholder"}),k.createElement("div",{"class":"ariadne-rope"})]});L.inject(J.navigator.container);var I=k.createElement("nav",{"class":"create-view-navigator"}).inject(J.navigator.container);J.sortedViewsIds.forEach(function(M){var N=J.views[M];if(N.view){var O=J._navItem(N);O.container.inject(I)}});J.navigator.toggler=new l({container:I,events:{onToggle:function(M){if("id" in M){J.switchView(M.id)}}}});J.content.container=k.createElement("div",{"class":"create-view-content"}).inject(J.elements.body);J.content.scrollable=k.createElement("div",{"class":"create-view-scrollable-content"});J.scroller=new C({element:J.content.scrollable}).inject(J.content.container);J.sortedViewsIds.forEach(function(M){var N=J.views[M];if(N.view){N.view.inject(J.scroller.getInnerElement());N.view.hide()}});var K={scroll:J._onScroll.bind(J)};J.scroller.elements.content.addEvents(K)},footer:function(){var L=this;L.elements.footer=k.createElement("div",{"class":"create-view-footer"});L.modeToggler.iconBar=new b({renderTo:L.elements.footer,items:[{name:"SwitchView",fonticon:(L._defaultViewMode===t.VIEW_MODES_ENUM.FULL_VIEW)?t.VIEW_MODES_FONTICON_ENUM.MULTI_STEP:t.VIEW_MODES_FONTICON_ENUM.FULL_VIEW,text:(L._defaultViewMode===t.VIEW_MODES_ENUM.FULL_VIEW)?j.create.modeToggler.tooltipMultiStep:j.create.modeToggler.tooltipFullView,handler:function(){var N=L.modeToggler.iconBar.getItem("SwitchView").elements.icon,O=L.modeToggler.iconBar.getItem("SwitchView").tooltip;if(N.hasClassName("fonticon-"+t.VIEW_MODES_FONTICON_ENUM.MULTI_STEP)===true){N.removeClassName("fonticon-"+t.VIEW_MODES_FONTICON_ENUM.MULTI_STEP);N.addClassName("fonticon-"+t.VIEW_MODES_FONTICON_ENUM.FULL_VIEW);O.setBody(j.create.modeToggler.tooltipFullView);L.switchViewMode(t.VIEW_MODES_ENUM.MULTI_STEP)}else{N.removeClassName("fonticon-"+t.VIEW_MODES_FONTICON_ENUM.FULL_VIEW);N.addClassName("fonticon-"+t.VIEW_MODES_FONTICON_ENUM.MULTI_STEP);O.setBody(j.create.modeToggler.tooltipMultiStep);L.switchViewMode(t.VIEW_MODES_ENUM.FULL_VIEW)}}}]});var I=k.createElement("div",{"class":"create-view-footer-btn-container"}).inject(L.elements.footer);var K=L.buttons.create=new r({value:L.isTemplate?j.create.saveButton:j.create.sendButton,id:"create-view-footer-create-btn",className:"primary"}).inject(I);K.addEvent("onClick",function(){L._create()});if(!L.isTemplate){var J=L.buttons.saveAsDraft=new r({value:j.create.saveAsDraftButton,id:"create-view-footer-save-as-draft-btn",className:"default"}).inject(I);J.addEvent("onClick",function(){L._create(true)})}var M=L.buttons.cancel=new r({value:j.create.cancelButton,id:"create-view-footer-cancel-btn",className:"default"}).inject(I);M.addEvent("onClick",function(){L.cancel()})},build:function(){var I=this;if(!I._allViewsHaveBeenRendered){Object.keys(I.views).forEach(function(J){var L=I.views[J];if(L.view){L.view.render();if(I.isTemplate){if(k.is(L.view.formElements,"object")&&k.is(L.view.formElementsToggler,"object")){var M=L.view.formElements;var N=L.view.formElementsToggler;var O=function(P){return function(){if(k.is(M[P])){M[P].toggleClassName("visibility-masked")}if(k.is(N[P])){N[P].toggleClassName("fonticon-eye");N[P].toggleClassName("fonticon-eye-off")}}};for(var K in M){if(k.is(N[K])){N[K].addEventListener("click",O(K))}}}}}});I.switchViewMode(I._defaultViewMode?I._defaultViewMode:t.VIEW_MODES_ENUM.MULTI_STEP);I.switchView(I.sortedViewsIds[0]);I._allViewsHaveBeenRendered=true;I._deferred.resolve();a.disableAll()}},onResize:function(){var L=this;var K=L.elements.dialog.elements.container.getSize();var J=K.width<t.MIN_WIDTH;var I=K.height<t.MIN_HEIGHT;L.elements.dialog.elements.container.toggleClassName("responsive-width-phone",J);L.elements.dialog.elements.container.toggleClassName("responsive-height-phone",I)},updateTitle:function(K){var J=this;var I=J.options.editMode?j.create.titleActionEdit:j.create.titleActionCreate;I+=" ";I+=J.isTemplate?j.create.titleTemplate:j.create.title;if(K&&K.length){I+=": "+K}J.elements.dialog.setTitle(I)},_navItem:function(I){var K=this;var J={};J.container=k.createElement("a",{id:I.id,"class":"nav-item"});J.container.addEventListener("click",function(){if(K.activeMode===t.VIEW_MODES_ENUM.FULL_VIEW&&K.activeView===I.id){K._highlightElement(I.view.container)}});J.container.addEventListener("dragover",function(){K.switchView(I.id)});J.activeIndicator=k.createElement("div",{"class":"nav-item-active-indicator"}).inject(J.container);k.createElement("span",{"class":"fonticon fonticon-expand-down"}).inject(J.activeIndicator);J.circle=k.createElement("div",{"class":"nav-item-circle"}).inject(J.container);k.createElement("span",{"class":"fonticon "+I.fonticon}).inject(J.circle);J.label=k.createElement("div",{"class":"nav-item-label",html:I.label}).inject(J.container);return J},switchViewMode:function(K){var J=this;if(J.elements.body){if(K===t.VIEW_MODES_ENUM.MULTI_STEP){J.elements.body.addClassName("multi-step");Object.keys(J.views).forEach(function(L){if(L!==J.activeView&&"view" in J.views[L]){J.views[L].view.hide()}})}else{J.elements.body.removeClassName("multi-step");Object.keys(J.views).forEach(function(L){if("view" in J.views[L]){J.views[L].view.show()}});if(J.activeView in J.views&&"view" in J.views[J.activeView]){var I=J.views[J.activeView].view.container;J.scroller.scrollToElement(I);J._highlightElement(I)}}}J.activeMode=K;localStorage.setItem("IssueCommonCreateViewMode",K)},switchView:function(I){var M=this;if(M.navigator&&M.navigator.container&&M.activeView){var K=M.navigator.container.getElements("a");var L=false;K.forEach(function(O){if(L===false){O.removeClassName("filled").addClassName("filled")}else{O.removeClassName("filled")}if(O.id===M.activeView){O.removeClassName("active")}if(O.id===I){O.addClassName("active");var Q=O.getElement(".view-icon.fonticon");if(M.elements.body.hasClassName("multi-step")){var N=Q.getPosition().x/M.navigator.container.getSize().width*100;N+=10;M.navigator.container.getElement(".ariadne-rope").setStyles({width:N+"%",height:"2px"})}else{var P=Q.getPosition().y/M.navigator.container.getSize().height*100;M.navigator.container.getElement(".ariadne-rope").setStyles({width:"2px",height:P+"%"})}L=true}})}if(M.activeMode===t.VIEW_MODES_ENUM.MULTI_STEP){if(M.activeView in M.views&&"view" in M.views[M.activeView]){M.views[M.activeView].view.hide()}if(I in M.views&&"view" in M.views[I]){M.views[I].view.show()}}else{if(I in M.views&&"view" in M.views[I]&&M.scroller){var J=M.views[I].view.container;M.scroller.scrollToElement(J);M._highlightElement(J)}}M.activeView=I},applyTemplate:function(N,K){var O=this;if(K&&K.overwrite===true){O.overwrite=N}H.mask(O.elements.dialog.getBody());for(var M in O.buttons){if(O.buttons.hasOwnProperty(M)&&O.buttons[M]){O.buttons[M].disable()}}var J=Object.keys(O.views);var L=[];J.forEach(function(P){var Q=O.views[P];if("applyTemplate" in Q.view){L.push(Q.view.applyTemplate(N))}});if(!O.options.editMode&&!O.isTemplate){var I=O.templates.getTemplates().then(function(R){var P=new Date();for(var Q=0;Q<R.length;Q++){if(N.id&&N.id===R[Q].id){R[Q].info.lastUsed=P.getTime()}}return O.templates.setTemplates(R)});L.push(I)}return h.all(L).then(function(Q){H.unmask(O.elements.dialog.getBody());for(var P in O.buttons){if(O.buttons.hasOwnProperty(P)&&O.buttons[P]){O.buttons[P].enable()}}return Q})},applyIssue:function(I){var K=this;var L=m.get("widget");var J={};return i.issues.retrieve({data:{objects:[{physicalId:I.id}]}}).then(function(M){var N=M[0].body;J={id:"template-"+L.id+"-"+Date.now(),info:{description:null,name:null},ui:{assignees:N.assignees.reduce(function(P,O){P[O.user]={fullName:O.fullName,user:O.user};return P},{}),responsibleOrganization:N.responsibleOrganization},data:{assignees:N.assignees,automationTasks:[],contexts:N.contexts,custom:N.custom,description:N.description||"",priority:N.priority||"Low",reportedAgainst:N.reportedAgainst,resolutionDate:N.resolutionDate,resolutionRecommendation:N.resolutionRecommendation||"",responsibleOrganization:N.responsibleOrganization,title:N.title||""},hidden:{}};return q.getDocumentsFrom(I.id)}).then(function(M){if(Array.isArray(M.attachments)){J.data.attachments=M.attachments.map(function(N){return N.id})}return q.getPrimary(I.id)}).then(function(M){var N=JSON.parse(M);if(k.is(N.documentId,"string")&&N.documentId!==""){J.data.primaryAttachment=N.documentId}return K.applyTemplate(J).then(function O(){B.displayNotification({msg:j.replace(j.create.issueApplySuccess,{title:I["ds6w:label"],name:I["ds6w:identifier"]}),eventID:"info"})})})["catch"](function(M){B.displayNotification({msg:j.replace(j.create.issueApplyError,{title:I["ds6w:label"],name:I["ds6w:identifier"]}),eventID:"error"});K._logger.error(M)})},cancel:function(){var I=this;I.elements.dialog.options.events.onClose()},getDialog:function(){var I=this;return I.elements.dialog},_onScroll:function(){var I=this;setTimeout(function(){if(I.activeMode===t.VIEW_MODES_ENUM.FULL_VIEW){var J=I.scroller._infos.y.scrollPosition;Object.keys(I.views).forEach(function(K){var M=I.views[K];if(M.view&&M.view.container){var L=M.view.container;if(J>=L.offsetTop&&J<L.offsetTop+L.offsetHeight){I.navigator.container.getElement("a#"+K).addClassName("active");I.activeView=K}else{I.navigator.container.getElement("a#"+K).removeClassName("active")}}})}},0)},_highlightElement:function(I){I.addClassName("highlight");I.addEventListener("animationend",function(){if(I){I.removeClassName("highlight")}})},_create:function(K){var N=this;var O=m.get("widget");var J=true;H.mask(O.body);for(var L in N.buttons){if(N.buttons.hasOwnProperty(L)&&N.buttons[L]){N.buttons[L].disable()}}var I=N.elements.dialog.rightButtons.getElement(".fonticon-cancel");I.addClassName("disabled");var P;if(N.isTemplate){P=N._validate().then(function(){return N._connectAttachments()}).then(function(){return N._saveAsTemplate().then(function(){N._publishTemplateCreateEvent()})})["catch"](function(){J=false})}else{P=N._validate().then(function(){return N._createRequest(K)}).then(function(R){var Q=R.physicalId;N._publishEvent(Q,"DS/Object/create");return h.resolve(Q)}).then(function(Q){return new h(function(S,R){N._connectAttachments(Q).then(function(){S(Q)})["catch"](R)})}).then(function(Q){var R=[];R.push(N._execAutomationTasks(Q));return h.all(R)});P["catch"](function(){J=false})}return P["catch"](function M(Q){N._logger.error(Q);return h.reject(Q)})["finally"](function(){H.unmask(O.body);for(var R in N.buttons){if(N.buttons.hasOwnProperty(R)&&N.buttons[R]!==null){N.buttons[R].enable()}}var Q=N.elements.dialog.rightButtons.getElement(".fonticon-cancel");Q.removeClassName("disabled");if(J){N.elements.dialog.options.events.onClose()}})},_createRequest:function(J){var K=this;var I=Object.keys(K.views);var L={};I.forEach(function(M){var N=K.views[M];if("getValues" in N.view){k.merge(L,N.view.getValues())}});if(k.is(L.description,"string")){L.description=f.getTextFromHTML(L.description);if(L.description.match(/.*\n$/)){L.description=L.description.replace(/\n+$/,"")}}if(J!==true){L.state="Assign"}else{L.state="Create"}return i.issues.create({data:L}).then(function(M){B.displayNotification({msg:j.create.creationSuccess,eventID:"success"});return M.body})["catch"](function(M){B.displayNotification({msg:j.create.creationFailed,eventID:"error"});K._logger.error(M)})},_validate:function(){var J=this;var I=Object.keys(J.views);return new h(function(L,K){var M=I.every(function(N){var O=J.views[N];var P=true;if("validate" in O.view){P=O.view.validate()}return P});if(M){L()}else{B.displayNotification({msg:j.create.validationFailed,eventID:"error"});K(new Error("invalid fields"))}})},_connectAttachments:function(I){var R=this;var N=m.get("widget");if("attachments" in R.views&&"collection" in R.views.attachments.view){var O=R.views.attachments.view.collection;var P=R.views.attachments.view.catalog;var S=function(Y){this.set("isCancelable",true);this.set("request",Y)};var T=function(Z){if(Z.lengthComputable){var Y=Z.loaded/Z.total;this.set("requestProgress",Y)}};var V=function(){this.set("isCancelable",false);this.set("request",null)};var Q=O.filter(function(Y){return Y.get("isFile")===true}).map(function(Y){var Z=Y.clone();Z.set("isProcessing",true);return Z});var J=[];if(Q.length>0){var X=new G({id:I||"template",attachments:Q});R.views.attachments.view.uploadCollection=X;var L=new D({collection:X,layout:2}).render();var U=new s({animate:true,autocenter:true,closable:true,limitParent:false,overlay:false,resizable:true,visible:true,className:"create-view-file-upload-dialog",title:j.replace(j.create.attachments.uploadDialog.title,{number:X.size()}),header:null,body:L,events:{onClose:function(){U.destroy()}}}).inject(N.body);var W=0;J=Q.map(function(Y){var Z=h.resolve();if(I!==null&&I!==undefined){Z=q.uploadFile(Y.get("file"),I,{onCheckinStart:S.bind(Y),onCheckinProgress:T.bind(Y),onCheckinComplete:V.bind(Y)})}else{Z=q.uploadFile(Y.get("file"),null,{onCheckinStart:S.bind(Y),onCheckinProgress:T.bind(Y),onCheckinComplete:V.bind(Y)})}Z=Z.then(function(aa){if(aa&&aa.data&&aa.data.length>0&&aa.data[0].id){var ab=O.get(Y.id);ab.set("id",aa.data[0].id);ab.set("isFile",false);P.attachments[aa.data[0].id]=P.attachments[Y.id];P.attachments[aa.data[0].id].id=ab.get("id");P.attachments[aa.data[0].id].container.id=ab.get("id");P.attachments[aa.data[0].id].container.setAttribute("id","attachment-"+ab.get("id"));P.attachments[aa.data[0].id].container.setData("id",ab.get("id"));delete P.attachments[Y.id];Y.set("id",aa.data[0].id);Y.set("isFile",false);Y.set("isProcessing",false);W++}})["catch"](function(aa){Y.set("isFailed",true);Y.set("isProcessing",false);Y.set("isCancelable",false);Y.set("request",null);if(aa instanceof Error){B.displayNotification({msg:w.replace(w.notifications.Upload.failure,{count:1}),eventID:"error"});R._logger.error(aa)}});return Z});h.all(J)["finally"](function(){U.setTitle(j.replace(j.create.attachments.uploadDialog.uploadCompleted,{success:W,total:J.length,}))})}var K=O.filter(function(Y){return Y.get("isFile")!==true}).map(function(Y){return Y.clone()});var M=[];if(K.length>0){M=K.map(function(Y){if(I!==null&&I!==undefined){return q.connectDocumentToParent(Y.id,I)["catch"](function(Z){B.displayNotification({msg:w.notifications.Attach.failure,eventID:"error",count:1});R._logger.error(Z)})}else{return h.resolve()}})}return h.all(J.concat(M)).then(function(){if(!R.isTemplate){var Z=O.filter(function(aa){return aa.get("isPrimary")===true});if(Z.length===1){var Y=Z[0];return q.setAsPrimary(Y.get("id"),I,true).then(function(){B.displayNotification({msg:w.notifications.SetAsPrimary.success,eventID:"info"})})["catch"](function(aa){B.displayNotification({msg:w.notifications.SetAsPrimary.failure,eventID:"error"});R._logger.error(aa)})}}return h.resolve()})}else{return h.resolve()}},_execAutomationTasks:function(){var J=this;var K=h.resolve();if("finalize" in J.views&&"getTasks" in J.views.finalize.view){var L=J.views.finalize.view.getTasks();var I=[];if(L.indexOf("saveAsTemplate")!==-1){I.push(J._saveAsTemplate())}K=h.all(I)}else{K=h.resolve()}return K},_saveAsTemplate:function(){var L=this;var P=m.get("widget");var I=Object.keys(L.views);var O={},N={},M={};I.forEach(function(Q){var R=L.views[Q];if("getValues" in R.view){k.merge(O,R.view.getValues(true))}if("getUIValues" in R.view){k.merge(N,R.view.getUIValues(true))}if("getHiddenAttributes" in R.view){k.merge(M,R.view.getHiddenAttributes(true))}});O.automationTasks=L.views.finalize.view.getTasks();var J=L.views.finalize.view.getTemplateValues();J.version=m.version;var K={id:"template-"+P.id+"-"+Date.now(),info:J,data:O,ui:N,hidden:M};if(k.is(L.overwrite,"object")===true){K.id=L.overwrite.id;K.info.lastUsed=L.overwrite.info.lastUsed;if(L.templates.isShared(L.overwrite)===true){K.info.share=L.overwrite.info.share}}return L.templates.getTemplates().then(function(R){var Q=-1,S=R.some(function(U,T){if(U.id===K.id){Q=T;return true}return false});if(S===true){if(L.templates.isShared(K)===true){return L.templates.updateSharedTemplate(K).then(function(T){R.splice(Q,1,T);return R})}else{R.splice(Q,1,K)}}else{R.push(K)}return R}).then(function(Q){return L.templates.setTemplates(Q).then(function(){var R=j.create.creationTemplateSuccess;if(k.is(L.overwrite,"object")===true){R=j.create.updateTemplateSuccess}B.displayNotification({msg:R,eventID:"success"})})})},_publishEvent:function(O,K){var M=m.get("widget");var N=[],J={};N.push([O]);J[O]={};var I=Math.floor(Date.now());var L={metadata:{appId:M.id,appName:t.COMMON_APP_NAME,timestamp:I,options:{}},data:{paths:N,attributes:J},version:"1.0"};g.publish(K,L)},_publishTemplateCreateEvent:function(){var I=this;I.dispatchEvent("onTemplateCreate")},templates:{getTemplates:function(){return new h(function(J,I){require(["DS/IssueComponents/templates/Templates"],function(L){var K=new L(m.get("widget"),{editMode:true,onClose:function(){},onEnd:function(){}});K.getTemplates().then(function(M){J(M)},function(M){I(M)})["finally"](function(){K.destroy();K=null})})})},setTemplates:function(I){return new h(function(K,J){require(["DS/IssueComponents/templates/Templates"],function(M){var L=new M(m.get("widget"),{editMode:true,onClose:function(){},onEnd:function(){}});L.setTemplates(I).then(K,J)["finally"](function(){L.destroy();L=null})})})},updateSharedTemplate:function(I){return new h(function(K,J){require(["DS/IssueComponents/templates/Templates"],function(M){var L=new M(m.get("widget"),{editMode:true,onClose:function(){},onEnd:function(){}});L.updateSharedTemplate(I).then(function(N){K(N)},function(N){J(N)})["finally"](function(){L.destroy();L=null})})})},isShared:function(I){return k.is(I.info.share,"object")===true}}});return F});define("DS/IssueComponents/templates/Templates",["UWA/Class/Promise","UWA/Class/View","UWA/Core","DS/UIKIT/Iconbar","DS/UIKIT/Input/Button","DS/UIKIT/Mask","DS/UIKIT/Popover","DS/UIKIT/Scroller","DS/UIKIT/Input/Text","DS/UIKIT/Toggler","DS/UIKIT/Tooltip","DS/Core/PointerEvents","DS/DocumentManagement/DocumentManagement","DS/ENOFloatingPanel/ENOFloatingPanel","DS/Logger/Logger","DS/PADUtils/views/PADAlert","DS/PlatformAPI/PlatformAPI","DS/Tree/TreeListView","DS/TreeModel/TreeNodeModel","DS/IssueCommon/commands/CommandsManager","DS/IssueCommon/utils/Utils","DS/IssueComponents/create/Create","DS/IssueComponents/users/Users","DS/IssueServices/Contexts","DS/IssueServices/services/IssueServices","DS/IssueServices/services/PlatformServices","DS/IssueServices/utils/Parser","DS/IssueServices/utils/Performance","i18n!DS/IssueComponents/assets/nls/IssueComponents","css!DS/IssueComponents/IssueComponents.css"],function(g,u,k,c,q,E,z,B,v,l,w,m,y,s,C,A,f,o,r,b,e,D,x,n,h,p,a,d,j){var t={LOW_PRIORITY:"Low",MEDIUM_PRIORITY:"Medium",HIGH_PRIORITY:"High",URGENT_PRIORITY:"Urgent",TEMPLATES_PREFERENCE:"ISU_TEMPLATES",FIRST_DOCUMENT:0,MAXIMUM_TEMPLATES_PREVIEW:4,SHARED_TEMPLATE_URL_PREFIX:"#dashboard:/tab:/app:ENXISSU_AP/content:XTemplateContentId=",TIMEOUT_SHARE_POPOVER:100};var i=u.extend({name:"DS/IssueComponents/templates/Templates",_logger:null,isLoaded:null,_deferred:{resolve:null,reject:null},_isRendered:false,defaultOptions:{editMode:false,treeList:{grid:{allowUnsafeHTMLContent:true,selection:{toggle:false,unselectAllOnEmptyArea:true,canMultiSelect:true,enableListSelection:true},height:"100%",apiVersion:2,defaultCellHeight:26,useTransparentScroller:false,useNativeScroller:false,useAsyncPreExpand:true,resize:{columns:true,rows:true},columns:[{text:k.createElement("div",{"class":"template-shared-header-container",html:k.createElement("span",{"class":"fonticon fonticon-share-alt"})}),dataIndex:"shared",width:50,isDraggable:false,resizable:false},{text:j.templates.treeList.tree,dataIndex:"tree",width:270,isDraggable:false},{text:j.templates.treeList.description,width:"auto",dataIndex:"description",isDraggable:false},{text:j.templates.treeList.owner,width:60,dataIndex:"owner",isDraggable:false,resizable:false}]}}},init:function(F,G){var H=this;H._parent(G);H.container=F;H._logger=C.getLogger(H.name);H._logger.log("Initializing the templates component");H.elements={dialog:null,header:null,body:null,footer:null};H.templateList={container:null,title:null,treeListContainer:null,treeList:null,iconBarContainer:null,iconBar:null};H.templateLastUsed={container:null,header:null,previews:{container:null,templates:{}}};H.buttons={cancel:null,select:null};H._tooltips=[];H.user=p.getUserName();H.popover=null;H.onClose=G.onClose.bind(H);H.onEnd=G.onEnd.bind(H)},destroy:function(){var F=this;F._tooltips.forEach(function(G){G.destroy()});F._tooltips=[];F.elements={dialog:null,header:null,body:null,footer:null};F.templateList={container:null,title:null,treeListContainer:null,treeList:null,iconBarContainer:null,iconBar:null};F.templateLastUsed={container:null,header:null,previews:{container:null,templates:{}}};F.buttons={cancel:null,select:null};F.user="";F._destroyPopover()},render:function(){var F=this;F.isLoaded=new g(function(H,G){F._deferred.resolve=H;F._deferred.reject=G});F.setBody();F.setFooter();F.dialog(F.container)},dialog:function(F){var G=this;G.elements.dialog=new s({animate:true,autocenter:true,closable:true,limitParent:false,overlay:false,resizable:true,visible:true,className:"create-template-chooser-dialog",title:G.options.editMode?j.templates.titleEdit:j.templates.title,header:null,body:G.elements.body,footer:G.elements.footer,events:{onShow:function(){G.build()},onResizeFloating:function(){},onMove:function(){},onClose:function(){b.enableAll();G.elements.dialog.destroy();G.onClose();G.destroy()}}});G.elements.dialog.inject(F)},setBody:function(){var H=this;H.elements.body=k.createElement("div",{"class":"create-template-chooser-body hide-last-used"});if(H.options.editMode===true){H.elements.body.addClassName("edit-mode")}H.templateLastUsed.container=k.createElement("div",{"class":"create-template-chooser-last-used"}).inject(H.elements.body);H.templateLastUsed.header=k.createElement("div",{"class":"h5 create-template-chooser-last-used-header",html:j.templates.lastUsed.title}).inject(H.templateLastUsed.container);H.templateLastUsed.previews.container=k.createElement("div",{"class":"create-template-chooser-last-used-previews-container"}).inject(H.templateLastUsed.container);H.templateList.container=k.createElement("div",{"class":"create-template-chooser-list"}).inject(H.elements.body);H.templateList.iconBarContainer=k.createElement("div",{"class":"create-template-chooser-list-iconbar"}).inject(H.templateList.container);H.templateList.title=k.createElement("div",{"class":"h5 create-template-chooser-list-title",html:j.templates.iconBar.title}).inject(H.templateList.iconBarContainer);if(H.options.editMode===true){H.templateList.iconBar=new c({renderTo:H.templateList.iconBarContainer,items:[{id:"create",text:j.templates.iconBar.create,fonticon:"plus",handler:function(){H.elements.dialog.hide();var I=new D(H.container,{isTemplate:true});I.render();H._listenToCreateEvents(I)}},{id:"fromIssue",text:j.templates.iconBar.fromIssue,fonticon:"import",handler:function(){var L=n.get("application");var N=k.is(L,"object")&&L.isStandalone;if(N){var K=n.get("component");var J=K.taskManager.addObjectsTask(function M(O){if(Array.isArray(O.physicalIds)){H.elements.dialog.hide();var P=new D(H.container,{isTemplate:true});P.render();P.isLoaded.then(function(){var Q={id:O.physicalIds[O.physicalIds.length-1],};P.applyIssue(Q)})["finally"](function(){H._listenToCreateEvents(P)})}else{}K.unmaskForTask(J)},function I(){K.unmaskForTask(J)});K.maskForTask(J,j.tasks.addObjects)}else{p.search({title:j.create.start.actionPage.issue.fromIssue,default_search_criteria:"",precond:'(flattenedtaxonomies:"types/Issue")',multiSel:false,callback:function(O){H.elements.dialog.hide();var P=new D(H.container,{isTemplate:true});P.render();P.isLoaded.then(function(){P.applyIssue(O[O.length-1])})["finally"](function(){H._listenToCreateEvents(P)})},cancel:function(){}})}}},{id:"clone",text:j.templates.iconBar.clone,fonticon:"duplicate",handler:function(){var K=H.templateList.treeList.getDocument().getSelectedNodes();if(K.length!==1){return}var J=K[K.length-1].options.data;H.elements.dialog.hide();J.info.name=j.replace(j.templates.clonePrefix,{name:J.info.name});var I=new D(H.container,{isTemplate:true});I.render();I.isLoaded.then(function(){return I.applyTemplate(J,{overwrite:false})["catch"](function(L){H._logger.error('Could not apply template "%s"',L);A.displayNotification({msg:j.replace(j.create.templateApplyError,{name:J.info.name}),eventID:"error"})})})["finally"](function(){H._listenToCreateEvents(I)})}},{id:"edit",text:j.templates.iconBar.edit,fonticon:"pencil",handler:function(){var K=H.templateList.treeList.getDocument().getSelectedNodes();if(K.length!==1){return}var J=K[K.length-1].options.data;H.elements.dialog.hide();var I=new D(H.container,{editMode:true,isTemplate:true});I.render();I.isLoaded.then(function(){return I.applyTemplate(J,{overwrite:true})["catch"](function(L){H._logger.error('Could not apply template "%s"',L);A.displayNotification({msg:j.replace(j.create.templateApplyError,{name:J.info.name}),eventID:"error"})})})["finally"](function(){H._listenToCreateEvents(I)})}},{id:"delete",text:j.templates.iconBar["delete"],fonticon:"trash",handler:function(){var M=H.templateList.treeList.getDocument().getSelectedNodes();var I=M.some(function(N){return H.utils.isShared(N.options.data)});var L=M.some(function(N){return H.utils.isOwnedBy(N.options.data,H.user)});var K=new s({animate:true,autocenter:true,closable:true,limitParent:false,overlay:true,resizable:true,visible:true,className:"confirm-delete-template-dialog",title:j.replace(j.templates.confirmDelete.title,{number:M.length}),header:null,body:(I===true&&L===true)?[j.templates.confirmDelete.text,k.createElement("div",{"class":"warning-delete-shared-template",html:j.templates.confirmDelete.sharedWarning})]:[j.templates.confirmDelete.text,k.createElement("div",{"class":"info-delete-shared-template",html:j.templates.confirmDelete.sharedInfo})],footer:[new q({value:j.templates.confirmDelete.okButton,className:"primary",id:"delete-template-confirm-ok-button",events:{onClick:function(){K.destroy();H.removeTemplates(M).then(function(){return H.refresh()})["catch"](function(){A.displayNotification({msg:j.templates.errors.remove,eventID:"error"})})}}}),new q({value:j.templates.confirmDelete.cancelButton,className:"default",id:"delete-template-confirm-cancel-button",events:{onClick:function(){K.destroy()}}})],events:{onClose:function(){K.destroy()}}});var J=n.get("widget");K.inject(J.body)}},{id:"share",text:j.templates.iconBar.share,fonticon:"share-alt",handler:function(){E.mask(H.elements.dialog.getBody());var K=H.templateList.treeList.getDocument().getSelectedNodes();if(K.length!==1){return}var I=K[K.length-1],J=I.options.data;H.share(J).then(function(M){I.options.data.id=M.id;I.options.data.info.share=M.info.share;I.updateOptions({isShared:true,grid:{shared:H.utils.getSharedImage().outerHTML}});var L=H.templateList.container.getElement(".wux-datagrid-cell.wux-layouts-treeview-cell.wux-datagrid-row-highlighted.wux-datagrid-cell-highlighted");L.dispatchEvent(new MouseEvent("click"));E.unmask(H.elements.dialog.getBody())})}}]});H.templateList.iconBar.getItem("edit").elements.container.addClassName("disabled");H.templateList.iconBar.getItem("clone").elements.container.addClassName("disabled");H.templateList.iconBar.getItem("delete").elements.container.addClassName("disabled");H.templateList.iconBar.getItem("share").elements.container.addClassName("disabled")}H.templateList.treeListContainer=k.createElement("div",{"class":"create-template-chooser-list-tree-list tree-list-empty"}).inject(H.templateList.container);H.templateList.treeListPlaceholder=k.createElement("span",{"class":"tree-list-placeholder",html:{tag:"span","class":"fonticon fonticon-5x fonticon-newspaper"}}).inject(H.templateList.treeListContainer);var G=k.clone(H.options.treeList.grid);G.id="templates";G.onDropBlank=function(){return false};G.onDropCell=function(){return false};G.onDragStartCell=function(){return false};G.shouldDisplayTooltip=function(I){var K="";if(I.isHeader){switch(I.dataIndex){case"shared":K=j.templates.treeList.shared;break;default:if(typeof I.cellModel.options.value==="string"){K=I.cellModel.options.value}break}}else{switch(I.dataIndex){case"tree":K=I.nodeModel.options.label;break;case"shared":var J=I.cellModel.options.value;if(typeof J==="string"&&J!==""){K=j.templates.treeList.isShared}else{K=j.templates.treeList.isNotShared}break;case"owner":K=I.nodeModel.options.owner;break;default:if(typeof I.cellModel.options.value==="string"){K=I.cellModel.options.value}break}}return{longHelp:K}};H.templateList.treeList=new o(G);H.templateList.treeList.inject(H.templateList.treeListContainer);H.templateList.treeList.onNodeClick(function(N){if(N.dataIndex==="shared"&&N.nodeModel&&N.nodeModel.options&&N.nodeModel.options.isShared===true){H._destroyPopover();var M=N.nodeModel.options.data;var K=p.get3DDashboardUrl()+t.SHARED_TEMPLATE_URL_PREFIX+encodeURIComponent('{"template":{"document":"'+M.info.share.document+'","file":"'+M.info.share.file+'"}}');var J=new v({className:"template-url-share",value:K}),L=new q({className:"default template-button-share",icon:"clipboard-add",attributes:{title:j.templates.shared.popover.copy},events:{onClick:function(){e.copyTextToClipboard(K);A.displayNotification({msg:j.templates.notifications.sharedTemplateURL,eventID:"info"})}}});new w({position:"right",target:L.getContent()});J.elements.input.setAttribute("readonly",true);J.elements.container.addEventListener("click",function(){J.elements.input.select()});var I=k.createElement("div",{"class":"template-body-share",html:[J,L]});H.popover=new z({target:N.cellView.elements.container,position:"top",body:I,title:j.templates.shared.popover.title,events:{onHide:function(){H._destroyPopover()}}});setTimeout(function(){H.popover.show()},t.TIMEOUT_SHARE_POPOVER)}else{if(N.dataIndex==="owner"){p.getUserProfile(N.nodeModel.options.user)}}});var F=H.templateList.treeList.getDocument().getXSO();F.onEmpty(function(){H._destroyPopover();if(H.buttons.select!==null){H.buttons.select.disable()}if(H.templateList.iconBar!==null){H.templateList.iconBar.getItem("edit").elements.container.addClassName("disabled");H.templateList.iconBar.getItem("clone").elements.container.addClassName("disabled");H.templateList.iconBar.getItem("delete").elements.container.addClassName("disabled");H.templateList.iconBar.getItem("share").elements.container.addClassName("disabled")}var J=Object.keys(H.templateLastUsed.previews.templates);for(var I=0;I<J.length;I++){H.templateLastUsed.previews.templates[J[I]].removeClassName("active")}});F.onChange(function(){H._destroyPopover();var N=H.templateList.treeList.getDocument().getSelectedNodes();if(N.length===1){if(H.buttons.select!==null){H.buttons.select.enable()}if(H.templateList.iconBar!==null){var K=N[N.length-1];if(H.utils.isShared(K.options.data)&&!H.utils.isOwnedBy(K.options.data,H.user)){H.templateList.iconBar.getItem("edit").elements.container.addClassName("disabled")}else{H.templateList.iconBar.getItem("edit").elements.container.removeClassName("disabled")}H.templateList.iconBar.getItem("clone").elements.container.removeClassName("disabled");H.templateList.iconBar.getItem("share").elements.container.removeClassName("disabled")}}else{if(H.buttons.select!==null){H.buttons.select.disable()}if(H.templateList.iconBar!==null){H.templateList.iconBar.getItem("edit").elements.container.addClassName("disabled");H.templateList.iconBar.getItem("clone").elements.container.addClassName("disabled");H.templateList.iconBar.getItem("share").elements.container.addClassName("disabled")}}if(H.templateList.iconBar!==null){if(H.templateList.treeList.getDocument().getSelectedNodes().length>0){H.templateList.iconBar.getItem("delete").elements.container.removeClassName("disabled")}else{H.templateList.iconBar.getItem("delete").elements.container.addClassName("disabled")}}var M=Object.keys(H.templateLastUsed.previews.templates);var J=H.templateList.treeList.getDocument().getSelectedNodes().reduce(function(P,O){P.push(O.options.id);return P},[]);for(var I=0;I<M.length;I++){var L=H.templateLastUsed.previews.templates[M[I]];if(J.indexOf(L.id)>-1){L.addClassName("active")}else{L.removeClassName("active")}}});H.templateLastUsed.container.addEventListener("click",function(){H.templateList.treeList.getDocument().unselectAll();var J=Object.keys(H.templateLastUsed.previews.templates);for(var I=0;I<J.length;I++){H.templateLastUsed.previews.templates[J[I]].removeClassName("active")}});H.templateList.treeList.getManager().onNodeDblClick(function(){if(H.options.editMode===false){H.onEndCallback()}})},setFooter:function(){var G=this;G.elements.footer=k.createElement("div",{"class":"create-template-chooser-footer"});var F=k.createElement("div",{"class":"create-template-chooser-footer-btn-container"}).inject(G.elements.footer);if(G.options.editMode===false){var I=G.buttons.select=new q({value:j.templates.selectButton,id:"create-template-chooser-footer-select-btn",className:"primary"}).inject(F);I.disable();I.addEvent("onClick",function(){G.onEndCallback()})}var H=G.buttons.cancel=new q({value:G.options.editMode?j.templates.closeButton:j.templates.cancelButton,id:"create-template-chooser-footer-cancel-btn",className:"default"}).inject(F);H.addEvent("onClick",function(){G.elements.dialog.options.events.onClose()})},build:function(){var F=this;if(F._isRendered===false){F.refresh().then(function(){F._isRendered=true;F._deferred.resolve();b.disableAll()})["catch"](function(G){F._deferred.reject(G)})}},refresh:function(){var F=this;E.mask(F.elements.dialog.getContent());return F.getAndFetchTemplates().then(function(I){F.templateList.treeList.getDocument().empty();F.templateLastUsed.previews.container.empty();F.templateLastUsed.previews.templates={};if(I.length>0){F.templateList.treeList.getDocument().withTransactionUpdate(function(){I.forEach(function(O){var N=F.utils.isShared(O);var L="",M="",S="";if(N===true){M=M=O.info.share.owner.user;S=O.info.share.owner.fullName;L=x.create({users:[M]}).addClassName("template-owner-container").outerHTML}else{M=F.user;S=p.getFullName();L=x.create({users:[M]}).addClassName("template-owner-container").outerHTML}var Q="";Q=N===true?F.utils.getSharedImage().outerHTML:"";var R={id:O.id,label:O.info.name,description:O.info.description,owner:S+" ("+M+")",user:M,isShared:N,grid:{label:e.getTextFromHTML(O.info.name),description:e.getTextFromHTML(O.info.description),owner:L,shared:Q},data:O};var P=new r(R);F.templateList.treeList.addRoot(P)})});if(F.templateList.treeList.getDocument().getRoots().length){F.templateList.treeListContainer.removeClassName("tree-list-empty")}var G=I.filter(function(L){return Number.isInteger(L.info.lastUsed)});G=G.sort(function(M,L){return(L.info.lastUsed-M.info.lastUsed)});if(G.length>0){F.elements.body.removeClassName("hide-last-used");for(var H=0;H<G.length&&H<t.MAXIMUM_TEMPLATES_PREVIEW;H++){var J=G[H];var K=F.createPreview(J).inject(F.templateLastUsed.previews.container);K.addEventListener("click",function(L){L.stopPropagation();F.templateList.treeList.getDocument().withTransactionUpdate(function(){if(!L.ctrlKey){F.templateList.treeList.getDocument().unselectAll();var P=Object.keys(F.templateLastUsed.previews.templates);for(var N=0;N<P.length;N++){F.templateLastUsed.previews.templates[P[N]].removeClassName("active")}}var M=F.templateList.treeList.getRoots();for(var O=0;O<M.length;O++){if(M[O].options.id===L.currentTarget.id){M[O].select()}}L.currentTarget.addClassName("active")})});K.addEventListener("dblclick",function(){if(!F.options.editMode){F.onEndCallback()}});F.templateLastUsed.previews.templates[G[H].id]=K}}else{F.elements.body.addClassName("hide-last-used")}}else{F.templateList.treeListContainer.addClassName("tree-list-empty");F.templateList.treeListPlaceholder.setContent(j.templates.treeList.placeholder)}})["catch"](function(){A.displayNotification({msg:j.templates.errors.get,eventID:"error"})})["finally"](function(){E.unmask(F.elements.dialog.getContent())})},getTemplates:function(){var G=this;var F=[];return h.preferences.get({data:{name:t.TEMPLATES_PREFERENCE}}).then(function(H){F=H.body;if(!Array.isArray(F)){return[]}var J=[];for(var I=0;I<F.length;I++){var K=k.clone(F[I]);if(!k.is(K.info.version,"string")){K.info.version=""}if(k.is(G.converters[K.info.version],"function")){J.push(G.converters[K.info.version](K))}else{J.push(K)}}return J})["catch"](function(H){G._logger.error("Could not fetch the templates from the preferences: %o",H);return[]})},getAndFetchTemplates:function(){var F=this;return F.getTemplates().then(function(H){var G=[],J=[],I={};H.forEach(function(K){G.push(K.id);I[K.id]=K;if(F.utils.isShared(K)===true){J.push(K)}});return F._getSharedTemplates(J).then(function(N){var M=[];G.forEach(function(O){if(!F.utils.isShared(I[O])){M.push(I[O])}else{if(k.is(N.map[O],"object")){M.push(N.map[O])}else{delete I[O]}}});var K=[];for(var L=0;L<H.length;L++){if(I[H[L].id]){K.push(H[L])}}H=K;if(H.length!==G.length){return F.setTemplates(H).then(function(){return M})}return M})})},setTemplates:function(G){var F=this;return h.preferences.set({data:{name:t.TEMPLATES_PREFERENCE,value:JSON.stringify(G)}})["catch"](function(H){F._logger.error("Could not save the preferences: %o",H)})},removeTemplates:function(F){var I=this;var G=F.reduce(function(K,J){K[J.options.data.id]=J.options.data;return K},{});var H=F.map(function(J){return J.options.id});return I.getTemplates().then(function(K){var J=[],M=[];for(var L=0;L<K.length;L++){if(H.indexOf(K[L].id)===-1){J.push(K[L])}else{if(I.utils.isShared(G[K[L].id])===true&&I.utils.isOwnedBy(G[K[L].id],I.user)){M.push(G[K[L].id].info.share.document);J.push(G[K[L].id])}}}return I.removeSharedTemplates(M).then(function(){return I.setTemplates(J)})})},removeSharedTemplates:function(I){var K=function(L){return new g(function(M){y.deleteDocument(L,{tenantUrl:p.get3DSpaceUrl(),tenant:p.getTenant(),securityContext:p.getSecurityContext(),onComplete:M,onFailure:M})})};var G=[];for(var F=0;F<I.length;F++){var H=I[F];var J=function(M){var L=this;return{documentId:L.documentId,response:M}};G.push(K(H).then(J.bind({documentId:H})))}return g.all(G)},onEndCallback:function(){var G=this;var H=G.templateList.treeList.getDocument().getSelectedNodes(),F=H[H.length-1].options.data;G.onEnd(F);G.elements.dialog.destroy();G.destroy()},createPreview:function(P){var K=this;var L=k.createElement("div",{"class":"card create-template-chooser-preview",id:P.id});k.createElement("div",{"class":"card-block create-template-chooser-preview-name",html:e.getTextFromHTML(P.info.name),title:e.getTextFromHTML(P.info.name)}).inject(L);var F=k.createElement("div",{"class":"card-block create-template-chooser-preview-details"}).inject(L);var O="";switch(P.data.priority){case t.LOW_PRIORITY:O="low wux-ui-3ds wux-ui-3ds-level-low";break;case t.MEDIUM_PRIORITY:O="medium wux-ui-3ds wux-ui-3ds-level-medium";break;case t.HIGH_PRIORITY:O="high wux-ui-3ds wux-ui-3ds-level-high";break;case t.URGENT_PRIORITY:O="urgent wux-ui-3ds wux-ui-3ds-alert ";break;default:break}k.createElement("div",{"class":"create-template-chooser-preview-priority",html:[k.createElement("span",{"class":"issue-list-priority-icon "+O,title:j.priorities[P.data.priority.toLowerCase()]}),j.priorities[P.data.priority.toLowerCase()]]}).inject(F);var R=k.createElement("div",{"class":"create-template-chooser-preview-reported-against"}).inject(F);k.createElement("span",{"class":"preview-reported-against-icon wux-ui-3ds wux-ui-3ds-location",title:j.create.related.labels.reportedAgainst}).inject(R);var J=k.createElement("span",{"class":"preview-reported-against-title"}).inject(R);if(P.data.reportedAgainst.length>0){K._fetchAndInject(P.data.reportedAgainst,J)}else{J.innerHTML=j.templates.preview.noObject;J.addClassName("no-object")}var M=k.createElement("div",{"class":"create-template-chooser-preview-contexts"}).inject(F);k.createElement("span",{"class":"preview-contexts-icon wux-ui-3ds wux-ui-3ds-3d-object",title:j.create.related.labels.context}).inject(M);var Q=k.createElement("span",{"class":"preview-contexts-title"}).inject(M);if(P.data.contexts.length>0){K._fetchAndInject(P.data.contexts,Q)}else{Q.innerHTML=j.templates.preview.noObject;Q.addClassName("no-object")}var N=k.createElement("div",{"class":"create-template-chooser-preview-responsible-organization"}).inject(F);k.createElement("span",{"class":"preview-responsible-organization-icon fonticon fonticon-users-group",title:j.create.team.labels.responsibleOrganization}).inject(N);var I=k.createElement("span",{"class":"preview-responsible-organization-title"}).inject(N);if(typeof P.data.responsibleOrganization==="string"){I.title=P.data.responsibleOrganization;I.innerHTML=P.data.responsibleOrganization}var H=k.createElement("div",{"class":"create-template-chooser-preview-users"}).inject(F);var G=false;P.data.assignees.forEach(function(U,V){var W=p.getUserImage(U.user),T=P.ui.assignees[U.user];if(V>2){G=true}else{k.createElement("img",{"class":"preview-users-img",title:T.fullName+" ("+T.user+")",src:W,events:{click:function(){p.getUserProfile(T.user)}}}).inject(H)}});if(G===true){var S="";P.data.assignees.forEach(function(U){var T=P.ui.assignees[U.user];S+=T.fullName+" ("+T.user+")\n"});k.createElement("div",{"class":"preview-users-ellipsis",html:"...",title:S}).inject(H)}return L},share:function(J){var K=this;var H=null;var I=null;var L=function(N){var M=p.get3DDashboardUrl()+t.SHARED_TEMPLATE_URL_PREFIX+encodeURIComponent('{"template":{"document":"'+N.document+'","file":"'+N.file+'"}}');e.copyTextToClipboard(M)};if(K.utils.isShared(J)===true){return g.resolve(J)}if(Number.isInteger(J.info.lastUsed)){I=J.info.lastUsed;J.info.lastUsed=null}var G=JSON.stringify(J);var F=new Blob([G],{type:"application/json"});return new g(function(O,N){var M=j.templates.shared.description+" \n "+J.info.name+" ( "+J.info.description+")";y.createDocument({title:j.replace(j.templates.shared.title,{owner:p.getFullName()}),description:M,fileInfo:{file:new File([F],j.replace(j.templates.shared.title,{owner:p.getFullName()})+".json")}},{tenantUrl:p.get3DSpaceUrl(),tenant:p.getTenant(),securityContext:p.getSecurityContext(),onComplete:function(Q){try{var P=Q.data[t.FIRST_DOCUMENT].id,S=Q.data[t.FIRST_DOCUMENT].relateddata.files[t.FIRST_DOCUMENT].id;O({id:J.id,info:{share:{document:P,file:S},lastUsed:I}})}catch(R){N(new Error("Error during the document creation "+Q+R))}},onFailure:function(P){N(new Error("Error during the document creation "+P))}})}).then(function(M){H=M;return K.getTemplates().then(function(P){var N=[];for(var O=0;O<P.length;O++){if(J.id===P[O].id){N.push(M)}else{N.push(P[O])}}return N})}).then(function(M){return K.setTemplates(M)}).then(function(){L(H.info.share);A.displayNotification({msg:j.templates.notifications.sharedSuccess,eventID:"success"});H.info.share.owner={user:K.user};return H})},addSharedTemplateToPreferences:function(H){var G=this;var F={id:H.document+"-"+H.file,info:{share:{document:H.document,file:H.file},lastUsed:null}};return G._getSharedTemplates([F]).then(function(I){if(!Array.isArray(I.array)||I.array.length===0){A.displayNotification({msg:j.templates.notifications.sharedTemplateNotValid,eventID:"warning"});return{array:[],map:{}}}return I}).then(function(I){if(I&&!Array.isArray(I.array)||I.array.length===0){return[]}return G.getTemplates().then(function(K){for(var J=0;J<K.length;J++){if(G.utils.isShared(K[J])){if(K[J].info.share.document===H.document){A.displayNotification({msg:j.templates.notifications.sharedTemplateAlreadyAdded,eventID:"info"});return[]}}}K.push(F);return K})}).then(function(I){if(!Array.isArray(I)||I.length===0){return[]}return G.setTemplates(I).then(function(){A.displayNotification({msg:j.templates.notifications.sharedTemplateAdded,eventID:"success"})})})},updateSharedTemplate:function(M){var L=this;if(L.utils.isShared(M)===false){return g.reject(new Error("This template is not a shared template"))}if(L.utils.isShared(M)&&!L.utils.isOwnedBy(M,L.user)){return g.reject(new Error("You do not owned this shared template"))}var K=k.clone(M);var F=K.info.share.document,I=K.info.share.file;var J=null;if(Number.isInteger(K.info.lastUsed)){J=K.info.lastUsed;K.info.lastUsed=null}delete K.info.share;var H=JSON.stringify(K);var G=new Blob([H],{type:"application/json"});return new g(function(O,N){y.modifyDocument({id:F,fileInfo:{id:I,file:new File([G],j.replace(j.templates.shared.title,{owner:p.getFullName()})+".json")}},{tenantUrl:p.get3DSpaceUrl(),tenant:p.getTenant(),securityContext:p.getSecurityContext(),onComplete:function(P){try{O({id:K.id,info:{share:{document:F,file:P.data[t.FIRST_DOCUMENT].relateddata.files[t.FIRST_DOCUMENT].id},lastUsed:J}})}catch(Q){N(new Error("Error during the document creation "+P+Q))}},onFailure:function(P){N(new Error("Error during the document creation "+P))}})})},_getSharedTemplates:function(F){var I=this;var H=k.clone(F),G={array:[],map:{}};if(H.length===0){return g.resolve(G)}return new g(function(L,K){var J=H.reduce(function(O,N){O.push(N.info.share.document);return O},[]);var M=H.reduce(function(O,N){O[N.info.share.document]=N;return O},{});y.getDocuments(J,{tenantUrl:p.get3DSpaceUrl(),tenant:p.getTenant(),securityContext:p.getSecurityContext(),onComplete:function(O){if(!O||!Array.isArray(O.data)){K(new Error("Could not fetch the documents "+O))}var Q=[],S=[];O.data.forEach(function(V){var U=I.utils.getFileInfo(O,V.id);if(U&&U.id){S.push(V.id);M[V.id].info.share.file=U.id;Q.push(U)}});var T=[],R=[];k.clone(J).forEach(function(U){if(S.indexOf(U)>-1){R.push(M[U].info.share.document);T.push(M[U].info.share.file)}else{delete M[U]}});var N=[];for(var P=0;P<H.length;P++){if(M[H[P].info.share.document]){N.push(H[P])}}H=N;L({documents:R,files:T,results:Q})},onFailure:function(N){K(new Error("Could not fetch the documents "+N))}})}).then(function(J){if(H.length===0){return g.resolve(G)}return new g(function(K){y.downloadDocuments(J.files,{tenantUrl:p.get3DSpaceUrl(),tenant:p.getTenant(),securityContext:p.getSecurityContext(),onComplete:function(L){var M=[];L.forEach(function(N){M.push(I.utils.getContentFromURL(N.id,N.downloadUrl))});g.all(M).then(function(O){var N=O.reduce(function(Q,P){Q.push(P.id);return Q},[]);k.clone(J.files).forEach(function(R,Q){var T=N.indexOf(R);if(T===-1){H.splice(Q,1);J.documents.splice(Q,1);J.files.splice(Q,1)}else{var U=k.clone(O[T]);var P=U.content.info.version;if(!k.is(P,"string")){P=U.content.info.version=""}if(k.is(I.converters[P],"function")){U.content=I.converters[P](U.content)}var S=k.clone(U.content);S.id=H[Q].id;S.info.lastUsed=H[Q].info.lastUsed;S.info.share={document:J.documents[T],file:J.files[T],owner:J.results[T].owner};G.array.push(S);G.map[S.id]=S}});K()},function(N){I._logger.error('The downloaded document is not valid "%s"',N);K()})},onFailure:function(L){I._logger.error('The download call failed "%s"',L);K()}})})}).then(function(){return G})},_setParseAttributes:function(F){var H=this;H.parsed={icons:[],id:null,title:null,type:null,name:null,revision:null};var G=a.parseFetchResponse(F);H.parsed.icons.push(G.display.typeIcon);H.parsed.title=G.display.title;H.parsed.type=G.display.type;H.parsed.name=G.display.name;H.parsed.revision=G.display.revision},_fetchAndInject:function(G,H){var F=this;h.fetch({data:{objects:G.map(function(I){return{physicalId:I.physicalId}})},onComplete:function(K){var J=K.body;if("results" in J){if(J.results.length===1){var I=J.results[J.results.length-1];F._setParseAttributes(I);H.title=F.parsed.title+" ("+F.parsed.name+" - "+F.parsed.type+" - "+F.parsed.revision+")";H.innerHTML=F.parsed.title}else{if(J.results.length>1){var L="";J.results.forEach(function(M){F._setParseAttributes(M);L+=F.parsed.title+" ("+F.parsed.name+" - "+F.parsed.type+" - "+F.parsed.revision+")\n";H.title=L});H.innerHTML=J.results.length+" "+j.templates.preview.objectCount}}}},onFailure:function(){}})},_listenToCreateEvents:function(F){var G=this;G.listenTo(F,"onTemplateCreate",function(){G.refresh()});G.listenTo(F,"onCreateDialogClose",function(){G.elements.dialog.show()})},_destroyPopover:function(){var G=this;if(G.popover!==null){try{G.popover.destroy()}catch(F){}G.popover=null}},converters:{"":function(H){var M=k.clone(H);var O=C.getLogger("DS/IssueComponents/templates/Templates");O.info("Converting a template prior to 19x FD03");if(k.is(M.info.share,"object")===true){return H}var F=[],P=[],K=[];var L={};if(M.data.assignees&&Array.isArray(M.data.assignees.add)){M.data.assignees.add.forEach(function(Q){F.push({user:Q})});M.data.assignees=F}if(M.data.reportedAgainst&&Array.isArray(M.data.reportedAgainst.add)){M.data.reportedAgainst.add.forEach(function(Q){P.push({physicalId:Q})});M.data.reportedAgainst=P}if(Array.isArray(M.data.positions)){M.data.positions.forEach(function(Q){for(var R=0;R<M.data.reportedAgainst.length;R++){if(M.data.reportedAgainst[R].physicalId===Q.id){M.data.reportedAgainst[R].position=Q.coordinates}}});delete M.data.positions}if(k.is(M.data.context,"string")){if(M.data.context.length>0){K.push({physicalId:M.data.context})}M.data.contexts=K;delete M.data.context}if(M.ui&&M.ui.assignees&&k.is(M.ui.assignees.add,"object")){var G=Object.keys(M.ui.assignees.add);G.forEach(function(Q){L[Q]=M.ui.assignees.add[Q]});delete M.ui.assignees.add;M.ui.assignees=L}var N={id:M.id,info:M.info,data:M.data,ui:M.ui};var I=this["19x FD03"](N);var J=I;return J},"19x FD03":function(G){var H=k.clone(G);var F=C.getLogger("DS/IssueComponents/templates/Templates");F.info("Converting a template from 19x FD03");if(k.is(H.info.share,"object")===true){return G}if(!Array.isArray(H.data.coOwners)){H.data.coOwners=[]}if(!k.is(H.ui.coOwners,"object")){H.ui.coOwners={}}return{id:H.id,info:H.info,data:H.data,ui:H.ui}}},utils:{isShared:function(F){return k.is(F.info.share,"object")===true},isOwnedBy:function(G,F){var H=this;return H.isShared(G)===true&&G.info.share.owner&&G.info.share.owner.user===F},getFileInfo:function(G,F){var I={};try{G.data.forEach(function(J){if(J.id===F){if(J.relateddata.files&&J.relateddata.files.length===1){var K=J.relateddata.ownerInfo[J.relateddata.ownerInfo.length-1].dataelements;I.id=J.relateddata.files[J.relateddata.files.length-1].id;I.owner={lastName:K.lastname,firstName:K.firstname,fullName:K.firstname+" "+K.lastname,user:K.name}}}})}catch(H){}return I},getContentFromURL:function(I,F){var H=this;var G=new XMLHttpRequest();return new g(function(K,J){G.open("GET",F,true);G.responseType="blob";G.onload=function(){var L=new FileReader();L.readAsDataURL(G.response);L.onload=function(N){try{K({id:I,content:JSON.parse(H.base64.decode(N.target.result.split(",").pop()))})}catch(M){J(new Error("The shared template from the URL is not a JSON "+M))}}};G.onerror=function(){J(new Error("Could not read the shared template from the URL "+F))};G.send()})},getUserImage:function(G){var F=k.createElement("div",{"class":"template-owner-container"});k.createElement("img",{"class":"template-owner-img",title:G.fullName+" ("+G.user+")",src:p.getUserImage(G.user)}).inject(F);return F},getSharedImage:function(){var F=k.createElement("div",{"class":"template-shared-container"});k.createElement("span",{"class":"wux-button-icon-fi wux-ui-3ds wux-ui-3ds-users wux-ui-3ds-lg"}).inject(F);return F},base64:{decode:function(F){return decodeURIComponent(Array.prototype.map.call(atob(F),function(G){return"%"+("00"+G.charCodeAt(0).toString(16)).slice(-2)}).join(""))}}}});return i});