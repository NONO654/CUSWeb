/*!  Copyright 2016 Dassault Systemes. All rights reserved. */
define("DS/CAT3DAnnotationModelLoader/CAT3DAnnotationModelLoader",["UWA/Class","UWA/Utils","DS/Visualization/AnnotationServices","DS/WebappsUtils/WebappsUtils","DS/Visualization/Utils","DS/CoreEvents/ModelEvents","DS/PADUtils/views/PADAlert","DS/PADUtils/views/PADProgressBar","DS/CAT3DAnnotationUtils/CAT3DAnnotationStorageController","DS/CAT3DAnnotationUtils/CAT3DAnnotationUtils","i18n!DS/CAT3DAnnotationModelLoader/assets/nls/CAT3DAnnotationModelLoader"],function(a,j,k,f,c,e,b,i,d,l,h){var n=a.extend({init:function(S){this._parent(S);var at=0;var Q=S.ctxViewer;var z=S.favoriteCtxManager;var v=null;var A=new k();var aa=[];var Y=4;var s=this;var V=new e();var w;var ak=null;var T=0;var J=false;var K=[];var ar=[];var x=[];var av=[];var E=[];var D=[];var R=[];var y=[];var aj=[];var ah=true;var au=[];var ap=[];var ac={};var B=0;var F=0;var aq=false;var O=false;this.setActiveState=function(aA){if(aA===at||(at!==0&&at!==1&&at!==2)){return}at=aA;O=true;t();if(at===1||at===2){if(!v){s.setLoaderType()}an();if(!ac.onRemoveRoot){ac.onRemoveRoot=Q.subscribe({event:"onRootRemoved"},af);ac.on3DPlayAssetChanged=Q.subscribe({event:"on3DPlayAssetChanged"},function(){af({path:Q.getRootBagPath()})});ac.onRootAttached=Q.subscribe({event:"onRootAttached"},r);ac.onRootDetached=Q.subscribe({event:"onRootDetached"},G);ac.onHide=Q.subscribe({event:"onHide"},ad);ac.onShow=Q.subscribe({event:"onShow"},p);ac.onRefreshBegin=Q.subscribe({event:"onRefreshBegin"},u);ac.onRefreshCompleted=Q.subscribe({event:"onRefreshCompleted"},o)}if(at===1&&!ac.onAddRoot){if(z){F=z.subscribe({event:"onFavoriteContextLoading"},H)}ac.onAddRoot=Q.subscribe({event:"onRootAdded"},C);ac.onLoadingComplete=Q.subscribe({event:"onLoadingComplete"},ao);ac.onLoadingFailure=Q.subscribe({event:"onLoadingFailure"},ao);ac.onLoadingCanceled=Q.subscribe({event:"onLoadingCanceled"},ao);B=d.subscribe("onPreferenceModified",Z);L()}}else{if(T>0){T=1;ae()}var ay=Object.keys(ac);var ax;for(ax=0;ax<ay.length;ax++){Q.unsubscribe(ac[ay[ax]])}ac={};if(B){d.unsubscribe(B);B=0}if(F&&z){z.unsubscribe(F);F=0}var az=R.slice();for(ax=R.length-1;ax>=0;ax--){R[ax].getParentPath().getLastElement(true).removeChild(R[ax].getLastElement(true))}if(az.length){al("onAnnotationSetRemoved",{pathes:az});Q.getViewer().render()}D.splice(0,D.length);R.splice(0,R.length);y.splice(0,y.length);K.splice(0,K.length);ar.splice(0,ar.length);x.splice(0,x.length);av.splice(0,av.length);E.splice(0,E.length);aj.splice(0,aj.length)}al("onAnnotModelLoaderActiveStateChanged",{state:at});O=false};this.clear=function(){this.setActiveState(0);Q=v=A=s=V=w=ac=aj=null;aa=K=ar=x=av=E=D=R=y=au=null};this.getActiveState=function(){return at};var P=function(aC){var ay=aC.clone();var aB=ay.getLastElement(true);var ax;for(ax=0;ax<R.length;ax++){var aA=R[ax].getLastElement(true);if(aA===aB){d.removeA3EWidgetPref({path:R[ax],pref:"A3EAnnotSetsLoaded"});d.saveA3EWidgetPref({path:aC,pref:"A3EAnnotSetsLoaded",data:{visibility:aB.isVisible(),ctxType:aB.getContextType()}});for(var az=R.length-1;az>=0;az--){if(R[ax].isEqual(R[az])){R[az]=aC.clone()}}}}for(ax=0;ax<D.length;ax++){if(D[ax].path.getLastElement(true)===ay.getParentPath().getLastElement(true)){D[ax].path=ay.getParentPath().clone()}}K.splice(0,K.length)};this.getLoadedAnnotationSets=function(){var aQ=[],aO;if(!at){return aQ}var aN=Q.getRootBagPath();if(K.length===0){var aG=[];for(var aK=0;aK<R.length;aK++){var aL=true;for(aO=0;aO<y.length;aO++){if(y[aO].path.isAParentOf(R[aK])){aL=false;break}}if(aL){aG.push(R[aK])}}var az=function(aU){var aT=aU.getLastElement(true);if(aT.getTreeOrder&&aT.getTreeOrder()){return true}var aS=aU.getChildrenPathes();for(var aV=0;aV<aS.length;aV++){var aR=az(aS[aV]);if(aR===true){return true}}return undefined};var aI=function(aV){var aR=[];var aU=aV;while(!aU.isEqual(aN)){var aT=aU.getLastElement(true);var aS=0;if(aT.getTreeOrder&&aT.getTreeOrder()){aS=aT.getTreeOrder()}aR.splice(0,0,aS);aU=aU.getParentPath()}return aR};var ay=function(aU,aS){if(aU.length===0){return true}if(aS.length===0){return false}var aR=Math.max(aU.length,aS.length);for(var aT=0;aT<aR;aT++){if(aU[aT]===aS[aT]){continue}else{return aU[aT]>aS[aT]}}return false};var aE=[];var aM=function(aW){var aV=aW.getLastElement(true);var aU,aT;if(aV.getAnnotationClassType&&aV.getAnnotationClassType()==="tpsAnnotationSet"){var aS=true;for(aU=0;aU<aG.length;aU++){if(aW.isEqual(aG[aU])){for(aT=0;aT<aE.length;aT++){if(aE[aT].isEqual(aG[aU])){aS=false;break}}if(aG[aU]&&aS){aE.push(aG[aU].clone())}break}}}else{var aR=aW.getChildrenPathes();for(aU=0;aU<aR.length;aU++){aM(aR[aU])}}};var aB=aN.getChildrenPathes();for(var aD=0;aD<aB.length;aD++){aE=[];var aF;if(az(aB[aD])){var aC=[];for(aF=0;aF<aG.length;aF++){if(aB[aD].isAParentOf(aG[aF])){aC.push({index:aI(aG[aF].getParentPath().getParentPath()),path:aG[aF]})}}var aA=[];for(aF=0;aF<aC.length;aF++){var aJ=aC[aF].index;var aH=aC[aF].path.clone();if(aE.length===0){aE.push(aH);aA.push(aJ)}else{var aP=false;for(aO=0;aO<aA.length;aO++){if(ay(aJ,aA[aO])){if(aO===aA.length-1){aE.push(aH);aA.push(aJ);aP=true;break}else{if(ay(aA[aO+1],aJ)){aE.splice(aO+1,0,aH);aA.splice(aO+1,0,aJ);aP=true;break}}}else{break}}if(!aP){aE.splice(0,0,aH);aA.splice(0,0,aJ)}}}}else{aM(aB[aD])}K=K.concat(aE)}}if(K&&K.length){for(var ax=0;ax<K.length;ax++){aQ.push(K[ax].clone())}}return aQ};this.subscribe=function(ay,ax){if(ay&&ax){return V.subscribe({event:ay},ax)}return undefined};this.unsubscribe=function(ax){if(V&&ax){V.unsubscribe(ax)}};this.isRunning=function(){return(x&&x.length>0)||(E&&E.length>0)};this.setLoaderType=function(ay){var ax=ay||w||"DS/CAT3DAnnotationModel/CAT3DAnnotationLoader";if(ax!==w){w=ax;require([ax],function(aB){if(w===ax){v=new aB();if(R.length){var aA;for(var az=R.length-1;az>=0;az--){aA=R[az].getLastElement(true);R[az].getParentPath().getLastElement(true).removeChild(aA);aA.removeChildren();aA=null;R.splice(az,1)}R.splice(0,R.length);K.splice(0,K.length);D.splice(0,D.length);t();an();L()}}})}};this.getLoaderType=function(){return v?v.getType():"undefined"};this.hasAlreadyBeenLoaded=function(az,aB){var ax,ay;if(az){if(aB){for(ax=0;ax<au.length;ax++){if(au[ax].isEqual(az)){return 1}}}else{for(ax=0;ax<D.length;ax++){if(D[ax].recursive){if(D[ax].path.isAParentOf(az)){for(ay=0;ay<R.length;ay++){if(az.isAParentOf(R[ay])){return 1}else{if(az.getLastElement(true)===R[ay].getParentPath().getLastElement(true)){return 7}}}for(ay=0;ay<x.length;ay++){if(x[ay]&&(az.isAParentOf(x[ay])||az.isEqual(x[ay]))){return 3}}return 2}else{if(D[ax].path.getLastElement(true)===az.getLastElement(true)){return 7}}}else{if(az.isEqual(D[ax].path)){for(ay=0;ay<R.length;ay++){var aA=R[ay].getParentPath();if(az.isEqual(aA)){return 4}}for(ay=0;ay<x.length;ay++){if(x[ay]&&az.isEqual(x[ay])){return 6}}return 5}else{if(D[ax].path.getLastElement(true)===az.getLastElement(true)){return 8}}}}}}return 0};function U(aB,aA){if(l.getNodeID(aA.getLastElement(true))===aB){return aA}var ay=aA.getChildrenPathes();var az;for(var ax=0;ax<ay.length;ax++){az=U(aB,ay[ax]);if(az){return az}}return undefined}this.loadFTALightModel=function(aM,aU,aK,aY){var aJ,aH,aR;if(!aM||!A||!at){return}var aB=aY&&aY.length===1&&aY[0]===2;if(aB){if(s.hasAlreadyBeenLoaded(aM,true)===1){return}au.push(aM.clone())}else{var aA=s.hasAlreadyBeenLoaded(aM);if(aA===1||aA===2||aA===3){return}if(!aK&&(aA===4||aA===5||aA===6)){return}if(!aK&&(aA===7||aA===8)){for(aH=0;aH<R.length;aH++){if(R[aH].getParentPath().getLastElement(true)===aM.getLastElement(true)){var ay=aM.clone();ay.addElement(R[aH].getLastElement(true));P(ay)}}return}var az=[];if(aM.isEqual(Q.getRootBagPath())){az=Q.getRootBagPath().getChildrenPathes()}else{az.push(aM)}for(var aD=0;aD<az.length;aD++){aJ=az[aD];var aE=false;for(aH=0;aH<D.length;aH++){if(D[aH].path.isEqual(aJ)){if(!D[aH].recursive&&aK){D[aH].recursive=aK}aE=true}else{if(aK&&aJ.isAParentOf(D[aH].path)&&!D[aH].recursive){D[aH].recursive=true}}}if(!aE&&!aJ.isEqual(Q.getRootBagPath())){D.push({path:aJ.clone(),recursive:aK!==undefined?aK:false})}}}var aF=[];if(aK){q(aM,aF,aU)}else{if(aB){var aC=aM.getChildrenPathes();for(aR=0;aR<aC.length;aR++){var aX=aC[aR].getChildrenPathes();if(l.getNodeType(aM.getLastElement(true))==="CATProduct"&&aX.length===1&&l.is3DLeaf(aX[0].getLastElement(true))){aF.push(aX[0])}else{if(l.isReference(aM.getLastElement(true))&&aX.length===1&&l.isReference(aX[0].getLastElement(true))){var aL=aX[0].getChildrenPathes();if(aL.length===1&&l.isRepInstance(aL[0].getLastElement(true))){aF.push(aL[0].getChildrenPathes()[0])}}}}}else{aF.push(aM)}}var aO=[],aN=[],aG=[],ax=[],aW=[];var aT=false;for(aH=0;aH<aF.length;aH++){aJ=aF[aH];var aP=l.getNodeID(aJ.getLastElement(true));if(aP){for(aR=0;aR<R.length;aR++){if(aJ.getLastElement(true)===R[aR].getParentPath().getLastElement(true)){aP=false;break}}for(aR=0;aR<x.length;aR++){if(aJ.isEqual(x[aR])){aP=false;break}}for(aR=0;aR<aO.length;aR++){if(aJ.getLastElement(true)===aO[aR].getLastElement(true)){aP=false;break}}if(aP){var aI=l.getNodeID(aJ.getLastElement(true));if(aJ.getLastElement(true).xml){W(aJ,aJ.getLastElement(true).xml,aU,aY,true);aJ.getLastElement(true).xml=null;x.push(aJ);aT=true}else{if(!l.getLoadedAssetType()){if(aJ.getLastElement(true).getLoadedStream&&aJ.getLastElement(true).getLoadedStream()){if(E.indexOf(aI)===-1){av.push({path:aJ.clone(),id:aI});if(aJ.getLastElement(true).getLoadedStream()==="thumbnail"){aW.push(aI);ax.push({node:Q.getController().getNode({id:aI}),stream:"cgr"})}else{aG.push(aI)}}}else{aN.push(aI);aO.push(aJ)}}}}}}if(aN.length||aG.length||aW.length){J=x.length!==0;x=x.concat(aO);E=E.concat(aG);E=E.concat(aW);var aQ=function(a0){if(a0&&a0.node){var a2=l.getNodeID(a0.node);var a1;for(var aZ=0;aZ<av.length;aZ++){if(av[aZ].id===a2){if(!a0.xml){av.splice(aZ,1);return}av[aZ].xml=a0.xml;av[aZ].node=a0.node;a1=U(a2,av[aZ].path);if(a1){av.splice(aZ,1)}break}}if(!a1||!at){return}if(x.indexOf(a1)!==-1){return}x.push(a1);E.splice(E.indexOf(a2),1);if(a0.xml){Q.getController().lockNodes({ids:[a2]});W(a1,a0.xml,aU,aY);return}al("onNoAnnotationSetLoaded",{path:a1})}else{al("onNoAnnotationSetLoaded",{})}};var aS=function(){for(var aZ=0;aZ<av.length;aZ++){if(av[aZ].xml&&av[aZ].node){aQ(av[aZ])}}};var aV=function(){var aZ;for(aZ=0;aZ<aG.length;aZ++){E.splice(E.indexOf(aG[aZ]),1)}var a0=null;for(aZ=0;aZ<av.length;aZ++){a0=U(aI,av[aZ]);if(a0){av.splice(aZ,1);break}}if(E.length===0&&x.length===0){al("onNoAnnotationSetLoaded",{})}};if(aN.length){Q.getController().getAttributes({ids:aN,attributes:["cgr","ds6w:label"],callbacks:{onComplete:function(a1){for(var a0=0;a0<aN.length;a0++){var a2=a1[aN[a0]],aZ=a2?a2.cgr:null;if(aZ){ab(aO[a0],aZ,aU,aY)}else{al("onNoAnnotationSetLoaded",{path:aO[a0]})}}},onFailure:function(){for(aH=x.length-1;aH>=0;aH--){for(aR=0;aR<aO.length;aR++){if(aO[aR].isEqual(x[aH])){x.splice(aH,1);al("onNoAnnotationSetLoaded",{path:x[aH]});break}}}}}})}if(aG.length){Q.getController().refreshGeometry({ids:aG,applicativeContainers:{V4V5_FDT:{errorCallBack:aQ,doneCallback:aQ}},onComplete:aS,onFailure:aV,onTimeout:aV})}if(ax.length){Q.getController().switchNodeVisuStreamOnDemand({data:ax,applicativeContainers:{V4V5_FDT:{errorCallBack:aQ,doneCallback:aQ}},callbacks:{onURLLoad:function(){},onComplete:aS,onFailure:aV,onTimeout:aV}})}}else{if(!aT){al("onNoAnnotationSetLoaded",{})}}};this.getDirectChildrenAnnotSets=function(ax){return N(ax)};this.setGlobalFTAVisibilityFlag=function(ay){var ax;if(typeof ay==="boolean"&&at>0){ah=ay;if(!ah){for(ax=0;ax<R.length;ax++){if(R[ax].getLastElement(true).isVisible()){aj.push(R[ax].clone());R[ax].getLastElement(true).setVisibility(false)}}}else{for(ax=0;ax<aj.length;ax++){aj[ax].getLastElement(true).setVisibility(true)}aj.length=0}Q.getViewer().render()}};var L=function(){var aC=Q.getRootBagPath().getChildrenPathes();var aG=[];var aA=d.getPreference("3DAnnotLoadARMPartsPref");for(var aF=0;aF<aC.length;aF++){var ax=d.getA3EWidgetAnnotSetsLoadedPref({path:aC[aF]});if(ax&&ax.length){aG=aG.concat(ax)}else{var ay=aC[aF].getLastElement(true);if(l.is3DLeaf(ay)){aG.push({path:aC[aF],visibility:true})}else{s.loadFTALightModel(aC[aF],true,false);if(aA){s.loadFTALightModel(aC[aF],true,false,[2])}if(l.isReference(aC[aF].getLastElement(true))&&l.getNodeType(aC[aF].getLastElement(true))!=="CATProduct"){var az=aC[aF].getChildrenPathes();for(var aD=0;aD<az.length;aD++){var aE=az[aD].getChildrenPathes();if(aE.length===1&&l.is3DLeaf(aE[0].getLastElement(true))){s.loadFTALightModel(aE[0],true,false)}}}}}}d.deleteA3EWidgetPref({pref:"A3EAnnotSetsLoaded"});for(var aB=0;aB<aG.length;aB++){s.loadFTALightModel(aG[aB].path,aG[aB].visibility,l.is3DLeaf(aG[aB].path.getLastElement(true)))}};var aw=function(az,ax){if(!az||!az.getAnnotationClassType||!ax){return}var aA;for(var ay=0;ay<R.length;ay++){if(R[ay].getLastElement(true)===az){aA=R[ay];break}}if(ax==="visibility"){al("onAnnotationVisibilityModified",{annotNode:az,path:aA})}};var Z=function(aC){if(aC.preference==="3DAnnotLoadARMPartsPref"&&aC.value===true){var aE=Q.getRootBagPath().getChildrenPathes();for(var ay=0;ay<aE.length;ay++){var ax=aE[ay].getLastElement(true);s.loadFTALightModel(aE[ay],true,false,[2]);if(l.getNodeType(ax)==="CATDrawing"||l.getNodeType(ax)==="CATAnalysis"){var aB=aE[ay].getChildrenPathes();for(var aA=0;aA<aB.length;aA++){var aD=aB[aA];var az;while(aD){az=aD.getLastElement(true);if(l.isReference(az)||l.is3DLeaf(az)||aD.getChildrenPathes().length!==1){break}aD=aD.getChildrenPathes()[0]}if(aD&&l.isReference(aD.getLastElement(true))){s.loadFTALightModel(aD,true,false,[2])}}}}Q.getViewer().render()}};var H=function(ax){ap=ap.concat(ax)};var C=function(aB){if(!aq){var ax=true;for(var ay=0;ay<ap.length;ay++){if(ap[ay].root===l.getNodeID(aB.path.getLastElement(true))){var aC=aB.path.clone();var aA=ap[ay].instances&&ap[ay].instances.length?ap[ay].instances:[ap[ay].origin];for(var az=0;az<aA.length;az++){aC=ai(aC,aA[az])}if(aC&&!aC.isEqual(aB.path)){s.loadFTALightModel(aC,true,false);ax=false}ap.splice(ay,1);break}}if(ax){am(aB.path)}}};var af=function(ay){var az=[];var ax;for(ax=R.length-1;ax>=0;ax--){if(ay.path.isAParentOf(R[ax])){az.push(R[ax].clone());R.splice(ax,1)}}K.length=0;for(ax=D.length-1;ax>=0;ax--){if(ay.path.isAParentOf(D[ax].path)){D.splice(ax,1)}}for(ax=ar.length-1;ax>=0;ax--){if(ay.path.isAParentOf(ar[ax].path)){ar.splice(ax,1)}}for(ax=aa.length-1;ax>=0;ax--){if(aa[ax].loadedData&&(ay.path.isAParentOf(aa[ax].loadedData.path)||ay.path.isEqual(aa[ax].loadedData.path))){al("onNoAnnotationSetLoaded",{path:aa[ax].loadedData.path,loadingAlreadyStarted:true});aa[ax].terminate();an(ax);ae()}}if(az.length){al("onAnnotationSetRemoved",{pathes:az})}};var r=function(ay){for(var ax=0;ax<y.length;ax++){if(y[ax].detached&&ay.path.isEqual(y[ax].path)){if(y[ax].hidden){y[ax].detached=false}else{y.splice(ax,1)}break}}al("onAnnotationParentVisibilityModified")};var G=function(az){var ax=false;for(var ay=0;ay<y.length;ay++){if(az.path.isEqual(y[ay].path)){y[ay].detached=true;ax=true;break}}if(!ax){y.push({path:az.path.clone(),hidden:false,detached:true})}al("onAnnotationParentVisibilityModified")};var ao=function(){ap.length=0};var ad=function(aA){for(var ay=0;ay<aA.paths.length;ay++){var ax=false;for(var az=0;az<y.length;az++){if(aA.paths[ay].isEqual(y[az].path)){y[az].hidden=true;ax=true;break}}if(!ax){y.push({path:aA.paths[ay].clone(),hidden:true,detached:false})}}al("onAnnotationParentVisibilityModified")};var p=function(az){for(var ax=0;ax<az.paths.length;ax++){for(var ay=0;ay<y.length;ay++){if(y[ay].hidden&&az.paths[ax].isEqual(y[ay].path)){if(y[ay].detached){y[ay].hidden=false}else{y.splice(ay,1)}}}}al("onAnnotationParentVisibilityModified")};var u=function(){aq=true;K.splice(0,K.length)};var o=function(){aq=false;if(T>0){T=1;ae()}t();an();var ay=Q.getRootBagPath().getChildrenPathes();for(var ax=0;ax<ay.length;ax++){am(ay[ax])}};var ai=function(aB,aC){var ay=aB.getLastElement(true);if(l.getNodeID(ay)===aC){return aB}var aA=aB.getChildrenPathes();for(var ax=0;ax<aA.length;ax++){var az=ai(aA[ax],aC);if(az){return az}}return undefined};var N=function(aD){var ax=[];var az;var aB=aD.getLastElement(true);if(l.is3DLeaf(aB)){for(az=0;az<R.length;az++){if(aD.isAParentOf(R[az])){ax.push(R[az].clone())}}}else{if(l.isReference(aB)){for(az=0;az<R.length;az++){var aE=X(R[az]);if(aE&&aD.isEqual(aE)){ax.push(R[az].clone())}}}else{if(l.getNodeType(aB)==="CATDrawing"||l.getNodeType(aB)==="CATAnalysis"){var aA=aD.getChildrenPathes();for(az=0;az<aA.length;az++){var aC=aA[az];var ay;while(aC){ay=aC.getLastElement(true);if(l.isReference(ay)||l.is3DLeaf(ay)||aC.getChildrenPathes().length!==1){break}aC=aC.getChildrenPathes()[0]}if(aC){if(l.isReference(aC.getLastElement(true))||l.is3DLeaf(aC.getLastElement(true))){ax=ax.concat(N(aC))}}}}}}return ax};var X=function(aB){var aA=aB.clone();var ay=Q.getRootBagPath();var ax=false;while(aA&&!aA.isEqual(ay)){var az=aA.getLastElement(true);if(l.is3DLeaf(az)){if(l.getNodeType(az)==="3DShape"){if(aA.getParentPath().isEqual(ay)){return aA}}else{if(l.getNodeType(az)==="CATPart"){if(aB.getLastElement(true).getContextType()!==2){return aA}}}}else{if(l.isReference(az)){if(aB.getLastElement(true).getContextType()===2){if(l.getNodeType(aA.getLastElement(true))==="CATProduct"||ax){return aA}ax=true}else{return aA}}}aA=aA.getParentPath()}return undefined};var am=function(ax){var az=ax.getLastElement(true);var aH=d.getA3EWidgetAnnotSetsLoadedPref({path:ax});if(aH&&aH.length){for(var aC=0;aC<aH.length;aC++){s.loadFTALightModel(aH[aC].path,aH[aC].visibility,l.is3DLeaf(ax.getLastElement(true)))}}else{if(l.is3DLeaf(az)){s.loadFTALightModel(ax,true,true)}else{if(l.isReference(az)){s.loadFTALightModel(ax,true,false);if(d.getPreference("3DAnnotLoadARMPartsPref")){s.loadFTALightModel(ax,true,false,[2])}if(l.isReference(ax.getLastElement(true))&&l.getNodeType(ax.getLastElement(true))!=="CATProduct"){var aG=ax.getChildrenPathes();for(var aB=0;aB<aG.length;aB++){var aE=aG[aB].getChildrenPathes();if(aE.length===1&&l.is3DLeaf(aE[0].getLastElement(true))){s.loadFTALightModel(aE[0],true,false)}}}}else{if(l.getNodeType(az)==="CATDrawing"||l.getNodeType(az)==="CATAnalysis"){var aA=ax.getChildrenPathes();for(var aD=0;aD<aA.length;aD++){var aF=aA[aD];var ay;while(aF){ay=aF.getLastElement(true);if(l.isReference(ay)||l.is3DLeaf(ay)||aF.getChildrenPathes().length!==1){break}aF=aF.getChildrenPathes()[0]}if(aF){if(l.isReference(aF.getLastElement(true))||l.is3DLeaf(aF.getLastElement(true))){am(aF)}}}}}}}};var q=function(ay,aD,aB){var aE=false;var aF;var ax=ay.getChildrenPathes();for(aF=0;aF<ax.length;aF++){var az=ax[aF].getLastElement(true);if(az.getAnnotationClassType&&az.getAnnotationClassType()==="tpsAnnotationSet"&&az.getContextType){ax[aF].getLastElement(true).setVisibility(aB);aE=true}}if(!aE){var aA=ay.getLastElement(true);if(l.getNodeID(aA)){var aG=true;if(!l.getNodeType(aA)||l.getNodeType(aA)!=="CATProduct"&&!l.is3DLeaf(aA)){aG=false}if(aG){for(var aC=0;aC<aD.length;aC++){if(aD[aC].getLastElement(true)===aA){aG=false;break}}}if(aG){aD.push(ay.clone())}}}if(ax&&ax.length){for(aF=0;aF<ax.length;aF++){q(ax[aF],aD,aB)}}};var an=function(aB){var ax=f.getWebappsBaseUrl();var aD=!j.matchUrl(ax,window.location)?"Passport":null;var aC={provider:"FILE",filename:"CAT3DAnnotationLoadWorker.js",serverurl:ax+"CAT3DAnnotationWorkers/",requiredAuth:aD};var ay={provider:"FILE",filename:"AmdLoader.js",serverurl:ax+"AmdLoader/",requiredAuth:aD};var az={provider:"FILE",filename:"ThreeJS_Base.js",serverurl:ax+"Mesh/",requiredAuth:aD};var aF={provider:"FILE",filename:"Mesh.js",serverurl:ax+"Mesh/",requiredAuth:aD};var aA={provider:"FILE",filename:"CGRFile.js",serverurl:ax+"Formats/",requiredAuth:aD};var aE={provider:"FILE",filename:"EasySax.js",serverurl:ax+"EasySax/",requiredAuth:aD};if(aB===undefined){aa.splice(0,aa.length)}c.getWorkerBlobFromSpecs([ay,az,aF,aA,aE,aC],function(aG){if(!aa){return}if(aB===undefined){for(var aH=0;aH<Y;aH++){var aI=new Worker(aG);aI.onmessage=M;aa.push(aI)}}else{aa[aB]=new Worker(aG);aa[aB].onmessage=M}})};var t=function(){for(var ax=0;ax<aa.length;ax++){aa[ax].terminate()}aa.splice(0,aa.length);ar.splice(0,ar.length);x.splice(0,x.length)};var ab=function(aA,ay,az,ax){if(!aA||!ay||!A||!at){return}A.getFTAContainer(ay,"V4V5_FDT",function(aB){if(aA&&aB&&aB.xml){W(aA,aB.xml,az,ax);return}al("onNoAnnotationSetLoaded",{path:aA})})};var W=function(aC,az,aB,ay,aD){if(aa.length!==Y){var ax=setInterval(function(){if(aa.length===Y){clearInterval(ax);W(aC,az,aB,ay,aD)}},50);return}for(var aA=0;aA<aa.length;aA++){if(!aa[aA].loadedData){al("onAnnotationSetBeginLoad",{path:aC});aa[aA].loadedData={annotationSets:{},path:aC.clone(),visibility:aB,xml:az,ctxTypes:ay};aa[aA].postMessage({xmlData:az,loadingIndex:aA,ctxTypes:ay});return}}ar.push({annotationSets:{},path:aC.clone(),visibility:aB,xml:az,ctxTypes:ay})};var ag=function(ay){if(s.getLoaderType()!=="visu"){if(ay.children.length!==12){return false}for(var ax=0;ax<ay.children.length;ax++){if(ay.children[ax].children.length!==0){return true}}return false}return true};var M=function(aO){var aH=aO.data.loadingIndex;var aA,aM,aE;if(aH===undefined){return}var aG=aa[aH].loadedData?aa[aH].loadedData.path:null;if(!aG){aa[aH].terminate();an(aH);return}if(aO.data.done===true){var aC=Object.keys(aa[aH].loadedData.annotationSets);if(aO.data.loadingCancelled===true){for(aA=0;aA<D.length;aA++){if(D[aA].path.isEqual(aG)&&l.is3DLeaf(D[aA].path.getLastElement(true))){D.splice(aA,1)}else{if(D[aA].path.isAParentOf(aG)&&D[aA].recursive){D[aA].recursive=false}}}for(aA=0;aA<aC.length;aA++){aM=aa[aH].loadedData.annotationSets[aC[aA]];aG.getLastElement(true).removeChild(aM);for(var aI=0;aI<aj.length;aI++){if(aj[aI].getLastElement(true)===aM){aj.splice(aI,1)}}}if(aO.data.error===true){al("onAnnotationSetLoadingFailed",{path:aG})}else{al("onNoAnnotationSetLoaded",{path:aG,loadingAlreadyStarted:true})}}else{var aJ=function(aQ){var aP=h.TesselatedTextRepsMissing;if(aQ[aF]["ds6w:label"]){aP+=aQ[aF]["ds6w:label"]+" / "}aP+=aM.getAnnotationName();al("onAnnotationSetPartiallyLoaded",{path:aE,message:aP})};var aK=function(){al("onAnnotationSetPartiallyLoaded",{path:aE,message:h.TesselatedTextRepsMissing+aM.getAnnotationName()})};for(aA=0;aA<aC.length;aA++){aM=aa[aH].loadedData.annotationSets[aC[aA]];v.postProcessViewsAndCaptures(aa[aH].loadedData.annotationSets[aC[aA]]);if(aO.data.loadingPartiallyFailed){if(!aa[aH].loadedData.hasFailedOnce&&aa[aH].loadedData.xml){aG.getLastElement(true).removeChild(aM);var aB=aa[aH].loadedData;aB.hasFailedOnce=true;var ay=j.loadXml(aB.xml);aB.xml=j.xmlToString(ay);ar.push(aB);console.warn("Error while loading annotations of : "+l.getNodeID(aG.getLastElement(true))+". FTA light model is converted and reloaded.")}else{aE=aG.clone();aE.addElement(aM);al("onAnnotationSetPartiallyLoaded",{path:aE})}}else{if(ag(aM)){aE=aG.clone();aE.addElement(aM);if(!aO.data.hasTesseletedTextReps){if(!l.getLoadedAssetType()){var aF=l.getNodeID(aG.getLastElement(true));Q.getController().getAttributes({ids:[aF],attributes:["ds6w:label"],callbacks:{onComplete:aJ,onFailure:aK}})}else{al("onAnnotationSetPartiallyLoaded",{path:aE,message:h.TesselatedTextRepsMissing+aM.getAnnotationName()})}}else{al("onAnnotationSetLoaded",{path:aE})}}else{aG.getLastElement(true).removeChild(aM);al("onNoAnnotationSetLoaded",{path:aG,loadingAlreadyStarted:true})}}}}if(ar.length){var az;for(aA=ar.length-1;aA>=0;aA--){if(ar[aA]&&!ar[aA].path){ar.splice(aA,1)}else{if(ar[aA]&&ar[aA].path){az=aA}}}aa[aH].loadedData={visibility:ar[az].visibility,path:ar[az].path.clone(),annotationSets:{},hasFailedOnce:ar[az].hasFailedOnce,xml:ar[az].xml};aa[aH].postMessage({xmlData:ar[az].xml,loadingIndex:aH,ctxTypes:ar[az].ctxTypes});ar.splice(az,1)}else{aa[aH].loadedData=null}}else{var aL=aO.data.node;if(aa[aH].loadedData.annotationSets[aO.data.annotSetID]){aM=aa[aH].loadedData.annotationSets[aO.data.annotSetID]}else{var aN=aa[aH].loadedData.visibility;var ax=false;if(aN&&!ah){aN=false;ax=true}aM=v.createAnnotationSet(aN,aw,aL);aG.getLastElement(true).addChild(aM);if(ax){var aD=aG.clone();aD.addElement(aM);aj.push(aD)}aa[aH].loadedData.annotationSets[aO.data.annotSetID]=aM}if(aL){v.loadAnnotation({nodeInfo:aL,annotationSetNode:aM,processText:aO.data.processText,cb:aw})}}Q.getViewer().render()};var al=function(aE,aB){var aC=aB?(aB.path?aB.path.clone():null):null;var ax;var aA=!l.getLoadedAssetType();if(aE==="onAnnotationSetBeginLoad"){I()}else{if(aE==="onAnnotationSetLoaded"||aE==="onAnnotationSetPartiallyLoaded"){J=true;var ay=aC.getLastElement(true);if(aA){d.saveA3EWidgetPref({path:aC.getParentPath(),pref:"A3EAnnotSetsLoaded",data:{visibility:ay.isVisible(),ctxType:ay.getContextType()}})}K.splice(0,K.length);var aD=aC.getParentPath();for(ax=x.length-1;ax>=0;ax--){if(aD.isEqual(x[ax])){x.splice(ax,1)}}if(x.length===0&&J){if(aE==="onAnnotationSetPartiallyLoaded"){b.displayNotification({eventID:"warning",msg:aB.message?aB.message:h.AnnotationSetPartiallyLoadedLbl})}else{b.displayNotification({eventID:"success",msg:h.AnnotationSetLoadedSuccessfullyLbl})}}R.push(aC.clone());ae()}else{if(aE==="onAnnotationSetRemoved"){if(!aq&&!O&&aA){if(aB.pathes&&aB.pathes.length){for(ax=0;ax<aB.pathes.length;ax++){d.removeA3EWidgetPref({path:aB.pathes[ax],pref:"A3EAnnotSetsLoaded"})}}}K.splice(0,K.length)}else{if(aE==="onAnnotationSetLoadingFailed"){for(ax=x.length-1;ax>=0;ax--){if(aC.isEqual(x[ax])){x.splice(ax,1)}}b.displayNotification({eventID:"error",msg:h.AnnotationSetLoadedFailedLbl});ae()}else{if(aE==="onNoAnnotationSetLoaded"){if(aC){for(ax=x.length-1;ax>=0;ax--){if(aC.isEqual(x[ax])){x.splice(ax,1)}}}if(x.length===0&&!J&&E.length===0){b.displayNotification({eventID:"info",msg:h.NoAnnotationSetLoadedLbl})}else{if(x.length===0&&J&&E.length===0){b.displayNotification({eventID:"success",msg:h.AnnotationSetLoadedSuccessfullyLbl})}}if(aB&&aB.loadingAlreadyStarted){ae()}}else{if(aE==="onAnnotationSetLoadingCanceled"){x.splice(0,x.length);av.splice(0,av.length);E.splice(0,E.length);b.displayNotification({eventID:"info",msg:h.AnnotationSetLoadedCanceledLbl});ae()}else{if(aE==="onAnnotationVisibilityModified"){if(aC){var az=aC.getLastElement(true);if(aA){d.removeA3EWidgetPref({path:aC,pref:"A3EAnnotSetsLoaded"});d.saveA3EWidgetPref({path:aC,pref:"A3EAnnotSetsLoaded",data:{visibility:az.isVisible(),ctxType:az.getContextType()}})}}}else{if(aE==="onAnnotationParentVisibilityModified"){K.length=0}}}}}}}}if(D){V.publish({event:aE,data:aB,context:s})}};var I=function(){if(ak){clearTimeout(ak);ak=null}ak=setTimeout(function(){T=1;ae()},20000);T++;if(T===1){i.on(h.LoadingAnnotationsLbl,function(){for(var ax=aa.length-1;ax>=0;ax--){if(aa[ax].loadedData){var aA=aa[ax].loadedData.path.getLastElement(true);var az=Object.keys(aa[ax].loadedData.annotationSets);var ay;for(ay=0;ay<az.length;ay++){aA.removeChild(aa[ax].loadedData.annotationSets[az[ay]])}for(ay=D.length-1;ay>=0;ay--){if(D[ay].path.isAParentOf(aa[ax].loadedData.path)||D[ay].path.isEqual(aa[ax].loadedData.path)){D.splice(ay,1)}}}}t();an();al("onAnnotationSetLoadingCanceled");Q.getViewer().render()})}};var ae=function(){if(ak){clearTimeout(ak);ak=null}T--;if(T<0){T=0;return}if(T===0){i.off()}}}});var g=[];var m=a.singleton({init:function(){},getAnnotationModelLoader:function(q){if(q&&q.context){var o=false;for(var p=0;p<g.length;p++){if(g[p].context===q.context){g[p].counter++;o=true;break}}if(!o){g.push({counter:1,context:q.context,modelLoader:new n({ctxViewer:q.context,favoriteCtxManager:q.favoriteCtxManager})})}return this.giveAnnotationModelLoader(q)}return undefined},giveAnnotationModelLoader:function(r){if(r&&r.context){var o,q;for(var p=0;p<g.length;p++){if(g[p].context===r.context){q=g[p];o=q.modelLoader;break}}if(o){return Object.freeze({setActiveState:function(s){if(o){o.setActiveState(s)}},getActiveState:function(){if(o){return o.getActiveState()}return undefined},setGlobalFTAVisibilityFlag:function(s){if(o){o.setGlobalFTAVisibilityFlag(s)}},loadFTALightModel:function(u,t,v,s){if(o){o.loadFTALightModel(u,t,v,s)}},hasAlreadyBeenLoaded:function(s,t){if(o&&q.counter>0){return o.hasAlreadyBeenLoaded(s,t)}return undefined},getLoadedAnnotationSets:function(){if(o){return o.getLoadedAnnotationSets()}return undefined},getDirectChildrenAnnotSets:function(s){if(o){return o.getDirectChildrenAnnotSets(s)}return undefined},isRunning:function(){if(o){return o.isRunning()}return undefined},setLoaderType:function(s){if(o){o.setLoaderType(s)}},getLoaderType:function(){if(o){return o.getLoaderType()}return undefined},subscribe:function(t,s){if(o){return o.subscribe(t,s)}return undefined},unsubscribe:function(s){if(o){o.unsubscribe(s)}}})}}return undefined},unreferenceAnnotationModelLoader:function(p){if(p&&p.context){for(var o=0;o<g.length;o++){if(g[o].context===p.context){g[o].counter--;if(g[o].counter<=0){if(g[o].modelLoader){g[o].modelLoader.clear()}g.splice(o,1)}return}}}}});return m});define("DS/CAT3DAnnotationModelLoader/CAT3DAnnotationVisuLoader",["UWA/Class","DS/Visualization/Node3D","DS/Visualization/LoaderUtils"],function(b,d,c){var a=b.extend({init:function(f){var e=f||{};this._parent(e);this.getType=function(){return"visu"};this.createAnnotationSet=function(i){var j=new d();if(i!==undefined&&i!==null){j.setVisibility(i)}j.getAnnotationClassType=function(){return"tpsAnnotationSet"};return j};this.postProcessViewsAndCaptures=function(){};var h=function(k){if(k.getNodeType&&k.getNodeType()==="Mesh3D"){return k}var i=k.children;for(var j=0;j<i.length;j++){var l=h(i[j]);if(l){return l}}};var g=function(k){if(k.setPickParent){k.setPickParent(true)}var i=k.children;for(var j=0;j<i.length;j++){g(i[j])}};this.createReps=function(m,o,p,n){var q,l,k;var i={textureInBlack:localStorage.getItem("3DAnnotWhiteVectorAsBlack")!=="false",edgeTransparency:p!==1&&p!==2&&p!==3,processText:c.isProcessDataAsynchronous&&o};var j=function(w){if(i.textureInBlack&&w.whiteVectorInBlack){w.whiteVectorInBlack()}var v=h(w);v.setShadow(false,false);v.setSSAO(false);v.setVisibilityInTree(false);if(m.nodeXMLtype!=="TPSCG"){v.setNoZ(true)}else{var u=true;var x=v.getPrimitives();for(q=0;q<x.length;q++){var s=x[q].getDimension();if(s==="surface"||s==="volume"){u=false}}v.setNoZ(u)}g(w);var r=w.children[0].isVisible();w.children[0].setVisibility(true);var t=w.getBoundingSphere();if(t.radius>0||t.pixelRadius>0){n.addChild(w);n.setVisibility(r)}};if(m.reps[0]&&m.reps[0].reps){l=new d();c.processData([l],m.reps[0],undefined,true,i,c.isProcessDataAsynchronous?function(){j(l)}:undefined);if(!c.isProcessDataAsynchronous){j(l)}}if(m.reps[1]&&m.reps[1].reps){k=new d();c.processData([k],m.reps[1],undefined,true,i,c.isProcessDataAsynchronous?function(){j(k)}:undefined);if(!c.isProcessDataAsynchronous){j(k)}}};this.createCappingRep=function(i){if(i.cappingRep.reps){var k=new d();c.processData([k],i.cappingRep,undefined,true);var j=h(k);j.setVisibilityInTree(false);j.setShadow(false,false);j.excludeFromHighlight(true,true);j.setNoZ(false);k.name=i.name+"_cappingRep";return k}}},loadAnnotation:function(i){if(i.nodeInfo.type===6){return}else{if(i.nodeInfo.nodeXMLtype==="AnnotationSet"){i.annotationSetNode.getContextType=function(){return(i.nodeInfo.contextType!==undefined?i.nodeInfo.contextType:0)}}else{var g=Object.keys(i.nodeInfo);if(g.length){var h=new d();i.annotationSetNode.addChild(h);for(var f=0;f<g.length;f++){if(g[f]==="reps"){this.createReps(i.nodeInfo,i.processText,i.annotationSetNode.getContextType(),h)}else{if(g[f]==="cappingRep"){var e=this.createCappingRep(i.nodeInfo);if(e){h.cappingRep=e}}}}}}}}});return a});