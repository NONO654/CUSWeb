define("DS/DEL3DLeanSession/Session.manager",["pluginDS!DS/VENJQuery/jquery.1.11.1/jquery","UWA/Core","pluginDS!DS/VENUnderscore/underscore.1.8.3/underscore","pluginDS!DS/VENMarionette/backbone.marionette.3.5.1/backbone.marionette","UWA/Class/Promise","DS/Logger/Logger","DS/DEL3DLeanModels/AElement.model","DS/DEL3DLeanHttpRequest/HttpRequest","DS/DEL3DLeanHttpRequest/SecurityContext","DS/DEL3DLeanFactory/ModelFactory","DS/DEL3DLeanCollections/Collection.manager","DS/DEL3DLeanModels/Model.manager","DS/DEL3DLeanEnums/Model.enum","DS/DEL3DLeanEnums/Collection.enum","DS/DEL3DLeanEnums/AttributeMap.enum","DS/DEL3DLeanResources/ResourcesManager","DS/i3DXCompassPlatformServices/i3DXCompassPlatformServices","DS/DEL3DLeanServices/EncodingParser","DS/DEL3DLeanHttpRequest/ImageService","DS/WebappsUtils/WebappsUtils","DS/DEL3DLeanHttpRequest/MessageHandler"],function(x,c,N,E,z,b,l,C,i,y,A,e,q,j,u,t,K,B,J,F,w){var g=null;var d=E.Object.extend({name:"SessionManager",_logger:null,_3DLeanSession:null,_CollabspaceSession:null,_Collabspaces:null,_PrivateTeamCollabspace:null,_PublicStickerCollabspace:null,_ConnectedUser:null,_localXMLDirTst:F.getWebappsAssetUrl("DEL3DLeanResourcesTest","favorites"),_localXMLDir:F.getWebappsAssetUrl("DEL3DLeanResources","favorites"),constructor:function d(){E.Object.prototype.constructor.apply(this,arguments);var O=c.getGlobal();O.leanSessionManager=this},initialize:function(){this._logger=b.getLogger(d);this._3DLeanSession=new q.PROJECT.modelConstructor();this._CollabspaceSession=new q.COLLABORATIVESPACESESSION.modelConstructor();this._PrivateTeamCollabspace=new q.COLLABORATIVESPACE.modelConstructor();this._PublicStickerCollabspace=new q.COLLABORATIVESPACE.modelConstructor();this._teamLoaded=false},init:function(){var O=z.deferred();var P=[];var Q=this;var R=this._getSecurityContext();P.push(R);R.then(function(){var T=Q._getConnectedUser();var S=u.load();P.push(T);P.push(S);T.then(function(){P.push(Q._getCollabspaceSession());z.all(P).then(O.resolve,O.reject)},function(U){O.reject(U)})},function(S){O.reject(S)});return O.promise},computeCollabSpacesNames:function(){var P="My 3DLean - "+this._ConnectedUser.id+" - Team";var O="3DLean Public - Stickers";this._PrivateTeamCollabspace.set("title",P);this._PublicStickerCollabspace.set("title",O)},setCollections:function(O){for(var P in O){this.setCollection(P,O[P])}},setCollection:function(T,R,Q){Q=Q||{};R=N.uniq(R,function(U){return c.is(U.physicalid)?U.physicalid:U.type});R=N.filter(R,function(U){return c.is(q.getFromServerType(U.type))});var S=typeof T==="string"?j.getFromType(T):T;var O=S.sessionInstance;var P=N.extend(Q,{merge:true,parse:true});O.reset();O.set(R,P)},initSession:function(){var R=this;var S=this._ConnectedUser.id;var P="/resources/modeler/3dlean/api/getusersessionid";var Q=z.deferred();var O={login:S};C.request(P,{type:"POST",data:JSON.stringify(O),success:function(U){var V=JSON.parse(U);var T;if(c.is(V.session,"string")&&V.session.length>0){w.init(V.session);T=R.loadSession(V.session)}else{T=R.createSession()}T.then(Q.resolve,Q.reject)},error:function(T){R._logger.warn(T);Q.reject(t.getTranslation("ERR0x00000D11"))}});return Q.promise},loadSession:function H(R){var S=this;var Y=z.deferred();var U=null;var Q=null;var P=c.getGlobal();var V=[];var W=null;this.trigger("before:loadsession",{sessionId:R});var T=function(Z){S._logger.warn("Loading session failed");P.sessionLoaded=false;S.trigger("after:loadsession",{state:"failed",sessionId:R});Y.reject(Z)};var O=function(Z){U=JSON.parse(Z)||{};Q={merge:true};S._3DLeanSession.clear();S._3DLeanSession.set(S._3DLeanSession.parse(U.session),Q);S.computeCollabSpacesNames();S.setCollections({statics:U.statics,floatables:U.floatables,relations:U.relations,store:U.leangets,tasks:U.tasks});W=S._fetchOrCreateCollabSpaces();V.push(W.global);P.privateTeamCollabSpace=S._PrivateTeamCollabspace.get("title");V.push(S._fetchTeam());V.push(S._PublicStickerCollabspace.listContent(true));V.push(S._PrivateTeamCollabspace.listContent());S._loadFavorites();P.sessionLoaded=true;V.push(S._createUniqueActionLog());V.push(S._createUniqueIssueLog());W.team.then(function(){S.trigger("after:loadsession",{state:"success",sessionId:R});Y.resolve()},T.bind(S));z.all(V).then(function(){S.trigger("after:loadall",{state:"success",sessionId:R})},function(){S.trigger("after:loadall",{state:"failed",sessionId:R})})};var X="/resources/modeler/3dlean/api/loadsession/"+R;C.request(X,{proxy:"passport",urlParameters:{iefix:Date.now()},error:function(){T.call(S,"Loading session failed")},success:O.bind(this)});return Y.promise},createSession:function I(){var R=this;var V=z.deferred();var T=z.deferred();var W={merge:true};var U;var P="/resources/modeler/3dlean/api/listleangetstypes/";var S=[];var O=c.getGlobal();this.trigger("before:loadsession",{sessionId:""});R.computeCollabSpacesNames();var Q=R._fetchOrCreateCollabSpaces();Q.global.then(function(){O.privateTeamCollabSpace=R._PrivateTeamCollabspace.get("title");R._3DLeanSession.save(null,{success:function(Z){R._3DLeanSession.clear();R._3DLeanSession.set(Z.toJSON(),W);var Y=z.deferred();var X=j.PEOPLES.sessionInstance.loadPeoples([{name:Z.get("owner")}],{success:Y.resolve,error:Y.reject});X[0].set("privileges",["VPLMProjectLeader","VPLMCreator"]);S.push(Y.promise);S.push(R._createUniqueActionLog());S.push(R._createUniqueIssueLog());var aa=z.deferred();C.request(P,{success:function(ab){U=JSON.parse(ab);j.STORE.sessionInstance.add(U);aa.resolve(ab)},error:function(){R._logger.warn("Could not retrieve store collection");aa.reject(t.getTranslation("ERR0x00000E11"))}});S.push(aa.promise);z.all(S).then(function(){S=[];S.push(R._PublicStickerCollabspace.listContent(true));S.push(R._PrivateTeamCollabspace.listContent());z.all(S).then(function(){window.location.reload()},T.reject)},T.reject)},error:function(){T.reject(t.getTranslation("ERR0x00001011"))}});z.all([T.promise]).then(function(){O.sessionLoaded=true;R.trigger("after:loadsession",{state:"success",sessionId:R._3DLeanSession.id});V.resolve()},function(X){R._logger.warn("Session creation failed");O.sessionLoaded=false;R.trigger("after:loadsession",{state:"failed",sessionId:""});V.reject(X)})},function(X){R._logger.warn("Session creation failed");O.sessionLoaded=false;R.trigger("after:loadsession",{state:"failed",sessionId:""});V.reject(X)});return V.promise},getLiveService:function(){return w},getLiveId:function(){return w.getLiveId()},getSessionId:function(){return this._3DLeanSession.id},isSessionLoaded:function s(){return c.getGlobal().sessionLoaded},isTeamLoaded:function h(){return this._teamLoaded},getSessionName:function(){return this._ConnectedUser.id},getSessionToken:function a(){return this._CollabspaceSession.get("csrftoken")},get3DSpaceSessionToken:function M(){var O=c.getGlobal();return O.sessionToken3DSpace},get3DLeanSession:function p(){return this._3DLeanSession},getPrivateTeamSpace:function D(){return this._PrivateTeamCollabspace},getPublicStickerSpace:function o(){return this._PublicStickerCollabspace},getCollectionManager:function n(){return A},getAllRelations:function(){return j.RELATIONS.sessionInstance},getSession:function(){return this.get3DLeanSession()},getModelEnum:function(){return q},getCollectionEnum:function(){return j},getAllFloatables:function(){return j.FLOATABLES.sessionInstance},getAllStatics:function(){return j.STATICS.sessionInstance},getAllTasks:function(){return j.TASKS.sessionInstance},getAllSessions:function(){return j.PEOPLES.sessionInstance.filter(function(O){return O.isCollaborator()})},getAllPeoples:function(){return j.PEOPLES.sessionInstance},hasUniqueActionLog:function(){return this._hasUnique(q.ACTIONLOG)},hasUniqueIssueLog:function(){return this._hasUnique(q.ISSUELOG)},_hasUnique:function(R){if(c.is(R)&&c.is(R.serverType)){var Q=this._3DLeanSession.id;var S=A.getStaticsRelationsFrom(Q).where({type:"DEL3DL_Link"});for(var P=0;P<S.length;P++){var O=A.findModel(S[P].get("to"),"statics");if(c.is(O)&&O.get("type")===R.serverType){return true}}}return false},_createUniqueActionLog:function(){return this._createUnique(q.ACTIONLOG)},_createUniqueIssueLog:function(){return this._createUnique(q.ISSUELOG)},_createUnique:function(P){var O=z.deferred();if(!this._hasUnique(P)){A.createModel(this._3DLeanSession.id,P,{},{success:O.resolve,error:O.reject},q.LINK)}else{O.resolve()}return O.promise},_loadLocalXML:function(O,R,P){var Q=new XMLHttpRequest();Q.open("GET",P+"/"+O,true);Q.responseType="blob";Q.onload=function(){if(this.status===200){R.readAsDataURL(Q.response)}};Q.send()},_loadFavorites:function(){j.STORE.sessionInstance.forEach(function(P){var Q=q.getFromServerType(P.get("type"));var R=Q.clientType;var S="config."+R+".xml";var O=new FileReader();O.onload=x.proxy(function(V){var T;if(navigator.userAgent.toLowerCase().indexOf("firefox")>-1){T=V.target.result}else{T=V.srcElement.result}var U=B.parseBase64XML(T);var W=B.xmlAsCollection(U.content,"favorite",Q.favorites);if(!Q.favorites){Q.favorites.add(W)}},this);this._loadLocalXML(S,O,this._localXMLDir);this._PrivateTeamCollabspace.listContent().then(function(U){var T=U.findWhere({fullFileName:S});if(c.is(T)&&c.is(T.get("businessobj"))){var V=T.get("businessobj");J.getImage(V.documentId).then(function(X){var W=B.parseBase64XML(X);var Y=B.xmlAsCollection(W.content,"favorite",Q.favorites);if(!Q.favorites){Q.favorites.add(Y)}})}})},this)},_getCollabspaceSession:function m(){var P=c.getGlobal();var O=z.deferred();this._CollabspaceSession.fetch({success:function(Q){P.sessionToken=Q.get("csrftoken");O.resolve()},error:function(){O.reject(t.getTranslation("ERR0x00000711"))}});return O.promise},_getSecurityContext:function k(){var Q=this;var O=z.deferred();i.computeSecurityContext(function R(){O.resolve()},function P(){if(i.hasTeamSecurityContext()===true){Q._logger.warn("Compute Security Context Failed");O.resolve()}else{O.reject(t.getTranslation("ERR0x00000411"))}});return O.promise},_getConnectedUser:function f(){var P=this;var O=z.deferred();K.getUser({platformId:widget.getValue("PlatformID"),onComplete:function(Q){P._ConnectedUser=Q;P._ConnectedUser.fullname=Q.firstname+" "+Q.lastname;O.resolve()},onFailure:function(){O.reject(t.getTranslation("ERR0x00000311"))}});return O.promise},_get3DSpaceToken:function r(){var R=this;var O=z.deferred();var Q=c.getGlobal();var P="/resources/v1/application/CSRF";C.request(P,{type:"GET",success:function(S){var T=JSON.parse(S);Q.sessionToken3DSpace=T.csrf.value;O.resolve()},error:function(S){R._logger.warn(S);O.reject(t.getTranslation("ERR0x00001611"))}});return O.promise},_fetchOrCreateCollabSpaces:function v(){var R=this;var O=null;var T=z.deferred();var Q=z.deferred();var V=z.deferred();var S=z.deferred();var P=[];O={family:{value:"DESIGNTEAM"},title:R._PrivateTeamCollabspace.get("title"),visibility:{value:"PROTECTED"}};y.fetchOrCreate(q.COLLABORATIVESPACE,O).then(function U(W){R.quickfixTitle(R._PrivateTeamCollabspace,W.toJSON());T.resolve(W)},function(){T.reject(t.getTranslation("ERR0x00001111"))});O.title=R._PublicStickerCollabspace.get("title");O.visibility={value:"PUBLIC"};y.fetchOrCreate(q.COLLABORATIVESPACE,O).then(function U(W){R.quickfixTitle(R._PublicStickerCollabspace,W.toJSON());Q.resolve(W)},function(){Q.reject(t.getTranslation("ERR0x00001211"))});P.push(T.promise);P.push(Q.promise);z.all(P).then(function(){S.resolve()},function(W){R._logger.warn("Fetch or Create Collaborative Spaces failed");S.reject(W)});return{team:T.promise,sticker:Q.promise,people:V.promise,global:S.promise}},quickfixTitle:function(Q,O){var P=Q.get("title");Q.clear();Q.set(O);var R=Q.get("title");if(!c.is(R)||R===""||R==="null"){Q.set("title",P)}},_fetchTeam:function L(){var O=this;return j.PEOPLES.sessionInstance.loadTeam().then(function(){j.PEOPLES.sessionInstance.trigger("after:loadPrivileges");O._teamLoaded=true})}});function G(){if(!c.is(g)){g=new d()}return g}return G()});